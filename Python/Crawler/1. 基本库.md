# urllib

## 模块介绍

1. request：它是最基本的HTTP请求模块，可以用来模拟发送请求。就像在浏览器里输入网址然后回车一样，只需要给库方法传入URL以及额外的参数，就可以模拟实现这个过程了。

2. error：异常处理模块，如果出现请求错误，我们可以捕获这些异常，然后进行重试或其他操作以保证程序不会意外终止。

3. parse：一个工具模块，提供了许多URL处理方法，比如拆分、解析、合并等。

4. robotparser：主要是用来识别网站的robots.txt文件，然后判断哪些网站可以爬，哪些网站不可以爬，它其实用得比较少

## 发送请求

使用urllib.equest模块，我们可以方便地实现请求的发送并得到响应

### urlopen()

``` python
	import urllib.request
	response = urllib.request.urlopen("https://www.python.org")
    print(response.read().decode('utf-8'))
```

输出：网页源代码

#### 利用type()方法输出响应的类型

``` python
	print(type(response))
```

输出：`<class 'http.client.HTTPResponse'>`

可以发现，它是一个HTTPResposne类型的对象。它主要包含read()、readinto()、getheader(name)、getheaders()、fileno()等方法，msg、version、status、reason、debuglevel、closed等属性

#### 调用方法和属性

```python
	print(response.status)
	print(response.getheaders())
	print(response.getheader('Server'))
```

输出：响应的状态码，响应的头信息，响应头中的Server值

``` markdown
200
 [('Server', 'nginx'), ('Content-Type', 'text/html; charset=utf-8')……('Strict-Transport-Security', 'max-age=63072000; includeSubDomains')]
 nginx
```

#### urlopen()函数的API

urllib.request.urlopen(url, data=None, [timeout, ]*, cafile=None, capath=None, cadefault=False, context=None)

1. data参数

   - 如果传递了这个参数，则它的请求方式就不再是GET方式，而是POST方式

   - 如果它是字节流编码格式（bytes类型），则需要通过bytes()方法转化

   - 例

     ``` python
     		import urllib.parse
     		import urllib.request
     		data = bytes(urllib.parse.urlencode({'name': 'germey'}), encoding='utf-8')
     		response = urllib.request.urlopen('https://httpbin.org/post', data=data)
     		print(response.read().decode('utf-8'))
     ```

     第一个参数需要是str类型，需要用urllib.parse模块里的urlencode()方法来将参数字典转化为字符串

     第二个参数指定编码格式，这里指定为utf8

     输出：

     ``` markdown
     		{
     		  "args": {},
     		  "data": "",
     		  "files": {},
     		  "form": {
     			    "name": "germey"
     				  },
     		  "headers": {
     	      		"Accept-Encoding": "identity",
     		  		"Content-Length": "11",
     				"Content-Type": "application/x-www-form-urlencoded",
     				"Host": "httpbin.org",
     				"User-Agent": "Python-urllib/3.7",
     				"X-Amzn-Trace-Id": "Root=1-5f96de5b-6805a3ac7b7b4b151a11fdc6"
     					},
     			"json": null,
     			"origin": "59.79.2.148",
     			"url": "https://httpbin.org/post"
               }
     ```

2. timeout参数

   用于设置超时时间，单位为秒，意思就是如果请求超出了设置的这个时间，还没有得到响应，就会抛出异常。如果不指定该参数，就会使用全局默认时间。它支持HTTP、HTTPS、FTP请求。

   - 例一

     ``` python
     		import urllib.request
     		response = urllib.request.urlopen('https://httpbin.org/get', timeout=0.1)
     		print(response.read())
     ```

     程序1秒过后，服务器依然没有响应，于是抛出了URLError异常。该异常属于urllib.error模块，错误原因是超时

   - 例二

     可以通过设置这个超时时间来控制一个网页如果长时间未响应，就跳过它的抓取。这可以利用try except语句来实现

     ``` python
     		import urllib.request
     		import socket
     		import urllib.error
     		try:
     			response = urllib.request.urlopen('http://httpbin.org/get', timeout=0.1)
     		except urllib.error.URLError as e:
     			if isinstance(e.reason, socket.timeout):
     				print('TIME OUT')
     ```

     这里我们请求了http://httpbin.org/get测试链接，设置超时时间是0.1秒，然后捕获了URLError异常，接着判断异常是socket.timeout类型（意思就是超时异常），从而得出它确实是因为超时而报错，打印输出了TIME OUT

3. 其他参数
   - context参数，它必须是ssl.SSLContext类型，用来指定SSL设置。
   - cafile和capath这两个参数分别指定CA证书和它的路径，这个在请求HTTPS链接时会有用。
   - cadefault参数现在已经弃用了，其默认值为False