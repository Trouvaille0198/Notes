---
draft: true
---

# 第八章：故障恢复，并发控制

19120198 孙天野

## 思考题

1. 某数据库配置时把数据库文件、备份文件、日志文件放在同一个硬盘上，是否合适？并说明理由。放在同一台计算机的不同硬盘上呢？从故障恢复的角度应该如何配置合理？至少哪两类文件不应放在同一硬盘上？

    答：

    1. 不合适。将所有数据放在一个磁盘上，难以避免介质故障（硬盘损坏）带来的不可恢复的结果。
    2. 不合适。整台电脑发生故障时，数据还是无法恢复。
    3. 数据应在多个存储设备上备份。
    4. 数据库文件和备份文件。

2. 操作序列 T1、T2、T3 对数据 A、B、C 并发操作如下所示，T1 与 T2 间并发操作<u>**不一致性**</u> ， T2 与 T3 间并发操作<u>**丢失更新**</u>。修改如下并发调度为可串行化调度

    ![image-20220516113822957](https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220516113822957.png)

修改后

| 时间 |    T1    |   T2    |    T3    |
| :--: | :------: | :-----: | :------: |
|  t1  | 读 A=50  |         |          |
|  t2  | 读 B=200 |         |          |
|  t3  |  X1=A+B  |         |          |
|  t4  |          | 读B=200 |          |
|  t5  | 读 A=50  |         |          |
|  t6  | 读 B=200 |         |          |
|  t7  |  X1=A+B  |         |          |
|  t8  |          | B=B-100 |          |
|  t9  |          |  写 B   |          |
| t10  |          |         | 读 B=100 |
| t11  |          |         |  B=B+50  |
| t12  |          |         |   写 B   |

## 作业

### 题一

假定系统采用检查点方法，T1、T2 和 T3 是并发事务，在 t19 时发生系统故障，最近的检查点在 t8 时（见图）；A、B、C 和 D 都是数据库中的数据项，初值依次是 800、300、70 和 80，说明所需的恢复工作。

![image-20220516114055966](https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220516114055966.png)

- 正向扫描日志文件，建立**事务重做队列**与**事务撤消队列**。
- T1 在故障最近检查点之前未完成，在发生故障之前已完成，故加入事务重做队列，恢复后 A=710，
- T2 在故障最近检查点之前已完成，不用恢复
- T3 在故障点时还未完成，故加入事务撤销队列，恢复后 B=600，D=80。

## 题二

假定系统采用检查点方法，当系统崩溃时产生了以下并发事务的日志记录。

1. 请给出系统在恢复后搜索日志时所形成的重做队列和撤销队列。

2. 请给出恢复后各数据项的值。

![image-20220516114445754](https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220516114445754.png)

1. 重做队列：T2，T4；撤销队列：T3

2. A=600， B=190， C=90， D=130

### 题三

判断下列并发调度是不是可串行化调度，为什么？修改如下并发调度为可串行化调度

![image-20220516131421351](https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220516131421351.png)

不是，可能的结果有两种：

- A=11，B=14
- A=11，B=13

然而当前并发调度的结果为 A=11，B=3

修改：

| 时间 |    事务T1    | 数据库中值 |    事务T2    |
| :--: | :----------: | :--------: | :----------: |
|  t0  |              | A=10, B=2  |              |
|  t1  |    Read A    |            |              |
|  t2  | Update A=A+1 |            |              |
|  t3  |              |            |    Read B    |
|  t4  |              |            |    Read A    |
|  t5  |              |            | Update B=A+B |
|  t6  |    Read B    |            |              |
|  t7  | Update B=B+1 |            |              |

### 题四

设 T1，T2，T3 是如下三个事务：T1: A:=A+2;   T2:  A:=A*2;   T3: A:=A^2; 设 A 的初始值为 0

1. 若三个事务允许并发执行，则有多少种可能的正确的结果，请分别列举出来

2. 请给出一个可串行化的调度，并给出执行结果

3. 请给出一个非串行化的调度，并给出执行结果

4. 若三个事务都遵守两段锁协议，请给出一个产生死锁的调度。



1. 4 种结果：A=16，A=8，A=4，A=2

2. 结果为 A=2

| 时间 |        T1        |        T2        |        T3        |
| :--: | :--------------: | :--------------: | :--------------: |
|  t0  |                  |      Read A      |                  |
|  t1  |      Read A      |                  |                  |
|  t2  |                  | Update A = A * 2 |                  |
|  t3  |                  |                  |      Read A      |
|  t4  |                  |                  | Update A = A ^ 2 |
|  t5  | Update A = A + 2 |                  |                  |

4. 结果为 A=0

| 时间 |        T1        |        T2        |        T3        |
| :--: | :--------------: | :--------------: | :--------------: |
|  t0  |                  |      Read A      |                  |
|  t1  |      Read A      |                  |                  |
|  t2  |                  | Update A = A * 2 |                  |
|  t3  |                  |                  |      Read A      |
|  t4  | Update A = A + 2 |                  |                  |
|  t5  |                  |                  | Update A = A ^ 2 |

4. 

| 时间 |          T1           |          T2           |          T3           |
| :--: | :-------------------: | :-------------------: | :-------------------: |
|  t0  |      Read A(S A)      |                       |                       |
|  t1  |                       |      Read A(S A)      |                       |
|  t2  |                       |                       |      Read A(S A)      |
|  t3  | Update A = A + 2(X A) |                       |                       |
|  t4  |                       | Update A = A * 2(X A) |                       |
|  t5  |                       |                       | Update A = A ^ 2(X A) |