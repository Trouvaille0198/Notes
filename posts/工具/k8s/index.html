<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>k8s - 伤心肠粉的酱油碟子</title><meta name=author content><meta name=author-link content><meta name=description content="Kubernetes k8s 是基于容器的集群编排引擎，具备扩展集群、滚动升级回滚、弹性伸缩、自动治愈、服"><meta name=keywords content="Theme,Hugo"><meta itemprop=name content="k8s"><meta itemprop=description content="Kubernetes k8s 是基于容器的集群编排引擎，具备扩展集群、滚动升级回滚、弹性伸缩、自动治愈、服"><meta itemprop=datePublished content="2022-06-22T00:00:00+00:00"><meta itemprop=dateModified content="2023-07-05T02:59:55+00:00"><meta itemprop=wordCount content="9249"><meta itemprop=image content="https://trouvaille0198.github.io/logo.png"><meta itemprop=keywords content><meta property="og:title" content="k8s"><meta property="og:description" content="Kubernetes k8s 是基于容器的集群编排引擎，具备扩展集群、滚动升级回滚、弹性伸缩、自动治愈、服"><meta property="og:type" content="article"><meta property="og:url" content="https://trouvaille0198.github.io/Notes/posts/%E5%B7%A5%E5%85%B7/k8s/"><meta property="og:image" content="https://trouvaille0198.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-07-05T02:59:55+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://trouvaille0198.github.io/logo.png"><meta name=twitter:title content="k8s"><meta name=twitter:description content="Kubernetes k8s 是基于容器的集群编排引擎，具备扩展集群、滚动升级回滚、弹性伸缩、自动治愈、服"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://trouvaille0198.github.io/Notes/posts/%E5%B7%A5%E5%85%B7/k8s/><link rel=prev href=https://trouvaille0198.github.io/Notes/posts/golang/%E6%A0%87%E5%87%86%E5%BA%93/exec/><link rel=next href=https://trouvaille0198.github.io/Notes/posts/useful/go-dockerfile-%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE/><link rel=stylesheet href=/Notes/lib/normalize/normalize.min.css><link rel=stylesheet href=/Notes/css/style.min.css><link rel=stylesheet href=/Notes/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/Notes/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"k8s","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/%E5%B7%A5%E5%85%B7\/k8s\/"},"genre":"posts","wordcount":9249,"url":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/%E5%B7%A5%E5%85%B7\/k8s\/","datePublished":"2022-06-22T00:00:00+00:00","dateModified":"2023-07-05T02:59:55+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"MelonCholi"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子><span class=header-title-text>伤心肠粉</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/Notes/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/Notes/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/Notes/posts/>文章</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子><span class=header-title-text>伤心肠粉</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/Notes/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/Notes/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/Notes/posts/>文章</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class="toc-content always-active" id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>k8s</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle"></i>
MelonCholi</span></span>
<span class=post-category>收录于 <a href=/Notes/categories/%E5%B7%A5%E5%85%B7/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;工具</a></span></div><div class=post-meta-line><span title="2022-06-22 00:00:00"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-06-22>2022-06-22</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 9249 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 19 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#认识>认识</a><ul><li><a href=#简介>简介</a><ul><li><a href=#kubernetes-k8s-是什么>Kubernetes (K8S) 是什么</a></li><li><a href=#不同的应用部署方案>不同的应用部署方案</a><ul><li><a href=#传统部署方式>传统部署方式：</a></li><li><a href=#虚拟机部署>虚拟机部署</a></li><li><a href=#容器部署>容器部署</a></li></ul></li><li><a href=#什么时候需要-kubernetes>什么时候需要 Kubernetes</a></li></ul></li><li><a href=#kubernetes-集群架构>Kubernetes 集群架构</a><ul><li><ul><li><a href=#master>master</a></li><li><a href=#worker--node>worker / node</a></li><li><a href=#重要概念-pod>重要概念 Pod</a></li><li><a href=#kubernetes-组件>Kubernetes 组件</a></li></ul></li></ul></li></ul></li><li><a href=#设计>设计</a><ul><li><a href=#集群设计>集群设计</a></li><li><a href=#deployment---应用管理者>Deployment - 应用管理者</a></li><li><a href=#pod---kubernetes-最小调度单位>Pod - Kubernetes 最小调度单位</a></li><li><a href=#service---服务发现---找到每个-pod>Service - 服务发现 - 找到每个 Pod</a></li><li><a href=#rollingupdate---滚动升级>RollingUpdate - 滚动升级</a></li></ul></li><li><a href=#快速上手>快速上手</a><ul><li><a href=#配置集群>配置集群</a><ul><li><a href=#minikube>minikube</a></li><li><a href=#裸机搭建>裸机搭建</a></li></ul></li><li><a href=#部署应用>部署应用</a><ul><li><a href=#使用-yaml-文件>使用 YAML 文件</a><ul><li><a href=#pod>Pod</a></li><li><a href=#deployment>Deployment</a></li></ul></li><li><a href=#相关指令>相关指令</a></li><li><a href=#工作负载分类>工作负载分类</a></li><li><a href=#现存问题>现存问题</a></li></ul></li><li><a href=#service>service</a><ul><li><a href=#创建-service>创建 Service</a></li><li><a href=#对外暴露服务>对外暴露服务</a></li><li><a href=#多端口>多端口</a></li><li><a href=#总结>总结</a></li></ul></li><li><a href=#statefulset>StatefulSet</a><ul><li><a href=#什么是-statefulset>什么是 StatefulSet</a></li><li><a href=#部署-statefulset-类型的-mongodb>部署 StatefulSet 类型的 Mongodb</a></li><li><a href=#statefulset-特性>StatefulSet 特性</a></li><li><a href=#web-应用连接-mongodb>Web 应用连接 Mongodb</a></li><li><a href=#问题>问题</a></li></ul></li><li><a href=#数据持久化>数据持久化</a><ul><li><a href=#介绍>介绍</a></li><li><a href=#hostpath-挂载示例>hostPath 挂载示例</a></li><li><a href=#更高级的抽象>更高级的抽象</a><ul><li><a href=#storage-class-sc>Storage Class (SC)</a></li><li><a href=#persistent-volume-pv>Persistent Volume (PV)</a></li><li><a href=#persistent-volume-claim-pvc>Persistent Volume Claim (PVC)</a></li><li><a href=#为什么要这么多层抽象>为什么要这么多层抽象</a></li></ul></li><li><a href=#腾讯云示例>腾讯云示例</a></li><li><a href=#本地磁盘示例>本地磁盘示例</a></li><li><a href=#问题-1>问题</a></li></ul></li><li><a href=#配置文件>配置文件</a><ul><li><a href=#configmap>ConfigMap</a></li><li><a href=#secret>Secret</a></li><li><a href=#使用方法>使用方法</a><ul><li><a href=#作为环境变量使用>作为环境变量使用</a></li><li><a href=#挂载为文件更适合证书文件>挂载为文件（更适合证书文件）</a></li></ul></li></ul></li><li><a href=#helm--命名空间>Helm & 命名空间</a><ul><li><a href=#介绍-1>介绍</a></li><li><a href=#安装-helm>安装 Helm</a></li><li><a href=#安装-mongodb-示例>安装 MongoDB 示例</a></li><li><a href=#命名空间>命名空间</a><ul><li><a href=#kubens>kubens</a></li></ul></li></ul></li><li><a href=#ingress>Ingress</a><ul><li><a href=#使用>使用</a></li><li><a href=#腾讯云配置-ingress-演示>腾讯云配置 Ingress 演示</a></li></ul></li><li><a href=#其他>其他</a><ul><li><a href=#web-可视化管理集群>WEB 可视化管理集群</a></li><li><a href=#数据库更好的做法>数据库更好的做法</a></li><li><a href=#用脚本搭建集群>用脚本搭建集群</a></li><li><a href=#公网搭建-k8s-集群>公网搭建 K8S 集群</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=kubernetes>Kubernetes</h1><p>k8s 是基于容器的<strong>集群编排引擎</strong>，具备扩展集群、滚动升级回滚、弹性伸缩、自动治愈、服务发现等多种特性能力。</p><ul><li>快速部署应用</li><li>快速扩展应用</li><li>无缝对接新的应用功能</li><li>节省资源，优化硬件资源的使用</li></ul><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kubernetes-whole-arch.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kubernetes-whole-arch.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kubernetes-whole-arch.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kubernetes-whole-arch.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kubernetes-whole-arch.png title="kubernetes 整体架构示意图"></p><table><thead><tr><th style=text-align:left>对比项</th><th style=text-align:left>Linux</th><th style=text-align:left>Kubernetes</th></tr></thead><tbody><tr><td style=text-align:left>隔离单元</td><td style=text-align:left>进程</td><td style=text-align:left>Pod</td></tr><tr><td style=text-align:left>硬件</td><td style=text-align:left>单机</td><td style=text-align:left>数据中心</td></tr><tr><td style=text-align:left>并发</td><td style=text-align:left>线程</td><td style=text-align:left>容器</td></tr><tr><td style=text-align:left>资源管理</td><td style=text-align:left>进程内存 & CPU</td><td style=text-align:left>内存、CPU Limit/Request</td></tr><tr><td style=text-align:left>存储</td><td style=text-align:left>文件</td><td style=text-align:left>ConfigMap、Secret、Volume</td></tr><tr><td style=text-align:left>网络</td><td style=text-align:left>端口绑定</td><td style=text-align:left>Service</td></tr><tr><td style=text-align:left>终端</td><td style=text-align:left>tty、pty、shell</td><td style=text-align:left>kubectl exec</td></tr><tr><td style=text-align:left>网络安全</td><td style=text-align:left>IPtables</td><td style=text-align:left>NetworkPolicy</td></tr><tr><td style=text-align:left>权限</td><td style=text-align:left>用户、文件权限</td><td style=text-align:left>ServiceAccount、RBAC</td></tr></tbody></table><h2 id=认识>认识</h2><h3 id=简介>简介</h3><h4 id=kubernetes-k8s-是什么>Kubernetes (K8S) 是什么</h4><p>它是一个为 <strong>容器化</strong> 应用提供<strong>集群部署和管理</strong>的开源工具，由 Google 开发。</p><p><strong>Kubernetes</strong> 这个名字源于希腊语，意为 “舵手” 或 “飞行员”。k8s 这个缩写是因为 k 和 s 之间有八个字符的关系。</p><p>Google 在 2014 年开源了 Kubernetes 项目</p><p><strong>主要特性：</strong></p><ul><li>高可用，不宕机，自动灾难恢复</li><li>灰度更新，不影响业务正常运转</li><li>一键回滚到历史版本</li><li>方便的伸缩扩展（应用伸缩，机器加减）、提供负载均衡</li><li>有一个完善的生态</li></ul><h4 id=不同的应用部署方案>不同的应用部署方案</h4><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwmxgxwp.svg data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwmxgxwp.svg, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwmxgxwp.svg 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwmxgxwp.svg 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwmxgxwp.svg title=container_evolution.svg></p><h5 id=传统部署方式>传统部署方式：</h5><p>应用直接在物理机上部署，机器资源分配不好控制，出现 Bug 时，可能机器的大部分资源被某个应用占用，导致其他应用无法正常运行，无法做到应用隔离。</p><h5 id=虚拟机部署>虚拟机部署</h5><p>在单个物理机上运行多个虚拟机，每个虚拟机都是完整独立的系统，性能损耗大。</p><h5 id=容器部署>容器部署</h5><p>所有容器共享主机的系统，轻量级的虚拟机，性能损耗小，资源隔离，CPU 和内存可按需分配</p><h4 id=什么时候需要-kubernetes>什么时候需要 Kubernetes</h4><p>当你的应用只是跑在一台机器，直接一个 docker + docker-compose 就够了，方便轻松；</p><p>当你的应用需要跑在 3，4 台机器上，你依旧可以每台机器单独配置运行环境 + 负载均衡器；</p><p>当你应用访问数不断增加，机器逐渐增加到十几台、上百台、上千台时，每次加机器、软件更新、版本回滚，都会变得非常麻烦、痛不欲生，再也不能好好的摸鱼了，人生浪费在那些没技术含量的重复性工作上。</p><p>Kubernetes 可以为你提供集中式的管理集群机器和应用，加机器、版本升级、版本回滚，那都是一个命令就搞定的事，不停机的灰度更新，确保高可用、高性能、高扩展。</p><h3 id=kubernetes-集群架构>Kubernetes 集群架构</h3><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwob90mh.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwob90mh.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwob90mh.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwob90mh.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwob90mh.png title=部署示意图></p><h5 id=master>master</h5><p>主节点，控制平台，不需要很高性能，不跑任务，通常一个就行了，也可以开多个主节点来提高集群可用度。</p><h5 id=worker--node>worker / node</h5><p>工作节点，可以是虚拟机或物理计算机，任务都在这里跑，机器性能需要好点；通常都有很多个，可以不断加机器扩大集群；每个工作节点由主节点管理</p><h5 id=重要概念-pod>重要概念 Pod</h5><p>豆荚，K8S 调度、管理的最小单位，一个 Pod 可以包含一个或多个容器，每个 Pod 有自己的虚拟 IP。一个工作节点可以有多个 pod，主节点会考量负载自动调度 pod 到哪个节点运行。</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwoccq7d data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwoccq7d, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwoccq7d 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwoccq7d 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwoccq7d title=集群示意图.png></p><h5 id=kubernetes-组件>Kubernetes 组件</h5><ul><li><code>kube-apiserver</code> API 服务器，公开了 Kubernetes API</li><li><code>etcd</code> 键值数据库，可以作为保存 Kubernetes 所有集群数据的后台数据库</li><li><code>kube-scheduler</code> 调度 Pod 到哪个节点运行</li><li><code>kube-controller</code> 集群控制器</li><li><code>cloud-controller</code> 与云服务商交互
<img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwonmx7e.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwonmx7e.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwonmx7e.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwonmx7e.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwonmx7e.png title=Kubernetes组件></li></ul><h2 id=设计>设计</h2><h3 id=集群设计>集群设计</h3><p>Kubernetes 可以管理大规模的集群，使集群中的每一个节点彼此连接，能够像控制一台单一的计算机一样控制整个集群。</p><p>集群有两种角色，一种是 <strong>master</strong> ，一种是 <strong>Node</strong>（也叫 worker）。</p><ul><li><strong>master</strong> 是集群的"大脑"，负责管理整个集群：应用的调度、更新、扩缩容等。</li><li><strong>Node</strong> 就是具体"干活"的<ul><li>一个 Node 一般是<strong>一个虚拟机或物理机</strong>，它上面事先运行着 docker 服务和 kubelet 服务（ Kubernetes 的一个组件）</li><li>当接收到 master 下发的 &ldquo;任务&rdquo; 后，Node 就要去完成任务（用 docker 运行一个指定的应用）</li></ul></li></ul><img src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-ae36c2d33d5afb5215f9e746c6a9bbd4_1440w.jpg alt=img style=zoom:50%><h3 id=deployment---应用管理者>Deployment - 应用管理者</h3><p>当我们拥有一个 Kubernetes 集群后，就可以在上面跑我们的应用了，前提是我们的应用必须支持在 docker 中运行，也就是我们要事先准备好 docker 镜像。</p><p>有了镜像之后，一般我们会通过 Kubernetes 的 <strong>Deployment</strong> 的<strong>配置文件</strong>去描述应用，比如应用叫什么名字、使用的镜像名字、要运行几个实例、需要多少的内存资源、cpu 资源等等。</p><p>有了配置文件就可以通过 Kubernetes 提供的命令行客户端 - <strong>kubectl</strong> 去管理这个应用了。kubectl 会跟 Kubernetes 的 master 通过 RestAPI 通信，最终完成应用的管理。</p><p>比如我们刚才配置好的 Deployment 配置文件叫 app.yaml，我们就可以通过 &ldquo;kubectl create -f app.yaml&rdquo; 来创建这个应用，之后就由 Kubernetes 来保证我们的应用处于运行状态。</p><p>当某个实例运行失败了或者运行着应用的 Node 突然宕机了，Kubernetes 会自动发现并在新的 Node 上调度一个新的实例，保证我们的应用始终达到我们预期的结果。</p><img src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-de389c70f77d3ade07a9e5f6e2dadcfc_1440w.jpg alt=img style=zoom:50%><h3 id=pod---kubernetes-最小调度单位>Pod - Kubernetes 最小调度单位</h3><p>其实在上一步创建完 Deployment 之后，Kubernetes 的 Node 做的事情并不是简单的 docker run 一个容器。出于像易用性、灵活性、稳定性等的考虑，Kubernetes 提出了一个叫做 Pod 的东西，作为 Kubernetes 的最小调度单位。所以我们的应用在每个 Node 上运行的其实是一个 Pod。</p><img src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-2d769a56fc687409da9151779adafc7f_1440w.jpg alt=img style=zoom:50%><p>Pod 是一组容器（当然也可以只有一个）。容器本身就是一个小盒子了，Pod 相当于在容器上又包了一层小盒子。这个盒子里面的容器有什么特点呢？</p><ul><li>可以直接通过 volume 共享存储。</li><li>有相同的网络空间，通俗点说就是有一样的 ip 地址，有一样的网卡和网络设置。</li><li>多个容器之间可以“了解”对方，比如知道其他人的镜像，知道别人定义的端口等。</li></ul><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-244c75b316d49205ce86776ddb4c1d37_1440w.jpg data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-244c75b316d49205ce86776ddb4c1d37_1440w.jpg, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-244c75b316d49205ce86776ddb4c1d37_1440w.jpg 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-244c75b316d49205ce86776ddb4c1d37_1440w.jpg 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-244c75b316d49205ce86776ddb4c1d37_1440w.jpg title=img></p><h3 id=service---服务发现---找到每个-pod>Service - 服务发现 - 找到每个 Pod</h3><p>上面的 Deployment 创建了，Pod 也运行起来了。如何才能访问到我们的应用呢？</p><p>最直接想到的方法就是直接通过 Pod-ip+port 去访问，但如果实例数很多呢？好，拿到所有的 Pod-ip 列表，配置到负载均衡器中，轮询访问。</p><p>但上面我们说过，Pod 可能会死掉，甚至 Pod 所在的 Node 也可能宕机，Kubernetes 会自动帮我们重新创建新的 Pod。再者每次更新服务的时候也会重建 Pod。而每个 Pod 都有自己的 ip。所以 Pod 的 ip 是<strong>不稳定</strong>的，会经常变化的。</p><p>面对这种变化我们就要借助另一个概念：<strong>Service</strong>。它就是来专门解决这个问题的。不管 Deployment 的 Pod 有多少个，不管它是更新、销毁还是重建，Service 总是能发现并维护好它的 ip 列表。</p><p>Service 对外也提供了多种入口：</p><ol><li><strong>ClusterIP</strong>：Service 在集群内的唯一 ip 地址，我们可以通过这个 ip，均衡的访问到后端的 Pod，而无须关心具体的 Pod</li><li><strong>NodePort</strong>：Service 会在集群的每个 Node 上都启动一个端口，我们可以通过任意 Node 的这个端口来访问到 Pod</li><li><strong>LoadBalancer</strong>：在 NodePort 的基础上，借助公有云环境创建一个外部的负载均衡器，并将请求转发到 <code>NodeIP:NodePort</code>。</li><li><strong>ExternalName</strong>：将服务通过 DNS CNAME 记录方式转发到指定的域名（通过 spec.externlName 设定）</li></ol><img src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-f0e6d59bb179f1293986625c98fa593f_1440w.jpg alt=img style=zoom:50%><p>好，看似服务访问的问题解决了。但大家有没有想过，Service 是如何知道它负责哪些 Pod 呢？是如何跟踪这些 Pod 变化的？</p><p>最容易想到的方法是使用 Deployment 的名字。一个 Service 对应一个 Deployment 。当然这样确实可以实现。但 kubernetes 使用了一个更加灵活、通用的设计 - Label 标签；通过给 Pod 打标签，Service 可以只负责一个 Deployment 的 Pod 也可以负责多个 Deployment 的 Pod 了。Deployment 和 Service 就可以通过 Label 解耦了。</p><img src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-3d4c14f108b08a6f05b03a0f46546063_1440w.jpg alt=img style=zoom:50%><h3 id=rollingupdate---滚动升级>RollingUpdate - 滚动升级</h3><p>滚动升级是 Kubernetes 中最典型的服务升级方案，主要思路是一边增加新版本应用的实例数，一边减少旧版本应用的实例数，直到新版本的实例数达到预期，旧版本的实例数减少为 0，滚动升级结束。</p><p>在整个升级过程中，服务一直处于可用状态。并且可以在任意时刻回滚到旧版本。</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-232d0bd7f74bbf380e0d4f83f4a3bbc9_b.webp data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-232d0bd7f74bbf380e0d4f83f4a3bbc9_b.webp, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-232d0bd7f74bbf380e0d4f83f4a3bbc9_b.webp 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-232d0bd7f74bbf380e0d4f83f4a3bbc9_b.webp 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-232d0bd7f74bbf380e0d4f83f4a3bbc9_b.webp title=动图></p><h2 id=快速上手>快速上手</h2><h3 id=配置集群>配置集群</h3><p>安装方式</p><ul><li><strong>minikube</strong>
只是一个 K8S 集群模拟器，只有一个节点的集群，只为测试用，master 和 worker 都在一起</li><li><strong>直接用云平台 Kubernetes</strong>
可视化搭建，只需简单几步就可以创建好一个集群。
优点：安装简单，生态齐全，负载均衡器、存储等都给你配套好，简单操作就搞定</li><li><strong>裸机安装（Bare Metal）</strong>
至少需要两台机器（主节点、工作节点个一台），需要自己安装 Kubernetes 组件，配置会稍微麻烦点。
可以到各云厂商按时租用服务器，费用低，用完就销毁。
缺点：配置麻烦，缺少生态支持，例如负载均衡器、云存储。</li></ul><h4 id=minikube>minikube</h4><p>官方文档：https://minikube.sigs.k8s.io/docs/start/</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 启动集群</span>
</span></span><span class=line><span class=cl>minikube start
</span></span><span class=line><span class=cl><span class=c1># 查看节点。kubectl 是一个用来跟 K8S 集群进行交互的命令行工具</span>
</span></span><span class=line><span class=cl>kubectl get node
</span></span><span class=line><span class=cl><span class=c1># 停止集群</span>
</span></span><span class=line><span class=cl>minikube stop
</span></span><span class=line><span class=cl><span class=c1># 清空集群</span>
</span></span><span class=line><span class=cl>minikube delete --all
</span></span><span class=line><span class=cl><span class=c1># 安装集群可视化 Web UI 控制台</span>
</span></span><span class=line><span class=cl>minikube dashboard
</span></span></code></pre></td></tr></table></div></div><h4 id=裸机搭建>裸机搭建</h4><blockquote><p>Bare Metal</p></blockquote><p><strong>主节点需要组件</strong></p><ul><li>docker（也可以是其他容器运行时）</li><li>kubectl 集群命令行交互工具</li><li>kubeadm 集群初始化工具</li></ul><p><strong>工作节点需要组件</strong> <a href=https://kubernetes.io/zh/docs/concepts/overview/components/#node-components target=_blank rel="external nofollow noopener noreferrer">文档</a></p><ul><li>docker（也可以是其他容器运行时）</li><li>kubelet：管理 Pod 和容器，确保他们健康稳定运行。</li><li>kube-proxy：网络代理，负责网络相关的工作</li></ul><blockquote><p>你也可以试下 <a href=https://github.com/lework/kainstall target=_blank rel="external nofollow noopener noreferrer">这个项目</a>，用脚本快速搭建 K8S 裸机集群
当然，为了更好的理解，你应该先手动搭建一次</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 每个节点分别设置对应主机名</span>
</span></span><span class=line><span class=cl>hostnamectl set-hostname master
</span></span><span class=line><span class=cl>hostnamectl set-hostname node1
</span></span><span class=line><span class=cl>hostnamectl set-hostname node2
</span></span><span class=line><span class=cl><span class=c1># 所有节点都修改 hosts</span>
</span></span><span class=line><span class=cl>vim /etc/hosts
</span></span><span class=line><span class=cl>172.16.32.2 node1
</span></span><span class=line><span class=cl>172.16.32.6 node2
</span></span><span class=line><span class=cl>172.16.0.4 master
</span></span><span class=line><span class=cl><span class=c1># 所有节点关闭 SELinux</span>
</span></span><span class=line><span class=cl>setenforce <span class=m>0</span>
</span></span><span class=line><span class=cl>sed -i --follow-symlinks <span class=s1>&#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39;</span> /etc/sysconfig/selinux
</span></span></code></pre></td></tr></table></div></div><p>所有节点确保防火墙关闭</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>systemctl stop firewalld
</span></span><span class=line><span class=cl>systemctl disable firewalld
</span></span></code></pre></td></tr></table></div></div><p>所有节点添加安装源</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 添加 k8s 安装源</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; kubernetes.repo
</span></span></span><span class=line><span class=cl><span class=s>[kubernetes]
</span></span></span><span class=line><span class=cl><span class=s>name=Kubernetes
</span></span></span><span class=line><span class=cl><span class=s>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span class=line><span class=cl><span class=s>enabled=1
</span></span></span><span class=line><span class=cl><span class=s>gpgcheck=0
</span></span></span><span class=line><span class=cl><span class=s>repo_gpgcheck=0
</span></span></span><span class=line><span class=cl><span class=s>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>mv kubernetes.repo /etc/yum.repos.d/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加 Docker 安装源</span>
</span></span><span class=line><span class=cl>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span></code></pre></td></tr></table></div></div><p>所有节点安装所需组件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># CentOS</span>
</span></span><span class=line><span class=cl>yum install -y kubelet-1.22.4 kubectl-1.22.4 kubeadm-1.22.4 docker-ce
</span></span><span class=line><span class=cl><span class=c1># ubuntu 没试过</span>
</span></span><span class=line><span class=cl>apt-get install -y kubelet-1.22.4 kubectl-1.22.4 kubeadm-1.22.4 docker-ce
</span></span></code></pre></td></tr></table></div></div><blockquote><p>1.24 以上的版本会报错，因为默认不主持 Docker 了 T T</p></blockquote><p>所有节点启动 kubelet、docker，并设置开机启动</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>systemctl <span class=nb>enable</span> kubelet
</span></span><span class=line><span class=cl>systemctl start kubelet
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> docker
</span></span><span class=line><span class=cl>systemctl start docker
</span></span></code></pre></td></tr></table></div></div><p>所有节点修改 docker 配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># kubernetes 官方推荐 docker 等使用 systemd 作为 cgroupdriver，否则 kubelet 启动不了</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; daemon.json
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span class=line><span class=cl><span class=s>  &#34;registry-mirrors&#34;: [&#34;https://ud6340vz.mirror.aliyuncs.com&#34;]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>mv daemon.json /etc/docker/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 重启生效</span>
</span></span><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl restart docker
</span></span></code></pre></td></tr></table></div></div><p><strong>主节点</strong>用 <a href=https://kubernetes.io/docs/reference/setup-tools/kubeadm/ target=_blank rel="external nofollow noopener noreferrer">kubeadm</a> 初始化集群</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 初始化集群控制台 Control plane</span>
</span></span><span class=line><span class=cl><span class=c1># 失败了可以用 kubeadm reset 重置</span>
</span></span><span class=line><span class=cl>kubeadm init --image-repository<span class=o>=</span>registry.aliyuncs.com/google_containers
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 记得把 kubeadm join xxx 保存起来</span>
</span></span><span class=line><span class=cl><span class=c1># 忘记了重新获取：kubeadm token create --print-join-command</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 复制授权文件，以便 kubectl 可以有权限访问集群</span>
</span></span><span class=line><span class=cl><span class=c1># 如果你其他节点需要访问集群，需要从主节点复制这个文件过去其他节点</span>
</span></span><span class=line><span class=cl>mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在其他机器上创建 ~/.kube/config 文件也能通过 kubectl 访问到集群</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>有兴趣了解 kubeadm init 具体做了什么的，可以 <a href=https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/ target=_blank rel="external nofollow noopener noreferrer">查看文档</a></p></blockquote><p><strong>工作节点</strong>加入集群</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubeadm join &lt;master_ip&gt;:6443 --token xxx --discovery-token-ca-cert-hash xxx
</span></span></code></pre></td></tr></table></div></div><p><strong>主节点</strong>安装网络插件，否则 node 是 NotReady 状态</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 很有可能国内网络访问不到这个资源，你可以网上找找国内的源安装 flannel</span>
</span></span><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span></code></pre></td></tr></table></div></div><p>查看节点，要在主节点查看（其他节点有安装 kubectl 也可以查看）</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kw8x2qdf.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kw8x2qdf.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kw8x2qdf.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kw8x2qdf.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kw8x2qdf.png title=image.png></p><h3 id=部署应用>部署应用</h3><h4 id=使用-yaml-文件>使用 YAML 文件</h4><p>部署示例应用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl run testapp --image<span class=o>=</span>ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v1
</span></span></code></pre></td></tr></table></div></div><h5 id=pod>Pod</h5><p>直接部署一个 pod</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 定义容器，可以多个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-k8s</span><span class=w> </span><span class=c># 容器名字</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v1</span><span class=w> </span><span class=c># 镜像</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=deployment>Deployment</h5><p>使用 Deployment 来部署多个 pod</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 部署名字</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 用来查找关联的 Pod，所有标签都匹配才行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>test-k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 定义 Pod 相关数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>test-k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 定义容器，可以多个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-k8s</span><span class=w> </span><span class=c># 容器名字</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v1</span><span class=w> </span><span class=c># 镜像</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Deployment 通过 label 关联起来 Pods</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwpt8p8o.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwpt8p8o.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwpt8p8o.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwpt8p8o.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwpt8p8o.png title=deployment.png></p><h4 id=相关指令>相关指令</h4><p>部署一个 nodejs web 应用，源码地址：<a href=https://github.com/gzyunke/test-k8s target=_blank rel="external nofollow noopener noreferrer">Github</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 部署应用</span>
</span></span><span class=line><span class=cl>kubectl apply -f app.yaml
</span></span><span class=line><span class=cl><span class=c1># 查看 deployment</span>
</span></span><span class=line><span class=cl>kubectl get deployment
</span></span><span class=line><span class=cl><span class=c1># 查看 pod</span>
</span></span><span class=line><span class=cl>kubectl get pod -o wide
</span></span><span class=line><span class=cl><span class=c1># 查看 pod 详情</span>
</span></span><span class=line><span class=cl>kubectl describe pod &lt;pod-name&gt;
</span></span><span class=line><span class=cl><span class=c1># 查看 log</span>
</span></span><span class=line><span class=cl>kubectl logs &lt;pod-name&gt;
</span></span><span class=line><span class=cl><span class=c1># 进入 Pod 容器终端， -c container-name 可以指定进入哪个容器。</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it &lt;pod-name&gt; -- bash
</span></span><span class=line><span class=cl><span class=c1># 伸缩扩展副本</span>
</span></span><span class=line><span class=cl>kubectl scale deployment &lt;deployment-name&gt; --replicas<span class=o>=</span><span class=m>5</span>
</span></span><span class=line><span class=cl><span class=c1># 把集群内端口映射到节点，这个命令的进程要一直开着</span>
</span></span><span class=line><span class=cl>kubectl port-forward &lt;pod-name&gt; 8090:8080
</span></span><span class=line><span class=cl><span class=c1># 查看历史</span>
</span></span><span class=line><span class=cl>kubectl rollout <span class=nb>history</span> deployment &lt;deployment-name&gt;
</span></span><span class=line><span class=cl><span class=c1># 回到上个版本</span>
</span></span><span class=line><span class=cl>kubectl rollout undo deployment &lt;deployment-name&gt;
</span></span><span class=line><span class=cl><span class=c1># 回到指定版本</span>
</span></span><span class=line><span class=cl>kubectl rollout undo deployment &lt;deployment-name&gt; --to-revision<span class=o>=</span><span class=m>2</span>
</span></span><span class=line><span class=cl><span class=c1># 删除部署</span>
</span></span><span class=line><span class=cl>kubectl delete deployment test-k8s
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>Pod 报错解决</strong></p><p>如果你运行 <code>kubectl describe pod/pod-name</code> 发现 Events 中有下面这个错误</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>networkPlugin cni failed to set up pod &#34;test-k8s-68bb74d654-mc6b9_default&#34; network: open /run/flannel/subnet.env: no such file or directory
</span></span></code></pre></td></tr></table></div></div><p>在每个节点创建文件<code>/run/flannel/subnet.env</code>写入以下内容，配置后等待一会就好了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>FLANNEL_NETWORK=10.244.0.0/16
</span></span><span class=line><span class=cl>FLANNEL_SUBNET=10.244.0.1/24
</span></span><span class=line><span class=cl>FLANNEL_MTU=1450
</span></span><span class=line><span class=cl>FLANNEL_IPMASQ=true
</span></span></code></pre></td></tr></table></div></div></blockquote><p><strong>更多命令</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 查看全部</span>
</span></span><span class=line><span class=cl>kubectl get all
</span></span><span class=line><span class=cl><span class=c1># 重新部署</span>
</span></span><span class=line><span class=cl>kubectl rollout restart deployment test-k8s
</span></span><span class=line><span class=cl><span class=c1># 命令修改镜像，--record 表示把这个命令记录到操作历史中</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>set</span> image deployment test-k8s test-k8s<span class=o>=</span>ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v2-with-error --record
</span></span><span class=line><span class=cl><span class=c1># 暂停运行，暂停后，对 deployment 的修改不会立刻生效，恢复后才应用设置</span>
</span></span><span class=line><span class=cl>kubectl rollout pause deployment test-k8s
</span></span><span class=line><span class=cl><span class=c1># 恢复</span>
</span></span><span class=line><span class=cl>kubectl rollout resume deployment test-k8s
</span></span><span class=line><span class=cl><span class=c1># 输出到文件</span>
</span></span><span class=line><span class=cl>kubectl get deployment test-k8s -o yaml &gt;&gt; app2.yaml
</span></span><span class=line><span class=cl><span class=c1># 删除全部资源</span>
</span></span><span class=line><span class=cl>kubectl delete all --all
</span></span></code></pre></td></tr></table></div></div><p>将 Pod 指定到某个节点运行：<a href=https://kubernetes.io/zh/docs/concepts/scheduling-eviction/assign-pod-node/#nodeselector target=_blank rel="external nofollow noopener noreferrer">nodeselector</a></p><p>限定 CPU、内存总量：<a href=https://kubernetes.io/zh/docs/concepts/policy/resource-quotas/#%e8%ae%a1%e7%ae%97%e8%b5%84%e6%ba%90%e9%85%8d%e9%a2%9d target=_blank rel="external nofollow noopener noreferrer">文档</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>disktype</span><span class=p>:</span><span class=w> </span><span class=l>ssd</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=工作负载分类>工作负载分类</h4><p>详见 <a href=https://kubernetes.io/zh/docs/concepts/workloads/ target=_blank rel="external nofollow noopener noreferrer">文档</a></p><ul><li>Deployment<ul><li>适合无状态应用，所有 pod 等价，可替代</li></ul></li><li>StatefulSet<ul><li>有状态的应用，适合数据库这种类型。</li></ul></li><li>DaemonSet<ul><li>在每个节点上跑一个 Pod，可以用来做节点监控、节点日志收集等</li></ul></li><li>Job & CronJob<ul><li>Job 用来表达的是一次性的任务，而 CronJob 会根据其时间规划反复运行。</li></ul></li></ul><h4 id=现存问题>现存问题</h4><ul><li>每次只能访问一个 pod，没有负载均衡自动转发到不同 pod</li><li>访问还需要端口转发</li><li>Pod 重创后 IP 变了，名字也变了</li></ul><h3 id=service>service</h3><p><strong>特性</strong></p><ul><li>Service 通过 label 关联对应的 Pod</li><li>Servcie 生命周期不跟 Pod 绑定，不会因为 Pod 重创改变 IP</li><li>提供了负载均衡功能，自动转发流量到不同 Pod</li><li>可对集群外部提供访问端口</li><li>集群内部可通过服务名字访问</li></ul><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwpuoh0h.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwpuoh0h.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwpuoh0h.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwpuoh0h.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwpuoh0h.png title=img></p><h4 id=创建-service>创建 Service</h4><p>创建 一个 Service，通过标签 <code>test-k8s</code> 跟对应的 Pod 关联上</p><p><code>service.yaml</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>test-k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>        </span><span class=c># 本 Service 的端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>  </span><span class=c># 容器端口</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>应用配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -f service.yaml
</span></span></code></pre></td></tr></table></div></div><p>查看服务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl get svc
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvie6pw.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvie6pw.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvie6pw.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvie6pw.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvie6pw.png title="kubernetes service"></p><p>查看服务详情</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl describe svc test-k8s
</span></span></code></pre></td></tr></table></div></div><p>可以发现 Endpoints 是各个 Pod 的 IP，也就是他会把流量转发到这些节点。</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvifqes.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvifqes.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvifqes.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvifqes.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvifqes.png title="kubernetes endpoints"></p><p>服务的默认类型是 <code>ClusterIP</code>，<strong>只能在集群内部访问</strong>，我们可以进入到 Pod 里面访问：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it &lt;pod-name&gt; -- bash
</span></span><span class=line><span class=cl>curl http://&lt;service-name&gt;:8080 <span class=c1># 通过service的名字作为域名去访问</span>
</span></span><span class=line><span class=cl>curl http://&lt;service-ip&gt;:8080 <span class=c1># 用service的ip也能访问</span>
</span></span></code></pre></td></tr></table></div></div><p>如果要在集群外部访问，可以通过端口转发实现（只适合临时测试用）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl port-forward service/test-k8s 8888:8080 <span class=c1># 将8080转发到8888</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>如果你用 minikube，也可以运行 <code>minikube service test-k8s</code></p></blockquote><h4 id=对外暴露服务>对外暴露服务</h4><p>上面我们是通过端口转发的方式可以在外面访问到集群里的服务，如果想要直接把集群服务暴露出来，我们可以使用<code>NodePort</code> 和 <code>Loadbalancer</code> 类型的 Service</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>test-k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 默认 ClusterIP 集群内可访问，NodePort 节点可访问，LoadBalancer 负载均衡模式（需要负载均衡器才可用）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>        </span><span class=c># 本 Service 的端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>  </span><span class=c># 容器端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>31000</span><span class=w>   </span><span class=c># 节点端口，范围固定 30000 ~ 32767</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>应用配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -f service.yaml
</span></span></code></pre></td></tr></table></div></div><p><strong>在节点上</strong>，我们可以 <code>curl http://localhost:31000/hello/easydoc</code> 访问到应用</p><p>并且是有负载均衡的，网页的信息可以看到被转发到了不同的 Pod</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>hello easydoc 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>IP lo172.17.0.8, hostname: test-k8s-68bb74d654-962lh
</span></span></code></pre></td></tr></table></div></div><blockquote><p>如果你是用 minikube，因为是模拟集群，你的电脑并不是节点，节点是 minikube 模拟出来的，所以你并不能直接在电脑上访问到服务</p></blockquote><p><code>Loadbalancer</code> 也可以对外提供服务，这需要一个负载均衡器的支持，因为它需要生成一个新的 IP 对外服务，否则状态就一直是 pendding，这个很少用了，后面我们会讲更高端的 Ingress 来代替它。</p><h4 id=多端口>多端口</h4><p>多端口时必须配置 name， <a href=https://kubernetes.io/zh/docs/concepts/services-networking/service/#multi-port-services target=_blank rel="external nofollow noopener noreferrer">文档</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>test-k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>        </span><span class=c># 本 Service 的端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-k8s   </span><span class=w> </span><span class=c># 必须配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>  </span><span class=c># 容器端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>31000</span><span class=w>   </span><span class=c># 节点端口，范围固定 30000 ~ 32767</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-other</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>32000</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=总结>总结</h4><ul><li><p><strong>ClusterIP</strong></p><ul><li>默认的，仅在集群内可用</li></ul></li><li><p><strong>NodePort</strong></p><ul><li>暴露端口到节点，提供了集群外部访问的入口
端口范围固定 30000 ~ 32767</li></ul></li><li><p><strong>LoadBalancer</strong></p><ul><li>需要负载均衡器（通常都需要云服务商提供，裸机可以安装 <a href=https://metallb.universe.tf/ target=_blank rel="external nofollow noopener noreferrer">METALLB</a> 测试）
会额外生成一个 IP 对外服务
K8S 支持的负载均衡器：<a href=https://kubernetes.io/zh/docs/concepts/services-networking/service/#internal-load-balancer target=_blank rel="external nofollow noopener noreferrer">负载均衡器</a></li></ul></li><li><p><strong>Headless</strong></p><ul><li>适合数据库</li><li>clusterIp 设置为 None 就变成 Headless 了，不会再分配 IP，后面会再讲到具体用法</li><li><a href=https://kubernetes.io/zh/docs/concepts/services-networking/service/#headless-services target=_blank rel="external nofollow noopener noreferrer">官网文档</a></li></ul></li></ul><h3 id=statefulset>StatefulSet</h3><h4 id=什么是-statefulset>什么是 StatefulSet</h4><p>StatefulSet 是用来管理<strong>有状态</strong>的应用，例如数据库。</p><p>前面我们部署的应用，都是不需要存储数据，不需要记住状态的，可以随意扩充副本，每个副本都是一样的，可替代的。</p><p>而像数据库、Redis 这类有状态的，则不能随意扩充副本。</p><p>StatefulSet 会固定每个 Pod 的名字</p><h4 id=部署-statefulset-类型的-mongodb>部署 StatefulSet 类型的 Mongodb</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># serviceName: mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mongo:4.4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  对应的 service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w> </span><span class=c># 跟pod对应上</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w> </span><span class=c># HeadLess，不分配ip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>27017</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>27017</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=statefulset-特性>StatefulSet 特性</h4><ul><li>Service 的 <code>CLUSTER-IP</code> 是空的，Pod 名字也是固定的。</li><li>Pod 创建和销毁是有序的，创建是顺序的，销毁是逆序的。</li><li>Pod 重建不会改变名字，但是 IP 还是会变的，所以不要用 IP 直连</li></ul><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwrhzaku.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwrhzaku.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwrhzaku.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwrhzaku.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwrhzaku.png title=statefulset.png></p><p>Endpoints 会多一个 hostname</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwri1g2g.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwri1g2g.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwri1g2g.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwri1g2g.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwri1g2g.png title=endpoints></p><p>访问时，如果直接使用 Service 名字连接，会随机转发请求</p><p>要连接指定 Pod，可以这样<code>pod-name.service-name</code></p><p>运行一个临时 Pod 连接数据测试下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl run mongodb-client --rm --tty -i --restart<span class=o>=</span><span class=s1>&#39;Never&#39;</span> --image docker.io/bitnami/mongodb:4.4.10-debian-10-r20 --command -- bash
</span></span></code></pre></td></tr></table></div></div><h4 id=web-应用连接-mongodb>Web 应用连接 Mongodb</h4><p>在集群内部，我们可以通过服务名字访问到不同的服务</p><p>指定连接第一个：<code>mongodb-0.mongodb</code></p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwriial2 data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwriial2, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwriial2 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwriial2 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwriial2 title=mongodbweb.png></p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwripe9o.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwripe9o.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwripe9o.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwripe9o.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwripe9o.png title=image.png></p><h4 id=问题>问题</h4><p><strong>pod 重建后，数据库的内容丢失了</strong></p><p>下节，我们讲解如何解决这个问题。</p><h3 id=数据持久化>数据持久化</h3><h4 id=介绍>介绍</h4><p>kubernetes 集群不会为你处理数据的存储，我们可以为数据库挂载一个磁盘来确保数据的安全。</p><p>你可以选择云存储、本地磁盘、NFS。</p><ul><li>本地磁盘：可以挂载某个节点上的目录，但是这需要限定 pod 在这个节点上运行</li><li>云存储：不限定节点，不受集群影响，安全稳定；需要云服务商提供，裸机集群是没有的。</li><li>NFS：不限定节点，不受集群影响</li></ul><h4 id=hostpath-挂载示例>hostPath 挂载示例</h4><p>把节点上的一个目录挂载到 Pod，但是已经<strong>不推荐使用了</strong>，<a href=https://kubernetes.io/zh/docs/concepts/storage/volumes/#hostpath target=_blank rel="external nofollow noopener noreferrer">文档</a></p><p>配置方式简单，需要手动指定 Pod 跑在某个固定的节点。</p><p>仅供单节点测试使用；不适用于多节点集群。</p><blockquote><p>minikube 提供了 hostPath 存储，<a href=https://minikube.sigs.k8s.io/docs/handbook/persistent_volumes/ target=_blank rel="external nofollow noopener noreferrer">文档</a></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mongo:4.4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/data/db</span><span class=w> </span><span class=c># 容器里面的挂载路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongo-data   </span><span class=w> </span><span class=c># 卷名字，必须跟下面定义的名字一致</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongo-data             </span><span class=w> </span><span class=c># 卷名字</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/data/mongo-data     </span><span class=w> </span><span class=c># 节点上的路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>DirectoryOrCreate    </span><span class=w> </span><span class=c># 指向一个目录，不存在时自动创建</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=更高级的抽象>更高级的抽象</h4><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwrmidne.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwrmidne.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwrmidne.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwrmidne.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwrmidne.png title=持久卷></p><h5 id=storage-class-sc>Storage Class (SC)</h5><p>将存储卷划分为不同的种类，例如：SSD，普通磁盘，本地磁盘，按需使用。<a href=https://kubernetes.io/zh/docs/concepts/storage/storage-classes/ target=_blank rel="external nofollow noopener noreferrer">文档</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>storage.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StorageClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>slow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>provisioner</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/aws-ebs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>io1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>iopsPerGB</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fsType</span><span class=p>:</span><span class=w> </span><span class=l>ext4</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=persistent-volume-pv>Persistent Volume (PV)</h5><p>描述卷的具体信息，例如磁盘大小，<a href=https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#access-modes target=_blank rel="external nofollow noopener noreferrer">访问模式</a>。<a href=https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/ target=_blank rel="external nofollow noopener noreferrer">文档</a>，<a href=https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes target=_blank rel="external nofollow noopener noreferrer">类型</a>，<a href=https://kubernetes.io/zh/docs/concepts/storage/volumes/#local target=_blank rel="external nofollow noopener noreferrer">Local 示例</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongodata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeMode</span><span class=p>:</span><span class=w> </span><span class=l>Filesystem </span><span class=w> </span><span class=c># Filesystem（文件系统） Block（块）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce      </span><span class=w> </span><span class=c># 卷可以被一个节点以读写方式挂载</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Delete</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>local-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>local</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/root/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>required</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 通过 hostname 限定在某个节点创建存储卷</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/hostname</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>node2</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=persistent-volume-claim-pvc>Persistent Volume Claim (PVC)</h5><p>对存储需求的一个申明，可以理解为一个申请单，系统根据这个申请单去找一个合适的 PV
还可以根据 PVC 自动创建 PV。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongodata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;ReadWriteOnce&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;local-storage&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=为什么要这么多层抽象>为什么要这么多层抽象</h5><ul><li>更好的分工，运维人员负责提供好存储，开发人员不需要关注磁盘细节，只需要写一个申请单。</li><li>方便云服务商提供不同类型的，配置细节不需要开发者关注，只需要一个申请单。</li><li><a href=https://kubernetes.io/zh/docs/concepts/storage/dynamic-provisioning/ target=_blank rel="external nofollow noopener noreferrer">动态创建</a>，开发人员写好申请单后，供应商可以根据需求自动创建所需存储卷。</li></ul><h4 id=腾讯云示例>腾讯云示例</h4><p>配置可视化操作，最后还会生成 yml 文件，很棒</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvrj64s.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvrj64s.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvrj64s.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvrj64s.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvrj64s.png title="腾讯云创建kubernetes pvc"></p><h4 id=本地磁盘示例>本地磁盘示例</h4><p>不支持动态创建，需要提前创建好</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mongo:5.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/data/db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongo-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongo-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w> </span><span class=c># pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>mongodata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>27017</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>27017</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># sc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>storage.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StorageClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>local-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>provisioner</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/no-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumeBindingMode</span><span class=p>:</span><span class=w> </span><span class=l>WaitForFirstConsumer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># pv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongodata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeMode</span><span class=p>:</span><span class=w> </span><span class=l>Filesystem </span><span class=w> </span><span class=c># Filesystem（文件系统） Block（块）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce      </span><span class=w> </span><span class=c># 卷可以被一个节点以读写方式挂载</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Delete</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>local-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>local</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/root/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>required</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 通过 hostname 限定在某个节点创建存储卷</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/hostname</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongodata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;ReadWriteOnce&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;local-storage&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=问题-1>问题</h4><p>当前数据库的连接地址是写死在代码里的，另外还有数据库的密码需要配置。</p><p>下节，我们讲解如何解决。</p><h3 id=配置文件>配置文件</h3><h4 id=configmap>ConfigMap</h4><p>数据库连接地址，这种可能根据部署环境变化的，我们不应该写死在代码里。
Kubernetes 为我们提供了 ConfigMap，可以方便的配置一些变量。<a href=https://kubernetes.io/zh/docs/concepts/configuration/configmap/ target=_blank rel="external nofollow noopener noreferrer">文档</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># configmap.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongo-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mongoHost</span><span class=p>:</span><span class=w> </span><span class=l>mongodb-0.mongodb</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 应用</span>
</span></span><span class=line><span class=cl>kubectl apply -f configmap.yaml
</span></span><span class=line><span class=cl><span class=c1># 查看</span>
</span></span><span class=line><span class=cl>kubectl get configmap mongo-config -o yaml
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://sjwx.easydoc.xyz/46901064/files/kwubdzyw.png data-srcset="https://sjwx.easydoc.xyz/46901064/files/kwubdzyw.png, https://sjwx.easydoc.xyz/46901064/files/kwubdzyw.png 1.5x, https://sjwx.easydoc.xyz/46901064/files/kwubdzyw.png 2x" data-sizes=auto alt=https://sjwx.easydoc.xyz/46901064/files/kwubdzyw.png title=configmap.png></p><h4 id=secret>Secret</h4><p>一些重要数据，例如密码、TOKEN，我们可以放到 secret 中。<a href=https://kubernetes.io/zh/docs/concepts/configuration/secret/ target=_blank rel="external nofollow noopener noreferrer">文档</a>，<a href=https://kubernetes.io/zh/docs/concepts/configuration/secret/#tls-secret target=_blank rel="external nofollow noopener noreferrer">配置证书</a></p><blockquote><p>注意，数据要进行 Base64 编码。<a href=https://tools.fun/base64.html target=_blank rel="external nofollow noopener noreferrer">Base64 工具</a></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># secret.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongo-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Opaque 用户定义的任意数据，更多类型介绍 https://kubernetes.io/zh/docs/concepts/configuration/secret/#secret-types</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 数据要 base64。https://tools.fun/base64.html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mongo-username</span><span class=p>:</span><span class=w> </span><span class=l>bW9uZ291c2Vy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mongo-password</span><span class=p>:</span><span class=w> </span><span class=l>bW9uZ29wYXNz</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 应用</span>
</span></span><span class=line><span class=cl>kubectl apply -f secret.yaml
</span></span><span class=line><span class=cl><span class=c1># 查看</span>
</span></span><span class=line><span class=cl>kubectl get secret mongo-secret -o yaml
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://sjwx.easydoc.xyz/46901064/files/kwub4een.png data-srcset="https://sjwx.easydoc.xyz/46901064/files/kwub4een.png, https://sjwx.easydoc.xyz/46901064/files/kwub4een.png 1.5x, https://sjwx.easydoc.xyz/46901064/files/kwub4een.png 2x" data-sizes=auto alt=https://sjwx.easydoc.xyz/46901064/files/kwub4een.png title=image.png></p><h4 id=使用方法>使用方法</h4><h5 id=作为环境变量使用>作为环境变量使用</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mongo:4.4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MONGO_INITDB_ROOT_USERNAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongo-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>mongo-username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MONGO_INITDB_ROOT_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mongo-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>mongo-password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># Secret 的所有数据定义为容器的环境变量，Secret 中的键名称为 Pod 中的环境变量名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># envFrom:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># - secretRef:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c>#     name: mongo-secret</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=挂载为文件更适合证书文件>挂载为文件（更适合证书文件）</h5><p>挂载后，会在容器中对应路径生成文件，一个 key 一个文件，内容就是 value，<a href=https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets-as-files-from-a-pod target=_blank rel="external nofollow noopener noreferrer">文档</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mypod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mypod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/etc/foo&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=helm--命名空间>Helm & 命名空间</h3><h4 id=介绍-1>介绍</h4><p><code>Helm</code> 类似 npm，pip，docker hub, 可以理解为是一个软件库，可以方便快速的为我们的集群安装一些第三方软件。
使用 Helm 我们可以非常方便的就搭建出来 MongoDB / MySQL 副本集群，YAML 文件别人都给我们写好了，直接使用。<a href=https://helm.sh/zh/ target=_blank rel="external nofollow noopener noreferrer">官网</a>，<a href=https://artifacthub.io/ target=_blank rel="external nofollow noopener noreferrer">应用中心</a></p><h4 id=安装-helm>安装 Helm</h4><p>安装 <a href=https://helm.sh/zh/docs/intro/install/ target=_blank rel="external nofollow noopener noreferrer">文档</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 <span class=p>|</span> bash
</span></span></code></pre></td></tr></table></div></div><h4 id=安装-mongodb-示例>安装 MongoDB 示例</h4><p>一个主从 mongo</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># 安装</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>helm repo add bitnami https://charts.bitnami.com/bitnami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>helm install my-mongo bitnami/mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 指定密码和架构</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>helm install my-mongo bitnami/mongodb --set architecture=&#34;replicaset&#34;,auth.rootPassword=&#34;mongopass&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 删除</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>helm ls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>heml delete my-mongo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 查看密码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubectl get secret my-mongo-mongodb -o json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubectl get secret my-mongo-mongodb -o yaml &gt; secret.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 临时运行一个包含 mongo client 的 debian 系统</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubectl run mongodb-client --rm --tty -i --restart=&#39;Never&#39; --image docker.io/bitnami/mongodb:4.4.10-debian-10-r20 --command -- bash</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 进去 mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>mongo --host &#34;my-mongo-mongodb&#34; -u root -p mongopass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 也可以转发集群里的端口到宿主机访问 mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubectl port-forward svc/my-mongo-mongodb 27017:27018</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=命名空间>命名空间</h4><p>如果一个集群中部署了多个应用，所有应用都在一起，就不太好管理，也可以导致名字冲突等。
我们可以使用 namespace 把应用划分到不同的命名空间，跟代码里的 namespace 是一个概念，只是为了划分空间。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 打印命名空间</span>
</span></span><span class=line><span class=cl>kubectl get ns
</span></span><span class=line><span class=cl><span class=c1># 创建命名空间</span>
</span></span><span class=line><span class=cl>kubectl create namespace testapp
</span></span><span class=line><span class=cl><span class=c1># 部署应用到指定的命名空间</span>
</span></span><span class=line><span class=cl>kubectl apply -f app.yml --namespace testapp
</span></span><span class=line><span class=cl><span class=c1># 查询</span>
</span></span><span class=line><span class=cl>kubectl get pod --namespace kube-system
</span></span></code></pre></td></tr></table></div></div><h5 id=kubens>kubens</h5><p>可以用 <a href=https://github.com/ahmetb/kubectx target=_blank rel="external nofollow noopener noreferrer">kubens</a> 快速切换 namespace</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 切换命名空间</span>
</span></span><span class=line><span class=cl>kubens kube-system
</span></span><span class=line><span class=cl><span class=c1># 回到上个命名空间</span>
</span></span><span class=line><span class=cl>kubens -
</span></span><span class=line><span class=cl><span class=c1># 切换集群</span>
</span></span><span class=line><span class=cl>kubectx minikube
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwudup5z.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwudup5z.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwudup5z.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwudup5z.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwudup5z.png title=image.png></p><h3 id=ingress>Ingress</h3><p>Ingress 为外部访问集群提供了一个 <strong>统一</strong> 入口，避免了对外暴露集群端口；</p><p>功能类似 Nginx，可以根据域名、路径把请求转发到不同的 Service。</p><p>可以配置 https</p><blockquote><p><strong>跟 LoadBalancer 有什么区别？</strong></p><p>LoadBalancer 需要对外暴露端口，不安全；</p><p>无法根据域名、路径转发流量到不同 Service，多个 Service 则需要开多个 LoadBalancer；</p><p>功能单一，无法配置 https</p></blockquote><img src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwhd6dc8.png alt=img style=zoom:80%><h4 id=使用>使用</h4><p>要使用 Ingress，需要一个负载均衡器 + Ingress Controller</p><ul><li><p>如果是裸机（bare metal）搭建的集群，你需要自己安装一个负载均衡插件，可以安装 <a href=https://metallb.universe.tf/ target=_blank rel="external nofollow noopener noreferrer">METALLB</a></p></li><li><p>如果是云服务商，会自动给你配置，否则你的外部 IP 会是 “pending” 状态，无法使用。</p></li></ul><blockquote><p>文档：<a href=https://kubernetes.io/zh/docs/concepts/services-networking/ingress/ target=_blank rel="external nofollow noopener noreferrer">Ingress</a></p><p>Minikube 中部署 Ingress Controller：<a href=https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/ target=_blank rel="external nofollow noopener noreferrer">nginx</a></p><p>Helm 安装： <a href=https://kubernetes.github.io/ingress-nginx/deploy/#quick-start target=_blank rel="external nofollow noopener noreferrer">Nginx</a></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>simple-example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>tools.fun</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/easydoc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>service1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>4200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/svnbucket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>service2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=腾讯云配置-ingress-演示>腾讯云配置 Ingress 演示</h4><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvrrepn.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvrrepn.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvrrepn.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvrrepn.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/kwvrrepn.png title="腾讯云 ingress"></p><h3 id=其他>其他</h3><p>kubernetes 可以管理大量的容器化应用，方便的进行伸缩扩展集群，随时回退版本。
kubernetes 需要云厂商的支持才是完整的，好在当前各大云厂商都已经提供了 k8s 集群服务，生态很完善，非常方便。
我们自己搭建的叫裸机，用来做测试、学习很好，可以把自己淘汰的电脑用起来搭建出一个集群玩玩。</p><h4 id=web-可视化管理集群>WEB 可视化管理集群</h4><p>如果你觉得命令行管理集群太麻烦，你可以用 Helm 快速搭建一个 <a href=https://artifacthub.io/packages/helm/k8s-dashboard/kubernetes-dashboard target=_blank rel="external nofollow noopener noreferrer">kubernetes-dashboard</a>，这样你就有了一个 WEB 界面，可以可视化的进行一些操作和管理。
如果是 minikube 更加简单，一个命令<code>minikube dashboard</code>就好了。</p><h4 id=数据库更好的做法>数据库更好的做法</h4><p>数据库这种有状态的应用，更好的做法是直接使用云厂商提供的数据库，运行会更加稳定，也有完善的数据备份。</p><h4 id=用脚本搭建集群>用脚本搭建集群</h4><p>Github 上有用户已经把裸机搭建需要做的工作写成了脚本，一个脚本就帮你初始化好集群工作：<a href=https://github.com/lework/kainstall target=_blank rel="external nofollow noopener noreferrer">kainstall</a></p><h4 id=公网搭建-k8s-集群>公网搭建 K8S 集群</h4><p>网友提供的：<a href=https://ilep2pm1ty.feishu.cn/docs/doccnah39IMGdW3sY5uZWvJaX3X target=_blank rel="external nofollow noopener noreferrer">参考文档</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2023-07-05 02:59:55">更新于 2023-07-05</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://trouvaille0198.github.io/Notes/posts/%E5%B7%A5%E5%85%B7/k8s/ data-title=k8s><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://trouvaille0198.github.io/Notes/posts/%E5%B7%A5%E5%85%B7/k8s/><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://trouvaille0198.github.io/Notes/posts/%E5%B7%A5%E5%85%B7/k8s/ data-title=k8s><i class="fa-brands fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/Notes/>主页</a></span></section></div><div class=post-nav><a href=/Notes/posts/golang/%E6%A0%87%E5%87%86%E5%BA%93/exec/ class=prev rel=prev title=os/exec><i class="fa-solid fa-angle-left fa-fw"></i>os/exec</a>
<a href=/Notes/posts/useful/go-dockerfile-%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE/ class=next rel=next title="Go Dockerfile 通用配置">Go Dockerfile 通用配置<i class="fa-solid fa-angle-right fa-fw"></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line custom">酒困路长惟欲睡，日高人渴漫思茶</div><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2022 - 2023</span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><div id=mask></div></div><link rel=stylesheet href=/Notes/lib/katex/katex.min.css><link rel=stylesheet href=/Notes/lib/katex/copy-tex.min.css><link rel=stylesheet href=/Notes/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/Notes/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/Notes/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script type=text/javascript src=/Notes/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/Notes/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/Notes/lib/katex/katex.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/Notes/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:45},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"7I9AMOLA4S",algoliaIndex:"Notes",algoliaSearchKey:"3c1638dfe9f4d49a59d81ff6943416b8",highlightTag:"em",maxResultLength:30,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/Notes/js/theme.min.js defer></script><script type=text/javascript src=/Notes/js/_custom.min.js defer></script></body></html>