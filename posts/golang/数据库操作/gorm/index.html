<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Go GORM 库 - 伤心肠粉的酱油碟子</title><meta name=author content><meta name=author-link content><meta name=description content="gorm 官方文档：https://gorm.io/zh_CN/docs 1 2 3 4 5 6 7 8"><meta name=keywords content="数据库,后端"><meta itemprop=name content="Go GORM 库"><meta itemprop=description content="gorm 官方文档：https://gorm.io/zh_CN/docs 1 2 3 4 5 6 7 8"><meta itemprop=datePublished content="2022-02-14T00:00:00+00:00"><meta itemprop=dateModified content="2023-06-14T10:56:53+00:00"><meta itemprop=wordCount content="18301"><meta itemprop=image content="https://trouvaille0198.github.io/logo.png"><meta itemprop=keywords content="数据库,后端,"><meta property="og:title" content="Go GORM 库"><meta property="og:description" content="gorm 官方文档：https://gorm.io/zh_CN/docs 1 2 3 4 5 6 7 8"><meta property="og:type" content="article"><meta property="og:url" content="https://trouvaille0198.github.io/Notes/posts/golang/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/gorm/"><meta property="og:image" content="https://trouvaille0198.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-14T00:00:00+00:00"><meta property="article:modified_time" content="2023-06-14T10:56:53+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://trouvaille0198.github.io/logo.png"><meta name=twitter:title content="Go GORM 库"><meta name=twitter:description content="gorm 官方文档：https://gorm.io/zh_CN/docs 1 2 3 4 5 6 7 8"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://trouvaille0198.github.io/Notes/posts/golang/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/gorm/><link rel=prev href=https://trouvaille0198.github.io/Notes/posts/useful/%E9%85%8D%E7%BD%AE-wsl/><link rel=next href=https://trouvaille0198.github.io/Notes/posts/golang/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/go-redis/><link rel=stylesheet href=/Notes/lib/normalize/normalize.min.css><link rel=stylesheet href=/Notes/css/style.min.css><link rel=stylesheet href=/Notes/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/Notes/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Go GORM 库","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/golang\/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C\/gorm\/"},"genre":"posts","keywords":"数据库, 后端","wordcount":18301,"url":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/golang\/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C\/gorm\/","datePublished":"2022-02-14T00:00:00+00:00","dateModified":"2023-06-14T10:56:53+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"MelonCholi"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子><span class=header-title-text>伤心肠粉</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/Notes/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/Notes/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/Notes/posts/>文章</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子><span class=header-title-text>伤心肠粉</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/Notes/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/Notes/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/Notes/posts/>文章</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class="toc-content always-active" id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Go GORM 库</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle"></i>
MelonCholi</span></span>
<span class=post-category>收录于 <a href=/Notes/categories/golang/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;Golang</a></span></div><div class=post-meta-line><span title="2022-02-14 00:00:00"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-02-14>2022-02-14</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 18301 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 37 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#快速开始>快速开始</a><ul><li><a href=#安装>安装</a></li></ul></li><li><a href=#模型>模型</a><ul><li><a href=#约定>约定</a></li><li><a href=#gormmodel>gorm.Model</a></li><li><a href=#字段标签>字段标签</a></li><li><a href=#字段级权限控制>字段级权限控制</a></li><li><a href=#创建更新时间追踪纳秒毫秒秒time>创建/更新时间追踪（纳秒、毫秒、秒、Time）</a></li><li><a href=#嵌入结构体>嵌入结构体</a></li><li><a href=#关联标签>关联标签</a></li></ul></li><li><a href=#连接到数据库>连接到数据库</a><ul><li><a href=#mysql>MySQL</a><ul><li><a href=#自定义驱动>自定义驱动</a></li><li><a href=#现有的数据库连接>现有的数据库连接</a></li></ul></li><li><a href=#sqlite>SQLite</a></li></ul></li><li><a href=#连接池>连接池</a></li><li><a href=#创建>创建</a><ul><li><a href=#创建记录>创建记录</a></li><li><a href=#筛选指定字段来创建记录>筛选指定字段来创建记录</a></li><li><a href=#批量插入>批量插入</a></li><li><a href=#创建钩子>创建钩子</a></li><li><a href=#根据-map-创建>根据 Map 创建</a></li><li><a href=#使用-sql-表达式context-valuer-创建记录>使用 SQL 表达式、Context Valuer 创建记录</a></li><li><a href=#高级选项>高级选项</a><ul><li><a href=#关联创建>关联创建</a></li><li><a href=#默认值>默认值</a></li><li><a href=#upsert-及冲突>Upsert 及冲突</a></li><li><a href=#复合主键>复合主键</a></li></ul></li></ul></li><li><a href=#查询>查询</a><ul><li><a href=#检索单个对象>检索单个对象</a><ul><li><a href=#用主键检索>用主键检索</a></li></ul></li><li><a href=#检索全部对象>检索全部对象</a></li><li><a href=#条件>条件</a><ul><li><a href=#string-条件>String 条件</a></li><li><a href=#struct--map-条件>Struct & Map 条件</a></li><li><a href=#指定结构体查询字段>指定结构体查询字段</a></li><li><a href=#内联条件>内联条件</a></li><li><a href=#not-条件>Not 条件</a></li><li><a href=#or-条件>Or 条件</a></li></ul></li><li><a href=#选择特定字段>选择特定字段</a></li><li><a href=#order>Order</a></li><li><a href=#limit--offset>Limit & Offset</a></li><li><a href=#groupby--having>GroupBy & Having</a><ul><li><a href=#distinct>Distinct</a></li></ul></li><li><a href=#joins>Joins</a><ul><li><a href=#joins-预加载>Joins 预加载</a></li></ul></li><li><a href=#scan>Scan</a></li></ul></li><li><a href=#更新>更新</a><ul><li><a href=#保存所有字段>保存所有字段</a></li><li><a href=#更新单个列>更新单个列</a></li><li><a href=#更新多列>更新多列</a></li><li><a href=#更新选定字段>更新选定字段</a></li><li><a href=#更新-hook>更新 Hook</a></li><li><a href=#批量更新>批量更新</a><ul><li><a href=#阻止全局更新>阻止全局更新</a></li><li><a href=#更新的记录数>更新的记录数</a></li></ul></li><li><a href=#高级选项-1>高级选项</a><ul><li><a href=#使用-sql-表达式更新>使用 SQL 表达式更新</a></li><li><a href=#根据子查询进行更新>根据子查询进行更新</a></li><li><a href=#不使用-hook-和时间追踪>不使用 Hook 和时间追踪</a></li><li><a href=#返回修改行的数据>返回修改行的数据</a></li><li><a href=#检查字段是否有变更>检查字段是否有变更</a></li><li><a href=#在-update-时修改值>在 Update 时修改值</a></li></ul></li></ul></li><li><a href=#删除>删除</a><ul><li><a href=#删除一条记录>删除一条记录</a></li><li><a href=#根据主键删除>根据主键删除</a></li><li><a href=#delete-hook>Delete Hook</a></li><li><a href=#批量删除>批量删除</a><ul><li><a href=#阻止全局删除>阻止全局删除</a></li><li><a href=#返回删除行的数据>返回删除行的数据</a></li></ul></li><li><a href=#软删除>软删除</a><ul><li><a href=#查找被软删除的记录>查找被软删除的记录</a></li><li><a href=#永久删除>永久删除</a></li><li><a href=#delete-flag>Delete Flag</a></li></ul></li></ul></li><li><a href=#关联>关联</a><ul><li><a href=#belongs-to>Belongs to</a><ul><li><a href=#重写外键>重写外键</a></li><li><a href=#重写引用>重写引用</a></li><li><a href=#外键约束>外键约束</a></li></ul></li><li><a href=#has-one>Has One</a><ul><li><a href=#重写外键-1>重写外键</a></li><li><a href=#重写引用-1>重写引用</a></li><li><a href=#多态关联>多态关联</a></li><li><a href=#自引用-has-one>自引用 Has One</a></li><li><a href=#外键约束-1>外键约束</a></li></ul></li><li><a href=#has-many>Has Many</a><ul><li><a href=#重写外键-2>重写外键</a></li><li><a href=#重写引用-2>重写引用</a></li><li><a href=#多态关联-1>多态关联</a></li><li><a href=#自引用-has-many>自引用 Has Many</a></li><li><a href=#外键约束-2>外键约束</a></li></ul></li><li><a href=#many-to-many>Many To Many</a><ul><li><a href=#反向引用>反向引用</a></li><li><a href=#重写外键-3>重写外键</a></li><li><a href=#自引用-many2many>自引用 Many2Many</a></li><li><a href=#自定义连接表>自定义连接表</a></li><li><a href=#外键约束-3>外键约束</a></li><li><a href=#复合外键>复合外键</a></li></ul></li><li><a href=#关联模式>关联模式</a><ul><li><a href=#自动创建更新>自动创建、更新</a></li><li><a href=#跳过自动创建更新>跳过自动创建、更新</a></li><li><a href=#selectomit-关联字段>Select/Omit 关联字段</a></li><li><a href=#关联模式-1>关联模式</a><ul><li><a href=#查找关联>查找关联</a></li><li><a href=#添加关联>添加关联</a></li><li><a href=#替换关联>替换关联</a></li><li><a href=#删除关联>删除关联</a></li><li><a href=#清空关联>清空关联</a></li><li><a href=#关联计数>关联计数</a></li><li><a href=#批量处理数据>批量处理数据</a></li></ul></li><li><a href=#带-select-的删除>带 Select 的删除</a></li><li><a href=#关联标签-1>关联标签</a></li></ul></li><li><a href=#预加载>预加载</a><ul><li><a href=#joins-预加载-1>Joins 预加载</a></li><li><a href=#预加载全部>预加载全部</a></li><li><a href=#带条件的预加载>带条件的预加载</a></li><li><a href=#自定义预加载-sql>自定义预加载 SQL</a></li><li><a href=#嵌套预加载>嵌套预加载</a></li></ul></li></ul></li><li><a href=#高级查询>高级查询</a><ul><li><a href=#智能选择字段>智能选择字段</a></li><li><a href=#locking-for-update>Locking (FOR UPDATE)</a></li><li><a href=#子查询>子查询</a></li><li><a href=#from-子查询>From 子查询</a></li><li><a href=#group-条件>Group 条件</a></li><li><a href=#带多个列的-in>带多个列的 in</a></li><li><a href=#命名参数>命名参数</a></li><li><a href=#find-至-map>Find 至 map</a></li><li><a href=#firstorinit>FirstOrInit</a></li><li><a href=#firstorcreate>FirstOrCreate</a></li><li><a href=#优化器索引提示>优化器、索引提示</a></li><li><a href=#迭代>迭代</a></li><li><a href=#findinbatches>FindInBatches</a></li><li><a href=#查询钩子>查询钩子</a></li><li><a href=#pluck>Pluck</a></li><li><a href=#scope>Scope</a></li><li><a href=#count>Count</a></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=gorm>gorm</h1><p>官方文档：https://gorm.io/zh_CN/docs</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;gorm.io/gorm&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;gorm.io/driver/sqlite&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Product</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Code</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Price</span> <span class=kt>uint</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>sqlite</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;test.db&#34;</span><span class=p>),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;failed to connect database&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 迁移 schema
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>db</span><span class=p>.</span><span class=nf>AutoMigrate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Product</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Create
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Product</span><span class=p>{</span><span class=nx>Code</span><span class=p>:</span> <span class=s>&#34;D42&#34;</span><span class=p>,</span> <span class=nx>Price</span><span class=p>:</span> <span class=mi>100</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Read
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>var</span> <span class=nx>product</span> <span class=nx>Product</span>
</span></span><span class=line><span class=cl>  <span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=c1>// 根据整型主键查找
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>,</span> <span class=s>&#34;code = ?&#34;</span><span class=p>,</span> <span class=s>&#34;D42&#34;</span><span class=p>)</span> <span class=c1>// 查找 code 字段值为 D42 的记录
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// Update - 将 product 的 price 更新为 200
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;Price&#34;</span><span class=p>,</span> <span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Update - 更新多个字段
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=nx>Product</span><span class=p>{</span><span class=nx>Price</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span> <span class=nx>Code</span><span class=p>:</span> <span class=s>&#34;F42&#34;</span><span class=p>})</span> <span class=c1>// 仅更新非零值字段
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;Price&#34;</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span> <span class=s>&#34;Code&#34;</span><span class=p>:</span> <span class=s>&#34;F42&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Delete - 删除 product
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>若要打开 MySQL</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/jinzhu/gorm&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=s>&#34;github.com/jinzhu/gorm/dialects/mysql&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 定义一个数据模型(user表)
</span></span></span><span class=line><span class=cl><span class=c1>// 列名是字段名的蛇形小写(PassWd-&gt;pass_word)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Id</span>          <span class=kt>uint</span>        <span class=s>`gorm:&#34;AUTO_INCREMENT&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>        <span class=kt>string</span>      <span class=s>`gorm:&#34;size:50&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Age</span>         <span class=kt>int</span>         <span class=s>`gorm:&#34;size:3&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Birthday</span>    <span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>    <span class=nx>Email</span>       <span class=kt>string</span>      <span class=s>`gorm:&#34;type:varchar(50);unique_index&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>PassWord</span>    <span class=kt>string</span>      <span class=s>`gorm:&#34;type:varchar(25)&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>db</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>,</span><span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span><span class=s>&#34;root:bgbiao.top@(127.0.0.1:13306)/test_api?charset=utf8&amp;parseTime=True&amp;loc=Local&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;创建数据库连接失败:%v&#34;</span><span class=p>,</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// defer db.Close() // GORM v2 不需要此步
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 自动迁移数据结构(table schema)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 注意:在gorm中，默认的表名都是结构体名称的复数形式，比如User结构体默认创建的表为users
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.SingularTable(true) 可以取消表名的复数形式，使得表名和结构体名称一致
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>db</span><span class=p>.</span><span class=nf>AutoMigrate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 添加唯一索引
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>AddUniqueIndex</span><span class=p>(</span><span class=s>&#34;name_email&#34;</span><span class=p>,</span> <span class=s>&#34;id&#34;</span><span class=p>,</span> <span class=s>&#34;name&#34;</span><span class=p>,</span><span class=s>&#34;email&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 插入记录
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span><span class=s>&#34;bgbiao&#34;</span><span class=p>,</span><span class=nx>Age</span><span class=p>:</span><span class=mi>18</span><span class=p>,</span><span class=nx>Email</span><span class=p>:</span><span class=s>&#34;bgbiao@bgbiao.top&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span><span class=s>&#34;xxb&#34;</span><span class=p>,</span><span class=nx>Age</span><span class=p>:</span><span class=mi>18</span><span class=p>,</span><span class=nx>Email</span><span class=p>:</span><span class=s>&#34;xxb@bgbiao.top&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>users</span> <span class=p>[]</span><span class=nx>User</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 查看插入后的全部元素
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;插入后元素:\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 查询一条记录
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span><span class=s>&#34;bgbiao&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;查看查询记录:&#34;</span><span class=p>,</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 更新记录(基于查出来的数据进行更新)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span><span class=s>&#34;biaoge&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;更新后的记录:&#34;</span><span class=p>,</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 删除记录
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 查看全部记录
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;查看全部记录:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 运行gorm实例</span>
</span></span><span class=line><span class=cl>$ go run gorm-mysql-example.go
</span></span><span class=line><span class=cl>插入后元素:
</span></span><span class=line><span class=cl><span class=o>[{</span><span class=m>1</span> bgbiao <span class=m>18</span> &lt;nil&gt; bgbiao@bgbiao.top <span class=o>}</span> <span class=o>{</span><span class=m>2</span> xxb <span class=m>18</span> &lt;nil&gt; xxb@bgbiao.top <span class=o>}]</span>
</span></span><span class=line><span class=cl>查看查询记录: <span class=o>{</span><span class=m>1</span> bgbiao <span class=m>18</span> &lt;nil&gt; bgbiao@bgbiao.top <span class=o>}</span>
</span></span><span class=line><span class=cl>更新后的记录: <span class=o>{</span><span class=m>1</span> biaoge <span class=m>18</span> &lt;nil&gt; bgbiao@bgbiao.top <span class=o>}</span>
</span></span><span class=line><span class=cl>查看全部记录:
</span></span><span class=line><span class=cl><span class=o>[{</span><span class=m>2</span> xxb <span class=m>18</span> &lt;nil&gt; xxb@bgbiao.top <span class=o>}]</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=快速开始>快速开始</h2><p><a href=https://zhuanlan.zhihu.com/p/113251066 target=_blank rel="external nofollow noopener noreferrer">https://zhuanlan.zhihu.com/p/113251066</a></p><h3 id=安装>安装</h3><p>支持的数据库以及导入路径如下:</p><ul><li>mysql: github.com/jinzhu/gorm/dialects/mysql</li><li>postgres: github.com/jinzhu/gorm/dialects/postgres</li><li>sqlite: github.com/jinzhu/gorm/dialects/sqlite</li><li>sqlserver: github.com/jinzhu/gorm/dialects/mssql</li></ul><p>gorm 框架只是简单封装了数据库的驱动包，在安装时仍需要下载原始的驱动包</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>get</span> <span class=o>-</span><span class=nx>u</span> <span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>jinzhu</span><span class=o>/</span><span class=nx>gorm</span>
</span></span><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>get</span> <span class=o>-</span><span class=nx>u</span> <span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=k>go</span><span class=o>-</span><span class=nx>sql</span><span class=o>-</span><span class=nx>driver</span><span class=o>/</span><span class=nx>mysql</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>get</span> <span class=o>-</span><span class=nx>u</span> <span class=nx>gorm</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>driver</span><span class=o>/</span><span class=nx>mysql</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=模型>模型</h2><p>模型是标准的 struct，由 Go 的基本数据类型、实现了 <a href="https://pkg.go.dev/database/sql/?tab=doc#Scanner" target=_blank rel="external nofollow noopener noreferrer">Scanner</a> 和 <a href=https://pkg.go.dev/database/sql/driver#Valuer target=_blank rel="external nofollow noopener noreferrer">Valuer</a> 接口的自定义类型及其指针或别名组成</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>           <span class=kt>uint</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>         <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Email</span>        <span class=o>*</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Age</span>          <span class=kt>uint8</span>
</span></span><span class=line><span class=cl>  <span class=nx>Birthday</span>     <span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>  <span class=nx>MemberNumber</span> <span class=nx>sql</span><span class=p>.</span><span class=nx>NullString</span>
</span></span><span class=line><span class=cl>  <span class=nx>ActivatedAt</span>  <span class=nx>sql</span><span class=p>.</span><span class=nx>NullTime</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreatedAt</span>    <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>  <span class=nx>UpdatedAt</span>    <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=约定>约定</h3><p>GORM 倾向于<strong>约定</strong>，而不是配置。</p><p>默认情况下，Gorm：</p><ul><li>使用 <code>ID</code> 作为主键</li><li>使用结构体名的 <code>蛇形复数</code> 作为表名</li><li>字段名的 <code>蛇形</code> 作为列名</li><li>使用 <code>CreatedAt</code>、<code>UpdatedAt</code> 字段追踪创建、更新时间</li></ul><p>遵循 GORM 已有的约定，可以减少您的配置和代码量。如果约定不符合您的需求，<a href=https://gorm.io/zh_CN/docs/conventions.html target=_blank rel="external nofollow noopener noreferrer">GORM 允许您自定义配置它们</a></p><h3 id=gormmodel>gorm.Model</h3><p>GORM 定义一个 <code>gorm.Model</code> 结构体，其包括字段 <code>ID</code>、<code>CreatedAt</code>、<code>UpdatedAt</code>、<code>DeletedAt</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// gorm.Model 的定义
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Model</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>        <span class=kt>uint</span>           <span class=s>`gorm:&#34;primaryKey&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreatedAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>  <span class=nx>UpdatedAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>  <span class=nx>DeletedAt</span> <span class=nx>gorm</span><span class=p>.</span><span class=nx>DeletedAt</span> <span class=s>`gorm:&#34;index&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>您可以将它嵌入到您的结构体中，以包含这几个字段</p><h3 id=字段标签>字段标签</h3><p>声明 model 时，tag 是可选的，GORM 支持以下 tag： tag 名大小写不敏感，但建议使用 <code>camelCase</code> 风格</p><table><thead><tr><th style=text-align:left>标签名</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>column</td><td style=text-align:left>指定 db 列名</td></tr><tr><td style=text-align:left>type</td><td style=text-align:left>列数据类型，推荐使用兼容性好的通用类型，例如：所有数据库都支持 bool、int、uint、float、string、time、bytes 并且可以和其他标签一起使用，例如：<code>not null</code>、<code>size</code>, <code>autoIncrement</code>… 像 <code>varbinary(8)</code> 这样指定数据库数据类型也是支持的。在使用指定数据库数据类型时，它需要是完整的数据库数据类型，如：<code>MEDIUMINT UNSIGNED not NULL AUTO_INCREMENT</code></td></tr><tr><td style=text-align:left>size</td><td style=text-align:left>指定列大小，例如：<code>size:256</code></td></tr><tr><td style=text-align:left>primaryKey</td><td style=text-align:left>指定列为主键</td></tr><tr><td style=text-align:left>unique</td><td style=text-align:left>指定列为唯一</td></tr><tr><td style=text-align:left>default</td><td style=text-align:left>指定列的默认值</td></tr><tr><td style=text-align:left>precision</td><td style=text-align:left>指定列的精度</td></tr><tr><td style=text-align:left>scale</td><td style=text-align:left>指定列大小</td></tr><tr><td style=text-align:left>not null</td><td style=text-align:left>指定列为 NOT NULL</td></tr><tr><td style=text-align:left>autoIncrement</td><td style=text-align:left>指定列为自动增长</td></tr><tr><td style=text-align:left>autoIncrementIncrement</td><td style=text-align:left>自动步长，控制连续记录之间的间隔</td></tr><tr><td style=text-align:left>embedded</td><td style=text-align:left>嵌套字段</td></tr><tr><td style=text-align:left>embeddedPrefix</td><td style=text-align:left>嵌入字段的列名前缀</td></tr><tr><td style=text-align:left>autoCreateTime</td><td style=text-align:left>创建时追踪当前时间，对于 <code>int</code> 字段，它会追踪秒级时间戳，您可以使用 <code>nano</code>/<code>milli</code> 来追踪纳秒、毫秒时间戳，例如：<code>autoCreateTime:nano</code></td></tr><tr><td style=text-align:left>autoUpdateTime</td><td style=text-align:left>创建/更新时追踪当前时间，对于 <code>int</code> 字段，它会追踪秒级时间戳，您可以使用 <code>nano</code>/<code>milli</code> 来追踪纳秒、毫秒时间戳，例如：<code>autoUpdateTime:milli</code></td></tr><tr><td style=text-align:left>index</td><td style=text-align:left>根据参数创建索引，多个字段使用相同的名称则创建复合索引，查看 <a href=https://gorm.io/zh_CN/docs/indexes.html target=_blank rel="external nofollow noopener noreferrer">索引</a> 获取详情</td></tr><tr><td style=text-align:left>uniqueIndex</td><td style=text-align:left>与 <code>index</code> 相同，但创建的是唯一索引</td></tr><tr><td style=text-align:left>check</td><td style=text-align:left>创建检查约束，例如 <code>check:age > 13</code>，查看 <a href=https://gorm.io/zh_CN/docs/constraints.html target=_blank rel="external nofollow noopener noreferrer">约束</a> 获取详情</td></tr><tr><td style=text-align:left>&lt;-</td><td style=text-align:left>设置字段写入的权限， <code>&lt;-:create</code> 只创建、<code>&lt;-:update</code> 只更新、<code>&lt;-:false</code> 无写入权限、<code>&lt;-</code> 创建和更新权限</td></tr><tr><td style=text-align:left>-></td><td style=text-align:left>设置字段读的权限，<code>->:false</code> 无读权限</td></tr><tr><td style=text-align:left>-</td><td style=text-align:left>忽略该字段，<code>-</code> 无读写权限</td></tr><tr><td style=text-align:left>comment</td><td style=text-align:left>迁移时为字段添加注释</td></tr></tbody></table><h3 id=字段级权限控制>字段级权限控制</h3><p>可导出的字段在使用 GORM 进行 CRUD 时拥有全部的权限，此外，GORM 允许您用标签控制字段级别的权限。这样您就可以让一个字段的权限是只读、只写、只创建、只更新或者被忽略</p><blockquote><p><strong>注意：</strong> 使用 GORM Migrator 创建表时，不会创建被忽略的字段</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`gorm:&#34;&lt;-:create&#34;`</span> <span class=c1>// 允许读和创建
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`gorm:&#34;&lt;-:update&#34;`</span> <span class=c1>// 允许读和更新
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`gorm:&#34;&lt;-&#34;`</span>        <span class=c1>// 允许读和写（创建和更新）
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`gorm:&#34;&lt;-:false&#34;`</span>  <span class=c1>// 允许读，禁止写
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`gorm:&#34;-&gt;&#34;`</span>        <span class=c1>// 只读（除非有自定义配置，否则禁止写）
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`gorm:&#34;-&gt;;&lt;-:create&#34;`</span> <span class=c1>// 允许读和写
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`gorm:&#34;-&gt;:false;&lt;-:create&#34;`</span> <span class=c1>// 仅创建（禁止从 db 读）
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`gorm:&#34;-&#34;`</span>  <span class=c1>// 通过 struct 读写会忽略该字段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=创建更新时间追踪纳秒毫秒秒time>创建/更新时间追踪（纳秒、毫秒、秒、Time）</h3><p>GORM 约定使用 <code>CreatedAt</code>、<code>UpdatedAt</code> 追踪创建/更新时间。如果您定义了这种字段，GORM 在创建、更新时会自动填充 <a href=https://gorm.io/zh_CN/docs/gorm_config.html#now_func target=_blank rel="external nofollow noopener noreferrer">当前时间</a></p><p>要使用不同名称的字段，您可以配置 <code>autoCreateTime</code>、<code>autoUpdateTime</code> 标签</p><p>如果您想要保存 UNIX（毫/纳）秒时间戳，而不是 time，您只需简单地将 <code>time.Time</code> 修改为 <code>int</code> 即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreatedAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=c1>// Set to current time if it is zero on creating
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>UpdatedAt</span> <span class=kt>int</span>       <span class=c1>// Set to current unix seconds on updating or if it is zero on creating
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Updated</span>   <span class=kt>int64</span> <span class=s>`gorm:&#34;autoUpdateTime:nano&#34;`</span> <span class=c1>// Use unix nano seconds as updating time
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Updated</span>   <span class=kt>int64</span> <span class=s>`gorm:&#34;autoUpdateTime:milli&#34;`</span><span class=c1>// Use unix milli seconds as updating time
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Created</span>   <span class=kt>int64</span> <span class=s>`gorm:&#34;autoCreateTime&#34;`</span>      <span class=c1>// Use unix seconds as creating time
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=嵌入结构体>嵌入结构体</h3><p>对于匿名字段，GORM 会将其字段包含在父结构体中，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 等效于
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>        <span class=kt>uint</span>           <span class=s>`gorm:&#34;primaryKey&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreatedAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>  <span class=nx>UpdatedAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>  <span class=nx>DeletedAt</span> <span class=nx>gorm</span><span class=p>.</span><span class=nx>DeletedAt</span> <span class=s>`gorm:&#34;index&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对于正常的结构体字段，你也可以通过标签 <code>embedded</code> 将其嵌入，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Author</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Email</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Blog</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>      <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Author</span>  <span class=nx>Author</span> <span class=s>`gorm:&#34;embedded&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Upvotes</span> <span class=kt>int32</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 等效于
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Blog</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>    <span class=kt>int64</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Email</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Upvotes</span>  <span class=kt>int32</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>并且，您可以使用标签 <code>embeddedPrefix</code> 来为 db 中的字段名添加前缀，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Blog</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>      <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Author</span>  <span class=nx>Author</span> <span class=s>`gorm:&#34;embedded;embeddedPrefix:author_&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Upvotes</span> <span class=kt>int32</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 等效于
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Blog</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>          <span class=kt>int64</span>
</span></span><span class=line><span class=cl>    <span class=nx>AuthorName</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>AuthorEmail</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Upvotes</span>     <span class=kt>int32</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=关联标签>关联标签</h3><p>GORM 允许通过标签为关联配置外键、约束、many2many 表</p><table><thead><tr><th style=text-align:left>标签</th><th style=text-align:left>描述</th></tr></thead><tbody><tr><td style=text-align:left>foreignKey</td><td style=text-align:left>指定当前模型的列作为连接表的外键</td></tr><tr><td style=text-align:left>references</td><td style=text-align:left>指定引用表的列名，其将被映射为连接表外键</td></tr><tr><td style=text-align:left>polymorphic</td><td style=text-align:left>指定多态类型，比如模型名</td></tr><tr><td style=text-align:left>polymorphicValue</td><td style=text-align:left>指定多态值、默认表名</td></tr><tr><td style=text-align:left>many2many</td><td style=text-align:left>指定连接表表名</td></tr><tr><td style=text-align:left>joinForeignKey</td><td style=text-align:left>指定连接表的外键列名，其将被映射到当前表</td></tr><tr><td style=text-align:left>joinReferences</td><td style=text-align:left>指定连接表的外键列名，其将被映射到引用表</td></tr><tr><td style=text-align:left>constraint</td><td style=text-align:left>关系约束，例如：<code>OnUpdate</code>、<code>OnDelete</code></td></tr></tbody></table><h2 id=连接到数据库>连接到数据库</h2><p>GORM 官方支持的数据库类型有： MySQL, PostgreSQL, SQlite, SQL Server</p><h3 id=mysql>MySQL</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;gorm.io/driver/mysql&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;gorm.io/gorm&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 参考 https://github.com/go-sql-driver/mysql#dsn-data-source-name 获取详情
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>dsn</span> <span class=o>:=</span> <span class=s>&#34;user:pass@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>mysql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>dsn</span><span class=p>),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>MySQl 驱动程序提供了 <a href=https://github.com/go-gorm/mysql target=_blank rel="external nofollow noopener noreferrer">一些高级配置</a> 可以在初始化过程中使用，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>mysql</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>mysql</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>DSN</span><span class=p>:</span> <span class=s>&#34;gorm:gorm@tcp(127.0.0.1:3306)/gorm?charset=utf8&amp;parseTime=True&amp;loc=Local&#34;</span><span class=p>,</span> <span class=c1>// DSN data source name
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>DefaultStringSize</span><span class=p>:</span> <span class=mi>256</span><span class=p>,</span> <span class=c1>// string 类型字段的默认长度
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>DisableDatetimePrecision</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=c1>// 禁用 datetime 精度，MySQL 5.6 之前的数据库不支持
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>DontSupportRenameIndex</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=c1>// 重命名索引时采用删除并新建的方式，MySQL 5.7 之前的数据库和 MariaDB 不支持重命名索引
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>DontSupportRenameColumn</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=c1>// 用 `change` 重命名列，MySQL 8 之前的数据库和 MariaDB 不支持重命名列
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>SkipInitializeWithVersion</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=c1>// 根据当前 MySQL 版本自动配置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{})</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=自定义驱动>自定义驱动</h4><p>GORM 允许通过 <code>DriverName</code> 选项自定义 MySQL 驱动，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>_</span> <span class=s>&#34;example.com/my_mysql_driver&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;gorm.io/gorm&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>mysql</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>mysql</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>DriverName</span><span class=p>:</span> <span class=s>&#34;my_mysql_driver&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>DSN</span><span class=p>:</span> <span class=s>&#34;gorm:gorm@tcp(localhost:9910)/gorm?charset=utf8&amp;parseTime=True&amp;loc=Local&#34;</span><span class=p>,</span> <span class=c1>// Data Source Name，参考 https://github.com/go-sql-driver/mysql#dsn-data-source-name
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{})</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=现有的数据库连接>现有的数据库连接</h4><p>GORM 允许通过一个现有的数据库连接来初始化 <code>*gorm.DB</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;gorm.io/driver/mysql&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;gorm.io/gorm&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>sqlDB</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span> <span class=s>&#34;mydb_dsn&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>gormDB</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>mysql</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>mysql</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Conn</span><span class=p>:</span> <span class=nx>sqlDB</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{})</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=sqlite>SQLite</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;gorm.io/driver/sqlite&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;gorm.io/gorm&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// github.com/mattn/go-sqlite3
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>sqlite</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;gorm.db&#34;</span><span class=p>),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{})</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意：</strong> 您也可以使用 <code>file::memory:?cache=shared</code> 替代文件路径。 这会告诉 SQLite 在系统内存中使用一个临时数据库。</p></blockquote><h2 id=连接池>连接池</h2><p>GORM 使用 <a href=https://pkg.go.dev/database/sql target=_blank rel="external nofollow noopener noreferrer">database/sql</a> 维护连接池</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>sqlDB</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>DB</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SetMaxIdleConns 设置空闲连接池中连接的最大数量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>sqlDB</span><span class=p>.</span><span class=nf>SetMaxIdleConns</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SetMaxOpenConns 设置打开数据库连接的最大数量。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>sqlDB</span><span class=p>.</span><span class=nf>SetMaxOpenConns</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SetConnMaxLifetime 设置了连接可复用的最大时间。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>sqlDB</span><span class=p>.</span><span class=nf>SetConnMaxLifetime</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Hour</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=创建>创建</h2><h3 id=创建记录>创建记录</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>user</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;Jinzhu&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span> <span class=nx>Birthday</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>result</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span> <span class=c1>// 通过数据的指针来创建
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>user</span><span class=p>.</span><span class=nx>ID</span>             <span class=c1>// 返回插入数据的主键
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span><span class=p>.</span><span class=nx>Error</span>        <span class=c1>// 返回 error
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span><span class=p>.</span><span class=nx>RowsAffected</span> <span class=c1>// 返回插入记录的条数
</span></span></span></code></pre></td></tr></table></div></div><h3 id=筛选指定字段来创建记录>筛选指定字段来创建记录</h3><p>创建记录并更新给出的字段。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;Name&#34;</span><span class=p>,</span> <span class=s>&#34;Age&#34;</span><span class=p>,</span> <span class=s>&#34;CreatedAt&#34;</span><span class=p>).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `users` (`name`,`age`,`created_at`) VALUES (&#34;jinzhu&#34;, 18, &#34;2020-07-04 11:05:21.775&#34;)
</span></span></span></code></pre></td></tr></table></div></div><p>创建一个记录且一同忽略传递给略去的字段值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Omit</span><span class=p>(</span><span class=s>&#34;Name&#34;</span><span class=p>,</span> <span class=s>&#34;Age&#34;</span><span class=p>,</span> <span class=s>&#34;CreatedAt&#34;</span><span class=p>).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `users` (`birthday`,`updated_at`) VALUES (&#34;2020-01-01 00:00:00.000&#34;, &#34;2020-07-04 11:05:21.775&#34;)
</span></span></span></code></pre></td></tr></table></div></div><h3 id=批量插入>批量插入</h3><p>要有效地插入大量记录，请将一个 <code>slice</code> 传递给 <code>Create</code> 方法。 GORM 将生成<strong>单独一条</strong> SQL 语句来插入所有数据，并回填主键的值，钩子方法也会被调用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>users</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>User</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu1&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu2&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu3&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>user</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>users</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>user</span><span class=p>.</span><span class=nx>ID</span> <span class=c1>// 1,2,3
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 <code>CreateInBatches</code> 分批创建时，你可以指定每批的数量，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>users</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>User</span><span class=p>{{</span><span class=nx>name</span><span class=p>:</span> <span class=s>&#34;jinzhu_1&#34;</span><span class=p>},</span> <span class=o>...</span><span class=p>.,</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu_10000&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 数量为 100
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>CreateInBatches</span><span class=p>(</span><span class=nx>users</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><a href=https://gorm.io/zh_CN/docs/create.html#upsert target=_blank rel="external nofollow noopener noreferrer">Upsert</a> 和 <a href=https://gorm.io/zh_CN/docs/create.html#create_with_associations target=_blank rel="external nofollow noopener noreferrer">Create With Associations</a> 也支持批量插入</p><blockquote><p><strong>注意</strong> 使用 <code>CreateBatchSize</code> 选项初始化 GORM 时，所有的创建 & 关联 <code>INSERT</code> 都将遵循该选项</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>sqlite</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;gorm.db&#34;</span><span class=p>),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreateBatchSize</span><span class=p>:</span> <span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Session</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Session</span><span class=p>{</span><span class=nx>CreateBatchSize</span><span class=p>:</span> <span class=mi>1000</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>users</span> <span class=p>=</span> <span class=p>[</span><span class=mi>5000</span><span class=p>]</span><span class=nx>User</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=nx>Pets</span><span class=p>:</span> <span class=p>[]</span><span class=nx>Pet</span><span class=p>{</span><span class=nx>pet1</span><span class=p>,</span> <span class=nx>pet2</span><span class=p>,</span> <span class=nx>pet3</span><span class=p>}}</span><span class=o>...</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO users xxx (5 batches)
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO pets xxx (15 batches)
</span></span></span></code></pre></td></tr></table></div></div><h3 id=创建钩子>创建钩子</h3><p>GORM 允许用户定义的钩子有 <code>BeforeSave</code>, <code>BeforeCreate</code>, <code>AfterSave</code>, <code>AfterCreate</code> 创建记录时将调用这些钩子方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>BeforeCreate</span><span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=nx>u</span><span class=p>.</span><span class=nx>UUID</span> <span class=p>=</span> <span class=nx>uuid</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Role</span> <span class=o>==</span> <span class=s>&#34;admin&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;invalid role&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果您想跳过 <code>钩子</code> 方法，您可以使用 <code>SkipHooks</code> 会话模式，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>DB</span><span class=p>.</span><span class=nf>Session</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Session</span><span class=p>{</span><span class=nx>SkipHooks</span><span class=p>:</span> <span class=kc>true</span><span class=p>}).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>DB</span><span class=p>.</span><span class=nf>Session</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Session</span><span class=p>{</span><span class=nx>SkipHooks</span><span class=p>:</span> <span class=kc>true</span><span class=p>}).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>DB</span><span class=p>.</span><span class=nf>Session</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Session</span><span class=p>{</span><span class=nx>SkipHooks</span><span class=p>:</span> <span class=kc>true</span><span class=p>}).</span><span class=nf>CreateInBatches</span><span class=p>(</span><span class=nx>users</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=根据-map-创建>根据 Map 创建</h3><p>GORM 支持根据 <code>map[string]interface{}</code> 和 <code>[]map[string]interface{}{}</code> 创建记录，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Create</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;Name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=s>&#34;Age&#34;</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// batch insert from `[]map[string]interface{}{}`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Create</span><span class=p>([]</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=s>&#34;Name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu_1&#34;</span><span class=p>,</span> <span class=s>&#34;Age&#34;</span><span class=p>:</span> <span class=mi>18</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=s>&#34;Name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu_2&#34;</span><span class=p>,</span> <span class=s>&#34;Age&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意：</strong> 根据 map 创建记录时，association 不会被调用，且主键也不会自动填充</p></blockquote><h3 id=使用-sql-表达式context-valuer-创建记录>使用 SQL 表达式、Context Valuer 创建记录</h3><p>GORM 允许使用 SQL 表达式插入数据，有两种方法实现这个目标。根据 <code>map[string]interface{}</code> 或 <a href=https://gorm.io/zh_CN/docs/data_types.html#gorm_valuer_interface target=_blank rel="external nofollow noopener noreferrer">自定义数据类型</a> 创建，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 通过 map 创建记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Create</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;Name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;Location&#34;</span><span class=p>:</span> <span class=nx>clause</span><span class=p>.</span><span class=nx>Expr</span><span class=p>{</span><span class=nx>SQL</span><span class=p>:</span> <span class=s>&#34;ST_PointFromText(?)&#34;</span><span class=p>,</span> <span class=nx>Vars</span><span class=p>:</span> <span class=p>[]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;POINT(100 100)&#34;</span><span class=p>}},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `users` (`name`,`location`) VALUES (&#34;jinzhu&#34;,ST_PointFromText(&#34;POINT(100 100)&#34;));
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 通过自定义类型创建记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Location</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>X</span><span class=p>,</span> <span class=nx>Y</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Scan 方法实现了 sql.Scanner 接口
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>loc</span> <span class=o>*</span><span class=nx>Location</span><span class=p>)</span> <span class=nf>Scan</span><span class=p>(</span><span class=nx>v</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Scan a value into struct from database driver
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>loc</span> <span class=nx>Location</span><span class=p>)</span> <span class=nf>GormDataType</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=s>&#34;geometry&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>loc</span> <span class=nx>Location</span><span class=p>)</span> <span class=nf>GormValue</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>db</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=nx>clause</span><span class=p>.</span><span class=nx>Expr</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>clause</span><span class=p>.</span><span class=nx>Expr</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>SQL</span><span class=p>:</span>  <span class=s>&#34;ST_PointFromText(?)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Vars</span><span class=p>:</span> <span class=p>[]</span><span class=kd>interface</span><span class=p>{}{</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;POINT(%d %d)&#34;</span><span class=p>,</span> <span class=nx>loc</span><span class=p>.</span><span class=nx>X</span><span class=p>,</span> <span class=nx>loc</span><span class=p>.</span><span class=nx>Y</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>     <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Location</span> <span class=nx>Location</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span><span class=p>:</span>     <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Location</span><span class=p>:</span> <span class=nx>Location</span><span class=p>{</span><span class=nx>X</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span> <span class=nx>Y</span><span class=p>:</span> <span class=mi>100</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `users` (`name`,`location`) VALUES (&#34;jinzhu&#34;,ST_PointFromText(&#34;POINT(100 100)&#34;))
</span></span></span></code></pre></td></tr></table></div></div><h3 id=高级选项>高级选项</h3><h4 id=关联创建>关联创建</h4><p>创建关联数据时，如果关联值是非零值，这些关联会被 upsert，且它们的 <code>Hook</code> 方法也会被调用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CreditCard</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Number</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>UserID</span>   <span class=kt>uint</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>       <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCard</span> <span class=nx>CreditCard</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCard</span><span class=p>:</span> <span class=nx>CreditCard</span><span class=p>{</span><span class=nx>Number</span><span class=p>:</span> <span class=s>&#34;411111111111&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `users` ...
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `credit_cards` ...
</span></span></span></code></pre></td></tr></table></div></div><p>您也可以通过 <code>Select</code>、 <code>Omit</code> 跳过关联保存，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Omit</span><span class=p>(</span><span class=s>&#34;CreditCard&#34;</span><span class=p>).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 跳过所有关联
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Omit</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Associations</span><span class=p>).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=默认值>默认值</h4><p>您可以通过标签 <code>default</code> 为字段定义默认值，如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>   <span class=kt>int64</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`gorm:&#34;default:galeone&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Age</span>  <span class=kt>int64</span>  <span class=s>`gorm:&#34;default:18&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>插入记录到数据库时，默认值 <em>会被用于</em> 填充值为 <a href=https://tour.golang.org/basics/12 target=_blank rel="external nofollow noopener noreferrer">零值</a> 的字段</p><blockquote><p><strong>注意</strong> 对于声明了默认值的字段，像 <code>0</code>、<code>''</code>、<code>false</code> 等零值是不会保存到数据库。您需要使用指针类型或 Scanner/Valuer 来避免这个问题，例如：</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Age</span>  <span class=o>*</span><span class=kt>int</span>           <span class=s>`gorm:&#34;default:18&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Active</span> <span class=nx>sql</span><span class=p>.</span><span class=nx>NullBool</span> <span class=s>`gorm:&#34;default:true&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong> 若要数据库有默认、虚拟/生成的值，你必须为字段设置 <code>default</code> 标签。若要在迁移时跳过默认值定义，你可以使用 <code>default:(-)</code>，例如：</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>        <span class=kt>string</span> <span class=s>`gorm:&#34;default:uuid_generate_v3()&#34;`</span> <span class=c1>// db func
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>FirstName</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>LastName</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Age</span>       <span class=kt>uint8</span>
</span></span><span class=line><span class=cl>  <span class=nx>FullName</span>  <span class=kt>string</span> <span class=s>`gorm:&#34;-&gt;;type:GENERATED ALWAYS AS (concat(firstname,&#39; &#39;,lastname));default:(-);&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>使用虚拟/生成的值时，你可能需要禁用它的创建、更新权限，查看 <a href=https://gorm.io/zh_CN/docs/models.html#field_permission target=_blank rel="external nofollow noopener noreferrer">字段级权限</a> 获取详情</p><h4 id=upsert-及冲突>Upsert 及冲突</h4><p>GORM 为不同数据库提供了兼容的 Upsert 支持</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;gorm.io/gorm/clause&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 在冲突时，什么都不做
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>OnConflict</span><span class=p>{</span><span class=nx>DoNothing</span><span class=p>:</span> <span class=kc>true</span><span class=p>}).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 在`id`冲突时，将列更新为默认值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>OnConflict</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Columns</span><span class=p>:</span>   <span class=p>[]</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Column</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;id&#34;</span><span class=p>}},</span>
</span></span><span class=line><span class=cl>  <span class=nx>DoUpdates</span><span class=p>:</span> <span class=nx>clause</span><span class=p>.</span><span class=nf>Assignments</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;role&#34;</span><span class=p>:</span> <span class=s>&#34;user&#34;</span><span class=p>}),</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// MERGE INTO &#34;users&#34; USING *** WHEN NOT MATCHED THEN INSERT *** WHEN MATCHED THEN UPDATE SET ***; SQL Server
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `users` *** ON DUPLICATE KEY UPDATE ***; MySQL
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 使用SQL语句
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>OnConflict</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Columns</span><span class=p>:</span>   <span class=p>[]</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Column</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;id&#34;</span><span class=p>}},</span>
</span></span><span class=line><span class=cl>  <span class=nx>DoUpdates</span><span class=p>:</span> <span class=nx>clause</span><span class=p>.</span><span class=nf>Assignments</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;count&#34;</span><span class=p>:</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Expr</span><span class=p>(</span><span class=s>&#34;GREATEST(count, VALUES(count))&#34;</span><span class=p>)}),</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `users` *** ON DUPLICATE KEY UPDATE `count`=GREATEST(count, VALUES(count));
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 在`id`冲突时，将列更新为新值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>OnConflict</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Columns</span><span class=p>:</span>   <span class=p>[]</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Column</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;id&#34;</span><span class=p>}},</span>
</span></span><span class=line><span class=cl>  <span class=nx>DoUpdates</span><span class=p>:</span> <span class=nx>clause</span><span class=p>.</span><span class=nf>AssignmentColumns</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>}),</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// MERGE INTO &#34;users&#34; USING *** WHEN NOT MATCHED THEN INSERT *** WHEN MATCHED THEN UPDATE SET &#34;name&#34;=&#34;excluded&#34;.&#34;name&#34;; SQL Server
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO &#34;users&#34; *** ON CONFLICT (&#34;id&#34;) DO UPDATE SET &#34;name&#34;=&#34;excluded&#34;.&#34;name&#34;, &#34;age&#34;=&#34;excluded&#34;.&#34;age&#34;; PostgreSQL
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `users` *** ON DUPLICATE KEY UPDATE `name`=VALUES(name),`age=VALUES(age); MySQL
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 在冲突时，更新除主键以外的所有列到新值。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>OnConflict</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>UpdateAll</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO &#34;users&#34; *** ON CONFLICT (&#34;id&#34;) DO UPDATE SET &#34;name&#34;=&#34;excluded&#34;.&#34;name&#34;, &#34;age&#34;=&#34;excluded&#34;.&#34;age&#34;, ...;
</span></span></span></code></pre></td></tr></table></div></div><p>您还可以查看 <a href=https://gorm.io/zh_CN/docs/advanced_query.html target=_blank rel="external nofollow noopener noreferrer">高级查询</a> 中的 <code>FirstOrInit</code>、<code>FirstOrCreate</code></p><h4 id=复合主键>复合主键</h4><p>通过将多个字段设为主键，以创建复合主键，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>type Product struct {
</span></span><span class=line><span class=cl>  ID           string `gorm:&#34;primaryKey&#34;`
</span></span><span class=line><span class=cl>  LanguageCode string `gorm:&#34;primaryKey&#34;`
</span></span><span class=line><span class=cl>  Code         string
</span></span><span class=line><span class=cl>  Name         string
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>**注意：**默认情况下，整型 <code>PrioritizedPrimaryField</code> 启用了 <code>AutoIncrement</code>，要禁用它，您需要为整型字段关闭 <code>autoIncrement</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>type Product struct {
</span></span><span class=line><span class=cl>  CategoryID uint64 `gorm:&#34;primaryKey;autoIncrement:false&#34;`
</span></span><span class=line><span class=cl>  TypeID     uint64 `gorm:&#34;primaryKey;autoIncrement:false&#34;`
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h2 id=查询>查询</h2><h3 id=检索单个对象>检索单个对象</h3><p>GORM 提供了 <code>First</code>、<code>Take</code>、<code>Last</code> 方法，以便从数据库中检索单个对象。当查询数据库时它添加了 <code>LIMIT 1</code> 条件，且没有找到记录时，它会返回 <code>ErrRecordNotFound</code> 错误</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 获取第一条记录（主键升序）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 获取一条记录，没有指定排序字段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Take</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 获取最后一条记录（主键降序）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Last</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users ORDER BY id DESC LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>result</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>result</span><span class=p>.</span><span class=nx>RowsAffected</span> <span class=c1>// 返回找到的记录数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span><span class=p>.</span><span class=nx>Error</span>        <span class=c1>// returns error or nil
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 检查 ErrRecordNotFound 错误
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>errors</span><span class=p>.</span><span class=nf>Is</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>Error</span><span class=p>,</span> <span class=nx>gorm</span><span class=p>.</span><span class=nx>ErrRecordNotFound</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>如果你想避免 <code>ErrRecordNotFound</code> 错误，你可以使用 <code>Find</code>，比如 <code>db.Limit(1).Find(&amp;user)</code>，<code>Find</code>方法可以接受 struct 和 slice 的数据。</p></blockquote><p><strong>只有在目标 struct 是指针或者通过 <code>db.Model()</code> 指定 model 时，该方法才有效</strong>。</p><p>此外，如果相关 model 没有定义主键，那么将按 model 的第一个字段进行排序。 例如:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>users</span> <span class=p>[]</span><span class=nx>User</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 有效，因为目标 struct 是指针
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM `users` ORDER BY `users`.`id` LIMIT 1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 有效，因为通过 `db.Model()` 指定了 model
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{}</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM `users` ORDER BY `users`.`id` LIMIT 1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 无效
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{}</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;users&#34;</span><span class=p>).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 配合 Take 有效
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{}</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;users&#34;</span><span class=p>).</span><span class=nf>Take</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 未指定主键，会根据第一个字段排序(即：`Code`)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Language</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Code</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Language</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM `languages` ORDER BY `languages`.`code` LIMIT 1
</span></span></span></code></pre></td></tr></table></div></div><h4 id=用主键检索>用主键检索</h4><p>如果主键是数字类型，您可以使用 <a href=https://gorm.io/zh_CN/docs/query.html#inline_conditions target=_blank rel="external nofollow noopener noreferrer">内联条件</a> 来检索对象。 传入字符串参数时，需要特别注意 SQL 注入问题</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE id = 10;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span> <span class=s>&#34;10&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE id = 10;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>,</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE id IN (1,2,3);
</span></span></span></code></pre></td></tr></table></div></div><p>如果主键是字符串（例如像 uuid），查询将被写成这样：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span> <span class=s>&#34;id = ?&#34;</span><span class=p>,</span> <span class=s>&#34;1b74413f-f3b8-409f-ac47-e8c062e3472a&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE id = &#34;1b74413f-f3b8-409f-ac47-e8c062e3472a&#34;;
</span></span></span></code></pre></td></tr></table></div></div><h3 id=检索全部对象>检索全部对象</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 获取全部记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>result</span><span class=p>.</span><span class=nx>RowsAffected</span> <span class=c1>// 返回找到的记录数，相当于 `len(users)`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span><span class=p>.</span><span class=nx>Error</span>        <span class=c1>// returns error
</span></span></span></code></pre></td></tr></table></div></div><h3 id=条件>条件</h3><h4 id=string-条件>String 条件</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 获取第一条匹配的记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#39;jinzhu&#39; ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 获取全部匹配的记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name &lt;&gt; ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name &lt;&gt; &#39;jinzhu&#39;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// IN
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name IN ?&#34;</span><span class=p>,</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu 2&#34;</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name IN (&#39;jinzhu&#39;,&#39;jinzhu 2&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// LIKE
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name LIKE ?&#34;</span><span class=p>,</span> <span class=s>&#34;%jin%&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name LIKE &#39;%jin%&#39;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// AND
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = ? AND age &gt;= ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=s>&#34;22&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#39;jinzhu&#39; AND age &gt;= 22;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Time
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;updated_at &gt; ?&#34;</span><span class=p>,</span> <span class=nx>lastWeek</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE updated_at &gt; &#39;2000-01-01 00:00:00&#39;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// BETWEEN
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;created_at BETWEEN ? AND ?&#34;</span><span class=p>,</span> <span class=nx>lastWeek</span><span class=p>,</span> <span class=nx>today</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE created_at BETWEEN &#39;2000-01-01 00:00:00&#39; AND &#39;2000-01-08 00:00:00&#39;;
</span></span></span></code></pre></td></tr></table></div></div><h4 id=struct--map-条件>Struct & Map 条件</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Struct
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>20</span><span class=p>}).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#34;jinzhu&#34; AND age = 20 ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Map
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#34;jinzhu&#34; AND age = 20;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 主键切片条件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>([]</span><span class=kt>int64</span><span class=p>{</span><span class=mi>20</span><span class=p>,</span> <span class=mi>21</span><span class=p>,</span> <span class=mi>22</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE id IN (20, 21, 22);
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong> 当使用结构作为条件查询时，GORM 只会查询非零值字段。这意味着如果您的字段值为 <code>0</code>、<code>''</code>、<code>false</code> 或其他 <a href=https://tour.golang.org/basics/12 target=_blank rel="external nofollow noopener noreferrer">零值</a>，该字段不会被用于构建查询条件，例如：</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>0</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#34;jinzhu&#34;;
</span></span></span></code></pre></td></tr></table></div></div><p>如果想要包含零值查询条件，你可以使用 map，其会包含所有 key-value 的查询条件，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;Name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=s>&#34;Age&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#34;jinzhu&#34; AND age = 0;
</span></span></span></code></pre></td></tr></table></div></div><p>或者使用 6.3.3 的方法</p><h4 id=指定结构体查询字段>指定结构体查询字段</h4><p>当使用 struct 进行查询时，你可以通过向 <code>Where()</code> 传入 struct 来指定查询条件的字段、值、表名，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>},</span> <span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;Age&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#34;jinzhu&#34; AND age = 0;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>},</span> <span class=s>&#34;Age&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE age = 0;
</span></span></span></code></pre></td></tr></table></div></div><h4 id=内联条件>内联条件</h4><p>查询条件也可以被内联到 <code>First</code> 和 <code>Find</code> 之类的方法中，其用法类似于 <code>Where</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 根据主键获取记录，如果是非整型主键
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span> <span class=s>&#34;id = ?&#34;</span><span class=p>,</span> <span class=s>&#34;string_primary_key&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE id = &#39;string_primary_key&#39;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Plain SQL
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span> <span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#34;jinzhu&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>,</span> <span class=s>&#34;name &lt;&gt; ? AND age &gt; ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name &lt;&gt; &#34;jinzhu&#34; AND age &gt; 20;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Struct
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>,</span> <span class=nx>User</span><span class=p>{</span><span class=nx>Age</span><span class=p>:</span> <span class=mi>20</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE age = 20;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Map
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>,</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;age&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE age = 20;
</span></span></span></code></pre></td></tr></table></div></div><h4 id=not-条件>Not 条件</h4><p>构建 NOT 条件，用法与 <code>Where</code> 类似</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Not</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE NOT name = &#34;jinzhu&#34; ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Not In
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Not</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu 2&#34;</span><span class=p>}}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name NOT IN (&#34;jinzhu&#34;, &#34;jinzhu 2&#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Struct
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Not</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>18</span><span class=p>}).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name &lt;&gt; &#34;jinzhu&#34; AND age &lt;&gt; 18 ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 不在主键切片中的记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Not</span><span class=p>([]</span><span class=kt>int64</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>}).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE id NOT IN (1,2,3) ORDER BY id LIMIT 1;
</span></span></span></code></pre></td></tr></table></div></div><h4 id=or-条件>Or 条件</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;role = ?&#34;</span><span class=p>,</span> <span class=s>&#34;admin&#34;</span><span class=p>).</span><span class=nf>Or</span><span class=p>(</span><span class=s>&#34;role = ?&#34;</span><span class=p>,</span> <span class=s>&#34;super_admin&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE role = &#39;admin&#39; OR role = &#39;super_admin&#39;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Struct
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = &#39;jinzhu&#39;&#34;</span><span class=p>).</span><span class=nf>Or</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu 2&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>18</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#39;jinzhu&#39; OR (name = &#39;jinzhu 2&#39; AND age = 18);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Map
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = &#39;jinzhu&#39;&#34;</span><span class=p>).</span><span class=nf>Or</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu 2&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>:</span> <span class=mi>18</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#39;jinzhu&#39; OR (name = &#39;jinzhu 2&#39; AND age = 18);
</span></span></span></code></pre></td></tr></table></div></div><p>更复杂的 SQL 查询， 请查看 <a href=https://gorm.io/zh_CN/docs/advanced_query.html#group_conditions target=_blank rel="external nofollow noopener noreferrer">高级查询中的组条件</a>。</p><h3 id=选择特定字段>选择特定字段</h3><p><code>Select</code> 允许您指定从数据库中检索哪些字段， 默认情况下，GORM 会检索所有字段。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT name, age FROM users;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT name, age FROM users;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;users&#34;</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;COALESCE(age,?)&#34;</span><span class=p>,</span> <span class=mi>42</span><span class=p>).</span><span class=nf>Rows</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT COALESCE(age,&#39;42&#39;) FROM users;
</span></span></span></code></pre></td></tr></table></div></div><p>还可以看一看 [智能选择字段](<a href=https://gorm.io/ target=_blank rel="external nofollow noopener noreferrer">https://gorm.io/</a> zh_CN/docs/advanced_query.html#smart_select)</p><h3 id=order>Order</h3><p>指定从数据库检索记录时的排序方式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Order</span><span class=p>(</span><span class=s>&#34;age desc, name&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users ORDER BY age desc, name;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 多个 order
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Order</span><span class=p>(</span><span class=s>&#34;age desc&#34;</span><span class=p>).</span><span class=nf>Order</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users ORDER BY age desc, name;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>OrderBy</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Expression</span><span class=p>:</span> <span class=nx>clause</span><span class=p>.</span><span class=nx>Expr</span><span class=p>{</span><span class=nx>SQL</span><span class=p>:</span> <span class=s>&#34;FIELD(id,?)&#34;</span><span class=p>,</span> <span class=nx>Vars</span><span class=p>:</span> <span class=p>[]</span><span class=kd>interface</span><span class=p>{}{[]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>}},</span> <span class=nx>WithoutParentheses</span><span class=p>:</span> <span class=kc>true</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users ORDER BY FIELD(id,1,2,3)
</span></span></span></code></pre></td></tr></table></div></div><h3 id=limit--offset>Limit & Offset</h3><p><code>Limit</code> 指定获取记录的最大数量</p><p><code>Offset</code> 指定在开始返回记录之前要跳过的记录数量</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Limit</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users LIMIT 3;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 通过 -1 消除 Limit 条件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Limit</span><span class=p>(</span><span class=mi>10</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users1</span><span class=p>).</span><span class=nf>Limit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users LIMIT 10; (users1)
</span></span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users; (users2)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Offset</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users OFFSET 3;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Limit</span><span class=p>(</span><span class=mi>10</span><span class=p>).</span><span class=nf>Offset</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users OFFSET 5 LIMIT 10;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 通过 -1 消除 Offset 条件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Offset</span><span class=p>(</span><span class=mi>10</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users1</span><span class=p>).</span><span class=nf>Offset</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users OFFSET 10; (users1)
</span></span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users; (users2)
</span></span></span></code></pre></td></tr></table></div></div><p>查看 <a href=https://gorm.io/zh_CN/docs/scopes.html#pagination target=_blank rel="external nofollow noopener noreferrer">Pagination</a> 学习如何写一个分页器</p><h3 id=groupby--having>GroupBy & Having</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>result</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Date</span>  <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>  <span class=nx>Total</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;name, sum(age) as total&#34;</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name LIKE ?&#34;</span><span class=p>,</span> <span class=s>&#34;group%&#34;</span><span class=p>).</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT name, sum(age) as total FROM `users` WHERE name LIKE &#34;group%&#34; GROUP BY `name` LIMIT 1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;name, sum(age) as total&#34;</span><span class=p>).</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>).</span><span class=nf>Having</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;group&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT name, sum(age) as total FROM `users` GROUP BY `name` HAVING name = &#34;group&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;orders&#34;</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;date(created_at) as date, sum(amount) as total&#34;</span><span class=p>).</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;date(created_at)&#34;</span><span class=p>).</span><span class=nf>Rows</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;orders&#34;</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;date(created_at) as date, sum(amount) as total&#34;</span><span class=p>).</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;date(created_at)&#34;</span><span class=p>).</span><span class=nf>Having</span><span class=p>(</span><span class=s>&#34;sum(amount) &gt; ?&#34;</span><span class=p>,</span> <span class=mi>100</span><span class=p>).</span><span class=nf>Rows</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Result</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Date</span>  <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>  <span class=nx>Total</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;orders&#34;</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;date(created_at) as date, sum(amount) as total&#34;</span><span class=p>).</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;date(created_at)&#34;</span><span class=p>).</span><span class=nf>Having</span><span class=p>(</span><span class=s>&#34;sum(amount) &gt; ?&#34;</span><span class=p>,</span> <span class=mi>100</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>results</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=distinct>Distinct</h4><p>从模型中选择不相同的值</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Distinct</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>).</span><span class=nf>Order</span><span class=p>(</span><span class=s>&#34;name, age desc&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>results</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>Distinct</code> 也可以配合 <a href=https://gorm.io/zh_CN/docs/advanced_query.html#pluck target=_blank rel="external nofollow noopener noreferrer"><code>Pluck</code></a>, <a href=https://gorm.io/zh_CN/docs/advanced_query.html#count target=_blank rel="external nofollow noopener noreferrer"><code>Count</code></a> 使用</p><h3 id=joins>Joins</h3><p>指定 Joins 条件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>result</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Email</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;users.name, emails.email&#34;</span><span class=p>).</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;left join emails on emails.user_id = users.id&#34;</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>result</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT users.name, emails.email FROM `users` left join emails on emails.user_id = users.id
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;users&#34;</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;users.name, emails.email&#34;</span><span class=p>).</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;left join emails on emails.user_id = users.id&#34;</span><span class=p>).</span><span class=nf>Rows</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;users&#34;</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;users.name, emails.email&#34;</span><span class=p>).</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;left join emails on emails.user_id = users.id&#34;</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 带参数的多表连接
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;JOIN emails ON emails.user_id = users.id AND emails.email = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu@example.org&#34;</span><span class=p>).</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;JOIN credit_cards ON credit_cards.user_id = users.id&#34;</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;credit_cards.number = ?&#34;</span><span class=p>,</span> <span class=s>&#34;411111111111&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=joins-预加载>Joins 预加载</h4><p>您可以使用 <code>Joins</code> 实现<strong>单条 SQL 预加载关联记录</strong>，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;Company&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT `users`.`id`,`users`.`name`,`users`.`age`,`Company`.`id` AS `Company__id`,`Company`.`name` AS `Company__name` FROM `users` LEFT JOIN `companies` AS `Company` ON `users`.`company_id` = `Company`.`id`;
</span></span></span></code></pre></td></tr></table></div></div><p>Join with conditions</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;Company&#34;</span><span class=p>,</span> <span class=nx>DB</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Company</span><span class=p>{</span><span class=nx>Alive</span><span class=p>:</span> <span class=kc>true</span><span class=p>})).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT `users`.`id`,`users`.`name`,`users`.`age`,`Company`.`id` AS `Company__id`,`Company`.`name` AS `Company__name` FROM `users` LEFT JOIN `companies` AS `Company` ON `users`.`company_id` = `Company`.`id` AND `Company`.`alive` = true;
</span></span></span></code></pre></td></tr></table></div></div><p>For more details, please refer to <a href=https://gorm.io/zh_CN/docs/preload.html target=_blank rel="external nofollow noopener noreferrer">Preloading (Eager Loading)</a>.</p><h3 id=scan>Scan</h3><p>Scanning results into a struct works similarly to the way we use <code>Find</code></p><p><code>Find</code> 中只能传递 gorm 模型，但 <code>Scan</code> 中可以传递任意结构体，用以接收只含有部分字段的查询结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Result</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Age</span>  <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>result</span> <span class=nx>Result</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;users&#34;</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;Antonio&#34;</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Raw SQL
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Raw</span><span class=p>(</span><span class=s>&#34;SELECT name, age FROM users WHERE name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;Antonio&#34;</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>result</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=更新>更新</h2><h3 id=保存所有字段>保存所有字段</h3><p><code>Save</code> 会保存所有的字段，即使字段是零值</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>user</span><span class=p>.</span><span class=nx>Name</span> <span class=p>=</span> <span class=s>&#34;jinzhu 2&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>user</span><span class=p>.</span><span class=nx>Age</span> <span class=p>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Save</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;jinzhu 2&#39;, age=100, birthday=&#39;2016-01-01&#39;, updated_at = &#39;2013-11-17 21:34:10&#39; WHERE id=111;
</span></span></span></code></pre></td></tr></table></div></div><h3 id=更新单个列>更新单个列</h3><p>当使用 <code>Update</code> 更新单个列时，你需要指定条件，否则会返回 <code>ErrMissingWhereClause</code> 错误，查看 <a href=https://gorm.io/zh_CN/docs/update.html#block_global_updates target=_blank rel="external nofollow noopener noreferrer">Block Global Updates</a> 获取详情。当使用了 <code>Model</code> 方法，且该对象主键有值，该值会被用于构建条件，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 条件更新
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;active = ?&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, updated_at=&#39;2013-11-17 21:34:10&#39; WHERE active=true;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// User 的 ID 是 `111`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, updated_at=&#39;2013-11-17 21:34:10&#39; WHERE id=111;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 根据条件和 model 的值进行更新
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;active = ?&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, updated_at=&#39;2013-11-17 21:34:10&#39; WHERE id=111 AND active=true;
</span></span></span></code></pre></td></tr></table></div></div><h3 id=更新多列>更新多列</h3><p><code>Updates</code> 方法支持 <code>struct</code> 和 <code>map[string]interface{}</code> 参数。</p><p>当使用 <code>struct</code> 更新时，默认情况下，GORM 只会更新非零值的字段</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 根据 `struct` 更新属性，只会更新非零值的字段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span> <span class=nx>Active</span><span class=p>:</span> <span class=kc>false</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, age=18, updated_at = &#39;2013-11-17 21:34:10&#39; WHERE id = 111;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 根据 `map` 更新属性
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span> <span class=s>&#34;active&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, age=18, active=false, updated_at=&#39;2013-11-17 21:34:10&#39; WHERE id=111;
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong> 当通过 struct 更新时，GORM 只会更新非零字段。 如果您想确保指定字段被更新，你应该使用 <code>Select</code> 更新选定字段，或使用 <code>map</code> 来完成更新操作</p></blockquote><h3 id=更新选定字段>更新选定字段</h3><p>如果您想要在更新时选定、忽略某些字段，您可以使用 <code>Select</code>、<code>Omit</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 使用 Map 进行 Select
</span></span></span><span class=line><span class=cl><span class=c1>// User&#39;s ID is `111`:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span> <span class=s>&#34;active&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39; WHERE id=111;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Omit</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span> <span class=s>&#34;active&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET age=18, active=false, updated_at=&#39;2013-11-17 21:34:10&#39; WHERE id=111;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 使用 Struct 进行 Select（会 select 零值的字段）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;Name&#34;</span><span class=p>,</span> <span class=s>&#34;Age&#34;</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;new_name&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>0</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;new_name&#39;, age=0 WHERE id=111;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Select 所有字段（查询包括零值字段的所有字段）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;*&#34;</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=nx>Role</span><span class=p>:</span> <span class=s>&#34;admin&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>0</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Select 除 Role 外的所有字段（包括零值字段的所有字段）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;*&#34;</span><span class=p>).</span><span class=nf>Omit</span><span class=p>(</span><span class=s>&#34;Role&#34;</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=nx>Role</span><span class=p>:</span> <span class=s>&#34;admin&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>0</span><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=更新-hook>更新 Hook</h3><p>对于更新操作，GORM 支持 <code>BeforeSave</code>、<code>BeforeUpdate</code>、<code>AfterSave</code>、<code>AfterUpdate</code> 钩子，这些方法将在更新记录时被调用，详情请参阅 <a href=https://gorm.io/zh_CN/docs/hooks.html target=_blank rel="external nofollow noopener noreferrer">钩子</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>BeforeUpdate</span><span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Role</span> <span class=o>==</span> <span class=s>&#34;admin&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;admin user not allowed to update&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=批量更新>批量更新</h3><p>如果您尚未通过 <code>Model</code> 指定记录的主键，则 GORM 会执行批量更新</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 根据 struct 更新
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;role = ?&#34;</span><span class=p>,</span> <span class=s>&#34;admin&#34;</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>18</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, age=18 WHERE role = &#39;admin&#39;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 根据 map 更新
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;users&#34;</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;id IN ?&#34;</span><span class=p>,</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{</span><span class=mi>10</span><span class=p>,</span> <span class=mi>11</span><span class=p>}).</span><span class=nf>Updates</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>:</span> <span class=mi>18</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, age=18 WHERE id IN (10, 11);
</span></span></span></code></pre></td></tr></table></div></div><h4 id=阻止全局更新>阻止全局更新</h4><p>如果在没有任何条件的情况下执行批量更新，默认情况下，GORM 不会执行该操作，并返回 <code>ErrMissingWhereClause</code> 错误</p><p>对此，你必须加一些条件，或者使用原生 SQL，或者启用 <code>AllowGlobalUpdate</code> 模式，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nx>Error</span> <span class=c1>// gorm.ErrMissingWhereClause
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;1 = 1&#34;</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET `name` = &#34;jinzhu&#34; WHERE 1=1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;UPDATE users SET name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name = &#34;jinzhu&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Session</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Session</span><span class=p>{</span><span class=nx>AllowGlobalUpdate</span><span class=p>:</span> <span class=kc>true</span><span class=p>}).</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET `name` = &#34;jinzhu&#34;
</span></span></span></code></pre></td></tr></table></div></div><h4 id=更新的记录数>更新的记录数</h4><p>获取受更新影响的行数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 通过 `RowsAffected` 得到更新的记录数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;role = ?&#34;</span><span class=p>,</span> <span class=s>&#34;admin&#34;</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>18</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, age=18 WHERE role = &#39;admin&#39;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>result</span><span class=p>.</span><span class=nx>RowsAffected</span> <span class=c1>// 更新的记录数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span><span class=p>.</span><span class=nx>Error</span>        <span class=c1>// 更新的错误
</span></span></span></code></pre></td></tr></table></div></div><h3 id=高级选项-1>高级选项</h3><h4 id=使用-sql-表达式更新>使用 SQL 表达式更新</h4><p>GORM 允许使用 SQL 表达式更新列，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// product 的 ID 是 `3`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;price&#34;</span><span class=p>,</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Expr</span><span class=p>(</span><span class=s>&#34;price * ? + ?&#34;</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>100</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE &#34;products&#34; SET &#34;price&#34; = price * 2 + 100, &#34;updated_at&#34; = &#39;2013-11-17 21:34:10&#39; WHERE &#34;id&#34; = 3;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;price&#34;</span><span class=p>:</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Expr</span><span class=p>(</span><span class=s>&#34;price * ? + ?&#34;</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>100</span><span class=p>)})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE &#34;products&#34; SET &#34;price&#34; = price * 2 + 100, &#34;updated_at&#34; = &#39;2013-11-17 21:34:10&#39; WHERE &#34;id&#34; = 3;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 不会更新 updated_at 字段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>).</span><span class=nf>UpdateColumn</span><span class=p>(</span><span class=s>&#34;quantity&#34;</span><span class=p>,</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Expr</span><span class=p>(</span><span class=s>&#34;quantity - ?&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE &#34;products&#34; SET &#34;quantity&#34; = quantity - 1 WHERE &#34;id&#34; = 3;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;quantity &gt; 1&#34;</span><span class=p>).</span><span class=nf>UpdateColumn</span><span class=p>(</span><span class=s>&#34;quantity&#34;</span><span class=p>,</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Expr</span><span class=p>(</span><span class=s>&#34;quantity - ?&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE &#34;products&#34; SET &#34;quantity&#34; = quantity - 1 WHERE &#34;id&#34; = 3 AND quantity &gt; 1;
</span></span></span></code></pre></td></tr></table></div></div><p>并且 GORM 也允许使用 SQL 表达式、<a href=https://gorm.io/zh_CN/docs/data_types.html#gorm_valuer_interface target=_blank rel="external nofollow noopener noreferrer">自定义数据类型</a>的 Context Valuer 来更新，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 根据自定义数据类型创建
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Location</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>X</span><span class=p>,</span> <span class=nx>Y</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>loc</span> <span class=nx>Location</span><span class=p>)</span> <span class=nf>GormValue</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>db</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=nx>clause</span><span class=p>.</span><span class=nx>Expr</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>clause</span><span class=p>.</span><span class=nx>Expr</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>SQL</span><span class=p>:</span>  <span class=s>&#34;ST_PointFromText(?)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Vars</span><span class=p>:</span> <span class=p>[]</span><span class=kd>interface</span><span class=p>{}{</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;POINT(%d %d)&#34;</span><span class=p>,</span> <span class=nx>loc</span><span class=p>.</span><span class=nx>X</span><span class=p>,</span> <span class=nx>loc</span><span class=p>.</span><span class=nx>Y</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=mi>1</span><span class=p>}).</span><span class=nf>Updates</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span><span class=p>:</span>  <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Location</span><span class=p>:</span> <span class=nx>Location</span><span class=p>{</span><span class=nx>X</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span> <span class=nx>Y</span><span class=p>:</span> <span class=mi>100</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE `user_with_points` SET `name`=&#34;jinzhu&#34;,`location`=ST_PointFromText(&#34;POINT(100 100)&#34;) WHERE `id` = 1
</span></span></span></code></pre></td></tr></table></div></div><h4 id=根据子查询进行更新>根据子查询进行更新</h4><p>使用子查询更新表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;company_name&#34;</span><span class=p>,</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Company</span><span class=p>{}).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;companies.id = users.company_id&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE &#34;users&#34; SET &#34;company_name&#34; = (SELECT name FROM companies WHERE companies.id = users.company_id);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;users as u&#34;</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;company_name&#34;</span><span class=p>,</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;companies as c&#34;</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;c.id = u.company_id&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE &#34;users as u&#34; SET &#34;company_name&#34; = (SELECT name FROM companies as c WHERE c.id = u.company_id) WHERE name = &#34;jinzhu&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;users as u&#34;</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{}{</span><span class=s>&#34;company_name&#34;</span><span class=p>:</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;companies as c&#34;</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;c.id = u.company_id&#34;</span><span class=p>)})</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=不使用-hook-和时间追踪>不使用 Hook 和时间追踪</h4><p>如果您想在更新时跳过 <code>Hook</code> 方法且不追踪更新时间，可以使用 <code>UpdateColumn</code>、<code>UpdateColumns</code>，其用法类似于 <code>Update</code>、<code>Updates</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 更新单个列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>UpdateColumn</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39; WHERE id = 111;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 更新多个列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>UpdateColumns</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>18</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, age=18 WHERE id = 111;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 更新选中的列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>).</span><span class=nf>UpdateColumns</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>0</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, age=0 WHERE id = 111;
</span></span></span></code></pre></td></tr></table></div></div><h4 id=返回修改行的数据>返回修改行的数据</h4><p>返回被修改的数据，仅适用于支持 Returning 的数据库，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 返回所有列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>users</span> <span class=p>[]</span><span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=nx>DB</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>).</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Returning</span><span class=p>{}).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;role = ?&#34;</span><span class=p>,</span> <span class=s>&#34;admin&#34;</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;salary&#34;</span><span class=p>,</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Expr</span><span class=p>(</span><span class=s>&#34;salary * ?&#34;</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE `users` SET `salary`=salary * 2,`updated_at`=&#34;2021-10-28 17:37:23.19&#34; WHERE role = &#34;admin&#34; RETURNING *
</span></span></span><span class=line><span class=cl><span class=c1>// users =&gt; []User{{ID: 1, Name: &#34;jinzhu&#34;, Role: &#34;admin&#34;, Salary: 100}, {ID: 2, Name: &#34;jinzhu.2&#34;, Role: &#34;admin&#34;, Salary: 1000}}
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 返回指定的列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>DB</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>).</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Returning</span><span class=p>{</span><span class=nx>Columns</span><span class=p>:</span> <span class=p>[]</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Column</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;name&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;salary&#34;</span><span class=p>}}}).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;role = ?&#34;</span><span class=p>,</span> <span class=s>&#34;admin&#34;</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;salary&#34;</span><span class=p>,</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Expr</span><span class=p>(</span><span class=s>&#34;salary * ?&#34;</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE `users` SET `salary`=salary * 2,`updated_at`=&#34;2021-10-28 17:37:23.19&#34; WHERE role = &#34;admin&#34; RETURNING `name`, `salary`
</span></span></span><span class=line><span class=cl><span class=c1>// users =&gt; []User{{ID: 0, Name: &#34;jinzhu&#34;, Role: &#34;&#34;, Salary: 100}, {ID: 0, Name: &#34;jinzhu.2&#34;, Role: &#34;&#34;, Salary: 1000}}
</span></span></span></code></pre></td></tr></table></div></div><h4 id=检查字段是否有变更>检查字段是否有变更</h4><p>GORM 提供了 <code>Changed</code> 方法，它可以被用在 <strong>Before Update Hook</strong> 里，它会返回字段是否有变更的布尔值</p><p><code>Changed</code> 方法只能与 <code>Update</code>、<code>Updates</code> 方法一起使用，并且它只是检查 Model 对象字段的值与 <code>Update</code>、<code>Updates</code> 的值是否相等，如果值有变更，且字段没有被忽略，则返回 true</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>BeforeUpdate</span><span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果 Role 字段有变更
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>tx</span><span class=p>.</span><span class=nx>Statement</span><span class=p>.</span><span class=nf>Changed</span><span class=p>(</span><span class=s>&#34;Role&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;role not allowed to change&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>tx</span><span class=p>.</span><span class=nx>Statement</span><span class=p>.</span><span class=nf>Changed</span><span class=p>(</span><span class=s>&#34;Name&#34;</span><span class=p>,</span> <span class=s>&#34;Admin&#34;</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// 如果 Name 或 Role 字段有变更
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>tx</span><span class=p>.</span><span class=nx>Statement</span><span class=p>.</span><span class=nf>SetColumn</span><span class=p>(</span><span class=s>&#34;Age&#34;</span><span class=p>,</span> <span class=mi>18</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果任意字段有变更
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>tx</span><span class=p>.</span><span class=nx>Statement</span><span class=p>.</span><span class=nf>Changed</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>tx</span><span class=p>.</span><span class=nx>Statement</span><span class=p>.</span><span class=nf>SetColumn</span><span class=p>(</span><span class=s>&#34;RefreshedAt&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>}).</span><span class=nf>Updates</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu2&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// Changed(&#34;Name&#34;) =&gt; true
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>}).</span><span class=nf>Updates</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// Changed(&#34;Name&#34;) =&gt; false, 因为 `Name` 没有变更
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>}).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;Admin&#34;</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu2&#34;</span><span class=p>,</span> <span class=s>&#34;admin&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// Changed(&#34;Name&#34;) =&gt; false, 因为 `Name` 没有被 Select 选中并更新
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>}).</span><span class=nf>Updates</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu2&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// Changed(&#34;Name&#34;) =&gt; true
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>}).</span><span class=nf>Updates</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// Changed(&#34;Name&#34;) =&gt; false, 因为 `Name` 没有变更
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>}).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;Admin&#34;</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu2&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// Changed(&#34;Name&#34;) =&gt; false, 因为 `Name` 没有被 Select 选中并更新
</span></span></span></code></pre></td></tr></table></div></div><h4 id=在-update-时修改值>在 Update 时修改值</h4><p>若要在 Before 钩子中改变要更新的值，如果它是一个完整的更新，可以使用 <code>Save</code>；否则，应该使用 <code>SetColumn</code> ，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>user</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>BeforeSave</span><span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>pw</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>bcrypt</span><span class=p>.</span><span class=nf>GenerateFromPassword</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>Password</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>tx</span><span class=p>.</span><span class=nx>Statement</span><span class=p>.</span><span class=nf>SetColumn</span><span class=p>(</span><span class=s>&#34;EncryptedPassword&#34;</span><span class=p>,</span> <span class=nx>pw</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>tx</span><span class=p>.</span><span class=nx>Statement</span><span class=p>.</span><span class=nf>Changed</span><span class=p>(</span><span class=s>&#34;Code&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nx>Age</span> <span class=o>+=</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>    <span class=nx>tx</span><span class=p>.</span><span class=nx>Statement</span><span class=p>.</span><span class=nf>SetColumn</span><span class=p>(</span><span class=s>&#34;Age&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Age</span><span class=o>+</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;Name&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=删除>删除</h2><h3 id=删除一条记录>删除一条记录</h3><p>删除一条记录时，删除对象需要指定主键，否则会触发 <a href=https://gorm.io/zh_CN/docs/delete.html#batch_delete target=_blank rel="external nofollow noopener noreferrer">批量 Delete</a>，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Email 的 ID 是 `10`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>email</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE from emails where id = 10;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 带额外条件的删除
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>email</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE from emails where id = 10 AND name = &#34;jinzhu&#34;;
</span></span></span></code></pre></td></tr></table></div></div><h3 id=根据主键删除>根据主键删除</h3><p>GORM 允许通过主键 (可以是复合主键) 和内联条件来删除对象，它可以使用数字（如以下例子。也可以使用字符串——译者注）。查看 <a href=https://gorm.io/zh_CN/docs/query.html#inline_conditions target=_blank rel="external nofollow noopener noreferrer">查询-内联条件（Query Inline Conditions）</a> 了解详情。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{},</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE FROM users WHERE id = 10;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{},</span> <span class=s>&#34;10&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE FROM users WHERE id = 10;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>,</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE FROM users WHERE id IN (1,2,3);
</span></span></span></code></pre></td></tr></table></div></div><h3 id=delete-hook>Delete Hook</h3><p>对于删除操作，GORM 支持 <code>BeforeDelete</code>、<code>AfterDelete</code> Hook，在删除记录时会调用这些方法，查看 <a href=https://gorm.io/zh_CN/docs/hooks.html target=_blank rel="external nofollow noopener noreferrer">Hook</a> 获取详情</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>BeforeDelete</span><span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Role</span> <span class=o>==</span> <span class=s>&#34;admin&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;admin user not allowed to delete&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=批量删除>批量删除</h3><p>如果指定的值不包括主属性，那么 GORM 会执行批量删除，它将删除所有匹配的记录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;email LIKE ?&#34;</span><span class=p>,</span> <span class=s>&#34;%jinzhu%&#34;</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>Email</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE from emails where email LIKE &#34;%jinzhu%&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>Email</span><span class=p>{},</span> <span class=s>&#34;email LIKE ?&#34;</span><span class=p>,</span> <span class=s>&#34;%jinzhu%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE from emails where email LIKE &#34;%jinzhu%&#34;;
</span></span></span></code></pre></td></tr></table></div></div><h4 id=阻止全局删除>阻止全局删除</h4><p>如果在没有任何条件的情况下执行批量删除，GORM 不会执行该操作，并返回 <code>ErrMissingWhereClause</code> 错误</p><p>对此，你必须加一些条件，或者使用原生 SQL，或者启用 <code>AllowGlobalUpdate</code> 模式，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nx>Error</span> <span class=c1>// gorm.ErrMissingWhereClause
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;1 = 1&#34;</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE FROM `users` WHERE 1=1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;DELETE FROM users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE FROM users
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Session</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Session</span><span class=p>{</span><span class=nx>AllowGlobalUpdate</span><span class=p>:</span> <span class=kc>true</span><span class=p>}).</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE FROM users
</span></span></span></code></pre></td></tr></table></div></div><h4 id=返回删除行的数据>返回删除行的数据</h4><p>返回被删除的数据，仅适用于支持 Returning 的数据库，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 返回所有列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>users</span> <span class=p>[]</span><span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=nx>DB</span><span class=p>.</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Returning</span><span class=p>{}).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;role = ?&#34;</span><span class=p>,</span> <span class=s>&#34;admin&#34;</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE FROM `users` WHERE role = &#34;admin&#34; RETURNING *
</span></span></span><span class=line><span class=cl><span class=c1>// users =&gt; []User{{ID: 1, Name: &#34;jinzhu&#34;, Role: &#34;admin&#34;, Salary: 100}, {ID: 2, Name: &#34;jinzhu.2&#34;, Role: &#34;admin&#34;, Salary: 1000}}
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 返回指定的列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>DB</span><span class=p>.</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Returning</span><span class=p>{</span><span class=nx>Columns</span><span class=p>:</span> <span class=p>[]</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Column</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;name&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;salary&#34;</span><span class=p>}}}).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;role = ?&#34;</span><span class=p>,</span> <span class=s>&#34;admin&#34;</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE FROM `users` WHERE role = &#34;admin&#34; RETURNING `name`, `salary`
</span></span></span><span class=line><span class=cl><span class=c1>// users =&gt; []User{{ID: 0, Name: &#34;jinzhu&#34;, Role: &#34;&#34;, Salary: 100}, {ID: 0, Name: &#34;jinzhu.2&#34;, Role: &#34;&#34;, Salary: 1000}}
</span></span></span></code></pre></td></tr></table></div></div><h3 id=软删除>软删除</h3><p>如果您的模型包含了一个 <code>gorm.deletedat</code> 字段（<code>gorm.Model</code> 已经包含了该字段)，它将自动获得软删除的能力！</p><p>拥有软删除能力的模型调用 <code>Delete</code> 时，记录不会被数据库。但 GORM 会将 <code>DeletedAt</code> 置为当前时间， 并且你不能再通过普通的查询方法找到该记录。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// user 的 ID 是 `111`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET deleted_at=&#34;2013-10-29 10:23&#34; WHERE id = 111;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 批量删除
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;age = ?&#34;</span><span class=p>,</span> <span class=mi>20</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET deleted_at=&#34;2013-10-29 10:23&#34; WHERE age = 20;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 在查询时会忽略被软删除的记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;age = 20&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE age = 20 AND deleted_at IS NULL;
</span></span></span></code></pre></td></tr></table></div></div><p>如果您不想引入 <code>gorm.Model</code>，您也可以这样启用软删除特性：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>      <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Deleted</span> <span class=nx>gorm</span><span class=p>.</span><span class=nx>DeletedAt</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>    <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=查找被软删除的记录>查找被软删除的记录</h4><p>您可以使用 <code>Unscoped</code> 找到被软删除的记录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Unscoped</span><span class=p>().</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;age = 20&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE age = 20;
</span></span></span></code></pre></td></tr></table></div></div><h4 id=永久删除>永久删除</h4><p>您也可以使用 <code>Unscoped</code> 永久删除匹配的记录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Unscoped</span><span class=p>().</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>order</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE FROM orders WHERE id=10;
</span></span></span></code></pre></td></tr></table></div></div><h4 id=delete-flag>Delete Flag</h4><p>将 unix 时间戳作为 delete flag</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;gorm.io/plugin/soft_delete&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>        <span class=kt>uint</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>DeletedAt</span> <span class=nx>soft_delete</span><span class=p>.</span><span class=nx>DeletedAt</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 查询
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>SELECT</span> <span class=o>*</span> <span class=nx>FROM</span> <span class=nx>users</span> <span class=nx>WHERE</span> <span class=nx>deleted_at</span> <span class=p>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 删除
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>UPDATE</span> <span class=nx>users</span> <span class=nx>SET</span> <span class=nx>deleted_at</span> <span class=p>=</span> <span class=cm>/* current unix second */</span> <span class=nx>WHERE</span> <span class=nx>ID</span> <span class=p>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>INFO</strong> 在配合 unique 字段使用软删除时，您需要使用这个基于 unix 时间戳的 <code>DeletedAt</code> 字段创建一个复合索引，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>import &#34;gorm.io/plugin/soft_delete&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>type User struct {
</span></span><span class=line><span class=cl>  ID        uint
</span></span><span class=line><span class=cl>  Name      string                `gorm:&#34;uniqueIndex:udx_name&#34;`
</span></span><span class=line><span class=cl>  DeletedAt soft_delete.DeletedAt `gorm:&#34;uniqueIndex:udx_name&#34;`
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div></blockquote><p>使用 <code>1</code> / <code>0</code> 作为 delete flag</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;gorm.io/plugin/soft_delete&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>    <span class=kt>uint</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>IsDel</span> <span class=nx>soft_delete</span><span class=p>.</span><span class=nx>DeletedAt</span> <span class=s>`gorm:&#34;softDelete:flag&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 查询
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>SELECT</span> <span class=o>*</span> <span class=nx>FROM</span> <span class=nx>users</span> <span class=nx>WHERE</span> <span class=nx>is_del</span> <span class=p>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 删除
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>UPDATE</span> <span class=nx>users</span> <span class=nx>SET</span> <span class=nx>is_del</span> <span class=p>=</span> <span class=mi>1</span> <span class=nx>WHERE</span> <span class=nx>ID</span> <span class=p>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=关联>关联</h2><h3 id=belongs-to>Belongs to</h3><p><code>belongs to</code> 会与另一个模型建立了一对一的连接。 这种模型的每一个实例都“属于”另一个模型的一个实例。</p><p>例如，您的应用包含 user 和 company，并且每个 user 能且只能被分配给一个 company。下面的类型就表示这种关系。</p><p>注意，在 <code>User</code> 对象中，有一个和 <code>Company</code> 一样的 <code>CompanyID</code>。 默认情况下， <code>CompanyID</code> 被隐含地用来在 <code>User</code> 和 <code>Company</code> 之间创建一个外键关系， 因此必须包含在 <code>User</code> 结构体中才能填充 <code>Company</code> 内部结构体。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// `User` 属于 `Company`，`CompanyID` 是外键
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>CompanyID</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Company</span>   <span class=nx>Company</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Company</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=重写外键>重写外键</h4><p>要定义一个 belongs to 关系，数据库的表中必须存在外键。</p><p>默认情况下，<strong>外键的名字，使用拥有者的类型名称加上表的主键的字段名字</strong></p><p>例如，定义一个 User 实体属于 Company 实体，那么外键的名字一般使用 CompanyID。</p><p>GORM 同时提供自定义外键名字的方式，如下例所示。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>         <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>CompanyRefer</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Company</span>      <span class=nx>Company</span> <span class=s>`gorm:&#34;foreignKey:CompanyRefer&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 使用 CompanyRefer 作为外键
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Company</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=重写引用>重写引用</h4><p>对于 belongs to 关系，GORM 通常使用数据库表，主表（拥有者）的主键值作为外键参考。 正如上面的例子，我们使用主表 Company 中的主键字段 ID 作为外键的参考值。</p><p>如果在 Company 实体中设置了 User 实体，那么 GORM 会自动把 Company 中的 ID 属性保存到 User 的 CompanyID 属性中。</p><p>同样的，您也可以使用标签 <code>references</code> 来更改它，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>CompanyID</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Company</span>   <span class=nx>Company</span> <span class=s>`gorm:&#34;references:Code&#34;`</span> <span class=c1>// 使用 Code 作为引用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Company</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Code</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=外键约束>外键约束</h4><p>你可以通过 <code>OnUpdate</code>, <code>OnDelete</code> 配置标签来增加关联关系的级联操作，如下面的例子，通过 GORM 可以完成用户和公司的级联更新和级联删除操作：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>CompanyID</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Company</span>   <span class=nx>Company</span> <span class=s>`gorm:&#34;constraint:OnUpdate:CASCADE,OnDelete:SET NULL;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Company</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=has-one>Has One</h3><p><code>has one</code> 与另一个模型建立一对一的关联，但它和一对一关系有些许不同。 这种关联表明一个模型的每个实例都包含或拥有另一个模型的一个实例。</p><p>例如，您的应用包含 user 和 credit card 模型，且每个 user 只能有一张 credit card。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// User 有一张 CreditCard，UserID 是外键
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCard</span> <span class=nx>CreditCard</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CreditCard</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Number</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>UserID</span> <span class=kt>uint</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=重写外键-1>重写外键</h4><p>对于 <code>has one</code> 关系，同样必须存在外键字段。拥有者将把属于它的模型的主键保存到这个字段。</p><p>这个字段的名称通常<strong>由 <code>has one</code> 模型的类型加上其 <code>主键</code> 生成</strong>，对于上面的例子，它是 <code>UserID</code>。</p><p>为 user 添加 credit card 时，它会将 user 的 <code>ID</code> 保存到自己的 <code>UserID</code> 字段。</p><p>如果你想要使用另一个字段来保存该关系，你同样可以使用标签 <code>foreignKey</code> 来更改它，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCard</span> <span class=nx>CreditCard</span> <span class=s>`gorm:&#34;foreignKey:UserName&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 使用 UserName 作为外键
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CreditCard</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Number</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>UserName</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=重写引用-1>重写引用</h4><p>默认情况下，<strong>拥有者实体会将 <code>has one</code> 对应模型的主键保存为外键</strong>，您也可以修改它，用另一个字段来保存，例如下个这个使用 <code>Name</code> 来保存的例子。</p><p>您可以使用标签 <code>references</code> 来更改它，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>       <span class=kt>string</span>     <span class=s>`gorm:&#34;index&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCard</span> <span class=nx>CreditCard</span> <span class=s>`gorm:&#34;foreignkey:UserName;references:name&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CreditCard</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Number</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>UserName</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=多态关联>多态关联</h4><p>GORM 为 <code>has one</code> 和 <code>has many</code> 提供了多态关联支持，它会将拥有者实体的表名、主键值都保存到多态类型的字段中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Cat</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>    <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Toy</span>   <span class=nx>Toy</span> <span class=s>`gorm:&#34;polymorphic:Owner;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Dog</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Toy</span>  <span class=nx>Toy</span> <span class=s>`gorm:&#34;polymorphic:Owner;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Toy</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>        <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>OwnerID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>OwnerType</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Dog</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;dog1&#34;</span><span class=p>,</span> <span class=nx>Toy</span><span class=p>:</span> <span class=nx>Toy</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;toy1&#34;</span><span class=p>}})</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `dogs` (`name`) VALUES (&#34;dog1&#34;)
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES (&#34;toy1&#34;,&#34;1&#34;,&#34;dogs&#34;)
</span></span></span></code></pre></td></tr></table></div></div><p>您可以使用标签 <code>polymorphicValue</code> 来更改多态类型的值，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Dog</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Toy</span>  <span class=nx>Toy</span> <span class=s>`gorm:&#34;polymorphic:Owner;polymorphicValue:master&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Toy</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>        <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>OwnerID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>OwnerType</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Dog</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;dog1&#34;</span><span class=p>,</span> <span class=nx>Toy</span><span class=p>:</span> <span class=nx>Toy</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;toy1&#34;</span><span class=p>}})</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `dogs` (`name`) VALUES (&#34;dog1&#34;)
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES (&#34;toy1&#34;,&#34;1&#34;,&#34;master&#34;)
</span></span></span></code></pre></td></tr></table></div></div><h4 id=自引用-has-one>自引用 Has One</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>ManagerID</span> <span class=o>*</span><span class=kt>uint</span>
</span></span><span class=line><span class=cl>  <span class=nx>Manager</span>   <span class=o>*</span><span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=外键约束-1>外键约束</h4><p>你可以通过为标签 <code>constraint</code> 配置 <code>OnUpdate</code>、<code>OnDelete</code> 实现外键约束，在使用 GORM 进行迁移时它会被创建，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCard</span> <span class=nx>CreditCard</span> <span class=s>`gorm:&#34;constraint:OnUpdate:CASCADE,OnDelete:SET NULL;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CreditCard</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Number</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>UserID</span> <span class=kt>uint</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>你也可以在删除记录时通过 <code>Select</code> 来删除关联的记录</p><h3 id=has-many>Has Many</h3><p><code>has many</code> 与另一个模型建立了一对多的连接。 不同于 <code>has one</code>，拥有者可以有零或多个关联模型。</p><p>例如，您的应用包含 user 和 credit card 模型，且每个 user 可以有多张 credit card。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// User 有多张 CreditCard，UserID 是外键
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCards</span> <span class=p>[]</span><span class=nx>CreditCard</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CreditCard</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Number</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>UserID</span> <span class=kt>uint</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=重写外键-2>重写外键</h4><p>要定义 <code>has many</code> 关系，同样必须存在外键。 默认的外键名是拥有者的类型名加上其主键字段名</p><p>例如，要定义一个属于 <code>User</code> 的模型，则其外键应该是 <code>UserID</code>。</p><p>此外，想要使用另一个字段作为外键，您可以使用 <code>foreignKey</code> 标签自定义它：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCards</span> <span class=p>[]</span><span class=nx>CreditCard</span> <span class=s>`gorm:&#34;foreignKey:UserRefer&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CreditCard</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Number</span>    <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>UserRefer</span> <span class=kt>uint</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=重写引用-2>重写引用</h4><p>GORM 通常使用拥有者的主键作为外键的值。 对于上面的例子，它是 <code>User</code> 的 <code>ID</code> 字段。</p><p>为 user 添加 credit card 时，GORM 会将 user 的 <code>ID</code> 字段保存到 credit card 的 <code>UserID</code> 字段。</p><p>同样的，您也可以使用标签 <code>references</code> 来更改它，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>MemberNumber</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCards</span>  <span class=p>[]</span><span class=nx>CreditCard</span> <span class=s>`gorm:&#34;foreignKey:UserNumber;references:MemberNumber&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CreditCard</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Number</span>     <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>UserNumber</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=多态关联-1>多态关联</h4><p>GORM 为 <code>has one</code> 和 <code>has many</code> 提供了多态关联支持，它会将拥有者实体的表名、主键都保存到多态类型的字段中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Dog</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Toys</span> <span class=p>[]</span><span class=nx>Toy</span> <span class=s>`gorm:&#34;polymorphic:Owner;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Toy</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>        <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>OwnerID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>OwnerType</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Dog</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;dog1&#34;</span><span class=p>,</span> <span class=nx>Toys</span><span class=p>:</span> <span class=p>[]</span><span class=nx>Toy</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;toy1&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;toy2&#34;</span><span class=p>}}})</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `dogs` (`name`) VALUES (&#34;dog1&#34;)
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES (&#34;toy1&#34;,&#34;1&#34;,&#34;dogs&#34;), (&#34;toy2&#34;,&#34;1&#34;,&#34;dogs&#34;)
</span></span></span></code></pre></td></tr></table></div></div><p>您可以使用标签 <code>polymorphicValue</code> 来更改多态类型的值，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Dog</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Toys</span> <span class=p>[]</span><span class=nx>Toy</span> <span class=s>`gorm:&#34;polymorphic:Owner;polymorphicValue:master&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Toy</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>        <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>OwnerID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>OwnerType</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Dog</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;dog1&#34;</span><span class=p>,</span> <span class=nx>Toys</span><span class=p>:</span> <span class=p>[]</span><span class=nx>Toy</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;toy1&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;toy2&#34;</span><span class=p>}}})</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `dogs` (`name`) VALUES (&#34;dog1&#34;)
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES (&#34;toy1&#34;,&#34;1&#34;,&#34;master&#34;), (&#34;toy2&#34;,&#34;1&#34;,&#34;master&#34;)
</span></span></span></code></pre></td></tr></table></div></div><h4 id=自引用-has-many>自引用 Has Many</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>ManagerID</span> <span class=o>*</span><span class=kt>uint</span>
</span></span><span class=line><span class=cl>  <span class=nx>Team</span>      <span class=p>[]</span><span class=nx>User</span> <span class=s>`gorm:&#34;foreignkey:ManagerID&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=外键约束-2>外键约束</h4><p>你可以通过为标签 <code>constraint</code> 配置 <code>OnUpdate</code>、<code>OnDelete</code> 实现外键约束，在使用 GORM 进行迁移时它会被创建，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCards</span> <span class=p>[]</span><span class=nx>CreditCard</span> <span class=s>`gorm:&#34;constraint:OnUpdate:CASCADE,OnDelete:SET NULL;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CreditCard</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Number</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>UserID</span> <span class=kt>uint</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>你也可以在删除记录时通过 <code>Select</code> 来删除 has many 关联的记录</p><h3 id=many-to-many>Many To Many</h3><p>Many to Many 会在两个 model 中添加一张连接表。</p><p>例如，您的应用包含了 user 和 language，且一个 user 可以说多种 language，多个 user 也可以说一种 language。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// User 拥有并属于多种 language，`user_languages` 是连接表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Languages</span> <span class=p>[]</span><span class=nx>Language</span> <span class=s>`gorm:&#34;many2many:user_languages;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Language</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>当使用 GORM 的 <code>AutoMigrate</code> 为 <code>User</code> 创建表时，GORM 会自动创建连接表</p><h4 id=反向引用>反向引用</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// User 拥有并属于多种 language，`user_languages` 是连接表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Languages</span> <span class=p>[]</span><span class=o>*</span><span class=nx>Language</span> <span class=s>`gorm:&#34;many2many:user_languages;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Language</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Users</span> <span class=p>[]</span><span class=o>*</span><span class=nx>User</span> <span class=s>`gorm:&#34;many2many:user_languages;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=重写外键-3>重写外键</h4><p>对于 <code>many2many</code> 关系，连接表会同时拥有两个模型的外键，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Languages</span> <span class=p>[]</span><span class=nx>Language</span> <span class=s>`gorm:&#34;many2many:user_languages;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Language</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 连接表：user_languages
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: user_id, reference: users.id
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: language_id, reference: languages.id
</span></span></span></code></pre></td></tr></table></div></div><p>若要重写它们，可以使用标签 <code>foreignKey</code>、<code>references</code>、<code>joinforeignKey</code>、<code>joinReferences</code>。当然，您不需要使用全部的标签，你可以仅使用其中的一个重写部分的外键、引用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=nx>Profiles</span> <span class=p>[]</span><span class=nx>Profile</span> <span class=s>`gorm:&#34;many2many:user_profiles;foreignKey:Refer;joinForeignKey:UserReferID;References:UserRefer;joinReferences:ProfileRefer&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Refer</span>    <span class=kt>uint</span>      <span class=s>`gorm:&#34;index:,unique&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Profile</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>UserRefer</span> <span class=kt>uint</span> <span class=s>`gorm:&#34;index:,unique&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 会创建连接表：user_profiles
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: user_refer_id, reference: users.refer
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: profile_refer, reference: profiles.user_refer
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意：</strong> 某些数据库只允许在唯一索引字段上创建外键，如果您在迁移时会创建外键，则需要指定 <code>unique index</code> 标签。</p></blockquote><h4 id=自引用-many2many>自引用 Many2Many</h4><p>自引用 many2many 关系</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=nx>Friends</span> <span class=p>[]</span><span class=o>*</span><span class=nx>User</span> <span class=s>`gorm:&#34;many2many:user_friends&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 会创建连接表：user_friends
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: user_id, reference: users.id
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: friend_id, reference: users.id
</span></span></span></code></pre></td></tr></table></div></div><h4 id=自定义连接表>自定义连接表</h4><p><code>连接表</code> 可以是一个全功能的模型，支持 <code>Soft Delete</code>、<code>钩子</code>、更多的字段，就跟其它模型一样。您可以通过 <code>SetupJoinTable</code> 指定它，例如：</p><blockquote><p><strong>注意：</strong> 自定义连接表要求外键是复合主键或复合唯一索引</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Person</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>        <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Addresses</span> <span class=p>[]</span><span class=nx>Address</span> <span class=s>`gorm:&#34;many2many:person_addresses;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Address</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>   <span class=kt>uint</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>PersonAddress</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>PersonID</span>  <span class=kt>int</span> <span class=s>`gorm:&#34;primaryKey&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>AddressID</span> <span class=kt>int</span> <span class=s>`gorm:&#34;primaryKey&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreatedAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>  <span class=nx>DeletedAt</span> <span class=nx>gorm</span><span class=p>.</span><span class=nx>DeletedAt</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>PersonAddress</span><span class=p>)</span> <span class=nf>BeforeCreate</span><span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 修改 Person 的 Addresses 字段的连接表为 PersonAddress
</span></span></span><span class=line><span class=cl><span class=c1>// PersonAddress 必须定义好所需的外键，否则会报错
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>SetupJoinTable</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Person</span><span class=p>{},</span> <span class=s>&#34;Addresses&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>PersonAddress</span><span class=p>{})</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=外键约束-3>外键约束</h4><p>你可以通过为标签 <code>constraint</code> 配置 <code>OnUpdate</code>、<code>OnDelete</code> 实现外键约束，在使用 GORM 进行迁移时它会被创建，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Languages</span> <span class=p>[]</span><span class=nx>Language</span> <span class=s>`gorm:&#34;many2many:user_speaks;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Language</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Code</span> <span class=kt>string</span> <span class=s>`gorm:&#34;primarykey&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// CREATE TABLE `user_speaks` (`user_id` integer,`language_code` text,PRIMARY KEY (`user_id`,`language_code`),CONSTRAINT `fk_user_speaks_user` FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE SET NULL ON UPDATE CASCADE,CONSTRAINT `fk_user_speaks_language` FOREIGN KEY (`language_code`) REFERENCES `languages`(`code`) ON DELETE SET NULL ON UPDATE CASCADE);
</span></span></span></code></pre></td></tr></table></div></div><p>你也可以在删除记录时通过 <code>Select</code> 来删除 many2many 关系的记录，查看 <a href=https://gorm.io/zh_CN/docs/associations.html#delete_with_select target=_blank rel="external nofollow noopener noreferrer">Delete with Select</a> 获取详情</p><h4 id=复合外键>复合外键</h4><p>如果您的模型使用了 <a href=https://gorm.io/zh_CN/docs/composite_primary_key.html target=_blank rel="external nofollow noopener noreferrer">复合主键</a>，GORM 会<strong>默认启用复合外键</strong>。</p><p>您也可以覆盖默认的外键、指定多个外键，只需用逗号分隔那些键名，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Tag</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>     <span class=kt>uint</span>   <span class=s>`gorm:&#34;primaryKey&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Locale</span> <span class=kt>string</span> <span class=s>`gorm:&#34;primaryKey&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Value</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Blog</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>         <span class=kt>uint</span>   <span class=s>`gorm:&#34;primaryKey&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Locale</span>     <span class=kt>string</span> <span class=s>`gorm:&#34;primaryKey&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Subject</span>    <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Body</span>       <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Tags</span>       <span class=p>[]</span><span class=nx>Tag</span> <span class=s>`gorm:&#34;many2many:blog_tags;&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>LocaleTags</span> <span class=p>[]</span><span class=nx>Tag</span> <span class=s>`gorm:&#34;many2many:locale_blog_tags;ForeignKey:id,locale;References:id&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>SharedTags</span> <span class=p>[]</span><span class=nx>Tag</span> <span class=s>`gorm:&#34;many2many:shared_blog_tags;ForeignKey:id;References:id&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 连接表：blog_tags
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: blog_id, reference: blogs.id
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: blog_locale, reference: blogs.locale
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: tag_id, reference: tags.id
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: tag_locale, reference: tags.locale
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 连接表：locale_blog_tags
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: blog_id, reference: blogs.id
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: blog_locale, reference: blogs.locale
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: tag_id, reference: tags.id
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 连接表：shared_blog_tags
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: blog_id, reference: blogs.id
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: tag_id, reference: tags.id
</span></span></span></code></pre></td></tr></table></div></div><h3 id=关联模式>关联模式</h3><h4 id=自动创建更新>自动创建、更新</h4><p>在创建、更新记录时，GORM 会通过 <a href=https://gorm.io/zh_CN/docs/create.html#upsert target=_blank rel="external nofollow noopener noreferrer">Upsert</a> 自动保存关联及其引用记录。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>user</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span><span class=p>:</span>            <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>BillingAddress</span><span class=p>:</span>  <span class=nx>Address</span><span class=p>{</span><span class=nx>Address1</span><span class=p>:</span> <span class=s>&#34;Billing Address - Address 1&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>ShippingAddress</span><span class=p>:</span> <span class=nx>Address</span><span class=p>{</span><span class=nx>Address1</span><span class=p>:</span> <span class=s>&#34;Shipping Address - Address 1&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>Emails</span><span class=p>:</span>          <span class=p>[]</span><span class=nx>Email</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Email</span><span class=p>:</span> <span class=s>&#34;jinzhu@example.com&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Email</span><span class=p>:</span> <span class=s>&#34;jinzhu-2@example.com&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>Languages</span><span class=p>:</span>       <span class=p>[]</span><span class=nx>Language</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;ZH&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;EN&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// BEGIN TRANSACTION;
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO &#34;addresses&#34; (address1) VALUES (&#34;Billing Address - Address 1&#34;), (&#34;Shipping Address - Address 1&#34;) ON DUPLICATE KEY DO NOTHING;
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO &#34;users&#34; (name,billing_address_id,shipping_address_id) VALUES (&#34;jinzhu&#34;, 1, 2);
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO &#34;emails&#34; (user_id,email) VALUES (111, &#34;jinzhu@example.com&#34;), (111, &#34;jinzhu-2@example.com&#34;) ON DUPLICATE KEY DO NOTHING;
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO &#34;languages&#34; (&#34;name&#34;) VALUES (&#39;ZH&#39;), (&#39;EN&#39;) ON DUPLICATE KEY DO NOTHING;
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO &#34;user_languages&#34; (&#34;user_id&#34;,&#34;language_id&#34;) VALUES (111, 1), (111, 2) ON DUPLICATE KEY DO NOTHING;
</span></span></span><span class=line><span class=cl><span class=c1>// COMMIT;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Save</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>如果您想要更新关联的数据，您应该使用 <code>FullSaveAssociations</code> 模式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Session</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Session</span><span class=p>{</span><span class=nx>FullSaveAssociations</span><span class=p>:</span> <span class=kc>true</span><span class=p>}).</span><span class=nf>Updates</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO &#34;addresses&#34; (address1) VALUES (&#34;Billing Address - Address 1&#34;), (&#34;Shipping Address - Address 1&#34;) ON DUPLICATE KEY SET address1=VALUES(address1);
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO &#34;users&#34; (name,billing_address_id,shipping_address_id) VALUES (&#34;jinzhu&#34;, 1, 2);
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO &#34;emails&#34; (user_id,email) VALUES (111, &#34;jinzhu@example.com&#34;), (111, &#34;jinzhu-2@example.com&#34;) ON DUPLICATE KEY SET email=VALUES(email);
</span></span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span></code></pre></td></tr></table></div></div><h4 id=跳过自动创建更新>跳过自动创建、更新</h4><p>若要在创建、更新时跳过自动保存，您可以使用 <code>Select</code> 或 <code>Omit</code>，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>user</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span><span class=p>:</span>            <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>BillingAddress</span><span class=p>:</span>  <span class=nx>Address</span><span class=p>{</span><span class=nx>Address1</span><span class=p>:</span> <span class=s>&#34;Billing Address - Address 1&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>ShippingAddress</span><span class=p>:</span> <span class=nx>Address</span><span class=p>{</span><span class=nx>Address1</span><span class=p>:</span> <span class=s>&#34;Shipping Address - Address 1&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>Emails</span><span class=p>:</span>          <span class=p>[]</span><span class=nx>Email</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Email</span><span class=p>:</span> <span class=s>&#34;jinzhu@example.com&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Email</span><span class=p>:</span> <span class=s>&#34;jinzhu-2@example.com&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>Languages</span><span class=p>:</span>       <span class=p>[]</span><span class=nx>Language</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;ZH&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;EN&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;Name&#34;</span><span class=p>).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO &#34;users&#34; (name) VALUES (&#34;jinzhu&#34;, 1, 2);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Omit</span><span class=p>(</span><span class=s>&#34;BillingAddress&#34;</span><span class=p>).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// Skip create BillingAddress when creating a user
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Omit</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Associations</span><span class=p>).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// Skip all associations when creating a user
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>NOTE:</strong> 对于 many2many 关联，GORM 在创建连接表引用之前，会先 upsert 关联。如果你想跳过关联的 upsert，你可以这样做：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>db.Omit(&#34;Languages.*&#34;).Create(&amp;user)
</span></span></code></pre></td></tr></table></div></div><p>下面的代码将跳过创建关联及其引用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>db.Omit(&#34;Languages&#34;).Create(&amp;user)
</span></span></code></pre></td></tr></table></div></div></blockquote><h4 id=selectomit-关联字段>Select/Omit 关联字段</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>user</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span><span class=p>:</span>            <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>BillingAddress</span><span class=p>:</span>  <span class=nx>Address</span><span class=p>{</span><span class=nx>Address1</span><span class=p>:</span> <span class=s>&#34;Billing Address - Address 1&#34;</span><span class=p>,</span> <span class=nx>Address2</span><span class=p>:</span> <span class=s>&#34;addr2&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>ShippingAddress</span><span class=p>:</span> <span class=nx>Address</span><span class=p>{</span><span class=nx>Address1</span><span class=p>:</span> <span class=s>&#34;Shipping Address - Address 1&#34;</span><span class=p>,</span> <span class=nx>Address2</span><span class=p>:</span> <span class=s>&#34;addr2&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 创建 user 及其 BillingAddress、ShippingAddress
</span></span></span><span class=line><span class=cl><span class=c1>// 在创建 BillingAddress 时，仅使用其 address1、address2 字段，忽略其它字段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;BillingAddress.Address1&#34;</span><span class=p>,</span> <span class=s>&#34;BillingAddress.Address2&#34;</span><span class=p>).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Omit</span><span class=p>(</span><span class=s>&#34;BillingAddress.Address2&#34;</span><span class=p>,</span> <span class=s>&#34;BillingAddress.CreatedAt&#34;</span><span class=p>).</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=关联模式-1>关联模式</h4><p>关联模式包含一些在处理关系时有用的方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 开始关联模式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// `user` 是源模型，它的主键不能为空
</span></span></span><span class=line><span class=cl><span class=c1>// 关系的字段名是 `Languages`
</span></span></span><span class=line><span class=cl><span class=c1>// 如果匹配了上面两个要求，会开始关联模式，否则会返回错误
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nx>Error</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=查找关联>查找关联</h5><p>查找所有匹配的关联记录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>languages</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>查找带条件的关联</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>courses</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>c</span><span class=p>,</span><span class=w> </span><span class=n>selections</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>sc</span><span class=p>.</span><span class=n>student_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sc</span><span class=p>.</span><span class=n>co</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>codes</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;zh-CN&#34;</span><span class=p>,</span> <span class=s>&#34;en-US&#34;</span><span class=p>,</span> <span class=s>&#34;ja-JP&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;code IN ?&#34;</span><span class=p>,</span> <span class=nx>codes</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>languages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;code IN ?&#34;</span><span class=p>,</span> <span class=nx>codes</span><span class=p>).</span><span class=nf>Order</span><span class=p>(</span><span class=s>&#34;code desc&#34;</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>languages</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=添加关联>添加关联</h5><p>为 <code>many to many</code>、<code>has many</code> 添加新的关联；为 <code>has one</code>, <code>belongs to</code> 替换当前的关联</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>Append</span><span class=p>([]</span><span class=nx>Language</span><span class=p>{</span><span class=nx>languageZH</span><span class=p>,</span> <span class=nx>languageEN</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>Append</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Language</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;DE&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;CreditCard&#34;</span><span class=p>).</span><span class=nf>Append</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>CreditCard</span><span class=p>{</span><span class=nx>Number</span><span class=p>:</span> <span class=s>&#34;411111111111&#34;</span><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=替换关联>替换关联</h5><p>用一个新的关联替换当前的关联</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>Replace</span><span class=p>([]</span><span class=nx>Language</span><span class=p>{</span><span class=nx>languageZH</span><span class=p>,</span> <span class=nx>languageEN</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>Replace</span><span class=p>(</span><span class=nx>Language</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;DE&#34;</span><span class=p>},</span> <span class=nx>languageEN</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=删除关联>删除关联</h5><p>如果存在，则删除源模型与参数之间的关系，<strong>只会删除引用，不会从数据库中删除这些对象</strong>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>Delete</span><span class=p>([]</span><span class=nx>Language</span><span class=p>{</span><span class=nx>languageZH</span><span class=p>,</span> <span class=nx>languageEN</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>languageZH</span><span class=p>,</span> <span class=nx>languageEN</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=清空关联>清空关联</h5><p>删除源模型与关联之间的所有引用，但不会删除这些关联</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>Clear</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=关联计数>关联计数</h5><p>返回当前关联的计数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>Count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 条件计数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>codes</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;zh-CN&#34;</span><span class=p>,</span> <span class=s>&#34;en-US&#34;</span><span class=p>,</span> <span class=s>&#34;ja-JP&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;code IN ?&#34;</span><span class=p>,</span> <span class=nx>codes</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>Count</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=批量处理数据>批量处理数据</h5><p>关联模式也支持批量处理，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 查询所有用户的所有角色
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Role&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>roles</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 从所有 team 中删除 user A
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Team&#34;</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>userA</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取去重的用户所属 team 数量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Team&#34;</span><span class=p>).</span><span class=nf>Count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 对于批量数据的 `Append`、`Replace`，参数的长度必须与数据的长度相同，否则会返回 error
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>users</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>User</span><span class=p>{</span><span class=nx>user1</span><span class=p>,</span> <span class=nx>user2</span><span class=p>,</span> <span class=nx>user3</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 例如：现在有三个 user，Append userA 到 user1 的 team，Append userB 到 user2 的 team，Append userA、userB 和 userC 到 user3 的 team
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Team&#34;</span><span class=p>).</span><span class=nf>Append</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>userA</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>userB</span><span class=p>,</span> <span class=o>&amp;</span><span class=p>[]</span><span class=nx>User</span><span class=p>{</span><span class=nx>userA</span><span class=p>,</span> <span class=nx>userB</span><span class=p>,</span> <span class=nx>userC</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// 重置 user1 team 为 userA，重置 user2 的 team 为 userB，重置 user3 的 team 为 userA、 userB 和 userC
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Team&#34;</span><span class=p>).</span><span class=nf>Replace</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>userA</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>userB</span><span class=p>,</span> <span class=o>&amp;</span><span class=p>[]</span><span class=nx>User</span><span class=p>{</span><span class=nx>userA</span><span class=p>,</span> <span class=nx>userB</span><span class=p>,</span> <span class=nx>userC</span><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=带-select-的删除>带 Select 的删除</h4><p>你可以在删除记录时通过 <code>Select</code> 来删除具有 has one、has many、many2many 关系的记录，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 删除 user 时，也删除 user 的 account
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;Account&#34;</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 删除 user 时，也删除 user 的 Orders、CreditCards 记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;Orders&#34;</span><span class=p>,</span> <span class=s>&#34;CreditCards&#34;</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 删除 user 时，也删除用户所有 has one/many、many2many 记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Associations</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 删除 users 时，也删除每一个 user 的 account
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;Account&#34;</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意：</strong> 只有当记录的主键不为空时，关联才会被删除，GORM 会使用这些主键作为条件来删除关联记录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// DOESN&#39;T WORK
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;Account&#34;</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// 会删除所有 name=`jinzhu` 的 user，但这些 user 的 account 不会被删除
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;Account&#34;</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=mi>1</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// 会删除 name = `jinzhu` 且 id = `1` 的 user，并且 user `1` 的 account 也会被删除
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;Account&#34;</span><span class=p>).</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=mi>1</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// 会删除 id = `1` 的 user，并且 user `1` 的 account 也会被删除
</span></span></span></code></pre></td></tr></table></div></div></blockquote><h4 id=关联标签-1>关联标签</h4><table><thead><tr><th style=text-align:left>标签</th><th style=text-align:left>描述</th></tr></thead><tbody><tr><td style=text-align:left>foreignKey</td><td style=text-align:left>指定当前模型的列作为连接表的外键</td></tr><tr><td style=text-align:left>references</td><td style=text-align:left>指定引用表的列名，其将被映射为连接表外键</td></tr><tr><td style=text-align:left>polymorphic</td><td style=text-align:left>指定多态类型，比如模型名</td></tr><tr><td style=text-align:left>polymorphicValue</td><td style=text-align:left>指定多态值、默认表名</td></tr><tr><td style=text-align:left>many2many</td><td style=text-align:left>指定连接表表名</td></tr><tr><td style=text-align:left>joinForeignKey</td><td style=text-align:left>指定连接表的外键列名，其将被映射到当前表</td></tr><tr><td style=text-align:left>joinReferences</td><td style=text-align:left>指定连接表的外键列名，其将被映射到引用表</td></tr><tr><td style=text-align:left>constraint</td><td style=text-align:left>关系约束，例如：<code>OnUpdate</code>、<code>OnDelete</code></td></tr></tbody></table><h3 id=预加载>预加载</h3><p>GORM 允许在 <code>Preload</code> 的其它 SQL 中直接加载关系，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Username</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Orders</span>   <span class=p>[]</span><span class=nx>Order</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Order</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>UserID</span> <span class=kt>uint</span>
</span></span><span class=line><span class=cl>  <span class=nx>Price</span>  <span class=kt>float64</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 查找 user 时预加载相关 Order
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Preload</span><span class=p>(</span><span class=s>&#34;Orders&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users;
</span></span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM orders WHERE user_id IN (1,2,3,4);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Preload</span><span class=p>(</span><span class=s>&#34;Orders&#34;</span><span class=p>).</span><span class=nf>Preload</span><span class=p>(</span><span class=s>&#34;Profile&#34;</span><span class=p>).</span><span class=nf>Preload</span><span class=p>(</span><span class=s>&#34;Role&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users;
</span></span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM orders WHERE user_id IN (1,2,3,4); // has many
</span></span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM profiles WHERE user_id IN (1,2,3,4); // has one
</span></span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM roles WHERE id IN (4,5,6); // belongs to
</span></span></span></code></pre></td></tr></table></div></div><h4 id=joins-预加载-1>Joins 预加载</h4><p><code>Preload</code> 在一个单独查询中加载关联数据。而 <code>Join Preload</code> 会使用 inner join 加载关联数据，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;Company&#34;</span><span class=p>).</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;Manager&#34;</span><span class=p>).</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;Account&#34;</span><span class=p>).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;Company&#34;</span><span class=p>).</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;Manager&#34;</span><span class=p>).</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;Account&#34;</span><span class=p>).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span> <span class=s>&#34;users.name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;Company&#34;</span><span class=p>).</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;Manager&#34;</span><span class=p>).</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;Account&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>,</span> <span class=s>&#34;users.id IN ?&#34;</span><span class=p>,</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>5</span><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>带条件的 Join</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Joins</span><span class=p>(</span><span class=s>&#34;Company&#34;</span><span class=p>,</span> <span class=nx>DB</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Company</span><span class=p>{</span><span class=nx>Alive</span><span class=p>:</span> <span class=kc>true</span><span class=p>})).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT `users`.`id`,`users`.`name`,`users`.`age`,`Company`.`id` AS `Company__id`,`Company`.`name` AS `Company__name` FROM `users` LEFT JOIN `companies` AS `Company` ON `users`.`company_id` = `Company`.`id` AND `Company`.`alive` = true;
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong> <code>Join Preload</code> 适用于<strong>一对一</strong>的关系，例如： <code>has one</code>, <code>belongs to</code></p></blockquote><h4 id=预加载全部>预加载全部</h4><p>与创建、更新时使用 <code>Select</code> 类似，<code>clause.Associations</code> 也可以和 <code>Preload</code> 一起使用，它可以用来 <code>预加载</code> 全部关联，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>       <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>CompanyID</span>  <span class=kt>uint</span>
</span></span><span class=line><span class=cl>  <span class=nx>Company</span>    <span class=nx>Company</span>
</span></span><span class=line><span class=cl>  <span class=nx>Role</span>       <span class=nx>Role</span>
</span></span><span class=line><span class=cl>  <span class=nx>Orders</span>     <span class=p>[]</span><span class=nx>Order</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Preload</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Associations</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>clause.Associations</code> <strong>不会预加载嵌套的关联</strong>，但你可以使用<a href=https://gorm.io/zh_CN/docs/preload.html#nested_preloading target=_blank rel="external nofollow noopener noreferrer">嵌套预加载</a> 例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Preload</span><span class=p>(</span><span class=s>&#34;Orders.OrderItems.Product&#34;</span><span class=p>).</span><span class=nf>Preload</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Associations</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=带条件的预加载>带条件的预加载</h4><p>GORM 允许带条件的 Preload 关联，类似于<a href=https://gorm.io/zh_CN/docs/query.html#inline_conditions target=_blank rel="external nofollow noopener noreferrer">内联条件</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 带条件的预加载 Order
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Preload</span><span class=p>(</span><span class=s>&#34;Orders&#34;</span><span class=p>,</span> <span class=s>&#34;state NOT IN (?)&#34;</span><span class=p>,</span> <span class=s>&#34;cancelled&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users;
</span></span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM orders WHERE user_id IN (1,2,3,4) AND state NOT IN (&#39;cancelled&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;state = ?&#34;</span><span class=p>,</span> <span class=s>&#34;active&#34;</span><span class=p>).</span><span class=nf>Preload</span><span class=p>(</span><span class=s>&#34;Orders&#34;</span><span class=p>,</span> <span class=s>&#34;state NOT IN (?)&#34;</span><span class=p>,</span> <span class=s>&#34;cancelled&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE state = &#39;active&#39;;
</span></span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM orders WHERE user_id IN (1,2) AND state NOT IN (&#39;cancelled&#39;);
</span></span></span></code></pre></td></tr></table></div></div><h4 id=自定义预加载-sql>自定义预加载 SQL</h4><p>您可以通过 <code>func(db *gorm.DB) *gorm.DB</code> 实现自定义预加载 SQL，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Preload</span><span class=p>(</span><span class=s>&#34;Orders&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Order</span><span class=p>(</span><span class=s>&#34;orders.amount DESC&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users;
</span></span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM orders WHERE user_id IN (1,2,3,4) order by orders.amount DESC;
</span></span></span></code></pre></td></tr></table></div></div><h4 id=嵌套预加载>嵌套预加载</h4><p>GORM 支持嵌套预加载，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Preload</span><span class=p>(</span><span class=s>&#34;Orders.OrderItems.Product&#34;</span><span class=p>).</span><span class=nf>Preload</span><span class=p>(</span><span class=s>&#34;CreditCard&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 自定义预加载 `Orders` 的条件
</span></span></span><span class=line><span class=cl><span class=c1>// 这样，GORM 就不会加载不匹配的 order 记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Preload</span><span class=p>(</span><span class=s>&#34;Orders&#34;</span><span class=p>,</span> <span class=s>&#34;state = ?&#34;</span><span class=p>,</span> <span class=s>&#34;paid&#34;</span><span class=p>).</span><span class=nf>Preload</span><span class=p>(</span><span class=s>&#34;Orders.OrderItems&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=高级查询>高级查询</h2><h3 id=智能选择字段>智能选择字段</h3><p>GORM 允许通过 <a href=https://gorm.io/zh_CN/docs/query.html target=_blank rel="external nofollow noopener noreferrer"><code>Select</code></a> 方法选择特定的字段，如果您在应用程序中经常使用此功能，你也可以定义一个较小的结构体，以实现调用 API 时自动选择特定的字段，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>     <span class=kt>uint</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Age</span>    <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Gender</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 假设后面还有几百个字段...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>APIUser</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>   <span class=kt>uint</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 查询时会自动选择 `id`, `name` 字段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Limit</span><span class=p>(</span><span class=mi>10</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>APIUser</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT `id`, `name` FROM `users` LIMIT 10
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong> <code>QueryFields</code> 模式会根据当前 model 的所有字段名称进行 select。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>sqlite</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;gorm.db&#34;</span><span class=p>),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>QueryFields</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT `users`.`name`, `users`.`age`, ... FROM `users` // 带上这个选项
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Session Mode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Session</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Session</span><span class=p>{</span><span class=nx>QueryFields</span><span class=p>:</span> <span class=kc>true</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT `users`.`name`, `users`.`age`, ... FROM `users`
</span></span></span></code></pre></td></tr></table></div></div><h3 id=locking-for-update>Locking (FOR UPDATE)</h3><p>GORM 支持多种类型的锁，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Locking</span><span class=p>{</span><span class=nx>Strength</span><span class=p>:</span> <span class=s>&#34;UPDATE&#34;</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM `users` FOR UPDATE
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Locking</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Strength</span><span class=p>:</span> <span class=s>&#34;SHARE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Table</span><span class=p>:</span> <span class=nx>clause</span><span class=p>.</span><span class=nx>Table</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>clause</span><span class=p>.</span><span class=nx>CurrentTable</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM `users` FOR SHARE OF `users`
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>clause</span><span class=p>.</span><span class=nx>Locking</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Strength</span><span class=p>:</span> <span class=s>&#34;UPDATE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Options</span><span class=p>:</span> <span class=s>&#34;NOWAIT&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM `users` FOR UPDATE NOWAIT
</span></span></span></code></pre></td></tr></table></div></div><p>查看 <a href=https://gorm.io/zh_CN/docs/sql_builder.html target=_blank rel="external nofollow noopener noreferrer">原生 SQL 及构造器</a> 获取详情</p><h3 id=子查询>子查询</h3><p>子查询可以嵌套在查询中，GORM 允许在使用 <code>*gorm.DB</code> 对象作为参数时生成子查询</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;amount &gt; (?)&#34;</span><span class=p>,</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;orders&#34;</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;AVG(amount)&#34;</span><span class=p>)).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>orders</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM &#34;orders&#34; WHERE amount &gt; (SELECT AVG(amount) FROM &#34;orders&#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>subQuery</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;AVG(age)&#34;</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name LIKE ?&#34;</span><span class=p>,</span> <span class=s>&#34;name%&#34;</span><span class=p>).</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;AVG(age) as avgage&#34;</span><span class=p>).</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>).</span><span class=nf>Having</span><span class=p>(</span><span class=s>&#34;AVG(age) &gt; (?)&#34;</span><span class=p>,</span> <span class=nx>subQuery</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT AVG(age) as avgage FROM `users` GROUP BY `name` HAVING AVG(age) &gt; (SELECT AVG(age) FROM `users` WHERE name LIKE &#34;name%&#34;)
</span></span></span></code></pre></td></tr></table></div></div><h3 id=from-子查询>From 子查询</h3><p>GORM 允许您在 <code>Table</code> 方法中通过 FROM 子句使用子查询，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;(?) as u&#34;</span><span class=p>,</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>)).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;age = ?&#34;</span><span class=p>,</span> <span class=mi>18</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM (SELECT `name`,`age` FROM `users`) as u WHERE `age` = 18
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>subQuery1</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>subQuery2</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Pet</span><span class=p>{}).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;(?) as u, (?) as p&#34;</span><span class=p>,</span> <span class=nx>subQuery1</span><span class=p>,</span> <span class=nx>subQuery2</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM (SELECT `name` FROM `users`) as u, (SELECT `name` FROM `pets`) as p
</span></span></span></code></pre></td></tr></table></div></div><h3 id=group-条件>Group 条件</h3><p>使用 Group 条件可以更轻松的编写复杂 SQL</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;pizza = ?&#34;</span><span class=p>,</span> <span class=s>&#34;pepperoni&#34;</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;size = ?&#34;</span><span class=p>,</span> <span class=s>&#34;small&#34;</span><span class=p>).</span><span class=nf>Or</span><span class=p>(</span><span class=s>&#34;size = ?&#34;</span><span class=p>,</span> <span class=s>&#34;medium&#34;</span><span class=p>)),</span>
</span></span><span class=line><span class=cl><span class=p>).</span><span class=nf>Or</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;pizza = ?&#34;</span><span class=p>,</span> <span class=s>&#34;hawaiian&#34;</span><span class=p>).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;size = ?&#34;</span><span class=p>,</span> <span class=s>&#34;xlarge&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Pizza</span><span class=p>{}).</span><span class=nx>Statement</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM `pizzas` WHERE (pizza = &#34;pepperoni&#34; AND (size = &#34;small&#34; OR size = &#34;medium&#34;)) OR (pizza = &#34;hawaiian&#34; AND size = &#34;xlarge&#34;)
</span></span></span></code></pre></td></tr></table></div></div><h3 id=带多个列的-in>带多个列的 in</h3><p>带多个列的 in 查询</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;(name, age, role) IN ?&#34;</span><span class=p>,</span> <span class=p>[][]</span><span class=kd>interface</span><span class=p>{}{{</span><span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=mi>18</span><span class=p>,</span> <span class=s>&#34;admin&#34;</span><span class=p>},</span> <span class=p>{</span><span class=s>&#34;jinzhu2&#34;</span><span class=p>,</span> <span class=mi>19</span><span class=p>,</span> <span class=s>&#34;user&#34;</span><span class=p>}}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE (name, age, role) IN ((&#34;jinzhu&#34;, 18, &#34;admin&#34;), (&#34;jinzhu 2&#34;, 19, &#34;user&#34;));
</span></span></span></code></pre></td></tr></table></div></div><h3 id=命名参数>命名参数</h3><p>GORM 支持 <a href=https://tip.golang.org/pkg/database/sql/#NamedArg target=_blank rel="external nofollow noopener noreferrer"><code>sql.NamedArg</code></a> 和 <code>map[string]interface{}{}</code> 形式的命名参数，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name1 = @name OR name2 = @name&#34;</span><span class=p>,</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Named</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>)).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM `users` WHERE name1 = &#34;jinzhu&#34; OR name2 = &#34;jinzhu&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name1 = @name OR name2 = @name&#34;</span><span class=p>,</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>}).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM `users` WHERE name1 = &#34;jinzhu&#34; OR name2 = &#34;jinzhu&#34; ORDER BY `users`.`id` LIMIT 1
</span></span></span></code></pre></td></tr></table></div></div><p>查看 <a href=https://gorm.io/zh_CN/docs/sql_builder.html#named_argument target=_blank rel="external nofollow noopener noreferrer">原生 SQL 及构造器</a> 获取详情</p><h3 id=find-至-map>Find 至 map</h3><p>GORM 允许扫描结果至 <code>map[string]interface{}</code> 或 <code>[]map[string]interface{}</code>，此时别忘了指定 <code>Model</code> 或 <code>Table</code>，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>result</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{}</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>result</span><span class=p>,</span> <span class=s>&#34;id = ?&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>results</span> <span class=p>[]</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;users&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>results</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=firstorinit>FirstOrInit</h3><p>获取第一条匹配的记录，或者根据给定的条件初始化一个实例（仅支持 sturct 和 map 条件）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 未找到 user，则根据给定的条件初始化一条记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>FirstOrInit</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span> <span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;non_existing&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// user -&gt; User{Name: &#34;non_existing&#34;}
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 找到了 `name` = `jinzhu` 的 user
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>}).</span><span class=nf>FirstOrInit</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// user -&gt; User{ID: 111, Name: &#34;Jinzhu&#34;, Age: 18}
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 找到了 `name` = `jinzhu` 的 user
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>FirstOrInit</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// user -&gt; User{ID: 111, Name: &#34;Jinzhu&#34;, Age: 18}
</span></span></span></code></pre></td></tr></table></div></div><p>如果没有找到记录，可以使用包含更多的属性的结构体初始化 user，<code>Attrs</code> 不会被用于生成查询 SQL</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 未找到 user，则根据给定的条件以及 Attrs 初始化 user
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;non_existing&#34;</span><span class=p>}).</span><span class=nf>Attrs</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Age</span><span class=p>:</span> <span class=mi>20</span><span class=p>}).</span><span class=nf>FirstOrInit</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM USERS WHERE name = &#39;non_existing&#39; ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1>// user -&gt; User{Name: &#34;non_existing&#34;, Age: 20}
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 未找到 user，则根据给定的条件以及 Attrs 初始化 user
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;non_existing&#34;</span><span class=p>}).</span><span class=nf>Attrs</span><span class=p>(</span><span class=s>&#34;age&#34;</span><span class=p>,</span> <span class=mi>20</span><span class=p>).</span><span class=nf>FirstOrInit</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM USERS WHERE name = &#39;non_existing&#39; ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1>// user -&gt; User{Name: &#34;non_existing&#34;, Age: 20}
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 找到了 `name` = `jinzhu` 的 user，则忽略 Attrs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;Jinzhu&#34;</span><span class=p>}).</span><span class=nf>Attrs</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Age</span><span class=p>:</span> <span class=mi>20</span><span class=p>}).</span><span class=nf>FirstOrInit</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM USERS WHERE name = jinzhu&#39; ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1>// user -&gt; User{ID: 111, Name: &#34;Jinzhu&#34;, Age: 18}
</span></span></span></code></pre></td></tr></table></div></div><p>不管是否找到记录，<code>Assign</code> 都会将属性赋值给 struct，但这些属性不会被用于生成查询 SQL，也不会被保存到数据库</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 未找到 user，根据条件和 Assign 属性初始化 struct
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;non_existing&#34;</span><span class=p>}).</span><span class=nf>Assign</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Age</span><span class=p>:</span> <span class=mi>20</span><span class=p>}).</span><span class=nf>FirstOrInit</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// user -&gt; User{Name: &#34;non_existing&#34;, Age: 20}
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 找到 `name` = `jinzhu` 的记录，依然会更新 Assign 相关的属性
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;Jinzhu&#34;</span><span class=p>}).</span><span class=nf>Assign</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Age</span><span class=p>:</span> <span class=mi>20</span><span class=p>}).</span><span class=nf>FirstOrInit</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM USERS WHERE name = jinzhu&#39; ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1>// user -&gt; User{ID: 111, Name: &#34;Jinzhu&#34;, Age: 20}
</span></span></span></code></pre></td></tr></table></div></div><h3 id=firstorcreate>FirstOrCreate</h3><p>获取第一条匹配的记录，或者根据给定的条件创建一条新纪录（仅支持 sturct 和 map 条件）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 未找到 user，则根据给定条件创建一条新纪录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>FirstOrCreate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span> <span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;non_existing&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO &#34;users&#34; (name) VALUES (&#34;non_existing&#34;);
</span></span></span><span class=line><span class=cl><span class=c1>// user -&gt; User{ID: 112, Name: &#34;non_existing&#34;}
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 找到了 `name` = `jinzhu` 的 user
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>}).</span><span class=nf>FirstOrCreate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// user -&gt; User{ID: 111, Name: &#34;jinzhu&#34;, &#34;Age&#34;: 18}
</span></span></span></code></pre></td></tr></table></div></div><p>如果没有找到记录，可以使用包含更多的属性的结构体创建记录，<code>Attrs</code> 不会被用于生成查询 SQL 。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 未找到 user，根据条件和 Assign 属性创建记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;non_existing&#34;</span><span class=p>}).</span><span class=nf>Attrs</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Age</span><span class=p>:</span> <span class=mi>20</span><span class=p>}).</span><span class=nf>FirstOrCreate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#39;non_existing&#39; ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO &#34;users&#34; (name, age) VALUES (&#34;non_existing&#34;, 20);
</span></span></span><span class=line><span class=cl><span class=c1>// user -&gt; User{ID: 112, Name: &#34;non_existing&#34;, Age: 20}
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 找到了 `name` = `jinzhu` 的 user，则忽略 Attrs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>}).</span><span class=nf>Attrs</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Age</span><span class=p>:</span> <span class=mi>20</span><span class=p>}).</span><span class=nf>FirstOrCreate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#39;jinzhu&#39; ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1>// user -&gt; User{ID: 111, Name: &#34;jinzhu&#34;, Age: 18}
</span></span></span></code></pre></td></tr></table></div></div><p>不管是否找到记录，<code>Assign</code> 都会将属性赋值给 struct，并将结果写回数据库</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 未找到 user，根据条件和 Assign 属性创建记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;non_existing&#34;</span><span class=p>}).</span><span class=nf>Assign</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Age</span><span class=p>:</span> <span class=mi>20</span><span class=p>}).</span><span class=nf>FirstOrCreate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#39;non_existing&#39; ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO &#34;users&#34; (name, age) VALUES (&#34;non_existing&#34;, 20);
</span></span></span><span class=line><span class=cl><span class=c1>// user -&gt; User{ID: 112, Name: &#34;non_existing&#34;, Age: 20}
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 找到了 `name` = `jinzhu` 的 user，依然会根据 Assign 更新记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>}).</span><span class=nf>Assign</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Age</span><span class=p>:</span> <span class=mi>20</span><span class=p>}).</span><span class=nf>FirstOrCreate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#39;jinzhu&#39; ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET age=20 WHERE id = 111;
</span></span></span><span class=line><span class=cl><span class=c1>// user -&gt; User{ID: 111, Name: &#34;jinzhu&#34;, Age: 20}
</span></span></span></code></pre></td></tr></table></div></div><h3 id=优化器索引提示>优化器、索引提示</h3><p><strong>优化器提示</strong>用于控制查询优化器选择某个查询执行计划，GORM 通过 <code>gorm.io/hints</code> 提供支持，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;gorm.io/hints&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>hints</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;MAX_EXECUTION_TIME(10000)&#34;</span><span class=p>)).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * /*+ MAX_EXECUTION_TIME(10000) */ FROM `users`
</span></span></span></code></pre></td></tr></table></div></div><p><strong>索引提示</strong>允许传递索引提示到数据库，以防查询计划器出现混乱。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;gorm.io/hints&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>hints</span><span class=p>.</span><span class=nf>UseIndex</span><span class=p>(</span><span class=s>&#34;idx_user_name&#34;</span><span class=p>)).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM `users` USE INDEX (`idx_user_name`)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Clauses</span><span class=p>(</span><span class=nx>hints</span><span class=p>.</span><span class=nf>ForceIndex</span><span class=p>(</span><span class=s>&#34;idx_user_name&#34;</span><span class=p>,</span> <span class=s>&#34;idx_user_id&#34;</span><span class=p>).</span><span class=nf>ForJoin</span><span class=p>()).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM `users` FORCE INDEX FOR JOIN (`idx_user_name`,`idx_user_id`)&#34;
</span></span></span></code></pre></td></tr></table></div></div><p>参考 <a href=https://gorm.io/zh_CN/docs/hints.html target=_blank rel="external nofollow noopener noreferrer">优化器提示、索引、备注</a> 获取详情</p><h3 id=迭代>迭代</h3><p>GORM 支持通过行进行迭代</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nf>Rows</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>defer</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ScanRows 方法用于将一行记录扫描至结构体
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>db</span><span class=p>.</span><span class=nf>ScanRows</span><span class=p>(</span><span class=nx>rows</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 业务逻辑...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=findinbatches>FindInBatches</h3><p>用于批量查询并处理记录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 每次批量处理 100 条
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;processed = ?&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>).</span><span class=nf>FindInBatches</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>results</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>,</span> <span class=nx>batch</span> <span class=kt>int</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>result</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>results</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 批量处理找到的记录
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>tx</span><span class=p>.</span><span class=nf>Save</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>tx</span><span class=p>.</span><span class=nx>RowsAffected</span> <span class=c1>// 本次批量操作影响的记录数
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>batch</span> <span class=c1>// Batch 1, 2, 3
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果返回错误会终止后续批量操作
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>result</span><span class=p>.</span><span class=nx>Error</span> <span class=c1>// returned error
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span><span class=p>.</span><span class=nx>RowsAffected</span> <span class=c1>// 整个批量操作影响的记录数
</span></span></span></code></pre></td></tr></table></div></div><h3 id=查询钩子>查询钩子</h3><p>对于查询操作，GORM 支持 <code>AfterFind</code> 钩子，查询记录后会调用它，详情请参考 <a href=https://gorm.io/zh_CN/docs/hooks.html target=_blank rel="external nofollow noopener noreferrer">钩子</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>AfterFind</span><span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Role</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>u</span><span class=p>.</span><span class=nx>Role</span> <span class=p>=</span> <span class=s>&#34;user&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=pluck>Pluck</h3><p>Pluck 用于从数据库查询单个列，并将结果扫描到切片。如果您想要查询多列，您应该使用 <code>Select</code> 和 <a href=https://gorm.io/zh_CN/docs/query.html#scan target=_blank rel="external nofollow noopener noreferrer"><code>Scan</code></a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ages</span> <span class=p>[]</span><span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>).</span><span class=nf>Pluck</span><span class=p>(</span><span class=s>&#34;age&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>ages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>names</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Pluck</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>names</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;deleted_users&#34;</span><span class=p>).</span><span class=nf>Pluck</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>names</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Distinct Pluck
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Distinct</span><span class=p>().</span><span class=nf>Pluck</span><span class=p>(</span><span class=s>&#34;Name&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>names</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT DISTINCT `name` FROM `users`
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 超过一列的查询，应该使用 `Scan` 或者 `Find`，例如：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=scope>Scope</h3><p><code>Scopes</code> 允许你指定常用的查询，可以在调用方法时引用这些查询</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>AmountGreaterThan1000</span><span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;amount &gt; ?&#34;</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>PaidWithCreditCard</span><span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;pay_mode_sign = ?&#34;</span><span class=p>,</span> <span class=s>&#34;C&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>PaidWithCod</span><span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;pay_mode_sign = ?&#34;</span><span class=p>,</span> <span class=s>&#34;C&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>OrderStatus</span><span class=p>(</span><span class=nx>status</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;status IN (?)&#34;</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Scopes</span><span class=p>(</span><span class=nx>AmountGreaterThan1000</span><span class=p>,</span> <span class=nx>PaidWithCreditCard</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>orders</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 查找所有金额大于 1000 的信用卡订单
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Scopes</span><span class=p>(</span><span class=nx>AmountGreaterThan1000</span><span class=p>,</span> <span class=nx>PaidWithCod</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>orders</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 查找所有金额大于 1000 的货到付款订单
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Scopes</span><span class=p>(</span><span class=nx>AmountGreaterThan1000</span><span class=p>,</span> <span class=nf>OrderStatus</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;paid&#34;</span><span class=p>,</span> <span class=s>&#34;shipped&#34;</span><span class=p>})).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>orders</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 查找所有金额大于 1000 且已付款或已发货的订单
</span></span></span></code></pre></td></tr></table></div></div><p>查看 <a href=https://gorm.io/zh_CN/docs/scopes.html target=_blank rel="external nofollow noopener noreferrer">Scopes</a> 获取详情</p><h3 id=count>Count</h3><p>Count 用于获取匹配的记录数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>count</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nf>Or</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu 2&#34;</span><span class=p>).</span><span class=nf>Count</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT count(1) FROM users WHERE name = &#39;jinzhu&#39; OR name = &#39;jinzhu 2&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nf>Count</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT count(1) FROM users WHERE name = &#39;jinzhu&#39;; (count)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;deleted_users&#34;</span><span class=p>).</span><span class=nf>Count</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT count(1) FROM deleted_users;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Count with Distinct
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Distinct</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>).</span><span class=nf>Count</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT COUNT(DISTINCT(`name`)) FROM `users`
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Table</span><span class=p>(</span><span class=s>&#34;deleted_users&#34;</span><span class=p>).</span><span class=nf>Select</span><span class=p>(</span><span class=s>&#34;count(distinct(name))&#34;</span><span class=p>).</span><span class=nf>Count</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT count(distinct(name)) FROM deleted_users
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Count with Group
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>users</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;name1&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;name2&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;name3&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;name3&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=c1>// data in sql
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>).</span><span class=nf>Count</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>count</span> <span class=c1>// =&gt; 3
</span></span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2023-06-14 10:56:53">更新于 2023-06-14</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://trouvaille0198.github.io/Notes/posts/golang/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/gorm/ data-title="Go GORM 库" data-hashtags=数据库,后端><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://trouvaille0198.github.io/Notes/posts/golang/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/gorm/ data-hashtag=数据库><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://trouvaille0198.github.io/Notes/posts/golang/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/gorm/ data-title="Go GORM 库"><i class="fa-brands fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href=/Notes/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>数据库</a>,&nbsp;<a href=/Notes/tags/%E5%90%8E%E7%AB%AF/>后端</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/Notes/>主页</a></span></section></div><div class=post-nav><a href=/Notes/posts/useful/%E9%85%8D%E7%BD%AE-wsl/ class=prev rel=prev title="配置 WSL"><i class="fa-solid fa-angle-left fa-fw"></i>配置 WSL</a>
<a href=/Notes/posts/golang/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/go-redis/ class=next rel=next title="Go go-redis 库">Go go-redis 库<i class="fa-solid fa-angle-right fa-fw"></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line custom">酒困路长惟欲睡，日高人渴漫思茶</div><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2022 - 2023</span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><div id=mask></div></div><link rel=stylesheet href=/Notes/lib/katex/katex.min.css><link rel=stylesheet href=/Notes/lib/katex/copy-tex.min.css><link rel=stylesheet href=/Notes/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/Notes/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/Notes/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script type=text/javascript src=/Notes/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/Notes/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/Notes/lib/katex/katex.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/Notes/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:45},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"7I9AMOLA4S",algoliaIndex:"Notes",algoliaSearchKey:"3c1638dfe9f4d49a59d81ff6943416b8",highlightTag:"em",maxResultLength:30,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/Notes/js/theme.min.js defer></script><script type=text/javascript src=/Notes/js/_custom.min.js defer></script></body></html>