<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Go sql 标准库 - 伤心肠粉的酱油碟子</title><meta name=Description content><meta property="og:title" content="Go sql 标准库"><meta property="og:description" content="database Go 使用 SQL 与类 SQL 数据库的惯例是通过标准库 database/sql。这是一个对关系"><meta property="og:type" content="article"><meta property="og:url" content="https://trouvaille0198.github.io/Notes/posts/golang/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/sql/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-31T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-11T14:08:15+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go sql 标准库"><meta name=twitter:description content="database Go 使用 SQL 与类 SQL 数据库的惯例是通过标准库 database/sql。这是一个对关系"><meta name=application-name content="伤心肠粉的酱油碟子"><meta name=apple-mobile-web-app-title content="伤心肠粉的酱油碟子"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://trouvaille0198.github.io/Notes/posts/golang/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/sql/><link rel=prev href=https://trouvaille0198.github.io/Notes/posts/courses/%E5%AE%9E%E7%94%A8%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%8B%B1%E8%AF%AD/><link rel=next href=https://trouvaille0198.github.io/Notes/posts/golang/%E6%A0%87%E5%87%86%E5%BA%93/io/ioutil/><link rel=stylesheet href=/Notes/lib/normalize/normalize.min.css><link rel=stylesheet href=/Notes/css/style.min.css><link rel=stylesheet href=/Notes/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/Notes/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Go sql 标准库","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/golang\/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C\/sql\/"},"genre":"posts","keywords":"数据库","wordcount":9455,"url":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/golang\/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C\/sql\/","datePublished":"2021-12-31T00:00:00+00:00","dateModified":"2022-03-11T14:08:15+00:00","publisher":{"@type":"Organization","name":"MelonCholi"},"author":{"@type":"Person","name":"MelonCholi"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":''==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:''==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子>伤心肠粉</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/Notes/categories/>分类 </a><a class=menu-item href=/Notes/tags/>标签 </a><a class=menu-item href=/Notes/posts/>文章 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子>伤心肠粉</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/Notes/categories/ title>分类</a><a class=menu-item href=/Notes/tags/ title>标签</a><a class=menu-item href=/Notes/posts/ title>文章</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Go sql 标准库</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/Notes/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>MelonCholi</a></span>&nbsp;<span class=post-category>收录于 <a href=/Notes/categories/golang/><i class="far fa-folder fa-fw"></i>Golang</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-12-31>2021-12-31</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 9455 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 19 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#快速开始>快速开始</a><ul><li><a href=#导入驱动>导入驱动</a></li><li><a href=#建立连接池>建立连接池</a></li><li><a href=#查询>查询</a></li><li><a href=#结果集>结果集</a></li><li><a href=#事务>事务</a></li><li><a href=#错误处理>错误处理</a></li><li><a href=#标准库-sql-不支持但常用的特性>标准库 sql 不支持但常用的特性</a></li><li><a href=#处理空值>处理空值</a></li><li><a href=#处理动态列>处理动态列</a></li></ul></li><li><a href=#databasesql>database/sql</a><ul><li><a href=#type-db>type DB</a><ul><li><a href=#func-open>func Open</a></li><li><a href=#func-db-ping>func (*DB) Ping</a></li><li><a href=#func-db-close>func (*DB) Close</a></li><li><a href=#func-db-driver>func (*DB) Driver</a></li><li><a href=#func-db-exec>func (*DB) Exec</a></li><li><a href=#func-db-query>func (*DB) Query</a></li><li><a href=#func-db-queryrow>func (*DB) QueryRow</a></li><li><a href=#func-db-prepare>func (*DB) Prepare</a></li><li><a href=#func-db-begin>func (*DB) Begin</a></li><li><a href=#例>例</a></li><li><a href=#func-db-setmaxopenconns>func (*DB) SetMaxOpenConns</a></li><li><a href=#func-db-setmaxidleconns>func (*DB) SetMaxIdleConns</a></li></ul></li><li><a href=#type-result>type Result</a></li><li><a href=#type-row>type Row</a><ul><li><a href=#func-row-scan>func (*Row) Scan</a></li></ul></li><li><a href=#type-rows>type Rows</a><ul><li><a href=#func-rows-columns>func (*Rows) Columns</a></li><li><a href=#func-rows-scan>func (*Rows) Scan</a></li><li><a href=#func-rows-next>func (*Rows) Next</a></li><li><a href=#func-rows-close>func (*Rows) Close</a></li><li><a href=#func-rows-err>func (*Rows) Err</a></li></ul></li><li><a href=#type-stmt>type Stmt</a></li><li><a href=#type-tx>type Tx</a><ul><li><a href=#事务中的多条语句>事务中的多条语句</a></li><li><a href=#func-tx-prepare>func (*Tx) Prepare</a></li><li><a href=#func-tx-stmt>func (*Tx) Stmt</a></li><li><a href=#func-tx-commit>func (*Tx) Commit</a></li><li><a href=#func-tx-rollback>func (*Tx) Rollback</a></li></ul></li></ul></li><li><a href=#databasesqldriver>database/sql/driver</a><ul><li><a href=#driverdriver>driver.Driver</a></li><li><a href=#driverconn>driver.Conn</a></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=database>database</h1><p>Go 使用 SQL 与类 SQL 数据库的惯例是通过标准库 <a href=http://golang.org/pkg/database/sql/ target=_blank rel="noopener noreffer">database/sql</a>。这是一个对关系型数据库的通用抽象，它提供了标准的、轻量的、面向行的接口</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=s>&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;user:password@tcp(127.0.0.1:3306)/hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Ping</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	     <span class=c1>// do something here
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=快速开始>快速开始</h2><p>在 Go 中访问数据库需要用到 <code>sql.DB</code> 接口：它可以创建语句 (statement) 和事务 (transaction)，执行查询，获取结果。</p><p><code>sql.DB</code> 并不是数据库连接，也并未在概念上映射到特定的数据库 (Database) 或模式 (schema)。它只是一个抽象的接口，不同的具体驱动有着不同的实现方式。</p><p>通常而言，<code>sql.DB</code> 会处理一些重要而麻烦的事情，例如操作具体的驱动打开/关闭实际底层数据库的连接，按需管理连接池。</p><p><code>sql.DB</code> 这一抽象让用户不必考虑如何管理并发访问底层数据库的问题。当一个连接在执行任务时会被标记为正在使用。用完之后会放回连接池中。不过用户如果用完连接后忘记释放，就会产生大量的连接，极可能导致资源耗尽</p><h3 id=导入驱动>导入驱动</h3><p>Mysql：&ldquo;github.com/go-sql-driver/mysql&rdquo;</p><p>sqlite：&ldquo;github.com/mattn/go-sqlite3&rdquo;</p><h3 id=建立连接池>建立连接池</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;user:password@tcp(127.0.0.1:3306)/hello&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>sql.DB</code> 刚开始建立时是懒加载的，不会自动创建新的连接，只有使用 <code>Ping()</code> 或者运行查询时才会自动生成一个新的连接然后去连接数据库，只有这个时候才能确定数据库是否真的OK，所以建议<strong>一定要在 <code>sql.Open</code> 后运行 <code>Ping()</code> 确定数据连接正常运行</strong>。</p><p><code>sql.DB</code> 是连接后初始化的一个连接池，通常全局就初始化这一个连接池，并且长期运行，所有后续数据库操作都使用该连接池进行。</p><p><code>sql.DB</code> <strong>内部自动维护连接池</strong>，当需要连接时自动选择一个空闲的连接，如果没有空闲就建立一个新的连接，当连接不再使用时放回连接池中，内部会自动管理空闲回收。</p><p>数据库的连接是一个比较大的耗时和资源消耗操作，首选需要经典的 TCP 三次握手，tcp 连接后数据库需要分配连接资源，同时根据连接信息鉴权等，所以建议使用长连接。对应到我们的 go 中，<code>sql.DB</code> 会自动管理连接池，最好<strong>全局使用一个连接池</strong>，不要重复的 open 或者 close。</p><h3 id=查询>查询</h3><p><code>sql.DB</code> 支持 4 种查询：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Query</span><span class=p>()</span>    
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=nx>sql</span><span class=p>)</span>   <span class=nx>stmt</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Exec</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>db.Query()</code> 返回多行数据，需要依次遍历，并且需要自己关闭查询结果集</li><li><code>db.QueryRow()</code> 是专门查询一行数据的一个语法糖，返回 ErrNoRow 或者一行数据，不需要自己关闭结果集</li><li><code>db.Prepare()</code> 是预先将一个数据库连接（con）和一个条 sql 语句绑定并返回 stmt 结构体代表这个绑定后的连接，然后运行 <code>stmt.Query()</code> 或者 <code>stmt.QueryRow()</code>；stmt 是并发安全的。之所以这样设计，是因为每次直接调用 db.Prepare 都会自动选择一个可用的 con，每次选择的可能不是同一个 con</li><li><code>db.Exec()</code> 适用于执行 insert、update、delete 等不需要返回结果集的操作</li></ul><h3 id=结果集>结果集</h3><p>只有 <code>db.Query()</code> 返回结果集</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>id</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;select id, name from users where id = ?&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>defer</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Err</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Close 是可以重复调用的，关闭已经关闭的结果集不会报错</p></blockquote><p>使用 <code>for rows.Next()</code> 遍历结果集，这样迭代<strong>一行一行处理结果</strong>，节约内存分配，同时防止出现 OOM 的问题</p><p>使用 <code>rows.Scan</code> 将一行数据填入指定的变量中，<strong>scan 会自动根据目标变量的类型处理类型转换</strong>的问题，比如数据库中是 varchar，但目标变量是 int，那么 scan 会自动转换，当然如果转化出现 error 会返回 error</p><h3 id=事务>事务</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>tx</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Begin</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>tx</span><span class=p>.</span><span class=nf>Commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>tx</span><span class=p>.</span><span class=nf>Rollback</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>事务是使用 <code>db.begin</code> 开始，以 <code>db.commit</code>/<code>db.rollback</code> 结束</p><p>普通的 <code>db.Query</code>/<code>db.QueryRow</code> 自动从连接池中选择一个可用连接，运行结束后会自动将连接放回连接池，下次运行再次重复这个过程</p><p><strong><code>db.begin</code> 会自动从连接池中选择一个连接并返回一直持有该连接的 tx</strong>（和 <code>db.Prepare</code> 有点像），后续所有事务操作都用 tx，这样能保证是在用一个连接内运行事务，只有 <code>commit</code>/<code>rollback</code> 才会释放连接</p><h3 id=错误处理>错误处理</h3><ul><li>结果集遍历后 error，每次 <code>for rows.Next</code> 结束后要跟一个 <code>rows.Err()</code> 检测</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Err</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// handle the error here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>结果集遍历 close error</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// but what should we do if there&#39;s an error?
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>QueryRow() Error</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=s>&#34;select name from users where id = ?&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>QueryRow 的结果是在 Scan 时才会出现</p><ul><li>Mysql 特定 Error</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>driverErr</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=o>*</span><span class=nx>mysql</span><span class=p>.</span><span class=nx>MySQLError</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// Now the error number is accessible directly
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>driverErr</span><span class=p>.</span><span class=nx>Number</span> <span class=o>==</span> <span class=mi>1045</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Handle the permission-denied error
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>连接没释放问题</p><ol><li>事务没有 commit 或者 rollback</li><li>查询集没有 close</li></ol></li><li><p>查询参数问题</p><ol><li>Mysql 使用？做参数，防止 sql 注入</li><li>既然是参数，就只能当参数，不可以用于其他部分，也不能做插值</li></ol></li></ul><h3 id=标准库-sql-不支持但常用的特性>标准库 sql 不支持但常用的特性</h3><ul><li><p>不支持多条 sql 执行</p><ul><li><p><code>database/sql</code> 并没有对在一次查询中执行多条 SQL 语句的显式支持，具体的行为以驱动的实现为准。所以对于</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;DELETE FROM tbl1; DELETE FROM tbl2&#34;</span><span class=p>)</span> <span class=c1>// Error/unpredictable result
</span></span></span></code></pre></td></tr></table></div></div><p>这样的查询，怎样执行完全由驱动说了算，用户并无法确定驱动到底执行了什么，又返回了什么。</p></li></ul></li><li><p>不支持返回多个结果集</p></li><li><p>不支持存储过程（Mysql 驱动目前不支持）</p></li><li><p>不支持 Scan 到 map、struct</p></li><li><p>不建议 uint64</p></li></ul><h3 id=处理空值>处理空值</h3><p>可空列（Nullable Column）非常的恼人，容易导致代码变得丑陋。如果可以，在设计时就应当尽量避免。因为：</p><ul><li>Go 语言的每一个变量都有着默认零值，当数据的零值没有意义时，可以用零值来表示空值。但很多情况下，数据的零值和空值实际上有着不同的语义。单独的原子类型无法表示这种情况。</li><li>标准库只提供了有限的四种 <code>Nullable type</code>：<code>NullInt64, NullFloat64, NullString, NullBool</code>。并没有诸如<code>NullUint64</code>，<code>NullYourFavoriteType</code>，用户需要自己实现。</li><li>空值有很多麻烦的地方。例如用户认为某一列不会出现空值而采用基本类型接收时却遇到了空值，程序就会崩溃。这种错误非常稀少，难以捕捉、侦测、处理，甚至意识到。</li></ul><p><code>database\sql</code> 提供了四种基本可空数据类型：使用基本类型和一个布尔标记的复合结构体表示可空值。例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>NullInt64</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Int64</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>        <span class=nx>Valid</span> <span class=kt>bool</span> <span class=c1>// Valid is true if Int64 is not NULL
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可空类型的使用方法与基本类型一致：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>s</span> <span class=nx>sql</span><span class=p>.</span><span class=nx>NullString</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// check err
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=c1>// use s.String
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=c1>// handle NULL case
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=处理动态列>处理动态列</h3><p><code>Scan()</code> 函数要求传递给它的目标变量的数目，与结果集中的列数正好匹配，否则就会出错。</p><p>但总有一些情况，用户事先并不知道返回的结果到底有多少列，例如调用一个返回表的存储过程时。</p><p>在这种情况下，使用 <code>rows.Columns()</code> 来获取列名列表。在不知道列类型情况下，应当使用 <code>sql.RawBytes</code> 作为接受变量的类型。获取结果后自行解析。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>cols</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Columns</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// handle this....
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 目标列是一个动态生成的数组
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>dest</span> <span class=o>:=</span> <span class=p>[]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>    <span class=nb>new</span><span class=p>(</span><span class=kt>string</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nb>new</span><span class=p>(</span><span class=kt>uint32</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nb>new</span><span class=p>(</span><span class=nx>sql</span><span class=p>.</span><span class=nx>RawBytes</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 将数组作为可变参数传入Scan中。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=nx>dest</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span></code></pre></td></tr></table></div></div><h2 id=databasesql>database/sql</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;database/sql&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>sql 包提供了保证 SQL 或类 SQL 数据库的泛用接口。</p><p>使用 sql 包时必须注入（至少）一个数据库驱动。</p><h3 id=type-db>type DB</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DB</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 内含隐藏或非导出字段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DB 是一个数据库（操作）<strong>句柄</strong>，代表一个具有零到多个底层连接的连接池。它可以安全的被多个 go 程同时使用。</p><p><code>sql.DB</code> 不是一个连接，它是数据库的抽象接口。它可以根据 driver 驱动打开关闭数据库连接，管理连接池。</p><p>正在使用的连接被标记为繁忙，用完后回到连接池等待下次使用。所以，如果你没有把连接释放回连接池，会导致过多连接使系统资源耗尽。</p><p>sql 包会自动创建和释放连接；它也会维护一个闲置连接的连接池。如果数据库具有单连接状态的概念，该状态只有在事务中被观察时才可信。</p><p>一旦调用了 DB.Begin，返回的 Tx 会绑定到单个连接。当调用事务 Tx 的 Commit 或 Rollback 后，该事务使用的连接会归还到 DB 的闲置连接池中。</p><p>连接池的大小可以用 SetMaxIdleConns 方法控制。</p><h4 id=func-open>func Open</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Open</span><span class=p>(</span><span class=nx>driverName</span><span class=p>,</span> <span class=nx>dataSourceName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>DB</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Open 打开一个 dirverName 指定的数据库，dataSourceName 指定数据源，一般包至少括数据库文件名和（可能的）连接信息。</p><ul><li>第一个参数是调用的驱动名，比如下面的例子中使用的是 github.com/go-sql-driver/mysql 中注册的驱动 &ldquo;mysql&rdquo;</li><li>第二个参数依赖与特定驱动的语法，用来连接数据库，通常是 URL 的形式，如 &ldquo;root:user78@/test&rdquo;</li></ul><p>大多数用户会通过数据库特定的连接帮助函数打开数据库，返回一个 *DB。</p><p>Go 标准库中没有数据库驱动。参见 <a href=http://golang.org/s/sqldrivers target=_blank rel="noopener noreffer">http://golang.org/s/sqldrivers</a> 获取第三方驱动。</p><p>Open 函数不创建与数据库的连接，也不验证其参数。它可能会延迟到你第一次调用该数据库时才回去真正创建与数据库的连接。所以如果要立即检查数据源的名称是否合法，或者数据库是否实际可用，应调用返回值的 Ping 方法。</p><h4 id=func-db-ping>func (*DB) Ping</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DB</span><span class=p>)</span> <span class=nf>Ping</span><span class=p>()</span> <span class=kt>error</span>
</span></span></code></pre></td></tr></table></div></div><p>Ping 检查与数据库的连接是否仍有效，如果需要会创建连接。</p><h4 id=func-db-close>func (*DB) Close</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DB</span><span class=p>)</span> <span class=nf>Close</span><span class=p>()</span> <span class=kt>error</span>
</span></span></code></pre></td></tr></table></div></div><p>Close 关闭数据库，释放任何打开的资源。一般不会关闭 DB，因为 DB 句柄通常被多个 go 程共享，并长期活跃。</p><p>举例，正确是不会报错：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span> 
</span></span><span class=line><span class=cl><span class=kn>import</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=s>&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span> <span class=s>&#34;root:user78@/test&#34;</span><span class=p>)</span> <span class=c1>// 格式为&#34;user:password@/dbname&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//使用Ping检查数据库是否实际可用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Ping</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果写错密码，则会返回：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>userdeMBP</span><span class=p>:</span><span class=k>go</span><span class=o>-</span><span class=nx>learning</span> <span class=nx>user</span><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>test</span><span class=p>.</span><span class=k>go</span>
</span></span><span class=line><span class=cl><span class=mi>2019</span><span class=o>/</span><span class=mo>02</span><span class=o>/</span><span class=mi>20</span> <span class=mi>19</span><span class=p>:</span><span class=mi>51</span><span class=p>:</span><span class=mo>00</span> <span class=nx>Error</span> <span class=mi>1045</span><span class=p>:</span> <span class=nx>Access</span> <span class=nx>denied</span> <span class=k>for</span> <span class=nx>user</span> <span class=err>&#39;</span><span class=nx>root</span><span class=sc>&#39;@&#39;</span><span class=nx>localhost</span><span class=err>&#39;</span> <span class=p>(</span><span class=nx>using</span> <span class=nx>password</span><span class=p>:</span> <span class=nx>YES</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>exit</span> <span class=nx>status</span> <span class=mi>1</span>
</span></span></code></pre></td></tr></table></div></div><p>可见调用 <code>sql.Open()</code> 函数时并没有报错，是调用 <code>db.Ping()</code> 函数时才报出的密码错误</p><p>返回的 DB 可以安全的被多个 go 程同时使用，并会维护自身的闲置连接池。这样一来，Open 函数只需调用一次。很少需要关闭 DB，因为 <code>sql.DB</code> 对象是为了长连接设计的，不要频繁使用 <code>Open()</code> 和 <code>Close()</code> 函数，否则会导致各种错误。</p><p>因此应该为每个待访问的数据库创建一个 <code>sql.DB</code> 实例，并在用完前保留它。如果需要短连接使用，那么可以将其作为函数的参数传递给别的 function 的参数使用，而不是在这个 function 中调用 Open() 和 Close() 再建立已经创建的 sql.DB 实例，或者将其设置为全局变量。</p><h4 id=func-db-driver>func (*DB) Driver</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DB</span><span class=p>)</span> <span class=nf>Driver</span><span class=p>()</span> <span class=nx>driver</span><span class=p>.</span><span class=nx>Driver</span>
</span></span></code></pre></td></tr></table></div></div><p>Driver 方法返回数据库下层驱动。</p><p>下面的四个函数用于进行数据库操作</p><h4 id=func-db-exec>func (*DB) Exec</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DB</span><span class=p>)</span> <span class=nf>Exec</span><span class=p>(</span><span class=nx>query</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>args</span> <span class=o>...</span><span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Exec 执行一次命令（包括查询、删除、更新、插入等），不返回数据集，返回的结果是 Result</p><p><code>Result</code> 接口允许获取执行结果的元数据。参数 args 表示 query 中的占位参数。</p><h4 id=func-db-query>func (*DB) Query</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DB</span><span class=p>)</span> <span class=nf>Query</span><span class=p>(</span><span class=nx>query</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>args</span> <span class=o>...</span><span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=o>*</span><span class=nx>Rows</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Query 执行一次查询，返回多行结果（即 Rows），一般用于执行 select 命令。</p><p>参数 args 表示 query 中的占位参数。</p><p>上面两个的差别在于：Query 会返回查询结果 Rows, Exec 不会返回查询结果，只会返回一个结果的状态 Result</p><p><strong>所以一般进行不需要返回值的 DDL 和增删改等操作时会使用 Exec，查询则使用 Query</strong>。当然这主要还是取决于是否需要返回值</p><h4 id=func-db-queryrow>func (*DB) QueryRow</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DB</span><span class=p>)</span> <span class=nf>QueryRow</span><span class=p>(</span><span class=nx>query</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>args</span> <span class=o>...</span><span class=kd>interface</span><span class=p>{})</span> <span class=o>*</span><span class=nx>Row</span>
</span></span></code></pre></td></tr></table></div></div><p>QueryRow执行一次查询，并期望返回最多一行结果（即Row）。QueryRow总是返回非nil的值，直到返回值的Scan方法被调用时，才会返回被延迟的错误。（如：未找到结果）</p><h4 id=func-db-prepare>func (*DB) Prepare</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DB</span><span class=p>)</span> <span class=nf>Prepare</span><span class=p>(</span><span class=nx>query</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>Stmt</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Prepare 创建一个准备好的状态用于之后的查询和命令，即<strong>准备一个需要多次使用的语句，供后续执行用</strong>。返回值可以同时执行多个查询和命令。</p><h4 id=func-db-begin>func (*DB) Begin</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DB</span><span class=p>)</span> <span class=nf>Begin</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>Tx</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Begin开始一个事务。隔离水平由数据库驱动决定。</p><h4 id=例>例</h4><p>首先先在 mysql 中创建数据库 test，并生成两个表，一个是用户表 userinfo，一个是关联用户信息表 userdetail。使用 workbench 进行创建，首先创建数据库 test：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>SCHEMA</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=nb>CHARACTER</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>utf8</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>然后创建表：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>use</span> <span class=nx>test</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>create</span> <span class=nx>table</span> <span class=s>`userinfo`</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>`uid`</span> <span class=nb>int</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span> <span class=nx>not</span> <span class=nx>null</span> <span class=nx>auto_increment</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>`username`</span> <span class=nf>varchar</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span> <span class=nx>null</span> <span class=k>default</span> <span class=nx>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>`department`</span> <span class=nf>varchar</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span> <span class=nx>null</span> <span class=k>default</span> <span class=nx>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>`created`</span> <span class=nx>date</span> <span class=nx>null</span> <span class=k>default</span> <span class=nx>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>primary</span> <span class=nf>key</span> <span class=p>(</span><span class=s>`uid`</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>create</span> <span class=nx>table</span> <span class=s>`userdetail`</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>`uid`</span> <span class=nb>int</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span> <span class=nx>not</span> <span class=nx>null</span> <span class=k>default</span> <span class=sc>&#39;0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>`intro`</span> <span class=nx>text</span> <span class=nx>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>`profile`</span> <span class=nx>text</span> <span class=nx>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>primary</span> <span class=nf>key</span> <span class=p>(</span><span class=s>`uid`</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>接下来就示范怎么使用 database/sql 接口对数据库进行增删改查操作：</p><p>当然运行前首先需要下载驱动：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>go</span> <span class=nx>get</span> <span class=o>-</span><span class=nx>u</span> <span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=k>go</span><span class=o>-</span><span class=nx>sql</span><span class=o>-</span><span class=nx>driver</span><span class=o>/</span><span class=nx>mysql</span>
</span></span></code></pre></td></tr></table></div></div><p>当然，如果你连接的是 sqlite3 数据库，那么你要下载的驱动是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http://github.com/mattn/go-sqlite3
</span></span></code></pre></td></tr></table></div></div><p>举例；</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span> 
</span></span><span class=line><span class=cl><span class=kn>import</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=s>&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span> <span class=s>&#34;root:user78@/test&#34;</span><span class=p>)</span> <span class=c1>// 格式为&#34;user:password@/dbname&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 插入数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>stmt</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;insert userinfo set username = ?,department=?,created=?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 执行准备好的Stmt
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>res</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stmt</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;user1&#34;</span><span class=p>,</span> <span class=s>&#34;computing&#34;</span><span class=p>,</span> <span class=s>&#34;2019-02-20&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取上一个，即上面insert操作的ID
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>id</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>res</span><span class=p>.</span><span class=nf>LastInsertId</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 更新数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>stmt</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span><span class=nx>db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;update userinfo set username=? where uid=?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmt</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;user1update&#34;</span><span class=p>,</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>affect</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>res</span><span class=p>.</span><span class=nf>RowsAffected</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>affect</span><span class=p>)</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 查询数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;select * from userinfo&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span> <span class=c1>//作为循环条件来迭代获取结果集Rows
</span></span></span><span class=line><span class=cl><span class=c1></span>　　　　 <span class=c1>//从结果集中获取一行结果
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>uid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>username</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>department</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>created</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=c1>// 结果应为: 1 user1update computing 2019-02-20
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>uid</span><span class=p>,</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>department</span><span class=p>,</span> <span class=nx>created</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>　　<span class=k>defer</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span> <span class=c1>// 关闭结果集，释放链接
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 删除数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>stmt</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;delete from userinfo where uid=?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmt</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>affect</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>res</span><span class=p>.</span><span class=nf>RowsAffected</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>affect</span><span class=p>)</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>userdeMBP:go-learning user$ go run test.go
</span></span><span class=line><span class=cl>1
</span></span><span class=line><span class=cl>1
</span></span><span class=line><span class=cl>1 user1update computing 2019-02-20
</span></span><span class=line><span class=cl>1
</span></span></code></pre></td></tr></table></div></div><p>上面代码使用的函数的作用分别是：</p><ol><li><code>sql.Open()</code> 函数用来打开一个注册过的数据库驱动，go-sql-driver/mysql 中注册了 mysql 这个数据库驱动，第二个参数是 DNS（Data Source Name），它是 go-sql-driver/mysql 定义的一些数据库连接和配置信息，其支持下面的几种格式：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>user@unix(/path/to/socket)/dbname?charset=utf8
</span></span><span class=line><span class=cl>user:password@tcp(localhost:5555)/dbname?charset=utf8
</span></span><span class=line><span class=cl>user:password@/dbname
</span></span><span class=line><span class=cl>user:password@tcp([de:ad:be::ca:fe]:80)/dbname
</span></span></code></pre></td></tr></table></div></div><ol start=2><li><p><code>db.Prepare()</code> 函数用来返回准备要执行的 sql 操作，然后返回准备完毕的执行状态</p></li><li><p><code>db.Query()</code> 函数用来直接执行 Sql 并返回 Rows 结果</p></li><li><p><code>stmt.Exec()</code> 函数用来执行 stmt 准备好的 SQL 语句,然后返回 Result</p></li></ol><blockquote><p>sql 中传入的参数都是 =？对应的数据，这样做可以在一定程度上防止 SQL 注入</p></blockquote><h4 id=func-db-setmaxopenconns>func (*DB) SetMaxOpenConns</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DB</span><span class=p>)</span> <span class=nf>SetMaxOpenConns</span><span class=p>(</span><span class=nx>n</span> <span class=kt>int</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>SetMaxOpenConns 设置与数据库建立连接的最大数目。</p><p>如果 n 大于 0 且小于最大闲置连接数，会将最大闲置连接数减小到匹配最大开启连接数的限制。</p><p>如果 n &lt;= 0，不会限制最大开启连接数，默认为 0（无限制）。</p><h4 id=func-db-setmaxidleconns>func (*DB) SetMaxIdleConns</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (db *DB) SetMaxIdleConns(n int)
</span></span></code></pre></td></tr></table></div></div><p>SetMaxIdleConns设置连接池中的最大闲置连接数。</p><p>如果n大于最大开启连接数，则新的最大闲置连接数会减小到匹配最大开启连接数的限制。</p><p>如果n &lt;= 0，不会保留闲置连接。</p><h3 id=type-result>type Result</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Result</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>LastInsertId</span><span class=p>()</span> <span class=p>(</span><span class=kt>int64</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>RowsAffected</span><span class=p>()</span> <span class=p>(</span><span class=kt>int64</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Result 是对已执行的 SQL 命令的总结。</p><ul><li>LastInsertId 返回一个数据库生成的回应命令的整数。<ul><li>当插入新行时，一般来自一个"自增"列。</li><li>不是所有的数据库都支持该功能，该状态的语法也各有不同。</li></ul></li><li>RowsAffected 返回被 update、insert 或 delete 命令影响的<strong>行数</strong>。<ul><li>不是所有的数据库都支持该功能。</li></ul></li></ul><h3 id=type-row>type Row</h3><p>上面的 DB 的函数 <code>Query()</code> 和 <code>QueryRow()</code> 会返回 <em>ROWs</em> 和 <em>ROW</em>，因此下面就是如何去得到返回结果的更多详细的信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Row</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 内含隐藏或非导出字段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>QueryRow 方法返回 Row，代表单行查询结果。</p><h4 id=func-row-scan>func (*Row) Scan</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>Row</span><span class=p>)</span> <span class=nf>Scan</span><span class=p>(</span><span class=nx>dest</span> <span class=o>...</span><span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span>
</span></span></code></pre></td></tr></table></div></div><p>Scan 将该行查询结果各列分别保存进 dest 参数指定的值中。如果该查询匹配多行，Scan 会使用第一行结果并丢弃其余各行。如果没有匹配查询的行，Scan 会返回 ErrNoRows。</p><p>举例：一开始数据库中为空，因此调用 Scan 会返回错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span> 
</span></span><span class=line><span class=cl><span class=kn>import</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=s>&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span> <span class=s>&#34;root:user78@/test&#34;</span><span class=p>)</span> <span class=c1>//后面格式为&#34;user:password@/dbname&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//使用Ping检查数据库是否实际可用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Ping</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//查询数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>uid</span> <span class=kt>int</span> 
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>department</span><span class=p>,</span> <span class=nx>created</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=s>&#34;select * from userinfo&#34;</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>uid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>username</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>department</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>created</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>sql</span><span class=p>.</span><span class=nx>ErrNoRows</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;No user with that ID.&#34;</span><span class=p>)</span> <span class=c1>// 返回 2019/02/21 10:38:33 No user with that ID.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>case</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Username is %s\n&#34;</span><span class=p>,</span> <span class=nx>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>因此如果先插入数据再调用 <code>QueryRow</code> 则不会出错了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span> 
</span></span><span class=line><span class=cl><span class=kn>import</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=s>&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span> <span class=s>&#34;root:user78@/test&#34;</span><span class=p>)</span> <span class=c1>// 格式为&#34;user:password@/dbname&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用Ping检查数据库是否实际可用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Ping</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>stmt</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;insert userinfo set username =?,department=?,created=?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmt</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;testQueryRow&#34;</span><span class=p>,</span> <span class=s>&#34;computing&#34;</span><span class=p>,</span> <span class=s>&#34;2019-02-21&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 查询数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>uid</span> <span class=kt>int</span> 
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>department</span><span class=p>,</span> <span class=nx>created</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=s>&#34;select * from userinfo&#34;</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>uid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>username</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>department</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>created</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>sql</span><span class=p>.</span><span class=nx>ErrNoRows</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;No user with that ID.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Uid is %v, username is %s, department is %s, created at %s\n&#34;</span><span class=p>,</span> <span class=nx>uid</span><span class=p>,</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>department</span><span class=p>,</span> <span class=nx>created</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>userdeMBP:go-learning user$ go run test.go
</span></span><span class=line><span class=cl>Uid is 3, username is testQueryRow, department is computing, created at 2019-02-21
</span></span></code></pre></td></tr></table></div></div><h3 id=type-rows>type Rows</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Rows</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 内含隐藏或非导出字段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Rows 是查询的结果。它的游标指向结果集的第零行，使用 Next 方法来遍历各行结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;SELECT ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=k>defer</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>id</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Err</span><span class=p>()</span> <span class=c1>// 在退出迭代后检查错误
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=func-rows-columns>func (*Rows) Columns</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rs</span> <span class=o>*</span><span class=nx>Rows</span><span class=p>)</span> <span class=nf>Columns</span><span class=p>()</span> <span class=p>([]</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Columns 返回列名。如果 Rows 已经关闭会返回错误。</p><h4 id=func-rows-scan>func (*Rows) Scan</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rs</span> <span class=o>*</span><span class=nx>Rows</span><span class=p>)</span> <span class=nf>Scan</span><span class=p>(</span><span class=nx>dest</span> <span class=o>...</span><span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span>
</span></span></code></pre></td></tr></table></div></div><p>Scan 将当前行各列结果填充进 dest 指定的各个值中，用于在迭代中获取一行结果。</p><p>如果某个参数的类型为 []byte，Scan 会保存对应数据的拷贝，该拷贝为调用者所有，可以安全地修改或无限期地保存。如果参数类型为 *RawBytes 可以避免拷贝；参见 RawBytes 的文档获取其使用的约束。</p><p>如果某个参数的类型为 *interface{}，Scan 会不做转换的拷贝底层驱动提供的值。如果值的类型为 []byte，会进行数据的拷贝，调用者可以安全使用该值。</p><h4 id=func-rows-next>func (*Rows) Next</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rs</span> <span class=o>*</span><span class=nx>Rows</span><span class=p>)</span> <span class=nf>Next</span><span class=p>()</span> <span class=kt>bool</span>
</span></span></code></pre></td></tr></table></div></div><p>Next 准备用于 Scan 方法的下一行结果。如果成功会返回 true，如果没有下一行或者出现错误会返回 false。Err() 方法应该被调用以区分这两种情况。</p><p><strong>每一次调用 Scan 方法，甚至包括第一次调用该方法，都必须在前面先调用 Next 方法。</strong></p><h4 id=func-rows-close>func (*Rows) Close</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rs</span> <span class=o>*</span><span class=nx>Rows</span><span class=p>)</span> <span class=nf>Close</span><span class=p>()</span> <span class=kt>error</span>
</span></span></code></pre></td></tr></table></div></div><p>Close 关闭 Rows，阻止对其更多的列举。 如果 Next 方法返回 false，Rows 会自动关闭，满足检查 Err 方法结果的条件。Close 方法是幂等的（即多次调用不会出错），不影响 Err 方法的结果。</p><p>用于关闭结果集 Rows。结果集引用了数据库连接，并会从中读取结果。读取完之后必须关闭它才能避免资源泄露。只要结果集仍然打开着，相应的底层连接就处于忙碌状态，不能被其他查询使用。</p><h4 id=func-rows-err>func (*Rows) Err</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rs</span> <span class=o>*</span><span class=nx>Rows</span><span class=p>)</span> <span class=nf>Err</span><span class=p>()</span> <span class=kt>error</span>
</span></span></code></pre></td></tr></table></div></div><p>Err 返回可能的、在迭代时出现的错误，即用于在退出迭代后检查错误。Err 需在显式或隐式调用 Close 方法后调用，即如果 Next 方法返回 false，Rows 会自动关闭，相当于调用了 Close()。</p><p>正常情况下迭代退出是因为内部产生的 EOF 错误（即数据读取完毕），使得下一次 <code>rows.Next() == false</code>，从而终止循环；在迭代结束后要检查错误，以确保迭代是因为数据读取完毕，而非其他“真正”错误而结束的。</p><p>举例：</p><p>包括上面的例子，这里再插入一条数据，这样数据库中就有两条数据了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span> 
</span></span><span class=line><span class=cl><span class=kn>import</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=s>&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span> <span class=s>&#34;root:user78@/test&#34;</span><span class=p>)</span> <span class=c1>// 格式为&#34;user:password@/dbname&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用Ping检查数据库是否实际可用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Ping</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>stmt</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;insert userinfo set username =?,department=?,created=?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmt</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;testQuery&#34;</span><span class=p>,</span> <span class=s>&#34;data mining&#34;</span><span class=p>,</span> <span class=s>&#34;2019-02-21&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 查询数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;select * from userinfo&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 迭代结果
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>uid</span> <span class=kt>int</span> 
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>department</span><span class=p>,</span> <span class=nx>created</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>uid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>username</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>department</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>created</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Uid is %v, username is %s, department is %s, created at %s\n&#34;</span><span class=p>,</span> <span class=nx>uid</span><span class=p>,</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>department</span><span class=p>,</span> <span class=nx>created</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 查看迭代时是否出错以及出的是什么错
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Err</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>userdeMBP:go-learning user$ go run test.go
</span></span><span class=line><span class=cl>Uid is 3, username is testQueryRow, department is computing, created at 2019-02-21
</span></span><span class=line><span class=cl>Uid is 4, username is testQuery, department is data mining, created at 2019-02-21
</span></span></code></pre></td></tr></table></div></div><h3 id=type-stmt>type Stmt</h3><p>在调用 <code>db.Prepare()</code> 后会返回 *Stmt，即准备好的语句</p><p>一般一个<strong>会多次进行查询的语句</strong>就应该将其设置为准备好的语句。</p><p>Stmt 是和单个数据库直接绑定的。客户端会发送一个带有占位符，如 ？的 SQL 语句的 Stmt 到服务端，然后服务端会返回一个 Stmt ID，说明给你绑定的连接是哪一个。然后之后当客户端要执行该 Stmt 时，就会发送 ID 和参数来绑定连接并执行操作。</p><p>要注意的是不能直接为 Stmt 绑定连接，连接只能与 DB 和 Tx 绑定，当我们生成一个 Stmt 时，首先它会自动在连接池中绑定一个空闲连接，然后 Stmt 会记住该连接，然后之后执行时尝试使用这个连接，如果不可用，如连接繁忙或关闭，则会重新准备语句并再绑定一个新的连接</p><p>Stmt 中可以执行的方法与 db 中的方法十分类似</p><ul><li><code>func (*Stmt) Exec</code></li><li><code>func (*Stmt) Query</code></li><li><code>func (*Stmt) QueryRow</code></li><li><code>func (*Stmt) Close</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span> 
</span></span><span class=line><span class=cl><span class=kn>import</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=s>&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span> <span class=s>&#34;root:user78@/test&#34;</span><span class=p>)</span> <span class=c1>//后面格式为&#34;user:password@/dbname&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//使用Ping检查数据库是否实际可用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Ping</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>stmt1</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;insert userinfo set username =?,department=?,created=?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmt1</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;testStmtExecAndQueryRow&#34;</span><span class=p>,</span> <span class=s>&#34;accounting&#34;</span><span class=p>,</span> <span class=s>&#34;2019-02-21&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmt1</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>stmt2</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;select * from userinfo where uid =?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//查询数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>uid</span> <span class=kt>int</span> 
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>department</span><span class=p>,</span> <span class=nx>created</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmt2</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>uid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>username</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>department</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>created</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Uid is %v, username is %s, department is %s, created at %s\n&#34;</span><span class=p>,</span> <span class=nx>uid</span><span class=p>,</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>department</span><span class=p>,</span> <span class=nx>created</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmt2</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>userdeMBP:go-learning user$ go run test.go
</span></span><span class=line><span class=cl>Uid is 5, username is testStmtExecAndQueryRow, department is accounting, created at 2019-02-21
</span></span></code></pre></td></tr></table></div></div><h3 id=type-tx>type Tx</h3><p><code>db.Begin()</code> 函数会返回 *Tx。Go 中事务（Tx）是一个持有数据库连接的对象，它允许用户在同一个连接上执行上面提到的各类操作。</p><p>使用它的原因是：Tx 上执行的方法都保证是在同一个底层连接上执行的，这样对连接状态的修改将会一直对后续的操作起作用</p><p>然而 DB 的方法就不会保证是在同一条连接上执行，如果之前的连接繁忙或关闭，那么就会使用其他的连接</p><p>Tx 和 Stmt 不能分离，意思就是 Tx 必须调用自己的 Tx.Prepare() 函数来生成 Stmt 来供自己使用，而不能使用 DB 生成的 Stmt，因为这样他们使用的必定不是同一个连接。</p><p>当然，如果你想要在该事务中使用已存在的状态，参见 Tx.Stmt 方法，将 DB 的 Stmt 转成 Tx 的 Stmt。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Tx</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 内含隐藏或非导出字段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Tx 代表一个进行中的数据库事务。</p><p>一次事务必须以对 Commit 或 Rollback 的调用结束。</p><p>调用 Commit 或 Rollback 后，所有对事务的操作都会失败并返回错误值 ErrTxDone。</p><ul><li><code>func (*Stmt) Exec</code></li><li><code>func (*Stmt) Query</code></li><li><code>func (*Stmt) QueryRow</code></li></ul><h4 id=事务中的多条语句>事务中的多条语句</h4><p>因为事务保证在它上面执行的查询都由同一个连接来执行，因此事务中的语句必需按顺序一条一条执行。</p><p>对于返回结果集的查询，事务必须在结果集执行 <code>Close()</code> 之后才能进行下一次查询。</p><p>用户如果尝试在前一条语句的结果还没读完前就执行新的查询，连接就会失去同步。这意味着事务中返回结果集的语句都会占用一次单独的网络往返。</p><h4 id=func-tx-prepare>func (*Tx) Prepare</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>Tx</span><span class=p>)</span> <span class=nf>Prepare</span><span class=p>(</span><span class=nx>query</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>Stmt</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>Prepare</code> 准备一个专用于该事务的状态。返回的该事务专属状态操作在 Tx 递交或回滚后不能再使用，因此一定要在事务结束前，即调用 Commit() 或 Rollback 函数前关闭准备语句。</p><p><strong>在事务中使用 <code>defer stmt.Close()</code> 是相当危险的</strong>。因为当事务 Tx 结束后，它会先释放自己持有的数据库 DB 连接，但事务 Tx 创建的未关闭 <code>Stmt</code> 仍然保留着对事务 Tx 连接的引用。</p><p>在事务结束后执行 <code>stmt.Close()</code>，他就会根据引用去查找之前的数据库 DB 连接，然后想要释放它。但是其实数据库的连接早就被释放了，而且如果原来释放的数据库 DB 连接已经被其他查询获取并使用，就会产生竞争，极有可能破坏连接的状态。因此两者的释放顺序是十分重要的</p><p>先释放在事务 Tx 的状态 Stmt，再释放事务 Tx，最后释放 db</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span> 
</span></span><span class=line><span class=cl><span class=kn>import</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=s>&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span> <span class=s>&#34;root:user78@/test&#34;</span><span class=p>)</span> <span class=c1>// 格式为&#34;user:password@/dbname&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用Ping检查数据库是否实际可用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Ping</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>tx</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Begin</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>tx</span><span class=p>.</span><span class=nf>Commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>stmt1</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>tx</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;insert userinfo set username =?,department=?,created=?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stmt1</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;testTx&#34;</span><span class=p>,</span> <span class=s>&#34;PD&#34;</span><span class=p>,</span> <span class=s>&#34;2019-02-21&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>result</span><span class=p>.</span><span class=nf>LastInsertId</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmt1</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>stmt2</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>tx</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;select * from userinfo where uid =?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//查询数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>uid</span> <span class=kt>int</span> 
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>department</span><span class=p>,</span> <span class=nx>created</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmt2</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=nx>id</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>uid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>username</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>department</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>created</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>checkErr</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Uid is %v, username is %s, department is %s, created at %s\n&#34;</span><span class=p>,</span> <span class=nx>uid</span><span class=p>,</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>department</span><span class=p>,</span> <span class=nx>created</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmt2</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面的 defer 会安装 stmt2 -> stmt1 -> tx -> db 的顺序来关闭连接</p><p>成功返回：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>userdeMBP:go-learning user$ go run test.go
</span></span><span class=line><span class=cl>Uid is 6, username is testTx, department is PD, created at 2019-02-21
</span></span></code></pre></td></tr></table></div></div><h4 id=func-tx-stmt>func (*Tx) Stmt</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>Tx</span><span class=p>)</span> <span class=nf>Stmt</span><span class=p>(</span><span class=nx>stmt</span> <span class=o>*</span><span class=nx>Stmt</span><span class=p>)</span> <span class=o>*</span><span class=nx>Stmt</span>
</span></span></code></pre></td></tr></table></div></div><p>Stmt 使用已存在的状态生成一个该事务特定的状态。</p><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>updateMoney</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;UPDATE balance SET money=money+? WHERE id=?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nx>tx</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Begin</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nx>res</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>tx</span><span class=p>.</span><span class=nf>Stmt</span><span class=p>(</span><span class=nx>updateMoney</span><span class=p>).</span><span class=nf>Exec</span><span class=p>(</span><span class=mf>123.45</span><span class=p>,</span> <span class=mi>98293203</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=func-tx-commit>func (*Tx) Commit</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>Tx</span><span class=p>)</span> <span class=nf>Commit</span><span class=p>()</span> <span class=kt>error</span>
</span></span></code></pre></td></tr></table></div></div><p>Commit 递交事务。</p><h4 id=func-tx-rollback>func (*Tx) Rollback</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>Tx</span><span class=p>)</span> <span class=nf>Rollback</span><span class=p>()</span> <span class=kt>error</span>
</span></span></code></pre></td></tr></table></div></div><p>Rollback 放弃并回滚事务。</p><h2 id=databasesqldriver>database/sql/driver</h2><p><a href=https://www.cnblogs.com/wanghui-garcia/p/10405601.html target=_blank rel="noopener noreffer">https://www.cnblogs.com/wanghui-garcia/p/10405601.html</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;database/sql/driver&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>driver 包定义了应被数据库驱动实现的接口，这些接口会被 sql 包使用。</p><p>绝大多数代码应使用 sql 包。</p><h3 id=driverdriver>driver.Driver</h3><p>Driver是一个数据库驱动的接口，其定义了一个Open(name string)方法，该方法返回一个数据库的Conn接口：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Driver</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>Open</span><span class=p>(</span><span class=nx>name</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>Conn</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>Open</code> 返回一个新的与数据库的连接，参数 name 的格式是驱动特定的。</p><p><code>Open</code> 可能返回一个缓存的连接（之前关闭的连接），但这么做是不必要的；</p><p>sql 包会维护闲置连接池以便有效的重用连接。</p><p>返回的连接同一时间只会被一个 go 程使用。所以返回的 Conn 只能用来进行一次 goroutine 操作，即不能把这个Conn 应用于 Go 的多个 goroutine 中，否则会出现错误，如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>go</span> <span class=nf>goroutineA</span><span class=p>(</span><span class=nx>Conn</span><span class=p>)</span> <span class=c1>//执行查询操作
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>go</span> <span class=nf>goroutineB</span><span class=p>(</span><span class=nx>Conn</span><span class=p>)</span> <span class=c1>//执行插入操作
</span></span></span></code></pre></td></tr></table></div></div><p>这样的代码会使 Go 不知某个操作到底是由哪个 goroutine 发起的从而导致数据混乱。</p><p>可能会发生： goroutineA 里面执行的查询操作的结果返回给 goroutineB，从而让 goroutineB 将此结果当成自己执行的插入数据</p><h3 id=driverconn>driver.Conn</h3><p>Conn 是一个数据连接的接口定义。它只能应用在一个 goroutine 中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Conn</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>Prepare</span><span class=p>(</span><span class=nx>query</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>Stmt</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>Close</span><span class=p>()</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>    <span class=nf>Begin</span><span class=p>()</span> <span class=p>(</span><span class=nx>Tx</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>Prepare</code> 返回一个准备好的、绑定到该连接的状态，换句话说，返回与当前连接相关的 SQL 语句的准备状态，可以进行查询、删除等操作</p><p><code>Close</code> 作废并停止任何现在准备好的状态和事务，将该连接标注为不再使用。</p><blockquote><p>因为 sql 包维护着一个连接池，只有当闲置连接过剩时才会调用 Close 方法，驱动的实现中不需要添加自己的连接缓存池。</p><p>因为驱动实现了 database/sql 中建议的 conn pool，所以不用再去实现缓存 conn 之类的，这样会更容易引起问题</p></blockquote><p><code>Begin</code> 返回一个代表事务处理的 Tx，通过它你可以进行查询、更新等操作，或者对事务进行回滚、递交</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-03-11</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/Notes/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>数据库</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/Notes/>主页</a></span></section></div><div class=post-nav><a href=/Notes/posts/courses/%E5%AE%9E%E7%94%A8%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%8B%B1%E8%AF%AD/ class=prev rel=prev title=实用计算机英语><i class="fas fa-angle-left fa-fw"></i>实用计算机英语</a>
<a href=/Notes/posts/golang/%E6%A0%87%E5%87%86%E5%BA%93/io/ioutil/ class=next rel=next title="Go ioutil 标准库">Go ioutil 标准库<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>酒困路长惟欲睡，日高人渴漫思茶</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/Notes/lib/katex/katex.min.css><link rel=stylesheet href=/Notes/lib/katex/copy-tex.min.css><script type=text/javascript src=/Notes/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/Notes/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/Notes/lib/lunr/lunr.min.js></script><script type=text/javascript src=/Notes/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/Notes/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/Notes/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/Notes/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/Notes/lib/katex/katex.min.js></script><script type=text/javascript src=/Notes/lib/katex/auto-render.min.js></script><script type=text/javascript src=/Notes/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/Notes/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:45},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/Notes/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/Notes/lib/lunr/lunr.segmentit.js",maxResultLength:30,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/Notes/js/theme.min.js></script></body></html>