<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=X-UA-Compatible content="IE=edge, chrome=1"><title>Python unittest 库 - 伤心肠粉的酱油碟子</title><meta name=author content>
<meta name=author-link content><meta name=description content="unittest 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 import unittest class TestStringMethods(unittest.TestCase): def test_upper(self): self.assertEqual('foo'.upper(), 'FOO') def test_isupper(self): self.assertTrue('FOO'.isupper()) self.assertFalse('Foo'.isupper()) def test_split(self): s = 'hello world' self.assertEqual(s.split(),"><meta name=keywords content="Python"><meta itemprop=name content="Python unittest 库"><meta itemprop=description content="unittest 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 import unittest class TestStringMethods(unittest.TestCase): def test_upper(self): self.assertEqual('foo'.upper(), 'FOO') def test_isupper(self): self.assertTrue('FOO'.isupper()) self.assertFalse('Foo'.isupper()) def test_split(self): s = 'hello world' self.assertEqual(s.split(),"><meta itemprop=datePublished content="2022-09-15T00:00:00+00:00"><meta itemprop=dateModified content="2024-02-10T06:55:49+00:00"><meta itemprop=wordCount content="12618"><meta itemprop=image content="https://trouvaille0198.github.io/logo.png"><meta itemprop=keywords content="Python,"><meta property="og:title" content="Python unittest 库"><meta property="og:description" content="unittest 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 import unittest class TestStringMethods(unittest.TestCase): def test_upper(self): self.assertEqual('foo'.upper(), 'FOO') def test_isupper(self): self.assertTrue('FOO'.isupper()) self.assertFalse('Foo'.isupper()) def test_split(self): s = 'hello world' self.assertEqual(s.split(),"><meta property="og:type" content="article"><meta property="og:url" content="https://trouvaille0198.github.io/Notes/posts/python/%E6%A0%87%E5%87%86%E5%BA%93/unittest/"><meta property="og:image" content="https://trouvaille0198.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-15T00:00:00+00:00"><meta property="article:modified_time" content="2024-02-10T06:55:49+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://trouvaille0198.github.io/logo.png"><meta name=twitter:title content="Python unittest 库"><meta name=twitter:description content="unittest 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 import unittest class TestStringMethods(unittest.TestCase): def test_upper(self): self.assertEqual('foo'.upper(), 'FOO') def test_isupper(self): self.assertTrue('FOO'.isupper()) self.assertFalse('Foo'.isupper()) def test_split(self): s = 'hello world' self.assertEqual(s.split(),"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://trouvaille0198.github.io/Notes/posts/python/%E6%A0%87%E5%87%86%E5%BA%93/unittest/><link rel=prev href=https://trouvaille0198.github.io/Notes/posts/python/%E5%B8%B8%E7%94%A8%E5%BA%93/warnings/><link rel=next href=https://trouvaille0198.github.io/Notes/posts/python/%E5%B8%B8%E7%94%A8%E5%BA%93/ipdb/><link rel=stylesheet href=/Notes/lib/normalize/normalize.min.css><link rel=stylesheet href=/Notes/css/style.min.css><link rel=stylesheet href=/Notes/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/Notes/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Python unittest 库","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/python\/%E6%A0%87%E5%87%86%E5%BA%93\/unittest\/"},"genre":"posts","keywords":"Python","wordcount":12618,"url":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/python\/%E6%A0%87%E5%87%86%E5%BA%93\/unittest\/","datePublished":"2022-09-15T00:00:00+00:00","dateModified":"2024-02-10T06:55:49+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"MelonCholi"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子><span class=header-title-text>伤心肠粉</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/Notes/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/Notes/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/Notes/posts/>文章</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子><span class=header-title-text>伤心肠粉</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/Notes/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/Notes/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/Notes/posts/>文章</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class="toc-content always-active" id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Python unittest 库</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle"></i>
MelonCholi</span></span>
<span class=post-category>收录于 <a href=/Notes/categories/python/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;Python</a></span></div><div class=post-meta-line><span title="2022-09-15 00:00:00"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-09-15>2022-09-15</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 12618 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 26 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#mock>Mock</a><ul><li><a href=#快速上手>快速上手</a></li><li><a href=#mock-和-magicmock-对象>Mock 和 MagicMock 对象</a><ul><li><a href=#mock-构造函数>Mock 构造函数</a></li><li><a href=#magicmock-构造函数>MagicMock 构造函数</a></li></ul></li><li><a href=#常用方法>常用方法</a><ul><li><a href=#assert_called><code>assert_called()</code></a></li><li><a href=#assert_called_once><code>assert_called_once()</code></a></li><li><a href=#assert_called_withargs-kwargs><code>assert_called_with(*args, **kwargs)</code></a></li><li><a href=#assert_called_once_withargs-kwargs><code>assert_called_once_with(*args, **kwargs)</code></a></li><li><a href=#assert_any_callargs-kwargs><code>assert_any_call(*args, **kwargs)</code></a></li><li><a href=#assert_has_callscalls-any_orderfalse><code>assert_has_calls(calls, any_order=False)</code></a></li><li><a href=#assert_not_called><code>assert_not_called()</code></a></li><li><a href=#reset_mock-return_valuefalse-side_effectfalse><code>reset_mock(*, return_value=False, side_effect=False)</code></a></li><li><a href=#mock_add_specspec-spec_setfalse><code>mock_add_spec(spec, spec_set=False)</code></a></li><li><a href=#attach_mockmock-attribute><code>attach_mock(mock, attribute)</code></a></li><li><a href=#configure_mockkwargs><code>configure_mock(**kwargs)</code></a></li></ul></li><li><a href=#常用属性>常用属性</a><ul><li><a href=#called><strong>called</strong></a></li><li><a href=#call_count><strong>call_count</strong></a></li><li><a href=#return_value><strong>return_value</strong></a></li><li><a href=#side_effect><strong>side_effect</strong></a></li><li><a href=#call_args><strong>call_args</strong></a></li><li><a href=#call_args_list><strong>call_args_list</strong></a></li><li><a href=#method_calls><strong>method_calls</strong></a></li><li><a href=#mock_calls><strong>mock_calls</strong></a></li><li><a href=#__class__><code>__class__</code></a></li></ul></li><li><a href=#其他-mock-类>其他 Mock 类</a><ul><li><a href=#asyncmock-类>AsyncMock 类</a></li></ul></li><li><a href=#上手指南>上手指南</a><ul><li><a href=#模拟方法调用>模拟方法调用</a></li><li><a href=#对象上的方法调用的-mock>对象上的方法调用的 mock</a></li><li><a href=#模拟类>模拟类</a></li><li><a href=#命名你的-mock>命名你的 mock</a></li><li><a href=#追踪所有的调用>追踪所有的调用</a></li><li><a href=#设置返回值和属性>设置返回值和属性</a></li><li><a href=#通过-mock-引发异常>通过 mock 引发异常</a></li><li><a href=#附带影响函数和可迭代对象>附带影响函数和可迭代对象</a></li><li><a href=#模拟异步迭代器>模拟异步迭代器</a></li><li><a href=#模拟异步上下文管理器>模拟异步上下文管理器</a></li><li><a href=#基于现有对象创建模拟对象>基于现有对象创建模拟对象</a></li><li><a href=#使用-side_effect-返回每个文件的内容>使用 side_effect 返回每个文件的内容</a></li></ul></li><li><a href=#patch>patch</a><ul><li><a href=#构造函数>构造函数</a></li><li><a href=#mockpatch>@mock.patch</a></li><li><a href=#mockpatchobject>@mock.patch.object</a></li><li><a href=#自上而下原则>自上而下原则</a></li><li><a href=#patch-的位置>patch 的位置</a></li><li><a href=#patch-的-start-和-stop-方法>patch 的 start 和 stop 方法</a></li><li><a href=#一个示例>一个示例</a></li></ul></li></ul></li><li><a href=#assert>assert</a><ul><li><a href=#预览>预览</a></li><li><a href=#assertraises>assertRaises()</a></li></ul></li><li><a href=#跳过>跳过</a></li></ul></nav></div></div><div class=content id=content><h1 id=unittest>unittest</h1><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>import</span> <span class=err>unittest</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>class</span> <span class=err>TestStringMethods(unittest.TestCase):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>def</span> <span class=err>test_upper(self):</span>
</span></span><span class=line><span class=cl>        <span class=err>self.assertEqual(&#39;foo&#39;.upper(),</span> <span class=err>&#39;FOO&#39;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>def</span> <span class=err>test_isupper(self):</span>
</span></span><span class=line><span class=cl>        <span class=err>self.assertTrue(&#39;FOO&#39;.isupper())</span>
</span></span><span class=line><span class=cl>        <span class=err>self.assertFalse(&#39;Foo&#39;.isupper())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>def</span> <span class=err>test_split(self):</span>
</span></span><span class=line><span class=cl>        <span class=err>s</span> <span class=err>=</span> <span class=err>&#39;hello</span> <span class=err>world&#39;</span>
</span></span><span class=line><span class=cl>        <span class=err>self.assertEqual(s.split(),</span> <span class=p>[</span><span class=err>&#39;hello&#39;</span><span class=p>,</span> <span class=err>&#39;world&#39;</span><span class=p>]</span><span class=err>)</span>
</span></span><span class=line><span class=cl>        <span class=err>#</span> <span class=err>check</span> <span class=err>that</span> <span class=err>s.split</span> <span class=err>fails</span> <span class=err>when</span> <span class=err>the</span> <span class=err>separator</span> <span class=err>is</span> <span class=err>not</span> <span class=err>a</span> <span class=err>string</span>
</span></span><span class=line><span class=cl>        <span class=err>with</span> <span class=err>self.assertRaises(TypeError):</span>
</span></span><span class=line><span class=cl>            <span class=err>s.split(</span><span class=mi>2</span><span class=err>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>if</span> <span class=err>__name__</span> <span class=err>==</span> <span class=err>&#39;__main__&#39;:</span>
</span></span><span class=line><span class=cl>    <span class=err>unittest.main()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=mock>Mock</h2><blockquote><p>更详细的介绍：https://www.cnblogs.com/guyuyun/p/14880885.html</p><p>官方文档：https://docs.python.org/zh-cn/3/library/unittest.mock.html#quick-guide</p></blockquote><p><a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#module-unittest.mock target=_blank rel="external nofollow noopener noreferrer"><code>unittest.mock</code></a> 是一个用于测试的 Python 库。它允许使用模拟对象来替换受测系统的一些部分，并对这些部分如何被使用进行断言判断。</p><p>在进行单元测试的时候，会遇到以下问题：</p><ul><li>接口的依赖</li><li>外部接口调用</li></ul><p>测试环境非常复杂。</p><p>且单元测试应该只针对当前单元进行测试, 所有的内部或外部的依赖应该是稳定的, 已经在别处进行测试过的。使用 mock 就可以对外部依赖组件实现进行模拟并且替换掉, 从而使得单元测试将焦点只放在当前的单元功能。</p><h3 id=快速上手>快速上手</h3><p>当您访问对象时， <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock target=_blank rel="external nofollow noopener noreferrer"><code>Mock</code></a> 和 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.MagicMock target=_blank rel="external nofollow noopener noreferrer"><code>MagicMock</code></a> 将创建所有属性和方法，并保存他们在使用时的细节。你可以通过配置，指定返回值或者限制可访问属性，然后断言他们如何被调用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>MagicMock</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>thing</span> <span class=o>=</span> <span class=n>ProductionClass</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>thing</span><span class=o>.</span><span class=n>method</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>thing</span><span class=o>.</span><span class=n>method</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=s1>&#39;value&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>thing</span><span class=o>.</span><span class=n>method</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=s1>&#39;value&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>通过 <code>side_effect</code> 设置副作用 (side effects) ，可以是一个 mock 被调用时抛出的异常：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>Mock</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>side_effect</span><span class=o>=</span><span class=ne>KeyError</span><span class=p>(</span><span class=s1>&#39;foo&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>KeyError</span><span class=p>:</span> <span class=s1>&#39;foo&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>也可以是一个函数，一个列表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>values</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;a&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>side_effect</span><span class=p>(</span><span class=n>arg</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=n>values</span><span class=p>[</span><span class=n>arg</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=n>side_effect</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>),</span> <span class=n>mock</span><span class=p>(</span><span class=s1>&#39;b&#39;</span><span class=p>),</span> <span class=n>mock</span><span class=p>(</span><span class=s1>&#39;c&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=p>[</span><span class=mi>5</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(),</span> <span class=n>mock</span><span class=p>(),</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Mock 还可以通过其他方法配置和控制其行为。例如 mock 可以通过设置 <em>spec</em> 参数来从一个对象中获取其规格 (specification)。如果访问 mock 的属性或方法不在 spec 中，会报 <a href=https://docs.python.org/zh-cn/3/library/exceptions.html#AttributeError target=_blank rel="external nofollow noopener noreferrer"><code>AttributeError</code></a> 错误。</p><p>使用 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.patch target=_blank rel="external nofollow noopener noreferrer"><code>patch()</code></a> 装饰去/上下文管理器，可以更方便地测试一个模块下的类或对象。你指定的对象会在测试过程中替换成 mock （或者其他对象），测试结束后恢复。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>patch</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;module.ClassName2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;module.ClassName1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=k>def</span> <span class=nf>test</span><span class=p>(</span><span class=n>MockClass1</span><span class=p>,</span> <span class=n>MockClass2</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>module</span><span class=o>.</span><span class=n>ClassName1</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>module</span><span class=o>.</span><span class=n>ClassName2</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>assert</span> <span class=n>MockClass1</span> <span class=ow>is</span> <span class=n>module</span><span class=o>.</span><span class=n>ClassName1</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>assert</span> <span class=n>MockClass2</span> <span class=ow>is</span> <span class=n>module</span><span class=o>.</span><span class=n>ClassName2</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>assert</span> <span class=n>MockClass1</span><span class=o>.</span><span class=n>called</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>assert</span> <span class=n>MockClass2</span><span class=o>.</span><span class=n>called</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>test</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>当你嵌套 patch 装饰器时，mock 将以执行顺序传递给装饰器函数（<em>Python</em> 装饰器正常顺序）。由于从下至上，因此在上面的示例中，mock 传入的首先是 <code>module.ClassName1</code> 。</p></blockquote><p><a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.patch target=_blank rel="external nofollow noopener noreferrer"><code>patch()</code></a> 也可以 with 语句中使用上下文管理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>with</span> <span class=n>patch</span><span class=o>.</span><span class=n>object</span><span class=p>(</span><span class=n>ProductionClass</span><span class=p>,</span> <span class=s1>&#39;method&#39;</span><span class=p>,</span> <span class=n>return_value</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock_method</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>thing</span> <span class=o>=</span> <span class=n>ProductionClass</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>thing</span><span class=o>.</span><span class=n>method</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock_method</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>还有一个 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.patch.dict target=_blank rel="external nofollow noopener noreferrer"><code>patch.dict()</code></a> 用于在一定范围内设置字典中的值，并在测试结束时将字典恢复为其原始状态：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>foo</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;key&#39;</span><span class=p>:</span> <span class=s1>&#39;value&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>original</span> <span class=o>=</span> <span class=n>foo</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>with</span> <span class=n>patch</span><span class=o>.</span><span class=n>dict</span><span class=p>(</span><span class=n>foo</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;newkey&#39;</span><span class=p>:</span> <span class=s1>&#39;newvalue&#39;</span><span class=p>},</span> <span class=n>clear</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>assert</span> <span class=n>foo</span> <span class=o>==</span> <span class=p>{</span><span class=s1>&#39;newkey&#39;</span><span class=p>:</span> <span class=s1>&#39;newvalue&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>assert</span> <span class=n>foo</span> <span class=o>==</span> <span class=n>original</span>
</span></span></code></pre></td></tr></table></div></div><p>Mock 支持 Python <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#magic-methods target=_blank rel="external nofollow noopener noreferrer">魔术方法</a> 。使用魔术方法最简单的方式是使用 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.MagicMock target=_blank rel="external nofollow noopener noreferrer"><code>MagicMock</code></a> class. 。它可以做如下事情：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=fm>__str__</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=s1>&#39;foobarbaz&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>str</span><span class=p>(</span><span class=n>mock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;foobarbaz&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=fm>__str__</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Mock 能指定函数（或其他 Mock 实例）为魔术方法，它们将被适当地调用。 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.MagicMock target=_blank rel="external nofollow noopener noreferrer"><code>MagicMock</code></a> 是预先创建了所有魔术方法（所有有用的方法） 的 Mock 。</p><p>下面是一个使用了普通 Mock 类的魔术方法的例子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=fm>__str__</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=s1>&#39;wheeeeee&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>str</span><span class=p>(</span><span class=n>mock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;wheeeeee&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#auto-speccing target=_blank rel="external nofollow noopener noreferrer">auto-speccing</a> 可以保证测试中的模拟对象与要替换的对象具有相同的 api 。在 patch 中可以通过 <em>autospec</em> 参数实现自动推断，或者使用 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.create_autospec target=_blank rel="external nofollow noopener noreferrer"><code>create_autospec()</code></a> 函数。自动推断会创建一个与要替换对象相同的属相和方法的模拟对象，并且任何函数和方法（包括构造函数）都具有与真实对象相同的调用签名。</p><p>这么做是为了因确保不当地使用 mock 导致与生产代码相同的失败：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>create_autospec</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>function</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock_function</span> <span class=o>=</span> <span class=n>create_autospec</span><span class=p>(</span><span class=n>function</span><span class=p>,</span> <span class=n>return_value</span><span class=o>=</span><span class=s1>&#39;fishy&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock_function</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;fishy&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock_function</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock_function</span><span class=p>(</span><span class=s1>&#39;wrong arguments&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>TypeError</span><span class=p>:</span> <span class=o>&lt;</span><span class=k>lambda</span><span class=o>&gt;</span><span class=p>()</span> <span class=n>takes</span> <span class=n>exactly</span> <span class=mi>3</span> <span class=n>arguments</span> <span class=p>(</span><span class=mi>1</span> <span class=n>given</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>在类中使用 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.create_autospec target=_blank rel="external nofollow noopener noreferrer"><code>create_autospec()</code></a> 时，会复制 <code>__init__</code> 方法的签名，另外在可调用对象上使用时，会复制 <code>__call__</code> 方法的签名。</p><h3 id=mock-和-magicmock-对象>Mock 和 MagicMock 对象</h3><p>Mock 对象可以用来模拟对象、属性和方法，Mock 对象也会记录自身被使用的过程，你可以通过相关 assert 方法来测试验证代码是否被执行过。MagicMock 类是 Mock 类的一个子类，它实现了所有常用的 magic 方法。</p><h4 id=mock-构造函数>Mock 构造函数</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>unittest</span><span class=o>.</span><span class=n>mock</span><span class=o>.</span><span class=n>Mock</span><span class=p>(</span><span class=n>spec</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>side_effect</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>return_value</span><span class=o>=</span><span class=n>DEFAULT</span><span class=p>,</span> <span class=n>wraps</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>spec_set</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>unsafe</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>==spec==： 可传入一个字符串列表、类或者实例<ul><li>访问（get 操作）任何不在此列表中的属性和方法时都会抛出 AttributeError。</li><li>如果传入的是类或者实例对象，那么将会使用 <code>dir</code> 方法将该类或实例转化为一个字符串列表（magic 属性和方法除外）</li><li>如果传入的是一个类或者实例对象，那么 <code>__class__</code> 方法会返回对应的类，以便在使用 <code>isinstance</code> 方法时进行判断。</li></ul></li><li>spec_set： spec 参数的变体，但更加严格，如果试图使用 get 操作或 set 操作来操作此参数指定的对象中没有的属性或方法，则会抛出 AttributeError<ul><li>而 spec 参数是可以对 spec 指定对象中没有的属性进行 set 操作的。参考 <code>mock_add_spec</code> 方法。</li></ul></li><li>==side_effect==：可以传入一个函数，<strong>每次当 Mock 对象被调用的时候，就会自动调用该函数</strong>，可以用于抛出异常或者动态改变 mock 对象的返回值<ul><li>此函数使用的参数与 mock 对象被调用时传入的参数是一样的。</li><li>也可以传入一个 exception 对象或者实例对象，如果传入 exception 对象，则每次调用 mock 对象都会抛出该异常。</li><li>也可以传入一个可迭代对象，每次调用 mock 对象时就会返回该迭代对象的下一个值。</li></ul></li><li>==return_value==： 每次调用 mock 对象时的返回值，默认第一次调用时创建新的 Mock 对象。</li><li>name： 指定 mock 对象的名称，可在 debug 的时候使用，并且可以 “传播” 到子类中。</li><li>其他参数详见官方文档</li></ul><h4 id=magicmock-构造函数>MagicMock 构造函数</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>unittest</span><span class=o>.</span><span class=n>mock</span><span class=o>.</span><span class=n>MagicMock</span><span class=p>(</span><span class=o>**</span><span class=n>args</span><span class=o>*</span><span class=p>,</span> <span class=o>***</span><span class=n>kw</span><span class=o>*</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>MagicMock</code> 是包含了大部分魔术方法的默认实现的 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock target=_blank rel="external nofollow noopener noreferrer"><code>Mock</code></a> 的子类。 你可以使用 <code>MagicMock</code> 而无须自行配置魔术方法。</p><p>构造器形参的含义与 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock target=_blank rel="external nofollow noopener noreferrer"><code>Mock</code></a> 的相同。</p><p>魔术方法是通过 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.MagicMock target=_blank rel="external nofollow noopener noreferrer"><code>MagicMock</code></a> 对象来设置的，因此你可以用通常的方式来配置它们并使用它们:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;fish&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=fm>__setitem__</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=s1>&#39;fish&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=fm>__getitem__</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=s1>&#39;result&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;result&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>在默认情况下许多协议方法都需要返回特定类型的对象。 这些方法都预先配置了默认的返回值，以便它们在你对返回值不感兴趣时可以不做任何事就能被使用。 如果你想要修改默认值则你仍然可以手动 <em>设置</em> 返回值。</p><p>方法及其默认返回值:</p><ul><li><code>__lt__</code>: <code>NotImplemented</code></li><li><code>__gt__</code>: <code>NotImplemented</code></li><li><code>__le__</code>: <code>NotImplemented</code></li><li><code>__ge__</code>: <code>NotImplemented</code></li><li><code>__int__</code>: <code>1</code></li><li><code>__contains__</code>: <code>False</code></li><li><code>__len__</code>: <code>0</code></li><li><code>__iter__</code>: <code>iter([])</code></li><li><code>__exit__</code>: <code>False</code></li><li><code>__aexit__</code>: <code>False</code></li><li><code>__complex__</code>: <code>1j</code></li><li><code>__float__</code>: <code>1.0</code></li><li><code>__bool__</code>: <code>True</code></li><li><code>__index__</code>: <code>1</code></li><li><code>__hash__</code>: mock 的默认 hash</li><li><code>__str__</code>: mock 的默认 str</li><li><code>__sizeof__</code>: mock 的默认 sizeof</li></ul><p>例如:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>int</span><span class=p>(</span><span class=n>mock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>mock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>list</span><span class=p>(</span><span class=n>mock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>object</span><span class=p>()</span> <span class=ow>in</span> <span class=n>mock</span>
</span></span><span class=line><span class=cl><span class=kc>False</span>
</span></span></code></pre></td></tr></table></div></div><p>两个相等性方法 <code>__eq__()</code> 和 <code>__ne__()</code> 是特殊的。 它们基于标识号进行默认的相等性比较，使用 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock.side_effect target=_blank rel="external nofollow noopener noreferrer"><code>side_effect</code></a> 属性，除非你修改它们的返回值以返回其他内容:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>MagicMock</span><span class=p>()</span> <span class=o>==</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>MagicMock</span><span class=p>()</span> <span class=o>!=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=fm>__eq__</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>==</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><p><code>MagicMock.__iter__()</code> 的返回值可以是任意可迭代对象而不要求必须是迭代器:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=fm>__iter__</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>list</span><span class=p>(</span><span class=n>mock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>list</span><span class=p>(</span><span class=n>mock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>list</span><span class=p>(</span><span class=n>mock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>如果返回值是迭代器，则对其执行一次迭代就会将它耗尽因而后续执行的迭代将会输出空列表:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=fm>__iter__</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=nb>iter</span><span class=p>([</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>list</span><span class=p>(</span><span class=n>mock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>list</span><span class=p>(</span><span class=n>mock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[]</span>
</span></span></code></pre></td></tr></table></div></div><p><code>MagicMock</code> 已配置了所有受支持的魔术方法，只有某些晦涩和过时的魔术方法是例外。 如果你需要仍然可以设置它们。</p><p>在 <code>MagicMock</code> 中受到支持但默认未被设置的魔术方法有:</p><ul><li><code>__subclasses__</code></li><li><code>__dir__</code></li><li><code>__format__</code></li><li><code>__get__</code>, <code>__set__</code> 和 <code>__delete__</code></li><li><code>__reversed__</code> 和 <code>__missing__</code></li><li><code>__reduce__</code>, <code>__reduce_ex__</code>, <code>__getinitargs__</code>, <code>__getnewargs__</code>, <code>__getstate__</code> 和 <code>__setstate__</code></li><li><code>__getformat__</code></li></ul><h3 id=常用方法>常用方法</h3><h4 id=assert_called><code>assert_called()</code></h4><p>断言 mock 对象至少被调用过一次。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>method</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Mock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.method()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;...&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>method</span><span class=o>.</span><span class=n>assert_called</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=assert_called_once><code>assert_called_once()</code></h4><p>断言 mock 对象只被调用过一次。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>method</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Mock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.method()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;...&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>method</span><span class=o>.</span><span class=n>assert_called_once</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>method</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Mock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.method()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;...&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>method</span><span class=o>.</span><span class=n>assert_called_once</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>AssertionError</span><span class=p>:</span> <span class=n>Expected</span> <span class=s1>&#39;method&#39;</span> <span class=n>to</span> <span class=n>have</span> <span class=n>been</span> <span class=n>called</span> <span class=n>once</span><span class=o>.</span> <span class=n>Called</span> <span class=mi>2</span> <span class=n>times</span><span class=o>.</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=assert_called_withargs-kwargs><code>assert_called_with(*args, **kwargs)</code></h4><p>断言 mock 对象<strong>最后一次</strong>被调用的方式。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>Mock</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>method</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>test</span><span class=o>=</span><span class=s1>&#39;wow&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Mock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.method()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;2956280756552&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>method</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>test</span><span class=o>=</span><span class=s1>&#39;wow&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=assert_called_once_withargs-kwargs><code>assert_called_once_with(*args, **kwargs)</code></h4><p>断言 mock 对象以指定方式只被调用过一次。</p><h4 id=assert_any_callargs-kwargs><code>assert_any_call(*args, **kwargs)</code></h4><p>断言 mock 对象以指定方式被调用过。</p><h4 id=assert_has_callscalls-any_orderfalse><code>assert_has_calls(calls, any_order=False)</code></h4><p>断言 mock 对象以 calls 中指定的调用方式被调用过。</p><ul><li>calls 是一个 <code>unittest.mock.call</code> 对象列表，any_order 默认为 False，表示 calls 中的对象必须按照原来的调用顺序传入，为 True 则表示可以是任意顺序。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>Mock</span><span class=p>,</span> <span class=n>call</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>calls</span> <span class=o>=</span> <span class=p>[</span><span class=n>call</span><span class=p>(</span><span class=mi>2</span><span class=p>),</span> <span class=n>call</span><span class=p>(</span><span class=mi>3</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>assert_has_calls</span><span class=p>(</span><span class=n>calls</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>calls</span> <span class=o>=</span> <span class=p>[</span><span class=n>call</span><span class=p>(</span><span class=mi>4</span><span class=p>),</span> <span class=n>call</span><span class=p>(</span><span class=mi>2</span><span class=p>),</span> <span class=n>call</span><span class=p>(</span><span class=mi>3</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>assert_has_calls</span><span class=p>(</span><span class=n>calls</span><span class=p>,</span> <span class=n>any_order</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=assert_not_called><code>assert_not_called()</code></h4><p>断言 mock 对象没有被调用过。</p><h4 id=reset_mock-return_valuefalse-side_effectfalse><code>reset_mock(*, return_value=False, side_effect=False)</code></h4><p>重置所有调用相关的属性，但是默认不会改变它的 return_value 和 side_effect，以及其他属性。</p><ul><li>如果你想要重置 return_value 或 side_effect，则要为相应的形参传入 <code>True</code>。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>Mock</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=s1>&#39;hi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(</span><span class=s1>&#39;hello&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;hi&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>called</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>reset_mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>called</span>
</span></span><span class=line><span class=cl><span class=kc>False</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=mock_add_specspec-spec_setfalse><code>mock_add_spec(spec, spec_set=False)</code></h4><p>spec 参数可以是一个对象或者一个字符串列表，如果指定了此参数，那么只有 spec 指定的属性才可以进行访问（get 操作）。如果 spec_set 设置为 True，那么只有 spec 中指定的属性才可以进行 set 操作。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>mock_add_spec</span><span class=p>(</span><span class=n>spec</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;test_spec&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>test_spec</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Mock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.test_spec&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;1504477311816&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>new_test_spec</span>  <span class=c1># 只能访问spec指定的属性</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>AttributeError</span><span class=p>:</span> <span class=n>Mock</span> <span class=nb>object</span> <span class=n>has</span> <span class=n>no</span> <span class=n>attribute</span> <span class=s1>&#39;new_test_spec&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>new_test_spec</span> <span class=o>=</span> <span class=s1>&#39;test spec!!!&#39;</span>  <span class=c1># 但是可以设置新的属性</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>new_test_spec</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;test spec!!!&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>mock_add_spec</span><span class=p>(</span><span class=n>spec</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;test_spec&#39;</span><span class=p>],</span> <span class=n>spec_set</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>new_test_spec3</span> <span class=o>=</span> <span class=s1>&#39;test spec3&#39;</span>  <span class=c1># spec_set设置为True后，将不能设置新的属性</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>AttributeError</span><span class=p>:</span> <span class=n>Mock</span> <span class=nb>object</span> <span class=n>has</span> <span class=n>no</span> <span class=n>attribute</span> <span class=s1>&#39;new_test_spec3&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=attach_mockmock-attribute><code>attach_mock(mock, attribute)</code></h4><p>将一个 mock 对象作为一个子属性添加到当前 mock 对象，并且会将其 name 值和 parent 关系进行替换。注意，此方法的调用会被记录在 <code>method_calls</code> 方法和 <code>mock_calls</code> 方法中。</p><h4 id=configure_mockkwargs><code>configure_mock(**kwargs)</code></h4><p>添加额外的属性到已经创建的 mock 对象，并且可以给属性添加 return_value 值和 side_effect 值。在创建 mock 对象时也可以用这种方式添加额外的属性。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>Mock</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>attrs</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;func.return_value&#39;</span><span class=p>:</span> <span class=s1>&#39;hello&#39;</span><span class=p>,</span> <span class=s1>&#39;side_func.side_effect&#39;</span><span class=p>:</span> <span class=ne>ValueError</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>configure_mock</span><span class=p>(</span><span class=o>**</span><span class=n>attrs</span><span class=p>)</span>  <span class=c1># 给已经创建的mock对象添加额外的属性</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>func</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;hello&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>side_func</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>ValueError</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>new_mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>other_attr</span><span class=o>=</span><span class=s1>&#39;hi&#39;</span><span class=p>,</span> <span class=o>**</span><span class=n>attrs</span><span class=p>)</span>  <span class=c1># 在创建mock对象时指定额外的属性，效果同configure_mock()方法</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>new_mock</span><span class=o>.</span><span class=n>other_attr</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;hi&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>new_mock</span><span class=o>.</span><span class=n>func</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;hello&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>new_mock</span><span class=o>.</span><span class=n>side_func</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>ValueError</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=常用属性>常用属性</h3><h4 id=called><strong>called</strong></h4><p>如果 mock 对象被调用过则返回 True，否则返回 False。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>called</span>
</span></span><span class=line><span class=cl><span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>called</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=call_count><strong>call_count</strong></h4><p>返回 mock 对象被调用的次数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>call_count</span>
</span></span><span class=line><span class=cl><span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>call_count</span>
</span></span><span class=line><span class=cl><span class=mi>2</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=return_value><strong>return_value</strong></h4><p>指定 mock 对象被调用时的返回值，也可以在创建 mock 对象时通过参数进行指定。如果没有进行指定，return_value 的默认值为一个 mock 对象，而且它就是一个正常的 mock 对象，你可以把它当成普通的 mock 对象进行其他操作。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=s1>&#39;hello&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;hello&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=s1>&#39;hi&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;hi&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>new_mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>new_mock</span><span class=o>.</span><span class=n>return_value</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Mock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;2064061578056&#39;</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=side_effect><strong>side_effect</strong></h4><p>这个属性可以是函数、可迭代对象或者异常（类或实例都可以），当 mock 对象被调用时， <code>side_effect</code> 属性对应的对象就会被调用一次。</p><ul><li>如果传入的是函数，那么它将在 mock 对象调用时被执行，且执行时此函数传入的参数与 mock 对象被调用时的参数是一致的<ul><li>此函数的返回值即 mock 被对象调用的返回值，但是如果函数的返回值是 <code>unittest.mock.DEFAULT</code> 对象，那么 mock 对象被调用的返回值就是它自身的 return_value 属性值。</li></ul></li><li>如果传入的是一个可迭代对象，那么这个对象将被用作产生一个迭代器，这个迭代器在每一次 mock 对象被调用时返回一个值，这个值可以是异常类的实例，也可以是一个普通的值，当然如果这个返回值是一个 <code>unittest.mock.DEFAULT</code> 对象，则返回 mock 对象本身的 return_value 属性值。</li></ul><p><code>side_effect</code> 是一个异常:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>Mock</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;hello&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>ValueError</span><span class=p>:</span> <span class=n>hello</span>
</span></span></code></pre></td></tr></table></div></div><p><code>side_effect</code> 是一个可迭代对象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>StopIteration</span>
</span></span></code></pre></td></tr></table></div></div><p><code>side_effect</code> 是一个 <code>unittest.mock.DEFAULT</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>DEFAULT</span><span class=p>,</span> <span class=n>Mock</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>side_func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=n>DEFAULT</span>
</span></span><span class=line><span class=cl><span class=o>...</span> 
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=s1>&#39;hi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=n>side_func</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;hi&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>创建 mock 对象时指定 <code>side_effect</code> 为一个函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>side_func</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=n>value</span> <span class=o>**</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=o>...</span> 
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>side_effect</span><span class=o>=</span><span class=n>side_func</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>9</span>
</span></span></code></pre></td></tr></table></div></div><p>将 <code>side_effect</code> 指定为 None，即可清除该选项：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>side_effect</span><span class=o>=</span><span class=ne>KeyError</span><span class=p>,</span> <span class=n>return_value</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>KeyError</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=call_args><strong>call_args</strong></h4><p>返回 mock 对象最近一次被调用时的参数，如果没有被调用过，则为 None。
也可以通过 <code>call_args.args</code> 和 <code>call_args.kwargs</code> 属性分别获取对应的位置参数和关键词参数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=s1>&#39;hello&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=n>mock</span><span class=o>.</span><span class=n>call_args</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(</span><span class=s1>&#39;aa&#39;</span><span class=p>,</span> <span class=s1>&#39;bb&#39;</span><span class=p>,</span> <span class=n>hi</span><span class=o>=</span><span class=s1>&#39;hi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;hello&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>call_args</span>
</span></span><span class=line><span class=cl><span class=n>call</span><span class=p>(</span><span class=s1>&#39;aa&#39;</span><span class=p>,</span> <span class=s1>&#39;bb&#39;</span><span class=p>,</span> <span class=n>hi</span><span class=o>=</span><span class=s1>&#39;hi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>mock</span><span class=o>.</span><span class=n>call_args</span><span class=p>,</span> <span class=nb>tuple</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>call_args</span> <span class=o>==</span> <span class=p>((</span><span class=s1>&#39;aa&#39;</span><span class=p>,</span> <span class=s1>&#39;bb&#39;</span><span class=p>),</span> <span class=p>{</span><span class=s1>&#39;hi&#39;</span><span class=p>:</span> <span class=s1>&#39;hi&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=call_args_list><strong>call_args_list</strong></h4><p>存储 mock 对象调用的列表，列表元素为 call 对象，在没有被调用之前为空列表。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>Mock</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>call_args_list</span>
</span></span><span class=line><span class=cl><span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(</span><span class=n>arg1</span><span class=o>=</span><span class=s1>&#39;hi&#39;</span><span class=p>,</span> <span class=n>arg2</span><span class=o>=</span><span class=s1>&#39;hello&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>call_args_list</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>call</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span> <span class=n>call</span><span class=p>(</span><span class=n>arg1</span><span class=o>=</span><span class=s1>&#39;hi&#39;</span><span class=p>,</span> <span class=n>arg2</span><span class=o>=</span><span class=s1>&#39;hello&#39;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>call_args_list</span> <span class=o>==</span> <span class=p>[((</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span> <span class=p>),</span> <span class=p>({</span><span class=s1>&#39;arg1&#39;</span><span class=p>:</span> <span class=s1>&#39;hi&#39;</span><span class=p>,</span> <span class=s1>&#39;arg2&#39;</span><span class=p>:</span> <span class=s1>&#39;hello&#39;</span><span class=p>},</span> <span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=method_calls><strong>method_calls</strong></h4><p>存储 mock 对象调用以及“调用的调用“的列表，列表元素为 call 对象，在没有被调用之前为空列表。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>method_calls</span>
</span></span><span class=line><span class=cl><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>func</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Mock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.func()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;2152783337672&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>pro</span><span class=o>.</span><span class=n>func2</span><span class=o>.</span><span class=n>attr</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Mock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.pro.func2.attr()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;2152784407496&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>method_calls</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>call</span><span class=o>.</span><span class=n>func</span><span class=p>(),</span> <span class=n>call</span><span class=o>.</span><span class=n>pro</span><span class=o>.</span><span class=n>func2</span><span class=o>.</span><span class=n>attr</span><span class=p>()]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=mock_calls><strong>mock_calls</strong></h4><p>存储 mock 对象所有类型调用的列表。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>call</span><span class=p>,</span> <span class=n>Mock</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Mock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;2152784400584&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>mock</span><span class=o>.</span><span class=n>func</span><span class=p>(</span><span class=n>a</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>result</span><span class=p>(</span><span class=mi>44</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Mock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.func()()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;2152771939848&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>top</span><span class=p>(</span><span class=n>a</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span><span class=o>.</span><span class=n>bottom</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Mock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.top().bottom()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;2152784434888&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>mock_calls</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>call</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span>
</span></span><span class=line><span class=cl> <span class=n>call</span><span class=o>.</span><span class=n>func</span><span class=p>(</span><span class=n>a</span><span class=o>=</span><span class=mi>3</span><span class=p>),</span>
</span></span><span class=line><span class=cl> <span class=n>call</span><span class=o>.</span><span class=n>func</span><span class=p>()(</span><span class=mi>44</span><span class=p>),</span>
</span></span><span class=line><span class=cl> <span class=n>call</span><span class=o>.</span><span class=n>top</span><span class=p>(</span><span class=n>a</span><span class=o>=</span><span class=mi>3</span><span class=p>),</span>
</span></span><span class=line><span class=cl> <span class=n>call</span><span class=o>.</span><span class=n>top</span><span class=p>()</span><span class=o>.</span><span class=n>bottom</span><span class=p>()]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>mock_calls</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=n>call</span><span class=o>.</span><span class=n>top</span><span class=p>(</span><span class=n>a</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>bottom</span><span class=p>()</span>  <span class=c1># 注意：子调用bottom是没有记录其父调用top的参数的</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=__class__><code>__class__</code></h4><p>如果 mock 对象指定了 spec 对象，则会返回 spec 对象的类型，也可以直接赋值。</p><p>这个属性主要是在 <code>isinstance</code> 进行判断的时候会用到。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>spec</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>mock</span><span class=p>,</span> <span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=vm>__class__</span> <span class=o>=</span> <span class=nb>dict</span>  <span class=c1># 如果不想特别去指定spec参数，可以直接进行赋值</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>mock</span><span class=p>,</span> <span class=nb>dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=其他-mock-类>其他 Mock 类</h3><h4 id=asyncmock-类>AsyncMock 类</h4><p><code>unittest.mock.AsyncMock</code> 是 MagicMock 的异步版本，AsyncMock 对象会像一个异步函数一样运行，它的调用的返回值是一个 awaitable 对象，这个 awaitable 对象返回 <code>side_effect</code> 或者 <code>return_value</code> 指定的值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>inspect</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>AsyncMock</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>AsyncMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>iscoroutinefunction</span><span class=p>(</span><span class=n>mock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>inspect</span><span class=o>.</span><span class=n>isawaitable</span><span class=p>(</span><span class=n>mock</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><p>如果 Mock 或者 MagicMock 的 spec 参数指定了一个异步的函数，那么对应 mock 对象的调用将返回一个协程对象。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>MagicMock</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>async</span> <span class=k>def</span> <span class=nf>async_func</span><span class=p>():</span> <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=o>...</span> 
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>async_func</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>MagicMock</span> <span class=n>spec</span><span class=o>=</span><span class=s1>&#39;function&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;1934190100048&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>coroutine</span> <span class=nb>object</span> <span class=n>AsyncMockMixin</span><span class=o>.</span><span class=n>_execute_mock_call</span> <span class=n>at</span> <span class=mh>0x000001C2568E8EC0</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>如果 Mock、MagicMock 或者 AsyncMock 的 spec 参数指定了带有同步或者异步函数的类，那么对于 Mock，所有的同步函数将被定义为 Mock 对象，对于 MagicMock 和 AsyncMock，所有同步函数将被定义为 MagicMock。而对于 Mock、MagicMock 或者 AsyncMock，所有的异步函数都将被定义为 AsyncMock 对象。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>class</span> <span class=nc>ExampleClass</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>def</span> <span class=nf>sync_foo</span><span class=p>():</span>
</span></span><span class=line><span class=cl><span class=o>...</span>         <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>async</span> <span class=k>def</span> <span class=nf>async_foo</span><span class=p>():</span>
</span></span><span class=line><span class=cl><span class=o>...</span>         <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a_mock</span> <span class=o>=</span> <span class=n>AsyncMock</span><span class=p>(</span><span class=n>ExampleClass</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a_mock</span><span class=o>.</span><span class=n>sync_foo</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>MagicMock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.sync_foo&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;1934183952000&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a_mock</span><span class=o>.</span><span class=n>async_foo</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>AsyncMock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.async_foo&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;1934183974272&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>Mock</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>ExampleClass</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>sync_foo</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Mock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.sync_foo&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;1934183980864&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>async_foo</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>AsyncMock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.async_foo&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;1934183978800&#39;</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=上手指南>上手指南</h3><blockquote><p>摘自 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock-examples.html target=_blank rel="external nofollow noopener noreferrer">https://docs.python.org/zh-cn/3/library/unittest.mock-examples.html</a></p></blockquote><p>使用 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock target=_blank rel="external nofollow noopener noreferrer"><code>Mock</code></a> 的常见场景：</p><ul><li>模拟函数调用</li><li>记录在对象上的方法调用</li></ul><h4 id=模拟方法调用>模拟方法调用</h4><p>你可能需要替换一个对象上的方法，用于确认此方法被系统中的其他部分调用过，并且调用时使用了正确的参数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>real</span> <span class=o>=</span> <span class=n>SomeClass</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>real</span><span class=o>.</span><span class=n>method</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;method&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>real</span><span class=o>.</span><span class=n>method</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=s1>&#39;value&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>MagicMock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;method()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;...&#39;</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>在多数示例中，<a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock target=_blank rel="external nofollow noopener noreferrer"><code>Mock</code></a> 与 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.MagicMock target=_blank rel="external nofollow noopener noreferrer"><code>MagicMock</code></a> 两个类可以相互替换，而 <code>MagicMock</code> 是一个更适用的类，通常情况下，使用它就可以了。</p></blockquote><p>如果 mock 被调用，它的 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock.called target=_blank rel="external nofollow noopener noreferrer"><code>called</code></a> 属性就会变成 <code>True</code>，更重要的是，我们可以使用 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock.assert_called_with target=_blank rel="external nofollow noopener noreferrer"><code>assert_called_with()</code></a> 或者 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock.assert_called_once_with target=_blank rel="external nofollow noopener noreferrer"><code>assert_called_once_with()</code></a> 方法来确认它在被调用时使用了正确的参数。</p><p>在如下的测试示例中，验证对于 <code>ProductionClass().method</code> 的调用会导致 <code>something</code> 的调用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>class</span> <span class=nc>ProductionClass</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>def</span> <span class=nf>method</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>         <span class=bp>self</span><span class=o>.</span><span class=n>something</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>def</span> <span class=nf>something</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>         <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>real</span> <span class=o>=</span> <span class=n>ProductionClass</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>real</span><span class=o>.</span><span class=n>something</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>real</span><span class=o>.</span><span class=n>method</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>real</span><span class=o>.</span><span class=n>something</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=对象上的方法调用的-mock>对象上的方法调用的 mock</h4><p>上一个例子中我们直接在对象上给方法打补丁以检查它是否被正确地调用。 另一个常见的用例是将一个对象传给一个方法（或被测试系统的某个部分）然后检查它是否以正确的方式被使用。</p><p>下面这个简单的 <code>ProductionClass</code> 具有一个 <code>closer</code> 方法。 如果它附带一个对象被调用那么它就会调用其中的 <code>close</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>class</span> <span class=nc>ProductionClass</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>def</span> <span class=nf>closer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>something</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>         <span class=n>something</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><p>所以为了测试它我们需要传入一个带有 <code>close</code> 方法的对象并检查它是否被正确地调用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>real</span> <span class=o>=</span> <span class=n>ProductionClass</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>real</span><span class=o>.</span><span class=n>closer</span><span class=p>(</span><span class=n>mock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>close</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>我们不需要做任何事来在我们的 mock 上提供 &lsquo;close&rsquo; 方法。 访问 close 的操作就会创建它。</p><h4 id=模拟类>模拟类</h4><p>一个常见的用例是模拟被测试的代码所实例化的类。 当你给一个类打上补丁，该类就会被替换为一个 mock。 实例是通过 <em>调用该类</em> 来创建的。 这意味着你要通过查看被模拟类的返回值来访问“mock 实例”。</p><p>在下面的例子中我们有一个函数 <code>some_function</code> 实例化了 <code>Foo</code> 并调用该实例中的一个方法。 对 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.patch target=_blank rel="external nofollow noopener noreferrer"><code>patch()</code></a> 的调用会将类 <code>Foo</code> 替换为一个 mock。 <code>Foo</code> 实例是调用该 mock 的结果，所以它是通过修改 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock.return_value target=_blank rel="external nofollow noopener noreferrer"><code>return_value</code></a> 来配置的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>some_function</span><span class=p>():</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>instance</span> <span class=o>=</span> <span class=n>module</span><span class=o>.</span><span class=n>Foo</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=n>instance</span><span class=o>.</span><span class=n>method</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s1>&#39;module.Foo&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>instance</span> <span class=o>=</span> <span class=n>mock</span><span class=o>.</span><span class=n>return_value</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>instance</span><span class=o>.</span><span class=n>method</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=s1>&#39;the result&#39;</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>result</span> <span class=o>=</span> <span class=n>some_function</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>assert</span> <span class=n>result</span> <span class=o>==</span> <span class=s1>&#39;the result&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=命名你的-mock>命名你的 mock</h4><p>给你的 mock 起个名字可能会很有用。 名字会显示在 mock 的 repr 中并在 mock 出现于测试失败消息中时可以帮助理解。 这个名字也会被传播给 mock 的属性或方法:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;foo&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>MagicMock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;foo&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;...&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>method</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>MagicMock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;foo.method&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;...&#39;</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=追踪所有的调用>追踪所有的调用</h4><p>通常你会想要追踪对某个方法的多次调用。 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock.mock_calls target=_blank rel="external nofollow noopener noreferrer"><code>mock_calls</code></a> 属性记录了所有对 mock 的子属性的调用 —— 并且还包括对它们的子属性的调用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>method</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>MagicMock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.method()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;...&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>attribute</span><span class=o>.</span><span class=n>method</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=mi>53</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>MagicMock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.attribute.method()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;...&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>mock_calls</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>call</span><span class=o>.</span><span class=n>method</span><span class=p>(),</span> <span class=n>call</span><span class=o>.</span><span class=n>attribute</span><span class=o>.</span><span class=n>method</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=mi>53</span><span class=p>)]</span>
</span></span></code></pre></td></tr></table></div></div><p>如果你做了一个有关 <code>mock_calls</code> 的断言并且有任何非预期的方法被调用，则断言将失败。 这很有用处，因为除了断言你所预期的调用已被执行，你还会检查它们是否以正确的顺序被执行并且没有额外的调用:</p><p>你使用 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.call target=_blank rel="external nofollow noopener noreferrer"><code>call</code></a> 对象来构造列表以便与 <code>mock_calls</code> 进行比较:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>expected</span> <span class=o>=</span> <span class=p>[</span><span class=n>call</span><span class=o>.</span><span class=n>method</span><span class=p>(),</span> <span class=n>call</span><span class=o>.</span><span class=n>attribute</span><span class=o>.</span><span class=n>method</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=mi>53</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>mock_calls</span> <span class=o>==</span> <span class=n>expected</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><p>然而，返回 mock 的调用的形参不会被记录，这意味着不可能追踪附带了重要形参的创建上级对象的嵌套调用:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>m</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>m</span><span class=o>.</span><span class=n>factory</span><span class=p>(</span><span class=n>important</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>deliver</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Mock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock.factory().deliver()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;...&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>m</span><span class=o>.</span><span class=n>mock_calls</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=n>call</span><span class=o>.</span><span class=n>factory</span><span class=p>(</span><span class=n>important</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>deliver</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=设置返回值和属性>设置返回值和属性</h4><p>在 mock 对象上设置返回值是非常容易的:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span></code></pre></td></tr></table></div></div><p>当然你也可以对 mock 上的方法做同样的操作:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>method</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>method</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span></code></pre></td></tr></table></div></div><p>返回值也可以在构造器中设置:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span></code></pre></td></tr></table></div></div><p>如果你需要在你的 mock 上设置一个属性，只需这样做:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>x</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span></code></pre></td></tr></table></div></div><p>有时你会想要模拟更复杂的情况，例如这个例子 <code>mock.connection.cursor().execute("SELECT 1")</code>。 如果我们希望这个调用返回一个列表，那么我们还必须配置嵌套调用的结果。</p><p>我们可以像这样使用 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.call target=_blank rel="external nofollow noopener noreferrer"><code>call</code></a> 在一个“链式调用”中构造调用集合以便随后方便地设置断言:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>cursor</span> <span class=o>=</span> <span class=n>mock</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>cursor</span><span class=o>.</span><span class=n>return_value</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;foo&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SELECT 1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;foo&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>expected</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SELECT 1&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>call_list</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>mock_calls</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>call</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>cursor</span><span class=p>(),</span> <span class=n>call</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;SELECT 1&#39;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>mock_calls</span> <span class=o>==</span> <span class=n>expected</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><p>对 <code>.call_list()</code> 的调用会将我们的调用对象转成一个代表链式调用的调用列表。</p><h4 id=通过-mock-引发异常>通过 mock 引发异常</h4><p>一个很有用的属性是 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock.side_effect target=_blank rel="external nofollow noopener noreferrer"><code>side_effect</code></a>。 如果你将该属性设为一个异常类或者实例那么当 mock 被调用时该异常将会被引发。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>side_effect</span><span class=o>=</span><span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;Boom!&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>Exception</span><span class=p>:</span> <span class=n>Boom</span><span class=err>!</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=附带影响函数和可迭代对象>附带影响函数和可迭代对象</h4><p><code>side_effect</code> 也可以被设为一个函数或可迭代对象。 <strong><code>side_effect</code> 作为可迭代对象的应用场景适用于你的 mock 将要被多次调用，并且你希望每次调用都返回不同的值的情况。</strong> 当你将 <code>side_effect</code> 设为一个可迭代对象时每次对 mock 的调用将返回可迭代对象的下一个值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>side_effect</span><span class=o>=</span><span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>6</span>
</span></span></code></pre></td></tr></table></div></div><p>对于更高级的用例，例如根据 mock 调用时附带的参数动态改变返回值，<code>side_effect</code> 可以指定一个函数。 该函数将附带与 mock 相同的参数被调用。 该函数所返回的就是调用所返回的对象:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>vals</span> <span class=o>=</span> <span class=p>{(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>):</span> <span class=mi>1</span><span class=p>,</span> <span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>):</span> <span class=mi>2</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>side_effect</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=n>vals</span><span class=p>[</span><span class=n>args</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>side_effect</span><span class=o>=</span><span class=n>side_effect</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>2</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=模拟异步迭代器>模拟异步迭代器</h4><p>从 Python 3.8 起，<code>AsyncMock</code> 和 <code>MagicMock</code> 支持通过 <code>__aiter__</code> 来模拟 <a href=https://docs.python.org/zh-cn/3/reference/datamodel.html#async-iterators target=_blank rel="external nofollow noopener noreferrer">异步迭代器</a>。 <code>__aiter__</code> 的 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock.return_value target=_blank rel="external nofollow noopener noreferrer"><code>return_value</code></a> 属性可以被用来设置要用于迭代的返回值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>  <span class=c1># AsyncMock also works here</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=fm>__aiter__</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=p>[</span><span class=n>i</span> <span class=k>async</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>mock</span><span class=p>]</span>  <span class=c1># 异步迭代</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=模拟异步上下文管理器>模拟异步上下文管理器</h4><p>从 Python 3.8 起，<code>AsyncMock</code> 和 <code>MagicMock</code> 支持通过 <code>__aenter__</code> 和 <code>__aexit__</code> 来模拟 <a href=https://docs.python.org/zh-cn/3/reference/datamodel.html#async-context-managers target=_blank rel="external nofollow noopener noreferrer">异步上下文管理器</a>。 在默认情况下，<code>__aenter__</code> 和 <code>__aexit__</code> 将为返回异步函数的 <code>AsyncMock</code> 实例。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>class</span> <span class=nc>AsyncContextManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>async</span> <span class=k>def</span> <span class=fm>__aenter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>         <span class=k>return</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>async</span> <span class=k>def</span> <span class=fm>__aexit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exc_type</span><span class=p>,</span> <span class=n>exc</span><span class=p>,</span> <span class=n>tb</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>         <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock_instance</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>AsyncContextManager</span><span class=p>())</span>  <span class=c1># AsyncMock also works here</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>async</span> <span class=k>with</span> <span class=n>mock_instance</span> <span class=k>as</span> <span class=n>result</span><span class=p>:</span>  <span class=c1># 异步上下文管理器</span>
</span></span><span class=line><span class=cl><span class=o>...</span>         <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock_instance</span><span class=o>.</span><span class=fm>__aenter__</span><span class=o>.</span><span class=n>assert_awaited_once</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock_instance</span><span class=o>.</span><span class=fm>__aexit__</span><span class=o>.</span><span class=n>assert_awaited_once</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=基于现有对象创建模拟对象>基于现有对象创建模拟对象</h4><p>使用模拟操作的一个问题是它会将你的测试与你的 mock 实现相关联而不是与你的真实代码相关联。 假设你有一个实现了 <code>some_method</code> 的类。 在对另一个类的测试中，你提供了一个 <em>同样</em> 提供了 <code>some_method</code> 的模拟该对象的 mock 对象。 如果后来你重构了第一个类，使得它不再具有 <code>some_method</code> —— 那么你的测试将继续保持通过，尽管现在你的代码已经被破坏了！</p><p><a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock target=_blank rel="external nofollow noopener noreferrer"><code>Mock</code></a> 允许你使用 spec 关键字参数来提供一个对象作为 mock 的规格说明。 在 mock 上访问不存在于你的规格说明对象中的方法 / 属性将立即引发一个属性错误。 如果你修改你的规格说明的实现，，那么使用了该类的测试将立即开始失败而不需要你在这些测试中实例化该类。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>spec</span><span class=o>=</span><span class=n>SomeClass</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>old_method</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>AttributeError</span><span class=p>:</span> <span class=nb>object</span> <span class=n>has</span> <span class=n>no</span> <span class=n>attribute</span> <span class=s1>&#39;old_method&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>使用规格说明还可以启用对 mock 的调用的更聪明的匹配操作，无论是否有将某些形参作为位置或关键字参数传入:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>f</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span> <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>spec</span><span class=o>=</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Mock</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;mock()&#39;</span> <span class=nb>id</span><span class=o>=</span><span class=s1>&#39;140161580456576&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=n>a</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>b</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>c</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>如果你想要让这些更聪明的匹配操作也适用于 mock 上的方法调用，你可以使用 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#auto-speccing target=_blank rel="external nofollow noopener noreferrer">auto-speccing</a>。</p><p>如果你想要更强形式的规格说明以防止设置任意属性并获取它们那么你可以使用 <em>spec_set</em> 来代替 <em>spec</em>。</p><h4 id=使用-side_effect-返回每个文件的内容>使用 side_effect 返回每个文件的内容</h4><p><a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.mock_open target=_blank rel="external nofollow noopener noreferrer"><code>mock_open()</code></a> 被用来为 <a href=https://docs.python.org/zh-cn/3/library/functions.html#open target=_blank rel="external nofollow noopener noreferrer"><code>open()</code></a> 方法打补丁。 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.Mock.side_effect target=_blank rel="external nofollow noopener noreferrer"><code>side_effect</code></a> 可被用来在每次调用中返回一个新的 Mock 对象。 这可被用来返回存储在字典中的每个文件的不同内容:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>mock_open</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DEFAULT</span> <span class=o>=</span> <span class=s2>&#34;default&#34;</span>
</span></span><span class=line><span class=cl><span class=n>data_dict</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;file1&#34;</span><span class=p>:</span> <span class=s2>&#34;data1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=s2>&#34;file2&#34;</span><span class=p>:</span> <span class=s2>&#34;data2&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>open_side_effect</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mock_open</span><span class=p>(</span><span class=n>read_data</span><span class=o>=</span><span class=n>data_dict</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>DEFAULT</span><span class=p>))()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s2>&#34;builtins.open&#34;</span><span class=p>,</span> <span class=n>side_effect</span><span class=o>=</span><span class=n>open_side_effect</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;file1&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>file1</span><span class=o>.</span><span class=n>read</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&#34;data1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;file2&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>file2</span><span class=o>.</span><span class=n>read</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&#34;data2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;file3&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>file2</span><span class=o>.</span><span class=n>read</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&#34;default&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=patch>patch</h3><p>它是一个装饰器，需要把你想模拟的函数写在里面，然后在后面的单元测试案例中为它赋一个具体实例，再用 return_value 来指定模拟的这个函数希望返回的结果就可以了，后面就是正常单元测试代码。</p><p>mock 提供了三个便捷的装饰器: <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.patch target=_blank rel="external nofollow noopener noreferrer"><code>patch()</code></a>, <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.patch.object target=_blank rel="external nofollow noopener noreferrer"><code>patch.object()</code></a> 和 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.patch.dict target=_blank rel="external nofollow noopener noreferrer"><code>patch.dict()</code></a>。</p><ul><li><code>patch</code> 接受单个字符串，其形式 <code>package.module.Class.attribute</code> 指明你要修补的属性。 它还可选择接受一个值用来替换指定的属性（或者类对象等等）。</li><li><code>patch.object</code> 接受一个类和你想要修补的属性名称，并可选择接受要用作补丁的值。</li></ul><h4 id=构造函数>构造函数</h4><p><code>unittest.mock.patch</code> 可以作为一个函数装饰器，类装饰器，或者上下文管理器（with 语句）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>unittest</span><span class=o>.</span><span class=n>mock</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>new</span><span class=o>=</span><span class=n>DEFAULT</span><span class=p>,</span> <span class=n>spec</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>create</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>spec_set</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>autospec</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>new_callable</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>target： 形如 <code>package.module.ClassName</code> 的字符串。<ul><li>target 值将会被 import 并创建一个新的对象，所以 target 字符串必须是在当前环境可以 import 的。</li><li>需要注意，如果 patch 被作为装饰器的话，只有在被装饰的函数执行时，target 的对象才会被创建，而不是运行装饰器的时候被创建。</li></ul></li><li>new：声明创建的对象 / 值，如果没有指定，则对于 async 函数会创建一个 AsyncMock 对象，对于其他的，则会创建一个 MagicMock 对象。<ul><li>如果 <code>patch()</code> 是作为一个装饰器，且 new 参数没有指定，则创建的 mock 对象将会作为一个额外（即放在被装饰函数原有的参数之后）的参数传入被装饰的函数。</li><li>如果 <code>patch()</code> 用在上下文管理器中，则创建的 mock 对象会被上下文管理器返回。</li></ul></li><li>spec 和 spec_set：会当作参数传入 MagicMock 中。如果创建的是 spec 或 spec_set 对象，可以设置 <code>spec=True</code> 或者 <code>spec_set=True</code>，以便让 patch 正常运行。</li><li>new_callable：与 new 功能类似，但传入的是一个类或者一个 callable 对象，并会使用此参数创建一个对象，默认情况下，对于 async 函数会创建一个 AsyncMock 对象，对于其他的，则会创建一个 MagicMock 对象。</li><li>create：默认为 False，如果指定为 True，那么当 patch 的对象或函数不存在时会自动创建，当真正的对象在运行过程中被程序创建后就删除 patch 出来的 mock 对象，这个参数特别适用于一些运行时创建的内容。<ul><li>如果想要 patch 的内容是 <code>builtin</code> 内建模块，则不用指定 <code>create=True</code> ，patch 会在运行时自动创建。</li></ul></li></ul><h4 id=mockpatch>@mock.patch</h4><p>patch 可以作为一个装饰器为函数创建一个 mock 对象并传入被装饰的函数。如果 patch 装饰的是一个类，那么将会返回一个 MagicMock 对象，当这个类在 test 方法中被实例化时，那么将会返回此 MagicMock 对象的 <code>return_value</code> 值</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>SomeClass</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;__main__.SomeClass&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>mock_someclass</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>mock_someclass</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>func</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;打印输出
</span></span></span><span class=line><span class=cl><span class=s1>2
</span></span></span><span class=line><span class=cl><span class=s1>3
</span></span></span><span class=line><span class=cl><span class=s1>&lt;MagicMock name=&#39;SomeClass&#39; id=&#39;1519607444288&#39;&gt;
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>如果 mock 了一个类，对该类的实例对象和真实的 class 进行 <code>isinstance</code> 判断，则需要指定 <code>spec=True</code> 。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Class</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>method</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>       <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>Original</span> <span class=o>=</span> <span class=n>Class</span>
</span></span><span class=line><span class=cl>    <span class=n>patcher</span> <span class=o>=</span> <span class=n>patch</span><span class=p>(</span><span class=s1>&#39;__main__.Class&#39;</span><span class=p>,</span> <span class=n>spec</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>MockClass</span> <span class=o>=</span> <span class=n>patcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>instance</span> <span class=o>=</span> <span class=n>MockClass</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># 如果不指定spec=True，则会抛出异常</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>instance</span><span class=p>,</span> <span class=n>Original</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>patcher</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>func</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>patch 默认创建的是 MagicMock 对象，如果想要创建一个指定的对象，就可以使用 <code>new_callable</code> 参数。甚至可以使用 <code>new_callable</code> 参数在 test case 中重定向输出。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>thing</span> <span class=o>=</span> <span class=nb>object</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s1>&#39;__main__.thing&#39;</span><span class=p>,</span> <span class=n>new_callable</span><span class=o>=</span><span class=n>NonCallableMock</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock_thing</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>thing</span> <span class=ow>is</span> <span class=n>mock_thing</span>
</span></span><span class=line><span class=cl>    <span class=n>thing</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;打印输出
</span></span></span><span class=line><span class=cl><span class=s1>Traceback (most recent call last):
</span></span></span><span class=line><span class=cl><span class=s1>  ...
</span></span></span><span class=line><span class=cl><span class=s1>TypeError: &#39;NonCallableMock&#39; object is not callable
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>io</span> <span class=kn>import</span> <span class=n>StringIO</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>foo</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Something&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;sys.stdout&#39;</span><span class=p>,</span> <span class=n>new_callable</span><span class=o>=</span><span class=n>StringIO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test</span><span class=p>(</span><span class=n>mock_stdout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>foo</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>mock_stdout</span><span class=o>.</span><span class=n>getvalue</span><span class=p>()</span> <span class=o>==</span> <span class=s1>&#39;Something</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>test</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>patch 中可以通过传参的方式给 mock 对象设置属性。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>patcher</span> <span class=o>=</span> <span class=n>patch</span><span class=p>(</span><span class=s1>&#39;__main__.thing&#39;</span><span class=p>,</span> <span class=n>first</span><span class=o>=</span><span class=s1>&#39;one&#39;</span><span class=p>,</span> <span class=n>second</span><span class=o>=</span><span class=s1>&#39;two&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock_thing</span> <span class=o>=</span> <span class=n>patcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock_thing</span><span class=o>.</span><span class=n>first</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;one&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock_thing</span><span class=o>.</span><span class=n>second</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;two&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>可以通过字典的方式来配置 mock 对象的属性。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>config</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;method.return_value&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=s1>&#39;other.side_effect&#39;</span><span class=p>:</span> <span class=ne>KeyError</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>patcher</span> <span class=o>=</span> <span class=n>patch</span><span class=p>(</span><span class=s1>&#39;__main__.thing&#39;</span><span class=p>,</span> <span class=o>**</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock_thing</span> <span class=o>=</span> <span class=n>patcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock_thing</span><span class=o>.</span><span class=n>method</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>mock_thing</span><span class=o>.</span><span class=n>other</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>KeyError</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=mockpatchobject>@mock.patch.object</h4><p>patch.object 用来给对象（target 参数）的成员（attribute 参数）进行 “mock”，其参数的用法和 patch 是一样的，且也可以使用参数的形式给创建的 mock 对象添加额外的属性。</p><p>如果被装饰的对象是类的话，可以使用 <code>patch.TEST_PREFIX</code> 指定哪些方法需要被 “mock”。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=nd>@mock.patch.object</span><span class=p>(</span><span class=n>类名</span><span class=err>，“</span><span class=n>类中函数名</span><span class=err>”</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>patch.object 被用来装饰一个函数的时候，那么被创建的 mock 对象会一个额外参数的形式传入被装饰的函数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=nd>@patch.object</span><span class=p>(</span><span class=n>SomeClass</span><span class=p>,</span> <span class=s1>&#39;class_method&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test</span><span class=p>(</span><span class=n>mock_method</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>SomeClass</span><span class=o>.</span><span class=n>class_method</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>mock_method</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>test</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest</span> <span class=kn>import</span> <span class=n>mock</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>unittest</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Count</span><span class=p>():</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># test Count class</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TestCount</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@mock.patch.object</span><span class=p>(</span><span class=n>Count</span><span class=p>,</span> <span class=s2>&#34;add&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_add</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mock_add</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>mock_add</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=mi>13</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>mock_add</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=mi>13</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># same as 👇</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_add</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>mock</span><span class=o>.</span><span class=n>patch</span><span class=o>.</span><span class=n>object</span><span class=p>(</span><span class=n>Count</span><span class=p>,</span> <span class=s2>&#34;add&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock_add</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>mock_add</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=mi>13</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>mock_add</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=mi>13</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>unittest</span><span class=o>.</span><span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=自上而下原则>自上而下原则</h4><p>如果 patch 多个外部函数，那么调用遵循<strong>自下而上</strong>的规则，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=nd>@mock.patch</span><span class=p>(</span><span class=s2>&#34;function_C&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nd>@mock.patch</span><span class=p>(</span><span class=s2>&#34;function_B&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nd>@mock.patch</span><span class=p>(</span><span class=s2>&#34;function_A&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_check_cmd_response</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mock_function_A</span><span class=p>,</span> <span class=n>mock_function_B</span><span class=p>,</span> <span class=n>mock_function_C</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>mock_function_A</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=s2>&#34;Function A return&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>mock_function_B</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=s2>&#34;Function B return&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>mock_function_C</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=s2>&#34;Function C return&#34;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>assertTrue</span><span class=p>(</span><span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>,</span> <span class=n>mock_function_A</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>assertTrue</span><span class=p>(</span><span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=s2>&#34;B&#34;</span><span class=p>,</span> <span class=n>mock_function_B</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>assertTrue</span><span class=p>(</span><span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=s2>&#34;C&#34;</span><span class=p>,</span> <span class=n>mock_function_C</span><span class=p>()))</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=patch-的位置>patch 的位置</h4><p><a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.patch target=_blank rel="external nofollow noopener noreferrer"><code>patch()</code></a> 通过（临时性地）修改某一个对象的 <em>名称</em> 指向另一个对象来发挥作用。 可以有多个名称指向任意单独对象，因此要让补丁起作用你必须确保已为被测试的系统所使用的名称打上补丁。</p><p>基本原则是你要在对象 <em>被查找</em> 的地方打补丁，这不一定就是它被定义的地方。 一组示例将有助于厘清这一点。</p><p>想像我们有一个想要测试的具有如下结构的项目:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>a</span><span class=o>.</span><span class=n>py</span>
</span></span><span class=line><span class=cl>    <span class=o>-&gt;</span> <span class=n>Defines</span> <span class=n>SomeClass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>b</span><span class=o>.</span><span class=n>py</span>
</span></span><span class=line><span class=cl>    <span class=o>-&gt;</span> <span class=kn>from</span> <span class=nn>a</span> <span class=kn>import</span> <span class=n>SomeClass</span>
</span></span><span class=line><span class=cl>    <span class=o>-&gt;</span> <span class=n>some_function</span> <span class=n>instantiates</span> <span class=n>SomeClass</span>
</span></span></code></pre></td></tr></table></div></div><p>现在我们要测试 <code>some_function</code> 但我们想使用 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.patch target=_blank rel="external nofollow noopener noreferrer"><code>patch()</code></a> 来模拟 <code>SomeClass</code>。 问题在于当我们导入模块 b 时，我们将必须让它从模块 a 导入 <code>SomeClass</code>。 如果我们使用 <a href=https://docs.python.org/zh-cn/3/library/unittest.mock.html#unittest.mock.patch target=_blank rel="external nofollow noopener noreferrer"><code>patch()</code></a> 来模拟 <code>a.SomeClass</code> 那么它将不会对我们的测试造成影响；模块 b 已经拥有对 <em>真正的</em> <code>SomeClass</code> 的引用因此看上去我们的补丁不会有任何影响。</p><p>关键在于对 <code>SomeClass</code> 打补丁操作是在它被使用（或它被查找）的地方。 在此情况下实际上 <code>some_function</code> 将在模块 b 中查找 <code>SomeClass</code>，而我们已经在那里导入了它。 补丁看上去应该是这样:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;b.SomeClass&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>但是，再考虑另一个场景，其中不是 <code>from a import SomeClass</code> 而是模块 b 执行了 <code>import a</code> 并且 <code>some_function</code> 使用了 <code>a.SomeClass</code>。 这两个导入形式都很常见。 在这种情况下我们要打补丁的类将在该模块中被查找因而我们必须改为对 <code>a.SomeClass</code> 打补丁:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;a.SomeClass&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=patch-的-start-和-stop-方法>patch 的 start 和 stop 方法</h4><p>如果不想使用装饰器或 with 语法而直接使用 patch，那么可以使用 patch 的 start 方法和 stop 方法。start 方法能直接返回对应的 mock 对象，而 stop 方法则是取消使用 patch，类似 with 语句的开始和结束。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>patcher</span> <span class=o>=</span> <span class=n>patch</span><span class=p>(</span><span class=s1>&#39;package.module.ClassName&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>package</span> <span class=kn>import</span> <span class=n>module</span>
</span></span><span class=line><span class=cl><span class=n>original</span> <span class=o>=</span> <span class=n>module</span><span class=o>.</span><span class=n>ClassName</span>
</span></span><span class=line><span class=cl><span class=n>new_mock</span> <span class=o>=</span> <span class=n>patcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=n>module</span><span class=o>.</span><span class=n>ClassName</span> <span class=ow>is</span> <span class=ow>not</span> <span class=n>original</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=n>module</span><span class=o>.</span><span class=n>ClassName</span> <span class=ow>is</span> <span class=n>new_mock</span>
</span></span><span class=line><span class=cl><span class=n>patcher</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=n>module</span><span class=o>.</span><span class=n>ClassName</span> <span class=ow>is</span> <span class=n>original</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=n>module</span><span class=o>.</span><span class=n>ClassName</span> <span class=ow>is</span> <span class=ow>not</span> <span class=n>new_mock</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 start 和 stop 方法的另一个典型例子是 test case 的 setUp 和 tearDown 方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyTest</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>patcher1</span> <span class=o>=</span> <span class=n>patch</span><span class=p>(</span><span class=s1>&#39;package.module.Class1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>patcher2</span> <span class=o>=</span> <span class=n>patch</span><span class=p>(</span><span class=s1>&#39;package.module.Class2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>MockClass1</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>patcher1</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>MockClass2</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>patcher2</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>tearDown</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>patcher1</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>patcher2</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_something</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>package</span><span class=o>.</span><span class=n>module</span><span class=o>.</span><span class=n>Class1</span> <span class=ow>is</span> <span class=bp>self</span><span class=o>.</span><span class=n>MockClass1</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>package</span><span class=o>.</span><span class=n>module</span><span class=o>.</span><span class=n>Class2</span> <span class=ow>is</span> <span class=bp>self</span><span class=o>.</span><span class=n>MockClass2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>MyTest</span><span class=p>(</span><span class=s1>&#39;test_something&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>调用了 start 后一定要记得调用 stop，也可以在最后使用 stopall 方法一次性 stop 所有使用了 start 方法的 patch 对象。</p><p>如果怕自己在最后忘记了调用 stop 方法，也可以在调用了 start 方法后，立即调用 <code>unittest.TestCase.addCleanup()</code> 方法，此方法会在最后自动调用 stop。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyTest</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>patcher</span> <span class=o>=</span> <span class=n>patch</span><span class=p>(</span><span class=s1>&#39;package.module.Class&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>MockClass</span> <span class=o>=</span> <span class=n>patcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>addCleanup</span><span class=p>(</span><span class=n>patcher</span><span class=o>.</span><span class=n>stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_something</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>package</span><span class=o>.</span><span class=n>module</span><span class=o>.</span><span class=n>Class</span> <span class=ow>is</span> <span class=bp>self</span><span class=o>.</span><span class=n>MockClass</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=一个示例>一个示例</h4><p>Count 类中 add_and_multiply 依赖 multiply，由于 multiply 并没有实现，这时候可以使用 mock 替换 multiply：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest</span> <span class=kn>import</span> <span class=n>mock</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>unittest</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Count</span><span class=p>():</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_and_multiply</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>addition</span> <span class=o>=</span> <span class=n>x</span> <span class=o>+</span> <span class=n>y</span>
</span></span><span class=line><span class=cl>        <span class=n>multiple</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>multiply</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>addition</span><span class=p>,</span> <span class=n>multiple</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>multiply</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># test Count class</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TestCount</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@mock.patch.object</span><span class=p>(</span><span class=n>Count</span><span class=p>,</span> <span class=s2>&#34;multiply&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_add</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mock_multiply</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>mock_multiply</span><span class=o>.</span> <span class=n>return_value</span> <span class=o>=</span> <span class=mi>40</span>
</span></span><span class=line><span class=cl>        <span class=n>count</span> <span class=o>=</span> <span class=n>Count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>addition</span><span class=p>,</span><span class=n>multiple</span> <span class=o>=</span> <span class=n>count</span><span class=o>.</span><span class=n>add_and_multiply</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>addition</span><span class=p>,</span><span class=mi>13</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>multiple</span><span class=p>,</span> <span class=mi>40</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>unittest</span><span class=o>.</span><span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=assert>assert</h2><h3 id=预览>预览</h3><p>assertEqual(a,b，[msg=&lsquo;测试失败时打印的信息&rsquo;])：若 a=b，则测试用例通过</p><p>assertNotEqual(a,b，[msg=&lsquo;测试失败时打印的信息&rsquo;])：若 a != b，则测试用例通过</p><p>assertTrue(x，[msg=&lsquo;测试失败时打印的信息&rsquo;])：若 x 是 True，则测试用例通过</p><p>assertFalse(x，[msg=&lsquo;测试失败时打印的信息&rsquo;])：若 x 是 False，则测试用例通过</p><p>assertIs(a,b，[msg=&lsquo;测试失败时打印的信息&rsquo;])：若 a 是 b，则测试用例通过</p><p>assertNotIs(a,b，[msg=&lsquo;测试失败时打印的信息&rsquo;])：若 a 不是 b，则测试用例通过</p><p>assertIsNone(x，[msg=&lsquo;测试失败时打印的信息&rsquo;])：若 x 是 None，则测试用例通过</p><p>assertIsNotNone(x，[msg=&lsquo;测试失败时打印的信息&rsquo;])：若 x 不是 None，则测试用例通过</p><p>assertIn(a,b，[msg=&lsquo;测试失败时打印的信息&rsquo;])：若 a 在 b 中，则测试用例通过</p><p>assertNotIn(a,b，[msg=&lsquo;测试失败时打印的信息&rsquo;])：若 a 不在 b 中，则测试用例通过</p><p>assertIsInstance(a,b，[msg=&lsquo;测试失败时打印的信息&rsquo;])：若 a 是 b 的一个实例，则测试用例通过</p><p>assertNotIsInstance(a,b，[msg=&lsquo;测试失败时打印的信息&rsquo;])：若 a 不是 b 的实例，则测试用例通过</p><p>assertAlmostEqual(a, b)：round(a-b, 7) == 0</p><p>assertNotAlmostEqual(a, b)：round(a-b, 7) != 0</p><p>assertGreater(a, b)：a > b</p><p>assertGreaterEqual(a, b)：a >= b</p><p>assertLess(a, b)：a &lt; b</p><p>assertLessEqual(a, b)：a &lt;= b</p><p>assertRegexpMatches(s, re)：regex.search(s)</p><p>assertNotRegexpMatches(s, re)：not regex.search(s)</p><p>assertItemsEqual(a, b)：sorted(a) == sorted(b) and works with unhashable objs</p><p>assertDictContainsSubset(a, b)：all the key/value pairs in a exist in b</p><p>assertMultiLineEqual(a, b)：strings</p><p>assertSequenceEqual(a, b)：sequences</p><p>assertListEqual(a, b)：lists</p><p>assertTupleEqual(a, b)：tuples</p><p>assertSetEqual(a, b)：sets or frozensets</p><p>assertDictEqual(a, b)：dicts</p><h3 id=assertraises>assertRaises()</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>assertRaises</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=n>exception</span><span class=p>,</span>  <span class=c1># 待验证异常类型</span>
</span></span><span class=line><span class=cl>  <span class=n>callable</span><span class=p>,</span>  <span class=c1># 待验证方法</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>args</span><span class=p>,</span>  <span class=c1># 待验证方法参数</span>
</span></span><span class=line><span class=cl>	<span class=o>**</span><span class=n>kwds</span> <span class=c1># 待验证方法参数(dict类型)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>功能说明</p><ul><li>验证异常测试</li><li>验证异常（第一个参数）是当调用待测试函数时，在传入相应的测试数据后，如果测试通过，则表明待测试函数抛出了预期的异常，否则测试失败。</li></ul><p>下面我们通过一个示例来进行演示，如果验证做除法时抛出除数不能为 0 的异常 ZeroDivisionError。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># _*_ coding:utf-8 _*_</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>__author__</span> <span class=o>=</span> <span class=s1>&#39;苦叶子&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>unittest</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=n>reload</span><span class=p>(</span><span class=n>sys</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sys</span><span class=o>.</span><span class=n>setdefaultencoding</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 除法函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>div</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>a</span><span class=o>/</span><span class=n>b</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=c1># 测试用例</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>demoRaiseTest</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_raise</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>assertRaises</span><span class=p>(</span><span class=ne>ZeroDivisionError</span><span class=p>,</span> <span class=n>div</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=c1># 主函数</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>unittest</span><span class=o>.</span><span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>test_raise 方法使用了 assertRaises 方法来断言验证 div 方法除数为零时抛出的异常。</p><p>运行 python raise_demo.py 结果如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>-------------------------------------
</span></span><span class=line><span class=cl>Ran <span class=m>1</span> <span class=nb>test</span> in 0.000s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>OK
</span></span></code></pre></td></tr></table></div></div><p>你还可以尝试调整下数据，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_raise</span><span class=p>(</span><span class=nb>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>self</span><span class=o>.</span><span class=n>assertRaises</span><span class=p>(</span><span class=no>ZeroDivisionError</span><span class=p>,</span> <span class=n>div</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>执行结果如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>F</span>
</span></span><span class=line><span class=cl><span class=o>=====================================</span>
</span></span><span class=line><span class=cl>FAIL: test_raise <span class=o>(</span>__main__.demoRaiseTest<span class=o>)</span>
</span></span><span class=line><span class=cl>----------------------------------------------------------------------
</span></span><span class=line><span class=cl>Traceback <span class=o>(</span>most recent call last<span class=o>)</span>:
</span></span><span class=line><span class=cl>  File <span class=s2>&#34;raise_demo.py&#34;</span>, line 18, in test_raise
</span></span><span class=line><span class=cl>    self.assertRaises<span class=o>(</span>ZeroDivisionError, div, 1,1<span class=o>)</span>
</span></span><span class=line><span class=cl>AssertionError: ZeroDivisionError not raised
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----------------------------------
</span></span><span class=line><span class=cl>Ran <span class=m>1</span> <span class=nb>test</span> in 0.000s
</span></span></code></pre></td></tr></table></div></div><h2 id=跳过>跳过</h2><p>在执行测试用例时，有时候有些用例是不需要执行的，直接删除代码是不妥的；unittest 提供了一些跳过指定用例的方法</p><ul><li><code>@unittest.skip(reason)</code>：强制跳转。reason 是跳转原因</li><li><code>@unittest.skipIf(condition, reason)</code>：condition 为 True 的时候跳转</li><li><code>@unittest.skipUnless(condition, reason)</code>：condition 为 False 的时候跳转</li><li><code>@unittest.expectedFailure</code>：如果 test 失败了，这个 test 不计入失败的 case 数目</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># coding = utf-8</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>unittest</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>warnings</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>selenium</span> <span class=kn>import</span> <span class=n>webdriver</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>
</span></span><span class=line><span class=cl><span class=c1># 驱动文件路径</span>
</span></span><span class=line><span class=cl><span class=n>driverfile_path</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;D:\coship\Test_Framework\drivers\IEDriverServer.exe&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CmsLoginTest</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 这行代码的作用是忽略一些告警打印</span>
</span></span><span class=line><span class=cl>        <span class=n>warnings</span><span class=o>.</span><span class=n>simplefilter</span><span class=p>(</span><span class=s2>&#34;ignore&#34;</span><span class=p>,</span> <span class=ne>ResourceWarning</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span> <span class=o>=</span> <span class=n>webdriver</span><span class=o>.</span><span class=n>Ie</span><span class=p>(</span><span class=n>executable_path</span><span class=o>=</span><span class=n>driverfile_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;http://172.21.13.83:28080/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>tearDown</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>quit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@unittest.skip</span><span class=p>(</span><span class=s2>&#34;用户名密码都为空用例不执行&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_login1</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#39;&#39;用户名、密码为空&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;#imageField&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>click</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>error_message1</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;[for=&#39;loginName&#39;]&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=n>error_message2</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;[for=&#39;textfield&#39;]&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>error_message1</span><span class=p>,</span> <span class=s1>&#39;用户名不能为空&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>error_message2</span><span class=p>,</span> <span class=s1>&#39;密码不能为空&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@unittest.skipIf</span><span class=p>(</span><span class=mi>3</span> <span class=o>&gt;</span> <span class=mi>2</span><span class=p>,</span> <span class=s2>&#34;3大于2，此用例不执行&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_login3</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#39;&#39;用户名、密码正确&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;[name=&#39;admin.loginName&#39;]&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>send_keys</span><span class=p>(</span><span class=s2>&#34;autotest&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;[name=&#39;admin.password&#39;]&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>send_keys</span><span class=p>(</span><span class=s2>&#34;111111&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;#imageField&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>click</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>switch_to</span><span class=o>.</span><span class=n>frame</span><span class=p>(</span><span class=s2>&#34;topFrame&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;#nav_top&gt;ul&gt;li&gt;a&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>username</span><span class=p>,</span><span class=s2>&#34;autotest&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@unittest.skipUnless</span><span class=p>(</span><span class=mi>3</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>,</span><span class=s2>&#34;2没有大于3，此用例不执行&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_login2</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#39;&#39;用户名正确，密码错误&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;[name=&#39;admin.loginName&#39;]&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>send_keys</span><span class=p>(</span><span class=s2>&#34;autotest&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;[name=&#39;admin.password&#39;]&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>send_keys</span><span class=p>(</span><span class=s2>&#34;123456&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;#imageField&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>click</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>error_message</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;.errorMessage&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>error_message</span><span class=p>,</span> <span class=s1>&#39;密码错误,请重新输入!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@unittest.expectedFailure</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_login4</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#39;&#39;用户名不存在&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;[name=&#39;admin.loginName&#39;]&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>send_keys</span><span class=p>(</span><span class=s2>&#34;test007&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;[name=&#39;admin.password&#39;]&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>send_keys</span><span class=p>(</span><span class=s2>&#34;123456&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;#imageField&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>click</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>error_message</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;.errorMessage&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>error_message</span><span class=p>,</span> <span class=s1>&#39;用户名不存在!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_login5</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#39;&#39;用户名为空&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;[name=&#39;admin.password&#39;]&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>send_keys</span><span class=p>(</span><span class=s2>&#34;123456&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;#imageField&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>click</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>error_message</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;[for=&#39;loginName&#39;]&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>error_message</span><span class=p>,</span> <span class=s1>&#39;用户不存在!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_login6</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#39;&#39;密码为空&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;[name=&#39;admin.loginName&#39;]&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>send_keys</span><span class=p>(</span><span class=s2>&#34;autotest&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;#imageField&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>click</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>error_message</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>driver</span><span class=o>.</span><span class=n>find_element_by_css_selector</span><span class=p>(</span><span class=s2>&#34;[for=&#39;textfield&#39;]&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>error_message</span><span class=p>,</span> <span class=s1>&#39;密码不能为空&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>unittest</span><span class=o>.</span><span class=n>main</span><span class=p>(</span><span class=n>verbosity</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>执行结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=s2>&#34;C:\Program Files\Python36\python.exe&#34;</span> D:/Git/Test_Framework/utils/cmslogin.py
</span></span><span class=line><span class=cl>test_login1 <span class=o>(</span>__main__.CmsLoginTest<span class=o>)</span>
</span></span><span class=line><span class=cl>用户名、密码为空 ... skipped <span class=s1>&#39;用户名密码都为空用例不执行&#39;</span>
</span></span><span class=line><span class=cl>test_login2 <span class=o>(</span>__main__.CmsLoginTest<span class=o>)</span>
</span></span><span class=line><span class=cl>用户名正确，密码错误 ... skipped <span class=s1>&#39;2没有大于3，此用例不执行&#39;</span>
</span></span><span class=line><span class=cl>test_login3 <span class=o>(</span>__main__.CmsLoginTest<span class=o>)</span>
</span></span><span class=line><span class=cl>用户名、密码正确 ... skipped <span class=s1>&#39;3大于2，此用例不执行&#39;</span>
</span></span><span class=line><span class=cl>test_login4 <span class=o>(</span>__main__.CmsLoginTest<span class=o>)</span>
</span></span><span class=line><span class=cl>用户名不存在 ... expected failure
</span></span><span class=line><span class=cl>test_login5 <span class=o>(</span>__main__.CmsLoginTest<span class=o>)</span>
</span></span><span class=line><span class=cl>用户名为空 ... FAIL
</span></span><span class=line><span class=cl>test_login6 <span class=o>(</span>__main__.CmsLoginTest<span class=o>)</span>
</span></span><span class=line><span class=cl>密码为空 ... <span class=nv>ok</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>======================================================================</span>
</span></span><span class=line><span class=cl>FAIL: test_login5 <span class=o>(</span>__main__.CmsLoginTest<span class=o>)</span>
</span></span><span class=line><span class=cl>用户名为空
</span></span><span class=line><span class=cl>----------------------------------------------------------------------
</span></span><span class=line><span class=cl>Traceback <span class=o>(</span>most recent call last<span class=o>)</span>:
</span></span><span class=line><span class=cl>  File <span class=s2>&#34;D:/Git/Test_Framework/utils/cmslogin.py&#34;</span>, line 71, in test_login5
</span></span><span class=line><span class=cl>    self.assertEqual<span class=o>(</span>error_message, <span class=s1>&#39;用户不存在!&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>AssertionError: <span class=s1>&#39;用户名不能为空&#39;</span> !<span class=o>=</span> <span class=s1>&#39;用户不存在!&#39;</span>
</span></span><span class=line><span class=cl>- 用户名不能为空
</span></span><span class=line><span class=cl>+ 用户不存在!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----------------------------------------------------------------------
</span></span><span class=line><span class=cl>Ran <span class=m>6</span> tests in 32.663s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>FAILED <span class=o>(</span><span class=nv>failures</span><span class=o>=</span>1, <span class=nv>skipped</span><span class=o>=</span>3, expected <span class=nv>failures</span><span class=o>=</span>1<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Process finished with <span class=nb>exit</span> code <span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2024-02-10 06:55:49">更新于 2024-02-10</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://trouvaille0198.github.io/Notes/posts/python/%E6%A0%87%E5%87%86%E5%BA%93/unittest/ data-title="Python unittest 库" data-hashtags=Python><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://trouvaille0198.github.io/Notes/posts/python/%E6%A0%87%E5%87%86%E5%BA%93/unittest/ data-hashtag=Python><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://trouvaille0198.github.io/Notes/posts/python/%E6%A0%87%E5%87%86%E5%BA%93/unittest/ data-title="Python unittest 库"><i class="fa-brands fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href=/Notes/tags/python/>Python</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/Notes/>主页</a></span></section></div><div class=post-nav><a href=/Notes/posts/python/%E5%B8%B8%E7%94%A8%E5%BA%93/warnings/ class=prev rel=prev title="Python warnings 库"><i class="fa-solid fa-angle-left fa-fw"></i>Python warnings 库</a>
<a href=/Notes/posts/python/%E5%B8%B8%E7%94%A8%E5%BA%93/ipdb/ class=next rel=next title="Python ipdb 库">Python ipdb 库<i class="fa-solid fa-angle-right fa-fw"></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line custom">酒困路长惟欲睡，日高人渴漫思茶</div><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2022 - 2024</span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><div id=mask></div></div><link rel=stylesheet href=/Notes/lib/katex/katex.min.css><link rel=stylesheet href=/Notes/lib/katex/copy-tex.min.css><link rel=stylesheet href=/Notes/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/Notes/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/Notes/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script type=text/javascript src=/Notes/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/Notes/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/Notes/lib/katex/katex.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/Notes/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:45},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"7I9AMOLA4S",algoliaIndex:"Notes",algoliaSearchKey:"3c1638dfe9f4d49a59d81ff6943416b8",highlightTag:"em",maxResultLength:30,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/Notes/js/theme.min.js defer></script><script type=text/javascript src=/Notes/js/_custom.min.js defer></script></body></html>