<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>SQLAlchemy - 伤心肠粉的酱油碟子</title><meta name=Description content><meta property="og:title" content="SQLAlchemy"><meta property="og:description" content="SQLAlchemy 认识 ORM：Object Relational Mapping（对象关系映射）将数据库中的表与类构建"><meta property="og:type" content="article"><meta property="og:url" content="https://trouvaille0198.github.io/Notes/posts/python/web-backend/sqlalchemy/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-23T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-02T14:39:59+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="SQLAlchemy"><meta name=twitter:description content="SQLAlchemy 认识 ORM：Object Relational Mapping（对象关系映射）将数据库中的表与类构建"><meta name=application-name content="伤心肠粉的酱油碟子"><meta name=apple-mobile-web-app-title content="伤心肠粉的酱油碟子"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://trouvaille0198.github.io/Notes/posts/python/web-backend/sqlalchemy/><link rel=prev href=https://trouvaille0198.github.io/Notes/posts/frontend/css/tailwind/><link rel=next href=https://trouvaille0198.github.io/Notes/posts/%E5%88%B7%E9%A2%98/back-tracking/46.-%E5%85%A8%E6%8E%92%E5%88%97/><link rel=stylesheet href=/Notes/lib/normalize/normalize.min.css><link rel=stylesheet href=/Notes/css/style.min.css><link rel=stylesheet href=/Notes/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/Notes/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"SQLAlchemy","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/python\/web-backend\/sqlalchemy\/"},"genre":"posts","keywords":"Python, 后端, 数据库, ORM","wordcount":3903,"url":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/python\/web-backend\/sqlalchemy\/","datePublished":"2021-10-23T00:00:00+00:00","dateModified":"2022-04-02T14:39:59+00:00","publisher":{"@type":"Organization","name":"MelonCholi"},"author":{"@type":"Person","name":"MelonCholi"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":''==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:''==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子>伤心肠粉</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/Notes/categories/>分类 </a><a class=menu-item href=/Notes/tags/>标签 </a><a class=menu-item href=/Notes/posts/>文章 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子>伤心肠粉</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/Notes/categories/ title>分类</a><a class=menu-item href=/Notes/tags/ title>标签</a><a class=menu-item href=/Notes/posts/ title>文章</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">SQLAlchemy</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/Notes/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>MelonCholi</a></span>&nbsp;<span class=post-category>收录于 <a href=/Notes/categories/python/><i class="far fa-folder fa-fw"></i>Python</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-10-23>2021-10-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 3903 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 8 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#认识>认识</a></li><li><a href=#快速入门>快速入门</a><ul><li><a href=#创建引擎>创建引擎</a></li><li><a href=#建立对象>建立对象</a></li><li><a href=#声名映射>声名映射</a></li><li><a href=#建立-pydantic-模型>建立 Pydantic 模型</a></li><li><a href=#crud>CRUD</a><ul><li><a href=#读>读</a></li><li><a href=#建>建</a></li><li><a href=#改>改</a></li><li><a href=#删>删</a></li></ul></li><li><a href=#创建表>创建表</a></li></ul></li><li><a href=#概念>概念</a><ul><li><a href=#engine>Engine</a></li><li><a href=#session>Session</a></li></ul></li><li><a href=#column-参数>Column 参数</a></li><li><a href=#query>query</a><ul><li><a href=#get>get</a></li><li><a href=#filter>filter</a></li><li><a href=#filter_by>filter_by</a></li><li><a href=#返回列表-list-和单项-scalar>返回列表 (List) 和单项 (Scalar)</a></li><li><a href=#嵌入使用-sql>嵌入使用 SQL</a></li></ul></li><li><a href=#关系>关系</a><ul><li><a href=#一对多>一对多</a></li><li><a href=#多对一>多对一</a></li><li><a href=#一对一>一对一</a></li><li><a href=#多对多>多对多</a></li></ul></li><li><a href=#技巧>技巧</a><ul><li><a href=#relationship-中-lazy-属性详解><code>relationship()</code> 中 <code>lazy</code> 属性详解</a></li><li><a href=#关于更新数据的讨论>关于更新数据的讨论</a></li><li><a href=#关于插入大量数据的讨论>关于插入大量数据的讨论</a></li><li><a href=#级联删除>级联删除</a></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=sqlalchemy>SQLAlchemy</h1><h2 id=认识>认识</h2><p>ORM：Object Relational Mapping（对象关系映射）将数据库中的表与类构建映射</p><ul><li>简洁易读：将数据表抽象为对象（数据模型），更直观易读</li><li>可移植：封装了多种数据库引擎，面对多个数据库，操作基本一致，代码易维护</li><li>更安全：有效避免 SQL 注入</li></ul><p>数据库与 python 对象的映射</p><ul><li>数据库表 (table）映射为 Python 的类 (class)，称为 model</li><li>表的字段 (field) 映射为 Column</li><li>表的记录 (record）以类的实例 (instance) 来表示</li></ul><h2 id=快速入门>快速入门</h2><p>FastAPI 的文件结构</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=err>└──</span> <span class=n>sql_app</span>
</span></span><span class=line><span class=cl>    <span class=err>├──</span> <span class=fm>__init__</span><span class=o>.</span><span class=n>py</span>
</span></span><span class=line><span class=cl>    <span class=err>├──</span> <span class=n>crud</span><span class=o>.</span><span class=n>py</span> <span class=c1># 增删查改</span>
</span></span><span class=line><span class=cl>    <span class=err>├──</span> <span class=n>database</span><span class=o>.</span><span class=n>py</span> <span class=c1># 创建引擎</span>
</span></span><span class=line><span class=cl>    <span class=err>├──</span> <span class=n>main</span><span class=o>.</span><span class=n>py</span>
</span></span><span class=line><span class=cl>    <span class=err>├──</span> <span class=n>models</span><span class=o>.</span><span class=n>py</span> <span class=c1># 声明映射</span>
</span></span><span class=line><span class=cl>    <span class=err>└──</span> <span class=n>schemas</span><span class=o>.</span><span class=n>py</span> <span class=c1># 建立 pydantic 模型</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=创建引擎>创建引擎</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># database.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>create_engine</span>
</span></span><span class=line><span class=cl><span class=c1># using MySQL</span>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=s1>&#39;mysql+pymysql://user:pwd@localhost/testdb&#39;</span><span class=p>,</span> <span class=n>pool_recycle</span><span class=o>=</span><span class=mi>3600</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># using SQLite</span>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=s2>&#34;sqlite:///testdb.db&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>或者将数据库链接分离</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># database.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SQLALCHEMY_DATABASE_URL1</span> <span class=o>=</span> <span class=s2>&#34;sqlite:///./sql_app.db&#34;</span>
</span></span><span class=line><span class=cl><span class=n>SQLALCHEMY_DATABASE_URL2</span> <span class=o>=</span> <span class=s2>&#34;postgresql://user:password@postgresserver/db&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>SQLALCHEMY_DATABASE_URL1</span><span class=p>,</span> <span class=n>connect_args</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;check_same_thread&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span> 	<span class=c1># needed only for SQLite</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=建立对象>建立对象</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># database.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SessionLocal</span> <span class=o>=</span> <span class=n>sessionmaker</span><span class=p>(</span><span class=n>autocommit</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>autoflush</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>bind</span><span class=o>=</span><span class=n>engine</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=声名映射>声名映射</h3><p>声明 Base 实例（在 <code>database.py</code> 中）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># database.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.ext.declarative</span> <span class=kn>import</span> <span class=n>declarative_base</span>
</span></span><span class=line><span class=cl><span class=n>Base</span> <span class=o>=</span> <span class=n>declarative_base</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>新建表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># models.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>Boolean</span><span class=p>,</span> <span class=n>Column</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>String</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>relationship</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.database</span> <span class=kn>import</span> <span class=n>Base</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&#34;users&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>unique</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>hashed_password</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>is_active</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Boolean</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>items</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Item&#34;</span><span class=p>,</span> <span class=n>back_populates</span><span class=o>=</span><span class=s2>&#34;owner&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Item</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&#34;items&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>title</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>owner_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s2>&#34;users.id&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>owner</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;User&#34;</span><span class=p>,</span> <span class=n>back_populates</span><span class=o>=</span><span class=s2>&#34;items&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>SQLAlchemy 提供了 <code>backref</code> 让我们可以只需要定义一个关系：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>items</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Item&#34;</span><span class=p>,</span> <span class=n>backref</span><span class=o>=</span><span class=s2>&#34;owner&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>添加了这个就可以不用再在 <code>Item</code> 中定义 <code>relationship</code> 了！</p><h3 id=建立-pydantic-模型>建立 Pydantic 模型</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># schemas.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ItemBase</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>title</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ItemCreate</span><span class=p>(</span><span class=n>ItemBase</span><span class=p>):</span> <span class=c1># 创建时的所用的对象</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Item</span><span class=p>(</span><span class=n>ItemBase</span><span class=p>):</span> <span class=c1># API调用的对象</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>owner_id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Config</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>orm_mode</span> <span class=o>=</span> <span class=kc>True</span> <span class=c1># 将字典识别为ORM对象</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserBase</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserCreate</span><span class=p>(</span><span class=n>UserBase</span><span class=p>):</span> <span class=c1># 创建时的所用的对象</span>
</span></span><span class=line><span class=cl>    <span class=n>password</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>UserBase</span><span class=p>):</span> <span class=c1># API调用的对象</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>is_active</span><span class=p>:</span> <span class=nb>bool</span>
</span></span><span class=line><span class=cl>    <span class=n>items</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Item</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Config</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>orm_mode</span> <span class=o>=</span> <span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=crud>CRUD</h3><p><strong>C</strong>reate, <strong>R</strong>ead, <strong>U</strong>pdate, and <strong>D</strong>elete</p><h4 id=读>读</h4><p>详细：https://www.cnblogs.com/jingqi/p/8059673.html</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>Session</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.</span> <span class=kn>import</span> <span class=n>models</span><span class=p>,</span> <span class=n>schemas</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_user</span><span class=p>(</span><span class=n>db</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>User</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>User</span><span class=o>.</span><span class=n>id</span> <span class=o>==</span> <span class=n>user_id</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_user_by_email</span><span class=p>(</span><span class=n>db</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>email</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>User</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>User</span><span class=o>.</span><span class=n>email</span> <span class=o>==</span> <span class=n>email</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_users</span><span class=p>(</span><span class=n>db</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>skip</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>User</span><span class=p>)</span><span class=o>.</span><span class=n>offset</span><span class=p>(</span><span class=n>skip</span><span class=p>)</span><span class=o>.</span><span class=n>limit</span><span class=p>(</span><span class=n>limit</span><span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_items</span><span class=p>(</span><span class=n>db</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>skip</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Item</span><span class=p>)</span><span class=o>.</span><span class=n>offset</span><span class=p>(</span><span class=n>skip</span><span class=p>)</span><span class=o>.</span><span class=n>limit</span><span class=p>(</span><span class=n>limit</span><span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=建>建</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 把描述的表创建出来</span>
</span></span><span class=line><span class=cl><span class=n>Base</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>create_all</span><span class=p>(</span><span class=n>engine</span><span class=p>)</span> <span class=c1># Bas</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 把多个表数据添加到会话</span>
</span></span><span class=line><span class=cl><span class=n>session</span><span class=o>.</span><span class=n>add_all</span><span class=p>(</span><span class=n>Users</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 把一个表数据添加到会话</span>
</span></span><span class=line><span class=cl><span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>dog</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 提交会话</span>
</span></span><span class=line><span class=cl><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_user</span><span class=p>(</span><span class=n>db</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>user</span><span class=p>:</span> <span class=n>schemas</span><span class=o>.</span><span class=n>UserCreate</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>fake_hashed_password</span> <span class=o>=</span> <span class=n>user</span><span class=o>.</span><span class=n>password</span> <span class=o>+</span> <span class=s2>&#34;notreallyhashed&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>db_user</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>User</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>email</span><span class=p>,</span> <span class=n>hashed_password</span><span class=o>=</span><span class=n>fake_hashed_password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>db_user</span><span class=p>)</span> <span class=c1># 增加实例到数据库中</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span> <span class=c1># 提交更改</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>refresh</span><span class=p>(</span><span class=n>db_user</span><span class=p>)</span> <span class=c1># 刷新实例</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>db_user</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_user_item</span><span class=p>(</span><span class=n>db</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>item</span><span class=p>:</span> <span class=n>schemas</span><span class=o>.</span><span class=n>ItemCreate</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>db_item</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>Item</span><span class=p>(</span><span class=o>**</span><span class=n>item</span><span class=o>.</span><span class=n>dict</span><span class=p>(),</span> <span class=n>owner_id</span><span class=o>=</span><span class=n>user_id</span><span class=p>)</span> <span class=c1># 使用字典传入</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>db_item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>refresh</span><span class=p>(</span><span class=n>db_item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>db_item</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=改>改</h4><p>直接改</p><h4 id=删>删</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>db</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>user1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>删除整个数据库</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>db.drop_all()
</span></span></code></pre></td></tr></table></div></div><h3 id=创建表>创建表</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>Depends</span><span class=p>,</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>HTTPException</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>Session</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.</span> <span class=kn>import</span> <span class=n>crud</span><span class=p>,</span> <span class=n>models</span><span class=p>,</span> <span class=n>schemas</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.database</span> <span class=kn>import</span> <span class=n>SessionLocal</span><span class=p>,</span> <span class=n>engine</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>models</span><span class=o>.</span><span class=n>Base</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>create_all</span><span class=p>(</span><span class=n>bind</span><span class=o>=</span><span class=n>engine</span><span class=p>)</span> <span class=c1># 正式新建数据库和表（如果原来没有的话）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Dependency</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_db</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span> <span class=o>=</span> <span class=n>SessionLocal</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>db</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&#34;/users/&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>schemas</span><span class=o>.</span><span class=n>User</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_user</span><span class=p>(</span><span class=n>user</span><span class=p>:</span> <span class=n>schemas</span><span class=o>.</span><span class=n>UserCreate</span><span class=p>,</span> <span class=n>db</span><span class=p>:</span> <span class=n>Session</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>db_user</span> <span class=o>=</span> <span class=n>crud</span><span class=o>.</span><span class=n>get_user_by_email</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>email</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>email</span><span class=p>)</span> <span class=c1># 检查用户是否被注册</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>db_user</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>400</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;Email already registered&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>crud</span><span class=o>.</span><span class=n>create_user</span><span class=p>(</span><span class=n>db</span><span class=o>=</span><span class=n>db</span><span class=p>,</span> <span class=n>user</span><span class=o>=</span><span class=n>user</span><span class=p>)</span> <span class=c1># 新建用户</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;/users/&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>List</span><span class=p>[</span><span class=n>schemas</span><span class=o>.</span><span class=n>User</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>read_users</span><span class=p>(</span><span class=n>skip</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>,</span> <span class=n>db</span><span class=p>:</span> <span class=n>Session</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>users</span> <span class=o>=</span> <span class=n>crud</span><span class=o>.</span><span class=n>get_users</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>skip</span><span class=o>=</span><span class=n>skip</span><span class=p>,</span> <span class=n>limit</span><span class=o>=</span><span class=n>limit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;/users/</span><span class=si>{user_id}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>schemas</span><span class=o>.</span><span class=n>User</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>read_user</span><span class=p>(</span><span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>db</span><span class=p>:</span> <span class=n>Session</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>db_user</span> <span class=o>=</span> <span class=n>crud</span><span class=o>.</span><span class=n>get_user</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>user_id</span><span class=o>=</span><span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>db_user</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>404</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;User not found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>db_user</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&#34;/users/</span><span class=si>{user_id}</span><span class=s2>/items/&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>schemas</span><span class=o>.</span><span class=n>Item</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_item_for_user</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>item</span><span class=p>:</span> <span class=n>schemas</span><span class=o>.</span><span class=n>ItemCreate</span><span class=p>,</span> <span class=n>db</span><span class=p>:</span> <span class=n>Session</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>crud</span><span class=o>.</span><span class=n>create_user_item</span><span class=p>(</span><span class=n>db</span><span class=o>=</span><span class=n>db</span><span class=p>,</span> <span class=n>item</span><span class=o>=</span><span class=n>item</span><span class=p>,</span> <span class=n>user_id</span><span class=o>=</span><span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;/items/&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>List</span><span class=p>[</span><span class=n>schemas</span><span class=o>.</span><span class=n>Item</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>read_items</span><span class=p>(</span><span class=n>skip</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>,</span> <span class=n>db</span><span class=p>:</span> <span class=n>Session</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>items</span> <span class=o>=</span> <span class=n>crud</span><span class=o>.</span><span class=n>get_items</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>skip</span><span class=o>=</span><span class=n>skip</span><span class=p>,</span> <span class=n>limit</span><span class=o>=</span><span class=n>limit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>items</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=概念>概念</h2><table><thead><tr><th>概念</th><th>对应</th><th>说明</th></tr></thead><tbody><tr><td>engine</td><td>连接</td><td>驱动引擎</td></tr><tr><td>session</td><td>连接池、事务、会话</td><td>由此开始查询</td></tr><tr><td>model</td><td>表</td><td>类定义</td></tr><tr><td>column</td><td>列</td><td></td></tr><tr><td>query</td><td>若干行</td><td>可以链式添加多个文件</td></tr></tbody></table><h3 id=engine>Engine</h3><ul><li>位于数据库驱动之上的一个抽象概念，它适配了各种数据库驱动，提供了连接池等功能</li><li>用法：<code>engine = create_engine(&lt;数据库连接串>)</code><ul><li><p>数据库连接串的格式是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>dialect</span><span class=o>+</span><span class=n>driver</span><span class=p>:</span><span class=o>//</span><span class=n>username</span><span class=p>:</span><span class=n>password</span><span class=nd>@host</span><span class=p>:</span><span class=n>port</span><span class=o>/</span><span class=n>database</span><span class=err>?</span><span class=n>param</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>dialect 可以是 <code>mysql</code>, <code>postgresql</code>, <code>oracle</code>, <code>mssql</code>, <code>sqlite</code></p></li><li><p>driver：驱动，比如 MySQL 的驱动 pymysql， 如果不填写，就使用默认驱动</p></li><li><p>再往后就是用户名、密码、地址、端口、数据库、连接参数</p></li><li><p>例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># MySQL </span>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=s1>&#39;mysql+pymysql://scott:tiger@localhost/foo?charset=utf8mb4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># PostgreSQL</span>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=s1>&#39;postgresql+psycopg2://scott:tiger@localhost/mydatabase&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Oracle </span>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=s1>&#39;oracle+cx_oracle://scott:tiger@tnsname&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># MS SQL</span>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=s1>&#39;mssql+pymssql://scott:tiger@hostname:port/dbname&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># SQLite</span>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=s1>&#39;sqlite:////absolute/path/to/foo.db&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ul><h3 id=session>Session</h3><h2 id=column-参数>Column 参数</h2><ul><li><em><strong>type</strong></em>：字段的数据类型</li></ul><table><thead><tr><th>Object Name</th><th>Description</th></tr></thead><tbody><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.BigInteger target=_blank rel="noopener noreffer"><strong>BigInteger</strong></a></td><td>A type for bigger <code>int</code> integers.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.Boolean target=_blank rel="noopener noreffer"><strong>Boolean</strong></a></td><td>A bool datatype.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.Date target=_blank rel="noopener noreffer"><strong>Date</strong></a></td><td>A type for <code>datetime.date()</code> objects.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.DateTime target=_blank rel="noopener noreffer"><strong>DateTime</strong></a></td><td>A type for <code>datetime.datetime()</code> objects.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.Enum target=_blank rel="noopener noreffer"><strong>Enum</strong></a></td><td>Generic Enum Type.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.Float target=_blank rel="noopener noreffer"><strong>Float</strong></a></td><td>Type representing floating point types, such as <code>FLOAT</code> or <code>REAL</code>.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.Integer target=_blank rel="noopener noreffer"><strong>Integer</strong></a></td><td>A type for <code>int</code> integers.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.Interval target=_blank rel="noopener noreffer"><strong>Interval</strong></a></td><td>A type for <code>datetime.timedelta()</code> objects.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.LargeBinary target=_blank rel="noopener noreffer"><strong>LargeBinary</strong></a></td><td>A type for large binary byte data.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.MatchType target=_blank rel="noopener noreffer"><strong>MatchType</strong></a></td><td>Refers to the return type of the MATCH operator.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.Numeric target=_blank rel="noopener noreffer"><strong>Numeric</strong></a></td><td>A type for fixed precision numbers, such as <code>NUMERIC</code> or <code>DECIMAL</code>.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.PickleType target=_blank rel="noopener noreffer"><strong>PickleType</strong></a></td><td>Holds Python objects, which are serialized using pickle.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.SchemaType target=_blank rel="noopener noreffer"><strong>SchemaType</strong></a></td><td>Mark a type as possibly requiring schema-level DDL for usage.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.SmallInteger target=_blank rel="noopener noreffer"><strong>SmallInteger</strong></a></td><td>A type for smaller <code>int</code> integers.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.String target=_blank rel="noopener noreffer"><strong>String</strong></a></td><td>The base for all string and character types.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.Text target=_blank rel="noopener noreffer"><strong>Text</strong></a></td><td>A variably sized string type.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.Time target=_blank rel="noopener noreffer"><strong>Time</strong></a></td><td>A type for <code>datetime.time()</code> objects.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.Unicode target=_blank rel="noopener noreffer"><strong>Unicode</strong></a></td><td>A variable length Unicode string type.</td></tr><tr><td><a href=https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.UnicodeText target=_blank rel="noopener noreffer"><strong>UnicodeText</strong></a></td><td>An unbounded-length Unicode string type.</td></tr></tbody></table><table><thead><tr><th>类型名</th><th>说明</th></tr></thead><tbody><tr><td>Integer</td><td>普通整数，一般是32位</td></tr><tr><td>SmallInteger</td><td>取值范围小的整数，一般是16位</td></tr><tr><td>Float</td><td>浮点数</td></tr><tr><td>Numeric</td><td>定点数</td></tr><tr><td>String</td><td>字符串</td></tr><tr><td>Text</td><td>文本字符串</td></tr><tr><td>Boolean</td><td>布尔值</td></tr><tr><td>Date</td><td>日期</td></tr><tr><td>Time</td><td>时间</td></tr><tr><td>DateTime</td><td>日期和时间</td></tr></tbody></table><ul><li><em><strong>primary_key</strong></em>：设置字段是否为主键</li><li><em><strong>unique</strong></em>：设置字段是否唯一</li><li><em><strong>index</strong></em>：设置字段是否为索引参数</li><li><em><strong>default</strong></em>：设置字段默认值</li><li><em><strong>nullable</strong></em>：设置字段是否可空，默认为 <code>True</code>（可空）</li><li><em><strong>autoincrement</strong></em>：设置字段是否自动递增</li><li><em><strong>comment</strong></em>：设置字段注释</li></ul><h2 id=query>query</h2><p><code>Session </code>的 <code>query</code> 函数会返回一个 <code>Query</code> 对象</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>User</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>User</span><span class=o>.</span><span class=n>id</span> <span class=o>==</span> <span class=n>user_id</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=get>get</h3><p>根据指定主键查询</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>query</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=nb>id</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=filter>filter</h3><ul><li><code>equals</code>:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>query.filter<span class=o>(</span>User.name <span class=o>==</span> <span class=s1>&#39;ed&#39;</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>not equals</code>:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>query.filter<span class=o>(</span>User.name !<span class=o>=</span> <span class=s1>&#39;ed&#39;</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>LIKE</code>:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>query.filter<span class=o>(</span>User.name.like<span class=o>(</span><span class=s1>&#39;%ed%&#39;</span><span class=o>))</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>IN</code>:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>query.filter<span class=o>(</span>User.name.in_<span class=o>([</span><span class=s1>&#39;ed&#39;</span>, <span class=s1>&#39;wendy&#39;</span>, <span class=s1>&#39;jack&#39;</span><span class=o>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># works with query objects too:</span>
</span></span><span class=line><span class=cl>query.filter<span class=o>(</span>User.name.in_<span class=o>(</span>
</span></span><span class=line><span class=cl>        session.query<span class=o>(</span>User.name<span class=o>)</span>.filter<span class=o>(</span>User.name.like<span class=o>(</span><span class=s1>&#39;%ed%&#39;</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>))</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>NOT IN</code>:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>query.filter<span class=o>(</span>~User.name.in_<span class=o>([</span><span class=s1>&#39;ed&#39;</span>, <span class=s1>&#39;wendy&#39;</span>, <span class=s1>&#39;jack&#39;</span><span class=o>]))</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>IS NULL</code>:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>query.filter<span class=o>(</span>User.name <span class=o>==</span> None<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># alternatively, if pep8/linters are a concern</span>
</span></span><span class=line><span class=cl>query.filter<span class=o>(</span>User.name.is_<span class=o>(</span>None<span class=o>))</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>IS NOT NULL</code>:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>query.filter<span class=o>(</span>User.name !<span class=o>=</span> None<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># alternatively, if pep8/linters are a concern</span>
</span></span><span class=line><span class=cl>query.filter<span class=o>(</span>User.name.isnot<span class=o>(</span>None<span class=o>))</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>AND</code>:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># use and_()</span>
</span></span><span class=line><span class=cl>from sqlalchemy import and_
</span></span><span class=line><span class=cl>query.filter<span class=o>(</span>and_<span class=o>(</span>User.name <span class=o>==</span> <span class=s1>&#39;ed&#39;</span>, User.fullname <span class=o>==</span> <span class=s1>&#39;Ed Jones&#39;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># or send multiple expressions to .filter()</span>
</span></span><span class=line><span class=cl>query.filter<span class=o>(</span>User.name <span class=o>==</span> <span class=s1>&#39;ed&#39;</span>, User.fullname <span class=o>==</span> <span class=s1>&#39;Ed Jones&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># or chain multiple filter()/filter_by() calls</span>
</span></span><span class=line><span class=cl>query.filter<span class=o>(</span>User.name <span class=o>==</span> <span class=s1>&#39;ed&#39;</span><span class=o>)</span>.filter<span class=o>(</span>User.fullname <span class=o>==</span> <span class=s1>&#39;Ed Jones&#39;</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>OR</code>:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>from sqlalchemy import or_
</span></span><span class=line><span class=cl>query.filter<span class=o>(</span>or_<span class=o>(</span>User.name <span class=o>==</span> <span class=s1>&#39;ed&#39;</span>, User.name <span class=o>==</span> <span class=s1>&#39;wendy&#39;</span><span class=o>))</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>MATCH</code>:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>query.filter<span class=o>(</span>User.name.match<span class=o>(</span><span class=s1>&#39;wendy&#39;</span><span class=o>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=filter_by>filter_by</h3><p>查询指定字段值的结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>query</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=n>User</span><span class=o>.</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;wang_wu&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span> <span class=c1># 查询所有名字为wang_wu的实例</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=返回列表-list-和单项-scalar>返回列表 (List) 和单项 (Scalar)</h3><ul><li><code>all()</code> 返回一个列表:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt;&gt;&gt; <span class=nv>query</span> <span class=o>=</span> session.query<span class=o>(</span>User<span class=o>)</span>.filter<span class=o>(</span>User.name.like<span class=o>(</span><span class=s1>&#39;%ed&#39;</span><span class=o>))</span>.order_by<span class=o>(</span>User.id<span class=o>)</span>
</span></span><span class=line><span class=cl>SQL&gt;&gt;&gt; query.all<span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>[</span>&lt;User<span class=o>(</span><span class=nv>name</span><span class=o>=</span><span class=s1>&#39;ed&#39;</span>, <span class=nv>fullname</span><span class=o>=</span><span class=s1>&#39;Ed Jones&#39;</span>, <span class=nv>password</span><span class=o>=</span><span class=s1>&#39;f8s7ccs&#39;</span><span class=o>)</span>&gt;,
</span></span><span class=line><span class=cl>      &lt;User<span class=o>(</span><span class=nv>name</span><span class=o>=</span><span class=s1>&#39;fred&#39;</span>, <span class=nv>fullname</span><span class=o>=</span><span class=s1>&#39;Fred Flinstone&#39;</span>, <span class=nv>password</span><span class=o>=</span><span class=s1>&#39;blah&#39;</span><span class=o>)</span>&gt;<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>first()</code> 返回至多一个结果，而且以单项形式，而不是只有一个元素的tuple形式返回这个结果.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt;&gt;&gt; query.first<span class=o>()</span>
</span></span><span class=line><span class=cl>&lt;User<span class=o>(</span><span class=nv>name</span><span class=o>=</span><span class=s1>&#39;ed&#39;</span>, <span class=nv>fullname</span><span class=o>=</span><span class=s1>&#39;Ed Jones&#39;</span>, <span class=nv>password</span><span class=o>=</span><span class=s1>&#39;f8s7ccs&#39;</span><span class=o>)</span>&gt;
</span></span></code></pre></td></tr></table></div></div><ul><li><code>one()</code> 返回且仅返回一个查询结果。当结果的数量不足一个或者多于一个时会报错。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt;&gt;&gt; <span class=nv>user</span> <span class=o>=</span> query.one<span class=o>()</span>
</span></span><span class=line><span class=cl>Traceback <span class=o>(</span>most recent call last<span class=o>)</span>:
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>MultipleResultsFound: Multiple rows were found <span class=k>for</span> one<span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>没有查找到结果时：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>user</span> <span class=o>=</span> <span class=n>query</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=no>User</span><span class=o>.</span><span class=n>id</span> <span class=o>==</span> <span class=mi>99</span><span class=p>)</span><span class=o>.</span><span class=n>one</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=no>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ss>NoResultFound</span><span class=p>:</span> <span class=no>No</span> <span class=n>row</span> <span class=n>was</span> <span class=n>found</span> <span class=k>for</span> <span class=n>one</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>one_or_none()</code>：从名称可以看出，当结果数量为 0 时返回 <code>None</code>， 多于1个时报错</li><li><code>scalar()</code>和<code>one()</code> 类似，但是返回单项而不是 tuple</li></ul><h3 id=嵌入使用-sql>嵌入使用 SQL</h3><p>你可以在 <code>Query</code> 中通过 <code>text()</code> 使用 SQL 语句。例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt;&gt;&gt; from sqlalchemy import text
</span></span><span class=line><span class=cl>&gt;&gt;&gt; <span class=k>for</span> user in session.query<span class=o>(</span>User<span class=o>)</span>.<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>...             filter<span class=o>(</span>text<span class=o>(</span><span class=s2>&#34;id&lt;224&#34;</span><span class=o>))</span>.<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>...             order_by<span class=o>(</span>text<span class=o>(</span><span class=s2>&#34;id&#34;</span><span class=o>))</span>.all<span class=o>()</span>:
</span></span><span class=line><span class=cl>...     print<span class=o>(</span>user.name<span class=o>)</span>
</span></span><span class=line><span class=cl>ed
</span></span><span class=line><span class=cl>wendy
</span></span><span class=line><span class=cl>mary
</span></span><span class=line><span class=cl>fred
</span></span></code></pre></td></tr></table></div></div><p>除了上面这种直接将参数写进字符串的方式外，你还可以通过 <code>params()</code> 方法来传递参数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt;&gt;&gt; session.query<span class=o>(</span>User<span class=o>)</span>.filter<span class=o>(</span>text<span class=o>(</span><span class=s2>&#34;id&lt;:value and name=:name&#34;</span><span class=o>))</span>.<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>...     params<span class=o>(</span><span class=nv>value</span><span class=o>=</span>224, <span class=nv>name</span><span class=o>=</span><span class=s1>&#39;fred&#39;</span><span class=o>)</span>.order_by<span class=o>(</span>User.id<span class=o>)</span>.one<span class=o>()</span>
</span></span><span class=line><span class=cl>&lt;User<span class=o>(</span><span class=nv>name</span><span class=o>=</span><span class=s1>&#39;fred&#39;</span>, <span class=nv>fullname</span><span class=o>=</span><span class=s1>&#39;Fred Flinstone&#39;</span>, <span class=nv>password</span><span class=o>=</span><span class=s1>&#39;blah&#39;</span><span class=o>)</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p>并且，你可以直接使用完整的 SQL 语句，但是要注意将表名和列明写正确。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt;&gt;&gt; session.query<span class=o>(</span>User<span class=o>)</span>.from_statement<span class=o>(</span>
</span></span><span class=line><span class=cl>...                     text<span class=o>(</span><span class=s2>&#34;SELECT * FROM users where name=:name&#34;</span><span class=o>))</span>.<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>...                     params<span class=o>(</span><span class=nv>name</span><span class=o>=</span><span class=s1>&#39;ed&#39;</span><span class=o>)</span>.all<span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>[</span>&lt;User<span class=o>(</span><span class=nv>name</span><span class=o>=</span><span class=s1>&#39;ed&#39;</span>, <span class=nv>fullname</span><span class=o>=</span><span class=s1>&#39;Ed Jones&#39;</span>, <span class=nv>password</span><span class=o>=</span><span class=s1>&#39;f8s7ccs&#39;</span><span class=o>)</span>&gt;<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=关系>关系</h2><p>外键 (ForeignKey) 始终定义在多的一方</p><h3 id=一对多>一对多</h3><p><code>Child</code> 为多</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Parent</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;parent&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span><span class=n>primary_key</span> <span class=o>=</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>children</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Child&#34;</span><span class=p>,</span><span class=n>backref</span><span class=o>=</span><span class=s1>&#39;parent&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Child</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;child&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span><span class=n>primary_key</span> <span class=o>=</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parent_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span><span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;parent.id&#39;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=多对一>多对一</h3><p><code>Parent</code> 为多</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Parent</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;parent&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>child_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;child.id&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>child</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Child&#34;</span><span class=p>,</span> <span class=n>backref</span><span class=o>=</span><span class=s2>&#34;parents&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Child</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;child&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>为了建立双向关系,可以在 <code>relationship()</code> 中设置 backref，Child 对象就有 parents 属性. 设置 <code>cascade= ‘all’</code>，可以级联删除</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>children</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Child&#34;</span><span class=p>,</span><span class=n>cascade</span><span class=o>=</span><span class=s1>&#39;all&#39;</span><span class=p>,</span><span class=n>backref</span><span class=o>=</span><span class=s1>&#39;parent&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=一对一>一对一</h3><p>“一对一“就是“多对一”和“一对多”的一个特例，只需在 <code>relationship</code> 加上一个参数 <code>uselist=False</code> 替换多的一端即可</p><p>从一对多转换到一对一</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Parent</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;parent&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>child</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Child&#34;</span><span class=p>,</span> <span class=n>uselist</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>backref</span><span class=o>=</span><span class=s2>&#34;parent&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Child</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;child&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>parent_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;parent.id&#39;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>从多对一转换到一对一</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Parent</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;parent&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>child_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;child.id&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>child</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Child&#34;</span><span class=p>,</span> <span class=n>backref</span><span class=o>=</span><span class=n>backref</span><span class=p>(</span><span class=s2>&#34;parent&#34;</span><span class=p>,</span> <span class=n>uselist</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Child</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;child&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=多对多>多对多</h3><p>多对多关系需要一个中间关联表,通过参数 <code>secondary</code> 来指定</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>Table</span><span class=p>,</span><span class=n>Text</span>
</span></span><span class=line><span class=cl><span class=n>post_keywords</span> <span class=o>=</span> <span class=n>Table</span><span class=p>(</span><span class=s1>&#39;post_keywords&#39;</span><span class=p>,</span><span class=n>Base</span><span class=o>.</span><span class=n>metadata</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Column</span><span class=p>(</span><span class=s1>&#39;post_id&#39;</span><span class=p>,</span><span class=n>Integer</span><span class=p>,</span><span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;posts.id&#39;</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>        <span class=n>Column</span><span class=p>(</span><span class=s1>&#39;keyword_id&#39;</span><span class=p>,</span><span class=n>Integer</span><span class=p>,</span><span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;keywords.id&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BlogPost</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;posts&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span><span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>body</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>keywords</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s1>&#39;Keyword&#39;</span><span class=p>,</span><span class=n>secondary</span><span class=o>=</span><span class=n>post_keywords</span><span class=p>,</span><span class=n>backref</span><span class=o>=</span><span class=s1>&#39;posts&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Keyword</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;keywords&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span><span class=n>primary_key</span> <span class=o>=</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>keyword</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>50</span><span class=p>),</span><span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span><span class=n>unique</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=技巧>技巧</h2><h3 id=relationship-中-lazy-属性详解><code>relationship()</code> 中 <code>lazy</code> 属性详解</h3><p><code>lazy</code> 决定了 <code>SQLAlchemy</code> 什么时候从数据库中加载数据</p><ul><li><p>select：就是访问到属性的时候，就会全部加载该属性的数据</p></li><li><p>joined：对关联的两个表使用联接</p></li><li><p>subquery：与 joined 类似，但使用子子查询</p></li><li><p>dynamic：不加载记录，但提供加载记录的查询，也就是生成 query 对象</p><ul><li>只可以用在一对多和多对多关系中，不可以用在一对一和多对一中</li></ul></li></ul><h3 id=关于更新数据的讨论>关于更新数据的讨论</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 1 (bad)</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=c1># result: UPDATE user SET no_of_logins = 31 WHERE user.id = 6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2 (bad)</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>=</span> <span class=n>user</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=c1># result: UPDATE user SET no_of_logins = 31 WHERE user.id = 6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3 (bad)</span>
</span></span><span class=line><span class=cl><span class=nb>setattr</span><span class=p>(</span><span class=n>user</span><span class=p>,</span> <span class=s1>&#39;no_of_logins&#39;</span><span class=p>,</span> <span class=n>user</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># result: UPDATE user SET no_of_logins = 31 WHERE user.id = 6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4 (ok)</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=c1># result: UPDATE user SET no_of_logins = no_of_logins + 1 WHERE user.id = 6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5 (ok)</span>
</span></span><span class=line><span class=cl><span class=nb>setattr</span><span class=p>(</span><span class=n>user</span><span class=p>,</span> <span class=s1>&#39;no_of_logins&#39;</span><span class=p>,</span> <span class=n>User</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># result: UPDATE user SET no_of_logins = no_of_logins + 1 WHERE user.id = 6</span>
</span></span></code></pre></td></tr></table></div></div><p>If you are going to increment twice via code that produces SQL like <code>SET no_of_logins = no_of_logins + 1</code>, then you will need to commit or at least flush in between increments, or else you will only get one increment in total:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 6 (bad)</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># result: UPDATE user SET no_of_logins = no_of_logins + 1 WHERE user.id = 6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 7 (ok)</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>session</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># result: UPDATE user SET no_of_logins = no_of_logins + 1 WHERE user.id = 6</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>no_of_logins</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># result: UPDATE user SET no_of_logins = no_of_logins + 1 WHERE user.id = 6</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=关于插入大量数据的讨论>关于插入大量数据的讨论</h3><p>官方：https://docs.sqlalchemy.org/en/13/faq/performance.html#i-m-inserting-400-000-rows-with-the-orm-and-it-s-really-slow</p><p>大体意思：ORM 模型不适合于大量数据的插入，使用 sqlalchemy Core 或者 sqlalchemy 提供的 bulk insert 函数会是更好的选择</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>SQLAlchemy ORM: Total time for 100000 records 2.39429616928 secs
</span></span><span class=line><span class=cl>SQLAlchemy ORM pk given: Total time for 100000 records 1.51412987709 secs
</span></span><span class=line><span class=cl>SQLAlchemy ORM bulk_save_objects(): Total time for 100000 records 0.568987131119 secs
</span></span><span class=line><span class=cl>SQLAlchemy ORM bulk_insert_mappings(): Total time for 100000 records 0.320806980133 secs
</span></span><span class=line><span class=cl>SQLAlchemy Core: Total time for 100000 records 0.206904888153 secs
</span></span><span class=line><span class=cl>sqlite3: Total time for 100000 records 0.165791988373 sec
</span></span></code></pre></td></tr></table></div></div><p>Script:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sqlite3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.ext.declarative</span> <span class=kn>import</span> <span class=n>declarative_base</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>Column</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>String</span><span class=p>,</span>  <span class=n>create_engine</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>scoped_session</span><span class=p>,</span> <span class=n>sessionmaker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Base</span> <span class=o>=</span> <span class=n>declarative_base</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>DBSession</span> <span class=o>=</span> <span class=n>scoped_session</span><span class=p>(</span><span class=n>sessionmaker</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Customer</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&#34;customer&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>255</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>init_sqlalchemy</span><span class=p>(</span><span class=n>dbname</span><span class=o>=</span><span class=s1>&#39;sqlite:///sqlalchemy.db&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>engine</span>
</span></span><span class=line><span class=cl>    <span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=n>dbname</span><span class=p>,</span> <span class=n>echo</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>DBSession</span><span class=o>.</span><span class=n>remove</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>DBSession</span><span class=o>.</span><span class=n>configure</span><span class=p>(</span><span class=n>bind</span><span class=o>=</span><span class=n>engine</span><span class=p>,</span> <span class=n>autoflush</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>expire_on_commit</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Base</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>drop_all</span><span class=p>(</span><span class=n>engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Base</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>create_all</span><span class=p>(</span><span class=n>engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_sqlalchemy_orm</span><span class=p>(</span><span class=n>n</span><span class=o>=</span><span class=mi>100000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>init_sqlalchemy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>t0</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>xrange</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>customer</span> <span class=o>=</span> <span class=n>Customer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>customer</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;NAME &#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>DBSession</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>customer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>i</span> <span class=o>%</span> <span class=mi>1000</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>DBSession</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>DBSession</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;SQLAlchemy ORM: Total time for &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34; records &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>t0</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; secs&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_sqlalchemy_orm_pk_given</span><span class=p>(</span><span class=n>n</span><span class=o>=</span><span class=mi>100000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>init_sqlalchemy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>t0</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>xrange</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>customer</span> <span class=o>=</span> <span class=n>Customer</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&#34;NAME &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>DBSession</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>customer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>i</span> <span class=o>%</span> <span class=mi>1000</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>DBSession</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>DBSession</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;SQLAlchemy ORM pk given: Total time for &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34; records &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>t0</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; secs&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_sqlalchemy_orm_bulk_save_objects</span><span class=p>(</span><span class=n>n</span><span class=o>=</span><span class=mi>100000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>init_sqlalchemy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>t0</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=mi>10000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>DBSession</span><span class=o>.</span><span class=n>bulk_save_objects</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=n>Customer</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;NAME &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>xrange</span><span class=p>(</span><span class=n>chunk</span><span class=p>,</span> <span class=nb>min</span><span class=p>(</span><span class=n>chunk</span> <span class=o>+</span> <span class=mi>10000</span><span class=p>,</span> <span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>DBSession</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;SQLAlchemy ORM bulk_save_objects(): Total time for &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34; records &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>t0</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; secs&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_sqlalchemy_orm_bulk_insert</span><span class=p>(</span><span class=n>n</span><span class=o>=</span><span class=mi>100000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>init_sqlalchemy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>t0</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=mi>10000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>DBSession</span><span class=o>.</span><span class=n>bulk_insert_mappings</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>Customer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=nb>dict</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;NAME &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>xrange</span><span class=p>(</span><span class=n>chunk</span><span class=p>,</span> <span class=nb>min</span><span class=p>(</span><span class=n>chunk</span> <span class=o>+</span> <span class=mi>10000</span><span class=p>,</span> <span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>DBSession</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;SQLAlchemy ORM bulk_insert_mappings(): Total time for &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34; records &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>t0</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; secs&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_sqlalchemy_core</span><span class=p>(</span><span class=n>n</span><span class=o>=</span><span class=mi>100000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>init_sqlalchemy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>t0</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>engine</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Customer</span><span class=o>.</span><span class=n>__table__</span><span class=o>.</span><span class=n>insert</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=p>[{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s1>&#39;NAME &#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>)}</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>xrange</span><span class=p>(</span><span class=n>n</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;SQLAlchemy Core: Total time for &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34; records &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>t0</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; secs&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>init_sqlite3</span><span class=p>(</span><span class=n>dbname</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>dbname</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;DROP TABLE IF EXISTS customer&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;CREATE TABLE customer (id INTEGER NOT NULL, &#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name VARCHAR(255), PRIMARY KEY(id))&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>conn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_sqlite3</span><span class=p>(</span><span class=n>n</span><span class=o>=</span><span class=mi>100000</span><span class=p>,</span> <span class=n>dbname</span><span class=o>=</span><span class=s1>&#39;sqlite3.db&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>init_sqlite3</span><span class=p>(</span><span class=n>dbname</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>t0</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>xrange</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>row</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39;NAME &#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>),)</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO customer (name) VALUES (?)&#34;</span><span class=p>,</span> <span class=n>row</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;sqlite3: Total time for &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34; records &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>t0</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; sec&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>test_sqlalchemy_orm</span><span class=p>(</span><span class=mi>100000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>test_sqlalchemy_orm_pk_given</span><span class=p>(</span><span class=mi>100000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>test_sqlalchemy_orm_bulk_save_objects</span><span class=p>(</span><span class=mi>100000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>test_sqlalchemy_orm_bulk_insert</span><span class=p>(</span><span class=mi>100000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>test_sqlalchemy_core</span><span class=p>(</span><span class=mi>100000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>test_sqlite3</span><span class=p>(</span><span class=mi>100000</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=级联删除>级联删除</h3><p><a href=https://www.cnblogs.com/ShanCe/p/15381412.html target=_blank rel="noopener noreffer">https://www.cnblogs.com/ShanCe/p/15381412.html</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-04-02</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/Notes/tags/python/>Python</a>,&nbsp;<a href=/Notes/tags/%E5%90%8E%E7%AB%AF/>后端</a>,&nbsp;<a href=/Notes/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>数据库</a>,&nbsp;<a href=/Notes/tags/orm/>ORM</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/Notes/>主页</a></span></section></div><div class=post-nav><a href=/Notes/posts/frontend/css/tailwind/ class=prev rel=prev title=Tailwind><i class="fas fa-angle-left fa-fw"></i>Tailwind</a>
<a href=/Notes/posts/%E5%88%B7%E9%A2%98/back-tracking/46.-%E5%85%A8%E6%8E%92%E5%88%97/ class=next rel=next title="46. 全排列">46. 全排列<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>酒困路长惟欲睡，日高人渴漫思茶</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/Notes/lib/katex/katex.min.css><link rel=stylesheet href=/Notes/lib/katex/copy-tex.min.css><script type=text/javascript src=/Notes/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/Notes/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/Notes/lib/lunr/lunr.min.js></script><script type=text/javascript src=/Notes/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/Notes/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/Notes/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/Notes/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/Notes/lib/katex/katex.min.js></script><script type=text/javascript src=/Notes/lib/katex/auto-render.min.js></script><script type=text/javascript src=/Notes/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/Notes/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:45},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/Notes/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/Notes/lib/lunr/lunr.segmentit.js",maxResultLength:30,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/Notes/js/theme.min.js></script></body></html>