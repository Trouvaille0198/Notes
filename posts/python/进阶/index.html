<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Python 进阶 - 伤心肠粉的酱油碟子</title><meta name=author content><meta name=author-link content><meta name=description content="进阶 杂知识点 什么是CPython GIL? GIL，Global Interpreter Lock，即全局解释器锁"><meta name=keywords content="Python"><meta itemprop=name content="Python 进阶"><meta itemprop=description content="进阶 杂知识点 什么是CPython GIL? GIL，Global Interpreter Lock，即全局解释器锁"><meta itemprop=datePublished content="2022-04-02T00:00:00+00:00"><meta itemprop=dateModified content="2023-06-14T10:56:53+00:00"><meta itemprop=wordCount content="8947"><meta itemprop=image content="https://trouvaille0198.github.io/logo.png"><meta itemprop=keywords content="Python,"><meta property="og:title" content="Python 进阶"><meta property="og:description" content="进阶 杂知识点 什么是CPython GIL? GIL，Global Interpreter Lock，即全局解释器锁"><meta property="og:type" content="article"><meta property="og:url" content="https://trouvaille0198.github.io/Notes/posts/python/%E8%BF%9B%E9%98%B6/"><meta property="og:image" content="https://trouvaille0198.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-02T00:00:00+00:00"><meta property="article:modified_time" content="2023-06-14T10:56:53+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://trouvaille0198.github.io/logo.png"><meta name=twitter:title content="Python 进阶"><meta name=twitter:description content="进阶 杂知识点 什么是CPython GIL? GIL，Global Interpreter Lock，即全局解释器锁"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://trouvaille0198.github.io/Notes/posts/python/%E8%BF%9B%E9%98%B6/><link rel=prev href=https://trouvaille0198.github.io/Notes/posts/courses/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/><link rel=next href=https://trouvaille0198.github.io/Notes/posts/%E5%88%B7%E9%A2%98/array/%E6%A0%88%E4%B8%8E%E9%98%9F%E5%88%97/239.-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%9C%80%E5%A4%A7%E5%80%BC/><link rel=stylesheet href=/Notes/lib/normalize/normalize.min.css><link rel=stylesheet href=/Notes/css/style.min.css><link rel=stylesheet href=/Notes/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/Notes/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Python 进阶","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/python\/%E8%BF%9B%E9%98%B6\/"},"genre":"posts","keywords":"Python","wordcount":8947,"url":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/python\/%E8%BF%9B%E9%98%B6\/","datePublished":"2022-04-02T00:00:00+00:00","dateModified":"2023-06-14T10:56:53+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"MelonCholi"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子><span class=header-title-text>伤心肠粉</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/Notes/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/Notes/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/Notes/posts/>文章</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子><span class=header-title-text>伤心肠粉</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/Notes/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/Notes/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/Notes/posts/>文章</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class="toc-content always-active" id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Python 进阶</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle"></i>
MelonCholi</span></span>
<span class=post-category>收录于 <a href=/Notes/categories/python/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;Python</a></span></div><div class=post-meta-line><span title="2022-04-02 00:00:00"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-04-02>2022-04-02</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 8947 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 18 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#杂知识点>杂知识点</a><ul><li><a href=#什么是cpython-gil>什么是CPython GIL?</a><ul><li><a href=#另一种解释>另一种解释</a></li></ul></li><li><a href=#python-的内存管理>Python 的内存管理</a></li><li><a href=#python-垃圾回收机制>python 垃圾回收机制</a><ul><li><a href=#引用计数>引用计数</a></li><li><a href=#标记清除>标记清除</a></li><li><a href=#分代回收>分代回收</a></li></ul></li><li><a href=#async-和-await-的作用>async 和 await 的作用</a></li><li><a href=#oop-相关>OOP 相关</a><ul><li><a href=#类变量和实例变量的区别>类变量和实例变量的区别？</a></li><li><a href=#classmethod-和-staticmethod-区别>classmethod 和 staticmethod 区别？</a></li><li><a href=#__new__-和-__init__-区别><code>__new__</code> 和 <code>__init__</code> 区别？</a></li><li><a href=#什么是元类>什么是元类？</a></li></ul></li></ul></li><li><a href=#functoolslru_cache-装饰器><code>functools.lru_cache()</code> 装饰器</a></li><li><a href=#assert>assert</a></li><li><a href=#abstractmethod-抽象方法>@abstractmethod 抽象方法</a></li><li><a href=#cached_property>@cached_property</a></li><li><a href=#typingtypeddict>typing.TypedDict</a></li><li><a href=#多等于号表达式>多等于号表达式</a></li><li><a href=#__getattribute____getattr__-与-__setattr__><code>__getattribute__</code>，<code>__getattr__</code> 与 <code>__setattr__</code></a><ul><li><a href=#__getattribute__><code>__getattribute__</code></a></li><li><a href=#__getattr__><code>__getattr__</code></a></li><li><a href=#__getattr__-1><code>__getattr__</code></a></li></ul></li><li><a href=#__enter__-与-__exit__><code>__enter__</code> 与 <code>__exit__</code></a></li><li><a href=#结构化模式匹配>结构化模式匹配</a><ul><li><a href=#字典映射>字典映射</a></li><li><a href=#pattern-match>Pattern Match</a></li><li><a href=#模式匹配应用实例>模式匹配应用实例</a><ul><li><a href=#匹配字符串>匹配字符串</a></li><li><a href=#匹配列表>匹配列表</a></li><li><a href=#匹配对象>匹配对象</a></li></ul></li></ul></li><li><a href=#装饰器进阶>装饰器进阶</a><ul><li><a href=#一般装饰器>一般装饰器</a></li><li><a href=#带参数的装饰器>带参数的装饰器</a></li><li><a href=#装饰器不一定会执行被装饰的函数>装饰器不一定会执行被装饰的函数</a></li><li><a href=#类装饰器>类装饰器</a></li><li><a href=#带参数的类装饰器>带参数的类装饰器</a></li><li><a href=#对象装饰器>对象装饰器</a></li></ul></li><li><a href=#mixin-类的组合思想>Mixin 类的组合思想</a><ul><li><a href=#在基类中中提供功能>在基类中中提供功能</a></li><li><a href=#在需要子类上添加功能>在需要子类上添加功能</a></li><li><a href=#装饰器>装饰器</a></li><li><a href=#mixin-用类去继承>Mixin 用类去继承</a></li><li><a href=#总结>总结</a></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=进阶>进阶</h1><h2 id=杂知识点>杂知识点</h2><h3 id=什么是cpython-gil>什么是CPython GIL?</h3><p>GIL，Global Interpreter Lock，即<strong>全局解释器锁</strong></p><p>引入 GIL 是因为 CPython 的内存管理并不是线程安全的</p><p>为了保护多线程下对 python 对象的访问，每个线程在执行过程中都需要先获取 GIL，保证同一时刻只有一个线程在执行代码</p><p>GIL 使得 python 的多线程不能充分发挥多核 CPU 的性能，对 CPU 密集型程序的影响较大</p><h4 id=另一种解释>另一种解释</h4><p>全局解释器锁 GIL，英文名称为 Global Interpreter Lock，它是解释器中一种线程同步的方式。</p><p>对于每一个解释器进程都具有一个 GIL ，它的直接作用是限制单个解释器进程中多线程的并行执行，使得即使在多核处理器上对于单个解释器进程来说，在同一时刻运行的线程仅限一个。 对于 Python 来讲，GIL 并不是它语言本身的特性，而<strong>是 CPython 解释器的实现特性</strong>。</p><p>Python 代码被编译后的字节码会在解释器中执行，在执行过程中，存在于 CPython 解释器中的 GIL 会致使在同一时刻只有<strong>一个线程</strong>可以执行字节码。 GIL 的存在引起的最直接的问题便是：<strong>在一个解释器进程中通过多线程的方式无法利用多核处理器来实现真正的并行。</strong></p><p>因此，Python 的多线程是<strong>伪多线程</strong>，无法利用多核资源，同一个时刻只有一个线程在真正的运行。</p><h3 id=python-的内存管理>Python 的内存管理</h3><p>Python 有内存池机制，Pymalloc 机制，用于对内存的申请和释放管理。先来看一下为什么有内存池：</p><p>当创建大量消耗小内存的对象时，c 中频繁调用 new/malloc 会导致大量的内存碎片，致使效率降低。</p><p>内存池的概念就是预先在内存中申请一定数量的，大小相等的内存块留作备用，当有新的内存需求时，就先从内存池中分配内存给这个需求，不够了之后再申请新的内存。这样做最显著的优势就是能够减少内存碎片，提升效率。</p><p>查看源码，可以看到 Pymalloc 对于小的对象，Pymalloc 会在内存池中申请空间，一般是少于 236kb，如果是大的对象，则直接调用 new/malloc 来申请新的内存空间。</p><h3 id=python-垃圾回收机制>python 垃圾回收机制</h3><p><strong>引用计数</strong>为主，<strong>标记清除</strong>和<strong>分代回收</strong>为辅</p><h4 id=引用计数>引用计数</h4><p>引用计数机制是这样的：</p><ol><li><p>当对象被创建，被引用，作为参数传递，存储到容器中，引用计数 +1</p></li><li><p>当对象离开作用域，引用指向别的对象，del，从容器中移除，引用计数 -1</p></li><li><p>当引用计数降为 0，python 就会自动回收该对象所在的内存空间，</p></li></ol><p>但是引用计数无法解决循环引用的问题，所以引入了标记清除和分代回收机制</p><h4 id=标记清除>标记清除</h4><p>标记清除主要是解决循环引用问题。</p><p>标记清除算法是一种基于追踪回收（tracing GC）技术实现的垃圾回收算法。</p><p>它分为两个阶段：第一阶段是标记阶段，GC 会把所有的 活动对象 打上标记，第二阶段是把那些没有标记的对象 非活动对象 进行回收。那么 GC 又是如何判断哪些是活动对象哪些是非活动对象的呢？</p><p>对象之间通过引用（指针）连在一起，构成一个<strong>有向图</strong>，对象构成这个有向图的节点，而引用关系构成这个有向图的边。从根对象（root object）出发，沿着有向边遍历对象，<strong>可达的</strong>（reachable）对象标记为活动对象，<strong>不可达的对象就是要被清除的非活动对象</strong>。根对象就是全局变量、调用栈、寄存器。</p><h4 id=分代回收>分代回收</h4><p>分代回收是一种以空间换时间的操作方式。</p><p>Python 将内存根据对象的存活时间划分为不同的集合，每个集合称为一个代，Python 将内存分为了 3“代”，分别为年轻代（第 0 代）、中年代（第 1 代）、老年代（第 2 代），他们对应的是 3 个链表，它们的垃圾收集频率与对象的存活时间的增大而减小。新创建的对象都会分配在年轻代，年轻代链表的总数达到上限时，Python 垃圾收集机制就会被触发，把那些可以被回收的对象回收掉，而那些不会回收的对象就会被移到中年代去，依此类推，老年代中的对象是存活时间最久的对象，甚至是存活于整个系统的生命周期内。同时，分代回收是建立在标记清除技术基础之上。</p><h3 id=async-和-await-的作用>async 和 await 的作用</h3><p>async: 声明一个函数为异步函数，函数内只要有 await 就要声明为 async</p><p>await: 搭配 <code>asyncio.sleep()</code> 时会切换协程，当切换回来后再继续执行下面的语句</p><h3 id=oop-相关>OOP 相关</h3><h4 id=类变量和实例变量的区别>类变量和实例变量的区别？</h4><ol><li><strong>类变量由所有实例共享</strong></li><li>实例变量由实例单独享有，不同实例之间不影响</li><li>当我们需要在一个类的不同实例之间共享变量的时候使用类变量</li></ol><h4 id=classmethod-和-staticmethod-区别>classmethod 和 staticmethod 区别？</h4><ul><li>都可以通过 <code>Class.method()</code> 的方式使用</li><li>classmethod 第一个参数是 cls，可以引用类变量</li><li>staticmethod 使用起来和普通函数一样，<strong>只不过放在类里去组织</strong></li><li>classmethod 是<strong>为了使用类变量</strong>，staticmethod 是代码组织的需要，完全可以放到类之外</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Person</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Country</span> <span class=o>=</span> <span class=s1>&#39;china&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>age</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>age</span> <span class=o>=</span> <span class=n>age</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print_name</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print_country</span><span class=p>(</span><span class=bp>cls</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=bp>cls</span><span class=o>.</span><span class=n>Country</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>join_name</span><span class=p>(</span><span class=n>first_name</span><span class=p>,</span> <span class=n>last_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>print</span><span class=p>(</span><span class=n>last_name</span> <span class=o>+</span> <span class=n>first_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=n>Person</span><span class=p>(</span><span class=s2>&#34;Bruce&#34;</span><span class=p>,</span> <span class=s2>&#34;Lee&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>.</span><span class=n>print_country</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>.</span><span class=n>print_name</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>.</span><span class=n>join_name</span><span class=p>(</span><span class=s2>&#34;Bruce&#34;</span><span class=p>,</span> <span class=s2>&#34;Lee&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Person</span><span class=o>.</span><span class=n>print_country</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>Person</span><span class=o>.</span><span class=n>print_name</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Person</span><span class=o>.</span><span class=n>join_name</span><span class=p>(</span><span class=s2>&#34;Bruce&#34;</span><span class=p>,</span> <span class=s2>&#34;Lee&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=__new__-和-__init__-区别><code>__new__</code> 和 <code>__init__</code> 区别？</h4><ul><li><code>__new__</code> 是一个静态方法，而 <code>__init__</code> 是一个实例方法.</li><li><code>__new__</code> 方法会<strong>返回一个创建的实例</strong>，而 <code>__init__</code> 什么都不返回.</li><li>只有在 <code>__new__</code> 返回一个 cls 的实例时后面的 <code>__init__</code> 才能被调用.</li><li>当创建一个新实例时调用 <code>__new__</code>，初始化一个实例时用 <code>__init__</code>.</li></ul><p>我们可以做几个有趣的实验。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Person</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__new__</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;in __new__&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>instance</span> <span class=o>=</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__new__</span><span class=p>(</span><span class=bp>cls</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>instance</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>age</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;in __init__&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_name</span> <span class=o>=</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_age</span> <span class=o>=</span> <span class=n>age</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>Person</span><span class=p>(</span><span class=s2>&#34;zhiyu&#34;</span><span class=p>,</span> <span class=mi>26</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;p:&#34;</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这段程序输出为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>in __new__
</span></span><span class=line><span class=cl>in __init__
</span></span><span class=line><span class=cl>p: &lt;__main__.Person object at 0x00000261FE562E50&gt;
</span></span></code></pre></td></tr></table></div></div><p>可以看到先执行 new 方法创建对象，然后 init 进行初始化。假设将 new 方法中不返还该对象，会有什么结果了？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Person</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__new__</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;in __new__&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>instance</span> <span class=o>=</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__new__</span><span class=p>(</span><span class=bp>cls</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>#return instance</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>age</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;in __init__&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_name</span> <span class=o>=</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_age</span> <span class=o>=</span> <span class=n>age</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>Person</span><span class=p>(</span><span class=s2>&#34;zhiyu&#34;</span><span class=p>,</span> <span class=mi>26</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;p:&#34;</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>发现<strong>如果 new 没有返回实例化对象，init 就没法初始化了</strong>。</p><p>输出结果为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>in __new__
</span></span><span class=line><span class=cl>p: None
</span></span></code></pre></td></tr></table></div></div><h4 id=什么是元类>什么是元类？</h4><p>元类 (meta class) 是创建类的类</p><p>元类允许我们控制类的生成，比如修改类的属性等</p><p>使用 type 来定义元类</p><p>元类最常见的一个使用场景就是 ORM 框架</p><h2 id=functoolslru_cache-装饰器><code>functools.lru_cache()</code> 装饰器</h2><p>该函数是一个装饰器，为函数提供缓存功能。在下次以相同参数调用时直接返回上一次的结果。</p><p>例 1：生成第 n 个斐波纳契数，这种慢速递归函数适合使用 lru_cache</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fibonacci</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;斐波那契函数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>n</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fibonacci</span><span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=n>fibonacci</span><span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>stime</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>fibonacci</span><span class=p>(</span><span class=mi>34</span><span class=p>))</span>  <span class=c1># 没有使用缓存，则需要几秒钟的时间</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;total time is </span><span class=si>%.3f</span><span class=s2>s&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>stime</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=c1># output</span>
</span></span><span class=line><span class=cl><span class=c1># 5702887</span>
</span></span><span class=line><span class=cl><span class=c1># total time is 1.335s</span>
</span></span></code></pre></td></tr></table></div></div><p>如果没有使用缓存，则需要几秒钟的时间，像下面这样使用缓存后，瞬间就可以计算出结果。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>functools</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nd>@functools.lru_cache</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>300</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fibonacci</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;斐波那契函数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>n</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fibonacci</span><span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=n>fibonacci</span><span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>如果使用了 lru_cache，计算用时被大大减少，测试计算时间为 0s。这是因为我们在使用 fibonacci 递归函数时，会重复计算值。使用了 lru_cache 后，所有的重复计算只会执行一次。</p><p>注意：</p><ul><li>缓存是按照参数作为键</li><li>所有参数必须可哈希 hash，因为缓存实际是存储在字典中，所以使用 list 做参数时就会报错</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>lru_cache</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nd>@lru_cache</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>list_sum</span><span class=p>(</span><span class=n>nums</span><span class=p>:</span> <span class=nb>list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>sum</span><span class=p>(</span><span class=n>nums</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># output</span>
</span></span><span class=line><span class=cl><span class=c1># TypeError: unhashable type: &#39;list&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=assert>assert</h2><p>Python assert（断言）用于判断一个表达式，在表达式条件为 false 的时候触发异常。</p><p>断言可以在条件不满足程序运行的情况下直接返回错误，而不必等待程序运行后出现崩溃的情况，例如我们的代码只能在 Linux 系统下运行，可以先判断当前系统是否符合条件。</p><p>语法格式如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>assert</span> <span class=n>expression</span>
</span></span></code></pre></td></tr></table></div></div><p>等价于：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>if</span> <span class=ow>not</span> <span class=n>expression</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=ne>AssertionError</span>
</span></span></code></pre></td></tr></table></div></div><p>assert 后面也可以紧跟参数:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>assert</span> <span class=n>expression</span> <span class=p>[,</span> <span class=n>arguments</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>等价于：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>if</span> <span class=ow>not</span> <span class=n>expression</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=ne>AssertionError</span><span class=p>(</span><span class=n>arguments</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>以下为 assert 使用实例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>assert</span> <span class=kc>True</span>     <span class=c1># 条件为 true 正常执行</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>assert</span> <span class=kc>False</span>    <span class=c1># 条件为 false 触发异常</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;&lt;stdin&gt;&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>1</span><span class=p>,</span> <span class=ow>in</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=ne>AssertionError</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>assert</span> <span class=mi>1</span><span class=o>==</span><span class=mi>1</span>    <span class=c1># 条件为 true 正常执行</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>assert</span> <span class=mi>1</span><span class=o>==</span><span class=mi>2</span>    <span class=c1># 条件为 false 触发异常</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;&lt;stdin&gt;&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>1</span><span class=p>,</span> <span class=ow>in</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=ne>AssertionError</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>assert</span> <span class=mi>1</span><span class=o>==</span><span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;1 不等于 2&#39;</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;&lt;stdin&gt;&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>1</span><span class=p>,</span> <span class=ow>in</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=ne>AssertionError</span><span class=p>:</span> <span class=mi>1</span> <span class=n>不等于</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>以下实例判断当前系统是否为 Linux，如果不满足条件则直接触发异常，不必执行接下来的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=p>(</span><span class=s1>&#39;linux&#39;</span> <span class=ow>in</span> <span class=n>sys</span><span class=o>.</span><span class=n>platform</span><span class=p>),</span> <span class=s2>&#34;该代码只能在 Linux 下执行&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 接下来要执行的代码</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=abstractmethod-抽象方法>@abstractmethod 抽象方法</h2><p>抽象方法<strong>表示基类的一个方法，没有实现</strong>，所以<strong>基类不能实例化</strong>，子类实现了该抽象方法才能被实例化。</p><p>Python 的 abc 提供了 <code>@abstractmethod</code> 装饰器实现抽象方法</p><p>下面以 Python3 的 abc 模块举例。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>abc</span> <span class=kn>import</span> <span class=n>ABC</span><span class=p>,</span> <span class=n>abstractmethod</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Foo</span><span class=p>(</span><span class=n>ABC</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fun</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#39;&#39;please Implemente in subclass&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SubFoo</span><span class=p>(</span><span class=n>Foo</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fun</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;fun in SubFoo&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=n>SubFoo</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>.</span><span class=n>fun</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=cached_property>@cached_property</h2><p>每个实例只计算一次的属性，然后用普通属性替换自身。删除属性将重置属性。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>cached_property</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    A property that is only computed once per instance and then replaces itself
</span></span></span><span class=line><span class=cl><span class=s2>    with an ordinary attribute. Deleting the attribute resets the property.
</span></span></span><span class=line><span class=cl><span class=s2>    Source: https://github.com/bottlepy/bottle/commit/fa7733e075da0d790d809aa3d2f53071897e6f76
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>  <span class=c1># noqa</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=vm>__doc__</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>func</span><span class=p>,</span> <span class=s2>&#34;__doc__&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>func</span> <span class=o>=</span> <span class=n>func</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__get__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>obj</span><span class=p>,</span> <span class=bp>cls</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>obj</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span> <span class=o>=</span> <span class=n>obj</span><span class=o>.</span><span class=vm>__dict__</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>func</span><span class=p>(</span><span class=n>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>value</span>
</span></span></code></pre></td></tr></table></div></div><p>其实就保存到实例字典 <code>__dict__</code> 中, 避免多次调用重复计算</p><p>举个例子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>test1</span> <span class=o>=</span> <span class=s1>&#39;aaa&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>age</span> <span class=o>=</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@cached_property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>real_age</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>age</span> <span class=o>+</span> <span class=mi>19</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>Test</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=n>t</span><span class=o>.</span><span class=n>real_age</span>  <span class=c1># 39</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=n>t</span><span class=o>.</span><span class=vm>__dict__</span>  <span class=c1># {&#39;real_age&#39;: 39, &#39;age&#39;: 20}, 不加装饰器就不存在__dict__中了</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=typingtypeddict>typing.TypedDict</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>typing</span><span class=o>.</span><span class=n>TypedDict</span><span class=p>(</span><span class=nb>dict</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>向字典添加类型提示的特殊构造。在运行时，它是一个普通的 <a href=https://vimsky.com/examples/usage/python-dict-py.html target=_blank rel="external nofollow noopener noreferrer"><code>dict</code></a> 。</p><p><code>TypedDict</code> 声明了一个字典类型，它期望它的所有实例都有一组特定的键，其中每个键都与一个一致类型的值相关联。这种期望不会在运行时检查，但仅由类型检查器强制执行。用法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>Point2D</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>label</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=p>:</span> <span class=n>Point2D</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;x&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;y&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;good&#39;</span><span class=p>}</span>  <span class=c1># OK</span>
</span></span><span class=line><span class=cl><span class=n>b</span><span class=p>:</span> <span class=n>Point2D</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;z&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;bad&#39;</span><span class=p>}</span>           <span class=c1># Fails type check</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=n>Point2D</span><span class=p>(</span><span class=n>x</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>y</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;first&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=nb>dict</span><span class=p>(</span><span class=n>x</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>y</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;first&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>允许在不支持的旧版本 Python 中使用此函数<a href="https://vimsky.com/cache/index.php?source=https%3A//www.python.org/dev/peps/pep-0526" target=_blank rel="external nofollow noopener noreferrer"><strong>PEP 526</strong></a>，<code>TypedDict</code>支持另外两种等效的句法形式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>Point2D</span> <span class=o>=</span> <span class=n>TypedDict</span><span class=p>(</span><span class=s1>&#39;Point2D&#39;</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span> <span class=n>y</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=nb>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Point2D</span> <span class=o>=</span> <span class=n>TypedDict</span><span class=p>(</span><span class=s1>&#39;Point2D&#39;</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;x&#39;</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=s1>&#39;y&#39;</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>当键不是一个有效的标识符 / 关键字时，也应该使用函数语法，例如因为它们是关键字或包含连字符。例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># raises SyntaxError</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Point2D</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=ow>in</span><span class=p>:</span> <span class=nb>int</span>  <span class=c1># &#39;in&#39; is a keyword</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=o>-</span><span class=n>y</span><span class=p>:</span> <span class=nb>int</span>  <span class=c1># name with hyphens</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># OK, functional syntax</span>
</span></span><span class=line><span class=cl><span class=n>Point2D</span> <span class=o>=</span> <span class=n>TypedDict</span><span class=p>(</span><span class=s1>&#39;Point2D&#39;</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;in&#39;</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=s1>&#39;x-y&#39;</span><span class=p>:</span> <span class=nb>int</span><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>默认情况下，所有键都必须存在于 <code>TypedDict</code> 中。可以通过指定整体来覆盖它。用法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>Point2D</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>,</span> <span class=n>total</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span><span class=p>:</span> <span class=nb>int</span>
</span></span></code></pre></td></tr></table></div></div><p>这意味着 <code>Point2D</code> <code>TypedDict</code> 可以省略任何键。类型检查器仅应支持文字 <code>False</code> 或 <code>True</code> 作为 <code>total</code> 参数的值。 <code>True</code> 是默认值，它使类主体中定义的所有项都成为必需项。</p><p><code>TypedDict</code> 类型可以使用基于类的语法从一个或多个其他 <code>TypedDict</code> 类型继承。用法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>Point3D</span><span class=p>(</span><span class=n>Point2D</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>z</span><span class=p>:</span> <span class=nb>int</span>
</span></span></code></pre></td></tr></table></div></div><p><code>Point3D</code> 具有三个项目： <code>x</code> 、 <code>y</code> 和 <code>z</code> 。它等价于这个定义：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>Point3D</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>z</span><span class=p>:</span> <span class=nb>int</span>
</span></span></code></pre></td></tr></table></div></div><p><code>TypedDict</code> 不能从非 TypedDict 类继承，特别是包括 <a href=https://vimsky.com/examples/usage/python-typing.Generic-py.html target=_blank rel="external nofollow noopener noreferrer"><code>Generic</code></a> 。例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>X</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Y</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Z</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span> <span class=k>pass</span>  <span class=c1># A non-TypedDict class</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>XY</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>Y</span><span class=p>):</span> <span class=k>pass</span>  <span class=c1># OK</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>XZ</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>Z</span><span class=p>):</span> <span class=k>pass</span>  <span class=c1># raises TypeError</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>T</span> <span class=o>=</span> <span class=n>TypeVar</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>XT</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>Generic</span><span class=p>[</span><span class=n>T</span><span class=p>]):</span> <span class=k>pass</span>  <span class=c1># raises TypeError</span>
</span></span></code></pre></td></tr></table></div></div><p><code>TypedDict</code> 可以通过注解字典(有关注解最佳实践的更多信息，请参阅注解最佳实践)、<a href=https://vimsky.com/examples/usage/python-typing.TypedDict.__total__-py.html target=_blank rel="external nofollow noopener noreferrer"><code>__total__</code></a>、<a href="https://vimsky.com/cache/index.php?source=https%3A//docs.python.org/3/library/typing.html%23typing.TypedDict.__required_keys__" target=_blank rel="external nofollow noopener noreferrer"><code>__required_keys__</code></a> 和 <a href=https://vimsky.com/examples/usage/python-typing.TypedDict.__optional_keys__-py.html target=_blank rel="external nofollow noopener noreferrer"><code>__optional_keys__</code></a> 进行自省。</p><h2 id=多等于号表达式>多等于号表达式</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>i</span><span class=o>=</span><span class=mi>7</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=o>=</span><span class=n>b</span><span class=o>=</span><span class=n>c</span><span class=o>=</span><span class=n>d</span><span class=o>=</span><span class=n>e</span><span class=o>=</span><span class=n>f</span><span class=o>=</span><span class=n>g</span><span class=o>=</span><span class=n>h</span><span class=o>=</span><span class=n>i</span>
</span></span></code></pre></td></tr></table></div></div><p>形如 <code>a=b=c=d...=X</code></p><p>左边不管有多少个变量之间用等于号连接，都仅仅是为了声明</p><p>最右边的那个等于号左边的所有变量（a=b=c=d…） 都等于 它右边的那个变量（=X）。</p><p>注意，如果最后赋值的是一个列表，前面的变量都会指向一个列表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>i</span><span class=o>=</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>=</span><span class=n>b</span><span class=o>=</span><span class=n>c</span><span class=o>=</span><span class=n>i</span>
</span></span><span class=line><span class=cl><span class=c1># 相当于</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>=</span><span class=n>i</span>
</span></span><span class=line><span class=cl><span class=n>b</span><span class=o>=</span><span class=n>i</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>=</span><span class=n>i</span>
</span></span><span class=line><span class=cl><span class=c1># 所以他们指向同一个列表</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=__getattribute____getattr__-与-__setattr__><code>__getattribute__</code>，<code>__getattr__</code> 与 <code>__setattr__</code></h2><h3 id=__getattribute__><code>__getattribute__</code></h3><p>官方文档中描述如下：</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190227235511751-1561689135.jpg" data-srcset="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190227235511751-1561689135.jpg, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190227235511751-1561689135.jpg 1.5x, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190227235511751-1561689135.jpg 2x" data-sizes=auto alt="https://cubox.pro/c/filters:no_upscale()?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190227235511751-1561689135.jpg" title=img></p><p>该方法可以拦截对对象属性的所有访问企图，当属性被访问时，自动调用该方法（只适用于新式类）。因此常用于实现一些访问某属性时执行一段代码的特性。</p><p>需要注意的是，正式由于它拦截对所有属性的访问（包括对 <code>__dict__</code> 的访问），在使用中要十分小心地避开无限循环的陷阱。在 <code>__getattribute__</code> 方法中访问当前实例的属性时，唯一安全的方式是使用基类（超类） 的方法 <code>__getattribute__</code>（使用 super）。例如：</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228001823704-1074512655.jpg" data-srcset="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228001823704-1074512655.jpg, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228001823704-1074512655.jpg 1.5x, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228001823704-1074512655.jpg 2x" data-sizes=auto alt="https://cubox.pro/c/filters:no_upscale()?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228001823704-1074512655.jpg" title=img></p><p>通过上图中的代码示例可以看出，一旦实现了 <code>__getattribute__</code> 方法，所有通过对象访问的属性（包括类属性）都会被拦截，而直接通过类访问类属性则不会。</p><p>注意：当访问的属性不存在并重载（覆盖基类对某方法的默认实现）了 <code>__getattribute__</code> 方法时，该方法不会主动抛出 AttributeError 异常。上图中捕获的 AttributeError 异常，是由基类 <code>__getattribute__</code> 方法实现并抛出。</p><p>常见的错误用法示例：</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228004359925-759347249.jpg" data-srcset="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228004359925-759347249.jpg, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228004359925-759347249.jpg 1.5x, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228004359925-759347249.jpg 2x" data-sizes=auto alt="https://cubox.pro/c/filters:no_upscale()?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228004359925-759347249.jpg" title=img></p><p>在实现 <code>__getattribute__</code> 方法时访问对象自身的属性，程序陷入无限循环直到崩溃。</p><h3 id=__getattr__><code>__getattr__</code></h3><p>官方文档描述如下：</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228003257402-1419805854.jpg" data-srcset="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228003257402-1419805854.jpg, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228003257402-1419805854.jpg 1.5x, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228003257402-1419805854.jpg 2x" data-sizes=auto alt="https://cubox.pro/c/filters:no_upscale()?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228003257402-1419805854.jpg" title=img></p><p><code>__getattr__</code> 方法的自动执行，需要满足两个条件：</p><ol><li><strong>访问对象属性；</strong></li><li><strong>触发 AttributeError 异常。</strong></li></ol><p>代码示例如下：</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228012749904-1702916869.jpg" data-srcset="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228012749904-1702916869.jpg, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228012749904-1702916869.jpg 1.5x, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228012749904-1702916869.jpg 2x" data-sizes=auto alt="https://cubox.pro/c/filters:no_upscale()?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228012749904-1702916869.jpg" title=img></p><p>上图中，调用不存在的 job 属性首先调用 <code>__getattribute__</code> 方法（如果该方法未定义，会调用基类的<code>__getattribute__</code> 方法），触发 AttributeError 异常并自动捕获，然后才调用 <code>__getattr__</code> 方法。</p><p>错误用法示例如下：</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228013524395-1514972473.jpg" data-srcset="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228013524395-1514972473.jpg, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228013524395-1514972473.jpg 1.5x, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228013524395-1514972473.jpg 2x" data-sizes=auto alt="https://cubox.pro/c/filters:no_upscale()?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228013524395-1514972473.jpg" title=img></p><p>重载了 <code>__getattribute__</code> 方法，却没有主动抛出 AttributeError 异常的机制，或者抛出一个其它类型的异常，<code>__getattr__</code> 方法都不会执行</p><h3 id=__getattr__-1><code>__getattr__</code></h3><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228013939475-1601706771.jpg" data-srcset="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228013939475-1601706771.jpg, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228013939475-1601706771.jpg 1.5x, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228013939475-1601706771.jpg 2x" data-sizes=auto alt="https://cubox.pro/c/filters:no_upscale()?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228013939475-1601706771.jpg" title=img></p><p>试图给属性赋值时自动调用该方法，例如：</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228020837089-313560767.jpg" data-srcset="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228020837089-313560767.jpg, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228020837089-313560767.jpg 1.5x, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228020837089-313560767.jpg 2x" data-sizes=auto alt="https://cubox.pro/c/filters:no_upscale()?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228020837089-313560767.jpg" title=img></p><p>之所以会执行三次 print 函数，是因为在 <code>__init__</code> 方法中，对象 A 初始化时给属性 name 和 age 赋值时，触发了<code>__setattr__</code> 方法。使用该方法是同样需要十分小心避免无限循环陷阱。</p><p>错误用法示例如下：</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228021331657-944987695.jpg" data-srcset="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228021331657-944987695.jpg, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228021331657-944987695.jpg 1.5x, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228021331657-944987695.jpg 2x" data-sizes=auto alt="https://cubox.pro/c/filters:no_upscale()?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228021331657-944987695.jpg" title=img></p><p>可以看出，在 <code>__setattr__</code> 方法中，不能直接给属性赋值，而通常的做法是<strong>使用 <code>__dict__</code> 魔法属性</strong>。</p><p><code>__dict__</code> 属性是一个字典，所有的实例属性都存储在这个字典中，而修改 <code>__dict__</code> 字典中的键值对成员不会触发 <code>__setattr__</code> 方法，这里应注意与直接修改 <code>__dict__</code> 的值的区别。</p><p>注意：如果定义 <code>__setattr__</code> 方法的同时定义了 <code>__getattribute__</code> 方法，那么在修改 <code>__dict__</code> 字典中的键值对时，由于调用了 <code>self.__dict__</code> 属性，同样会触发 <code>__getattribute__</code> 方法，使用时应格外小心。代码示例如下：</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228023113726-1040716447.jpg" data-srcset="https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228023113726-1040716447.jpg, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228023113726-1040716447.jpg 1.5x, https://cubox.pro/c/filters:no_upscale%28%29?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228023113726-1040716447.jpg 2x" data-sizes=auto alt="https://cubox.pro/c/filters:no_upscale()?imageUrl=https%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1606258%2F201902%2F1606258-20190228023113726-1040716447.jpg" title=img></p><p>上图示例代码中，每调用一次 <code>__setattr__</code> 就会调用一次 <code>__getattribute__</code>。</p><p><strong>注意赋值语句与属性调用的区别</strong>：<code>self.__dict__ = {}</code> 是赋值语句，不会触发 <code>__getattribute__</code> 方法，但触发 <code>__setattr__</code> 方法；<code>self.__dict__[name] = value</code> 语句，先调用 <code>self.__dict__</code> 属性，得到 dict 对象后再修改其成员，因此会触发 <code>__getattribute__</code> 方法。</p><h2 id=__enter__-与-__exit__><code>__enter__</code> 与 <code>__exit__</code></h2><p>在 python 中实现了 <code>__enter__</code> 和 <code>__exit__</code> 方法，即<strong>支持上下文管理器协议</strong>。</p><p>上下文管理器就是支持上下文管理器协议的对象，它是为了 with 而生。</p><ul><li>当 with 语句在开始运行时，会在上下文管理器对象上调用 <code>__enter__</code> 方法。</li><li>with 语句运行结束后，会在上下文管理器对象上调用 <code>__exit__</code> 方法</li></ul><p>with 的语法:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>with</span> <span class=n>EXPR</span> <span class=k>as</span> <span class=n>VAR</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>BLOCK</span>
</span></span></code></pre></td></tr></table></div></div><p>这是上面语法的伪代码:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>mgr</span> <span class=o>=</span> <span class=p>(</span><span class=n>EXPR</span><span class=p>)</span>   
</span></span><span class=line><span class=cl><span class=n>exit</span> <span class=o>=</span> <span class=nb>type</span><span class=p>(</span><span class=n>mgr</span><span class=p>)</span><span class=o>.</span><span class=fm>__exit__</span>  <span class=c1># Not calling it yet</span>
</span></span><span class=line><span class=cl><span class=n>value</span> <span class=o>=</span> <span class=nb>type</span><span class=p>(</span><span class=n>mgr</span><span class=p>)</span><span class=o>.</span><span class=fm>__enter__</span><span class=p>(</span><span class=n>mgr</span><span class=p>)</span>    
</span></span><span class=line><span class=cl><span class=n>exc</span> <span class=o>=</span> <span class=kc>True</span>     
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>VAR</span> <span class=o>=</span> <span class=n>value</span>  <span class=c1># Only if &#34;as VAR&#34; is present</span>
</span></span><span class=line><span class=cl>        <span class=n>BLOCK</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># The exceptional case is handled here</span>
</span></span><span class=line><span class=cl>        <span class=n>exc</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>exit</span><span class=p>(</span><span class=n>mgr</span><span class=p>,</span> <span class=o>*</span><span class=n>sys</span><span class=o>.</span><span class=n>exc_info</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>        <span class=c1># The exception is swallowed if exit() returns true</span>
</span></span><span class=line><span class=cl><span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># The normal and non-local-goto cases are handled here</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>exc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>mgr</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>生成上下文管理器 mgr</li><li>如果没有发现 <code>__exit__</code>, <code>__enter__</code> 两个方法，解释器会抛出 AttributeError 异常</li><li>调用上下文管理器的 <code>__enter__()</code> 方法</li><li>如果语法里的 as VAR 没有写，那么伪代码里的 VAR= 这部分也会同样被忽略</li><li>如果 BLOCK 中的代码正常结束，或者是通过 break，continue，return 来结束，<code>__exit__()</code> 会使用三个 None 的参数来返回</li><li>如果执行过程中出现异常，则使用 <code>sys.exc_info</code> 的异常信息为参数调用 <code>__exit__(exc_type, exc_value, exc_traceback)</code></li></ol><p>之前我们对文件的操作是这样的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;filename&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Unexpected error:&#34;</span><span class=p>,</span> <span class=n>sys</span><span class=o>.</span><span class=n>exc_info</span><span class=p>()[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>readlines</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>现在有了 with 语句可以使代码更加简洁，减少编码量,下面的语句会在执行完后自动关闭文件（即使出现异常也会）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;example.info&#39;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>readlines</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p>一个例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>TmpTest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>filename</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>filename</span><span class=o>=</span><span class=n>filename</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>filename</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exc_type</span><span class=p>,</span> <span class=n>exc_val</span><span class=p>,</span> <span class=n>exc_tb</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>test</span><span class=o>=</span><span class=n>TmpTest</span><span class=p>(</span><span class=s1>&#39;file&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>test</span> <span class=k>as</span> <span class=n>t</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;test result: </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>t</span><span class=p>))</span><span class=n>返回</span><span class=p>:</span>
</span></span></code></pre></td></tr></table></div></div><p>返回：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>test</span> result: None
</span></span></code></pre></td></tr></table></div></div><p>如果在 <code>__init__</code> 或者 <code>__enter__</code> 中抛出异常，则不会进入到 <code>__exit__</code> 中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>TmpTest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>filename</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>filename</span><span class=o>=</span><span class=n>filename</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;__init__&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ImportError</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>filename</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;__enter__&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exc_type</span><span class=p>,</span> <span class=n>exc_val</span><span class=p>,</span> <span class=n>exc_tb</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;__exit__&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>test</span> <span class=o>=</span> <span class=n>TmpTest</span><span class=p>(</span><span class=s1>&#39;file&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>test</span> <span class=k>as</span> <span class=n>t</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;test result: </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>t</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>返回：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=fm>__init__</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;D:/pythonScript/leetcode/leetcode.py&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>14</span><span class=p>,</span> <span class=ow>in</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>test</span><span class=o>=</span><span class=n>TmpTest</span><span class=p>(</span><span class=s1>&#39;file&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;D:/pythonScript/leetcode/leetcode.py&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>5</span><span class=p>,</span> <span class=ow>in</span> <span class=fm>__init__</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=ne>ImportError</span>
</span></span><span class=line><span class=cl><span class=ne>ImportError</span>
</span></span></code></pre></td></tr></table></div></div><p>如果在 <code>__exit__</code> 中返回 True，则不会产生异常：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>TmpTest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>filename</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>filename</span><span class=o>=</span><span class=n>filename</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;__init__&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>filename</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;__enter__&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exc_type</span><span class=p>,</span> <span class=n>exc_val</span><span class=p>,</span> <span class=n>exc_tb</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;__exit__ </span><span class=si>{}</span><span class=s2> &#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>exc_type</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>test</span><span class=o>=</span><span class=n>TmpTest</span><span class=p>(</span><span class=s1>&#39;file&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>test</span> <span class=k>as</span> <span class=n>t</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;test result: </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>t</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=ne>ImportError</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;no error&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>返回：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=fm>__init__</span>
</span></span><span class=line><span class=cl><span class=fm>__enter__</span>
</span></span><span class=line><span class=cl><span class=n>test</span> <span class=n>result</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>_io</span><span class=o>.</span><span class=n>TextIOWrapper</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;file&#39;</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;r&#39;</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;cp936&#39;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=fm>__exit__</span> <span class=o>&lt;</span><span class=k>class</span> <span class=err>&#39;</span><span class=nc>ImportError</span><span class=s1>&#39;&gt;</span>
</span></span><span class=line><span class=cl><span class=n>no</span> <span class=n>error</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=结构化模式匹配>结构化模式匹配</h2><blockquote><p>Structural Pattern Match</p></blockquote><p>Python 3.10 的新特性</p><p>在模式匹配出现之前，对于分支相当多的判断语句，Python 建议通过<strong>字典映射</strong>（dictionary mapping）来实现。</p><h3 id=字典映射>字典映射</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>function_map</span><span class=p>(</span><span class=n>option</span><span class=p>):</span>
</span></span><span class=line><span class=cl>     <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=mi>1</span><span class=p>:</span> <span class=k>lambda</span> <span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;You have chose option 1.&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=mi>2</span><span class=p>:</span> <span class=k>lambda</span> <span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;You have chose option 2.&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=mi>3</span><span class=p>:</span> <span class=k>lambda</span> <span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;You have chose option 3.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>option</span><span class=p>,</span> <span class=k>lambda</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Sorry you chose an invalid option.&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>function_map</span><span class=p>(</span><span class=mi>3</span><span class=p>)()</span>
</span></span></code></pre></td></tr></table></div></div><p>借助字典这种数据结构，以匹配条件作为键值，一一对应匹配后需要执行的命令。将 <code>switch</code> 结构中的条件判断转化为对字典键值的搜索匹配。</p><h3 id=pattern-match>Pattern Match</h3><p>用模式匹配实现 <code>switch-case</code> 语法，从形式上看就直观了很多：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>option</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>match</span> <span class=n>option</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;You have chosen option 1.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;You have chosen option 2.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;You have chosen option 3.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>_</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;You chose an invalid option.&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>实际上模式匹配不只有创建流程上的分支结构这一种功能，它的作用可以比单纯的 <code>switch-case</code> 语法强大的多。</p><p>模式匹配其实可以拆成两部分来理解：匹配和模式。</p><ul><li>匹配部分可以发挥类似于 <code>if-else</code> 和 <code>switch</code> 等条件判断语句的作用，生成一种分支结构；</li><li>模式则定义了特定的规则即匹配的具体条件。更进一步的，还会对匹配到的对象进行<strong>解构</strong>（destructuring）或者说<strong>拆包</strong>（unpacking）</li></ul><p>以不同于模式匹配的正则表达式来说：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>source_str</span> <span class=o>=</span> <span class=s1>&#39;cats are cute&#39;</span>
</span></span><span class=line><span class=cl><span class=n>pattern</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=s1>&#39;(.*) are (.*)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>matched</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=k>match</span><span class=p>(</span><span class=n>pattern</span><span class=p>,</span> <span class=n>source_str</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>matched</span><span class=o>.</span><span class=n>groups</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=c1># =&gt; (&#39;cats&#39;, &#39;cute&#39;)</span>
</span></span></code></pre></td></tr></table></div></div><p>正则表达式规则中的 <code>(.*)</code> 分别匹配到源字符串中的 <code>cats</code> 和 <code>cute</code>，与此同时，还把这两个匹配项提取了出来。</p><p>而模式匹配相对来说，则不仅仅能够匹配和提取 <code>cats</code>、<code>cute</code> 等字符串类型，还能够匹配更复杂类型的对象，同时对匹配到的对象进行拆包操作</p><p>比如下面的代码就对类型为元组的对象进行了匹配和拆包：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>match_person</span><span class=p>(</span><span class=n>person</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=n>person</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=s1>&#39;M&#39;</span><span class=p>,</span> <span class=n>age</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;He is </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>, aged </span><span class=si>{</span><span class=n>age</span><span class=si>}</span><span class=s1>.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=s1>&#39;F&#39;</span><span class=p>,</span> <span class=n>age</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;She is </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>, aged </span><span class=si>{</span><span class=n>age</span><span class=si>}</span><span class=s1>.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=p>(</span><span class=n>name</span><span class=p>,):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;We only know the name is </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>, others are secrets.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>person_A</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39;John&#39;</span><span class=p>,</span> <span class=s1>&#39;M&#39;</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>person_B</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39;Jenny&#39;</span><span class=p>,</span> <span class=s1>&#39;F&#39;</span><span class=p>,</span> <span class=mi>18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>person_C</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39;Lily&#39;</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>match_person</span><span class=p>(</span><span class=n>person_A</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># =&gt; He is John, aged 20.</span>
</span></span><span class=line><span class=cl><span class=n>match_person</span><span class=p>(</span><span class=n>person_B</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># =&gt; She is Jenny, aged 18.</span>
</span></span><span class=line><span class=cl><span class=n>match_person</span><span class=p>(</span><span class=n>person_C</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># =&gt; We only know the name is Lily, others are secrets.</span>
</span></span></code></pre></td></tr></table></div></div><p>⭐ <code>match</code> 关键字后面被匹配的对象，支持很多种复杂的类型。对应的 <code>case</code> 关键字后面的模式也同样灵活：</p><ul><li>列表或元组，如 <code>(name, 18)</code></li><li>字典，如 <code>{"name": name, "age": 18}</code></li><li>使用 <code>*</code> 匹配列表中的剩余部分，如 <code>[first, *rest]</code></li><li>使用 <code>**</code> 匹配字典中的剩余部分</li><li>匹配对象和对象的属性</li><li>在模式中可以使用 <code>|</code> 逻辑或操作</li></ul><h3 id=模式匹配应用实例>模式匹配应用实例</h3><p>创建一个 Python 程序，模拟交互式命令行的行为。</p><h4 id=匹配字符串>匹配字符串</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>run_command</span><span class=p>(</span><span class=n>command</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=n>command</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s2>&#34;quit&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Quitting the program.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>quit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s2>&#34;reset&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Resetting the system.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>other</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unknown command: </span><span class=si>{</span><span class=n>other</span><span class=si>!r}</span><span class=s2>.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>command</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;$ &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>run_command</span><span class=p>(</span><span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>运行效果如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>$ reset
</span></span><span class=line><span class=cl>Resetting the system.
</span></span><span class=line><span class=cl>$ abcdefg
</span></span><span class=line><span class=cl>Unknown command: &#39;abcdefg&#39;.
</span></span><span class=line><span class=cl>$ quit
</span></span><span class=line><span class=cl>Quitting the program.
</span></span></code></pre></td></tr></table></div></div><h4 id=匹配列表>匹配列表</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>run_command</span><span class=p>(</span><span class=n>command</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=n>command</span><span class=o>.</span><span class=n>split</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=p>[</span><span class=s2>&#34;load&#34;</span><span class=p>,</span> <span class=n>filename</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Loading file: </span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=p>[</span><span class=s2>&#34;save&#34;</span><span class=p>,</span> <span class=n>filename</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Saving to file: </span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=p>[</span><span class=s2>&#34;quit&#34;</span> <span class=o>|</span> <span class=s2>&#34;exit&#34;</span> <span class=o>|</span> <span class=s2>&#34;bye&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Quitting the program.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>quit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>_</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unkown command: </span><span class=si>{</span><span class=n>command</span><span class=si>!r}</span><span class=s2>.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>command</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;$ &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>run_command</span><span class=p>(</span><span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>运行效果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>$ load input_data.txt
</span></span><span class=line><span class=cl>Loading file: input_data.txt.
</span></span><span class=line><span class=cl>$ save output_data.txt
</span></span><span class=line><span class=cl>Saving to file: output_data.txt.
</span></span><span class=line><span class=cl>$ load input_data.txt output_data.txt
</span></span><span class=line><span class=cl>Unkown command: &#39;load input_data.txt output_data.txt&#39;.
</span></span><span class=line><span class=cl>$ bye
</span></span><span class=line><span class=cl>Quitting the program.
</span></span></code></pre></td></tr></table></div></div><h4 id=匹配对象>匹配对象</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>shlex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Command</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>command</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>arguments</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run_command</span><span class=p>(</span><span class=n>command</span><span class=p>:</span> <span class=n>Command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=n>command</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>Command</span><span class=p>(</span><span class=n>command</span><span class=o>=</span><span class=s2>&#34;load&#34;</span><span class=p>,</span> <span class=n>arguments</span><span class=o>=</span><span class=p>[</span><span class=n>filename</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Loading file: </span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>Command</span><span class=p>(</span><span class=n>command</span><span class=o>=</span><span class=s2>&#34;save&#34;</span><span class=p>,</span> <span class=n>arguments</span><span class=o>=</span><span class=p>[</span><span class=n>filename</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Saving to file: </span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>Command</span><span class=p>(</span><span class=n>command</span><span class=o>=</span><span class=s2>&#34;quit&#34;</span> <span class=o>|</span> <span class=s2>&#34;exit&#34;</span> <span class=o>|</span> <span class=s2>&#34;bye&#34;</span><span class=p>,</span> <span class=n>arguments</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;--force&#34;</span> <span class=o>|</span> <span class=s2>&#34;-f&#34;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Sending SIGTERM and quitting the program.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>quit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>Command</span><span class=p>(</span><span class=n>command</span><span class=o>=</span><span class=s2>&#34;quit&#34;</span> <span class=o>|</span> <span class=s2>&#34;exit&#34;</span> <span class=o>|</span> <span class=s2>&#34;bye&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Quitting the program.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>quit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>_</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unknown command: </span><span class=si>{</span><span class=n>command</span><span class=si>!r}</span><span class=s2>.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>command</span><span class=p>,</span> <span class=o>*</span><span class=n>arguments</span> <span class=o>=</span> <span class=n>shlex</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=nb>input</span><span class=p>(</span><span class=s2>&#34;$ &#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>run_command</span><span class=p>(</span><span class=n>Command</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>arguments</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>运行效果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ not a <span class=nb>command</span>
</span></span><span class=line><span class=cl>Unknown command: Command<span class=o>(</span><span class=nv>command</span><span class=o>=</span><span class=s1>&#39;not&#39;</span>, <span class=nv>arguments</span><span class=o>=[</span><span class=s1>&#39;a&#39;</span>, <span class=s1>&#39;command&#39;</span><span class=o>])</span>.
</span></span><span class=line><span class=cl>$ load input_data.txt
</span></span><span class=line><span class=cl>Loading file: input_data.txt.
</span></span><span class=line><span class=cl>$ save output_data.txt
</span></span><span class=line><span class=cl>Saving to file: output_data.txt.
</span></span><span class=line><span class=cl>$ <span class=nb>exit</span> -f
</span></span><span class=line><span class=cl>Sending SIGTERM and quitting the program.
</span></span></code></pre></td></tr></table></div></div><p>假如 <code>case Command(command="quit" | "exit" | "bye")</code> 为规则 1，<code>Command(command="quit" | "exit" | "bye", arguments=["--force" | "-f"])</code> 为规则 2。</p><p>则更具体一些的规则 2 要放在规则 1 前面。</p><p>⭐ 因为模式匹配是<strong>从上到下依次</strong>检查每一个 case 语句，若遇到匹配的模式，则执行对应的命令。不再继续向下匹配。</p><p>由于严格符合规则 2 的对象一定也符合规则 1，当规则 1 位于规则 2 前面时，规则 2 永远也没有被匹配的机会。</p><p>可以想象成一种逐渐“滑落”的过程。比如写一个计算成绩等级的函数，可以这样实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>grade</span><span class=p>(</span><span class=n>score</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>score</span> <span class=o>&gt;=</span> <span class=mi>90</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;A&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>score</span> <span class=o>&gt;=</span> <span class=mi>70</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;B&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>score</span> <span class=o>&gt;=</span> <span class=mi>60</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;C&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>如果上面 <code>if-else</code> 的条件反着排，那就，所有人都是 C 了</p><h2 id=装饰器进阶>装饰器进阶</h2><h3 id=一般装饰器>一般装饰器</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>debug</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=c1># wrapper 这一层的代码，会在函数定义时运行</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[DEBUG]: enter </span><span class=si>{}</span><span class=s2>()&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>func</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@debug</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>hello</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>hello</span><span class=p>()</span> 
</span></span><span class=line><span class=cl><span class=c1># hello 本身是一个函数，实际上就是 debug.wrapper</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>-----------------------------</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span><span class=p>[</span><span class=n>DEBUG</span><span class=p>]:</span> <span class=n>enter</span> <span class=n>hello</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span><span class=n>hello</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=带参数的装饰器>带参数的装饰器</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>logging</span><span class=p>(</span><span class=n>level</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>outwrapper</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># outwrapper 这一层的代码，会在函数定义时运行</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[</span><span class=si>{0}</span><span class=s2>]: enter </span><span class=si>{1}</span><span class=s2>()&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>level</span><span class=p>,</span> <span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>outwrapper</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@logging</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=s2>&#34;INFO&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>hello</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>hello</span><span class=p>(</span><span class=s2>&#34;hello,&#34;</span><span class=p>,</span><span class=s2>&#34;good&#34;</span><span class=p>,</span><span class=s2>&#34;morning&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>-----------------------------</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span><span class=p>[</span><span class=n>INFO</span><span class=p>]:</span> <span class=n>enter</span> <span class=n>hello</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span><span class=n>hello</span><span class=p>,</span> <span class=n>good</span> <span class=n>morning</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=装饰器不一定会执行被装饰的函数>装饰器不一定会执行被装饰的函数</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>global_handlers</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>out</span><span class=p>(</span><span class=n>handler_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>inner</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 在函数定义时运行</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;defining </span><span class=si>{}</span><span class=s1>, </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span> <span class=n>handler_name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>global_handlers</span><span class=p>[</span><span class=n>handler_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>func</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>inner</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1># 在定义 mul 和 sub 的时候，实际上已经执行了 out.inner</span>
</span></span><span class=line><span class=cl><span class=nd>@out</span><span class=p>(</span><span class=s2>&#34;handler1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mul</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>a</span> <span class=o>*</span> <span class=n>b</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nd>@out</span><span class=p>(</span><span class=s2>&#34;handler2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sub</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>a</span> <span class=o>-</span> <span class=n>b</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>global_handlers</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>global_handlers</span><span class=p>[</span><span class=s2>&#34;handler1&#34;</span><span class=p>](</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>global_handlers</span><span class=p>[</span><span class=s2>&#34;handler2&#34;</span><span class=p>](</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>mul</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>-----------------------------</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span><span class=n>defining</span> <span class=n>mul</span><span class=p>,</span> <span class=n>handler1</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span><span class=n>defining</span> <span class=n>sub</span><span class=p>,</span> <span class=n>handler2</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span><span class=p>{</span><span class=s1>&#39;handler1&#39;</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>function</span> <span class=n>mul</span> <span class=n>at</span> <span class=mh>0x7fb908aa9160</span><span class=o>&gt;</span><span class=p>,</span> <span class=s1>&#39;handler2&#39;</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>function</span> <span class=n>sub</span> <span class=n>at</span> <span class=mh>0x7fb908aa91f0</span><span class=o>&gt;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span><span class=mi>6</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span><span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span><span class=kc>None</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=类装饰器>类装饰器</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>logging</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>func</span> <span class=o>=</span> <span class=n>func</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[DEBUG]: enter </span><span class=si>{}</span><span class=s2>()&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@logging</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>hello</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>hello</span><span class=p>(</span><span class=s2>&#34;hello,&#34;</span><span class=p>,</span><span class=s2>&#34;good&#34;</span><span class=p>,</span><span class=s2>&#34;morning&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>-----------------------------</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span><span class=p>[</span><span class=n>DEBUG</span><span class=p>]:</span> <span class=n>enter</span> <span class=n>hello</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span><span class=n>hello</span><span class=p>,</span> <span class=n>good</span> <span class=n>morning</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=带参数的类装饰器>带参数的类装饰器</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>logging</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>level</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>level</span> <span class=o>=</span> <span class=n>level</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[</span><span class=si>{0}</span><span class=s2>]: enter </span><span class=si>{1}</span><span class=s2>()&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>level</span><span class=p>,</span> <span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@logging</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=s2>&#34;TEST&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>hello</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>hello</span><span class=p>(</span><span class=s2>&#34;hello,&#34;</span><span class=p>,</span><span class=s2>&#34;good&#34;</span><span class=p>,</span><span class=s2>&#34;morning&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>-----------------------------</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span><span class=p>[</span><span class=n>TEST</span><span class=p>]:</span> <span class=n>enter</span> <span class=n>hello</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span><span class=n>hello</span><span class=p>,</span> <span class=n>good</span> <span class=n>morning</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=对象装饰器>对象装饰器</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>Manager</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>handler_map</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>handler_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>inner</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>handler_map</span><span class=p>[</span><span class=n>handler_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>func</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>inner</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>do_execute</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>handler_name</span><span class=p>,</span> <span class=n>func</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>handler_map</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;现在我正在执行: </span><span class=si>{</span><span class=n>handler_name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>func</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run1</span><span class=p>(</span><span class=n>reg</span><span class=p>:</span> <span class=n>Manager</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@reg</span><span class=p>(</span><span class=s1>&#39;mul&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>mul</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>a</span> <span class=o>*</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=nd>@reg</span><span class=p>(</span><span class=s1>&#39;sub&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>sub</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>a</span> <span class=o>-</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run2</span><span class=p>(</span><span class=n>reg</span><span class=p>:</span> <span class=n>Manager</span><span class=p>):</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=nd>@reg</span><span class=p>(</span><span class=s1>&#39;add&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>    <span class=nd>@reg</span><span class=p>(</span><span class=s1>&#39;sub&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>sub</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;I am a new sub&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>a</span> <span class=o>-</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl><span class=n>reg</span> <span class=o>=</span> <span class=n>Manager</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>run1</span><span class=p>(</span><span class=n>reg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>run2</span><span class=p>(</span><span class=n>reg</span><span class=p>)</span> <span class=c1># run2 中的 sub 会覆盖 run1 中的 sub</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>reg</span><span class=o>.</span><span class=n>handler_map</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>reg</span><span class=o>.</span><span class=n>do_execute</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=mixin-类的组合思想>Mixin 类的组合思想</h2><p>类有下面的继承关系</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://atts.w3cschool.cn/attachments/2021051214384992.png data-srcset="https://atts.w3cschool.cn/attachments/2021051214384992.png, https://atts.w3cschool.cn/attachments/2021051214384992.png 1.5x, https://atts.w3cschool.cn/attachments/2021051214384992.png 2x" data-sizes=auto alt=https://atts.w3cschool.cn/attachments/2021051214384992.png title=img></p><p>文档 Document 类是其他所有文档类的抽象基类，Word、Pdf 类是 Document 的子类</p><p>需求：为 Document 子类提供打印能力</p><h3 id=在基类中中提供功能>在基类中中提供功能</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>Document</span><span class=p>:</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>coutent</span> <span class=o>=</span> <span class=n>content</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>coutent</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Word</span><span class=p>(</span><span class=n>Document</span><span class=p>):</span> <span class=k>pass</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Pdf</span><span class=p>(</span><span class=n>Document</span><span class=p>):</span>  <span class=k>pass</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=n>Word</span><span class=p>(</span><span class=s2>&#34;tom com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>.</span><span class=n>print</span><span class=p>()</span>   <span class=c1>#   tom com</span>
</span></span></code></pre></td></tr></table></div></div><p>基类提供的方法不应该具体实现，因为它未必适合子类的打印，子类中需要覆盖重写。</p><p>print 算是一种能力（打印功能），不是所有的 Document 的子类都需要的，所以，从这个角度出发有点问题</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>Document</span><span class=p>:</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>coutent</span> <span class=o>=</span> <span class=n>content</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>coutent</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Word</span><span class=p>(</span><span class=n>Document</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Word print </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>coutent</span><span class=p>))</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Pdf</span><span class=p>(</span><span class=n>Document</span><span class=p>):</span>  <span class=k>pass</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=n>Word</span><span class=p>(</span><span class=s2>&#34;tom com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>.</span><span class=n>print</span><span class=p>()</span>   <span class=c1>#   Word print tom com</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=在需要子类上添加功能>在需要子类上添加功能</h3><p>如果现有子类上直接增加，违反了 OCP 的原则，所以应该继承后增加</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://atts.w3cschool.cn/attachments/2021051214385093.png data-srcset="https://atts.w3cschool.cn/attachments/2021051214385093.png, https://atts.w3cschool.cn/attachments/2021051214385093.png 1.5x, https://atts.w3cschool.cn/attachments/2021051214385093.png 2x" data-sizes=auto alt=https://atts.w3cschool.cn/attachments/2021051214385093.png title=img></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>Document</span><span class=p>:</span>        <span class=c1># 不允许修改</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>coutent</span> <span class=o>=</span> <span class=n>content</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>coutent</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Word</span><span class=p>(</span><span class=n>Document</span><span class=p>):</span> <span class=k>pass</span>    <span class=c1># 不允许修改</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Pdf</span><span class=p>(</span><span class=n>Document</span><span class=p>):</span>  <span class=k>pass</span>    <span class=c1>#    不允许修改</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PrinttableWord</span><span class=p>(</span><span class=n>Word</span><span class=p>):</span>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;PrinttableWord print </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>coutent</span><span class=p>))</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>PrinttableWord</span><span class=o>.</span><span class=n>mro</span><span class=p>())</span> <span class=c1>#   [&lt;class &#39;__main__.PrinttableWord&#39;&gt;, &lt;class &#39;__main__.Word&#39;&gt;, &lt;class &#39;__main__.Document&#39;&gt;, &lt;class &#39;object&#39;&gt;]</span>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=n>PrinttableWord</span><span class=p>(</span><span class=s2>&#34;tom com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>.</span><span class=n>print</span><span class=p>()</span>   <span class=c1>#   PrinttableWord print tom com</span>
</span></span></code></pre></td></tr></table></div></div><p>看似不错，如果还要提供其他类似能力，如何继承？</p><ul><li>应用于网络，文档应该具备序列化的能力，类上就应该实现序列化可序列化还可能分为使用 pickle、josn、messagepack 等</li></ul><p>这个时候，发现，类又可能太多了，继承的方式不是很好了</p><p>功能太多，A 类需要某几样功能，B 类需要另外几样功能，很繁琐</p><h3 id=装饰器>装饰器</h3><p>用装饰器增强一个类，把功能给类附加上去，哪个类需要，就装饰它</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>printable</span><span class=p>(</span><span class=bp>cls</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_print</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;_print 装饰器 </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>coutent</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>_print</span>
</span></span><span class=line><span class=cl>    <span class=bp>cls</span><span class=o>.</span><span class=n>print</span> <span class=o>=</span> <span class=n>_print</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=bp>cls</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Document</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>coutent</span> <span class=o>=</span> <span class=n>content</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>coutent</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Word</span><span class=p>(</span><span class=n>Document</span><span class=p>):</span> <span class=k>pass</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Pdf</span><span class=p>(</span><span class=n>Document</span><span class=p>):</span>  <span class=k>pass</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nd>@printable</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PrinttableWord</span><span class=p>(</span><span class=n>Word</span><span class=p>):</span> <span class=k>pass</span>    <span class=c1>#先继承，后装饰</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>PrinttableWord</span><span class=o>.</span><span class=vm>__dict__</span><span class=p>)</span>  <span class=c1>#   {&#39;__module__&#39;: &#39;__main__&#39;, &#39;__doc__&#39;: None, &#39;print&#39;: &lt;function printable.&lt;locals&gt;._print at 0x0173C228&gt;}</span>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=n>PrinttableWord</span><span class=p>(</span><span class=s2>&#34;tom&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>.</span><span class=n>print</span><span class=p>()</span>   <span class=c1>#   _print 装饰器 tom</span>
</span></span></code></pre></td></tr></table></div></div><p>优点：简单方便，在需要的地方动态增加</p><h3 id=mixin-用类去继承>Mixin 用类去继承</h3><p>先看代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>PrintableMixin</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;PrintableMixin </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>coutent</span><span class=p>))</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Document</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>coutent</span> <span class=o>=</span> <span class=n>content</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>coutent</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Word</span><span class=p>(</span><span class=n>Document</span><span class=p>):</span> <span class=k>pass</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Pdf</span><span class=p>(</span><span class=n>Document</span><span class=p>):</span>  <span class=k>pass</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PrinttableWord</span><span class=p>(</span><span class=n>PrintableMixin</span><span class=p>,</span><span class=n>Word</span><span class=p>):</span> <span class=k>pass</span>    
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>PrinttableWord</span><span class=o>.</span><span class=n>mro</span><span class=p>())</span>     <span class=c1>#   [&lt;class &#39;__main__.PrinttableWord&#39;&gt;, &lt;class &#39;__main__.PrintableMixin&#39;&gt;, &lt;class &#39;__main__.Word&#39;&gt;, &lt;class &#39;__main__.Document&#39;&gt;, &lt;class &#39;object&#39;&gt;]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>PrinttableWord</span><span class=o>.</span><span class=vm>__dict__</span><span class=p>)</span>  <span class=c1>#   {&#39;__module__&#39;: &#39;__main__&#39;, &#39;__doc__&#39;: None}</span>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=n>PrinttableWord</span><span class=p>(</span><span class=s2>&#34;tom&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>.</span><span class=n>print</span><span class=p>()</span>   <span class=c1>#   PrintableMixin tom</span>
</span></span></code></pre></td></tr></table></div></div><p>Mixin 就是其他类混合进来，同时带来了类的属性和方法</p><p>这里看来 Mixin 类和装饰器效果一样，也什么特别的，但是 Mixin 是类，就可以继承，增强功能</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>PrintableMixin</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;PrintableMixin </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>content</span><span class=p>))</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Document</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>content</span> <span class=o>=</span> <span class=n>content</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Word</span><span class=p>(</span><span class=n>Document</span><span class=p>):</span> <span class=k>pass</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Pdf</span><span class=p>(</span><span class=n>Document</span><span class=p>):</span>  <span class=k>pass</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PrinttableWord</span><span class=p>(</span><span class=n>PrintableMixin</span><span class=p>,</span><span class=n>Word</span><span class=p>):</span> <span class=k>pass</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SuperPrintableMixin</span><span class=p>(</span><span class=n>PrintableMixin</span><span class=p>,</span><span class=n>Word</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;~&#34;</span><span class=o>*</span><span class=mi>30</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>(</span><span class=n>SuperPrintableMixin</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>print</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;~&#34;</span><span class=o>*</span><span class=mi>30</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>SuperPrintableMixin</span><span class=o>.</span><span class=n>mro</span><span class=p>())</span>     <span class=c1>#  [&lt;class &#39;__main__.SuperPrintableMixin&#39;&gt;, &lt;class &#39;__main__.PrintableMixin&#39;&gt;, &lt;class &#39;__main__.Word&#39;&gt;, &lt;class &#39;__main__.Document&#39;&gt;, &lt;class &#39;object&#39;&gt;]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>SuperPrintableMixin</span><span class=o>.</span><span class=vm>__dict__</span><span class=p>)</span>  <span class=c1>#  {&#39;__module__&#39;: &#39;__main__&#39;, &#39;print&#39;: &lt;function SuperPrintableMixin.print at 0x018264B0&gt;, &#39;__doc__&#39;: None}</span>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=n>SuperPrintableMixin</span><span class=p>(</span><span class=s2>&#34;tom&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>.</span><span class=n>print</span><span class=p>()</span>   <span class=c1>#   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
</span></span><span class=line><span class=cl>            <span class=c1>#   PrintableMixin tom</span>
</span></span><span class=line><span class=cl>            <span class=c1>#   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=总结>总结</h3><p>Minxin 本质上就是多继承实现的</p><p><strong>Mixin 体现的是一种组合的设计模式</strong></p><p>在面向对象的设计中，一个负载的类，往往需要很多功能，而这些功能有来自不同的类提供，这就需要很多的类组合在一起</p><p>从设计模式的角度来说，多组合，少继承。</p><ul><li>Mixin 类的使用原则</li><li>Mixin 类中不应该显示的出现 <code>__init__</code> 初始化方法</li><li>Mixin 类通常不能独立工作，因为它是准备混入别的类中的部分功能实现</li><li>Mixin 类的祖先类也应该是 Mixin 类</li><li>使用时，Mixin 类通常在<strong>继承列表第一个位置</strong></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2023-06-14 10:56:53">更新于 2023-06-14</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://trouvaille0198.github.io/Notes/posts/python/%E8%BF%9B%E9%98%B6/ data-title="Python 进阶" data-hashtags=Python><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://trouvaille0198.github.io/Notes/posts/python/%E8%BF%9B%E9%98%B6/ data-hashtag=Python><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://trouvaille0198.github.io/Notes/posts/python/%E8%BF%9B%E9%98%B6/ data-title="Python 进阶"><i class="fa-brands fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href=/Notes/tags/python/>Python</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/Notes/>主页</a></span></section></div><div class=post-nav><a href=/Notes/posts/courses/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/ class=prev rel=prev title=设计模式><i class="fa-solid fa-angle-left fa-fw"></i>设计模式</a>
<a href=/Notes/posts/%E5%88%B7%E9%A2%98/array/%E6%A0%88%E4%B8%8E%E9%98%9F%E5%88%97/239.-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%9C%80%E5%A4%A7%E5%80%BC/ class=next rel=next title="239. 滑动窗口最大值">239. 滑动窗口最大值<i class="fa-solid fa-angle-right fa-fw"></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line custom">酒困路长惟欲睡，日高人渴漫思茶</div><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2022 - 2023</span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><div id=mask></div></div><link rel=stylesheet href=/Notes/lib/katex/katex.min.css><link rel=stylesheet href=/Notes/lib/katex/copy-tex.min.css><link rel=stylesheet href=/Notes/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/Notes/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/Notes/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script type=text/javascript src=/Notes/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/Notes/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/Notes/lib/katex/katex.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/Notes/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:45},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"7I9AMOLA4S",algoliaIndex:"Notes",algoliaSearchKey:"3c1638dfe9f4d49a59d81ff6943416b8",highlightTag:"em",maxResultLength:30,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/Notes/js/theme.min.js defer></script><script type=text/javascript src=/Notes/js/_custom.min.js defer></script></body></html>