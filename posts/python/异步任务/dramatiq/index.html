<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=X-UA-Compatible content="IE=edge, chrome=1"><title>Python dramatiq 库 - 伤心肠粉的酱油碟子</title><meta name=author content>
<meta name=author-link content><meta name=description content="dramatiq 官方文档：https://dramatiq.io/ 一个简单的分布式任务队列库 Dramatiq"><meta name=keywords content="Python"><meta itemprop=name content="Python dramatiq 库"><meta itemprop=description content="dramatiq 官方文档：https://dramatiq.io/ 一个简单的分布式任务队列库 Dramatiq"><meta itemprop=dateModified content="2024-01-14T09:16:02+00:00"><meta itemprop=wordCount content="3294"><meta itemprop=image content="https://trouvaille0198.github.io/logo.png"><meta itemprop=keywords content="Python,"><meta property="og:title" content="Python dramatiq 库"><meta property="og:description" content="dramatiq 官方文档：https://dramatiq.io/ 一个简单的分布式任务队列库 Dramatiq"><meta property="og:type" content="article"><meta property="og:url" content="https://trouvaille0198.github.io/Notes/posts/python/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/dramatiq/"><meta property="og:image" content="https://trouvaille0198.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:modified_time" content="2024-01-14T09:16:02+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://trouvaille0198.github.io/logo.png"><meta name=twitter:title content="Python dramatiq 库"><meta name=twitter:description content="dramatiq 官方文档：https://dramatiq.io/ 一个简单的分布式任务队列库 Dramatiq"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://trouvaille0198.github.io/Notes/posts/python/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/dramatiq/><link rel=prev href=https://trouvaille0198.github.io/Notes/posts/python/%E6%A0%87%E5%87%86%E5%BA%93/inspect/><link rel=next href=https://trouvaille0198.github.io/Notes/posts/python/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/celery/><link rel=stylesheet href=/Notes/lib/normalize/normalize.min.css><link rel=stylesheet href=/Notes/css/style.min.css><link rel=stylesheet href=/Notes/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/Notes/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Python dramatiq 库","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/python\/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1\/dramatiq\/"},"genre":"posts","keywords":"Python","wordcount":3294,"url":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/python\/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1\/dramatiq\/","dateModified":"2024-01-14T09:16:02+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"MelonCholi"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子><span class=header-title-text>伤心肠粉</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/Notes/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/Notes/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/Notes/posts/>文章</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子><span class=header-title-text>伤心肠粉</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/Notes/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/Notes/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/Notes/posts/>文章</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class="toc-content always-active" id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Python dramatiq 库</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle"></i>
MelonCholi</span></span>
<span class=post-category>收录于 <a href=/Notes/categories/python/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;Python</a></span></div><div class=post-meta-line><span title="0001-01-01 00:00:00"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=0001-01-01>0001-01-01</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 3294 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 7 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#安装>安装</a></li><li><a href=#快速入门>快速入门</a><ul><li><a href=#actors>Actors</a></li><li><a href=#workers>Workers</a></li><li><a href=#error-handling-错误处理>Error Handling 错误处理</a></li><li><a href=#code-reloading>Code Reloading</a></li><li><a href=#message-retries>Message Retries</a></li><li><a href=#message-age-limits>Message Age Limits</a><ul><li><a href=#dead-letters>Dead Letters</a></li></ul></li><li><a href=#message-time-limits>Message Time Limits</a><ul><li><a href=#handling-time-limits>Handling Time Limits</a></li></ul></li><li><a href=#scheduling-messages>Scheduling Messages</a></li><li><a href=#prioritizing-messages>Prioritizing Messages</a></li><li><a href=#message-brokers>Message Brokers</a><ul><li><a href=#rabbitmq-broker>RabbitMQ Broker</a></li><li><a href=#redis-broker>Redis Broker</a></li></ul></li><li><a href=#unit-testing>Unit Testing</a><ul><li><a href=#dealing-with-exceptions>Dealing with Exceptions</a></li></ul></li></ul></li><li><a href=#best-practices-最佳实践>Best Practices 最佳实践</a><ul><li><a href=#concurrent-actors>Concurrent Actors</a></li><li><a href=#retriable-actors>Retriable Actors</a></li><li><a href=#simple-messages>Simple Messages</a></li><li><a href=#error-reporting>Error Reporting</a></li></ul></li><li><a href=#控制-workers>控制 Workers</a><ul><li><ul><li><a href=#int-和-term><code>INT</code> 和 <code>TERM</code></a></li><li><a href=#hup><code>HUP</code></a></li></ul></li></ul></li><li><a href=#using-gevent>Using gevent</a></li><li><a href=#中间件>中间件</a><ul><li><a href=#使用>使用</a></li><li><a href=#diy>DIY</a></li></ul></li><li><a href=#dramatiq_dashboard>dramatiq_dashboard</a></li><li><a href=#其他技巧>其他技巧</a><ul><li><a href=#控制单个-actor-函数的并发量>控制单个 actor 函数的并发量</a></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=dramatiq>dramatiq</h1><blockquote><p>官方文档：https://dramatiq.io/</p></blockquote><p>一个简单的分布式任务队列库</p><p>Dramatiq 主要遵循以下原则:</p><ul><li>高可用性和高性能</li><li>简单并且易于理解的核心</li><li>约定大于配置</li></ul><p>如果你曾经对使用 Celery 感到过心烦意乱，那么 Dramatiq 会成为你的好工具的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>dramatiq</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dramatiq.actor</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>count_words</span><span class=p>(</span><span class=n>url</span><span class=p>):</span>
</span></span><span class=line><span class=cl>     <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=n>count</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>     <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;There are </span><span class=si>{</span><span class=n>count</span><span class=si>}</span><span class=s2> words at </span><span class=si>{</span><span class=n>url</span><span class=si>!r}</span><span class=s2>.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Synchronously count the words on example.com in the current process</span>
</span></span><span class=line><span class=cl><span class=n>count_words</span><span class=p>(</span><span class=s2>&#34;http://example.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># or send the actor a message so that it may perform the count</span>
</span></span><span class=line><span class=cl><span class=c1># later, in a separate process.</span>
</span></span><span class=line><span class=cl><span class=n>count_words</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;http://example.com&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=安装>安装</h2><p>If you want to use it with <a href=https://www.rabbitmq.com/ target=_blank rel="external nofollow noopener noreferrer">RabbitMQ</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ pip install -U <span class=s1>&#39;dramatiq[rabbitmq, watch]&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>Or if you want to use it with <a href=https://redis.io/ target=_blank rel="external nofollow noopener noreferrer">Redis</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ pip install -U <span class=s1>&#39;dramatiq[redis, watch]&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=快速入门>快速入门</h2><h3 id=actors>Actors</h3><p>To turn this into a function that can be processed asynchronously using Dramatiq, all we have to do is decorate it with <a href=https://dramatiq.io/reference.html#dramatiq.actor target=_blank rel="external nofollow noopener noreferrer"><code>actor</code></a>:</p><p>使用 actor 装饰器修饰函数，来达成异步的目的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>dramatiq</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dramatiq.actor</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>a</span> <span class=o>+</span> <span class=n>b</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 send 方法来异步地调用这个被修饰的函数，以开头的 <code>count_words</code> 为例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>count_words</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;http://example.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Message</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>queue_name</span><span class=o>=</span><span class=s1>&#39;default&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>actor_name</span><span class=o>=</span><span class=s1>&#39;count_words&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;http://example.com&#39;</span><span class=p>,),</span> <span class=n>kwargs</span><span class=o>=</span><span class=p>{},</span> <span class=n>options</span><span class=o>=</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>  <span class=n>message_id</span><span class=o>=</span><span class=s1>&#39;8cdcae57-af36-40ba-9616-849a336a4316&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>message_timestamp</span><span class=o>=</span><span class=mi>1498557015410</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Doing so immediately enqueues a message (via our local RabbitMQ server) that can be processed asynchronously but <em>doesn’t actually run the function</em>. In order to run it, we’ll have to boot up a Dramatiq worker.</p><p>这样做会立即向消息中间件 Broker 中插入一条可以被异步处理的消息，但是函数并没有立即被运行，我们需要启动一个 Dramatiq worker 来运行这个函数。</p><blockquote><p>Because all messages have to be sent over the network, any arguments you send to an actor must be <strong>JSON-encodable</strong>.</p></blockquote><h3 id=workers>Workers</h3><p>Dramatiq 自带一个命令行工具，称为 <code>dramatiq</code>。该工具能够启动多个并发的 worker 进程，从队列中获取消息并将其发送到 actor 函数以进行执行。</p><p>使用 <code>dramatiq</code> 命令行工具来生成解决 actors 的 workers</p><p>To spawn workers for our <code>count_words.py</code> example, run the following command in a new terminal window:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>dramatiq count_words
</span></span></code></pre></td></tr></table></div></div><p>This will spin up as many processes as there are CPU cores on your machine with 8 worker threads per process. Run <code>dramatiq -h</code> if you want to see a list of the available command line flags.</p><p>As soon as you run that command you’ll see log output along these lines:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:03:48,188<span class=o>]</span> <span class=o>[</span>PID 13047<span class=o>]</span> <span class=o>[</span>MainThread<span class=o>]</span> <span class=o>[</span>dramatiq.MainProcess<span class=o>]</span> <span class=o>[</span>INFO<span class=o>]</span> Dramatiq <span class=s1>&#39;0.13.1&#39;</span> is booting up.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:03:48,349<span class=o>]</span> <span class=o>[</span>PID 22377<span class=o>]</span> <span class=o>[</span>MainThread<span class=o>]</span> <span class=o>[</span>dramatiq.WorkerProcess<span class=o>(</span>3<span class=o>)]</span> <span class=o>[</span>INFO<span class=o>]</span> Worker process is ready <span class=k>for</span> action.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:03:48,350<span class=o>]</span> <span class=o>[</span>PID 22375<span class=o>]</span> <span class=o>[</span>MainThread<span class=o>]</span> <span class=o>[</span>dramatiq.WorkerProcess<span class=o>(</span>1<span class=o>)]</span> <span class=o>[</span>INFO<span class=o>]</span> Worker process is ready <span class=k>for</span> action.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:03:48,357<span class=o>]</span> <span class=o>[</span>PID 22376<span class=o>]</span> <span class=o>[</span>MainThread<span class=o>]</span> <span class=o>[</span>dramatiq.WorkerProcess<span class=o>(</span>2<span class=o>)]</span> <span class=o>[</span>INFO<span class=o>]</span> Worker process is ready <span class=k>for</span> action.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:03:48,357<span class=o>]</span> <span class=o>[</span>PID 22374<span class=o>]</span> <span class=o>[</span>MainThread<span class=o>]</span> <span class=o>[</span>dramatiq.WorkerProcess<span class=o>(</span>0<span class=o>)]</span> <span class=o>[</span>INFO<span class=o>]</span> Worker process is ready <span class=k>for</span> action.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:03:48,358<span class=o>]</span> <span class=o>[</span>PID 22379<span class=o>]</span> <span class=o>[</span>MainThread<span class=o>]</span> <span class=o>[</span>dramatiq.WorkerProcess<span class=o>(</span>5<span class=o>)]</span> <span class=o>[</span>INFO<span class=o>]</span> Worker process is ready <span class=k>for</span> action.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:03:48,362<span class=o>]</span> <span class=o>[</span>PID 22381<span class=o>]</span> <span class=o>[</span>MainThread<span class=o>]</span> <span class=o>[</span>dramatiq.WorkerProcess<span class=o>(</span>7<span class=o>)]</span> <span class=o>[</span>INFO<span class=o>]</span> Worker process is ready <span class=k>for</span> action.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:03:48,364<span class=o>]</span> <span class=o>[</span>PID 22380<span class=o>]</span> <span class=o>[</span>MainThread<span class=o>]</span> <span class=o>[</span>dramatiq.WorkerProcess<span class=o>(</span>6<span class=o>)]</span> <span class=o>[</span>INFO<span class=o>]</span> Worker process is ready <span class=k>for</span> action.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:03:48,366<span class=o>]</span> <span class=o>[</span>PID 22378<span class=o>]</span> <span class=o>[</span>MainThread<span class=o>]</span> <span class=o>[</span>dramatiq.WorkerProcess<span class=o>(</span>4<span class=o>)]</span> <span class=o>[</span>INFO<span class=o>]</span> Worker process is ready <span class=k>for</span> action.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:03:48,369<span class=o>]</span> <span class=o>[</span>PID 22377<span class=o>]</span> <span class=o>[</span>Thread-4<span class=o>]</span> <span class=o>[</span>count_words.count_words<span class=o>]</span> <span class=o>[</span>INFO<span class=o>]</span> Received <span class=nv>args</span><span class=o>=(</span><span class=s1>&#39;http://example.com&#39;</span>,<span class=o>)</span> <span class=nv>kwargs</span><span class=o>={}</span>.
</span></span><span class=line><span class=cl>There are <span class=m>338</span> words at <span class=s1>&#39;http://example.com&#39;</span>.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:03:48,679<span class=o>]</span> <span class=o>[</span>PID 22377<span class=o>]</span> <span class=o>[</span>Thread-4<span class=o>]</span> <span class=o>[</span>count_words.count_words<span class=o>]</span> <span class=o>[</span>INFO<span class=o>]</span> Completed after 310.42ms.
</span></span></code></pre></td></tr></table></div></div><p>If you open your Python interpreter back up and send the actor some more URLs to process:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>urls</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=s2>&#34;https://news.ycombinator.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=s2>&#34;https://xkcd.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=s2>&#34;https://rabbitmq.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=p>[</span><span class=n>count_words</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>url</span><span class=p>)</span> <span class=k>for</span> <span class=n>url</span> <span class=ow>in</span> <span class=n>urls</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>Message</span><span class=p>(</span><span class=n>queue_name</span><span class=o>=</span><span class=s1>&#39;default&#39;</span><span class=p>,</span> <span class=n>actor_name</span><span class=o>=</span><span class=s1>&#39;count_words&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;https://news.ycombinator.com&#39;</span><span class=p>,),</span> <span class=n>kwargs</span><span class=o>=</span><span class=p>{},</span> <span class=n>options</span><span class=o>=</span><span class=p>{},</span> <span class=n>message_id</span><span class=o>=</span><span class=s1>&#39;a99a5b2d-d2da-407b-be55-f2925266e216&#39;</span><span class=p>,</span> <span class=n>message_timestamp</span><span class=o>=</span><span class=mi>1498557998218</span><span class=p>),</span>
</span></span><span class=line><span class=cl> <span class=n>Message</span><span class=p>(</span><span class=n>queue_name</span><span class=o>=</span><span class=s1>&#39;default&#39;</span><span class=p>,</span> <span class=n>actor_name</span><span class=o>=</span><span class=s1>&#39;count_words&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;https://xkcd.com&#39;</span><span class=p>,),</span> <span class=n>kwargs</span><span class=o>=</span><span class=p>{},</span> <span class=n>options</span><span class=o>=</span><span class=p>{},</span> <span class=n>message_id</span><span class=o>=</span><span class=s1>&#39;0ec93dcb-2f9f-414f-99ec-7035e3b1ac5a&#39;</span><span class=p>,</span> <span class=n>message_timestamp</span><span class=o>=</span><span class=mi>1498557998218</span><span class=p>),</span>
</span></span><span class=line><span class=cl> <span class=n>Message</span><span class=p>(</span><span class=n>queue_name</span><span class=o>=</span><span class=s1>&#39;default&#39;</span><span class=p>,</span> <span class=n>actor_name</span><span class=o>=</span><span class=s1>&#39;count_words&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;https://rabbitmq.com&#39;</span><span class=p>,),</span> <span class=n>kwargs</span><span class=o>=</span><span class=p>{},</span> <span class=n>options</span><span class=o>=</span><span class=p>{},</span> <span class=n>message_id</span><span class=o>=</span><span class=s1>&#39;d3dd9799-1ea5-4b00-a70b-2cd6f6f634ed&#39;</span><span class=p>,</span> <span class=n>message_timestamp</span><span class=o>=</span><span class=mi>1498557998218</span><span class=p>)]</span>
</span></span></code></pre></td></tr></table></div></div><p>and then switch back to the worker terminal, you’ll see nine new lines:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:10:02,620<span class=o>]</span> <span class=o>[</span>PID 24357<span class=o>]</span> <span class=o>[</span>Thread-4<span class=o>]</span> <span class=o>[</span>count_words.count_words<span class=o>]</span> <span class=o>[</span>INFO<span class=o>]</span> Received <span class=nv>args</span><span class=o>=(</span><span class=s1>&#39;https://rabbitmq.com&#39;</span>,<span class=o>)</span> <span class=nv>kwargs</span><span class=o>={}</span>.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:10:02,621<span class=o>]</span> <span class=o>[</span>PID 24357<span class=o>]</span> <span class=o>[</span>Thread-6<span class=o>]</span> <span class=o>[</span>count_words.count_words<span class=o>]</span> <span class=o>[</span>INFO<span class=o>]</span> Received <span class=nv>args</span><span class=o>=(</span><span class=s1>&#39;https://xkcd.com&#39;</span>,<span class=o>)</span> <span class=nv>kwargs</span><span class=o>={}</span>.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:10:02,621<span class=o>]</span> <span class=o>[</span>PID 24357<span class=o>]</span> <span class=o>[</span>Thread-5<span class=o>]</span> <span class=o>[</span>count_words.count_words<span class=o>]</span> <span class=o>[</span>INFO<span class=o>]</span> Received <span class=nv>args</span><span class=o>=(</span><span class=s1>&#39;https://news.ycombinator.com&#39;</span>,<span class=o>)</span> <span class=nv>kwargs</span><span class=o>={}</span>.
</span></span><span class=line><span class=cl>There are <span class=m>888</span> words at <span class=s1>&#39;https://rabbitmq.com&#39;</span>.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:10:02,757<span class=o>]</span> <span class=o>[</span>PID 24357<span class=o>]</span> <span class=o>[</span>Thread-4<span class=o>]</span> <span class=o>[</span>count_words.count_words<span class=o>]</span> <span class=o>[</span>INFO<span class=o>]</span> Completed after 137.26ms.
</span></span><span class=line><span class=cl>There are <span class=m>461</span> words at <span class=s1>&#39;https://xkcd.com&#39;</span>.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:10:02,841<span class=o>]</span> <span class=o>[</span>PID 24357<span class=o>]</span> <span class=o>[</span>Thread-6<span class=o>]</span> <span class=o>[</span>count_words.count_words<span class=o>]</span> <span class=o>[</span>INFO<span class=o>]</span> Completed after 219.76ms.
</span></span><span class=line><span class=cl>There are <span class=m>3598</span> words at <span class=s1>&#39;https://news.ycombinator.com&#39;</span>.
</span></span><span class=line><span class=cl><span class=o>[</span>2017-11-19 13:10:03,297<span class=o>]</span> <span class=o>[</span>PID 24357<span class=o>]</span> <span class=o>[</span>Thread-5<span class=o>]</span> <span class=o>[</span>count_words.count_words<span class=o>]</span> <span class=o>[</span>INFO<span class=o>]</span> Completed after 675.19ms.
</span></span></code></pre></td></tr></table></div></div><p>At this point, you’re probably wondering what happens if you send the actor an invalid URL. Let’s try it:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>count_words</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;foo&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=error-handling-错误处理>Error Handling 错误处理</h3><p>使用指数退避算法来重试出错的 actors：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>2017-06-27 13:11:22,059<span class=o>]</span> <span class=o>[</span>PID 13053<span class=o>]</span> <span class=o>[</span>Thread-8<span class=o>]</span> <span class=o>[</span>dramatiq.worker.WorkerThread<span class=o>]</span> <span class=o>[</span>WARNING<span class=o>]</span> Failed to process message count_words<span class=o>(</span><span class=s1>&#39;foo&#39;</span><span class=o>)</span> with unhandled exception.
</span></span><span class=line><span class=cl>Traceback <span class=o>(</span>most recent call last<span class=o>)</span>:
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>requests.exceptions.MissingSchema: Invalid URL <span class=s1>&#39;foo&#39;</span>: No schema supplied. Perhaps you meant http://foo?
</span></span><span class=line><span class=cl><span class=o>[</span>2017-06-27 13:11:22,062<span class=o>]</span> <span class=o>[</span>PID 13053<span class=o>]</span> <span class=o>[</span>Thread-8<span class=o>]</span> <span class=o>[</span>dramatiq.middleware.retries.Retries<span class=o>]</span> <span class=o>[</span>INFO<span class=o>]</span> Retrying message <span class=s1>&#39;a53a5a7d-74e1-48ae-a5a8-0b72af2a8708&#39;</span> in <span class=m>8104</span> milliseconds.
</span></span></code></pre></td></tr></table></div></div><p>Dramatiq will keep retrying the message with longer and longer delays in between runs until we fix our code or for up to about 30 days from when it was first enqueued.</p><p>Change <code>count_words</code> to catch the missing schema error:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=nd>@dramatiq.actor</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>count_words</span><span class=p>(</span><span class=n>url</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>count</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;There are </span><span class=si>{</span><span class=n>count</span><span class=si>}</span><span class=s2> words at </span><span class=si>{</span><span class=n>url</span><span class=si>!r}</span><span class=s2>.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>MissingSchema</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Message dropped due to invalid url: </span><span class=si>{</span><span class=n>url</span><span class=si>!r}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Then send <code>SIGHUP</code> to the main worker process to make the workers pick up the source code changes:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ <span class=nb>kill</span> -s HUP &lt;dramatiq-worker-pid&gt;
</span></span></code></pre></td></tr></table></div></div><p>Substitute the process ID of your own main process for <code>&lt;dramatiq-worker-pid></code>. You can find the PID by looking at the log lines from the worker starting up. Look for lines containing the string <code>[dramatiq.MainProcess]</code>.</p><p>The next time your message is retried you should see:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Message dropped due to invalid url: <span class=s1>&#39;foo&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=code-reloading>Code Reloading</h3><p>Sending <code>SIGHUP</code> to the workers every time you make a change is going to get old quick. Instead, you can run the command line utility with the <code>--watch</code> flag pointing to the folder it should watch for source code changes. It’ll reload the workers whenever Python files under that folder or any of its sub-folders change:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ dramatiq count_words --watch .
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Warning: Although this is a handy feature to use when developing your code, you should avoid using it in production!</p></blockquote><h3 id=message-retries>Message Retries</h3><p>除了默认的指数退避算法，你还可以向装饰器传入参数 <code>max_retries</code> 来指定最大重试次数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=nd>@dramatiq.actor</span><span class=p>(</span><span class=n>max_retries</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>count_words</span><span class=p>(</span><span class=n>url</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><p>If you want to retry certain exceptions and not others, you can pass a predicate function via the <code>retry_when</code> parameter:</p><p>如果你想要对不同 exceptions 结果进行不同的重试处理，使用 <code>retry_when</code> 参数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>should_retry</span><span class=p>(</span><span class=n>retries_so_far</span><span class=p>,</span> <span class=n>exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>retries_so_far</span> <span class=o>&lt;</span> <span class=mi>3</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>exception</span><span class=p>,</span> <span class=n>HttpTimeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dramatiq.actor</span><span class=p>(</span><span class=n>retry_when</span><span class=o>=</span><span class=n>should_retry</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>count_words</span><span class=p>(</span><span class=n>url</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><p>The following retry options are configurable on a per-actor basis:</p><table><thead><tr><th style=text-align:left>Option</th><th style=text-align:left>Default</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>max_retries</code></td><td style=text-align:left><code>20</code></td><td style=text-align:left>最大重试次数. <code>None</code> means the message should be retried indefinitely.</td></tr><tr><td style=text-align:left><code>min_backoff</code></td><td style=text-align:left>15 seconds</td><td style=text-align:left>指数退避中，两次重试间隔的最小时间，单位为 milliseconds 毫秒 Must be greater than 100 milliseconds.</td></tr><tr><td style=text-align:left><code>max_backoff</code></td><td style=text-align:left>7 days</td><td style=text-align:left>指数退避中，两次重试间隔的最大时间，单位为 milliseconds 毫秒 Higher values are less reliable.</td></tr><tr><td style=text-align:left><code>retry_when</code></td><td style=text-align:left><code>None</code></td><td style=text-align:left>一个函数，决定 actor 是否被重试. When this is set, <code>max_retries</code> is ignored.</td></tr><tr><td style=text-align:left><code>throws</code></td><td style=text-align:left><code>None</code></td><td style=text-align:left>An exception or a tuple of exceptions that must not get retried if they are raised from within the actor.</td></tr></tbody></table><h3 id=message-age-limits>Message Age Limits</h3><p>Instead of limiting the number of times messages can be retried, you might want to expire old messages. You can specify the <code>max_age</code> of messages (given in milliseconds) on a per-actor basis:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=nd>@dramatiq.actor</span><span class=p>(</span><span class=n>max_age</span><span class=o>=</span><span class=mi>3600000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>count_words</span><span class=p>(</span><span class=n>url</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=dead-letters>Dead Letters</h4><p>Once a message has exceeded its retry or age limits, it gets moved to the dead letter queue where it’s kept for up to 7 days and then automatically dropped from the message broker. From here, you can manually inspect the message and decide whether or not it should be put back on the queue.</p><h3 id=message-time-limits>Message Time Limits</h3><p>In <code>count_words</code>, we didn’t set an explicit timeout for the outbound request which means that it can take a very long time to complete if the server we’re requesting is timing out. Dramatiq has a default actor time limit of 10 minutes, which means that any actor running for longer than 10 minutes is killed with a <a href=https://dramatiq.io/reference.html#dramatiq.middleware.TimeLimitExceeded target=_blank rel="external nofollow noopener noreferrer"><code>TimeLimitExceeded</code></a> error.</p><p>actor 运行的最长时间默认为 10 分钟</p><p>You can control these time limits at the individual actor level by specifying the <code>time_limit</code> (in milliseconds) of each one:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=nd>@dramatiq.actor</span><span class=p>(</span><span class=n>time_limit</span><span class=o>=</span><span class=mi>60000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>count_words</span><span class=p>(</span><span class=n>url</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Note: While this will keep our actor from running forever, remember that you should take care to always specify a timeout for the request itself, and this is <strong>not</strong> a good way to handle request timeouts in production code.</p></blockquote><h4 id=handling-time-limits>Handling Time Limits</h4><p>If you want to gracefully handle time limits within an actor, you can wrap its source code in a try block and catch <a href=https://dramatiq.io/reference.html#dramatiq.middleware.TimeLimitExceeded target=_blank rel="external nofollow noopener noreferrer"><code>TimeLimitExceeded</code></a>:</p><p>使用 <code>TimeLimitExceeded</code> 异常来捕获超时情况</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dramatiq.middleware</span> <span class=kn>import</span> <span class=n>TimeLimitExceeded</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dramatiq.actor</span><span class=p>(</span><span class=n>time_limit</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>long_running</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>setup_missiles</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>launch_missiles</span><span class=p>()</span>    <span class=c1># &lt;- this will not run</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>TimeLimitExceeded</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>teardown_missiles</span><span class=p>()</span>  <span class=c1># &lt;- this will run</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=scheduling-messages>Scheduling Messages</h3><p>You can schedule messages to run some time in the future by calling <a href=https://dramatiq.io/reference.html#dramatiq.Actor.send_with_options target=_blank rel="external nofollow noopener noreferrer"><code>send_with_options</code></a> on actors and providing a <code>delay</code> (in <strong>milliseconds</strong>):</p><p>延迟运行函数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>count_words</span><span class=o>.</span><span class=n>send_with_options</span><span class=p>(</span><span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s2>&#34;https://example.com&#34;</span><span class=p>,),</span> <span class=n>delay</span><span class=o>=</span><span class=mi>10000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Message</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>queue_name</span><span class=o>=</span><span class=s1>&#39;default&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>actor_name</span><span class=o>=</span><span class=s1>&#39;count_words&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;https://example.com&#39;</span><span class=p>,),</span> <span class=n>kwargs</span><span class=o>=</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>  <span class=n>options</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;eta&#39;</span><span class=p>:</span> <span class=mi>1498560453548</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=n>message_id</span><span class=o>=</span><span class=s1>&#39;7387dc76-8ebe-426e-aec1-db34c236563c&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>message_timestamp</span><span class=o>=</span><span class=mi>1498560443548</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Keep in mind that <em>your message broker is not a database</em>. Scheduled messages should represent a small subset of all your messages.</p><h3 id=prioritizing-messages>Prioritizing Messages</h3><p>使用 <code>priority</code> 参数来指定 actor 的优先级，数字越低，优先级越高</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=nd>@dramatiq.actor</span><span class=p>(</span><span class=n>priority</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>  <span class=c1># 0 is the default</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_report</span><span class=p>(</span><span class=n>user_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dramatiq.actor</span><span class=p>(</span><span class=n>priority</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sync_order_to_warehouse</span><span class=p>(</span><span class=n>order_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><p>Although all positive integers represent valid priorities, if you’re going to use this feature, I’d recommend setting up constants for the various priorities you plan to use:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>PRIO_LO</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=n>PRIO_MED</span> <span class=o>=</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl><span class=n>PRIO_HI</span> <span class=o>=</span> <span class=mi>0</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=message-brokers>Message Brokers</h3><p>Dramatiq abstracts over the notion of a message broker and currently supports both RabbitMQ and Redis out of the box. By default, it’ll set up a RabbitMQ broker instance pointing at the local host.</p><h4 id=rabbitmq-broker>RabbitMQ Broker</h4><p>To configure the RabbitMQ host, instantiate a <a href=https://dramatiq.io/reference.html#dramatiq.brokers.rabbitmq.RabbitmqBroker target=_blank rel="external nofollow noopener noreferrer"><code>RabbitmqBroker</code></a> and set it as the global broker as early as possible during your program’s execution:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>dramatiq</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dramatiq.brokers.rabbitmq</span> <span class=kn>import</span> <span class=n>RabbitmqBroker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rabbitmq_broker</span> <span class=o>=</span> <span class=n>RabbitmqBroker</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s2>&#34;rabbitmq&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dramatiq</span><span class=o>.</span><span class=n>set_broker</span><span class=p>(</span><span class=n>rabbitmq_broker</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=redis-broker>Redis Broker</h4><p>To use Dramatiq with the Redis broker, create an instance of it and set it as the global broker as early as possible during your program’s execution:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>dramatiq</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dramatiq.brokers.redis</span> <span class=kn>import</span> <span class=n>RedisBroker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>redis_broker</span> <span class=o>=</span> <span class=n>RedisBroker</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s2>&#34;redis&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dramatiq</span><span class=o>.</span><span class=n>set_broker</span><span class=p>(</span><span class=n>redis_broker</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=unit-testing>Unit Testing</h3><p>Dramatiq provides a <a href=https://dramatiq.io/reference.html#dramatiq.brokers.stub.StubBroker target=_blank rel="external nofollow noopener noreferrer"><code>StubBroker</code></a> that can be used in unit tests so you don’t have to have a running RabbitMQ or Redis instance in order to run your tests. My recommendation is to use it in conjunction with <a href=https://docs.pytest.org/en/latest/fixture.html target=_blank rel="external nofollow noopener noreferrer">pytest fixtures</a>:</p><p>broker.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dramatiq.brokers.rabbitmq</span> <span class=kn>import</span> <span class=n>RabbitmqBroker</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dramatiq.brokers.stub</span> <span class=kn>import</span> <span class=n>StubBroker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;UNIT_TESTS&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;1&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>broker</span> <span class=o>=</span> <span class=n>StubBroker</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>broker</span><span class=o>.</span><span class=n>emit_after</span><span class=p>(</span><span class=s2>&#34;process_boot&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>broker</span> <span class=o>=</span> <span class=n>RabbitmqBroker</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>conftest.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>dramatiq</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pytest</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dramatiq</span> <span class=kn>import</span> <span class=n>Worker</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>yourapp</span> <span class=kn>import</span> <span class=n>broker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest.fixture</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>stub_broker</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>broker</span><span class=o>.</span><span class=n>flush_all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>broker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest.fixture</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>stub_worker</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>worker</span> <span class=o>=</span> <span class=n>Worker</span><span class=p>(</span><span class=n>broker</span><span class=p>,</span> <span class=n>worker_timeout</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>worker</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>yield</span> <span class=n>worker</span>
</span></span><span class=line><span class=cl>    <span class=n>worker</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Then you can inject and use those fixtures in your tests:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_count_words</span><span class=p>(</span><span class=n>stub_broker</span><span class=p>,</span> <span class=n>stub_worker</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>count_words</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;http://example.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>stub_broker</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>count_words</span><span class=o>.</span><span class=n>queue_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>stub_worker</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Because all actors are callable, you can of course also unit test them synchronously by calling them as you would normal functions.</p><h4 id=dealing-with-exceptions>Dealing with Exceptions</h4><p>By default, any exceptions raised by an actor are raised in the worker, which runs in a separate thread from the one your tests run in. This means that any exceptions your actor throws will not be visible to your test code!</p><p>You can make the stub broker re-raise exceptions from failed actors in your main thread by passing <code>fail_fast=True</code> to its <code>join</code> method:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_count_words</span><span class=p>(</span><span class=n>stub_broker</span><span class=p>,</span> <span class=n>stub_worker</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>count_words</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;http://example.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>stub_broker</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>count_words</span><span class=o>.</span><span class=n>queue_name</span><span class=p>,</span> <span class=n>fail_fast</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>stub_worker</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>This way, whatever exception caused the actor to fail will be raised eagerly within your test. Note that the exception will only be raised once the actor exceeds its available retries.</p><h2 id=best-practices-最佳实践>Best Practices 最佳实践</h2><h3 id=concurrent-actors>Concurrent Actors</h3><p>Your actor will run concurrently with other actors in the system. You need to be mindful of the impact this has on your database, any third party services you might be calling and the resources available on the systems running your workers. Additionally, you need to be mindful of data races between actors that manipulate the same objects in your database.</p><h3 id=retriable-actors>Retriable Actors</h3><p>Dramatiq actors may receive the same message multiple times in the event of a worker failure (hardware, network or power failure). This means that, for any given message, running your actor multiple times must be safe. This is also known as being “idempotent”.</p><h3 id=simple-messages>Simple Messages</h3><p>Attempting to send an actor any object that can’t be encoded to JSON by the standard <code>json</code> package will fail immediately so you’ll want to limit your actor parameters to the following object types: bool, int, float, bytes, string, list and dict.</p><p>Additionally, since messages are sent over the wire you’ll want to keep them as short as possible. For example, if you’ve got an actor that operates over <code>User</code> objects in your system, send that actor the user’s id rather than the serialized user.</p><h3 id=error-reporting>Error Reporting</h3><p>Invariably, you’re probably going to introduce issues in production every now and then and some of those issues are going to affect your tasks. You should use an error reporting service such as <a href=https://sentry.io/welcome/ target=_blank rel="external nofollow noopener noreferrer">Sentry</a> so you get notified of these errors as soon as they occur.</p><h2 id=控制-workers>控制 Workers</h2><p>Dramatiq 进程接受如下信号：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ <span class=nb>kill</span> -TERM <span class=o>[</span>master-process-pid<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=int-和-term><code>INT</code> 和 <code>TERM</code></h4><p>Sending an <code>INT</code> or <code>TERM</code> signal to the main process triggers graceful shutdown. Consumer threads will stop receiving new work and worker threads will finish processing the work they have in flight before shutting down. Any tasks still in worker memory at this point are re-queued on the broker.</p><p>优雅地关闭 Dramatiq</p><ul><li>消费线程停止接受新的 actors</li><li>worker 线程先执行完当前 actor 再关闭</li><li>一些遗留在 worker memory 的任务填回队列</li></ul><p>If you send a <strong>second</strong> <code>INT</code> or <code>TERM</code> signal then the worker processes will be killed immediately.</p><h4 id=hup><code>HUP</code></h4><p>Sending <code>HUP</code> to the main process triggers a graceful shutdown followed by a reload of the workers. This is useful if you want to reload code without completely restarting the main process.</p><h2 id=using-gevent>Using gevent</h2><p>Dramatiq comes with a CLI utility called <code>dramatiq-gevent</code> that can run workers under <a href=http://www.gevent.org/ target=_blank rel="external nofollow noopener noreferrer">gevent</a>. The following invocation would run 8 worker processes with 250 greenlets per process for a total of 2k lightweight worker threads:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ dramatiq-gevent my_app -p 8 -t 250
</span></span></code></pre></td></tr></table></div></div><p>If your tasks spend most of their time doing network IO and don’t depend on C extensions to execute those network calls then using gevent could provide a significant performance improvement.</p><p>I suggest at least experimenting with it to see if it fits your use case.</p><h2 id=中间件>中间件</h2><p>Dramaiq 提供了一些功能丰富的中间件</p><h3 id=使用>使用</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>redis_broker</span> <span class=o>=</span> <span class=n>RedisBroker</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>=</span><span class=n>redis_client</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>AgeLimit</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>TimeLimit</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>ShutdownNotifications</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>Callbacks</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>Pipelines</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>Retries</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>CurrentMessage</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>Results</span><span class=p>(</span><span class=n>backend</span><span class=o>=</span><span class=n>backend</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=diy>DIY</h3><h2 id=dramatiq_dashboard>dramatiq_dashboard</h2><blockquote><p><a href=https://github.com/Bogdanp/dramatiq_dashboard target=_blank rel="external nofollow noopener noreferrer">https://github.com/Bogdanp/dramatiq_dashboard</a></p></blockquote><p>第三方库，可视化仪表盘</p><h2 id=其他技巧>其他技巧</h2><h3 id=控制单个-actor-函数的并发量>控制单个 actor 函数的并发量</h3><blockquote><p><a href=https://github.com/Bogdanp/dramatiq/issues/32 target=_blank rel="external nofollow noopener noreferrer">https://github.com/Bogdanp/dramatiq/issues/32</a></p></blockquote><p>dramtiq 提供了一个 <em>ConcurrentRateLimiter</em> 类来控制单个 actor 函数的并发量，具体原理就是设定一个互斥量 mutex 来保证同一时刻只有指定数量的 actor 在执行。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>dramatiq</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dramatiq.rate_limits</span> <span class=kn>import</span> <span class=n>ConcurrentRateLimiter</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dramatiq.rate_limits.backends</span> <span class=kn>import</span> <span class=n>RedisBackend</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>backend</span> <span class=o>=</span> <span class=n>RedisBackend</span><span class=p>(</span><span class=n>client</span><span class=o>=...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>DISTRIBUTED_MUTEX</span> <span class=o>=</span> <span class=n>ConcurrentRateLimiter</span><span class=p>(</span><span class=n>backend</span><span class=p>,</span> <span class=s2>&#34;distributed-mutex&#34;</span><span class=p>,</span> <span class=n>limit</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dramatiq.actor</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>one_at_a_time</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>DISTRIBUTED_MUTEX</span><span class=o>.</span><span class=n>acquire</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Done.&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>可以将其封装成中间件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_mutex</span><span class=p>(</span><span class=n>limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ConcurrentRateLimiter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;获取mutex&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>backend</span> <span class=o>=</span> <span class=n>RateLimitRedisBackend</span><span class=p>(</span><span class=n>client</span><span class=o>=</span><span class=n>redis_client</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ConcurrentRateLimiter</span><span class=p>(</span><span class=n>backend</span><span class=p>,</span> <span class=s2>&#34;distributed-mutex&#34;</span><span class=p>,</span> <span class=n>limit</span><span class=o>=</span><span class=n>limit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RetryMutex</span><span class=p>(</span><span class=n>Middleware</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>after_process_message</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>broker</span><span class=p>,</span> <span class=n>message</span><span class=p>,</span> <span class=o>*</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>exception</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>  <span class=c1># type:ignore</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>exception</span><span class=p>,</span> <span class=n>RateLimitExceeded</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 若访问mutex失败，将此任务重新入列</span>
</span></span><span class=line><span class=cl>            <span class=n>broker</span><span class=o>.</span><span class=n>enqueue</span><span class=p>(</span><span class=n>message</span><span class=p>,</span> <span class=n>delay</span><span class=o>=</span><span class=mi>10_000</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl><span class=n>broker</span> <span class=o>=</span> <span class=n>dramatiq</span><span class=o>.</span><span class=n>get_broker</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>broker</span><span class=o>.</span><span class=n>add_middleware</span><span class=p>(</span><span class=n>RetryMutex</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p>使用示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>MUTEX</span> <span class=o>=</span> <span class=n>get_mutex</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dramatiq_app.actor</span><span class=p>(</span><span class=n>max_retries</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>t_func</span><span class=p>(</span><span class=n>i</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>MUTEX</span><span class=o>.</span><span class=n>acquire</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=c1># do sth...</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2024-01-14 09:16:02">更新于 2024-01-14</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://trouvaille0198.github.io/Notes/posts/python/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/dramatiq/ data-title="Python dramatiq 库" data-hashtags=Python><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://trouvaille0198.github.io/Notes/posts/python/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/dramatiq/ data-hashtag=Python><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://trouvaille0198.github.io/Notes/posts/python/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/dramatiq/ data-title="Python dramatiq 库"><i class="fa-brands fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href=/Notes/tags/python/>Python</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/Notes/>主页</a></span></section></div><div class=post-nav><a href=/Notes/posts/python/%E6%A0%87%E5%87%86%E5%BA%93/inspect/ class=prev rel=prev title="Python inspect 库"><i class="fa-solid fa-angle-left fa-fw"></i>Python inspect 库</a>
<a href=/Notes/posts/python/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/celery/ class=next rel=next title="Python celery 库">Python celery 库<i class="fa-solid fa-angle-right fa-fw"></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line custom">酒困路长惟欲睡，日高人渴漫思茶</div><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2022 - 2024</span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><div id=mask></div></div><link rel=stylesheet href=/Notes/lib/katex/katex.min.css><link rel=stylesheet href=/Notes/lib/katex/copy-tex.min.css><link rel=stylesheet href=/Notes/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/Notes/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/Notes/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script type=text/javascript src=/Notes/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/Notes/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/Notes/lib/katex/katex.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/Notes/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:45},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"7I9AMOLA4S",algoliaIndex:"Notes",algoliaSearchKey:"3c1638dfe9f4d49a59d81ff6943416b8",highlightTag:"em",maxResultLength:30,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/Notes/js/theme.min.js defer></script><script type=text/javascript src=/Notes/js/_custom.min.js defer></script></body></html>