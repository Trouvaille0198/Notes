<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>流畅的 Python - 伤心肠粉的酱油碟子</title><meta name=author content><meta name=author-link content><meta name=description content="流畅的 Python 数据模型 （Data Model） 数据模型其实是对 Python 框架的描述，它规范了这门"><meta name=keywords content="Python"><meta itemprop=name content="流畅的 Python"><meta itemprop=description content="流畅的 Python 数据模型 （Data Model） 数据模型其实是对 Python 框架的描述，它规范了这门"><meta itemprop=datePublished content="2022-04-17T00:00:00+00:00"><meta itemprop=dateModified content="2023-06-14T11:23:16+00:00"><meta itemprop=wordCount content="48144"><meta itemprop=image content="https://trouvaille0198.github.io/logo.png"><meta itemprop=keywords content="Python,"><meta property="og:title" content="流畅的 Python"><meta property="og:description" content="流畅的 Python 数据模型 （Data Model） 数据模型其实是对 Python 框架的描述，它规范了这门"><meta property="og:type" content="article"><meta property="og:url" content="https://trouvaille0198.github.io/Notes/posts/python/%E6%B5%81%E7%95%85%E7%9A%84-python/"><meta property="og:image" content="https://trouvaille0198.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-17T00:00:00+00:00"><meta property="article:modified_time" content="2023-06-14T11:23:16+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://trouvaille0198.github.io/logo.png"><meta name=twitter:title content="流畅的 Python"><meta name=twitter:description content="流畅的 Python 数据模型 （Data Model） 数据模型其实是对 Python 框架的描述，它规范了这门"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://trouvaille0198.github.io/Notes/posts/python/%E6%B5%81%E7%95%85%E7%9A%84-python/><link rel=prev href=https://trouvaille0198.github.io/Notes/posts/%E5%88%B7%E9%A2%98/string/1047.-%E5%88%A0%E9%99%A4%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E7%9B%B8%E9%82%BB%E9%87%8D%E5%A4%8D%E9%A1%B9/><link rel=next href=https://trouvaille0198.github.io/Notes/posts/%E5%88%B7%E9%A2%98/array/%E5%8F%8C%E6%8C%87%E9%92%88/75.-%E9%A2%9C%E8%89%B2%E5%88%86%E7%B1%BB/><link rel=stylesheet href=/Notes/lib/normalize/normalize.min.css><link rel=stylesheet href=/Notes/css/style.min.css><link rel=stylesheet href=/Notes/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/Notes/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"流畅的 Python","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/python\/%E6%B5%81%E7%95%85%E7%9A%84-python\/"},"genre":"posts","keywords":"Python","wordcount":48144,"url":"https:\/\/trouvaille0198.github.io\/Notes\/posts\/python\/%E6%B5%81%E7%95%85%E7%9A%84-python\/","datePublished":"2022-04-17T00:00:00+00:00","dateModified":"2023-06-14T11:23:16+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"MelonCholi"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子><span class=header-title-text>伤心肠粉</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/Notes/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/Notes/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/Notes/posts/>文章</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/Notes/ title=伤心肠粉的酱油碟子><span class=header-title-text>伤心肠粉</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/Notes/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/Notes/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/Notes/posts/>文章</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class="toc-content always-active" id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>流畅的 Python</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle"></i>
MelonCholi</span></span>
<span class=post-category>收录于 <a href=/Notes/categories/python/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;Python</a></span></div><div class=post-meta-line><span title="2022-04-17 00:00:00"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-04-17>2022-04-17</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 48144 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 97 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#数据模型>数据模型</a><ul><li><a href=#特殊方法>特殊方法</a><ul><li><a href=#__repr__><strong>repr</strong></a></li><li><a href=#算术运算符>算术运算符</a></li><li><a href=#布尔值>布尔值</a></li></ul></li><li><a href=#特殊方法一览>特殊方法一览</a></li><li><a href=#其他>其他</a></li></ul></li><li><a href=#序列构成的数组>序列构成的数组</a><ul><li><a href=#内置序列类型>内置序列类型</a><ul><li><a href=#按元素类型分>按元素类型分</a></li><li><a href=#按能否被修改分>按能否被修改分</a></li></ul></li><li><a href=#元组>元组</a><ul><li><a href=#元组和记录>元组和记录</a></li><li><a href=#元组拆包>元组拆包</a></li><li><a href=#嵌套元组拆包>嵌套元组拆包</a></li><li><a href=#具名元组>具名元组</a></li></ul></li><li><a href=#切片>切片</a><ul><li><a href=#为什么切片和区间会忽略最后一个元素>为什么切片和区间会忽略最后一个元素</a></li><li><a href=#具有名称标识的切片操作>具有名称标识的切片操作</a></li><li><a href=#多维切片和省略>多维切片和省略</a></li><li><a href=#给切片赋值>给切片赋值</a></li><li><a href=#一个有趣的极限情况>一个有趣的极限情况</a></li></ul></li><li><a href=#序列的增量赋值>序列的增量赋值</a></li><li><a href=#有序序列的元素查找以及插入>有序序列的元素查找以及插入</a></li><li><a href=#当列表不是首选时>当列表不是首选时</a><ul><li><a href=#数组>数组</a></li><li><a href=#内存视图>内存视图</a></li><li><a href=#双向队列>双向队列</a></li></ul></li><li><a href=#其他-1>其他</a></li></ul></li><li><a href=#字典和集合>字典和集合</a><ul><li><a href=#泛映射mapping类型>泛映射（mapping）类型</a></li><li><a href=#可散列的数据类型>可散列的数据类型</a></li><li><a href=#常见的映射方法>常见的映射方法</a></li><li><a href=#映射的弹性键查询>映射的弹性键查询</a><ul><li><a href=#get--setdefault>get() & setdefault()</a></li><li><a href=#defaultdict>defaultdict</a></li><li><a href=#自定义-__missing__>自定义 <code>__missing__</code></a></li></ul></li><li><a href=#字典的变种>字典的变种</a><ul><li><a href=#collectionsdefaultdict>collections.defaultdict</a></li><li><a href=#collectionsordereddict>collections.OrderedDict</a></li><li><a href=#collectionschainmap>collections.ChainMap</a></li><li><a href=#collectionscounter>collections.Counter</a></li><li><a href=#userdict>UserDict</a></li></ul></li><li><a href=#子类化-userdict>子类化 <code>UserDict</code></a></li><li><a href=#不可变的映射类型>不可变的映射类型</a></li><li><a href=#集合>集合</a><ul><li><a href=#集合的字面量>集合的字面量</a></li><li><a href=#集合推导>集合推导</a></li></ul></li><li><a href=#dict-和-set-的背后>dict 和 set 的背后</a><ul><li><a href=#散列值和相等性>散列值和相等性</a><ul><li><a href=#一个例子>一个例子</a></li></ul></li><li><a href=#散列表算法>散列表算法</a></li><li><a href=#一些特点>一些特点</a><ul><li><a href=#字典在内存上的开销巨大>字典在内存上的开销巨大</a></li></ul></li><li><a href=#总结>总结</a></li></ul></li><li><a href=#其他-2>其他</a></li></ul></li><li><a href=#文本和字节序列>文本和字节序列</a><ul><li><a href=#字符问题>字符问题</a></li><li><a href=#字节概要>字节概要</a><ul><li><a href=#字节的字面量表示>字节的字面量表示</a></li><li><a href=#编解码器>编解码器</a></li></ul></li><li><a href=#处理文本文件>处理文本文件</a></li><li><a href=#为了正确比较而规范化-unicode-字符串>为了正确比较而规范化 Unicode 字符串</a><ul><li><a href=#大小写折叠>大小写折叠</a></li><li><a href=#极端规范化去掉变音符号>极端“规范化”：去掉变音符号</a></li></ul></li></ul></li><li><a href=#一等函数>一等函数</a><ul><li><a href=#把函数作为对象>把函数作为对象</a></li><li><a href=#高阶函数>高阶函数</a><ul><li><a href=#mapfilter-和-reduce-的现代替代品><code>map</code>、<code>filter</code> 和 <code>reduce</code> 的现代替代品</a></li></ul></li><li><a href=#匿名函数>匿名函数</a></li><li><a href=#可调用对象>可调用对象</a><ul><li><a href=#__call__><code>__call__</code></a></li><li><a href=#另一种对-__call__-的解释>另一种对 <code>__call__</code> 的解释</a></li></ul></li><li><a href=#函数内省>函数内省</a></li><li><a href=#定位参数与仅限关键字参数>定位参数与仅限关键字参数</a></li><li><a href=#获取关于参数的信息>获取关于参数的信息</a><ul><li><a href=#使用内置方法>使用内置方法</a></li><li><a href=#使用-inspect>使用 inspect</a></li></ul></li><li><a href=#函数注解>函数注解</a></li><li><a href=#支持函数式编程的包>支持函数式编程的包</a><ul><li><a href=#operator-模块>operator 模块</a><ul><li><a href=#itemgetter>itemgetter</a></li><li><a href=#attrgetter>attrgetter</a></li><li><a href=#methodcaller>methodcaller</a></li><li><a href=#其他-3>其他</a></li></ul></li><li><a href=#使用-functoolspartial-冻结参数>使用 functools.partial 冻结参数</a></li></ul></li></ul></li><li><a href=#使用一等函数实现设计模式>使用一等函数实现设计模式</a><ul><li><a href=#案例分析重构策略模式>案例分析：重构“策略”模式</a><ul><li><a href=#经典的策略模式>经典的“策略”模式</a></li><li><a href=#使用函数实现策略模式>使用函数实现“策略”模式</a></li><li><a href=#选择最佳策略简单的方式>选择最佳策略：简单的方式</a></li><li><a href=#找出模块中的全部策略>找出模块中的全部策略</a></li></ul></li><li><a href=#命令模式>命令模式</a></li></ul></li><li><a href=#函数装饰器和闭包>函数装饰器和闭包</a><ul><li><a href=#装饰器基础知识>装饰器基础知识</a></li><li><a href=#python-何时执行装饰器>Python 何时执行装饰器</a></li><li><a href=#使用装饰器改进策略模式>使用装饰器改进“策略”模式</a></li><li><a href=#变量作用域规则>变量作用域规则</a></li><li><a href=#闭包>闭包</a></li><li><a href=#nonlocal-声明>nonlocal 声明</a></li><li><a href=#实现一个简单的装饰器>实现一个简单的装饰器</a><ul><li><a href=#原理>原理</a></li><li><a href=#改进>改进</a></li></ul></li><li><a href=#标准库中的装饰器>标准库中的装饰器</a><ul><li><a href=#使用-functoolslru_cache-做备忘>使用 <code>functools.lru_cache</code> 做备忘</a></li><li><a href=#单分派泛函数-functoolssingledispatch>单分派泛函数 <code>functools.singledispatch</code></a></li></ul></li><li><a href=#叠放装饰器>叠放装饰器</a></li><li><a href=#参数化装饰器>参数化装饰器</a><ul><li><a href=#一个参数化的注册装饰器>一个参数化的注册装饰器</a></li><li><a href=#参数化-clock-装饰器>参数化 <code>clock</code> 装饰器</a></li></ul></li></ul></li><li><a href=#对象引用可变性和垃圾回收>对象引用、可变性和垃圾回收</a><ul><li><a href=#变量不是盒子>变量不是盒子</a></li><li><a href=#标识相等性和别名>标识、相等性和别名</a><ul><li><a href=#在--和-is-之间选择>在 <code>==</code> 和 <code>is</code> 之间选择</a></li><li><a href=#元组的相对不可变性>元组的相对不可变性</a></li></ul></li><li><a href=#默认做浅复制>默认做浅复制</a><ul><li><a href=#为任意对象做深复制和浅复制>为任意对象做深复制和浅复制</a></li></ul></li><li><a href=#函数的参数作为引用时>函数的参数作为引用时</a><ul><li><a href=#不要使用可变类型作为参数的默认值>不要使用可变类型作为参数的默认值</a></li><li><a href=#防御可变参数>防御可变参数</a></li></ul></li><li><a href=#del-和垃圾回收><code>del</code> 和垃圾回收</a></li><li><a href=#弱引用>弱引用</a><ul><li><a href=#weakvaluedictionary-简介><code>WeakValueDictionary</code> 简介</a></li><li><a href=#弱引用的局限>弱引用的局限</a></li></ul></li><li><a href=#python-对不可变类型施加的把戏>Python 对不可变类型施加的把戏</a></li><li><a href=#细节>细节</a></li></ul></li><li><a href=#符合-python-风格的对象>符合 Python 风格的对象</a><ul><li><a href=#对象表示形式>对象表示形式</a></li><li><a href=#构建向量类>构建向量类</a></li><li><a href=#备选构造方法>备选构造方法</a></li><li><a href=#classmethod-与-staticmethod>classmethod 与 staticmethod</a></li><li><a href=#格式化显示>格式化显示</a></li><li><a href=#可散列化>可散列化</a></li><li><a href=#python-的私有属性和受保护的属性>Python 的私有属性和“受保护的”属性</a></li><li><a href=#-使用-__slots__-类属性节省空间>⭐ 使用 <strong>slots</strong> 类属性节省空间</a></li><li><a href=#覆盖类属性>覆盖类属性</a></li></ul></li><li><a href=#序列的修改散列和切片>序列的修改、散列和切片</a></li></ul></nav></div></div><div class=content id=content><h1 id=流畅的-python>流畅的 Python</h1><h2 id=数据模型>数据模型</h2><p>（Data Model）</p><p>数据模型其实是对 Python 框架的描述，它规范了这门语言自身构建模块的接口，这些模块包括但不限于序列、迭代器、函数、类和上下文管理器</p><p>通过实现特殊方法，自定义数据类型可以表现得跟内置类型一样，从而让我们写出更具表达力的代码——或者说，更具 Python 风格的代码。</p><h3 id=特殊方法>特殊方法</h3><p>Python 解释器碰到特殊的句法时，会使用<strong>特殊方法</strong>去激活一些基本的对象操作，这些特殊方法的名字以两个下划线开头，以两个下划线结尾（例如 <code>__getitem__</code>）。比如 <code>obj[key]</code> 的背后就是 <code>__getitem__</code> 方法，为了能求得 <code>my_collection[key]</code> 的值，解释器实际上会调用 <code>my_collection.__getitem__(key)</code>。</p><blockquote><p><strong>魔术方法</strong>（magic method）是特殊方法的昵称，也叫<strong>双下方法</strong>（dunder method）</p></blockquote><p>通过实现特殊方法来利用 Python 数据模型有两个好处：</p><ul><li>作为你的类的用户，他们不必去记住标准操作的各式名称（“怎么得到元素的总数？是 <code>.size()</code> 还是 <code>.length()</code> 还是别的什么？”）</li><li>可以更加方便地利用 Python 的标准库，比如 <code>random.choice</code> 函数，从而不用重新发明轮子。</li></ul><p>首先明确一点，特殊方法的存在是为了被 Python 解释器调用的，你自己并不需要调用它们。也就是说没有 <code>my_object.__len__()</code> 这种写法，而应该使用 <code>len(my_object)</code>。在执行 <code>len(my_object)</code> 的时候，如果 <code>my_object</code> 是一个自定义类的对象，那么 Python 会自己去调用其中由你实现的 <code>__len__</code> 方法。</p><p>然而如果是 Python 内置的类型，比如列表（<code>list</code>）、字符串（<code>str</code>）、字节序列（<code>bytearray</code>）等，那么 CPython 会抄个近路，<code>__len__</code> 实际上会直接返回 <strong><code>PyVarObject</code> 里的 <code>ob_size</code> 属性</strong>。<code>PyVarObject</code> 是表示内存中长度可变的内置对象的 C 语言结构体。直接读取这个值比调用一个方法要快很多。</p><p><strong>很多时候，特殊方法的调用是隐式的</strong>，比如 <code>for i in x:</code> 这个语句，背后其实用的是 <code>iter(x)</code>，而这个函数的背后则是 <code>x.__iter__()</code> 方法。当然前提是这个方法在 <code>x</code> 中被实现了。</p><h4 id=__repr__><strong>repr</strong></h4><p>Python 有一个内置的函数叫 <code>repr</code>，它能把一个对象用字符串的形式表达出来以便辨认，这就是 “<strong>字符串表示形式</strong>”<code>repr</code> 就是通过 <code>__repr__</code> 这个特殊方法来得到一个对象的字符串表示形式的。如果没有实现 <code>__repr__</code>，当我们在控制台里打印一个向量的实例时，得到的字符串可能会是 <code>&lt;Vector object at 0x10e100070></code>。</p><p><code>__repr__</code> 和 <code>__str__</code> 的区别在于，后者是在 <code>str()</code> 函数被使用，或是在用 <code>print</code> 函数打印一个对象的时候才被调用的，并且它返回的字符串对终端用户更友好。</p><p>如果你只想实现这两个特殊方法中的一个，<code>__repr__</code> 是更好的选择，因为如果一个对象没有 <code>__str__</code> 函数，而 Python 又需要调用它的时候，解释器会用 <code>__repr__</code> 作为替代。前者方便我们调试和记录日志，后者则是给终端用户看的。</p><h4 id=算术运算符>算术运算符</h4><p><code>__add__</code> 和 <code>__mul__</code> 这两个方法的返回值都是新创建的向量对象，被操作的两个向量（<code>self</code> 或 <code>other</code>）还是原封不动，代码里只是读取了它们的值而已。</p><p><strong>中缀运算符的基本原则就是不改变操作对象，而是产出一个新的值</strong></p><h4 id=布尔值>布尔值</h4><p>尽管 Python 里有 <code>bool</code> 类型，但实际上任何对象都可以用于需要布尔值的上下文中（比如 <code>if</code> 或 <code>while</code> 语句，或者 <code>and</code>、<code>or</code> 和 <code>not</code> 运算符）。为了判定一个值 <code>x</code> 为<strong>真</strong>还是为<strong>假</strong>，Python 会调用 <code>bool(x)</code>，这个函数只能返回 <code>True</code> 或者 <code>False</code>。</p><p><strong>默认情况下，我们自己定义的类的实例总被认为是真的，除非这个类对 <code>__bool__</code> 或者 <code>__len__</code> 函数有自己的实现。</strong><code>bool(x)</code> 的背后是调用 <code>x.__bool__()</code> 的结果；如果不存在 <code>__bool__</code> 方法，那么 <code>bool(x)</code> 会尝试调用 <code>x.__len__()</code>。若返回 0，则 <code>bool</code> 会返回 <code>False</code>；否则返回 <code>True</code>。</p><h3 id=特殊方法一览>特殊方法一览</h3><p>Python 语言参考手册中的“Data Model”（https://docs.python.org/3/reference/datamodel.html）一章列出了 83 个特殊方法的名字，其中 47 个用于实现算术运算、位运算和比较操作。</p><p><strong>跟运算符无关的特殊方法</strong></p><table><thead><tr><th style=text-align:center>类别</th><th style=text-align:center>方法名</th></tr></thead><tbody><tr><td style=text-align:center>字符串 / 字节序列表示形式</td><td style=text-align:center><code>__repr__</code>、<code>__str__</code>、<code>__format__</code>、<code>__bytes__</code></td></tr><tr><td style=text-align:center>数值转换</td><td style=text-align:center><code>__abs__</code>、<code>__bool__</code>、<code>__complex__</code>、<code>__int__</code>、<code>__float__</code>、<code>__hash__</code>、<code>__index__</code></td></tr><tr><td style=text-align:center>集合模拟</td><td style=text-align:center><code>__len__</code>、<code>__getitem__</code>、<code>__setitem__</code>、<code>__delitem__</code>、<code>__contains__</code></td></tr><tr><td style=text-align:center>迭代枚举</td><td style=text-align:center><code>__iter__</code>、<code>__reversed__</code>、<code>__next__</code></td></tr><tr><td style=text-align:center>可调用模拟</td><td style=text-align:center><code>__call__</code></td></tr><tr><td style=text-align:center>上下文管理</td><td style=text-align:center><code>__enter__</code>、<code>__exit__</code></td></tr><tr><td style=text-align:center>实例创建和销毁</td><td style=text-align:center><code>__new__</code>、<code>__init__</code>、<code>__del__</code></td></tr><tr><td style=text-align:center>属性管理</td><td style=text-align:center><code>__getattr__</code>、<code>__getattribute__</code>、<code>__setattr__</code>、<code>__delattr__</code>、<code>__dir__</code></td></tr><tr><td style=text-align:center>属性描述符</td><td style=text-align:center><code>__get__</code>、<code>__set__</code>、<code>__delete__</code></td></tr><tr><td style=text-align:center>跟类相关的服务</td><td style=text-align:center><code>__prepare__</code>、<code>__instancecheck__</code>、<code>__subclasscheck__</code></td></tr></tbody></table><p><strong>跟运算符相关的特殊方法</strong></p><table><thead><tr><th style=text-align:center>类别</th><th style=text-align:center>方法名和对应的运算符</th></tr></thead><tbody><tr><td style=text-align:center>一元运算符</td><td style=text-align:center><code>__neg__ -</code>、<code>__pos__ +</code>、<code>__abs__ abs()</code></td></tr><tr><td style=text-align:center>众多比较运算符</td><td style=text-align:center><code>__lt__ &lt;</code>、<code>__le__ &lt;=</code>、<code>__eq__ ==</code>、<code>__ne__ !=</code>、<code>__gt__ ></code>、<code>__ge__ >=</code></td></tr><tr><td style=text-align:center>算术运算符</td><td style=text-align:center><code>__add__ +</code>、<code>__sub__ -</code>、<code>__mul__ *</code>、<code>__truediv__ /</code>、<code>__floordiv__ //</code>、<code>__mod__ %</code>、<code>__divmod__ divmod()</code>、<code>__pow__ **</code> 或<code>pow()</code>、<code>__round__ round()</code></td></tr><tr><td style=text-align:center>反向算术运算符</td><td style=text-align:center><code>__radd__</code>、<code>__rsub__</code>、<code>__rmul__</code>、<code>__rtruediv__</code>、<code>__rfloordiv__</code>、<code>__rmod__</code>、<code>__rdivmod__</code>、<code>__rpow__</code></td></tr><tr><td style=text-align:center>增量赋值算术运算符</td><td style=text-align:center><code>__iadd__</code>、<code>__isub__</code>、<code>__imul__</code>、<code>__itruediv__</code>、<code>__ifloordiv__</code>、<code>__imod__</code>、<code>__ipow__</code></td></tr><tr><td style=text-align:center>位运算符</td><td style=text-align:center><code>__invert__ ~</code>、<code>__lshift__ &lt;&lt;</code>、<code>__rshift__ >></code>、<code>__and__ &</code>、`<strong>or</strong></td></tr><tr><td style=text-align:center>反向位运算符</td><td style=text-align:center><code>__rlshift__</code>、<code>__rrshift__</code>、<code>__rand__</code>、<code>__rxor__</code>、<code>__ror__</code></td></tr><tr><td style=text-align:center>增量赋值位运算符</td><td style=text-align:center><code>__ilshift__</code>、<code>__irshift__</code>、<code>__iand__</code>、<code>__ixor__</code>、<code>__ior__</code></td></tr></tbody></table><h3 id=其他>其他</h3><ul><li>对序列数据类型的模拟是特殊方法用得最多的地方</li><li>迭代通常是隐式的，譬如说一个集合类型没有实现 <code>__contains__</code> 方法，那么 <code>in</code> 运算符就会按顺序做一次迭代搜索。</li></ul><h2 id=序列构成的数组>序列构成的数组</h2><h3 id=内置序列类型>内置序列类型</h3><h4 id=按元素类型分>按元素类型分</h4><p>Python 标准库用 C 实现了丰富的序列类型，列举如下。</p><ul><li><strong>容器序列</strong>：<code>list</code>、<code>tuple</code> 和 <code>collections.deque</code> 这些序列能存放不同类型的数据。</li><li><strong>扁平序列</strong>：<code>str</code>、<code>bytes</code>、<code>bytearray</code>、<code>memoryview</code> 和 <code>array.array</code>，这类序列只能容纳一种类型。</li></ul><p><strong>容器序列</strong>存放的是它们所包含的任意类型的对象的引用，而<strong>扁平序列</strong>里存放的是值而不是引用。换句话说，扁平序列其实是一段连续的内存空间。由此可见扁平序列其实更加紧凑，但是它里面只能存放诸如字符、字节和数值这种基础类型。</p><h4 id=按能否被修改分>按能否被修改分</h4><p>序列类型还能按照能否被修改来分类。</p><ul><li><strong>可变序列</strong>：<code>list</code>、<code>bytearray</code>、<code>array.array</code>、<code>collections.deque</code> 和 <code>memoryview</code>。</li><li><strong>不可变序列</strong><code>tuple</code>、<code>str</code> 和 <code>bytes</code>。</li></ul><p>下图显示了可变序列（<code>MutableSequence</code>）和不可变序列（<code>Sequence</code>）的差异，同时也能看出前者从后者那里继承了一些方法。这个 UML 类图列举了 collections.abc 中的几个类（超类在左边，箭头从子类指向超类，斜体名称代表抽象类和抽象方法）</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/NeatReader-1658976007715.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/NeatReader-1658976007715.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/NeatReader-1658976007715.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/NeatReader-1658976007715.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/NeatReader-1658976007715.png title=NeatReader-1658976007715></p><h3 id=元组>元组</h3><p>除了用作不可变的列表，它还可以用于没有字段名的记录。鉴于后者常常被忽略，我们先来看看元组作为记录的功用。</p><h4 id=元组和记录>元组和记录</h4><p>元组最大的特征是其不可变性。不可变性实际上暗含多种含义，其一是元组记录的值不会改变，<strong>其二是元组记录的值的顺序不会改变</strong>。第二条相当重要，但是常被忽略。有些时候单纯的数值没有意义，只有结合值与该值在序列中的位置才会有明确的意义（例如经纬度记录，抑或是按照一定顺序采集到的数据）。</p><p>拆包让元组可以完美地被当作记录来使用</p><h4 id=元组拆包>元组拆包</h4><p>拆包可以以多种方式进行：</p><ul><li>平行赋值：对于一个可迭代对象，使用相同数量的变量接收其中的元素</li><li>* 运算符拆包：* 可以将一个可迭代对象拆包并作为传入函数的参数</li><li>* 运算符处理剩余元素：* 除了可以拆包可迭代对象外，还可以用于接收不确定数量的拆包结果（非常神奇的功能，类似于*args。对于同一个赋值表达式的左式最多仅能使用一个 *，并且带有 * 运算符的变量总会自动接受合适数量的拆包结果）</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># * 运算符处理剩余元素</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=o>*</span><span class=n>rest</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>rest</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=o>*</span><span class=n>rest</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>rest</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=o>*</span><span class=n>rest</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>rest</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=p>,</span> <span class=o>*</span><span class=n>body</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>d</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=p>,</span> <span class=n>body</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>d</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=o>*</span><span class=n>head</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>d</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>head</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>d</span>
</span></span><span class=line><span class=cl><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=嵌套元组拆包>嵌套元组拆包</h4><p>接受表达式的元组可以是嵌套式的，例如 <code>(a, b, (c, d))</code>。只要这个接受元组的嵌套结构符合表达式本身的嵌套结构，Python 就可以作出正确的对应。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>metro_areas</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;Tokyo&#39;</span><span class=p>,</span><span class=s1>&#39;JP&#39;</span><span class=p>,</span><span class=mf>36.933</span><span class=p>,(</span><span class=mf>35.689722</span><span class=p>,</span><span class=mf>139.691667</span><span class=p>)),</span>  
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;Delhi NCR&#39;</span><span class=p>,</span> <span class=s1>&#39;IN&#39;</span><span class=p>,</span> <span class=mf>21.935</span><span class=p>,</span> <span class=p>(</span><span class=mf>28.613889</span><span class=p>,</span> <span class=mf>77.208889</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;Mexico City&#39;</span><span class=p>,</span> <span class=s1>&#39;MX&#39;</span><span class=p>,</span> <span class=mf>20.142</span><span class=p>,</span> <span class=p>(</span><span class=mf>19.433333</span><span class=p>,</span> <span class=o>-</span><span class=mf>99.133333</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;New York-Newark&#39;</span><span class=p>,</span> <span class=s1>&#39;US&#39;</span><span class=p>,</span> <span class=mf>20.104</span><span class=p>,</span> <span class=p>(</span><span class=mf>40.808611</span><span class=p>,</span> <span class=o>-</span><span class=mf>74.020386</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;Sao Paulo&#39;</span><span class=p>,</span> <span class=s1>&#39;BR&#39;</span><span class=p>,</span> <span class=mf>19.649</span><span class=p>,</span> <span class=p>(</span><span class=o>-</span><span class=mf>23.547778</span><span class=p>,</span> <span class=o>-</span><span class=mf>46.635833</span><span class=p>)),</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>{:15}</span><span class=s1> | </span><span class=si>{:^9}</span><span class=s1> | </span><span class=si>{:^9}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;lat.&#39;</span><span class=p>,</span> <span class=s1>&#39;long.&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>fmt</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=si>{:15}</span><span class=s1> | </span><span class=si>{:9.4f}</span><span class=s1> | </span><span class=si>{:9.4f}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>cc</span><span class=p>,</span> <span class=n>pop</span><span class=p>,</span> <span class=p>(</span><span class=n>latitude</span><span class=p>,</span> <span class=n>longitude</span><span class=p>)</span> <span class=ow>in</span> <span class=n>metro_areas</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>longitude</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>fmt</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>latitude</span><span class=p>,</span> <span class=n>longitude</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=具名元组>具名元组</h4><p>有些情况下，我们希望元组能带有一个可以解释各位置数据的含义的字段。collections.namedtuple 即可实现这一功能( collections.namedtuple 实际上创建了一个类 )</p><blockquote><p>用 <code>namedtuple</code> 构建的类的实例所消耗的内存跟元组是一样的，因为字段名都被存在对应的类里面。这个实例跟普通的对象实例比起来也要小一些，因为 Python 不会用 <code>__dict__</code> 来存放这些实例的属性。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>namedtuple</span>
</span></span><span class=line><span class=cl><span class=c1># 创建一个具名元组需要两个参数，一个是类名，另一个是类的各个字段的名字。后者可以是由数个字符串组成的可迭代对象，或者是由空格分隔开的字段名组成的字符串。</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>City</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;City&#39;</span><span class=p>,</span> <span class=s1>&#39;name country population coordinates&#39;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=c1># or</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>City</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;City&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=s1>&#39;country&#39;</span><span class=p>,</span> <span class=s1>&#39;population&#39;</span><span class=p>,</span> <span class=s1>&#39;coordinates&#39;</span><span class=p>])</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>tokyo</span> <span class=o>=</span> <span class=n>City</span><span class=p>(</span><span class=s1>&#39;Tokyo&#39;</span><span class=p>,</span> <span class=s1>&#39;JP&#39;</span><span class=p>,</span> <span class=mf>36.933</span><span class=p>,</span> <span class=p>(</span><span class=mf>35.689722</span><span class=p>,</span> <span class=mf>139.691667</span><span class=p>))</span>  <span class=err>➋</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>tokyo</span>
</span></span><span class=line><span class=cl><span class=n>City</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;Tokyo&#39;</span><span class=p>,</span> <span class=n>country</span><span class=o>=</span><span class=s1>&#39;JP&#39;</span><span class=p>,</span> <span class=n>population</span><span class=o>=</span><span class=mf>36.933</span><span class=p>,</span> <span class=n>coordinates</span><span class=o>=</span><span class=p>(</span><span class=mf>35.689722</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mf>139.691667</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>tokyo</span><span class=o>.</span><span class=n>population</span>  <span class=err>➌</span>
</span></span><span class=line><span class=cl><span class=mf>36.933</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>tokyo</span><span class=o>.</span><span class=n>coordinates</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mf>35.689722</span><span class=p>,</span> <span class=mf>139.691667</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>tokyo</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;JP&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 collections.namedtuple 创建的类的实例可以使用对应的字段名或者索引来获取对应的值。此外，还有如下常用功能：</p><ul><li><code>._fields</code>：返回包括所有字段名称的元组</li><li><code>._make()</code>：接受一个可迭代对象以生成一个实例</li><li><code>._asdict()</code>：将具名元组以 <code>collections.OrderedDict</code> 形式返回 —— <code>[(key1, value1), (key2, value2), ...]</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>City</span><span class=o>.</span><span class=n>_fields</span>  <span class=err>➊</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=s1>&#39;country&#39;</span><span class=p>,</span> <span class=s1>&#39;population&#39;</span><span class=p>,</span> <span class=s1>&#39;coordinates&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>LatLong</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;LatLong&#39;</span><span class=p>,</span> <span class=s1>&#39;lat long&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>delhi_data</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39;Delhi NCR&#39;</span><span class=p>,</span> <span class=s1>&#39;IN&#39;</span><span class=p>,</span> <span class=mf>21.935</span><span class=p>,</span> <span class=n>LatLong</span><span class=p>(</span><span class=mf>28.613889</span><span class=p>,</span> <span class=mf>77.208889</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>delhi</span> <span class=o>=</span> <span class=n>City</span><span class=o>.</span><span class=n>_make</span><span class=p>(</span><span class=n>delhi_data</span><span class=p>)</span>  <span class=err>➋</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>delhi</span><span class=o>.</span><span class=n>_asdict</span><span class=p>()</span>  <span class=err>➌</span>
</span></span><span class=line><span class=cl><span class=n>OrderedDict</span><span class=p>([(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=s1>&#39;Delhi NCR&#39;</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;country&#39;</span><span class=p>,</span> <span class=s1>&#39;IN&#39;</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;population&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mf>21.935</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;coordinates&#39;</span><span class=p>,</span> <span class=n>LatLong</span><span class=p>(</span><span class=n>lat</span><span class=o>=</span><span class=mf>28.613889</span><span class=p>,</span> <span class=n>long</span><span class=o>=</span><span class=mf>77.208889</span><span class=p>))])</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>delhi</span><span class=o>.</span><span class=n>_asdict</span><span class=p>()</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>key</span> <span class=o>+</span> <span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>name</span><span class=p>:</span> <span class=n>Delhi</span> <span class=n>NCR</span>
</span></span><span class=line><span class=cl><span class=n>country</span><span class=p>:</span> <span class=n>IN</span>
</span></span><span class=line><span class=cl><span class=n>population</span><span class=p>:</span> <span class=mf>21.935</span>
</span></span><span class=line><span class=cl><span class=n>coordinates</span><span class=p>:</span> <span class=n>LatLong</span><span class=p>(</span><span class=n>lat</span><span class=o>=</span><span class=mf>28.613889</span><span class=p>,</span> <span class=n>long</span><span class=o>=</span><span class=mf>77.208889</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=切片>切片</h3><h4 id=为什么切片和区间会忽略最后一个元素>为什么切片和区间会忽略最后一个元素</h4><ul><li>当只有最后一个位置信息时，我们也可以快速看出切片和区间里有几个元素：<code>range(3)</code> 和 <code>my_list[:3]</code> 都返回 3 个元素。</li><li>当起止位置信息都可见时，我们可以快速计算出切片和区间的长度，用后一个数减去第一个下标（<code>stop - start</code>）即可。</li><li>这样做也让我们可以利用任意一个下标来把序列分割成不重叠的两部分，只要写成 <code>my_list[:x]</code> 和 <code>my_list[x:]</code> 就可以了</li></ul><blockquote><p>这些理由对我不是很有说服力……</p></blockquote><h4 id=具有名称标识的切片操作>具有名称标识的切片操作</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>slice</span><span class=p>(</span><span class=n>startIndex</span><span class=p>,</span> <span class=n>endIndex</span><span class=p>,</span> <span class=n>step</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这个用法很实用，主要是能够对切片操作进行单独的定义。方便对不同的序列使用相同的切片操作进行切片。同样的，slice 对象也会忽略最后一个元素</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 纯文本文件形式的收据以一行字符串的形式被解析</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>invoice</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>... 0.....6................................40........52...55........
</span></span></span><span class=line><span class=cl><span class=s2>... 1909  Pimoroni PiBrella                    $17.50    3    $52.50
</span></span></span><span class=line><span class=cl><span class=s2>... 1489  6mm Tactile Switch x20                $4.95    2     $9.90
</span></span></span><span class=line><span class=cl><span class=s2>... 1510  Panavise Jr. - PV-201                $28.00    1    $28.00
</span></span></span><span class=line><span class=cl><span class=s2>... 1601  PiTFT Mini Kit 320x240               $34.95    1    $34.95
</span></span></span><span class=line><span class=cl><span class=s2>... &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>SKU</span> <span class=o>=</span> <span class=nb>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>DESCRIPTION</span> <span class=o>=</span> <span class=nb>slice</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span> <span class=mi>40</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>UNIT_PRICE</span> <span class=o>=</span> <span class=nb>slice</span><span class=p>(</span><span class=mi>40</span><span class=p>,</span> <span class=mi>52</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>QUANTITY</span> <span class=o>=</span> <span class=nb>slice</span><span class=p>(</span><span class=mi>52</span><span class=p>,</span> <span class=mi>55</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>ITEM_TOTAL</span> <span class=o>=</span> <span class=nb>slice</span><span class=p>(</span><span class=mi>55</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>line_items</span> <span class=o>=</span> <span class=n>invoice</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[</span><span class=mi>2</span><span class=p>:]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>line_items</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=n>item</span><span class=p>[</span><span class=n>UNIT_PRICE</span><span class=p>],</span> <span class=n>item</span><span class=p>[</span><span class=n>DESCRIPTION</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=err>$</span><span class=mf>17.50</span>   <span class=n>Pimoroni</span> <span class=n>PiBrella</span>
</span></span><span class=line><span class=cl>     <span class=err>$</span><span class=mf>4.95</span>   <span class=mi>6</span><span class=n>mm</span> <span class=n>Tactile</span> <span class=n>Switch</span> <span class=n>x20</span>
</span></span><span class=line><span class=cl>    <span class=err>$</span><span class=mf>28.00</span>   <span class=n>Panavise</span> <span class=n>Jr</span><span class=o>.</span> <span class=o>-</span> <span class=n>PV</span><span class=o>-</span><span class=mi>201</span>
</span></span><span class=line><span class=cl>    <span class=err>$</span><span class=mf>34.95</span>   <span class=n>PiTFT</span> <span class=n>Mini</span> <span class=n>Kit</span> <span class=mi>320</span><span class=n>x240</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=多维切片和省略>多维切片和省略</h4><p>多维切片在处理实际数据时经常用到，例如处理图像数据或者更高维的数据。Python 内置的序列类型均是一维的，<strong>因此内置的序列类型仅支持一维的</strong>。</p><p><code>[]</code> 运算符里还可以使用以逗号分开的多个索引或者是切片，外部库 NumPy 里就用到了这个特性，二维的 <code>numpy.ndarray</code> 就可以用 <code>a[i, j]</code> 这种形式来获取，抑或是用 <code>a[m:n, k:l]</code> 的方式来得到二维切片。</p><p>要正确处理这种 <code>[]</code> 运算符的话，对象的特殊方法 <code>__getitem__</code> 和 <code>__setitem__</code> 需要以元组的形式来接收 <code>a[i, j]</code> 中的索引。也就是说，如果要得到 <code>a[i, j]</code> 的值，Python 会调用 <code>a.__getitem__((i, j))</code>。</p><p>总的来说，若想实现多维切片，需要实现 <code>__getitem__</code> 和 <code>__setitem__</code> 。前者用于读取数据，后者用于赋值。</p><p>省略符号（&mldr;）则被用于省略无需额外指定的参数。例如，对于一个四维数组，若仅对第一维和最后一维进行切片，在 Numpy 可以写为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>test_list[i, ..., j]
</span></span><span class=line><span class=cl>test_list[i:j, ..., k:z]
</span></span></code></pre></td></tr></table></div></div><blockquote><p>这些句法上的特性主要是为了支持用户自定义类或者扩展，比如 NumPy 就是个例子。</p></blockquote><h4 id=给切片赋值>给切片赋值</h4><p>若赋值的对象是一个切片，则赋值语句的右侧也必须是一个可迭代对象</p><blockquote><p>但是在 Numpy 等库中，则可以直接用单个数值对切片进行赋值，这一操作主要依赖 Numpy 等库中的 broadcast 机制；基于 broadcast 机制，一些 shape 没有完全对应上的情况在 Numpy 中也可以进行赋值和运算</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>del</span> <span class=n>l</span><span class=p>[</span><span class=mi>5</span><span class=p>:</span><span class=mi>7</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l</span><span class=p>[</span><span class=mi>3</span><span class=p>::</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=mi>11</span><span class=p>,</span> <span class=mi>22</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>22</span><span class=p>,</span> <span class=mi>9</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span> <span class=mi>100</span>  
</span></span><span class=line><span class=cl><span class=c1># 如果赋值的对象是一个切片，那么赋值语句的右侧必须是个可迭代对象。即便只有单独一个值，也要把它转换成可迭代的序列。</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;&lt;stdin&gt;&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>1</span><span class=p>,</span> <span class=ow>in</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=ne>TypeError</span><span class=p>:</span> <span class=n>can</span> <span class=n>only</span> <span class=n>assign</span> <span class=n>an</span> <span class=n>iterable</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=mi>100</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>22</span><span class=p>,</span> <span class=mi>9</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=一个有趣的极限情况>一个有趣的极限情况</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>test_tuple</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>test_tuple</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>+=</span> <span class=p>[</span><span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>上述操作按理来说应当是直接报错，因为元组中的元素不可赋值。但是实际情况是报错的同时，元组包含的列表被修改了。</p><p>对上述代码的字节码进行分析可以发现，顺序执行了下述三个操作</p><ol><li>读取 <code>test_tuple[2]</code> 并将其存入栈顶，记为 <code>TOS</code></li><li>完成操作 <code>TOS += [5, 6]</code></li><li>将结果存入原位置：<code>test_tuple[2] = TOS</code></li></ol><p>其中，第二步是对 list 进行的操作，由于 list 是可变序列因此该操作不会报错；第三步是对 tuple 进行的操作，由于 tuple 是不可变序列，当尝试赋值时会抛出错误。但是 tuple 中存放的是 list 的引用，因此此时 tuple 中的 list 实际上已经被修改。</p><p>上述结果反映：</p><ol><li>将可变对象放置于不可变对象中是十分危险的操作</li><li>上述操作不是原子操作，因此发生了上述既完成了操作又抛出了错误的结果。</li></ol><h3 id=序列的增量赋值>序列的增量赋值</h3><p><code>+=</code> 背后的特殊方法是 <code>__iadd__</code> （用于“就地加法”）。但是如果一个类没有实现这个方法的话，Python 会退一步调用 <code>__add__</code> 。考虑下面这个简单的表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=o>+=</span> <span class=n>b</span>
</span></span></code></pre></td></tr></table></div></div><p>如果 <code>a</code> 实现了 <code>__iadd__</code> 方法，就会调用这个方法。同时对可变序列（例如 <code>list</code>、<code>bytearray</code> 和 <code>array.array</code>）来说，<code>a</code> 会就地改动，就像调用了 <code>a.extend(b)</code> 一样。但是如果 <code>a</code> 没有实现 <code>__iadd__</code> 的话，<code>a += b</code> 这个表达式的效果就变得跟 <code>a = a + b</code> 一样了：首先计算 <code>a + b</code>，得到一个新的对象，然后赋值给 <code>a</code>。也就是说，在这个表达式中，变量名会不会被关联到新的对象，完全取决于这个类型有没有实现 <code>__iadd__</code> 这个方法。</p><p>总体来讲，可变序列一般都实现了 <code>__iadd__</code> 方法，因此 <code>+=</code> 是就地加法。而不可变序列根本就不支持这个操作，对这个方法的实现也就无从谈起。</p><blockquote><p>上面所说的这些关于 <code>+=</code> 的概念也适用于 <code>*=</code>，不同的是，后者相对应的是 <code>__imul__</code>。</p></blockquote><p>接下来有个小例子，展示的是 <code>*=</code> 在可变和不可变序列上的作用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>id</span><span class=p>(</span><span class=n>l</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>4311953800</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l</span> <span class=o>*=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>id</span><span class=p>(</span><span class=n>l</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>4311953800</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>t</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>id</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>4312681568</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>t</span> <span class=o>*=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>id</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>4301348296</span>  
</span></span></code></pre></td></tr></table></div></div><p><strong>对不可变序列进行重复拼接操作的话，效率会很低</strong>，因为每次都有一个新对象，而解释器需要把原来对象中的元素先复制到新的对象里，然后再追加新的元素。</p><blockquote><p><code>str</code> 是一个例外，因为对字符串做 <code>+=</code> 实在是太普遍了，所以 CPython 对它做了优化。为 <code>str</code> 初始化内存的时候，程序会为它留出额外的可扩展空间，因此进行增量操作的时候，并不会涉及复制原有字符串到新位置这类操作</p></blockquote><h3 id=有序序列的元素查找以及插入>有序序列的元素查找以及插入</h3><p><code>bisect</code> 模块提供了对有序序列进行元素查找以及插入的方法。</p><ul><li><code>bisect.bisect</code> 可以用于元素插入位置查找：寻找一个位置，使得插入待插入元素后，有序序列仍是有序的。</li><li><code>bisect.insort</code> 函数则可以将元素插入有序序列中。</li></ul><p><code>bisect()</code> 和 <code>insort()</code> 均有两种形式，分别被命名为 <code>_right</code>，<code>_left</code>。若遇到相等的元素，<code>_right</code> 会将元素插入到序列中相同值的元素的后面，而 <code>_left</code> 则会插入到前面。</p><blockquote><p><code>bisect</code> 函数其实是 <code>bisect_right</code> 函数的别名</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>grade</span><span class=p>(</span><span class=n>score</span><span class=p>,</span> <span class=n>breakpoints</span><span class=o>=</span><span class=p>[</span><span class=mi>60</span><span class=p>,</span> <span class=mi>70</span><span class=p>,</span> <span class=mi>80</span><span class=p>,</span> <span class=mi>90</span><span class=p>],</span> <span class=n>grades</span><span class=o>=</span><span class=s1>&#39;FDCBA&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>i</span> <span class=o>=</span> <span class=n>bisect</span><span class=o>.</span><span class=n>bisect</span><span class=p>(</span><span class=n>breakpoints</span><span class=p>,</span> <span class=n>score</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=n>grades</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=p>[</span><span class=n>grade</span><span class=p>(</span><span class=n>score</span><span class=p>)</span> <span class=k>for</span> <span class=n>score</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>33</span><span class=p>,</span> <span class=mi>99</span><span class=p>,</span> <span class=mi>77</span><span class=p>,</span> <span class=mi>70</span><span class=p>,</span> <span class=mi>89</span><span class=p>,</span> <span class=mi>90</span><span class=p>,</span> <span class=mi>100</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;F&#39;</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>,</span> <span class=s1>&#39;B&#39;</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>bisect</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SIZE</span><span class=o>=</span><span class=mi>7</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>1729</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>my_list</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>SIZE</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>new_item</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randrange</span><span class=p>(</span><span class=n>SIZE</span><span class=o>*</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>bisect</span><span class=o>.</span><span class=n>insort</span><span class=p>(</span><span class=n>my_list</span><span class=p>,</span> <span class=n>new_item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>%2d</span><span class=s1> -&gt;&#39;</span> <span class=o>%</span> <span class=n>new_item</span><span class=p>,</span> <span class=n>my_list</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=m>10</span> -&gt; <span class=o>[</span>10<span class=o>]</span>
</span></span><span class=line><span class=cl> <span class=m>0</span> -&gt; <span class=o>[</span>0, 10<span class=o>]</span>
</span></span><span class=line><span class=cl> <span class=m>6</span> -&gt; <span class=o>[</span>0, 6, 10<span class=o>]</span>
</span></span><span class=line><span class=cl> <span class=m>8</span> -&gt; <span class=o>[</span>0, 6, 8, 10<span class=o>]</span>
</span></span><span class=line><span class=cl> <span class=m>7</span> -&gt; <span class=o>[</span>0, 6, 7, 8, 10<span class=o>]</span>
</span></span><span class=line><span class=cl> <span class=m>2</span> -&gt; <span class=o>[</span>0, 2, 6, 7, 8, 10<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=m>10</span> -&gt; <span class=o>[</span>0, 2, 6, 7, 8, 10, 10<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p><code>insort</code> 跟 <code>bisect</code> 一样，有 <code>lo</code> 和 <code>hi</code> 两个可选参数用来控制查找的范围。它也有个变体叫 <code>insort_left</code>，这个变体在背后用的是 <code>bisect_left</code>。</p><h3 id=当列表不是首选时>当列表不是首选时</h3><p>虽然列表既灵活又简单，但面对各类需求时，我们可能会有更好的选择。</p><p>比如，要存放 1000 万个浮点数的话，数组（<code>array</code>）的效率要高得多，因为数组在背后存的并不是 <code>float</code> 对象，而是数字的机器翻译，也就是字节表述。这一点就跟 C 语言中的数组一样。</p><p>再比如说，如果需要频繁对序列做先进先出的操作，<code>deque</code>（双端队列）的速度应该会更快。</p><p>如果在你的代码里，包含操作（比如检查一个元素是否出现在一个集合中）的频率很高，用 <code>set</code>（集合）会更合适。<code>set</code> 专为检查元素是否存在做过优化。</p><h4 id=数组>数组</h4><p>如果我们需要一个只包含数字的列表，那么 <code>array.array</code> 比 <code>list</code> 更高效。数组支持所有跟可变序列有关的操作，包括 <code>.pop</code>、<code>.insert</code> 和 <code>.extend</code>。另外，数组还提供从文件读取和存入文件的更快的方法，如 <code>.frombytes</code> 和 <code>.tofile</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>array</span> <span class=kn>import</span> <span class=n>array</span>  
</span></span><span class=line><span class=cl><span class=n>test_array</span> <span class=o>=</span> <span class=n>array</span><span class=p>(</span><span class=nb>type</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 一个浮点型数组的创建、存入文件和从文件读取的过程</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>array</span> <span class=kn>import</span> <span class=n>array</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>random</span> <span class=kn>import</span> <span class=n>random</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>floats</span> <span class=o>=</span> <span class=n>array</span><span class=p>(</span><span class=s1>&#39;d&#39;</span><span class=p>,</span> <span class=p>(</span><span class=n>random</span><span class=p>()</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=o>**</span><span class=mi>7</span><span class=p>)))</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>floats</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>  
</span></span><span class=line><span class=cl><span class=mf>0.07802343889111107</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>fp</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;floats.bin&#39;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>floats</span><span class=o>.</span><span class=n>tofile</span><span class=p>(</span><span class=n>fp</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>fp</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>floats2</span> <span class=o>=</span> <span class=n>array</span><span class=p>(</span><span class=s1>&#39;d&#39;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>fp</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;floats.bin&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>floats2</span><span class=o>.</span><span class=n>fromfile</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=mi>10</span><span class=o>**</span><span class=mi>7</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>fp</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>floats2</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>  
</span></span><span class=line><span class=cl><span class=mf>0.07802343889111107</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>floats2</span> <span class=o>==</span> <span class=n>floats</span>  
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><p>一个小试验告诉我，用 <code>array.fromfile</code> 从一个二进制文件里读出 1000 万个双精度浮点数只需要 0.1 秒，这比从文本文件里读取的速度要快 60 倍，因为后者会使用内置的 <code>float</code> 方法把每一行文字转换成浮点数。</p><p>另外，使用 <code>array.tofile</code> 写入到二进制文件，比以每行一个浮点数的方式把所有数字写入到文本文件要快 7 倍。另外，1000 万个这样的数在二进制文件里只占用 80 000 000 个字节（每个浮点数占用 8 个字节，不需要任何额外空间），如果是文本文件的话，我们需要 181 515 739 个字节。</p><h4 id=内存视图>内存视图</h4><p><code>memoryview</code> 是一个内置类，它能让用户<strong>在不复制内容的情况下操作同一个数组的不同切片。</strong></p><p>实际上提供了一种在不需要赋值内容的前提下，实现<strong>不同数据结构之间的内存共享</strong>。即指定一块区域，能够使用不同的方式去存读数据，例如可以以 list 的形式创建一个序列，然后以 Numpy array 的形式去处理这个序列，而不需要额外再创建一个包含相同内容的新 array。</p><h4 id=双向队列>双向队列</h4><blockquote><p>利用 <code>.append</code> 和 <code>.pop</code> 方法，我们可以把列表当作栈或者队列来用（比如，把 <code>.append</code> 和 <code>.pop(0)</code> 合起来用，就能模拟栈的“先进先出”的特点）。</p><p>但是删除列表的第一个元素（抑或是在第一个元素之前添加一个元素）之类的操作是很耗时的，因为这些操作会牵扯到移动列表里的所有元素。</p></blockquote><p><code>collections.deque</code> 类（双向队列）是一个线程安全、可以快速从两端添加或者删除元素的数据类型。</p><p>而且如果想要有一种数据类型来存放“最近用到的几个元素”，<code>deque</code> 也是一个很好的选择。</p><p>这是因为在新建一个双向队列的时候，你可以指定这个队列的大小，如果这个队列满员了，还可以从反向端删除过期的元素，然后在尾端添加新的元素。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dq</span> <span class=o>=</span> <span class=n>deque</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span> <span class=n>maxlen</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>dq</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># ------------------ 旋转元素 ------------------0</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>将后3个数移动到队列头部:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dq</span><span class=o>.</span><span class=n>rotate</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>dq</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>将前4个数移动到队列尾部:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dq</span><span class=o>.</span><span class=n>rotate</span><span class=p>(</span><span class=o>-</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>dq</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>从头部添加元素：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dq</span><span class=o>.</span><span class=n>appendleft</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>dq</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>从尾部添加元素：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dq</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>dq</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>从尾部逐项添加元素：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dq</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>dq</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>从头部逐项添加元素：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dq</span><span class=o>.</span><span class=n>extendleft</span><span class=p>([</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>dq</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>output</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>deque<span class=o>([</span>0, 1, 2, 3, 4, 5, 6, 7, 8, 9<span class=o>]</span>, <span class=nv>maxlen</span><span class=o>=</span>10<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>将后3个数移动到队列头部:
</span></span><span class=line><span class=cl>deque<span class=o>([</span>7, 8, 9, 0, 1, 2, 3, 4, 5, 6<span class=o>]</span>, <span class=nv>maxlen</span><span class=o>=</span>10<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>将前4个数移动到队列尾部:
</span></span><span class=line><span class=cl>deque<span class=o>([</span>1, 2, 3, 4, 5, 6, 7, 8, 9, 0<span class=o>]</span>, <span class=nv>maxlen</span><span class=o>=</span>10<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>从头部添加元素：
</span></span><span class=line><span class=cl>deque<span class=o>([</span>-1, 1, 2, 3, 4, 5, 6, 7, 8, 9<span class=o>]</span>, <span class=nv>maxlen</span><span class=o>=</span>10<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>从尾部添加元素：
</span></span><span class=line><span class=cl>deque<span class=o>([</span>1, 2, 3, 4, 5, 6, 7, 8, 9, -1<span class=o>]</span>, <span class=nv>maxlen</span><span class=o>=</span>10<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>从尾部逐项添加元素：
</span></span><span class=line><span class=cl>deque<span class=o>([</span>5, 6, 7, 8, 9, -1, 10, 20, 30, 40<span class=o>]</span>, <span class=nv>maxlen</span><span class=o>=</span>10<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>从头部逐项添加元素：
</span></span><span class=line><span class=cl>deque<span class=o>([</span>40, 30, 20, 10, 5, 6, 7, 8, 9, -1<span class=o>]</span>, <span class=nv>maxlen</span><span class=o>=</span>10<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>双向队列实现了大部分列表所拥有的方法，也有一些额外的符合自身设计的方法，比如说 <code>popleft</code> 和 <code>rotate</code>。但是为了实现这些方法，双向队列也付出了一些代价，从队列中间删除元素的操作会慢一些，因为它只对在头尾的操作进行了优化。</p><p><code>append</code> 和 <code>popleft</code> 都是原子操作，也就说是 <code>deque</code> 可以在多线程程序中安全地当作先进先出的栈使用，而使用者不需要担心资源锁的问题。</p><h3 id=其他-1>其他</h3><ul><li><p>对 <code>seq[start:stop:step]</code> 进行求值的时候，Python 会调用 <code>seq.__getitem__(slice(start, stop, step))</code></p></li><li><p><code>key</code> 参数能让你对一个混有数字字符和数值的列表进行排序。你只需要决定到底是把字符看作数值，还是把数值看作字符：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l</span> <span class=o>=</span> <span class=p>[</span><span class=mi>28</span><span class=p>,</span> <span class=mi>14</span><span class=p>,</span> <span class=s1>&#39;28&#39;</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=s1>&#39;9&#39;</span><span class=p>,</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=s1>&#39;23&#39;</span><span class=p>,</span> <span class=mi>19</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=s1>&#39;9&#39;</span><span class=p>,</span> <span class=mi>14</span><span class=p>,</span> <span class=mi>19</span><span class=p>,</span> <span class=s1>&#39;23&#39;</span><span class=p>,</span> <span class=mi>28</span><span class=p>,</span> <span class=s1>&#39;28&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=nb>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=mi>14</span><span class=p>,</span> <span class=mi>19</span><span class=p>,</span> <span class=s1>&#39;23&#39;</span><span class=p>,</span> <span class=mi>28</span><span class=p>,</span> <span class=s1>&#39;28&#39;</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=s1>&#39;9&#39;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h2 id=字典和集合>字典和集合</h2><blockquote><p>字典这个数据结构活跃在所有 Python 程序的背后，即便你的源码里并没有直接用到它</p></blockquote><p>跟字典有关的内置函数都在 <code>__builtins__.__dict__</code>模块中。</p><p>正是因为字典至关重要，Python 对它的实现做了高度优化，而散列表则是字典类型性能出众的根本原因。</p><h3 id=泛映射mapping类型>泛映射（mapping）类型</h3><p>字典属于泛映射类型数据结构，不同于序列类型，字典总是由 key-value（键值对）构成。</p><p>collections.abc 中定义了 Mapping 和 MutableMapping 两个抽象基类，这些基类为 dict 等数据结构定义了形式接口。</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220803161316081.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220803161316081.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220803161316081.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220803161316081.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220803161316081.png title=image-20220803161316081></p><blockquote><p>箭头由子类指向超类</p></blockquote><p>这些基类主要是作为形式化的文档并定义里构建一个映射类型需要的最基本接口。使用 isinstance 就可以判断某一个对象是否是广义上的映射类型。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>my_dict</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>my_dict</span><span class=p>,</span> <span class=n>abc</span><span class=o>.</span><span class=n>Mapping</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=可散列的数据类型>可散列的数据类型</h3><p>散列函数的使用能够更快速的访问某一特定关键字对应的数据。</p><p>如果一个对象是可散列的，那么在这个对象的生命周期中，它的散列值是不变的，而且这个对象需要实现 <code>__hash__()</code> 方法和 <code>__qe__()</code> 方法，这样才能跟其他键做比较。</p><p>如果两个可散列对象是相等的，那么它们的散列值一定是一样的。</p><p>原子不可变数据类型（<code>str</code>、<code>bytes</code> 和数值类型）都是可散列类型，<code>frozenset</code> 也是可散列的，因为根据其定义，<code>frozenset</code> 里只能容纳可散列类型。</p><p>元组的话，只有当一个元组包含的所有元素都是可散列类型的情况下，它才是可散列的。来看下面的元组<code>tt</code>、<code>tl</code> 和 <code>tf</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>tt</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=p>(</span><span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>hash</span><span class=p>(</span><span class=n>tt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>8027212646858338501</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>tl</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=p>[</span><span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>hash</span><span class=p>(</span><span class=n>tl</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;&lt;stdin&gt;&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>1</span><span class=p>,</span> <span class=ow>in</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=ne>TypeError</span><span class=p>:</span> <span class=n>unhashable</span> <span class=nb>type</span><span class=p>:</span> <span class=s1>&#39;list&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>tf</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=nb>frozenset</span><span class=p>([</span><span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>hash</span><span class=p>(</span><span class=n>tf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mi>4118419923444501110</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>一般来讲用户自定义的类型的对象都是可散列的，散列值就是它们的 <code>id()</code> 函数的返回值，所以所有这些对象在比较的时候都是不相等的。</p><p>如果一个对象实现了 <code>__eq__</code> 方法，并且在方法中用到了这个对象的内部状态的话，那么只有当所有这些内部状态都是不可变的情况下，这个对象才是可散列的。</p></blockquote><p>根据这些定义，字典提供了<strong>很多种构造方法</strong>，“Built-in Types”</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span><span class=n>one</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>two</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>three</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;one&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;two&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;three&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>c</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span><span class=nb>zip</span><span class=p>([</span><span class=s1>&#39;one&#39;</span><span class=p>,</span> <span class=s1>&#39;two&#39;</span><span class=p>,</span> <span class=s1>&#39;three&#39;</span><span class=p>],</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>([(</span><span class=s1>&#39;two&#39;</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;one&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;three&#39;</span><span class=p>,</span> <span class=mi>3</span><span class=p>)])</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>e</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>({</span><span class=s1>&#39;three&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=s1>&#39;one&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;two&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=o>==</span> <span class=n>b</span> <span class=o>==</span> <span class=n>c</span> <span class=o>==</span> <span class=n>d</span> <span class=o>==</span> <span class=n>e</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=常见的映射方法>常见的映射方法</h3><table><thead><tr><th style=text-align:center></th><th style=text-align:center>dict</th><th style=text-align:center>defaultdict</th><th style=text-align:center>OrderedDict</th><th style=text-align:center></th></tr></thead><tbody><tr><td style=text-align:center><code>d.clear()</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>移除所有元素</td></tr><tr><td style=text-align:center><code>d.__contains__(k)</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>检查 <code>k</code> 是否在 <code>d</code> 中</td></tr><tr><td style=text-align:center><code>d.copy()</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>浅复制</td></tr><tr><td style=text-align:center><code>d.__copy__()</code></td><td style=text-align:center></td><td style=text-align:center>•</td><td style=text-align:center></td><td style=text-align:center>用于支持 <code>copy.copy</code></td></tr><tr><td style=text-align:center><code>d.default_factory</code></td><td style=text-align:center></td><td style=text-align:center>•</td><td style=text-align:center></td><td style=text-align:center>在 <code>__missing__</code> 函数中被调用的函数，用以给未找到的元素设置值*</td></tr><tr><td style=text-align:center><code>d.__delitem__(k)</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center><code>del d[k]</code>，移除键为 <code>k</code> 的元素</td></tr><tr><td style=text-align:center><code>d.fromkeys(it, [initial])</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>将迭代器 <code>it</code> 里的元素设置为映射里的键，如果有 <code>initial</code> 参数，就把它作为这些键对应的值（默认是 <code>None</code>）</td></tr><tr><td style=text-align:center><code>d.get(k, [default])</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>返回键 <code>k</code> 对应的值，如果字典里没有键 <code>k</code>，则返回 <code>None</code> 或者 <code>default</code></td></tr><tr><td style=text-align:center><code>d.__getitem__(k)</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>让字典 <code>d</code> 能用 <code>d[k]</code> 的形式返回键 <code>k</code> 对应的值</td></tr><tr><td style=text-align:center><code>d.items()</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>返回 <code>d</code> 里所有的键值对</td></tr><tr><td style=text-align:center><code>d.__iter__()</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>获取键的迭代器</td></tr><tr><td style=text-align:center><code>d.keys()</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>获取所有的键</td></tr><tr><td style=text-align:center><code>d.__len__()</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>可以用 <code>len(d)</code> 的形式得到字典里键值对的数量</td></tr><tr><td style=text-align:center><code>d.__missing__(k)</code></td><td style=text-align:center></td><td style=text-align:center>•</td><td style=text-align:center></td><td style=text-align:center>当 <code>__getitem__</code> 找不到对应键的时候，这个方法会被调用</td></tr><tr><td style=text-align:center><code>d.move_to_end(k, [last])</code></td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center>•</td><td style=text-align:center>把键为 <code>k</code> 的元素移动到最靠前或者最靠后的位置（<code>last</code> 的默认值是 <code>True</code>）</td></tr><tr><td style=text-align:center><code>d.pop(k, [defaul]</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>返回键 <code>k</code> 所对应的值，然后移除这个键值对。如果没有这个键，返回 <code>None</code> 或者 <code>defaul</code></td></tr><tr><td style=text-align:center><code>d.popitem()</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>随机返回一个键值对并从字典里移除它#</td></tr><tr><td style=text-align:center><code>d.__reversed__()</code></td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center>•</td><td style=text-align:center>返回倒序的键的迭代器</td></tr><tr><td style=text-align:center><code>d.setdefault(k, [default])</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>若字典里有键k，则把它对应的值设置为 <code>default</code>，然后返回这个值；若无，则让 <code>d[k] = default</code>，然后返回 <code>default</code></td></tr><tr><td style=text-align:center><code>d.__setitem__(k, v)</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>实现 <code>d[k] = v</code> 操作，把 <code>k</code> 对应的值设为v</td></tr><tr><td style=text-align:center><code>d.update(m, [**kargs])</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center><code>m</code> 可以是映射或者键值对迭代器，用来更新 <code>d</code> 里对应的条目</td></tr><tr><td style=text-align:center><code>d.values()</code></td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>•</td><td style=text-align:center>返回字典里的所有值</td></tr></tbody></table><h3 id=映射的弹性键查询>映射的弹性键查询</h3><h4 id=get--setdefault>get() & setdefault()</h4><p><code>get()</code> 能够规避对 dict 中某一个 key 赋值时，由于 key 不存在于 dict 中导致的 keyError。但是利用 <code>get()</code> 方法处理这种情况需要经过多次键查询操作（<code>get()</code> 是一次，然后赋值又是一次，并且还需要创建临时变量用于存放取得的值以及对值的操作）</p><p><code>setdefault()</code> 则可以一步完成上述工作</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>my_dict</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=n>my_dict</span><span class=o>.</span><span class=n>setdefault</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=p>[])</span> <span class=c1># 更高效</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>my_dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>my_dict</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span></code></pre></td></tr></table></div></div><p>但有时候为了方便起见，就算某个键在映射里不存在，我们也希望在通过这个键读取值的时候能得到一个默认值。有两个途径能帮我们达到这个目的：</p><ul><li>一个是通过 <code>defaultdict</code> 这个类型而不是普通的 <code>dict</code></li><li>另一个是给自己定义一个 <code>dict</code> 的子类，然后在子类中实现 <code>__missing__</code> 方法。</li></ul><p>下面将介绍这两种方法。</p><h4 id=defaultdict>defaultdict</h4><p>有些时候，希望某个键不存在于映射中也会返回一个默认值，collections.defaultdict 实现了 <code>__missing__</code> 方法，用于应对这种需求。</p><p>defaultdict 会按照如下步骤处理映射类型中不存在的键</p><ul><li>调用定义时指定的方法，创建一个新的对象（例如，若默认创建一个列表类型，则会调用 <code>list()</code> 方法创建一个新 list）</li><li>将新对象作为值，构建键值对并记录到原字典中</li><li>返回新创建的键值对的值的引用</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 把 list 构造方法作为 default_factory 来创建一个 defaultdict</span>
</span></span><span class=line><span class=cl><span class=n>my_dict</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>defaultdict 依赖 default_factory 方法实现上述操作，值得注意的是，defaultfactory 仅会在 <code>__getitem__</code> 中被调用，对于一个不存在于字典中的键 &ldquo;new_key&rdquo;，若直接用 <code>get()</code> 函数获取其对应的值则会返回 None。</p><p><code>__getitem__</code> 并不会直接调用 default_factory，而是按照如下流程进行调用：</p><ul><li>执行 <code>defaultdict["new_key"]</code>，希望获得 &ldquo;new_key&rdquo; 对应的值</li><li>调用<code> __getitem__()</code> 方法，结果没有在键列表中查询到 &ldquo;new_key&rdquo;</li><li>调用 <code>__missing__()</code> 方法，处理未知键 &ldquo;new_key&rdquo;</li><li>调用 <code>default_factory()</code> 方法，赋予 &ldquo;new_key&rdquo; 默认值</li></ul><p>上述流程中最为关键的是 <code>__missing__()</code> 方法的实现。它会在 <code>defaultdict</code> 遇到找不到的键的时候调用 <code>default_factory</code>。</p><h4 id=自定义-__missing__>自定义 <code>__missing__</code></h4><p>实际上，对于自定义的映射数据类型，若想处理未知键的查询和创建任务，也仅需要实现 <code>__missing__()</code> 方法就好。</p><img src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/v2-1cab46cb5483c5272075666649f91f26_1440w.jpg alt=img style=zoom:50%><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>TestDict</span><span class=p>(</span><span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 其他代码，省略</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__missing__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;call __missing__&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 新增 key </span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;default&#34;</span>
</span></span><span class=line><span class=cl>	<span class=c1># 返回该项</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;default&#34;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>如果要自定义一个映射类型，更合适的策略其实是继承 <code>collections.UserDict</code> 类（示例 3-8 就是如此）。这里我们从 <code>dict</code> 继承，只是为了演示 <code>__missing__</code> 是如何被 <code>dict.__getitem__</code> 调用的。</p></blockquote><h3 id=字典的变种>字典的变种</h3><p><code>dict</code> 类型是最常用的映射类型，<code>defaultdict</code> 和 <code>OrderedDict</code> 则是 <code>dict</code> 的变种，这两个类型支持一些特殊的用法。此外还有如 <code>ChainMap</code>（可容纳多个映射对象并在进行键查找时，在所有的映射对象中进行查找）、<code>Counter</code>（具有计数器功能，相当适用于计数任务）、UserDict（开箱即用的自定义映射类型基类）等</p><p>总的来说，这些变种均具有 dict 具有的功能，此外还为了应对不同的应用场合提供了更为丰富的功能。</p><h4 id=collectionsdefaultdict>collections.defaultdict</h4><p><code>defaultdict</code> 对未知键提供了特殊支持，当传入字典中不存在的键获取数据时，<code>dict</code> 会直接报错，而 <code>defaultdict</code> 则会默认为这个新键创建对应的键值对（在建立字典的时候非常非常非常好用，之前都是首先用 if 判断字典中是否存在该键，然后根据判断结果创建或者修改键值对）</p><h4 id=collectionsordereddict>collections.OrderedDict</h4><p><code>OrderedDict</code> 则对顺序提供了额外支持，普通的 dict 并不会记录键值对的顺序，或者说 <code>dict</code> 中的键值对都是无序的，但是 <code>OrderedDict</code> 则提供了额外的键值对顺序功能支持，支持类似于先入先出的功能。</p><p><code>OrderedDict</code> 的 <code>popitem</code> 方法默认删除并返回的是字典里的最后一个元素，但是如果像 <code>my_odict.popitem(last=False)</code> 这样调用它，那么它删除并返回第一个被添加进去的元素。</p><h4 id=collectionschainmap>collections.ChainMap</h4><p>详见 <a href=https://www.cnblogs.com/mangmangbiluo/p/9882097.html target=_blank rel="external nofollow noopener noreferrer">https://www.cnblogs.com/mangmangbiluo/p/9882097.html</a></p><p>该类型可以容纳数个不同的映射对象，然后在进行键查找操作的时候，这些对象会被当作一个整体被逐个查找，直到键被找到为止。这个功能在给有嵌套作用域的语言做解释器的时候很有用，可以用一个映射对象来代表一个作用域的上下文。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>ChainMapa</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;x&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;z&#34;</span><span class=p>:</span><span class=mi>3</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>b</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;y&#34;</span><span class=p>:</span><span class=mi>2</span><span class=p>,</span> <span class=s2>&#34;z&#34;</span><span class=p>:</span><span class=mi>4</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>c</span> <span class=o>=</span> <span class=n>ChainMap</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;x: </span><span class=si>{}</span><span class=s2>, y: </span><span class=si>{}</span><span class=s2>, z: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>c</span><span class=p>[</span><span class=s2>&#34;x&#34;</span><span class=p>],</span> <span class=n>c</span><span class=p>[</span><span class=s2>&#34;y&#34;</span><span class=p>],</span> <span class=n>c</span><span class=p>[</span><span class=s2>&#34;z&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>输出</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=n>ChainMap</span><span class=p>({</span><span class=s1>&#39;x&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;z&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>},</span> <span class=p>{</span><span class=s1>&#39;y&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;z&#39;</span><span class=p>:</span> <span class=mi>4</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>x</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=n>z</span><span class=p>:</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>Finished</span> <span class=ow>in</span> <span class=mf>0.1</span><span class=n>s</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>这是 ChainMap 最基本的使用，可以用来合并两个或者更多个字典，当查询的时候，从前往后依次查询。</p><p>从原理上面讲，ChainMap 实际上是把放入的字典存储在一个队列中，当进行字典的增加删除等操作只会在第一个字典上进行，当进行查找的时候会依次查找</p><p>有一个注意点就是当对 ChainMap 进行修改的时候总是只会对第一个字典进行修改</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>6</span><span class=p>]:</span> <span class=n>a</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;x&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;z&#34;</span><span class=p>:</span><span class=mi>3</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>7</span><span class=p>]:</span> <span class=n>b</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;y&#34;</span><span class=p>:</span><span class=mi>2</span><span class=p>,</span> <span class=s2>&#34;z&#34;</span><span class=p>:</span><span class=mi>4</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>8</span><span class=p>]:</span> <span class=n>c</span> <span class=o>=</span> <span class=n>ChainMap</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>9</span><span class=p>]:</span> <span class=n>c</span>
</span></span><span class=line><span class=cl><span class=n>Out</span><span class=p>[</span><span class=mi>9</span><span class=p>]:</span> <span class=n>ChainMap</span><span class=p>({</span><span class=s1>&#39;z&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=s1>&#39;x&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>},</span> <span class=p>{</span><span class=s1>&#39;z&#39;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=s1>&#39;y&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>10</span><span class=p>]:</span> <span class=n>c</span><span class=p>[</span><span class=s2>&#34;z&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>Out</span><span class=p>[</span><span class=mi>10</span><span class=p>]:</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>11</span><span class=p>]:</span> <span class=n>c</span><span class=p>[</span><span class=s2>&#34;z&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>12</span><span class=p>]:</span> <span class=n>c</span>
</span></span><span class=line><span class=cl><span class=n>Out</span><span class=p>[</span><span class=mi>12</span><span class=p>]:</span> <span class=n>ChainMap</span><span class=p>({</span><span class=s1>&#39;z&#39;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=s1>&#39;x&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>},</span> <span class=p>{</span><span class=s1>&#39;z&#39;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=s1>&#39;y&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>13</span><span class=p>]:</span> <span class=n>c</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;z&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Out</span><span class=p>[</span><span class=mi>13</span><span class=p>]:</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>14</span><span class=p>]:</span> <span class=n>c</span>
</span></span><span class=line><span class=cl><span class=n>Out</span><span class=p>[</span><span class=mi>14</span><span class=p>]:</span> <span class=n>ChainMap</span><span class=p>({</span><span class=s1>&#39;x&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>},</span> <span class=p>{</span><span class=s1>&#39;z&#39;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=s1>&#39;y&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>15</span><span class=p>]:</span> <span class=k>del</span> <span class=n>c</span><span class=p>[</span><span class=s2>&#34;y&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>---------------------------------------------------------------------------</span>
</span></span><span class=line><span class=cl><span class=ne>KeyError</span>                                  <span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=err>。。。。。。</span>
</span></span><span class=line><span class=cl><span class=ne>KeyError</span><span class=p>:</span> <span class=s2>&#34;Key not found in the first mapping: &#39;y&#39;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=collectionscounter>collections.Counter</h4><p>这个映射类型会给键准备一个整数计数器。每次更新一个键的时候都会增加这个计数器。</p><p>所以这个类型可以用来给可散列表对象计数，或者是当成多重集来用——多重集合就是集合里的元素可以出现不止一次。</p><p><code>Counter</code> 实现了 <code>+</code> 和 <code>-</code> 运算符用来合并记录，还有像 <code>most_common([n])</code> 这类很有用的方法。<code>most_common([n])</code> 会按照次序返回映射里最常见的 <code>n</code> 个键和它们的计数</p><p>下面的小例子利用 <code>Counter</code> 来计算单词中各个字母出现的次数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>ct</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>Counter</span><span class=p>(</span><span class=s1>&#39;abracadabra&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>ct</span>
</span></span><span class=line><span class=cl><span class=n>Counter</span><span class=p>({</span><span class=s1>&#39;a&#39;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>ct</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=s1>&#39;aaaaazzz&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>ct</span>
</span></span><span class=line><span class=cl><span class=n>Counter</span><span class=p>({</span><span class=s1>&#39;a&#39;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span> <span class=s1>&#39;z&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>ct</span><span class=o>.</span><span class=n>most_common</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[(</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;z&#39;</span><span class=p>,</span> <span class=mi>3</span><span class=p>)]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=userdict>UserDict</h4><p>这个类其实就是把标准 <code>dict</code> 用纯 Python 又实现了一遍。</p><p>跟 <code>OrderedDict</code>、<code>ChainMap</code> 和 <code>Counter</code> 这些开箱即用的类型不同，<code>UserDict</code> 是让用户继承写子类的。</p><h3 id=子类化-userdict>子类化 <code>UserDict</code></h3><p>而更倾向于从 <code>UserDict</code> 而不是从 <code>dict</code> 继承的主要原因是，后者有时会在某些方法的实现上走一些捷径，导致我们不得不在它的子类中重写这些方法，但是 <code>UserDict</code> 就不会带来这些问题</p><p>另外一个值得注意的地方是，<code>UserDict</code> 并不是 <code>dict</code> 的子类，但是 <code>UserDict</code> 有一个叫作 <code>data</code> 的属性，是 <code>dict</code> 的实例，这个属性实际上是 <code>UserDict</code> 最终存储数据的地方。这样做的好处是，比起示例 3-7，<code>UserDict</code> 的子类就能在实现 <code>__setitem__</code> 的时候避免不必要的递归，也可以让 <code>__contains__</code> 里的代码更简洁。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>collections</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>StrKeyDict</span><span class=p>(</span><span class=n>collections</span><span class=o>.</span><span class=n>UserDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__missing__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=p>[</span><span class=nb>str</span><span class=p>(</span><span class=n>key</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__contains__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>data</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__setitem__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=nb>str</span><span class=p>(</span><span class=n>key</span><span class=p>)]</span> <span class=o>=</span> <span class=n>item</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=不可变的映射类型>不可变的映射类型</h3><p>从 Python 3.3 开始，types 模块中引入了一个封装类名叫 MappingProxyType。如果给这个类一个映射，它会返回一个只读的映射视图。</p><p>虽然是个只读视图，但是它是动态的。这意味着如果对原映射做出了改动，我们通过这个视图可以观察到，但是无法通过这个视图对原映射做出修改。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>types</span> <span class=kn>import</span> <span class=n>MappingProxyType</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d</span> <span class=o>=</span> <span class=p>{</span><span class=mi>1</span><span class=p>:</span><span class=s1>&#39;A&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d_proxy</span> <span class=o>=</span> <span class=n>MappingProxyType</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d_proxy</span>
</span></span><span class=line><span class=cl><span class=n>mappingproxy</span><span class=p>({</span><span class=mi>1</span><span class=p>:</span> <span class=s1>&#39;A&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d_proxy</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># d 中的内容可以通过 d_proxy 看到</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;A&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d_proxy</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;x&#39;</span>  <span class=c1># 但是通过 d_proxy 并不能做任何修改</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;&lt;stdin&gt;&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>1</span><span class=p>,</span> <span class=ow>in</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=ne>TypeError</span><span class=p>:</span> <span class=s1>&#39;mappingproxy&#39;</span> <span class=nb>object</span> <span class=n>does</span> <span class=ow>not</span> <span class=n>support</span> <span class=n>item</span> <span class=n>assignment</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;B&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d_proxy</span> <span class=c1># d_proxy 是动态的，也就是说对 d 所做的任何改动都会反馈到它上面</span>
</span></span><span class=line><span class=cl><span class=n>mappingproxy</span><span class=p>({</span><span class=mi>1</span><span class=p>:</span> <span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=mi>2</span><span class=p>:</span> <span class=s1>&#39;B&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d_proxy</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;B&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=集合>集合</h3><p>集合在 Python 中是一个较新的概念，其描述了<strong>唯一</strong>对象的集合。集合有如下特点：</p><ol><li>元素的唯一性：集合中不会有两个一样的对象（这里的唯一性指的是 hash 的唯一性）</li><li>集合中的元素必须是可散列的，但是**<code>set</code> 本身是不可散列的**，<code>set</code> 类型本身是不可散列的，但是 <code>frozenset</code> 可以。因此可以创建一个包含不同 <code>frozenset</code> 的 <code>set</code>。</li><li>集合允许各种基于集合的二元运算，例如交集、并集以及差集<ul><li><code>a | b</code> 返回的是它们的合集，<code>a & b</code> 得到的是交集，而 <code>a - b</code> 得到的是差集。</li></ul></li></ol><h4 id=集合的字面量>集合的字面量</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s</span> <span class=o>=</span> <span class=p>{</span><span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>type</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=k>class</span> <span class=err>&#39;</span><span class=nc>set</span><span class=s1>&#39;&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s</span><span class=o>.</span><span class=n>pop</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s</span>
</span></span><span class=line><span class=cl><span class=nb>set</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>像 <code>{1, 2, 3}</code> 这种字面量句法相比于构造方法（<code>set([1, 2, 3])</code>）要更快且更易读。后者的速度要慢一些，因为 Python 必须先从 <code>set</code> 这个名字来查询构造方法，然后新建一个列表，最后再把这个列表传入到构造方法里。但是如果是像 <code>{1, 2, 3}</code> 这样的字面量，Python 会利用一个专门的叫作 <code>BUILD_SET</code> 的字节码来创建集合。</p><p><strong>用 <code>dis.dis</code>（反汇编函数）来看看两个方法的字节码的不同：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>dis</span> <span class=kn>import</span> <span class=n>dis</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>dis</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>{1}</span><span class=s1>&#39;</span><span class=p>)</span>                                  <span class=err>➊</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>           <span class=mi>0</span> <span class=n>LOAD_CONST</span>             <span class=mi>0</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=mi>3</span> <span class=n>BUILD_SET</span>              <span class=mi>1</span>        <span class=err>➋</span>
</span></span><span class=line><span class=cl>              <span class=mi>6</span> <span class=n>RETURN_VALUE</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>dis</span><span class=p>(</span><span class=s1>&#39;set([1])&#39;</span><span class=p>)</span>                             <span class=err>➌</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>           <span class=mi>0</span> <span class=n>LOAD_NAME</span>              <span class=mi>0</span> <span class=p>(</span><span class=nb>set</span><span class=p>)</span>  <span class=err>➍</span>
</span></span><span class=line><span class=cl>              <span class=mi>3</span> <span class=n>LOAD_CONST</span>             <span class=mi>0</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=mi>6</span> <span class=n>BUILD_LIST</span>             <span class=mi>1</span>
</span></span><span class=line><span class=cl>              <span class=mi>9</span> <span class=n>CALL_FUNCTION</span>          <span class=mi>1</span> <span class=p>(</span><span class=mi>1</span> <span class=n>positional</span><span class=p>,</span> <span class=mi>0</span> <span class=n>keyword</span> <span class=n>pair</span><span class=p>)</span>
</span></span><span class=line><span class=cl>             <span class=mi>12</span> <span class=n>RETURN_VALUE</span>
</span></span></code></pre></td></tr></table></div></div><p>➊ 检查 <code>{1}</code> 字面量背后的字节码。</p><p>➋ 特殊的字节码 <code>BUILD_SET</code> 几乎完成了所有的工作。</p><p>➌ <code>set([1])</code> 的字节码。</p><p>➍ 3 种不同的操作代替了上面的 <code>BUILD_SET</code>：<code>LOAD_NAME</code>、<code>BUILD_LIST</code> 和 <code>CALL_FUNCTION</code>。</p><h4 id=集合推导>集合推导</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unicodedata</span> <span class=kn>import</span> <span class=n>name</span>  <span class=c1># 从 unicodedata 模块里导入 name 函数，用以获取字符的名字</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=p>{</span><span class=nb>chr</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=mi>256</span><span class=p>)</span> <span class=k>if</span> <span class=s1>&#39;SIGN&#39;</span> <span class=ow>in</span> <span class=n>name</span><span class=p>(</span><span class=nb>chr</span><span class=p>(</span><span class=n>i</span><span class=p>),</span><span class=s1>&#39;&#39;</span><span class=p>)}</span>  
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s1>&#39;§&#39;</span><span class=p>,</span> <span class=s1>&#39;=&#39;</span><span class=p>,</span> <span class=s1>&#39;¢&#39;</span><span class=p>,</span> <span class=s1>&#39;#&#39;</span><span class=p>,</span> <span class=s1>&#39;¤&#39;</span><span class=p>,</span> <span class=s1>&#39;&lt;&#39;</span><span class=p>,</span> <span class=s1>&#39;¥&#39;</span><span class=p>,</span> <span class=s1>&#39;μ&#39;</span><span class=p>,</span> <span class=s1>&#39;×&#39;</span><span class=p>,</span> <span class=s1>&#39;$&#39;</span><span class=p>,</span> <span class=s1>&#39;¶&#39;</span><span class=p>,</span> <span class=s1>&#39;£&#39;</span><span class=p>,</span> <span class=s1>&#39;©&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;°&#39;</span><span class=p>,</span> <span class=s1>&#39;+&#39;</span><span class=p>,</span> <span class=s1>&#39;÷&#39;</span><span class=p>,</span> <span class=s1>&#39;±&#39;</span><span class=p>,</span> <span class=s1>&#39;&gt;&#39;</span><span class=p>,</span> <span class=s1>&#39;¬&#39;</span><span class=p>,</span> <span class=s1>&#39;®&#39;</span><span class=p>,</span> <span class=s1>&#39;%&#39;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=dict-和-set-的背后>dict 和 set 的背后</h3><p>散列表其实是一个稀疏数组（总是有空白元素的数组称为稀疏数组）。在一般的数据结构教材中，散列表里的单元通常叫作表元（bucket）。在 <code>dict</code> 的散列表当中，每个键值对都占用一个表元，每个表元都有两个部分，一个是对键的引用，另一个是对值的引用。因为所有表元的大小一致，所以可以通过偏移量来读取某个表元。</p><p>因为 Python 会设法保证大概还有三分之一的表元是空的，所以在快要达到这个阈值的时候，原有的散列表会被复制到一个更大的空间里面。</p><p>如果要把一个对象放入散列表，那么首先要计算这个元素键的<strong>散列值</strong>。Python 中可以用 <code>hash()</code> 方法来做这件事情。</p><h4 id=散列值和相等性>散列值和相等性</h4><p>内置的 <code>hash()</code> 方法可以用于所有的内置类型对象。如果是自定义对象调用 <code>hash()</code> 的话，实际上运行的是自定义的 <code>__hash__</code>。</p><p><strong>如果两个对象在比较的时候是相等的，那它们的散列值必须相等</strong>，否则散列表就不能正常运行了。例如，如果 <code>1 == 1.0</code> 为真，那么 <code>hash(1) == hash(1.0)</code> 也必须为真，但其实这两个数字（整型和浮点）的内部结构是完全不一样的</p><p>为了让散列值能够胜任散列表索引这一角色，它们必须在索引空间中尽量分散开来。这意味着在最理想的状况下，越是相似但不相等的对象，它们散列值的差别应该越大。</p><p>总结一下，一个可散列的对象必须满足以下要求。</p><ol><li>支持 <code>hash()</code> 函数，并且通过 <code>__hash__()</code> 方法所得到的散列值是不变的。</li><li>支持通过 <code>__eq__()</code> 方法来检测相等性。</li><li>若 <code>a == b</code> 为真，则 <code>hash(a) == hash(b)</code> 也为真。</li></ol><p><strong>所有由用户自定义的对象默认都是可散列的</strong>，因为它们的散列值由 <code>id()</code> 来获取，而且它们都是不相等的</p><blockquote><p>如果你实现了一个类的 <code>__eq__</code> 方法，并且希望它是可散列的，那么它一定要有个恰当的 <code>__hash__</code> 方法，保证在 <code>a == b</code> 为真的情况下 <code>hash(a) == hash(b)</code> 也必定为真。否则就会破坏恒定的散列表算法，导致由这些对象所组成的字典和集合完全失去可靠性，这个后果是非常可怕的。</p><p>另一方面，如果一个含有自定义的 <code>__eq__</code> 依赖的类处于可变的状态，那就不要在这个类中实现 <code>__hash__</code> 方法，因为它的实例是不可散列的。</p></blockquote><h5 id=一个例子>一个例子</h5><p>在 32 位的 Python 中，1、1.0001、1.0002 和 1.0003 这几个数的散列值的二进制表达对比（上下两个二进制间不同的位被 <code>!</code> 高亮出来，表格的最右列显示了有多少位不相同）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>32-bit Python build
</span></span><span class=line><span class=cl><span class=m>1</span>        <span class=m>00000000000000000000000000000001</span>
</span></span><span class=line><span class=cl>                                          !<span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>1.0      <span class=m>00000000000000000000000000000001</span>
</span></span><span class=line><span class=cl>------------------------------------------------
</span></span><span class=line><span class=cl>1.0      <span class=m>00000000000000000000000000000001</span>
</span></span><span class=line><span class=cl>           ! !!! ! !! ! !    ! ! !! !!!   !<span class=o>=</span> <span class=m>16</span>
</span></span><span class=line><span class=cl>1.0001   <span class=m>00101110101101010000101011011101</span>
</span></span><span class=line><span class=cl>------------------------------------------------
</span></span><span class=line><span class=cl>1.0001   <span class=m>00101110101101010000101011011101</span>
</span></span><span class=line><span class=cl>          !!!  !!!! !!!!!   !!!!! !!  !   !<span class=o>=</span> <span class=m>20</span>
</span></span><span class=line><span class=cl>1.0002   <span class=m>01011101011010100001010110111001</span>
</span></span><span class=line><span class=cl>------------------------------------------------
</span></span><span class=line><span class=cl>1.0002   <span class=m>01011101011010100001010110111001</span>
</span></span><span class=line><span class=cl>          ! !   ! !!! ! !  !! ! !  ! !!!! !<span class=o>=</span> <span class=m>17</span>
</span></span><span class=line><span class=cl>1.0003   <span class=m>00001100000111110010000010010110</span>
</span></span><span class=line><span class=cl>------------------------------------------------
</span></span></code></pre></td></tr></table></div></div><blockquote><p>从 Python 3.3 开始，<code>str</code>、<code>bytes</code> 和 <code>datetime</code> 对象的散列值计算过程中多了随机的“加盐”这一步。所加盐值是 Python 进程内的一个常量，但是每次启动 Python 解释器都会生成一个不同的盐值。随机盐值的加入是为了防止 DOS 攻击而采取的一种安全措施。</p></blockquote><h4 id=散列表算法>散列表算法</h4><p>为了获取 <code>my_dict[search_key]</code> 背后的值，Python 首先会调用 <code>hash(search_key)</code> 来计算 <code>search_key</code> 的<strong>散列值</strong>，把这个值最低的几位数字当作偏移量，在散列表里查找表元（具体取几位，得看当前散列表的大小）。若找到的表元是空的，则抛出 <code>KeyError</code> 异常。若不是空的，则表元里会有一对 <code>found_key:found_value</code>。这时候 Python 会检验 <code>search_key == found_key</code> 是否为真，如果它们相等的话，就会返回 <code>found_value</code>。</p><p>如果 <code>search_key</code> 和 <code>found_key</code> 不匹配的话，这种情况称为<strong>散列冲突</strong>。发生这种情况是因为，散列表所做的其实是把随机的元素映射到只有几位的数字上，而散列表本身的索引又只依赖于这个数字的一部分。为了解决散列冲突，算法会在散列值中另外再取几位，然后用特殊的方法处理一下，把新得到的数字再当作索引来寻找表元；若这次找到的表元是空的，则同样抛出 <code>KeyError</code>；若非空，或者键匹配，则返回这个值；或者又发现了散列冲突，则重复以上的步骤。</p><p>总结一下：</p><ol><li>计算键的散列值</li><li>使用散列值的一部分来定位散列表中的一个表元</li><li>判断表元是否为空<ul><li>若为空，抛出 KeyError</li><li>若不为空，执行第 4 步</li></ul></li><li>检查是否是期望的元素<ul><li>若是期望的元素，返回表元中的值</li><li>若不是期望的元素，执行第 5 步</li></ul></li><li>发生冲突，使用散列值的另一部分来定位散列表中的另一行，并返回第 3 步</li></ol><p>添加新元素和更新现有键值的操作几乎跟查找一样。只不过对于前者，在发现空表元的时候会放入一个新元素；对于后者，在找到相对应的表元后，原表里的值对象会被替换成新值。。此外，<strong>为了保证散列表的稀疏性，当元素数量增添到一定阈值时，Python会自动将这个散列表复制到更大的空间中以避免冲突</strong>。</p><h4 id=一些特点>一些特点</h4><h5 id=字典在内存上的开销巨大>字典在内存上的开销巨大</h5><p>由于字典使用了散列表，而散列表又必须是稀疏的，这导致它在空间上的效率低下。</p><p>举例而言，如果你需要存放数量巨大的记录，那么放在<strong>由元组或是具名元组构成的列表</strong>中会是比较好的选择；最好不要根据 JSON 的风格，然后用字典组成的列表来存放这些记录。</p><p>用元组取代字典就能节省空间的原因有两个：其一是避免了散列表所耗费的空间，其二是无需把记录中字段的名字在每个元素里都存一遍。</p><blockquote><p>在用户自定义的类型中，<code>__slots__</code> 属性可以改变实例属性的存储方式，由 <code>dict</code> 变成 <code>tuple</code></p></blockquote><h4 id=总结>总结</h4><ol><li>正是由于 dict 和 set 使用散列表来进行数据存储，在进行元素查找时不需要对所有元素进行遍历，这使得搜索特定元素的效率大大提高。<ul><li>并且由于稀疏性，查找时间不会随着 dict 和 set 中元素数量的增加而线性增长。</li></ul></li><li>由于使用散列表进行存储，dict 和 set 中的元素也没有固定的顺序，在添加新元素时原有的顺序可能会被改变</li><li>dict 和 set 使用散列表进行数据存储，因此这两个数据类型要求元素时可散列的。<ul><li>即，在 Python 中某元素必须支持 <code>__hash__()</code> 函数，并且通过 <code>__hash__()</code> 函数取得的散列值在生命周期中不发生变化。</li><li>此外，Python 还要求可散列的元素支持 <code>__eq__()</code> 方法以判断相等性。这些条件使得不是所有的对象均可以作为 dict 的键或者 set 的元素。</li></ul></li><li>与 2 类似，由于添加元素后很可能改变原有的顺序，因此在 dict 和 set 中讨论元素的顺序没有意义，除非使用类似于 OrderedDict 这样的特殊类型。</li><li>由于元素的顺序不确定，在循环迭代 dict 或者 set 的同时删增元素可能会导致跳过某些元素。<ol><li>若使用 <code>.keys()</code>、<code>.values()</code> 以及 <code>.items()</code> 等函数对 dict 进行循环迭代，Python3 中这些方法返回的字典视图具有动态的特性。即，循环迭代过程中对 dict 的改变会实时反馈到循环条件上，这显然会导致不可预测的错误。</li></ol></li><li>dict 和 set 是空间换时间的典型例子。散列表需要保证稀疏性以尽可能避免冲突<ul><li>因此，相较于 list，dict 和 set 需要维护更大的内存空间以保证散列表的稀疏性</li></ul></li></ol><h3 id=其他-2>其他</h3><ul><li>像 <code>k in my_dict.keys()</code> 这种操作在 Python 3 中是很快的，而且即便映射类型对象很庞大也没关系。这是因为 <code>dict.keys()</code> 的返回值是一个 “<strong>视图</strong>”。<ul><li>视图就像一个集合，而且跟字典类似的是，在视图里查找一个元素的速度很快。Python 2 的 <code>dict.keys()</code> 返回的是个列表，因此虽然上面的方法仍然是正确的，它在处理体积大的对象的时候效率不会太高，因为 <code>k in my_list</code> 操作需要扫描整个列表。</li></ul></li><li>CPython 的实现细节里有一条是：如果有一个整型对象，而且它能被存进一个机器字中，那么它的散列值就是它本身的值</li><li>在散列冲突的情况下，用 C 语言写的用来打乱散列值位的算法的名字很有意思，叫 <code>perturb</code>。详见 CPython 源码里的 <code>dictobject.c</code>（https://hg.python.org/cpython/file/tip/Objects/dictobject.c）</li><li>PHP 和 Ruby 的散列语法借鉴了 Perl，它们都用 <code>=></code> 作为键和值的连接。JavaScript 则从 Python 那儿偷师，使用了 <code>:</code>。而 JSON 又从 JavaScript 发展而来，它的语法正好是 Python 句法的子集。因此，除了在 <code>true</code>、<code>false</code> 和 <code>null</code> 这几个值的拼写上有出入之外，JSON 和 Python 是完全兼容的。于是，现在大家用来交换数据的格式全是 Python 的 <code>dict</code> 和 <code>list</code>。</li></ul><h2 id=文本和字节序列>文本和字节序列</h2><p>本章将要讨论 Unicode 字符串、二进制序列，以及在二者之间转换时使用的编码</p><h3 id=字符问题>字符问题</h3><p><strong>字符串即字符的序列</strong>，重点是“字符”如何定义。</p><p>对于 Python，“字符” 即 Unicode 字符。字符的相关操作涉及到两个问题：</p><ul><li><strong>字符的标识</strong>，即<strong>码位</strong>，是特定字符在字符集中的唯一标识。<ul><li>码位是 0~1 114 111 的数字（十进制），在 Unicode 标准中以 4~6 个十六进制数字表示，而且加前缀“U+”。例如，字母 A 的码位是 U+0041，欧元符号的码位是 U+20AC，高音谱号的码位是 U+1D11E。</li></ul></li><li><strong>字符的字节表述</strong>，是字符的具体表述，通过特定的编码算法连接字符和对应的字节表述。<ul><li>在 UTF-8 编码中，A（U+0041）的码位编码成单个字节 <code>\x41</code>，而在 UTF-16LE 编码中编码成两个字节 <code>\x41\x00</code>。再举个例子，欧元符号（U+20AC）在 UTF-8 编码中是三个字节——<code>\xe2\x82\xac</code>，而在 UTF-16LE 中编码成两个字节：<code>\xac\x20</code>。</li></ul></li></ul><p><strong>编码</strong>：将码位转换为字节序列的过程</p><p><strong>解码</strong>：将字节序列转换为码位的过程</p><p>Python 对字符和字节进行了完全的区分，具体来说，<strong>所有的字节序列的字面量均会以特定标识开头</strong>。下述为编 / 解码的一个示例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s</span> <span class=o>=</span> <span class=s1>&#39;café&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf8&#39;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span>
</span></span><span class=line><span class=cl><span class=sa>b</span><span class=s1>&#39;caf</span><span class=se>\xc3\xa9</span><span class=s1>&#39;</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf8&#39;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=s1>&#39;café</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Python 3 的 <code>str</code> 类型基本相当于 Python 2 的 <code>unicode</code> 类型</p><p>Python 3 的 <code>bytes</code> 类型基本相当于 Python2 的 <code>str</code> 类型</p></blockquote><p>字符串比较关键的问题是字符的编码算法以及文本文件的处理。前者涉及到的问题众多，而且相关的乱码问题时不时会出现，例如 matplotlib 的中文支持问题，后者则在读写文件时时常会遇到。</p><h3 id=字节概要>字节概要</h3><p>bytes 是一种不可变数据类型，其元素是 0~255 之间的整数，并且 bytes 类型数据的切片依然是 bytes 类型。</p><p>bytearray 类型和 bytes 类型密切相关，bytearray 没有自己的字面量语法，但是和 bytes 类型的行为一致，其切片依然是 bytearray 类型。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>cafe</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=s1>&#39;café&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf_8&#39;</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>cafe</span>
</span></span><span class=line><span class=cl><span class=sa>b</span><span class=s1>&#39;caf</span><span class=se>\xc3\xa9</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>cafe</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=mi>99</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>cafe</span><span class=p>[:</span><span class=mi>1</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=sa>b</span><span class=s1>&#39;c&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>cafe_arr</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>(</span><span class=n>cafe</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>cafe_arr</span> 
</span></span><span class=line><span class=cl><span class=nb>bytearray</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;caf</span><span class=se>\xc3\xa9</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>cafe_arr</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>:]</span> 
</span></span><span class=line><span class=cl><span class=nb>bytearray</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xa9</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p><code>my_bytes[0]</code> 获取的是一个整数，而 <code>my_bytes[:1]</code> 返回的是一个长度为 1 的 <code>bytes</code> 对象——这一点应该不会让人意外。<code>s[0] == s[:1]</code> 只对 <code>str</code> 这个序列类型成立。</p><p>不过，<code>str</code> 类型的这个行为十分罕见。对其他各个序列类型来说，<code>s[i]</code> 返回一个元素，而 <code>s[i:i+1]</code> 返回一个相同类型的序列，里面是 <code>s[i]</code> 元素。</p></blockquote><h4 id=字节的字面量表示>字节的字面量表示</h4><p>虽然二进制序列其实是整数序列，但是它们的字面量表示法表明其中有 ASCII 文本。因此，各个字节的值可能会使用下列三种不同的方式显示。</p><ul><li>可打印的 ASCII 范围内的字节（从空格到 <code>~</code>），使用 ASCII 字符本身。</li><li>制表符、换行符、回车符和 <code>\</code> 对应的字节，使用转义序列 <code>\t</code>、<code>\n</code>、<code>\r</code> 和 <code>\\</code>。</li><li>其他字节的值，使用十六进制转义序列（例如，<code>\x00</code> 是空字节）。</li></ul><p>因此，在上面的代码中 5，我们看到的是 <code>b'caf\xc3\xa9'</code>：前 3 个字节 <code>b'caf'</code> 在可打印的 ASCII 范围内，后两个字节则不然。</p><h4 id=编解码器>编解码器</h4><p>Python 自带了相当数量的编解码器，常用的例如 utf-8、gbk 等</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>for</span> <span class=n>codec</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;latin_1&#39;</span><span class=p>,</span> <span class=s1>&#39;utf_8&#39;</span><span class=p>,</span> <span class=s1>&#39;utf_16&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=n>codec</span><span class=p>,</span> <span class=s1>&#39;El Niño&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=n>codec</span><span class=p>),</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39;</span><span class=se>\t</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>latin_1</span> <span class=sa>b</span><span class=s1>&#39;El Ni</span><span class=se>\xf1</span><span class=s1>o&#39;</span>
</span></span><span class=line><span class=cl><span class=n>utf_8</span>   <span class=sa>b</span><span class=s1>&#39;El Ni</span><span class=se>\xc3\xb1</span><span class=s1>o&#39;</span>
</span></span><span class=line><span class=cl><span class=n>utf_16</span>  <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xff\xfe</span><span class=s1>E</span><span class=se>\x00</span><span class=s1>l</span><span class=se>\x00</span><span class=s1> </span><span class=se>\x00</span><span class=s1>N</span><span class=se>\x00</span><span class=s1>i</span><span class=se>\x00\xf1\x00</span><span class=s1>o</span><span class=se>\x00</span><span class=s1>&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>编解码问题会导致一些异常的抛出：</p><ol><li>UnicodeEncodeError：str 转 bytes 时</li><li>UnicodeDecodeError：bytes 转 str 时</li><li>SyntaxError：源码的编码错误</li></ol><h3 id=处理文本文件>处理文本文件</h3><p>处理文本的最佳实践是 “Unicode 三明治”</p><ul><li>要尽早把输入（例如读取文件时）的字节序列解码成字符串。</li><li>这种三明治中的“肉片”是程序的业务逻辑，在这里只能处理字符串对象。在其他处理过程中，一定不能编码或解码。</li><li>对输出来说，则要尽量晚地把字符串编码成字节序列。</li></ul><img src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220808133807453.png alt=image-20220808133807453 style=zoom:50%><p>在 Python 3 中能轻松地采纳 Unicode 三明治的建议，因为内置的 <code>open</code> 函数会在读取文件时做必要的解码，以文本模式写入文件时还会做必要的编码，所以调用 <code>my_file.read()</code> 方法得到的以及传给 <code>my_file.write(text)</code> 方法的都是字符串对象</p><h3 id=为了正确比较而规范化-unicode-字符串>为了正确比较而规范化 Unicode 字符串</h3><p>因为 Unicode 有组合字符（变音符号和附加到前一个字符上的记号，打印时作为一个整体），所以字符串比较起来很复杂。</p><p>例如，“café” 这个词可以使用两种方式构成，分别有 4 个和 5 个码位，但是结果完全一样：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s1</span> <span class=o>=</span> <span class=s1>&#39;café&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s2</span> <span class=o>=</span> <span class=s1>&#39;cafe</span><span class=se>\u0301</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s1</span><span class=p>,</span> <span class=n>s2</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;café&#39;</span><span class=p>,</span> <span class=s1>&#39;café&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s1</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>s2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s1</span> <span class=o>==</span> <span class=n>s2</span>
</span></span><span class=line><span class=cl><span class=kc>False</span>
</span></span></code></pre></td></tr></table></div></div><p>U+0301 是 <code>COMBINING ACUTE ACCENT</code>，加在“e”后面得到“é”。在 Unicode 标准中，<code>'é'</code> 和 <code>'e\u0301'</code> 这样的序列叫“标准等价物”（canonical equivalent），应用程序应该把它们视作相同的字符。但是，Python 看到的是不同的码位序列，因此判定二者不相等。</p><p>这个问题的解决方案是使用 <code>unicodedata.normalize</code> 函数提供的 Unicode 规范化。这个函数的第一个参数是这 4 个字符串中的一个：<code>'NFC'</code>、<code>'NFD'</code>、<code>'NFKC'</code> 和 <code>'NFKD'</code>。</p><ol><li>NFC：使用<strong>最少码位</strong>构成等价字符串</li><li>NFD：将所有的组合字符解析为基字符和单独的组合字符</li><li>NFKC：基本上就是 NFC 的兼容模式，添加了对兼容字符的处理</li><li>NFKD：基本上就是 NFD 的兼容模式，添加了对兼容字符的处理</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unicodedata</span> <span class=kn>import</span> <span class=n>normalize</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s1</span> <span class=o>=</span> <span class=s1>&#39;café&#39;</span>  <span class=c1># 把&#34;e&#34;和重音符组合在一起</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s2</span> <span class=o>=</span> <span class=s1>&#39;cafe</span><span class=se>\u0301</span><span class=s1>&#39;</span>  <span class=c1># 分解成&#34;e&#34;和重音符</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s1</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>s2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFC&#39;</span><span class=p>,</span> <span class=n>s1</span><span class=p>)),</span> <span class=nb>len</span><span class=p>(</span><span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFC&#39;</span><span class=p>,</span> <span class=n>s2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFD&#39;</span><span class=p>,</span> <span class=n>s1</span><span class=p>)),</span> <span class=nb>len</span><span class=p>(</span><span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFD&#39;</span><span class=p>,</span> <span class=n>s2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFC&#39;</span><span class=p>,</span> <span class=n>s1</span><span class=p>)</span> <span class=o>==</span> <span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFC&#39;</span><span class=p>,</span> <span class=n>s2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFD&#39;</span><span class=p>,</span> <span class=n>s1</span><span class=p>)</span> <span class=o>==</span> <span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFD&#39;</span><span class=p>,</span> <span class=n>s2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>保存文本之前，最好使用 <code>normalize('NFC', user_text)</code> 清洗字符串。NFC 也是 W3C 的 “Character Model for the World Wide Web: String Matching and Searching” 规范推荐的规范化形式。</p></blockquote><p>使用 NFC 时，有些单字符会被规范成另一个单字符。例如，电阻的单位欧姆（Ω）会被规范成希腊字母大写的欧米加。这两个字符在视觉上是一样的，但是比较时并不相等，因此要规范化，防止出现意外：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unicodedata</span> <span class=kn>import</span> <span class=n>normalize</span><span class=p>,</span> <span class=n>name</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>ohm</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=se>\u2126</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>name</span><span class=p>(</span><span class=n>ohm</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;OHM SIGN&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>ohm_c</span> <span class=o>=</span> <span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFC&#39;</span><span class=p>,</span> <span class=n>ohm</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>name</span><span class=p>(</span><span class=n>ohm_c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;GREEK CAPITAL LETTER OMEGA&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>ohm</span> <span class=o>==</span> <span class=n>ohm_c</span>
</span></span><span class=line><span class=cl><span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFC&#39;</span><span class=p>,</span> <span class=n>ohm</span><span class=p>)</span> <span class=o>==</span> <span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFC&#39;</span><span class=p>,</span> <span class=n>ohm_c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><p>下面是 NFKC 的具体应用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>unicodedata</span> <span class=kn>import</span> <span class=n>normalize</span><span class=p>,</span> <span class=n>name</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>half</span> <span class=o>=</span> <span class=s1>&#39;½&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFKC&#39;</span><span class=p>,</span> <span class=n>half</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;1⁄2&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>four_squared</span> <span class=o>=</span> <span class=s1>&#39;4²&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFKC&#39;</span><span class=p>,</span> <span class=n>four_squared</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;42&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>micro</span> <span class=o>=</span> <span class=s1>&#39;μ&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>micro_kc</span> <span class=o>=</span> <span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFKC&#39;</span><span class=p>,</span> <span class=n>micro</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>micro</span><span class=p>,</span> <span class=n>micro_kc</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;μ&#39;</span><span class=p>,</span> <span class=s1>&#39;μ&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>ord</span><span class=p>(</span><span class=n>micro</span><span class=p>),</span> <span class=nb>ord</span><span class=p>(</span><span class=n>micro_kc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>181</span><span class=p>,</span> <span class=mi>956</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>name</span><span class=p>(</span><span class=n>micro</span><span class=p>),</span> <span class=n>name</span><span class=p>(</span><span class=n>micro_kc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;MICRO SIGN&#39;</span><span class=p>,</span> <span class=s1>&#39;GREEK SMALL LETTER MU&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 <code>'1/2'</code> 替代 <code>'½'</code> 可以接受，微符号也确实是小写的希腊字母 <code>'µ'</code>，但是把 <code>'4²'</code> 转换成 <code>'42'</code> 就改变原意了。某些应用程序可以把 <code>'4²'</code> 保存为 <code>'4&lt;sup>2&lt;/sup>'</code>，但是 <code>normalize</code> 函数对格式一无所知。</p><p>因此，NFKC 或 NFKD 可能会损失或曲解信息，但是可以使用 NFKC 和 NFKD 规范化形式时要小心，而且只能在特殊情况中使用，例如搜索和索引，而不能用于持久存储，因为这两种转换会导致数据损失。：用户搜索 <code>'1 / 2 inch'</code> 时，如果还能找到包含 <code>'½ inch'</code> 的文档，那么用户会感到满意。</p><p>使用 NFKC 和 NFKD 规范化形式时要小心，而且<strong>只能在特殊情况中使用</strong>，例如搜索和索引，而不能用于持久存储，因为这两种转换会导致数据损失。</p><h4 id=大小写折叠>大小写折叠</h4><p>除了组合字符以及兼容字符外，字母的大小写也是一些语言中非常重要的处理对象。对此，显然最常见的方法是<code>str.lower()</code>，此外，还有 <code>str.casefold()</code>，即大小写折叠。</p><p>这两个函数对绝大多数字符来说是等价的，但是对于极少数的特殊字符会得到不同的结果（自 Python3.4 起，有 116 个字符的处理结果不一致）</p><p>这是一个规范化字符串匹配函数的示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>Utility functions for normalized Unicode string comparison.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Using Normal Form C, case sensitive:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; s1 = &#39;café&#39;
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; s2 = &#39;cafe</span><span class=se>\u0301</span><span class=s2>&#39;
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; s1 == s2
</span></span></span><span class=line><span class=cl><span class=s2>    False
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; nfc_equal(s1, s2)
</span></span></span><span class=line><span class=cl><span class=s2>    True
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; nfc_equal(&#39;A&#39;, &#39;a&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>    False
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Using Normal Form C with case folding:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; s3 = &#39;Straße&#39;
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; s4 = &#39;strasse&#39;
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; s3 == s4
</span></span></span><span class=line><span class=cl><span class=s2>    False
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; nfc_equal(s3, s4)
</span></span></span><span class=line><span class=cl><span class=s2>    False
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; fold_equal(s3, s4)
</span></span></span><span class=line><span class=cl><span class=s2>    True
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; fold_equal(s1, s2)
</span></span></span><span class=line><span class=cl><span class=s2>    True
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; fold_equal(&#39;A&#39;, &#39;a&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>    True
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unicodedata</span> <span class=kn>import</span> <span class=n>normalize</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>nfc_equal</span><span class=p>(</span><span class=n>str1</span><span class=p>,</span> <span class=n>str2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFC&#39;</span><span class=p>,</span> <span class=n>str1</span><span class=p>)</span> <span class=o>==</span> <span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFC&#39;</span><span class=p>,</span> <span class=n>str2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fold_equal</span><span class=p>(</span><span class=n>str1</span><span class=p>,</span> <span class=n>str2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFC&#39;</span><span class=p>,</span> <span class=n>str1</span><span class=p>)</span><span class=o>.</span><span class=n>casefold</span><span class=p>()</span> <span class=o>==</span>
</span></span><span class=line><span class=cl>            <span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFC&#39;</span><span class=p>,</span> <span class=n>str2</span><span class=p>)</span><span class=o>.</span><span class=n>casefold</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p>除了 Unicode 规范化和大小写折叠（二者都是 Unicode 标准的一部分）之外，有时需要进行更为深入的转换，例如把 <code>'café'</code> 变成 <code>'cafe'</code>。下一节说明何时以及如何进行这种转换。</p><h4 id=极端规范化去掉变音符号>极端“规范化”：去掉变音符号</h4><p>去掉变音符号不是正确的规范化方式，因为这往往会改变词的意思，而且可能误判搜索结果，但是在搜索领域往往需要这么做。</p><p>除了搜索，去掉变音符号还能让 URL 更易于阅读，至少对拉丁语系语言是如此。下面是维基百科中介绍圣保罗市（São Paulo）的文章的 URL：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http://en.wikipedia.org/wiki/S%C3%A3o_Paulo
</span></span></code></pre></td></tr></table></div></div><p>其中，“%C3%A3” 是 UTF-8 编码 “ã” 字母（带有波形符的 “a”）转义后得到的结果。下述形式更友好，尽管拼写是错误的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http://en.wikipedia.org/wiki/Sao_Paulo
</span></span></code></pre></td></tr></table></div></div><p>这里提供一个去除变音符号的算法。具体而言，首先将所有的组合字符解析为基字符和组合字符（NFD 格式），然后滤除所有的组合字符，最后进行重组即可（NFC 格式）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>unicodedata</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>shave_marks</span><span class=p>(</span><span class=n>txt</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;去掉全部变音符号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>norm_txt</span> <span class=o>=</span> <span class=n>unicodedata</span><span class=o>.</span><span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFD&#39;</span><span class=p>,</span> <span class=n>txt</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=n>shaved</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>c</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>norm_txt</span>
</span></span><span class=line><span class=cl>                     <span class=k>if</span> <span class=ow>not</span> <span class=n>unicodedata</span><span class=o>.</span><span class=n>combining</span><span class=p>(</span><span class=n>c</span><span class=p>))</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>unicodedata</span><span class=o>.</span><span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFC&#39;</span><span class=p>,</span> <span class=n>shaved</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>----------------------------------------------------------------------------</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>order</span> <span class=o>=</span> <span class=s1>&#39;“Herr Voß: • ½ cup of OEtker™ caffè latte • bowl of açaí.”&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>shave_marks</span><span class=p>(</span><span class=n>order</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;“Herr Voß: • ½ cup of OEtker™ caffe latte • bowl of acai.”&#39;</span>  <span class=err>➊</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Greek</span> <span class=o>=</span> <span class=s1>&#39;Zέφupoς, Zéfiro&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>shave_marks</span><span class=p>(</span><span class=n>Greek</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;Ζεφupoς, Zefiro&#39;</span>  <span class=err>➋</span>
</span></span></code></pre></td></tr></table></div></div><p>更进一步地，只把拉丁基字符中所有的变音符号删除</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>shave_marks_latin</span><span class=p>(</span><span class=n>txt</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;把拉丁基字符中所有的变音符号删除&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>norm_txt</span> <span class=o>=</span> <span class=n>unicodedata</span><span class=o>.</span><span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFD&#39;</span><span class=p>,</span> <span class=n>txt</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=n>latin_base</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=n>keepers</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>norm_txt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>unicodedata</span><span class=o>.</span><span class=n>combining</span><span class=p>(</span><span class=n>c</span><span class=p>)</span> <span class=ow>and</span> <span class=n>latin_base</span><span class=p>:</span>  <span class=c1># 基字符为拉丁字母时，跳过组合记号</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>  <span class=c1># 忽略拉丁基字符上的变音符号</span>
</span></span><span class=line><span class=cl>        <span class=n>keepers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>                            
</span></span><span class=line><span class=cl>        <span class=c1># 如果不是组合字符，那就是新的基字符</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>unicodedata</span><span class=o>.</span><span class=n>combining</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>             <span class=c1># 检测新的基字符，判断是不是拉丁字母</span>
</span></span><span class=line><span class=cl>            <span class=n>latin_base</span> <span class=o>=</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>string</span><span class=o>.</span><span class=n>ascii_letters</span>
</span></span><span class=line><span class=cl>    <span class=n>shaved</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>keepers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>unicodedata</span><span class=o>.</span><span class=n>normalize</span><span class=p>(</span><span class=s1>&#39;NFC&#39;</span><span class=p>,</span> <span class=n>shaved</span><span class=p>)</span> 
</span></span></code></pre></td></tr></table></div></div><h2 id=一等函数>一等函数</h2><blockquote><p>不管别人怎么说或怎么想，我从未觉得 Python 受到来自函数式语言的太多影响。我非常熟悉命令式语言，如 C 和 Algol 68，虽然我把函数定为一等对象，但是我并不把 Python 当作函数式编程语言。</p><p>——Guido van Rossum，Python 仁慈的独裁者</p></blockquote><h3 id=把函数作为对象>把函数作为对象</h3><p>在 Python 中，函数是一等对象。编程语言理论家把“一等对象”定义为满足下述条件的程序实体：</p><ul><li>在运行时创建</li><li>能赋值给变量或数据结构中的元素</li><li>能作为参数传给函数</li><li>能作为函数的返回结果</li></ul><p>在 Python 中，整数、字符串和字典都是一等对象——没什么特别的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>factorial</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>  
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=s1>&#39;&#39;&#39;returns n!&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>n</span> <span class=o>&lt;</span> <span class=mi>2</span> <span class=k>else</span> <span class=n>n</span> <span class=o>*</span> <span class=n>factorial</span><span class=p>(</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>factorial</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>1405006117752879898543142606244511569936384000000000</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>factorial</span><span class=o>.</span><span class=vm>__doc__</span>  <span class=c1># 这个 factorial 是 function 类的实例</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;returns n!&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>type</span><span class=p>(</span><span class=n>factorial</span><span class=p>)</span>  <span class=err>➌</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=k>class</span> <span class=err>&#39;</span><span class=nc>function</span><span class=s1>&#39;&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=高阶函数>高阶函数</h3><p>接受函数为参数，或者把函数作为结果返回的函数是<strong>高阶函数</strong>（higher-order function）</p><p>在函数式编程范式中，最为人熟知的高阶函数有 <code>map</code>、<code>filter</code>、<code>reduce</code></p><h4 id=mapfilter-和-reduce-的现代替代品><code>map</code>、<code>filter</code> 和 <code>reduce</code> 的现代替代品</h4><p>列表推导或生成器表达式具有 <code>map</code> 和 <code>filter</code> 两个函数的功能，而且更易于阅读</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=n>fact</span><span class=p>,</span> <span class=nb>range</span><span class=p>(</span><span class=mi>6</span><span class=p>)))</span>  <span class=err>➊</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>24</span><span class=p>,</span> <span class=mi>120</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=p>[</span><span class=n>fact</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>6</span><span class=p>)]</span>  <span class=err>➋</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>24</span><span class=p>,</span> <span class=mi>120</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=n>factorial</span><span class=p>,</span> <span class=nb>filter</span><span class=p>(</span><span class=k>lambda</span> <span class=n>n</span><span class=p>:</span> <span class=n>n</span> <span class=o>%</span> <span class=mi>2</span><span class=p>,</span> <span class=nb>range</span><span class=p>(</span><span class=mi>6</span><span class=p>))))</span>  <span class=err>➌</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>120</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=p>[</span><span class=n>factorial</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span> <span class=k>if</span> <span class=n>n</span> <span class=o>%</span> <span class=mi>2</span><span class=p>]</span>  <span class=err>➍</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>120</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=匿名函数>匿名函数</h3><p>为了使用高阶函数，有时创建一次性的小型函数会更便利，这便是匿名函数存在的原因。</p><p><code>lambda</code> 关键字在 Python 表达式内创建匿名函数。</p><p>然而，Python 简单的句法限制了 <code>lambda</code> 函数的定义体只能使用纯表达式。换句话说，<code>lambda</code> 函数的定义体中不能赋值，也不能使用 <code>while</code> 和 <code>try</code> 等 Python 语句。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>fruits</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;strawberry&#39;</span><span class=p>,</span> <span class=s1>&#39;fig&#39;</span><span class=p>,</span> <span class=s1>&#39;apple&#39;</span><span class=p>,</span> <span class=s1>&#39;cherry&#39;</span><span class=p>,</span> <span class=s1>&#39;raspberry&#39;</span><span class=p>,</span> <span class=s1>&#39;banana&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>fruits</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>word</span><span class=p>:</span> <span class=n>word</span><span class=p>[::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;banana&#39;</span><span class=p>,</span> <span class=s1>&#39;apple&#39;</span><span class=p>,</span> <span class=s1>&#39;fig&#39;</span><span class=p>,</span> <span class=s1>&#39;raspberry&#39;</span><span class=p>,</span> <span class=s1>&#39;strawberry&#39;</span><span class=p>,</span> <span class=s1>&#39;cherry&#39;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>除了作为参数传给高阶函数之外，Python 很少使用匿名函数。由于句法上的限制，非平凡的 <code>lambda</code> 表达式要么难以阅读，要么无法写出。</p><h3 id=可调用对象>可调用对象</h3><p>除了用户定义的函数，调用运算符（即 <code>()</code>）还可以应用到其他对象上。如果想判断对象能否调用，可以使用内置的 <code>callable()</code> 函数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>abs</span><span class=p>,</span> <span class=nb>str</span><span class=p>,</span> <span class=mi>13</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>&lt;</span><span class=n>built</span><span class=o>-</span><span class=ow>in</span> <span class=n>function</span> <span class=nb>abs</span><span class=o>&gt;</span><span class=p>,</span> <span class=o>&lt;</span><span class=k>class</span> <span class=err>&#39;</span><span class=nc>str</span><span class=s1>&#39;&gt;, 13)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=p>[</span><span class=n>callable</span><span class=p>(</span><span class=n>obj</span><span class=p>)</span> <span class=k>for</span> <span class=n>obj</span> <span class=ow>in</span> <span class=p>(</span><span class=nb>abs</span><span class=p>,</span> <span class=nb>str</span><span class=p>,</span> <span class=mi>13</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=kc>True</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>Python 数据模型文档列出了 7 种可调用对象。</p><ol><li>自定义的函数</li><li>内置函数<ul><li>使用 C 语言（CPython）实现的函数，如 <code>len</code> 或 <code>time.strftime</code></li></ul></li><li>内置方法<ul><li>使用 C 语言实现的方法，如 <code>dict.get</code></li></ul></li><li>方法</li><li>类（创建实例时）<ul><li>调用类时会运行类的 <code>__new__</code> 方法创建一个实例，然后运行 <code>__init__</code> 方法，初始化实例，最后把实例返回给调用方。因为 Python 没有 <code>new</code> 运算符，所以调用类相当于调用函数。</li></ul></li><li>类的实例（要求实现 <code>__call__</code> 方法）</li><li>生成器函数（yield）</li></ol><h4 id=__call__><code>__call__</code></h4><p>下面的示例实现了 <code>BingoCage</code> 类。这个类的实例使用任何可迭代对象构建，而且会在内部存储一个随机顺序排列的列表。调用实例会取出一个元素。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BingoCage</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>items</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    	<span class=bp>self</span><span class=o>.</span><span class=n>_items</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>items</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    	<span class=n>random</span><span class=o>.</span><span class=n>shuffle</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_items</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>def</span> <span class=nf>pick</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>    	<span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        	<span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_items</span><span class=o>.</span><span class=n>pop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    	<span class=k>except</span> <span class=ne>IndexError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        	<span class=k>raise</span> <span class=ne>LookupError</span><span class=p>(</span><span class=s1>&#39;pick from empty BingoCage&#39;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>  <span class=c1># bingo.pick() 的快捷方式是 bingo()</span>
</span></span><span class=line><span class=cl>    	<span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>pick</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bingo</span> <span class=o>=</span> <span class=n>BingoCage</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bingo</span><span class=o>.</span><span class=n>pick</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bingo</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>callable</span><span class=p>(</span><span class=n>bingo</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><p>实现 <code>__call__</code> 方法的类是创建函数类对象的简便方式，此时必须在内部维护一个状态，让它在调用之间可用，例如 <code>BingoCage</code> 中的剩余元素。装饰器就是这样。装饰器必须是函数，而且有时要在多次调用之间“记住”某些事 （例如备忘（memoization），即缓存消耗大的计算结果，供后面使用）。</p><h4 id=另一种对-__call__-的解释>另一种对 <code>__call__</code> 的解释</h4><p>该方法的功能类似于在类中重载 <code>()</code> 运算符，使得类实例对象可以像调用普通函数那样，以 <code>对象名()</code> 的形式使用。</p><h3 id=函数内省>函数内省</h3><p>同样的，Python 的函数也可以被视为对象。 函数有很多属性，这一特点使得函数表现得像一个对象。通过函数内省 <code>dir()</code> 能够得到这些属性的列表。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>dir</span><span class=p>(</span><span class=n>factorial</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;__annotations__&#39;</span><span class=p>,</span> <span class=s1>&#39;__call__&#39;</span><span class=p>,</span> <span class=s1>&#39;__class__&#39;</span><span class=p>,</span> <span class=s1>&#39;__closure__&#39;</span><span class=p>,</span> <span class=s1>&#39;__code__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;__defaults__&#39;</span><span class=p>,</span> <span class=s1>&#39;__delattr__&#39;</span><span class=p>,</span> <span class=s1>&#39;__dict__&#39;</span><span class=p>,</span> <span class=s1>&#39;__dir__&#39;</span><span class=p>,</span> <span class=s1>&#39;__doc__&#39;</span><span class=p>,</span> <span class=s1>&#39;__eq__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;__format__&#39;</span><span class=p>,</span> <span class=s1>&#39;__ge__&#39;</span><span class=p>,</span> <span class=s1>&#39;__get__&#39;</span><span class=p>,</span> <span class=s1>&#39;__getattribute__&#39;</span><span class=p>,</span> <span class=s1>&#39;__globals__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;__gt__&#39;</span><span class=p>,</span> <span class=s1>&#39;__hash__&#39;</span><span class=p>,</span> <span class=s1>&#39;__init__&#39;</span><span class=p>,</span> <span class=s1>&#39;__kwdefaults__&#39;</span><span class=p>,</span> <span class=s1>&#39;__le__&#39;</span><span class=p>,</span> <span class=s1>&#39;__lt__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;__module__&#39;</span><span class=p>,</span> <span class=s1>&#39;__name__&#39;</span><span class=p>,</span> <span class=s1>&#39;__ne__&#39;</span><span class=p>,</span> <span class=s1>&#39;__new__&#39;</span><span class=p>,</span> <span class=s1>&#39;__qualname__&#39;</span><span class=p>,</span> <span class=s1>&#39;__reduce__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;__reduce_ex__&#39;</span><span class=p>,</span> <span class=s1>&#39;__repr__&#39;</span><span class=p>,</span> <span class=s1>&#39;__setattr__&#39;</span><span class=p>,</span> <span class=s1>&#39;__sizeof__&#39;</span><span class=p>,</span> <span class=s1>&#39;__str__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;__subclasshook__&#39;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>其中大多数属性是 Python 对象共有的</p><p>下面的示例列出了<strong>常规对象没有而函数有的属性</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>class</span> <span class=nc>C</span><span class=p>:</span> <span class=k>pass</span>  <span class=c1># ➊</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>obj</span> <span class=o>=</span> <span class=n>C</span><span class=p>()</span>  <span class=c1># ➋</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>func</span><span class=p>():</span> <span class=k>pass</span>  <span class=c1># ➌</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>sorted</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=nb>dir</span><span class=p>(</span><span class=n>func</span><span class=p>))</span> <span class=o>-</span> <span class=nb>set</span><span class=p>(</span><span class=nb>dir</span><span class=p>(</span><span class=n>obj</span><span class=p>)))</span> <span class=c1># ➍</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;__annotations__&#39;</span><span class=p>,</span> <span class=s1>&#39;__call__&#39;</span><span class=p>,</span> <span class=s1>&#39;__closure__&#39;</span><span class=p>,</span> <span class=s1>&#39;__code__&#39;</span><span class=p>,</span> <span class=s1>&#39;__defaults__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;__get__&#39;</span><span class=p>,</span> <span class=s1>&#39;__globals__&#39;</span><span class=p>,</span> <span class=s1>&#39;__kwdefaults__&#39;</span><span class=p>,</span> <span class=s1>&#39;__name__&#39;</span><span class=p>,</span> <span class=s1>&#39;__qualname__&#39;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><table><thead><tr><th style=text-align:center>名称</th><th style=text-align:center>类型</th><th style=text-align:center>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>__annotations__</code></td><td style=text-align:center><code>dict</code></td><td style=text-align:center>参数和返回值的注解</td></tr><tr><td style=text-align:center><code>__call__</code></td><td style=text-align:center><code>method-wrapper</code></td><td style=text-align:center>实现 <code>()</code> 运算符；即可调用对象协议</td></tr><tr><td style=text-align:center><code>__closure__</code></td><td style=text-align:center><code>tuple</code></td><td style=text-align:center>函数闭包，即自由变量的绑定（通常是 <code>None</code>）</td></tr><tr><td style=text-align:center><code>__code__</code></td><td style=text-align:center><code>code</code></td><td style=text-align:center>编译成字节码的函数元数据和函数定义体</td></tr><tr><td style=text-align:center><code>__defaults__</code></td><td style=text-align:center><code>tuple</code></td><td style=text-align:center>形式参数的默认值</td></tr><tr><td style=text-align:center><code>__get__</code></td><td style=text-align:center><code>method-wrapper</code></td><td style=text-align:center>实现只读描述符协议（参见第 20 章）</td></tr><tr><td style=text-align:center><code>__globals__</code></td><td style=text-align:center><code>dict</code></td><td style=text-align:center>函数所在模块中的全局变量</td></tr><tr><td style=text-align:center><code>__kwdefaults__</code></td><td style=text-align:center><code>dict</code></td><td style=text-align:center>仅限关键字形式参数的默认值</td></tr><tr><td style=text-align:center><code>__name__</code></td><td style=text-align:center><code>str</code></td><td style=text-align:center>函数名称</td></tr><tr><td style=text-align:center><code>__qualname__</code></td><td style=text-align:center><code>str</code></td><td style=text-align:center>函数的限定名称，如 <code>Random.choice</code></td></tr></tbody></table><h3 id=定位参数与仅限关键字参数>定位参数与仅限关键字参数</h3><p>两类实参：</p><ul><li>位置参数 (positional)：传参时前面不带 &ldquo;变量名 ="，顺序不可变，按顺序赋给相应的局部变量.</li><li>关键字参数 (keyword)：传参时前面加上 &ldquo;变量名="，顺序可变，按名称赋给同名的局部变量.</li></ul><p>Python 最好的特性之一是提供了极为灵活的参数处理机制</p><p><strong>仅限关键字参数</strong> (keyword-only) 是 Python 3 新增的特性，它是在 <code>*</code> 后面定义的参数（或在 <code>*args</code> 后面定义），传参时必需带变量名</p><p>下面示例中的 <code>tag</code> 函数用于生成 HTML 标签；使用名为 <code>cls</code> 的关键字参数传入 “class” 属性，这是一种变通方法，因为 “class” 是 Python 的关键字</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>tag</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=o>*</span><span class=n>content</span><span class=p>,</span> <span class=bp>cls</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=o>**</span><span class=n>attrs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生成一个或多个HTML标签&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=bp>cls</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>attrs</span><span class=p>[</span><span class=s1>&#39;class&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>cls</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>attrs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>attr_str</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39; </span><span class=si>%s</span><span class=s1>=&#34;</span><span class=si>%s</span><span class=s1>&#34;&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>attr</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                           <span class=k>for</span> <span class=n>attr</span><span class=p>,</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>                           <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>attrs</span><span class=o>.</span><span class=n>items</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>attr_str</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;&lt;</span><span class=si>%s%s</span><span class=s1>&gt;</span><span class=si>%s</span><span class=s1>&lt;/</span><span class=si>%s</span><span class=s1>&gt;&#39;</span> <span class=o>%</span>
</span></span><span class=line><span class=cl>                         <span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>attr_str</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>name</span><span class=p>)</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;&lt;</span><span class=si>%s%s</span><span class=s1> /&gt;&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>attr_str</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>tag</span><span class=p>(</span><span class=s1>&#39;br&#39;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=s1>&#39;&lt;br /&gt;&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>tag</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>,</span> <span class=s1>&#39;hello&#39;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=s1>&#39;&lt;p&gt;hello&lt;/p&gt;&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=n>tag</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>,</span> <span class=s1>&#39;hello&#39;</span><span class=p>,</span> <span class=s1>&#39;world&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>p</span><span class=o>&gt;</span><span class=n>hello</span><span class=o>&lt;/</span><span class=n>p</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>p</span><span class=o>&gt;</span><span class=n>world</span><span class=o>&lt;/</span><span class=n>p</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>tag</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>,</span> <span class=s1>&#39;hello&#39;</span><span class=p>,</span> <span class=nb>id</span><span class=o>=</span><span class=mi>33</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=s1>&#39;&lt;p id=&#34;33&#34;&gt;hello&lt;/p&gt;&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=n>tag</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>,</span> <span class=s1>&#39;hello&#39;</span><span class=p>,</span> <span class=s1>&#39;world&#39;</span><span class=p>,</span> <span class=bp>cls</span><span class=o>=</span><span class=s1>&#39;sidebar&#39;</span><span class=p>))</span>  
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>p</span> <span class=n>class</span><span class=o>=</span><span class=s2>&#34;sidebar&#34;</span><span class=o>&gt;</span><span class=n>hello</span><span class=o>&lt;/</span><span class=n>p</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>p</span> <span class=n>class</span><span class=o>=</span><span class=s2>&#34;sidebar&#34;</span><span class=o>&gt;</span><span class=n>world</span><span class=o>&lt;/</span><span class=n>p</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>tag</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s1>&#39;testing&#39;</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&#34;img&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=s1>&#39;&lt;img content=&#34;testing&#34; /&gt;&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>my_tag</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;img&#39;</span><span class=p>,</span> <span class=s1>&#39;title&#39;</span><span class=p>:</span> <span class=s1>&#39;Sunset Boulevard&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=o>...</span>           <span class=s1>&#39;src&#39;</span><span class=p>:</span> <span class=s1>&#39;sunset.jpg&#39;</span><span class=p>,</span> <span class=s1>&#39;cls&#39;</span><span class=p>:</span> <span class=s1>&#39;framed&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>tag</span><span class=p>(</span><span class=o>**</span><span class=n>my_tag</span><span class=p>)</span>  <span class=err>➏</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;&lt;img class=&#34;framed&#34; src=&#34;sunset.jpg&#34; title=&#34;Sunset Boulevard&#34; /&gt;&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>在上面的示例中，<code>cls</code> 参数只能通过关键字参数指定，它一定不会捕获未命名的定位参数。</p><p>定义函数时若想指定仅限关键字参数，要把它们放到前面有 <code>*</code> 的参数后面。如果不想支持数量不定的定位参数，但是想支持仅限关键字参数，在签名中放一个 <code>*</code>，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>f</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=o>*</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>f</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>b</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=获取关于参数的信息>获取关于参数的信息</h3><h4 id=使用内置方法>使用内置方法</h4><p>Python 的函数有大量可用于获取函数参数信息的内置方法:</p><ul><li><code>.__defaults__</code>: 获取参数的默认值</li><li><code>.__code__.co_varnames</code>: 参数名称，包括函数中创建的临时变量</li><li><code>.__code__.co_argcount</code>: 参数总数</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>clip</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>max_len</span><span class=o>=</span><span class=mi>80</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;在max_len前面或后面的第一个空格处截断文本&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>end</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>text</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>max_len</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>space_before</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>rfind</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>max_len</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>space_before</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>end</span> <span class=o>=</span> <span class=n>space_before</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>space_after</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>rfind</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>,</span> <span class=n>max_len</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>space_after</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>end</span> <span class=o>=</span> <span class=n>space_after</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>end</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>  <span class=c1># 没找到空格</span>
</span></span><span class=line><span class=cl>        <span class=n>end</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>text</span><span class=p>[:</span><span class=n>end</span><span class=p>]</span><span class=o>.</span><span class=n>rstrip</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>clip</span> <span class=kn>import</span> <span class=n>clip</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>clip</span><span class=o>.</span><span class=vm>__defaults__</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>80</span><span class=p>,)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>clip</span><span class=o>.</span><span class=vm>__code__</span>  <span class=c1># doctest: +ELLIPSIS</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>code</span> <span class=nb>object</span> <span class=n>clip</span> <span class=n>at</span> <span class=mi>0</span><span class=n>x</span><span class=o>...&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>clip</span><span class=o>.</span><span class=vm>__code__</span><span class=o>.</span><span class=n>co_varnames</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;text&#39;</span><span class=p>,</span> <span class=s1>&#39;max_len&#39;</span><span class=p>,</span> <span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=s1>&#39;space_before&#39;</span><span class=p>,</span> <span class=s1>&#39;space_after&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>clip</span><span class=o>.</span><span class=vm>__code__</span><span class=o>.</span><span class=n>co_argcount</span>
</span></span><span class=line><span class=cl><span class=mi>2</span>
</span></span></code></pre></td></tr></table></div></div><p>上述方法能够获取函数参数信息，但是不易处理和后续分析</p><ul><li>参数名称在 <code>__code__.co_varnames</code> 中，不过里面还有函数定义体中创建的局部变量。</li><li>因此，参数名称是前 <em>N</em> 个字符串，<em>N</em> 的值由 <code>__code__.co_argcount</code> 确定。<ul><li>顺便说一下，这里不包含前缀为 <code>*</code> 或 <code>**</code> 的变长参数。</li></ul></li><li>参数的默认值只能通过它们在 <code>__defaults__</code> 元组中的位置确定，因此要从后向前扫描才能把参数和默认值对应起来。<ul><li>在这个示例中 <code>clip</code> 函数有两个参数，<code>text</code> 和 <code>max_len</code>，其中一个有默认值，即 <code>80</code>，因此它必然属于最后一个参数，即 <code>max_len</code>。这有违常理。</li></ul></li></ul><p>inspect 模块则提供了快速分析函数参数的功能</p><h4 id=使用-inspect>使用 inspect</h4><p><code>inspect.signature</code> 函数返回一个 <code>inspect.Signature</code> 对象，它有一个 <code>parameters</code> 属性，这是一个有序映射，把参数名和 <code>inspect.Parameter</code> 对象对应起来。各个 <code>Parameter</code> 属性也有自己的属性，例如 <code>name</code>、<code>default</code> 和 <code>kind</code>。特殊的 <code>inspect._empty</code> 值表示没有默认值，考虑到 <code>None</code> 是有效的默认值（也经常这么做），而且这么做是合理的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>clip</span> <span class=kn>import</span> <span class=n>clip</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>inspect</span> <span class=kn>import</span> <span class=n>signature</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>sig</span> <span class=o>=</span> <span class=n>signature</span><span class=p>(</span><span class=n>clip</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>sig</span>  <span class=c1># doctest: +ELLIPSIS</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>inspect</span><span class=o>.</span><span class=n>Signature</span> <span class=nb>object</span> <span class=n>at</span> <span class=mi>0</span><span class=n>x</span><span class=o>...&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>str</span><span class=p>(</span><span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;(text, max_len=80)&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>param</span> <span class=ow>in</span> <span class=n>sig</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=n>param</span><span class=o>.</span><span class=n>kind</span><span class=p>,</span> <span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=s1>&#39;=&#39;</span><span class=p>,</span> <span class=n>param</span><span class=o>.</span><span class=n>default</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>POSITIONAL_OR_KEYWORD</span> <span class=p>:</span> <span class=n>text</span> <span class=o>=</span> <span class=o>&lt;</span><span class=k>class</span> <span class=err>&#39;</span><span class=nc>inspect</span><span class=o>.</span><span class=n>_empty</span><span class=s1>&#39;&gt;</span>
</span></span><span class=line><span class=cl><span class=n>POSITIONAL_OR_KEYWORD</span> <span class=p>:</span> <span class=n>max_len</span> <span class=o>=</span> <span class=mi>80</span>
</span></span></code></pre></td></tr></table></div></div><p><code>kind</code> 属性的值是 <code>_ParameterKind</code> 类中的 5 个值之一，列举如下。</p><ul><li><p>POSITIONAL_OR_KEYWORD</p><ul><li>可以通过定位参数和关键字参数传入的形参（多数 Python 函数的参数属于此类）。</li></ul></li><li><p>VAR_POSITIONAL</p><ul><li>定位参数元组。</li></ul></li><li><p>VAR_KEYWORD</p><ul><li>关键字参数字典。</li></ul></li><li><p>KEYWORD_ONLY</p><ul><li>仅限关键字参数（Python 3 新增）。</li></ul></li><li><p>POSITIONAL_ONLY</p><ul><li>仅限定位参数；目前，Python 声明函数的句法不支持，但是有些使用 C 语言实现且不接受关键字参数的函数（如 <code>divmod</code>）支持。</li></ul></li></ul><p><code>inspect.Signature</code> 对象有个 <code>bind</code> 方法，它可以把任意个参数绑定到签名中的形参上，所用的规则与实参到形参的匹配方式一样。框架可以使用这个方法在真正调用函数前验证参数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>inspect</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>sig</span> <span class=o>=</span> <span class=n>inspect</span><span class=o>.</span><span class=n>signature</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>my_tag</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;img&#39;</span><span class=p>,</span> <span class=s1>&#39;title&#39;</span><span class=p>:</span> <span class=s1>&#39;Sunset Boulevard&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=o>...</span>           <span class=s1>&#39;src&#39;</span><span class=p>:</span> <span class=s1>&#39;sunset.jpg&#39;</span><span class=p>,</span> <span class=s1>&#39;cls&#39;</span><span class=p>:</span> <span class=s1>&#39;framed&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bound_args</span> <span class=o>=</span> <span class=n>sig</span><span class=o>.</span><span class=n>bind</span><span class=p>(</span><span class=o>**</span><span class=n>my_tag</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bound_args</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>inspect</span><span class=o>.</span><span class=n>BoundArguments</span> <span class=nb>object</span> <span class=n>at</span> <span class=mi>0</span><span class=n>x</span><span class=o>...&gt;</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>bound_args</span><span class=o>.</span><span class=n>arguments</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>  
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=s1>&#39;=&#39;</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>name</span> <span class=o>=</span> <span class=n>img</span>
</span></span><span class=line><span class=cl><span class=bp>cls</span> <span class=o>=</span> <span class=n>framed</span>
</span></span><span class=line><span class=cl><span class=n>attrs</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;title&#39;</span><span class=p>:</span> <span class=s1>&#39;Sunset Boulevard&#39;</span><span class=p>,</span> <span class=s1>&#39;src&#39;</span><span class=p>:</span> <span class=s1>&#39;sunset.jpg&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>del</span> <span class=n>my_tag</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bound_args</span> <span class=o>=</span> <span class=n>sig</span><span class=o>.</span><span class=n>bind</span><span class=p>(</span><span class=o>**</span><span class=n>my_tag</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>TypeError</span><span class=p>:</span> <span class=s1>&#39;name&#39;</span> <span class=n>parameter</span> <span class=n>lacking</span> <span class=n>default</span> <span class=n>value</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=函数注解>函数注解</h3><p>Python 允许对函数的形参以及函数本身进行注释。例如标注某一参数的类型为 &ldquo;int&rdquo; 或者 &ldquo;str&rdquo;。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>func</span><span class=p>(</span><span class=n>text</span><span class=p>:</span><span class=nb>str</span><span class=p>,</span> <span class=n>max_len</span><span class=p>:</span><span class=s1>&#39;int &gt; 0&#39;</span><span class=o>=</span><span class=mi>80</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span></code></pre></td></tr></table></div></div><p>注解中最常用的类型是类（如 <code>str</code> 或 <code>int</code>）和字符串（如 <code>'int > 0'</code>）。在上面的示例中，<code>max_len</code> 参数的注解用的是字符串。</p><p>Python 不会对这些注释进行任何处理，<strong>不会根据注释对参数进行检查、强制处理或者验证</strong>，仅是存储到 <code>__annotations__</code> 属性中，以供 IDE（例如为 IDE 的静态类型检查功能提供信息）、框架和装饰器使用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>clip_annot</span> <span class=kn>import</span> <span class=n>clip</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>clip</span><span class=o>.</span><span class=vm>__annotations__</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s1>&#39;text&#39;</span><span class=p>:</span> <span class=o>&lt;</span><span class=k>class</span> <span class=err>&#39;</span><span class=nc>str</span><span class=s1>&#39;&gt;, &#39;</span><span class=n>max_len</span><span class=s1>&#39;: &#39;</span><span class=nb>int</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=s1>&#39;, &#39;</span><span class=k>return</span><span class=s1>&#39;: &lt;class &#39;</span><span class=nb>str</span><span class=s1>&#39;&gt;}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=支持函数式编程的包>支持函数式编程的包</h3><p>虽然 Guido 明确表明，Python 的目标不是变成函数式编程语言，但是得益于 <code>operator</code> 和 <code>functools</code> 等包的支持，函数式编程风格也可以信手拈来</p><h4 id=operator-模块>operator 模块</h4><p>在函数式编程中，经常需要把算术运算符当作函数使用。例如，不使用递归计算阶乘。求和可以使用 <code>sum</code> 函数，但是求积则没有这样的函数。我们可以使用 <code>reduce</code> 函数，但是需要一个函数计算序列中两个元素之积：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># 使用 reduce 函数和一个匿名函数计算阶乘</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>reduce</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fact</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>reduce</span><span class=p>(</span><span class=k>lambda</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=n>a</span><span class=o>*</span><span class=n>b</span><span class=p>,</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>n</span><span class=o>+</span><span class=mi>1</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p><code>operator</code> 模块为多个算术运算符提供了对应的函数，从而避免编写 <code>lambda a, b: a*b</code> 这种平凡的匿名函数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>reduce</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>operator</span> <span class=kn>import</span> <span class=n>mul</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fact</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>reduce</span><span class=p>(</span><span class=n>mul</span><span class=p>,</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>n</span><span class=o>+</span><span class=mi>1</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p><code>operator</code> 模块中还有一类函数，能替代从序列中取出元素或读取对象属性的 <code>lambda</code> 表达式：因此，<code>itemgetter</code> 和 <code>attrgetter</code> 其实会自行构建函数。</p><h5 id=itemgetter>itemgetter</h5><p><code>itemgetter</code> 的常见用途：根据元组的某个字段给元组列表排序。</p><p>下面的示例使用了 <code>itemgetter</code> 排序一个元组列表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>metro_data</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=p>(</span><span class=s1>&#39;Tokyo&#39;</span><span class=p>,</span> <span class=s1>&#39;JP&#39;</span><span class=p>,</span> <span class=mf>36.933</span><span class=p>,</span> <span class=p>(</span><span class=mf>35.689722</span><span class=p>,</span> <span class=mf>139.691667</span><span class=p>)),</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=p>(</span><span class=s1>&#39;Delhi NCR&#39;</span><span class=p>,</span> <span class=s1>&#39;IN&#39;</span><span class=p>,</span> <span class=mf>21.935</span><span class=p>,</span> <span class=p>(</span><span class=mf>28.613889</span><span class=p>,</span> <span class=mf>77.208889</span><span class=p>)),</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=p>(</span><span class=s1>&#39;Mexico City&#39;</span><span class=p>,</span> <span class=s1>&#39;MX&#39;</span><span class=p>,</span> <span class=mf>20.142</span><span class=p>,</span> <span class=p>(</span><span class=mf>19.433333</span><span class=p>,</span> <span class=o>-</span><span class=mf>99.133333</span><span class=p>)),</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=p>(</span><span class=s1>&#39;New York-Newark&#39;</span><span class=p>,</span> <span class=s1>&#39;US&#39;</span><span class=p>,</span> <span class=mf>20.104</span><span class=p>,</span> <span class=p>(</span><span class=mf>40.808611</span><span class=p>,</span> <span class=o>-</span><span class=mf>74.020386</span><span class=p>)),</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=p>(</span><span class=s1>&#39;Sao Paulo&#39;</span><span class=p>,</span> <span class=s1>&#39;BR&#39;</span><span class=p>,</span> <span class=mf>19.649</span><span class=p>,</span> <span class=p>(</span><span class=o>-</span><span class=mf>23.547778</span><span class=p>,</span> <span class=o>-</span><span class=mf>46.635833</span><span class=p>)),</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>operator</span> <span class=kn>import</span> <span class=n>itemgetter</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>for</span> <span class=n>city</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>metro_data</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=n>itemgetter</span><span class=p>(</span><span class=mi>1</span><span class=p>)):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=n>city</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;Sao Paulo&#39;</span><span class=p>,</span> <span class=s1>&#39;BR&#39;</span><span class=p>,</span> <span class=mf>19.649</span><span class=p>,</span> <span class=p>(</span><span class=o>-</span><span class=mf>23.547778</span><span class=p>,</span> <span class=o>-</span><span class=mf>46.635833</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;Delhi NCR&#39;</span><span class=p>,</span> <span class=s1>&#39;IN&#39;</span><span class=p>,</span> <span class=mf>21.935</span><span class=p>,</span> <span class=p>(</span><span class=mf>28.613889</span><span class=p>,</span> <span class=mf>77.208889</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;Tokyo&#39;</span><span class=p>,</span> <span class=s1>&#39;JP&#39;</span><span class=p>,</span> <span class=mf>36.933</span><span class=p>,</span> <span class=p>(</span><span class=mf>35.689722</span><span class=p>,</span> <span class=mf>139.691667</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;Mexico City&#39;</span><span class=p>,</span> <span class=s1>&#39;MX&#39;</span><span class=p>,</span> <span class=mf>20.142</span><span class=p>,</span> <span class=p>(</span><span class=mf>19.433333</span><span class=p>,</span> <span class=o>-</span><span class=mf>99.133333</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;New York-Newark&#39;</span><span class=p>,</span> <span class=s1>&#39;US&#39;</span><span class=p>,</span> <span class=mf>20.104</span><span class=p>,</span> <span class=p>(</span><span class=mf>40.808611</span><span class=p>,</span> <span class=o>-</span><span class=mf>74.020386</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>如果把多个参数传给 <code>itemgetter</code>，它构建的函数会返回提取的值构成的元组：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>cc_name</span> <span class=o>=</span> <span class=n>itemgetter</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>for</span> <span class=n>city</span> <span class=ow>in</span> <span class=n>metro_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=n>cc_name</span><span class=p>(</span><span class=n>city</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;JP&#39;</span><span class=p>,</span> <span class=s1>&#39;Tokyo&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;IN&#39;</span><span class=p>,</span> <span class=s1>&#39;Delhi NCR&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;MX&#39;</span><span class=p>,</span> <span class=s1>&#39;Mexico City&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;US&#39;</span><span class=p>,</span> <span class=s1>&#39;New York-Newark&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;BR&#39;</span><span class=p>,</span> <span class=s1>&#39;Sao Paulo&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p><code>itemgetter</code> 使用 <code>[]</code> 运算符，因此它不仅支持序列，还支持映射和任何实现 <code>__getitem__</code> 方法的类</p></blockquote><h5 id=attrgetter>attrgetter</h5><p><code>attrgetter</code> 与 <code>itemgetter</code> 作用类似，它创建的函数根据名称提取对象的属性。如果把多个属性名传给 <code>attrgetter</code>，它也会返回提取的值构成的元组。此外，如果参数名中包含 <code>.</code>（点号），<code>attrgetter</code> 会深入嵌套对象，获取指定的属性。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># 定义一个 namedtuple，名为 metro_data，演示使用 attrgetter 处理它</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>namedtuple</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>LatLong</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;LatLong&#39;</span><span class=p>,</span> <span class=s1>&#39;lat long&#39;</span><span class=p>)</span>  <span class=c1># ➊</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Metropolis</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;Metropolis&#39;</span><span class=p>,</span> <span class=s1>&#39;name cc pop coord&#39;</span><span class=p>)</span>  <span class=c1># ➋</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>metro_areas</span> <span class=o>=</span> <span class=p>[</span><span class=n>Metropolis</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>cc</span><span class=p>,</span> <span class=n>pop</span><span class=p>,</span> <span class=n>LatLong</span><span class=p>(</span><span class=n>lat</span><span class=p>,</span> <span class=n>long</span><span class=p>))</span>  <span class=c1># ➌</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>cc</span><span class=p>,</span> <span class=n>pop</span><span class=p>,</span> <span class=p>(</span><span class=n>lat</span><span class=p>,</span> <span class=n>long</span><span class=p>)</span> <span class=ow>in</span> <span class=n>metro_data</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>metro_areas</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>Metropolis</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;Tokyo&#39;</span><span class=p>,</span> <span class=n>cc</span><span class=o>=</span><span class=s1>&#39;JP&#39;</span><span class=p>,</span> <span class=n>pop</span><span class=o>=</span><span class=mf>36.933</span><span class=p>,</span> <span class=n>coord</span><span class=o>=</span><span class=n>LatLong</span><span class=p>(</span><span class=n>lat</span><span class=o>=</span><span class=mf>35.689722</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>long</span><span class=o>=</span><span class=mf>139.691667</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>metro_areas</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>coord</span><span class=o>.</span><span class=n>lat</span>  <span class=c1># ➍</span>
</span></span><span class=line><span class=cl><span class=mf>35.689722</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>operator</span> <span class=kn>import</span> <span class=n>attrgetter</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>name_lat</span> <span class=o>=</span> <span class=n>attrgetter</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=s1>&#39;coord.lat&#39;</span><span class=p>)</span>  <span class=c1># ➎</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>for</span> <span class=n>city</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>metro_areas</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=n>attrgetter</span><span class=p>(</span><span class=s1>&#39;coord.lat&#39;</span><span class=p>)):</span>  <span class=c1># ➏</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=n>name_lat</span><span class=p>(</span><span class=n>city</span><span class=p>))</span>  <span class=c1># ➐</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;Sao Paulo&#39;</span><span class=p>,</span> <span class=o>-</span><span class=mf>23.547778</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;Mexico City&#39;</span><span class=p>,</span> <span class=mf>19.433333</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;Delhi NCR&#39;</span><span class=p>,</span> <span class=mf>28.613889</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;Tokyo&#39;</span><span class=p>,</span> <span class=mf>35.689722</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;New York-Newark&#39;</span><span class=p>,</span> <span class=mf>40.808611</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=methodcaller>methodcaller</h5><p><code>methodcaller</code> 的作用与 <code>attrgetter</code> 和 <code>itemgetter</code> 类似，它会自行创建函数</p><p><strong><code>methodcaller</code> 创建的函数会在对象上调用参数指定的方法</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>operator</span> <span class=kn>import</span> <span class=n>methodcaller</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s</span> <span class=o>=</span> <span class=s1>&#39;The time has come&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>upcase</span> <span class=o>=</span> <span class=n>methodcaller</span><span class=p>(</span><span class=s1>&#39;upper&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>upcase</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;THE TIME HAS COME&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>hiphenate</span> <span class=o>=</span> <span class=n>methodcaller</span><span class=p>(</span><span class=s1>&#39;replace&#39;</span><span class=p>,</span> <span class=s1>&#39; &#39;</span><span class=p>,</span> <span class=s1>&#39;-&#39;</span><span class=p>)</span> <span class=c1># 绑定额外参数</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>hiphenate</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;The-time-has-come&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=其他-3>其他</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=p>[</span><span class=n>name</span> <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=nb>dir</span><span class=p>(</span><span class=n>operator</span><span class=p>)</span> <span class=k>if</span> <span class=ow>not</span> <span class=n>name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;_&#39;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;abs&#39;</span><span class=p>,</span> <span class=s1>&#39;add&#39;</span><span class=p>,</span> <span class=s1>&#39;and_&#39;</span><span class=p>,</span> <span class=s1>&#39;attrgetter&#39;</span><span class=p>,</span> <span class=s1>&#39;concat&#39;</span><span class=p>,</span> <span class=s1>&#39;contains&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;countOf&#39;</span><span class=p>,</span> <span class=s1>&#39;delitem&#39;</span><span class=p>,</span> <span class=s1>&#39;eq&#39;</span><span class=p>,</span> <span class=s1>&#39;floordiv&#39;</span><span class=p>,</span> <span class=s1>&#39;ge&#39;</span><span class=p>,</span> <span class=s1>&#39;getitem&#39;</span><span class=p>,</span> <span class=s1>&#39;gt&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;iadd&#39;</span><span class=p>,</span> <span class=s1>&#39;iand&#39;</span><span class=p>,</span> <span class=s1>&#39;iconcat&#39;</span><span class=p>,</span> <span class=s1>&#39;ifloordiv&#39;</span><span class=p>,</span> <span class=s1>&#39;ilshift&#39;</span><span class=p>,</span> <span class=s1>&#39;imod&#39;</span><span class=p>,</span> <span class=s1>&#39;imul&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;index&#39;</span><span class=p>,</span> <span class=s1>&#39;indexOf&#39;</span><span class=p>,</span> <span class=s1>&#39;inv&#39;</span><span class=p>,</span> <span class=s1>&#39;invert&#39;</span><span class=p>,</span> <span class=s1>&#39;ior&#39;</span><span class=p>,</span> <span class=s1>&#39;ipow&#39;</span><span class=p>,</span> <span class=s1>&#39;irshift&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;is_&#39;</span><span class=p>,</span> <span class=s1>&#39;is_not&#39;</span><span class=p>,</span> <span class=s1>&#39;isub&#39;</span><span class=p>,</span> <span class=s1>&#39;itemgetter&#39;</span><span class=p>,</span> <span class=s1>&#39;itruediv&#39;</span><span class=p>,</span> <span class=s1>&#39;ixor&#39;</span><span class=p>,</span> <span class=s1>&#39;le&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;length_hint&#39;</span><span class=p>,</span> <span class=s1>&#39;lshift&#39;</span><span class=p>,</span> <span class=s1>&#39;lt&#39;</span><span class=p>,</span> <span class=s1>&#39;methodcaller&#39;</span><span class=p>,</span> <span class=s1>&#39;mod&#39;</span><span class=p>,</span> <span class=s1>&#39;mul&#39;</span><span class=p>,</span> <span class=s1>&#39;ne&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;neg&#39;</span><span class=p>,</span> <span class=s1>&#39;not_&#39;</span><span class=p>,</span> <span class=s1>&#39;or_&#39;</span><span class=p>,</span> <span class=s1>&#39;pos&#39;</span><span class=p>,</span> <span class=s1>&#39;pow&#39;</span><span class=p>,</span> <span class=s1>&#39;rshift&#39;</span><span class=p>,</span> <span class=s1>&#39;setitem&#39;</span><span class=p>,</span> <span class=s1>&#39;sub&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;truediv&#39;</span><span class=p>,</span> <span class=s1>&#39;truth&#39;</span><span class=p>,</span> <span class=s1>&#39;xor&#39;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>这 52 个名称中大部分的作用不言而喻。以 <code>i</code> 开头、后面是另一个运算符的那些名称（如 <code>iadd</code>、<code>iand</code> 等），对应的是增量赋值运算符（如 <code>+=</code>、<code>&=</code> 等）。如果第一个参数是可变的，那么这些运算符函数会就地修改它；否则，作用与不带 <code>i</code> 的函数一样，直接返回运算结果。</p><h4 id=使用-functoolspartial-冻结参数>使用 functools.partial 冻结参数</h4><p><code>functools</code> 模块提供了一系列高阶函数，其中最为人熟知的或许是 <code>reduce</code>。余下的函数中，最有用的是 <code>partial</code> 及其变体，<code>partialmethod</code>。</p><p><code>functools.partial</code> 这个高阶函数用于部分应用一个函数。部分应用是指，基于一个函数创建一个新的可调用对象，把原函数的某些参数固定。使用这个函数可以把接受一个或多个参数的函数改编成需要回调的 API，这样参数更少。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>operator</span> <span class=kn>import</span> <span class=n>mul</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>partial</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>triple</span> <span class=o>=</span> <span class=n>partial</span><span class=p>(</span><span class=n>mul</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>triple</span><span class=p>(</span><span class=mi>7</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=mi>21</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=n>triple</span><span class=p>,</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>10</span><span class=p>)))</span>  
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>12</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mi>18</span><span class=p>,</span> <span class=mi>21</span><span class=p>,</span> <span class=mi>24</span><span class=p>,</span> <span class=mi>27</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=使用一等函数实现设计模式>使用一等函数实现设计模式</h2><blockquote><p>符合模式并不表示做得对。</p><p>——Ralph Johnson，经典的《设计模式：可复用面向对象软件的基础》的作者之一</p></blockquote><p>有时，设计模式或 API 要求组件实现单方法接口，而那个方法的名称很宽泛，例如“execute”“run”或“doIt”。在 Python 中，这些模式或 API 通常可以使用一等函数或其他可调用的对象实现，从而减少样板代码。</p><h3 id=案例分析重构策略模式>案例分析：重构“策略”模式</h3><p>定义：定义一系列算法，把它们一一封装起来，并且使它们可以相互替换。本模式使得算法可以独立于使用它的客户而变化。</p><p>策略模式描述了在一个<strong>需要根据上下文内容选择合适算法</strong>的问题中，如何更好的组织这些算法的设计模式。</p><p>策略模式有如下关键组件：</p><ul><li><strong>上下文</strong>：提供进行算法选择的关键信息</li><li><strong>策略</strong>：不同算法的共用接口</li><li><strong>具体策略</strong>：策略的子类，不同算法的实现</li></ul><h4 id=经典的策略模式>经典的“策略”模式</h4><p>假如一个网店制定了下述折扣规则。</p><ul><li>有 1000 或以上积分的顾客，每个订单享 5% 折扣。</li><li>同一订单中，单个商品的数量达到 20 个或以上，享 10% 折扣。</li><li>订单中的不同商品达到 10 个或以上，享 7% 折扣。</li></ul><p>下图是使用“策略”设计模式处理订单折扣的 UML 类图</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220811140153050.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220811140153050.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220811140153050.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220811140153050.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220811140153050.png title=image-20220811140153050></p><p>在这个电商示例中，<strong>上下文</strong>是 <code>Order</code>，它会根据不同的算法计算促销折扣。</p><p>在这个示例中，名为 <code>Promotion</code> 的抽象类扮演<strong>策略</strong>这个角色</p><p><code>fidelityPromo</code>、<code>BulkPromo</code> 和 <code>LargeOrderPromo</code> 是这里实现的三个<strong>具体策略</strong>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>abc</span> <span class=kn>import</span> <span class=n>ABC</span><span class=p>,</span> <span class=n>abstractmethod</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>namedtuple</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Customer</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;Customer&#39;</span><span class=p>,</span> <span class=s1>&#39;name fidelity&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LineItem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product</span><span class=p>,</span> <span class=n>quantity</span><span class=p>,</span> <span class=n>price</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>product</span> <span class=o>=</span> <span class=n>product</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>quantity</span> <span class=o>=</span> <span class=n>quantity</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>price</span> <span class=o>=</span> <span class=n>price</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>total</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>price</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>quantity</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Order</span><span class=p>:</span>  <span class=c1># 上下文</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>customer</span><span class=p>,</span> <span class=n>cart</span><span class=p>,</span> <span class=n>promotion</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>customer</span> <span class=o>=</span> <span class=n>customer</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cart</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>cart</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>promotion</span> <span class=o>=</span> <span class=n>promotion</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>total</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s1>&#39;__total&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>__total</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>total</span><span class=p>()</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>cart</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>__total</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>due</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>promotion</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>discount</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>discount</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>promotion</span><span class=o>.</span><span class=n>discount</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>total</span><span class=p>()</span> <span class=o>-</span> <span class=n>discount</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>fmt</span> <span class=o>=</span> <span class=s1>&#39;&lt;Order total: </span><span class=si>{:.2f}</span><span class=s1> due: </span><span class=si>{:.2f}</span><span class=s1>&gt;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>fmt</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>total</span><span class=p>(),</span> <span class=bp>self</span><span class=o>.</span><span class=n>due</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Promotion</span><span class=p>(</span><span class=n>ABC</span><span class=p>)</span> <span class=p>:</span> <span class=c1># 策略：抽象基类</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>discount</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;返回折扣金额（正值）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FidelityPromo</span><span class=p>(</span><span class=n>Promotion</span><span class=p>):</span>  <span class=c1># 第一个具体策略</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;为积分为1000或以上的顾客提供5%折扣&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>discount</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>order</span><span class=o>.</span><span class=n>total</span><span class=p>()</span> <span class=o>*</span> <span class=mf>.05</span> <span class=k>if</span> <span class=n>order</span><span class=o>.</span><span class=n>customer</span><span class=o>.</span><span class=n>fidelity</span> <span class=o>&gt;=</span> <span class=mi>1000</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BulkItemPromo</span><span class=p>(</span><span class=n>Promotion</span><span class=p>):</span>  <span class=c1># 第二个具体策略</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;单个商品为20个或以上时提供10%折扣&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>discount</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>discount</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>order</span><span class=o>.</span><span class=n>cart</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>item</span><span class=o>.</span><span class=n>quantity</span> <span class=o>&gt;=</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>discount</span> <span class=o>+=</span> <span class=n>item</span><span class=o>.</span><span class=n>total</span><span class=p>()</span> <span class=o>*</span> <span class=mf>.1</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>discount</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LargeOrderPromo</span><span class=p>(</span><span class=n>Promotion</span><span class=p>):</span>  <span class=c1># 第三个具体策略</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;订单中的不同商品达到10个或以上时提供7%折扣&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>discount</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>distinct_items</span> <span class=o>=</span> <span class=p>{</span><span class=n>item</span><span class=o>.</span><span class=n>product</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>order</span><span class=o>.</span><span class=n>cart</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>distinct_items</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>order</span><span class=o>.</span><span class=n>total</span><span class=p>()</span> <span class=o>*</span> <span class=mf>.07</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span>
</span></span></code></pre></td></tr></table></div></div><p>演示</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>joe</span> <span class=o>=</span> <span class=n>Customer</span><span class=p>(</span><span class=s1>&#39;John Doe&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>ann</span> <span class=o>=</span> <span class=n>Customer</span><span class=p>(</span><span class=s1>&#39;Ann Smith&#39;</span><span class=p>,</span> <span class=mi>1100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>cart</span> <span class=o>=</span> <span class=p>[</span><span class=n>LineItem</span><span class=p>(</span><span class=s1>&#39;banana&#39;</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mf>.5</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>            <span class=o>...</span>         <span class=n>LineItem</span><span class=p>(</span><span class=s1>&#39;apple&#39;</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mf>1.5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>         <span class=n>LineItem</span><span class=p>(</span><span class=s1>&#39;watermellon&#39;</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mf>5.0</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Order</span><span class=p>(</span><span class=n>joe</span><span class=p>,</span> <span class=n>cart</span><span class=p>,</span> <span class=n>FidelityPromo</span><span class=p>())</span> 
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Order</span> <span class=n>total</span><span class=p>:</span> <span class=mf>42.00</span> <span class=n>due</span><span class=p>:</span> <span class=mf>42.00</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Order</span><span class=p>(</span><span class=n>ann</span><span class=p>,</span> <span class=n>cart</span><span class=p>,</span> <span class=n>FidelityPromo</span><span class=p>())</span> 
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Order</span> <span class=n>total</span><span class=p>:</span> <span class=mf>42.00</span> <span class=n>due</span><span class=p>:</span> <span class=mf>39.90</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>banana_cart</span> <span class=o>=</span> <span class=p>[</span><span class=n>LineItem</span><span class=p>(</span><span class=s1>&#39;banana&#39;</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mf>.5</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>                   <span class=o>...</span>                <span class=n>LineItem</span><span class=p>(</span><span class=s1>&#39;apple&#39;</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mf>1.5</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Order</span><span class=p>(</span><span class=n>joe</span><span class=p>,</span> <span class=n>banana_cart</span><span class=p>,</span> <span class=n>BulkItemPromo</span><span class=p>())</span> 
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Order</span> <span class=n>total</span><span class=p>:</span> <span class=mf>30.00</span> <span class=n>due</span><span class=p>:</span> <span class=mf>28.50</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>long_order</span> <span class=o>=</span> <span class=p>[</span><span class=n>LineItem</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>item_code</span><span class=p>),</span> <span class=mi>1</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>                  <span class=o>...</span>               <span class=k>for</span> <span class=n>item_code</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Order</span><span class=p>(</span><span class=n>joe</span><span class=p>,</span> <span class=n>long_order</span><span class=p>,</span> <span class=n>LargeOrderPromo</span><span class=p>())</span> 
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Order</span> <span class=n>total</span><span class=p>:</span> <span class=mf>10.00</span> <span class=n>due</span><span class=p>:</span> <span class=mf>9.30</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Order</span><span class=p>(</span><span class=n>joe</span><span class=p>,</span> <span class=n>cart</span><span class=p>,</span> <span class=n>LargeOrderPromo</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>Order</span> <span class=n>total</span><span class=p>:</span> <span class=mf>42.00</span> <span class=n>due</span><span class=p>:</span> <span class=mf>42.00</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>这个示例完全可用，但是利用 Python 中作为对象的函数，可以使用更少的代码实现相同的功能。详情参见下一节。</p><h4 id=使用函数实现策略模式>使用函数实现“策略”模式</h4><p>在上个示例中，每个具体策略都是一个类，而且都只定义了一个方法，即 <code>discount</code>。此外，策略实例没有状态（没有实例属性）。你可能会说，它们看起来像是普通的函数——的确如此。下面的示例是对之前示例的重构，把具体策略换成了简单的函数，而且去掉了 <code>Promo</code> 抽象类。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>namedtuple</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Customer</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;Customer&#39;</span><span class=p>,</span> <span class=s1>&#39;name fidelity&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LineItem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product</span><span class=p>,</span> <span class=n>quantity</span><span class=p>,</span> <span class=n>price</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>product</span> <span class=o>=</span> <span class=n>product</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>quantity</span> <span class=o>=</span> <span class=n>quantity</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>price</span> <span class=o>=</span> <span class=n>price</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>total</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>price</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>quantity</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Order</span><span class=p>:</span>  <span class=c1># 上下文</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>customer</span><span class=p>,</span> <span class=n>cart</span><span class=p>,</span> <span class=n>promotion</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>customer</span> <span class=o>=</span> <span class=n>customer</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cart</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>cart</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>promotion</span> <span class=o>=</span> <span class=n>promotion</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>total</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s1>&#39;__total&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>__total</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>total</span><span class=p>()</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>cart</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>__total</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>due</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>promotion</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>discount</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>discount</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>promotion</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>total</span><span class=p>()</span> <span class=o>-</span> <span class=n>discount</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>fmt</span> <span class=o>=</span> <span class=s1>&#39;&lt;Order total: </span><span class=si>{:.2f}</span><span class=s1> due: </span><span class=si>{:.2f}</span><span class=s1>&gt;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>fmt</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>total</span><span class=p>(),</span> <span class=bp>self</span><span class=o>.</span><span class=n>due</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fidelity_promo</span><span class=p>(</span><span class=n>order</span><span class=p>):</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;为积分为1000或以上的顾客提供5%折扣&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>order</span><span class=o>.</span><span class=n>total</span><span class=p>()</span> <span class=o>*</span> <span class=mf>.05</span> <span class=k>if</span> <span class=n>order</span><span class=o>.</span><span class=n>customer</span><span class=o>.</span><span class=n>fidelity</span> <span class=o>&gt;=</span> <span class=mi>1000</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>bulk_item_promo</span><span class=p>(</span><span class=n>order</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;单个商品为20个或以上时提供10%折扣&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>discount</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>order</span><span class=o>.</span><span class=n>cart</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>item</span><span class=o>.</span><span class=n>quantity</span> <span class=o>&gt;=</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>discount</span> <span class=o>+=</span> <span class=n>item</span><span class=o>.</span><span class=n>total</span><span class=p>()</span> <span class=o>*</span> <span class=mf>.1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>discount</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>large_order_promo</span><span class=p>(</span><span class=n>order</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;订单中的不同商品达到10个或以上时提供7%折扣&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>distinct_items</span> <span class=o>=</span> <span class=p>{</span><span class=n>item</span><span class=o>.</span><span class=n>product</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>order</span><span class=o>.</span><span class=n>cart</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>distinct_items</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>order</span><span class=o>.</span><span class=n>total</span><span class=p>()</span> <span class=o>*</span> <span class=mf>.07</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span>
</span></span></code></pre></td></tr></table></div></div><p>使用起来更简单，不需要实例化具体逻辑，只需要传入函数即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>Order</span><span class=p>(</span><span class=n>joe</span><span class=p>,</span> <span class=n>cart</span><span class=p>,</span> <span class=n>fidelity_promo</span><span class=p>)</span> <span class=c1># 为了把折扣策略应用到 Order 实例上，只需把促销函数作为参数传入</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>值得注意的是，《设计模式：可复用面向对象软件的基础》一书的作者指出：“策略对象通常是很好的享元（flyweight）。” 那本书的另一部分对 “<strong>享元</strong>” 下了定义：“享元是可共享的对象，可以同时在多个上下文中使用。”</p><p>共享是推荐的做法，这样不必在每个新的上下文（这里是 <code>Order</code> 实例）中使用相同的策略时不断新建具体策略对象，从而减少消耗。</p></blockquote><p>在复杂的情况下，需要具体策略维护内部状态时，可能需要把“策略”和“享元”模式结合起来。但是，具体策略一般没有内部状态，只是处理上下文中的数据。此时，一定要使用普通的函数，别去编写只有一个方法的类，再去实现另一个类声明的单函数接口。</p><p>函数比用户定义的类的实例轻量，而且无需使用“享元”模式，因为各个策略函数在 Python 编译模块时只会创建一次。普通的函数也是“可共享的对象，可以同时在多个上下文中使用”。</p><h4 id=选择最佳策略简单的方式>选择最佳策略：简单的方式</h4><p>假设我们想创建一个“元策略”，让它为指定的订单选择最佳折扣。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>promos</span> <span class=o>=</span> <span class=p>[</span><span class=n>fidelity_promo</span><span class=p>,</span> <span class=n>bulk_item_promo</span><span class=p>,</span> <span class=n>large_order_promo</span><span class=p>]</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>best_promo</span><span class=p>(</span><span class=n>order</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;选择可用的最佳折扣
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=n>promo</span><span class=p>(</span><span class=n>order</span><span class=p>)</span> <span class=k>for</span> <span class=n>promo</span> <span class=ow>in</span> <span class=n>promos</span><span class=p>)</span>  
</span></span></code></pre></td></tr></table></div></div><p><code>promos</code> 是函数列表。习惯函数是一等对象后，自然而然就会构建那种数据结构存储函数</p><p>虽然示例可用，而且易于阅读，但是有些重复可能会导致不易察觉的缺陷：若想添加新的促销策略，要定义相应的函数，还要记得把它添加到 <code>promos</code> 列表中；否则，当新促销函数显式地作为参数传给 <code>Order</code> 时，它是可用的，但是 <code>best_promo</code> 不会考虑它。</p><h4 id=找出模块中的全部策略>找出模块中的全部策略</h4><p>在 Python 中，模块也是一等对象，而且标准库提供了几个处理模块的函数。</p><p>Python 文档是这样说明内置函数 <code>globals</code> 的：</p><blockquote><p>返回一个字典，表示当前的全局符号表。这个符号表始终针对当前模块（对函数或方法来说，是指定义它们的模块，而不是调用它们的模块）。</p></blockquote><p>下面的示例使用 <code>globals</code> 函数帮助 <code>best_promo</code> 自动找到其他可用的 <code>*_promo</code> 函数，过程有点曲折。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>promos</span> <span class=o>=</span> <span class=p>[</span><span class=nb>globals</span><span class=p>()[</span><span class=n>name</span><span class=p>]</span> <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=nb>globals</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>name</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;_promo&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=ow>and</span> <span class=n>name</span> <span class=o>!=</span> <span class=s1>&#39;best_promo&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>best_promo</span><span class=p>(</span><span class=n>order</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;选择可用的最佳折扣
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=n>promo</span><span class=p>(</span><span class=n>order</span><span class=p>)</span> <span class=k>for</span> <span class=n>promo</span> <span class=ow>in</span> <span class=n>promos</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>收集所有可用促销的另一种方法是，在一个单独的模块中保存所有策略函数，把 <code>best_promo</code> 排除在外</p><p>在下面的示例中，最大的变化是内省名为 <code>promotions</code> 的独立模块，构建策略函数列表。注意，示例要导入 <code>promotions</code> 模块，以及提供高阶内省函数的 <code>inspect</code> 模块（简单起见，这里没有给出导入语句，因为导入语句一般放在文件顶部）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>promos</span> <span class=o>=</span> <span class=p>[</span><span class=n>func</span> <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>func</span> <span class=ow>in</span>
</span></span><span class=line><span class=cl>                <span class=n>inspect</span><span class=o>.</span><span class=n>getmembers</span><span class=p>(</span><span class=n>promotions</span><span class=p>,</span> <span class=n>inspect</span><span class=o>.</span><span class=n>isfunction</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>best_promo</span><span class=p>(</span><span class=n>order</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;选择可用的最佳折扣
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=n>promo</span><span class=p>(</span><span class=n>order</span><span class=p>)</span> <span class=k>for</span> <span class=n>promo</span> <span class=ow>in</span> <span class=n>promos</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>inspect.getmembers</code> 函数用于获取对象（这里是 <code>promotions</code> 模块）的属性，第二个参数是可选的判断条件（一个布尔值函数）。我们使用的是 <code>inspect.isfunction</code>，只获取模块中的函数。</p><p>不管怎么命名策略函数，示例 6-8 都可用；唯一重要的是，<code>promotions</code> 模块只能包含计算订单折扣的函数。当然，这是对代码的隐性假设。如果有人在 <code>promotions</code> 模块中使用不同的签名定义函数，那么 <code>best_promo</code> 函数尝试将其应用到订单上时会出错。</p><p>我们可以添加更为严格的测试，审查传给实例的参数，进一步过滤函数。这个示例的目的不是提供完善的方案，而是强调模块内省的一种用途。</p><blockquote><p>动态收集促销折扣函数更为显式的一种方案是使用简单的装饰器，之后会讨论这种实现</p></blockquote><h3 id=命令模式>命令模式</h3><p>“命令”设计模式也可以通过把函数作为参数传递而简化</p><p>下面是菜单驱动的文本编辑器的 UML 类图，使用“命令”设计模式实现。各个命令可以有不同的接收者（实现操作的对象）。对 <code>PasteCommand</code> 来说，接收者是 <code>Document</code>。对 <code>OpenCommand</code> 来说，接收者是应用程序</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220811151245928.png data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220811151245928.png, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220811151245928.png 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220811151245928.png 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/image-20220811151245928.png title=image-20220811151245928></p><p>“命令”模式的目的是<strong>解耦调用操作的对象（调用者）和提供实现的对象（接收者）</strong></p><p>这个模式的做法是，在二者之间放一个 <code>Command</code> 对象，让它实现只有一个方法（<code>execute</code>）的接口，调用接收者中的方法执行所需的操作。这样，调用者无需了解接收者的接口，而且不同的接收者可以适应不同的 <code>Command</code> 子类。调用者有一个具体的命令，通过调用 <code>execute</code> 方法执行。注意，图 6-2 中的 <code>MacroCommand</code> 可能保存一系列命令，它的 <code>execute()</code> 方法会在各个命令上调用相同的方法。</p><p><strong>命令模式是回调机制的面向对象替代品</strong>。问题是，我们需要回调机制的面向对象替代品吗？有时确实需要，但并非始终需要。</p><p>我们可以不为调用者提供一个 <code>Command</code> 实例，而是给它一个函数。此时，调用者不用调用 <code>command.execute()</code>，直接调用 <code>command()</code> 即可。<code>MacroCommand</code> 可以实现成定义了 <code>__call__</code> 方法的类。这样，<code>MacroCommand</code> 的实例就是可调用对象，各自维护着一个函数列表，供以后调用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>MacroCommand</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;一个执行一组命令的命令&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>commands</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>commands</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>commands</span><span class=p>)</span> <span class=c1># ➊</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>command</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>commands</span><span class=p>:</span> <span class=c1># ➋</span>
</span></span><span class=line><span class=cl>            <span class=n>command</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>使用一等函数对“命令”模式的重新审视到此结束。站在一定高度上看，这里采用的方式与“策略”模式所用的类似：<strong>把实现单方法接口的类的实例替换成可调用对象</strong>。毕竟，每个 Python 可调用对象都实现了单方法接口，这个方法就是 <code>__call__</code>。</p><h2 id=函数装饰器和闭包>函数装饰器和闭包</h2><p>函数装饰器用于在源码中“标记”函数，以某种方式增强函数的行为。这是一项强大的功能，但是若想掌握，必须理解闭包</p><p>除了在装饰器中有用处之外，闭包还是回调式异步编程和函数式编程风格的基础</p><h3 id=装饰器基础知识>装饰器基础知识</h3><p><strong>装饰器是可调用的对象，其参数是另一个函数（被装饰的函数）</strong>。装饰器可能会处理被装饰的函数，然后把它返回，或者将其替换成另一个函数或可调用对象。</p><p>假如有个名为 <code>decorate</code> 的装饰器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@decorate</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>target</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running target()&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>上述代码的效果与下述写法一样：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>target</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running target()&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>target</span> <span class=o>=</span> <span class=n>decorate</span><span class=p>(</span><span class=n>target</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>两种写法的最终结果一样：上述两个代码片段执行完毕后得到的 <code>target</code> 不一定是原来那个 <code>target</code> 函数，而是 <code>decorate(target)</code> 返回的函数。</p><p>装饰器通常把函数替换成另一个函数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>deco</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>def</span> <span class=nf>inner</span><span class=p>():</span>
</span></span><span class=line><span class=cl><span class=o>...</span>         <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running inner()&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=n>inner</span>  
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nd>@deco</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=k>def</span> <span class=nf>target</span><span class=p>():</span>  
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running target()&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>target</span><span class=p>()</span>  
</span></span><span class=line><span class=cl><span class=n>running</span> <span class=n>inner</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>target</span>  
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>function</span> <span class=n>deco</span><span class=o>.&lt;</span><span class=nb>locals</span><span class=o>&gt;.</span><span class=n>inner</span> <span class=n>at</span> <span class=mh>0x10063b598</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>严格来说，装饰器只是语法糖。如前所示，装饰器可以像常规的可调用对象那样调用，其参数是另一个函数。有时，这样做更方便，尤其是做<strong>元编程</strong>（在运行时改变程序的行为）时</p><p>综上，装饰器的一大特性是，<strong>能把被装饰的函数替换成其他函数</strong>。第二个特性是，<strong>装饰器在加载模块时立即执行</strong></p><h3 id=python-何时执行装饰器>Python 何时执行装饰器</h3><p>装饰器的一个关键特性是，它们在被装饰的函数定义之后立即运行。这通常是在<strong>导入时</strong>（即 Python 加载模块时）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>registry</span> <span class=o>=</span> <span class=p>[]</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>register</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running register(</span><span class=si>%s</span><span class=s1>)&#39;</span> <span class=o>%</span> <span class=n>func</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>func</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@register</span>  
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>f1</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running f1()&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@register</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>f2</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running f2()&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>f3</span><span class=p>():</span>  
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running f3()&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>  
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running main()&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;registry -&gt;&#39;</span><span class=p>,</span> <span class=n>registry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>f1</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>f2</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>f3</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span><span class=o>==</span><span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>  
</span></span></code></pre></td></tr></table></div></div><p>作为脚本运行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ python3 registration.py
</span></span><span class=line><span class=cl>running register<span class=o>(</span>&lt;<span class=k>function</span> f1 at 0x100631bf8&gt;<span class=o>)</span>
</span></span><span class=line><span class=cl>running register<span class=o>(</span>&lt;<span class=k>function</span> f2 at 0x100631c80&gt;<span class=o>)</span>
</span></span><span class=line><span class=cl>running main<span class=o>()</span>
</span></span><span class=line><span class=cl>registry -&gt; <span class=o>[</span>&lt;<span class=k>function</span> f1 at 0x100631bf8&gt;, &lt;<span class=k>function</span> f2 at 0x100631c80&gt;<span class=o>]</span>
</span></span><span class=line><span class=cl>running f1<span class=o>()</span>
</span></span><span class=line><span class=cl>running f2<span class=o>()</span>
</span></span><span class=line><span class=cl>running f3<span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>注意，<code>register</code> 在模块中其他函数之前运行（两次）。调用 <code>register</code> 时，传给它的参数是被装饰的函数，例如 <code>&lt;function f1 at 0x100631bf8></code>。</p><p>加载模块后，<code>registry</code> 中有两个被装饰函数的引用：<code>f1</code> 和 <code>f2</code>。这两个函数，以及 <code>f3</code>，只在 <code>main</code> 明确调用它们时才执行。</p><p>如果导入 registration.py 模块（不作为脚本运行），输出如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>registration</span>
</span></span><span class=line><span class=cl><span class=n>running</span> <span class=n>register</span><span class=p>(</span><span class=o>&lt;</span><span class=n>function</span> <span class=n>f1</span> <span class=n>at</span> <span class=mh>0x10063b1e0</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>running</span> <span class=n>register</span><span class=p>(</span><span class=o>&lt;</span><span class=n>function</span> <span class=n>f2</span> <span class=n>at</span> <span class=mh>0x10063b268</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>registration</span><span class=o>.</span><span class=n>registry</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>&lt;</span><span class=n>function</span> <span class=n>f1</span> <span class=n>at</span> <span class=mh>0x10063b1e0</span><span class=o>&gt;</span><span class=p>,</span> <span class=o>&lt;</span><span class=n>function</span> <span class=n>f2</span> <span class=n>at</span> <span class=mh>0x10063b268</span><span class=o>&gt;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>函数装饰器在导入模块时立即执行，而被装饰的函数只在明确调用时运行。这突出了 Python 程序员所说的<strong>导入时</strong>和<strong>运行时</strong>之间的区别。</p><p>虽然示例中的 <code>register</code> 装饰器原封不动地返回被装饰的函数，但是这种技术并非没有用处。很多 Python Web 框架使用这样的装饰器把函数添加到某种中央注册处，例如把 URL 模式映射到生成 HTTP 响应的函数上的注册处。这种注册装饰器可能会也可能不会修改被装饰的函数。下一节会举例说明。</p><h3 id=使用装饰器改进策略模式>使用装饰器改进“策略”模式</h3><p>回顾一下，之前策略模式示例的主要问题是，定义体中有函数的名称，但是 <code>best_promo</code> 用来判断哪个折扣幅度最大的 <code>promos</code> 列表中也有函数名称。这种重复是个问题，因为新增策略函数后可能会忘记把它添加到 <code>promos</code> 列表中，导致 <code>best_promo</code> 忽略新策略，而且不报错，为系统引入了不易察觉的缺陷。下面的示例使用注册装饰器解决了这个问题。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>promos</span> <span class=o>=</span> <span class=p>[]</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>promotion</span><span class=p>(</span><span class=n>promo_func</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>    <span class=n>promos</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>promo_func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>promo_func</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@promotion</span>  
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fidelity</span><span class=p>(</span><span class=n>order</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;为积分为1000或以上的顾客提供5%折扣&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>order</span><span class=o>.</span><span class=n>total</span><span class=p>()</span> <span class=o>*</span> <span class=mf>.05</span> <span class=k>if</span> <span class=n>order</span><span class=o>.</span><span class=n>customer</span><span class=o>.</span><span class=n>fidelity</span> <span class=o>&gt;=</span> <span class=mi>1000</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@promotion</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>bulk_item</span><span class=p>(</span><span class=n>order</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;单个商品为20个或以上时提供10%折扣&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>discount</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>order</span><span class=o>.</span><span class=n>cart</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>item</span><span class=o>.</span><span class=n>quantity</span> <span class=o>&gt;=</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>discount</span> <span class=o>+=</span> <span class=n>item</span><span class=o>.</span><span class=n>total</span><span class=p>()</span> <span class=o>*</span> <span class=mf>.1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>discount</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@promotion</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>large_order</span><span class=p>(</span><span class=n>order</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;订单中的不同商品达到10个或以上时提供7%折扣&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>distinct_items</span> <span class=o>=</span> <span class=p>{</span><span class=n>item</span><span class=o>.</span><span class=n>product</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>order</span><span class=o>.</span><span class=n>cart</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>distinct_items</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>order</span><span class=o>.</span><span class=n>total</span><span class=p>()</span> <span class=o>*</span> <span class=mf>.07</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>best_promo</span><span class=p>(</span><span class=n>order</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;选择可用的最佳折扣
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=n>promo</span><span class=p>(</span><span class=n>order</span><span class=p>)</span> <span class=k>for</span> <span class=n>promo</span> <span class=ow>in</span> <span class=n>promos</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>与老方案相比，这个方案有几个优点：</p><ul><li>促销策略函数无需使用特殊的名称（即不用以 <code>_promo</code> 结尾）。</li><li><code>@promotion</code> 装饰器突出了被装饰的函数的作用，还便于临时禁用某个促销策略：只需把装饰器注释掉。</li><li>促销折扣策略可以在其他模块中定义，在系统中的任何地方都行，只要使用 <code>@promotion</code> 装饰即可。</li></ul><p><strong>不过，多数装饰器会修改被装饰的函数。通常，它们会定义一个内部函数，然后将其返回，替换被装饰的函数</strong>。使用内部函数的代码几乎都要靠闭包才能正确运作。为了理解闭包，我们要退后一步，先了解 Python 中的变量作用域。</p><h3 id=变量作用域规则>变量作用域规则</h3><p>在下面的示例中，我们定义并测试了一个函数，它读取两个变量的值：一个是局部变量 <code>a</code>，是函数的参数；另一个是变量 <code>b</code>，这个函数没有定义它。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>f1</span><span class=p>(</span><span class=n>a</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>f1</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;&lt;stdin&gt;&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>1</span><span class=p>,</span> <span class=ow>in</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;&lt;stdin&gt;&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>3</span><span class=p>,</span> <span class=ow>in</span> <span class=n>f1</span>
</span></span><span class=line><span class=cl><span class=ne>NameError</span><span class=p>:</span> <span class=n>name</span> <span class=s1>&#39;b&#39;</span> <span class=ow>is</span> <span class=ow>not</span> <span class=n>defined</span>
</span></span></code></pre></td></tr></table></div></div><p>出现错误并不奇怪。</p><p>在下个示例中，如果先给全局变量 <code>b</code> 赋值，然后再调用 <code>f</code>，那就不会出错：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>f1</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=mi>6</span>
</span></span></code></pre></td></tr></table></div></div><p>下面看一个可能会让你吃惊的示例。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>f2</span><span class=p>(</span><span class=n>a</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>b</span> <span class=o>=</span> <span class=mi>9</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>f2</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;&lt;stdin&gt;&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>1</span><span class=p>,</span> <span class=ow>in</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;&lt;stdin&gt;&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>3</span><span class=p>,</span> <span class=ow>in</span> <span class=n>f2</span>
</span></span><span class=line><span class=cl><span class=ne>UnboundLocalError</span><span class=p>:</span> <span class=n>local</span> <span class=n>variable</span> <span class=s1>&#39;b&#39;</span> <span class=n>referenced</span> <span class=n>before</span> <span class=n>assignment</span>
</span></span></code></pre></td></tr></table></div></div><p>f2 好像没有读取全局变量 <code>b</code>，<code>b</code> 被定义为局部变量，因为在函数的定义体中给它赋值了</p><p>⭐ 这不是缺陷，而是设计选择：<strong>Python 不要求声明变量，但是假定在函数定义体中赋值的变量是局部变量</strong>。</p><p>这比 JavaScript 的行为好多了，JavaScript 也不要求声明变量，但是如果忘记把变量声明为局部变量（使用 <code>var</code>），可能会在不知情的情况下获取全局变量。</p><p>如果在函数中赋值时想让解释器把 <code>b</code> 当成全局变量，要使用 <code>global</code> 声明：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>f3</span><span class=p>(</span><span class=n>a</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>global</span> <span class=n>b</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>b</span> <span class=o>=</span> <span class=mi>9</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>f3</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=mi>6</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span>
</span></span><span class=line><span class=cl><span class=mi>9</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>f3</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=mi>9</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span>
</span></span><span class=line><span class=cl><span class=mi>30</span>
</span></span></code></pre></td></tr></table></div></div><p>了解 Python 的变量作用域之后，下一节可以讨论闭包了</p><h3 id=闭包>闭包</h3><p>人们有时会把闭包和匿名函数弄混。这是有历史原因的：在函数内部定义函数不常见，直到开始使用匿名函数才会这样做。而且，只有涉及嵌套函数时才有闭包问题。因此，很多人是同时知道这两个概念的。</p><p>其实，<strong>闭包指延伸了作用域的函数，其中包含函数定义体中引用、但是不在定义体中定义的非全局变量</strong>。函数是不是匿名的没有关系，关键是它能访问定义体之外定义的非全局变量。</p><p>这个概念难以掌握，最好通过示例理解。</p><p>假如有个名为 <code>avg</code> 的函数，它的作用是计算不断增加的系列值的均值；例如，整个历史中某个商品的平均收盘价。每天都会增加新价格，因此平均值要考虑至目前为止所有的价格。</p><p>起初，<code>avg</code> 是这样使用的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mf>10.0</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mf>10.5</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=p>(</span><span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mf>11.0</span>
</span></span></code></pre></td></tr></table></div></div><p><code>avg</code> 从何而来，它又在哪里保存历史值呢？</p><p>初学者可能会像示例 7-8 那样使用类实现。</p><blockquote><p><strong>示例 7-8</strong>　average_oo.py：计算移动平均值的类</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>Averager</span><span class=p>():</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>series</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>new_value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>series</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>new_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>total</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>series</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>total</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>series</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>Averager</code> 的实例是可调用对象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span> <span class=o>=</span> <span class=n>Averager</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mf>10.0</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mf>10.5</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=p>(</span><span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mf>11.0</span>
</span></span></code></pre></td></tr></table></div></div><p>示例 7-9 是函数式实现，使用高阶函数 <code>make_averager</code>。</p><blockquote><p><strong>示例 7-9</strong>　average.py：计算移动平均值的高阶函数</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_averager</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>series</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>averager</span><span class=p>(</span><span class=n>new_value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>series</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>new_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>total</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>series</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>total</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>series</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>averager</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span> <span class=o>=</span> <span class=n>make_averager</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mf>10.0</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mf>10.5</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=p>(</span><span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mf>11.0</span>
</span></span></code></pre></td></tr></table></div></div><p>注意，这两个示例有共通之处：调用 <code>Averager()</code> 或 <code>make_averager()</code> 得到一个可调用对象 <code>avg</code>，它会更新历史值，然后计算当前均值。</p><p><code>Averager</code> 类的实例 <code>avg</code> 在哪里存储历史值很明显：<code>self.series</code> 实例属性。但是第二个示例中的 <code>avg</code> 函数在哪里寻找 <code>series</code> 呢？</p><p>注意，<code>series</code> 是 <code>make_averager</code> 函数的局部变量，因为那个函数的定义体中初始化了 <code>series</code>：<code>series = []</code>。可是，调用 <code>avg(10)</code> 时，<code>make_averager</code> 函数已经返回了，而它的本地作用域也一去不复返了。</p><p>在 <code>averager</code> 函数中，<code>series</code> 是<strong>自由变量</strong>（free variable）。这是一个技术术语，指<strong>未在本地作用域中绑定的变量</strong></p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00024.gif data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00024.gif, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00024.gif 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00024.gif 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00024.gif title={%}></p><p>审查返回的 <code>averager</code> 对象，我们发现 Python 在 <code>__code__</code> 属性（表示编译后的函数定义体）中保存局部变量和自由变量的名称，如示例 7-11 所示。</p><blockquote><p><strong>示例 7-11</strong>　审查 <code>make_averager</code>（见示例 7-9）创建的函数</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=o>.</span><span class=vm>__code__</span><span class=o>.</span><span class=n>co_varnames</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;new_value&#39;</span><span class=p>,</span> <span class=s1>&#39;total&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=o>.</span><span class=vm>__code__</span><span class=o>.</span><span class=n>co_freevars</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;series&#39;</span><span class=p>,)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>series</code> 的绑定在返回的 <code>avg</code> 函数的 <code>__closure__</code> 属性中。<code>avg.__closure__</code> 中的各个元素对应于 <code>avg.__code__.co_freevars</code> 中的一个名称。这些元素是 <code>cell</code> 对象，有个 <code>cell_contents</code> 属性，保存着真正的值。这些属性的值如示例 7-12 所示。</p><blockquote><p><strong>示例 7-12</strong>　接续示例 7-11</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=o>.</span><span class=vm>__code__</span><span class=o>.</span><span class=n>co_freevars</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;series&#39;</span><span class=p>,)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=o>.</span><span class=vm>__closure__</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>&lt;</span><span class=n>cell</span> <span class=n>at</span> <span class=mh>0x107a44f78</span><span class=p>:</span> <span class=nb>list</span> <span class=nb>object</span> <span class=n>at</span> <span class=mh>0x107a91a48</span><span class=o>&gt;</span><span class=p>,)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=o>.</span><span class=vm>__closure__</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>cell_contents</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>10</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>12</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>⭐ 综上，<strong>闭包是一种函数，它会保留定义函数时存在的自由变量的绑定，这样调用函数时，虽然定义作用域不可用了，但是仍能使用那些绑定。</strong></p><p>注意，只有嵌套在其他函数中的函数才可能需要处理不在全局作用域中的外部变量。</p><h3 id=nonlocal-声明>nonlocal 声明</h3><p>前面实现 <code>make_averager</code> 函数的方法效率不高。在示例 7-9 中，我们把所有值存储在历史数列中，然后在每次调用 <code>averager</code> 时使用 <code>sum</code> 求和。更好的实现方式是，只存储目前的总值和元素个数，然后使用这两个数计算均值。</p><p>示例 7-13 中的实现有缺陷，只是为了阐明观点。</p><blockquote><p><strong>示例 7-13</strong>　计算移动平均值的高阶函数，不保存所有历史值，但有缺陷</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_averager</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>total</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>averager</span><span class=p>(</span><span class=n>new_value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>total</span> <span class=o>+=</span> <span class=n>new_value</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>total</span> <span class=o>/</span> <span class=n>count</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>averager</span>
</span></span></code></pre></td></tr></table></div></div><p>尝试使用示例 7-13 中定义的函数，会得到如下结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span> <span class=o>=</span> <span class=n>make_averager</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>avg</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>UnboundLocalError</span><span class=p>:</span> <span class=n>local</span> <span class=n>variable</span> <span class=s1>&#39;count&#39;</span> <span class=n>referenced</span> <span class=n>before</span> <span class=n>assignment</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>问题是，当 <code>count</code> 是数字或任何不可变类型时，<code>count += 1</code> 语句的作用其实与 <code>count = count + 1</code> 一样。因此，我们在 <code>averager</code> 的定义体中为 <code>count</code> 赋值了，这会把 <code>count</code> 变成局部变量。<code>total</code> 变量也受这个问题影响。</p><p>示例 7-9 没遇到这个问题，因为我们没有给 <code>series</code> 赋值，我们只是调用 <code>series.append</code>，并把它传给 <code>sum</code> 和 <code>len</code>。也就是说，我们利用了列表是可变的对象这一事实。</p><p>但是对数字、字符串、元组等不可变类型来说，只能读取，不能更新。如果尝试重新绑定，例如 <code>count = count + 1</code>，其实会隐式创建局部变量 <code>count</code>。这样，<code>count</code> 就不是自由变量了，因此不会保存在闭包中。</p><p>为了解决这个问题，**Python 3 引入了 <code>nonlocal</code> 声明。它的作用是把变量标记为自由变量，即使在函数中为变量赋予新值了，也会变成自由变量。**如果为 <code>nonlocal</code> 声明的变量赋予新值，闭包中保存的绑定会更新。最新版 <code>make_averager</code> 的正确实现如示例 7-14 所示。</p><blockquote><p><strong>示例 7-14</strong>　计算移动平均值，不保存所有历史（使用 <code>nonlocal</code> 修正）</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_averager</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>total</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>averager</span><span class=p>(</span><span class=n>new_value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>nonlocal</span> <span class=n>count</span><span class=p>,</span> <span class=n>total</span>
</span></span><span class=line><span class=cl>        <span class=n>count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>total</span> <span class=o>+=</span> <span class=n>new_value</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>total</span> <span class=o>/</span> <span class=n>count</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>averager</span>
</span></span></code></pre></td></tr></table></div></div><p>至此，我们了解了 Python 闭包，下面可以使用嵌套函数正式实现装饰器了。</p><h3 id=实现一个简单的装饰器>实现一个简单的装饰器</h3><p>示例 7-15 定义了一个装饰器，它会在每次调用被装饰的函数时计时，然后把经过的时间、传入的参数和调用的结果打印出来。</p><blockquote><p><strong>示例 7-15</strong>　一个简单的装饰器，输出函数的运行时间</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>clock</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>clocked</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>t0</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>elapsed</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span> <span class=o>-</span> <span class=n>t0</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span> <span class=o>=</span> <span class=n>func</span><span class=o>.</span><span class=vm>__name__</span>
</span></span><span class=line><span class=cl>        <span class=n>arg_str</span> <span class=o>=</span> <span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>repr</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span> <span class=k>for</span> <span class=n>arg</span> <span class=ow>in</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[</span><span class=si>%0.8f</span><span class=s1>s] </span><span class=si>%s</span><span class=s1>(</span><span class=si>%s</span><span class=s1>) -&gt; </span><span class=si>%r</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>elapsed</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>arg_str</span><span class=p>,</span> <span class=n>result</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clocked</span> 
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>示例 7-16</strong>　使用 <code>clock</code> 装饰器</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># clockdeco_demo.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>clockdeco</span> <span class=kn>import</span> <span class=n>clock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@clock</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>snooze</span><span class=p>(</span><span class=n>seconds</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>seconds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@clock</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>factorial</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>n</span> <span class=o>&lt;</span> <span class=mi>2</span> <span class=k>else</span> <span class=n>n</span><span class=o>*</span><span class=n>factorial</span><span class=p>(</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span><span class=o>==</span><span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;*&#39;</span> <span class=o>*</span> <span class=mi>40</span><span class=p>,</span> <span class=s1>&#39;Calling snooze(.123)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>snooze</span><span class=p>(</span><span class=mf>.123</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;*&#39;</span> <span class=o>*</span> <span class=mi>40</span><span class=p>,</span> <span class=s1>&#39;Calling factorial(6)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;6! =&#39;</span><span class=p>,</span> <span class=n>factorial</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ python3 clockdeco_demo.py
</span></span><span class=line><span class=cl>**************************************** Calling snooze<span class=o>(</span>123<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>0.12405610s<span class=o>]</span> snooze<span class=o>(</span>.123<span class=o>)</span> -&gt; None
</span></span><span class=line><span class=cl>**************************************** Calling factorial<span class=o>(</span>6<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>0.00000191s<span class=o>]</span> factorial<span class=o>(</span>1<span class=o>)</span> -&gt; <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=o>[</span>0.00004911s<span class=o>]</span> factorial<span class=o>(</span>2<span class=o>)</span> -&gt; <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=o>[</span>0.00008488s<span class=o>]</span> factorial<span class=o>(</span>3<span class=o>)</span> -&gt; <span class=m>6</span>
</span></span><span class=line><span class=cl><span class=o>[</span>0.00013208s<span class=o>]</span> factorial<span class=o>(</span>4<span class=o>)</span> -&gt; <span class=m>24</span>
</span></span><span class=line><span class=cl><span class=o>[</span>0.00019193s<span class=o>]</span> factorial<span class=o>(</span>5<span class=o>)</span> -&gt; <span class=m>120</span>
</span></span><span class=line><span class=cl><span class=o>[</span>0.00026107s<span class=o>]</span> factorial<span class=o>(</span>6<span class=o>)</span> -&gt; <span class=m>720</span>
</span></span><span class=line><span class=cl>6! <span class=o>=</span> <span class=m>720</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=原理>原理</h4><p>在两个示例中，<code>factorial</code> 会作为 <code>func</code> 参数传给 <code>clock</code>（参见示例 7-15）。然后， <code>clock</code> 函数会返回 <code>clocked</code> 函数，Python 解释器在背后会把 <code>clocked</code> 赋值给 <code>factorial</code>。其实，导入 <code>clockdeco_demo</code> 模块后查看 <code>factorial</code> 的 <code>__name__</code> 属性，会得到如下结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>clockdeco_demo</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>clockdeco_demo</span><span class=o>.</span><span class=n>factorial</span><span class=o>.</span><span class=vm>__name__</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;clocked&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>所以，现在 <code>factorial</code> 保存的是 <code>clocked</code> 函数的引用。自此之后，每次调用 <code>factorial(n)</code>，执行的都是 <code>clocked(n)</code>。</p><h4 id=改进>改进</h4><p>示例 7-15 中实现的 <code>clock</code> 装饰器有几个缺点：</p><ul><li>不支持关键字参数</li><li>遮盖了被装饰函数的 <code>__name__</code> 和 <code>__doc__</code> 属性。</li></ul><p>示例 7-17 使用 <code>functools.wraps</code> 装饰器把相关的属性从 <code>func</code> 复制到 <code>clocked</code> 中。此外，这个新版还能正确处理关键字参数。</p><blockquote><p><strong>示例 7-17</strong>　改进后的 <code>clock</code> 装饰器</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># clockdeco2.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>functools</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>clock</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@functools.wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>clocked</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>t0</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>elapsed</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>t0</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span> <span class=o>=</span> <span class=n>func</span><span class=o>.</span><span class=vm>__name__</span>
</span></span><span class=line><span class=cl>        <span class=n>arg_lst</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>args</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>arg_lst</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>repr</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span> <span class=k>for</span> <span class=n>arg</span> <span class=ow>in</span> <span class=n>args</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>kwargs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>pairs</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;</span><span class=si>%s</span><span class=s1>=</span><span class=si>%r</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>k</span><span class=p>,</span> <span class=n>w</span><span class=p>)</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>w</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>kwargs</span><span class=o>.</span><span class=n>items</span><span class=p>())]</span>
</span></span><span class=line><span class=cl>            <span class=n>arg_lst</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>pairs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>arg_str</span> <span class=o>=</span> <span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>arg_lst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[</span><span class=si>%0.8f</span><span class=s1>s] </span><span class=si>%s</span><span class=s1>(</span><span class=si>%s</span><span class=s1>) -&gt; </span><span class=si>%r</span><span class=s1> &#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>elapsed</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>arg_str</span><span class=p>,</span> <span class=n>result</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clocked</span>
</span></span></code></pre></td></tr></table></div></div><p><code>functools.wraps</code> 只是标准库中拿来即用的装饰器之一。下一节将介绍 <code>functools</code> 模块中最让人印象深刻的两个装饰器：<code>lru_cache</code> 和 <code>singledispatch</code>。</p><h3 id=标准库中的装饰器>标准库中的装饰器</h3><p>Python 内置了三个用于装饰方法的函数：<code>property</code>、<code>classmethod</code> 和 <code>staticmethod</code>。</p><p>另一个常见的装饰器是 <code>functools.wraps</code>，它的作用是协助构建行为良好的装饰器。我们在示例 7-17 中用过。标准库中最值得关注的两个装饰器是 <code>lru_cache</code> 和全新的 <code>singledispatch</code>（Python 3.4 新增）。这两个装饰器都在 <code>functools</code> 模块中定义。接下来分别讨论它们。</p><h4 id=使用-functoolslru_cache-做备忘>使用 <code>functools.lru_cache</code> 做备忘</h4><p><code>functools.lru_cache</code> 是非常实用的装饰器，它实现了<strong>备忘</strong>（memoization）功能。这是一项优化技术，它把耗时的函数的结果保存起来，避免传入相同的参数时重复计算。</p><p>LRU 三个字母是“Least Recently Used”的缩写，表明缓存不会无限制增长，一段时间不用的缓存条目会被扔掉。</p><p>生成第 <em>n</em> 个斐波纳契数这种慢速递归函数适合使用 <code>lru_cache</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>functools</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>clockdeco</span> <span class=kn>import</span> <span class=n>clock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@functools.lru_cache</span><span class=p>()</span> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fibonacci</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>n</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fibonacci</span><span class=p>(</span><span class=n>n</span><span class=o>-</span><span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=n>fibonacci</span><span class=p>(</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span><span class=o>==</span><span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>fibonacci</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>除了优化递归算法之外，<code>lru_cache</code> 在从 Web 中获取信息的应用中也能发挥巨大作用。</p><p>特别要注意，<code>lru_cache</code> 可以使用两个可选的参数来配置。它的签名是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>functools</span><span class=o>.</span><span class=n>lru_cache</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>128</span><span class=p>,</span> <span class=n>typed</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p><code>maxsize</code> 参数指定存储多少个调用的结果。</p><ul><li>缓存满了之后，旧的结果会被扔掉，腾出空间。</li><li>为了得到最佳性能，<code>maxsize</code> 应该设为 2 的幂。</li></ul></li><li><p><code>typed</code> 参数如果设为 <code>True</code>，把不同参数类型得到的结果分开保存，即把通常认为相等的浮点数和整数参数（如 <code>1</code> 和 <code>1.0</code>）区分开。</p><ul><li>顺便说一下，因为 <code>lru_cache</code> 使用字典存储结果，而且键根据调用时传入的定位参数和关键字参数创建，所以被 <code>lru_cache</code> 装饰的函数，它的所有参数都必须是<strong>可散列的</strong>。</li></ul></li></ul><h4 id=单分派泛函数-functoolssingledispatch>单分派泛函数 <code>functools.singledispatch</code></h4><p>假设我们在开发一个调试 Web 应用的工具，我们想生成 HTML，显示不同类型的 Python 对象。</p><p>我们可能会编写这样的函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>html</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>htmlize</span><span class=p>(</span><span class=n>obj</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span> <span class=o>=</span> <span class=n>html</span><span class=o>.</span><span class=n>escape</span><span class=p>(</span><span class=nb>repr</span><span class=p>(</span><span class=n>obj</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;&lt;pre&gt;</span><span class=si>{}</span><span class=s1>&lt;/pre&gt;&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这个函数适用于任何 Python 类型，但是现在我们想做个扩展，让它使用特别的方式显示某些类型。</p><ul><li><code>str</code>：把内部的换行符替换为 <code>'&lt;br>\n'</code>；不使用 <code>&lt;pre></code>，而是使用 <code>&lt;p></code>。</li><li><code>int</code>：以十进制和十六进制显示数字。</li><li><code>list</code>：输出一个 HTML 列表，根据各个元素的类型进行格式化。</li></ul><p>我们想要的行为如示例 7-20 所示。</p><blockquote><p><strong>示例 7-20</strong>　生成 HTML 的 <code>htmlize</code> 函数，调整了几种对象的输出</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>htmlize</span><span class=p>({</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>})</span>  
</span></span><span class=line><span class=cl><span class=s1>&#39;&lt;pre&gt;{1, 2, 3}&lt;/pre&gt;&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>htmlize</span><span class=p>(</span><span class=nb>abs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;&lt;pre&gt;&lt;built-in function abs&gt;&lt;/pre&gt;&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>htmlize</span><span class=p>(</span><span class=s1>&#39;Heimlich &amp; Co.</span><span class=se>\n</span><span class=s1>- a game&#39;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=s1>&#39;&lt;p&gt;Heimlich &amp; Co.&lt;br&gt;</span><span class=se>\n</span><span class=s1>- a game&lt;/p&gt;&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>htmlize</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=s1>&#39;&lt;pre&gt;42 (0x2a)&lt;/pre&gt;&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=n>htmlize</span><span class=p>([</span><span class=s1>&#39;alpha&#39;</span><span class=p>,</span> <span class=mi>66</span><span class=p>,</span> <span class=p>{</span><span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>}]))</span>  
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>ul</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>li</span><span class=o>&gt;&lt;</span><span class=n>p</span><span class=o>&gt;</span><span class=n>alpha</span><span class=o>&lt;/</span><span class=n>p</span><span class=o>&gt;&lt;/</span><span class=n>li</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>li</span><span class=o>&gt;&lt;</span><span class=n>pre</span><span class=o>&gt;</span><span class=mi>66</span> <span class=p>(</span><span class=mh>0x42</span><span class=p>)</span><span class=o>&lt;/</span><span class=n>pre</span><span class=o>&gt;&lt;/</span><span class=n>li</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>li</span><span class=o>&gt;&lt;</span><span class=n>pre</span><span class=o>&gt;</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>}</span><span class=o>&lt;/</span><span class=n>pre</span><span class=o>&gt;&lt;/</span><span class=n>li</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;/</span><span class=n>ul</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>因为 Python 不支持重载方法或函数，所以我们不能使用不同的签名定义 <code>htmlize</code> 的变体，也无法使用不同的方式处理不同的数据类型。</p><p>在 Python 中，一种常见的做法是把 <code>htmlize</code> 变成一个分派函数，使用一串 <code>if/elif/elif</code>，调用专门的函数，如 <code>htmlize_str</code>、<code>htmlize_int</code>，等等。这样不便于模块的用户扩展，还显得笨拙：时间一长，分派函数 <code>htmlize</code> 会变得很大，而且它与各个专门函数之间的耦合也很紧密。</p><p>Python 3.4 新增的 <strong><code>functools.singledispatch</code> 装饰器可以把整体方案拆分成多个模块，甚至可以为你无法修改的类提供专门的函数。</strong></p><p>使用 <code>@singledispatch</code> 装饰的普通函数会变成<strong>泛函数</strong>（generic function）：<strong>根据第一个参数的类型，以不同方式执行相同操作的一组函数</strong></p><blockquote><p><strong>示例 7-21</strong>　<code>singledispatch</code> 创建一个自定义的 <code>htmlize.register</code> 装饰器，把多个函数绑在一起组成一个泛函数</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>singledispatch</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>abc</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numbers</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>html</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@singledispatch</span>  
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>htmlize</span><span class=p>(</span><span class=n>obj</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span> <span class=o>=</span> <span class=n>html</span><span class=o>.</span><span class=n>escape</span><span class=p>(</span><span class=nb>repr</span><span class=p>(</span><span class=n>obj</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;&lt;pre&gt;</span><span class=si>{}</span><span class=s1>&lt;/pre&gt;&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@htmlize.register</span><span class=p>(</span><span class=nb>str</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>_</span><span class=p>(</span><span class=n>text</span><span class=p>):</span>    <span class=c1># 专门函数的名称无关紧要；_ 是个不错的选择，简单明了</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span> <span class=o>=</span> <span class=n>html</span><span class=o>.</span><span class=n>escape</span><span class=p>(</span><span class=n>text</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;&lt;br&gt;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;&lt;p&gt;</span><span class=si>{0}</span><span class=s1>&lt;/p&gt;&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@htmlize.register</span><span class=p>(</span><span class=n>numbers</span><span class=o>.</span><span class=n>Integral</span><span class=p>)</span>  <span class=c1># numbers.Integral 是 int 的虚拟超类</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>_</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;&lt;pre&gt;</span><span class=si>{0}</span><span class=s1> (0x</span><span class=si>{0:x}</span><span class=s1>)&lt;/pre&gt;&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@htmlize.register</span><span class=p>(</span><span class=nb>tuple</span><span class=p>)</span>  <span class=c1># 可以叠放多个 register 装饰器，让同一个函数支持不同类型</span>
</span></span><span class=line><span class=cl><span class=nd>@htmlize.register</span><span class=p>(</span><span class=n>abc</span><span class=o>.</span><span class=n>MutableSequence</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>_</span><span class=p>(</span><span class=n>seq</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>inner</span> <span class=o>=</span> <span class=s1>&#39;&lt;/li&gt;</span><span class=se>\n</span><span class=s1>&lt;li&gt;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>htmlize</span><span class=p>(</span><span class=n>item</span><span class=p>)</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>seq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;&lt;ul&gt;</span><span class=se>\n</span><span class=s1>&lt;li&gt;&#39;</span> <span class=o>+</span> <span class=n>inner</span> <span class=o>+</span> <span class=s1>&#39;&lt;/li&gt;</span><span class=se>\n</span><span class=s1>&lt;/ul&gt;&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>只要可能，注册的专门函数应该处理抽象基类（如 <code>numbers.Integral</code> 和 <code>abc.MutableSequence</code>），不要处理具体实现（如 <code>int</code> 和 <code>list</code>）。</p><p>这样，代码支持的兼容类型更广泛。例如，Python 扩展可以子类化 <code>numbers.Integral</code>，使用固定的位数实现 <code>int</code> 类型。</p><p><code>singledispatch</code> 机制的一个显著特征是，你可以在系统的任何地方和任何模块中注册专门函数。如果后来在新的模块中定义了新的类型，可以轻松地添加一个新的专门函数来处理那个类型。</p><p>此外，你还可以为不是自己编写的或者不能修改的类添加自定义函数。</p><blockquote><p><code>@singledispatch</code> 不是为了把 Java 的那种方法重载带入 Python。在一个类中为同一个方法定义多个重载变体，比在一个函数中使用一长串 <code>if/elif/elif/elif</code> 块要更好。</p><p>但是这两种方案都有缺陷，因为它们让代码单元（类或函数）承担的职责太多。<code>@singledispath</code> 的优点是支持模块化扩展：各个模块可以为它支持的各个类型注册一个专门函数。</p></blockquote><h3 id=叠放装饰器>叠放装饰器</h3><p>把 <code>@d1</code> 和 <code>@d2</code> 两个装饰器按顺序应用到 <code>f</code> 函数上，作用相当于 <code>f = d1(d2(f))</code>。</p><p>也就是说，下述代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=nd>@d1</span>
</span></span><span class=line><span class=cl><span class=nd>@d2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>f</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;f&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>等同于：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>f</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;f&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>f</span> <span class=o>=</span> <span class=n>d1</span><span class=p>(</span><span class=n>d2</span><span class=p>(</span><span class=n>f</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=参数化装饰器>参数化装饰器</h3><p>怎么让装饰器接受其他参数呢？答案是：创建一个装饰器工厂函数，把参数传给它，返回一个装饰器，然后再把它应用到要装饰的函数上。</p><blockquote><p><strong>示例 7-22</strong>　示例 7-2 中 registration.py 模块的删减版，这里再次给出是为了便于讲解</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>registry</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>register</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running register(</span><span class=si>%s</span><span class=s1>)&#39;</span> <span class=o>%</span> <span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>func</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@register</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>f1</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running f1()&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running main()&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;registry -&gt;&#39;</span><span class=p>,</span> <span class=n>registry</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>f1</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=一个参数化的注册装饰器>一个参数化的注册装饰器</h4><p>为了便于启用或禁用 <code>register</code> 执行的函数注册功能，我们为它提供一个可选的 <code>active</code> 参数，设为 <code>False</code> 时，不注册被装饰的函数。实现方式参见示例 7-23。</p><p><strong>从概念上看，这个新的 <code>register</code> 函数不是装饰器，而是装饰器工厂函数。调用它会返回真正的装饰器，这才是应用到目标函数上的装饰器。</strong></p><blockquote><p><strong>示例 7-23</strong>　为了接受参数，新的 <code>register</code> 装饰器必须作为函数调用</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>registry</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>  
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>register</span><span class=p>(</span><span class=n>active</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>decorate</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>  <span class=c1># decorate 这个内部函数是真正的装饰器；注意，它的参数是一个函数</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running register(active=</span><span class=si>%s</span><span class=s1>)-&gt;decorate(</span><span class=si>%s</span><span class=s1>)&#39;</span>
</span></span><span class=line><span class=cl>              <span class=o>%</span> <span class=p>(</span><span class=n>active</span><span class=p>,</span> <span class=n>func</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>active</span><span class=p>:</span>   
</span></span><span class=line><span class=cl>            <span class=n>registry</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>registry</span><span class=o>.</span><span class=n>discard</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>func</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>decorate</span>  <span class=c1># register 是装饰器工厂函数，因此返回 decorate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@register</span><span class=p>(</span><span class=n>active</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>  <span class=c1># @register 工厂函数必须作为函数调用，并且传入所需的参数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>f1</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running f1()&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@register</span><span class=p>()</span>  <span class=c1># 即使不传入参数，register 也必须作为函数调用（@register()），即要返回真正的装饰器 decorate</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>f2</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running f2()&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>f3</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;running f3()&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的关键是，<code>register()</code> 要返回 <code>decorate</code>，然后把它应用到被装饰的函数上</p><p>如果不使用 <code>@</code> 句法，那就要像常规函数那样使用 <code>register</code>；若想把 <code>f</code> 添加到 <code>registry</code> 中，则装饰 <code>f</code> 函数的句法是 <code>register()(f)</code>；不想添加（或把它删除）的话，句法是 <code>register(active=False)(f)</code></p><p>参数化装饰器的原理相当复杂，我们刚刚讨论的那个比大多数都简单。参数化装饰器通常会把被装饰的函数替换掉，而且结构上需要多一层嵌套。接下来会探讨这种函数金字塔</p><h4 id=参数化-clock-装饰器>参数化 <code>clock</code> 装饰器</h4><p>本节再次探讨 <code>clock</code> 装饰器，为它添加一个功能：让用户传入一个格式字符串，控制被装饰函数的输出</p><blockquote><p><strong>示例 7-25</strong>　clockdeco_param.py 模块：参数化 <code>clock</code> 装饰器</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DEFAULT_FMT</span> <span class=o>=</span> <span class=s1>&#39;[</span><span class=si>{elapsed:0.8f}</span><span class=s1>s] </span><span class=si>{name}</span><span class=s1>(</span><span class=si>{args}</span><span class=s1>) -&gt; </span><span class=si>{result}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>clock</span><span class=p>(</span><span class=n>fmt</span><span class=o>=</span><span class=n>DEFAULT_FMT</span><span class=p>):</span>   <span class=c1># 工厂函数</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>decorate</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>       <span class=c1># 真正的装饰器</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>clocked</span><span class=p>(</span><span class=o>*</span><span class=n>_args</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>            <span class=n>t0</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>_result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>_args</span><span class=p>)</span>  <span class=c1># 被装饰的函数返回的真正结果</span>
</span></span><span class=line><span class=cl>            <span class=n>elapsed</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>t0</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span> <span class=o>=</span> <span class=n>func</span><span class=o>.</span><span class=vm>__name__</span>
</span></span><span class=line><span class=cl>            <span class=n>args</span> <span class=o>=</span> <span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>repr</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span> <span class=k>for</span> <span class=n>arg</span> <span class=ow>in</span> <span class=n>_args</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=nb>repr</span><span class=p>(</span><span class=n>_result</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>fmt</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=o>**</span><span class=nb>locals</span><span class=p>()))</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>_result</span>  
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>clocked</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>decorate</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@clock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>snooze</span><span class=p>(</span><span class=n>seconds</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>seconds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>snooze</span><span class=p>(</span><span class=mf>.123</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>clockdeco_param</span> <span class=kn>import</span> <span class=n>clock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@clock</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>{name}</span><span class=s1>(</span><span class=si>{args}</span><span class=s1>) dt=</span><span class=si>{elapsed:0.3f}</span><span class=s1>s&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>snooze</span><span class=p>(</span><span class=n>seconds</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>seconds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>snooze</span><span class=p>(</span><span class=mf>.123</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ python3 clockdeco_param_demo2.py
</span></span><span class=line><span class=cl>snooze<span class=o>(</span>0.123<span class=o>)</span> <span class=nv>dt</span><span class=o>=</span>0.124s
</span></span><span class=line><span class=cl>snooze<span class=o>(</span>0.123<span class=o>)</span> <span class=nv>dt</span><span class=o>=</span>0.124s
</span></span><span class=line><span class=cl>snooze<span class=o>(</span>0.123<span class=o>)</span> <span class=nv>dt</span><span class=o>=</span>0.124s
</span></span></code></pre></td></tr></table></div></div><h2 id=对象引用可变性和垃圾回收>对象引用、可变性和垃圾回收</h2><h3 id=变量不是盒子>变量不是盒子</h3><p>Python 变量类似于 Java 中的<strong>引用</strong>式变量，因此最好把它们理解为<strong>附加在对象上的标注</strong>。</p><p>下面的例子说明了在 Python 中为什么不能使用盒子比喻，而便利贴则指出了变量的正确工作方式。</p><blockquote><p><strong>示例 8-1</strong>　变量 <code>a</code> 和 <code>b</code> 引用同一个列表，而不是那个列表的副本</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span> <span class=o>=</span> <span class=n>a</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>如果把变量想象为盒子，那么无法解释 Python 中的赋值；应该把变量视作便利贴，这样示例 8-1 中的行为就好解释了</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00025.jpeg data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00025.jpeg, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00025.jpeg 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00025.jpeg 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00025.jpeg title={%}></p><p>对引用式变量来说，说把变量分配给对象更合理，反过来说就有问题。毕竟，对象在赋值之前就创建了</p><p>因为变量只不过是标注，所以无法阻止为对象贴上多个标注。贴的多个标注，就是<strong>别名</strong></p><h3 id=标识相等性和别名>标识、相等性和别名</h3><blockquote><p><code>charles</code> 和 <code>lewis</code> 指代同一个对象</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>charles</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;Charles L. Dodgson&#39;</span><span class=p>,</span> <span class=s1>&#39;born&#39;</span><span class=p>:</span> <span class=mi>1832</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>lewis</span> <span class=o>=</span> <span class=n>charles</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>lewis</span> <span class=ow>is</span> <span class=n>charles</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>id</span><span class=p>(</span><span class=n>charles</span><span class=p>),</span> <span class=nb>id</span><span class=p>(</span><span class=n>lewis</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>4300473992</span><span class=p>,</span> <span class=mi>4300473992</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>lewis</span><span class=p>[</span><span class=s1>&#39;balance&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>950</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>charles</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;Charles L. Dodgson&#39;</span><span class=p>,</span> <span class=s1>&#39;balance&#39;</span><span class=p>:</span> <span class=mi>950</span><span class=p>,</span> <span class=s1>&#39;born&#39;</span><span class=p>:</span> <span class=mi>1832</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>示例 8-4</strong>　<code>alex</code> 与 <code>charles</code> 比较的结果是相等，但 <code>alex</code> 不是 <code>charles</code></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>alex</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;Charles L. Dodgson&#39;</span><span class=p>,</span> <span class=s1>&#39;born&#39;</span><span class=p>:</span> <span class=mi>1832</span><span class=p>,</span> <span class=s1>&#39;balance&#39;</span><span class=p>:</span> <span class=mi>950</span><span class=p>}</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>alex</span> <span class=o>==</span> <span class=n>charles</span>  
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>alex</span> <span class=ow>is</span> <span class=ow>not</span> <span class=n>charles</span>  
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><p>示例 8-3 体现了<strong>别名</strong>。在那段代码中，<code>lewis</code> 和 <code>charles</code> 是别名，即两个变量绑定同一个对象。而 <code>alex</code> 不是 <code>charles</code> 的别名，因为二者绑定的是不同的对象。<code>alex</code> 和 <code>charles</code> 绑定的对象具有相同的<strong>值</strong>（<code>==</code> 比较的就是值），但是它们的标识不同。</p><p>每个变量都有标识、类型和值。对象一旦创建，它的标识绝不会变；你可以<strong>把标识理解为对象在内存中的地址</strong>。is 运算符比较两个对象的标识；id() 函数返回对象标识的整数表示。</p><p><strong>对象 ID 的真正意义在不同的实现中有所不同</strong>。在 CPython 中，<code>id()</code> 返回对象的内存地址，但是在其他 Python 解释器中可能是别的值。<strong>关键是，ID 一定是唯一的数值标注，而且在对象的生命周期中绝不会变。</strong></p><p>其实，编程中很少使用 <code>id()</code> 函数。<strong>标识最常使用 <code>is</code> 运算符检查，而不是直接比较 ID</strong></p><h4 id=在--和-is-之间选择>在 <code>==</code> 和 <code>is</code> 之间选择</h4><p><code>**==</code> 运算符比较两个对象的值（对象中保存的数据），而 <code>is</code> 比较对象的标识。**</p><p>通常，我们关注的是值，而不是标识，因此 Python 代码中 <code>==</code> 出现的频率比 <code>is</code> 高。</p><p>然而，在变量和单例值之间比较时，应该使用 <code>is</code>。目前，最常使用 <code>is</code> 检查变量绑定的值是不是 <code>None</code>。下面是推荐的写法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>x</span> <span class=ow>is</span> <span class=kc>None</span>
</span></span></code></pre></td></tr></table></div></div><p>否定的正确写法是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>x</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
</span></span></code></pre></td></tr></table></div></div><p><strong><code>is</code> 运算符比 <code>==</code> 速度快，因为它不能重载</strong>，所以 Python 不用寻找并调用特殊方法，而是直接比较两个整数 ID。</p><p><strong>而 <code>a == b</code> 是语法糖，等同于 <code>a.__eq__(b)</code></strong>。<strong>继承自 <code>object</code> 的 <code>__eq__</code> 方法比较两个对象的 ID，结果与 <code>is</code> 一样</strong>。但是多数内置类型使用更有意义的方式覆盖了 <code>__eq__</code> 方法，会考虑对象属性的值。相等性测试可能涉及大量处理工作，例如，比较大型集合或嵌套层级深的结构时。</p><h4 id=元组的相对不可变性>元组的相对不可变性</h4><p>元组与多数 Python 集合（列表、字典、集，等等）一样，保存的是对象的引用。如果引用的元素是可变的，即便元组本身不可变，元素依然可变。</p><p>而 <code>str</code>、<code>bytes</code> 和 <code>array.array</code> 等单一类型序列是扁平的，它们保存的不是引用，而是在连续的内存中保存数据本身（字符、字节和数字）</p><p>也就是说，元组的不可变性其实是指 <strong><code>tuple</code> 数据结构的物理内容（即保存的引用）不可变，与引用的对象无关</strong>。</p><h3 id=默认做浅复制>默认做浅复制</h3><p>复制列表（或多数内置的可变集合）最简单的方式是使用内置的类型构造方法。例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l1</span> <span class=o>=</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=p>[</span><span class=mi>55</span><span class=p>,</span> <span class=mi>44</span><span class=p>],</span> <span class=p>(</span><span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l2</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>l1</span><span class=p>)</span>  <span class=c1># list(l1) 创建 l1 的副本</span>
</span></span><span class=line><span class=cl>				   <span class=c1># 对列表和其他可变序列来说，还能使用简洁的 l2 = l1[:] 语句创建副本</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l2</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=p>[</span><span class=mi>55</span><span class=p>,</span> <span class=mi>44</span><span class=p>],</span> <span class=p>(</span><span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l2</span> <span class=o>==</span> <span class=n>l1</span>  
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>l2</span> <span class=ow>is</span> <span class=n>l1</span>  
</span></span><span class=line><span class=cl><span class=kc>False</span>
</span></span></code></pre></td></tr></table></div></div><p><code>l1</code> 和 <code>l2</code> 指代不同的列表，但是二者引用同一个列表 <code>[66, 55, 44]</code> 和元组 <code>(7, 8, 9)</code></p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00027.jpeg data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00027.jpeg, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00027.jpeg 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00027.jpeg 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00027.jpeg title={%}></p><blockquote><p><strong>示例 8-6</strong>　为一个包含另一个列表的列表做浅复制；把这段代码复制粘贴到 Python Tutor 网站中，看看动画效果</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>l1</span> <span class=o>=</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=p>[</span><span class=mi>66</span><span class=p>,</span> <span class=mi>55</span><span class=p>,</span> <span class=mi>44</span><span class=p>],</span> <span class=p>(</span><span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>l2</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>l1</span><span class=p>)</span>     
</span></span><span class=line><span class=cl><span class=n>l1</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>     <span class=c1># 把 100 追加到 l1 中，对 l2 没有影响</span>
</span></span><span class=line><span class=cl><span class=n>l1</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=mi>55</span><span class=p>)</span>   <span class=c1># 把内部列表 l1[1] 中的 55 删除。这对 l2 有影响，因为 l2[1] 绑定的列表与 l1[1] 是同一个</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;l1:&#39;</span><span class=p>,</span> <span class=n>l1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;l2:&#39;</span><span class=p>,</span> <span class=n>l2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>l2</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>+=</span> <span class=p>[</span><span class=mi>33</span><span class=p>,</span> <span class=mi>22</span><span class=p>]</span>  <span class=c1># 对可变的对象来说，如 l2[1] 引用的列表，+= 运算符就地修改列表。这次修改在 l1[1] 中也有体现，因为它是 l2[1] 的别名</span>
</span></span><span class=line><span class=cl><span class=n>l2</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>+=</span> <span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>11</span><span class=p>)</span>  <span class=c1># 对元组来说，+= 运算符创建一个新元组，然后重新绑定给变量 l2[2]。这等同于 l2[2] = l2[2] + (10, 11)。现在，l1 和 l2 中最后位置上的元组不是同一个对象</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;l1:&#39;</span><span class=p>,</span> <span class=n>l1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;l2:&#39;</span><span class=p>,</span> <span class=n>l2</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>示例 8-7</strong>　示例 8-6 的输出</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>l1</span><span class=p>:</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=p>[</span><span class=mi>66</span><span class=p>,</span> <span class=mi>44</span><span class=p>],</span> <span class=p>(</span><span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>),</span> <span class=mi>100</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>l2</span><span class=p>:</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=p>[</span><span class=mi>66</span><span class=p>,</span> <span class=mi>44</span><span class=p>],</span> <span class=p>(</span><span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>l1</span><span class=p>:</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=p>[</span><span class=mi>66</span><span class=p>,</span> <span class=mi>44</span><span class=p>,</span> <span class=mi>33</span><span class=p>,</span> <span class=mi>22</span><span class=p>],</span> <span class=p>(</span><span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>),</span> <span class=mi>100</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>l2</span><span class=p>:</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=p>[</span><span class=mi>66</span><span class=p>,</span> <span class=mi>44</span><span class=p>,</span> <span class=mi>33</span><span class=p>,</span> <span class=mi>22</span><span class=p>],</span> <span class=p>(</span><span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>11</span><span class=p>)]</span>
</span></span></code></pre></td></tr></table></div></div><p><code>l1</code> 和 <code>l2</code> 的最终状态：二者依然引用同一个列表对象，现在列表的值是 <code>[66, 44, 33, 22]</code>，不过 <code>l2[2] += (10, 11)</code> 创建一个新元组，内容是 <code>(7, 8, 9, 10, 11)</code>，它与 <code>l1[2]</code> 引用的元组 <code>(7, 8, 9)</code> 无关</p><p><img class=lazyload src=/Notes/svg/loading.min.svg data-src=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00028.jpeg data-srcset="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00028.jpeg, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00028.jpeg 1.5x, https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00028.jpeg 2x" data-sizes=auto alt=https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/00028.jpeg title={%}></p><p>浅复制容易操作，但是得到的结果可能并不是你想要的</p><h4 id=为任意对象做深复制和浅复制>为任意对象做深复制和浅复制</h4><p>浅复制没什么问题，但有时我们需要的是<strong>深复制</strong>（<strong>即副本不共享内部对象的引用</strong>）。</p><p><code>copy</code> 模块提供的 <code>deepcopy</code> 和 <code>copy</code> 函数能为任意对象做深复制和浅复制。</p><p>注意，一般来说，深复制不是件简单的事。如果对象有循环引用，那么这个朴素的算法会进入无限循环。<code>deepcopy</code> 函数会记住已经复制的对象，因此能优雅地处理循环引用</p><blockquote><p><strong>示例 8-10</strong>　循环引用：<code>b</code> 引用 <code>a</code>，然后追加到 <code>a</code> 中；<code>deepcopy</code> 会想办法复制 <code>a</code></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=o>=</span> <span class=p>[</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span> <span class=o>=</span> <span class=p>[</span><span class=n>a</span><span class=p>,</span> <span class=mi>30</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=p>[[</span><span class=o>...</span><span class=p>],</span> <span class=mi>30</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>copy</span> <span class=kn>import</span> <span class=n>deepcopy</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>c</span> <span class=o>=</span> <span class=n>deepcopy</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>c</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=p>[[</span><span class=o>...</span><span class=p>],</span> <span class=mi>30</span><span class=p>]]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=函数的参数作为引用时>函数的参数作为引用时</h3><p>Python 唯一支持的参数传递模式是<strong>共享传参</strong>（call by sharing）。多数面向对象语言都采用这一模式，包括 Ruby、Smalltalk 和 Java（Java 的引用类型是这样，基本类型按值传参）。</p><p>共享传参指函数的各个形式参数获得实参中各个引用的副本。也就是说，<strong>函数内部的形参是实参的别名</strong></p><p>这种方案的结果是，<strong>函数可能会修改作为参数传入的可变对象，但是无法修改那些对象的标识（即不能把一个对象替换成另一个对象）</strong></p><blockquote><p><strong>示例 8-11</strong>　函数可能会修改接收到的任何可变对象</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>f</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>a</span> <span class=o>+=</span> <span class=n>b</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=n>a</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>f</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span>  <span class=c1># 没变</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span> <span class=o>=</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>f</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span>  <span class=c1># 变了 因为列表的+=是原地进行的</span>
</span></span><span class=line><span class=cl><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>],</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>t</span> <span class=o>=</span> <span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>u</span> <span class=o>=</span> <span class=p>(</span><span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>f</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>u</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>t</span><span class=p>,</span> <span class=n>u</span> <span class=c1># 没变 因为元组的+=是新建对象</span>
</span></span><span class=line><span class=cl><span class=p>((</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>),</span> <span class=p>(</span><span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=不要使用可变类型作为参数的默认值>不要使用可变类型作为参数的默认值</h4><p>一个正常的 <code>Bus</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>Bus</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>passengers</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>passengers</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>passengers</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>passengers</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>passengers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>pick</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>passengers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>drop</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>passengers</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>我们以 <code>Bus</code> 类为基础定义一个新类， <code>HauntedBus</code>，然后修改 <code>__init__</code> 方法。这一次，<code>passengers</code> 的默认值不是 <code>None</code>，而是 <code>[]</code>，这样就不用像之前那样使用 <code>if</code> 判断了。这个“聪明的举动”会让我们陷入麻烦。</p><blockquote><p><strong>示例 8-12</strong>　一个简单的类，说明可变默认值的危险</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>HauntedBus</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;备受幽灵乘客折磨的校车&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>passengers</span><span class=o>=</span><span class=p>[]):</span>  
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>passengers</span> <span class=o>=</span> <span class=n>passengers</span>  <span class=c1># 这个赋值语句把 self.passengers 变成 passengers 的别名，而没有传入 passengers 参数时，后者又是默认列表的别名</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pick</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>passengers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>  <span class=c1>#  在 self.passengers 上调用 .remove() 和 .append() 方法时，修改的其实是默认列表，它是函数对象的一个属性。</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>drop</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>passengers</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>HauntedBus</code> 的诡异行为如示例 8-13 所示。</p><blockquote><p><strong>示例 8-13</strong>　备受幽灵乘客折磨的校车</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus1</span> <span class=o>=</span> <span class=n>HauntedBus</span><span class=p>([</span><span class=s1>&#39;Alice&#39;</span><span class=p>,</span> <span class=s1>&#39;Bill&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus1</span><span class=o>.</span><span class=n>passengers</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;Alice&#39;</span><span class=p>,</span> <span class=s1>&#39;Bill&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus1</span><span class=o>.</span><span class=n>pick</span><span class=p>(</span><span class=s1>&#39;Charlie&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus1</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span><span class=s1>&#39;Alice&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus1</span><span class=o>.</span><span class=n>passengers</span>  <span class=c1># 目前为止一切正常</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;Bill&#39;</span><span class=p>,</span> <span class=s1>&#39;Charlie&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus2</span> <span class=o>=</span> <span class=n>HauntedBus</span><span class=p>()</span>  <span class=c1># 一开始，bus2 是空的，因此把默认的空列表赋值给 self.passengers</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus2</span><span class=o>.</span><span class=n>pick</span><span class=p>(</span><span class=s1>&#39;Carrie&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus2</span><span class=o>.</span><span class=n>passengers</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;Carrie&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus3</span> <span class=o>=</span> <span class=n>HauntedBus</span><span class=p>()</span>  <span class=c1># 寄，现在形参 passengers 的默认值成了[&#39;Carrie&#39;]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus3</span><span class=o>.</span><span class=n>passengers</span>  
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;Carrie&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus3</span><span class=o>.</span><span class=n>pick</span><span class=p>(</span><span class=s1>&#39;Dave&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus2</span><span class=o>.</span><span class=n>passengers</span>  <span class=c1># 登上 bus3 的 Dave 出现在 bus2 中</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;Carrie&#39;</span><span class=p>,</span> <span class=s1>&#39;Dave&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus2</span><span class=o>.</span><span class=n>passengers</span> <span class=ow>is</span> <span class=n>bus3</span><span class=o>.</span><span class=n>passengers</span>  <span class=c1># bus2.passengers 和 bus3.passengers 指代同一个列表</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus1</span><span class=o>.</span><span class=n>passengers</span>  <span class=c1># 但 bus1.passengers 是不同的列表</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;Bill&#39;</span><span class=p>,</span> <span class=s1>&#39;Charlie&#39;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>问题在于，没有指定初始乘客的 <code>HauntedBus</code> 实例会共享同一个乘客列表</p><p>⭐ <strong>出现这个问题的根源是，默认值在定义函数时计算（通常在加载模块时），因此默认值变成了函数对象的属性。因此，如果默认值是可变对象，而且修改了它的值，那么后续的函数调用都会受到影响。</strong></p><p>运行示例 8-13 中的代码之后，可以审查 <code>HauntedBus.__init__</code> 对象，看看它的 <code>__defaults__</code> 属性中的那些幽灵学生：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>dir</span><span class=p>(</span><span class=n>HauntedBus</span><span class=o>.</span><span class=fm>__init__</span><span class=p>)</span>  <span class=c1># doctest: +ELLIPSIS</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;__annotations__&#39;</span><span class=p>,</span> <span class=s1>&#39;__call__&#39;</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=s1>&#39;__defaults__&#39;</span><span class=p>,</span> <span class=o>...</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>HauntedBus</span><span class=o>.</span><span class=fm>__init__</span><span class=o>.</span><span class=vm>__defaults__</span>
</span></span><span class=line><span class=cl><span class=p>([</span><span class=s1>&#39;Carrie&#39;</span><span class=p>,</span> <span class=s1>&#39;Dave&#39;</span><span class=p>],)</span>
</span></span></code></pre></td></tr></table></div></div><p>最后，我们可以验证 <code>bus2.passengers</code> 是一个别名，它绑定到 <code>HauntedBus.__init__.__defaults__</code> 属性的第一个元素上：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>HauntedBus</span><span class=o>.</span><span class=fm>__init__</span><span class=o>.</span><span class=vm>__defaults__</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=ow>is</span> <span class=n>bus2</span><span class=o>.</span><span class=n>passengers</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><p>可变默认值导致的这个问题说明了为什么通常使用 <code>None</code> 作为接收可变值的参数的默认值</p><h4 id=防御可变参数>防御可变参数</h4><p>如果定义的函数接收可变参数，应该谨慎考虑调用方是否期望修改传入的参数。</p><p>例如，如果函数接收一个字典，而且在处理的过程中要修改它，那么这个副作用要不要体现到函数外部？具体情况具体分析。这其实需要函数的编写者和调用方达成共识。</p><p>在本章最后一个校车示例中，<code>TwilightBus</code> 实例与客户共享乘客列表，这会产生意料之外的结果。在分析实现之前，我们先从客户的角度看看 <code>TwilightBus</code> 类是如何工作的。</p><blockquote><p><strong>示例 8-14</strong>　从 <code>TwilightBus</code> 下车后，乘客消失了</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>basketball_team</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Sue&#39;</span><span class=p>,</span> <span class=s1>&#39;Tina&#39;</span><span class=p>,</span> <span class=s1>&#39;Maya&#39;</span><span class=p>,</span> <span class=s1>&#39;Diana&#39;</span><span class=p>,</span> <span class=s1>&#39;Pat&#39;</span><span class=p>]</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus</span> <span class=o>=</span> <span class=n>TwilightBus</span><span class=p>(</span><span class=n>basketball_team</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span><span class=s1>&#39;Tina&#39;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>bus</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span><span class=s1>&#39;Pat&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>basketball_team</span>  
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;Sue&#39;</span><span class=p>,</span> <span class=s1>&#39;Maya&#39;</span><span class=p>,</span> <span class=s1>&#39;Diana&#39;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p><code>TwilightBus</code> 违反了设计接口的最佳实践，即“最少惊讶原则”。学生从校车中下车后，她的名字就从篮球队的名单中消失了，这确实让人惊讶。</p><p>示例 8-15 是 <code>TwilightBus</code> 的实现，随后解释了出现这个问题的原因。</p><blockquote><p><strong>示例 8-15</strong>　一个简单的类，说明接受可变参数的风险</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>TwilightBus</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;让乘客销声匿迹的校车&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>passengers</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>passengers</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>passengers</span> <span class=o>=</span> <span class=p>[]</span>  <span class=err>➊</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>passengers</span> <span class=o>=</span> <span class=n>passengers</span>  <span class=c1># 这个赋值语句把 self.passengers 变成 passengers 的别名，而后者是传给 __init__ 方法的实参的别名</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>pick</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>passengers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>drop</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>passengers</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>  <span class=c1># 在 self.passengers 上调用 .remove() 和 .append() 方法其实会修改传给构造方法的那个列表</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的问题是，校车为传给构造方法的列表创建了别名。正确的做法是，<strong>校车自己维护乘客列表</strong>。</p><p>修正的方法很简单：在 <code>__init__</code> 中，传入 <code>passengers</code> 参数时，应该把参数值的<strong>副本</strong>赋值给 <code>self.passengers</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>passengers</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>passengers</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>passengers</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>passengers</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>passengers</span><span class=p>)</span>  <span class=c1># 创建 passengers 列表的副本；如果不是列表，就把它转换成列表。</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>除非这个方法确实想修改通过参数传入的对象，否则在类中直接把参数赋值给实例变量之前一定要三思，因为这样会为参数对象创建别名。如果不确定，那就创建副本。这样客户会少些麻烦。</p></blockquote><h3 id=del-和垃圾回收><code>del</code> 和垃圾回收</h3><p><strong><code>del</code> 语句删除名称，而不是对象。<code>del</code> 命令可能会导致对象被当作垃圾回收，但是仅当删除的变量保存的是对象的最后一个引用，或者无法得到对象时。</strong></p><p>重新绑定也可能会导致对象的引用数量归零，导致对象被销毁。</p><p>如果两个对象相互引用，当它们的引用只存在二者之间时，垃圾回收程序会判定它们都无法获取，进而把它们都销毁。</p><blockquote><p>有个 <code>__del__</code> 特殊方法，但是它不会销毁实例，不应该在代码中调用。即将销毁实例时，Python 解释器会调用 <code>__del__</code> 方法，给实例最后的机会，释放外部资源。自己编写的代码很少需要实现 <code>__del__</code> 代码，有些 Python 新手会花时间实现，但却吃力不讨好，因为 <code>__del__</code> 很难用对</p></blockquote><p>在 CPython 中，垃圾回收使用的主要算法是<strong>引用计数</strong>。实际上，每个对象都会统计有多少引用指向自己。当<strong>引用计数</strong>归零时，对象立即就被销毁：CPython 会在对象上调用 <code>__del__</code> 方法（如果定义了），然后释放分配给对象的内存</p><p>CPython2.0 增加了<strong>分代垃圾回收</strong>算法，用于检测引用循环中涉及的对象组——如果一组对象之间全是相互引用，即使再出色的引用方式也会导致组中的对象不可获取。Python 的其他实现有更复杂的垃圾回收程序，而且不依赖引用计数，这意味着，对象的引用数量为零时可能不会立即调用 <code>__del__</code> 方法</p><p>为了演示对象生命结束时的情形，示例 8-16 使用 <code>weakref.finalize</code> 注册一个回调函数，在销毁对象时调用。</p><blockquote><p><strong>示例 8-16</strong>　没有指向对象的引用时，监视对象生命结束时的情形</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>weakref</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s1</span> <span class=o>=</span> <span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s2</span> <span class=o>=</span> <span class=n>s1</span>       
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>bye</span><span class=p>():</span>    <span class=c1># 这个函数一定不能是要销毁的对象的绑定方法，否则会有一个指向对象的引用</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Gone    with the wind...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>ender</span> <span class=o>=</span> <span class=n>weakref</span><span class=o>.</span><span class=n>finalize</span><span class=p>(</span><span class=n>s1</span><span class=p>,</span> <span class=n>bye</span><span class=p>)</span>  <span class=c1># 在 s1 引用的对象上注册 bye 回调</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>ender</span><span class=o>.</span><span class=n>alive</span>  <span class=c1># 调用 finalize 对象之前，.alive 属性的值为 True</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>del</span> <span class=n>s1</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>ender</span><span class=o>.</span><span class=n>alive</span>  <span class=c1># del 不删除对象，而是删除对象的引用</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s2</span> <span class=o>=</span> <span class=s1>&#39;spam&#39;</span>  <span class=c1># 重新绑定最后一个引用 s2，让 {1, 2, 3} 无法获取。对象被销毁了，调用了 bye 回调，ender.alive 的值变成了 False</span>
</span></span><span class=line><span class=cl><span class=n>Gone</span> <span class=k>with</span> <span class=n>the</span> <span class=n>wind</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>ender</span><span class=o>.</span><span class=n>alive</span>
</span></span><span class=line><span class=cl><span class=kc>False</span>
</span></span></code></pre></td></tr></table></div></div><p>示例 8-16 的目的是明确指出 <code>del</code> 不会删除对象，但是执行 <code>del</code> 操作后可能会导致对象不可获取，从而被删除</p><p>你可能觉得奇怪，为什么示例 8-16 中的 <code>{1, 2, 3}</code> 对象被销毁了？毕竟，我们把 <code>s1</code> 引用传给 <code>finalize</code> 函数了，而为了监控对象和调用回调，必须要有引用。这是因为，<code>finalize</code> 持有 <code>{1, 2, 3}</code> 的<strong>弱引用</strong>，参见下一节。</p><h3 id=弱引用>弱引用</h3><p>正是因为有引用，对象才会在内存中存在。当对象的引用数量归零后，垃圾回收程序会把对象销毁。但是，有时需要引用对象，而不让对象存在的时间超过所需时间。这经常用在缓存中。</p><p>弱引用不会增加对象的引用数量。引用的目标对象称为<strong>所指对象</strong>（referent）。因此我们说，弱引用不会妨碍所指对象被当作垃圾回收。</p><p>弱引用在缓存应用中很有用，因为我们不想仅因为被缓存引用着而始终保存缓存对象。</p><p>示例 8-17 展示了如何使用 <code>weakref.ref</code> 实例获取所指对象。如果对象存在，调用弱引用可以获取对象；否则返回 <code>None</code>。</p><blockquote><p><strong>示例 8-17</strong>　弱引用是可调用的对象，返回的是被引用的对象；如果所指对象不存在了，返回 <code>None</code></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>weakref</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a_set</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>wref</span> <span class=o>=</span> <span class=n>weakref</span><span class=o>.</span><span class=n>ref</span><span class=p>(</span><span class=n>a_set</span><span class=p>)</span>  <span class=c1># 创建弱引用对象 wref</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>wref</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>weakref</span> <span class=n>at</span> <span class=mh>0x100637598</span><span class=p>;</span> <span class=n>to</span> <span class=s1>&#39;set&#39;</span> <span class=n>at</span> <span class=mh>0x100636748</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>wref</span><span class=p>()</span>  <span class=c1># 调用 wref() 返回的是被引用的对象，{0, 1}。因为这是控制台会话，所以 {0, 1} 会绑定给 _ 变量</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a_set</span> <span class=o>=</span> <span class=p>{</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>}</span>  <span class=c1># a_set 不再指代 {0, 1} 集合，因此集合的引用数量减少了。但是 _ 变量仍然指代它</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>wref</span><span class=p>()</span>  <span class=c1># 调用 wref() 依旧返回 {0, 1}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>wref</span><span class=p>()</span> <span class=ow>is</span> <span class=kc>None</span>  <span class=c1># 计算这个表达式时，{0, 1} 存在，因此 wref() 不是 None。但是，随后 _ 绑定到结果值 False。现在 {0, 1} 没有强引用了</span>
</span></span><span class=line><span class=cl><span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>wref</span><span class=p>()</span> <span class=ow>is</span> <span class=kc>None</span>  <span class=c1># 因为 {0, 1} 对象不存在了，所以 wref() 返回 None</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><p>示例 8-17 是一个控制台会话，<strong>Python 控制台会自动把 <code>_</code> 变量绑定到结果不为 <code>None</code> 的表达式结果上。</strong></p><p>这对我想演示的行为有影响，不过却凸显了一个实际问题：微观管理内存时，往往会得到意外的结果，因为不明显的隐式赋值会为对象创建新引用。控制台中的 <code>_</code> 变量是一例。调用跟踪对象也常导致意料之外的引用。</p><blockquote><p><code>weakref.ref</code> 类其实是低层接口，供高级用途使用，多数程序最好使用 <code>weakref</code> 集合和 <code>finalize</code>。也就是说，应该使用 <code>WeakKeyDictionary</code>、<code>WeakValueDictionary</code>、<code>WeakSet</code> 和 <code>finalize</code>（在内部使用弱引用），不要自己动手创建并处理 <code>weakref.ref</code> 实例。我们在示例 8-17 中那么做是希望借助实际使用 <code>weakref.ref</code> 来褪去它的神秘色彩。但是实际上，多数时候 Python 程序都使用 <code>weakref</code> 集合。</p></blockquote><h4 id=weakvaluedictionary-简介><code>WeakValueDictionary</code> 简介</h4><p><code>WeakValueDictionary</code> 类实现的是一种可变映射，里面的值是对象的弱引用。</p><p>被引用的对象在程序中的其他地方被当作垃圾回收后，对应的键会自动从 <code>WeakValueDictionary</code> 中删除。因此，<code>WeakValueDictionary</code> 经常用于缓存。</p><blockquote><p><strong>示例 8-18</strong>　<code>Cheese</code> 有个 <code>kind</code> 属性和标准的字符串表示形式</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>Cheese</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>kind</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>kind</span> <span class=o>=</span> <span class=n>kind</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;Cheese(</span><span class=si>%r</span><span class=s1>)&#39;</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>kind</span>
</span></span></code></pre></td></tr></table></div></div><p>在示例 8-19 中，我们把 <code>catalog</code> 中的各种奶酪载入 <code>WeakValueDictionary</code> 实现的 <code>stock</code> 中。然而，删除 <code>catalog</code> 后，<code>stock</code> 中只剩下一种奶酪了。</p><blockquote><p><strong>示例 8-19</strong>　顾客：“你们店里到底有没有奶酪？”</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>weakref</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>stock</span> <span class=o>=</span> <span class=n>weakref</span><span class=o>.</span><span class=n>WeakValueDictionary</span><span class=p>()</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>catalog</span> <span class=o>=</span> <span class=p>[</span><span class=n>Cheese</span><span class=p>(</span><span class=s1>&#39;Red Leicester&#39;</span><span class=p>),</span> <span class=n>Cheese</span><span class=p>(</span><span class=s1>&#39;Tilsit&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=o>...</span>                 <span class=n>Cheese</span><span class=p>(</span><span class=s1>&#39;Brie&#39;</span><span class=p>),</span> <span class=n>Cheese</span><span class=p>(</span><span class=s1>&#39;Parmesan&#39;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>for</span> <span class=n>cheese</span> <span class=ow>in</span> <span class=n>catalog</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>stock</span><span class=p>[</span><span class=n>cheese</span><span class=o>.</span><span class=n>kind</span><span class=p>]</span> <span class=o>=</span> <span class=n>cheese</span>  
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>stock</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;Brie&#39;</span><span class=p>,</span> <span class=s1>&#39;Parmesan&#39;</span><span class=p>,</span> <span class=s1>&#39;Red Leicester&#39;</span><span class=p>,</span> <span class=s1>&#39;Tilsit&#39;</span><span class=p>]</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>del</span> <span class=n>catalog</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>stock</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;Parmesan&#39;</span><span class=p>]</span>  <span class=c1># cheese 实际上还引用着它</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>del</span> <span class=n>cheese</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>stock</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>[]</span>
</span></span></code></pre></td></tr></table></div></div><p>临时变量引用了对象，这可能会导致该变量的存在时间比预期长。通常，这对局部变量来说不是问题，因为它们在函数返回时会被销毁。</p><p>但是在示例 8-19 中，<code>for</code> 循环中的变量 <code>cheese</code> 是全局变量，除非显式删除，否则不会消失。</p><p>与 <code>WeakValueDictionary</code> 对应的是 <code>WeakKeyDictionary</code>，后者的键是弱引用。它可以为应用中其他部分拥有的对象附加数据，这样就无需为对象添加属性。这对覆盖属性访问权限的对象尤其有用。</p><p><code>weakref</code> 模块还提供了 <code>WeakSet</code> 类，按照文档的说明，这个类的作用很简单：“保存元素弱引用的集合类。元素没有强引用时，集合会把它删除。”如果一个类需要知道所有实例，一种好的方案是创建一个 <code>WeakSet</code> 类型的类属性，保存实例的引用。如果使用常规的 <code>set</code>，实例永远不会被垃圾回收，因为类中有实例的强引用，而类存在的时间与 Python 进程一样长，除非显式删除类。</p><h4 id=弱引用的局限>弱引用的局限</h4><p>不是每个 Python 对象都可以作为弱引用的目标（或称所指对象）。</p><p><strong>基本的 <code>list</code> 和 <code>dict</code> 实例不能作为所指对象</strong>，但是它们的子类可以轻松地解决这个问题：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyList</span><span class=p>(</span><span class=nb>list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;list的子类，实例可以作为弱引用的目标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>a_list</span> <span class=o>=</span> <span class=n>MyList</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># a_list可以作为弱引用的目标</span>
</span></span><span class=line><span class=cl><span class=n>wref_to_a_list</span> <span class=o>=</span> <span class=n>weakref</span><span class=o>.</span><span class=n>ref</span><span class=p>(</span><span class=n>a_list</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>set</code> 实例可以作为所指对象。用户定义的类型也没问题，这就解释了示例 8-19 中为什么使用那个简单的 <code>Cheese</code> 类。</p><p><strong>但是，<code>int</code> 和 <code>tuple</code> 实例不能作为弱引用的目标，甚至它们的子类也不行。</strong></p><p>这些局限基本上是 CPython 的实现细节，在其他 Python 解释器中情况可能不一样。这些局限是内部优化导致的结果</p><h3 id=python-对不可变类型施加的把戏>Python 对不可变类型施加的把戏</h3><p><strong>对元组 <code>t</code> 来说，<code>t[:]</code> 不创建副本，而是返回同一个对象的引用</strong>。<strong>此外，<code>tuple(t)</code> 获得的也是同一个元组的引用</strong></p><blockquote><p>文档明确指出了这个行为。在 Python 控制台中输入 <code>help(tuple)</code>，你会看到这句话：“如果参数是一个元组，那么返回值是同一个对象。</p></blockquote><blockquote><p><strong>示例 8-20</strong>　使用另一个元组构建元组，得到的其实是同一个元组</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>t1</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>t2</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>t1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>t2</span> <span class=ow>is</span> <span class=n>t1</span>  
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>t3</span> <span class=o>=</span> <span class=n>t1</span><span class=p>[:]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>t3</span> <span class=ow>is</span> <span class=n>t1</span>  
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><p><code>str</code>、<code>bytes</code> 和 <code>frozenset</code> 实例也有这种行为。注意，<code>frozenset</code> 实例不是序列，因此不能使用 <code>fs[:]</code>（<code>fs</code> 是一个 <code>frozenset</code> 实例）。但是，<code>fs.copy()</code> 具有相同的效果：它会欺骗你，返回同一个对象的引用，而不是创建一个副本（tuple 同理）</p><blockquote><p><strong><code>copy</code> 方法不会复制所有对象，这是一个善意的谎言，为的是接口的兼容性</strong>：这使得 <code>frozenset</code> 的兼容性比 <code>set</code> 强。两个不可变对象是同一个对象还是副本，反正对最终用户来说没有区别。</p></blockquote><blockquote><p><strong>示例 8-21</strong>　字符串字面量可能会创建共享的对象</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>t1</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>t3</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>t3</span> <span class=ow>is</span> <span class=n>t1</span>  <span class=c1># t1 和 t3 相等，但不是同一个对象</span>
</span></span><span class=line><span class=cl><span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s1</span> <span class=o>=</span> <span class=s1>&#39;ABC&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s2</span> <span class=o>=</span> <span class=s1>&#39;ABC&#39;</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s2</span> <span class=ow>is</span> <span class=n>s1</span>  <span class=c1># 奇怪的事发生了，a 和 b 指代同一个字符串</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><p>共享字符串字面量是一种优化措施，称为<strong>驻留</strong>（interning）。CPython 还会在小的整数上使用这个优化措施，防止重复创建“热门”数字，如 0、-1 和 42。</p><p>注意，CPython 不会驻留所有字符串和整数，驻留的条件是实现细节，而且没有文档说明。</p><blockquote><p>千万不要依赖字符串或整数的驻留！比较字符串或整数是否相等时，应该使用 <code>==</code>，而不是 <code>is</code>。驻留是 Python 解释器内部使用的一个特性</p></blockquote><p>本节讨论的把戏，包括 <code>frozenset.copy()</code> 的行为，是“善意的谎言”，能节省内存，提升解释器的速度。别担心，它们不会为你带来任何麻烦，因为只有不可变类型会受到影响。或许这些细枝末节的最佳用途是与其他 Python 程序员打赌，提高自己的胜算</p><h3 id=细节>细节</h3><ul><li><p>其实，对象的类型也可以变，方法只有一种：为 <code>__class__</code> 属性指定其他类。但这是在作恶。</p></li><li><p>在“纯”函数式编程中，所有数据都是不可变的，如果为集合追加元素，那么其实会创建新的集合</p></li></ul><h2 id=符合-python-风格的对象>符合 Python 风格的对象</h2><p>在本章中，我们将开发一个简单的二维欧几里得向量类型</p><h3 id=对象表示形式>对象表示形式</h3><p>每门面向对象的语言至少都有一种获取对象的字符串表示形式的标准方式。Python 提供了两种方式。</p><ul><li><p><code>repr()</code>：以便于开发者理解的方式返回对象的字符串表示形式。</p></li><li><p><code>str()</code>：以便于用户理解的方式返回对象的字符串表示形式。</p></li></ul><blockquote><p>在 Python 3 中，<code>__repr__</code>、<code>__str__</code> 和 <code>__format__</code> 都必须返回 Unicode 字符串（<code>str</code> 类型）。只有 <code>__bytes__</code> 方法应该返回字节序列（<code>bytes</code> 类型）</p></blockquote><h3 id=构建向量类>构建向量类</h3><blockquote><p>示例 9-2　vector2d_v0.py：目前定义的都是特殊方法</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>array</span> <span class=kn>import</span> <span class=n>array</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>math</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Vector2d</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>typecode</span> <span class=o>=</span> <span class=s1>&#39;d&#39;</span> <span class=c1># typecode 是类属性，在 Vector2d 实例和字节序列之间转换时使用</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>   <span class=err>➋</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__iter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>        定义 __iter__ 方法，把 Vector2d 实例变成可迭代的对象
</span></span></span><span class=line><span class=cl><span class=s1>        这样才能拆包（例如，x, y = my_vector）
</span></span></span><span class=line><span class=cl><span class=s1>        这个方法的实现方式很简单，直接调用生成器表达式一个接一个产出分量
</span></span></span><span class=line><span class=cl><span class=s1>        可以写成 yield self.x; yield.self.y
</span></span></span><span class=line><span class=cl><span class=s1>        &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>))</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>        __repr__ 方法使用 </span><span class=si>{!r}</span><span class=s1> 获取各个分量的表示形式，然后插值，构成一个字符串
</span></span></span><span class=line><span class=cl><span class=s1>        因为 Vector2d 实例是可迭代的对象，所以 *self 会把 x 和 y 分量提供给 format 函数。
</span></span></span><span class=line><span class=cl><span class=s1>        &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>class_name</span> <span class=o>=</span> <span class=nb>type</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=vm>__name__</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;</span><span class=si>{}</span><span class=s1>(</span><span class=si>{!r}</span><span class=s1>, </span><span class=si>{!r}</span><span class=s1>)&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>class_name</span><span class=p>,</span> <span class=o>*</span><span class=bp>self</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__str__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=nb>tuple</span><span class=p>(</span><span class=bp>self</span><span class=p>))</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__bytes__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=nb>bytes</span><span class=p>([</span><span class=nb>ord</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>typecode</span><span class=p>)])</span> <span class=o>+</span>  <span class=c1># 把 typecode 转换成字节序列</span>
</span></span><span class=line><span class=cl>                <span class=nb>bytes</span><span class=p>(</span><span class=n>array</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>typecode</span><span class=p>,</span> <span class=bp>self</span><span class=p>)))</span>  <span class=c1># 迭代 Vector2d 实例，得到一个数组，再把数组转换成字节序列</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__eq__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>other</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>tuple</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>==</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>other</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__abs__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>math</span><span class=o>.</span><span class=n>hypot</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__bool__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>bool</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=bp>self</span><span class=p>))</span>  
</span></span></code></pre></td></tr></table></div></div><blockquote><p>示例 9-2 中的 <code>__eq__</code> 方法，在两个操作数都是 <code>Vector2d</code> 实例时可用，不过拿 <code>Vector2d</code> 实例与其他具有相同数值的可迭代对象相比，结果也是 <code>True</code>（如 <code>Vector(3, 4) == [3, 4]</code>）。这个行为可以视作特性，也可以视作缺陷。</p></blockquote><h3 id=备选构造方法>备选构造方法</h3><p>我们可以把 <code>Vector2d</code> 实例转换成字节序列了；同理，也应该能从字节序列转换成 <code>Vector2d</code> 实例。在标准库中探索一番之后，我们发现 <code>array.array</code> 有个类方法 <code>.frombytes</code> 正好符合需求。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=nd>@classmethod</span>  <span class=c1># 类方法</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>frombytes</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>octets</span><span class=p>):</span>  <span class=c1># 不用传入 self 参数；相反，要通过 cls 传入类本身</span>
</span></span><span class=line><span class=cl>	<span class=n>typecode</span> <span class=o>=</span> <span class=nb>chr</span><span class=p>(</span><span class=n>octets</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>  <span class=c1># 从第一个字节中读取 typecode</span>
</span></span><span class=line><span class=cl>	<span class=n>memv</span> <span class=o>=</span> <span class=nb>memoryview</span><span class=p>(</span><span class=n>octets</span><span class=p>[</span><span class=mi>1</span><span class=p>:])</span><span class=o>.</span><span class=n>cast</span><span class=p>(</span><span class=n>typecode</span><span class=p>)</span>  <span class=c1># 使用传入的 octets 字节序列创建一个 memoryview，然后使用 typecode 转换</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=bp>cls</span><span class=p>(</span><span class=o>*</span><span class=n>memv</span><span class=p>)</span>  <span class=c1># 拆包转换后的 memoryview，得到构造方法所需的一对参数</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=classmethod-与-staticmethod>classmethod 与 staticmethod</h3><p><code>classmethod</code> 定义操作类，而不是操作实例的方法。<code>classmethod</code> 改变了调用方法的方式，因此类方法的第一个参数是类本身，而不是实例。</p><p><code>classmethod</code> 最常见的用途是<strong>定义备选构造方法</strong>，例如上个例子中的 <code>frombytes</code>。注意，<code>frombytes</code> 的最后一行使用 <code>cls</code> 参数构建了一个新实例，即 <code>cls(*memv)</code>。</p><p>按照约定，类方法的第一个参数名为 <code>cls</code>（但是 Python 不介意具体怎么命名）。</p><p><code>staticmethod</code> 装饰器也会改变方法的调用方式，但是第一个参数不是特殊的值。其实，静态方法就是普通的函数，只是碰巧在类的定义体中，而不是在模块层定义。</p><blockquote><p><strong>示例 9-4</strong>　比较 <code>classmethod</code> 和 <code>staticmethod</code> 的行为</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>class</span> <span class=nc>Demo</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>def</span> <span class=nf>klassmeth</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>         <span class=k>return</span> <span class=n>args</span>  
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>def</span> <span class=nf>statmeth</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>         <span class=k>return</span> <span class=n>args</span>  
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Demo</span><span class=o>.</span><span class=n>klassmeth</span><span class=p>()</span>  <span class=c1># 不管怎样调用 Demo.klassmeth，它的第一个参数始终是 Demo 类</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>&lt;</span><span class=k>class</span> <span class=err>&#39;</span><span class=nc>__main__</span><span class=o>.</span><span class=n>Demo</span><span class=s1>&#39;&gt;,)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Demo</span><span class=o>.</span><span class=n>klassmeth</span><span class=p>(</span><span class=s1>&#39;spam&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>&lt;</span><span class=k>class</span> <span class=err>&#39;</span><span class=nc>__main__</span><span class=o>.</span><span class=n>Demo</span><span class=s1>&#39;&gt;, &#39;</span><span class=n>spam</span><span class=s1>&#39;)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Demo</span><span class=o>.</span><span class=n>statmeth</span><span class=p>()</span>   <span class=c1># Demo.statmeth 的行为与普通的函数相似</span>
</span></span><span class=line><span class=cl><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Demo</span><span class=o>.</span><span class=n>statmeth</span><span class=p>(</span><span class=s1>&#39;spam&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;spam&#39;</span><span class=p>,)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=格式化显示>格式化显示</h3><p>内置的 <code>format()</code> 函数和 <code>str.format()</code> 方法把各个类型的格式化方式委托给相应的 <code>.__format__(format_spec)</code> 方法。<code>format_spec</code> 是格式说明符，它是：</p><ul><li><code>format(my_obj, format_spec)</code> 的第二个参数，或者</li><li><code>str.format()</code> 方法的格式字符串，<code>{}</code> 里代换字段中冒号后面的部分</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>brl</span> <span class=o>=</span> <span class=mi>1</span><span class=o>/</span><span class=mf>2.43</span>  <span class=c1># BRL到USD的货币兑换比价</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>brl</span>
</span></span><span class=line><span class=cl><span class=mf>0.4115226337448559</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>format</span><span class=p>(</span><span class=n>brl</span><span class=p>,</span> <span class=s1>&#39;0.4f&#39;</span><span class=p>)</span>  <span class=c1># ➊</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;0.4115&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=s1>&#39;1 BRL = </span><span class=si>{rate:0.2f}</span><span class=s1> USD&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>rate</span><span class=o>=</span><span class=n>brl</span><span class=p>)</span>  <span class=c1># ➋</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;1 BRL = 0.41 USD&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>'{0.mass:5.3e}'</code> 这样的格式字符串其实包含两部分</p><ul><li>冒号左边的 <code>'0.mass'</code> 在代换字段句法中是字段名</li><li>冒号后面的 <code>'5.3e'</code> 是格式说明符。</li></ul><p>格式说明符使用的表示法叫<strong>格式规范微语言</strong>（Format Specification Mini-Language）</p><p>格式规范微语言为一些内置类型提供了专用的表示代码。比如，<code>b</code> 和 <code>x</code> 分别表示二进制和十六进制的 <code>int</code> 类型，<code>f</code> 表示小数形式的 <code>float</code> 类型，而 <code>%</code> 表示百分数形式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>format</span><span class=p>(</span><span class=mi>42</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;101010&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>format</span><span class=p>(</span><span class=mi>2</span><span class=o>/</span><span class=mi>3</span><span class=p>,</span> <span class=s1>&#39;.1%&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;66.7%&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>格式规范微语言是可扩展的，因为各个类可以自行决定如何解释 <code>format_spec</code> 参数。例如， <code>datetime</code> 模块中的类，它们的 <code>__format__</code> 方法使用的格式代码与 <code>strftime()</code> 函数一样。下面是内置的 <code>format()</code> 函数和 <code>str.format()</code> 方法的几个示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>now</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>format</span><span class=p>(</span><span class=n>now</span><span class=p>,</span> <span class=s1>&#39;%H:%M:%S&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;18:49:05&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=s2>&#34;It&#39;s now {:%I:%M %p}&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>now</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;It&#39;s now 06:49 PM&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>如果类没有定义 <code>__format__</code> 方法，从 <code>object</code> 继承的方法会返回 <code>str(my_object)</code>。我们为 <code>Vector2d</code> 类定义了 <code>__str__</code> 方法，因此可以这样做：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>v1</span> <span class=o>=</span> <span class=n>Vector2d</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>format</span><span class=p>(</span><span class=n>v1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;(3.0, 4.0)&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>我们将实现自己的微语言来解决这个问题。首先，假设用户提供的格式说明符是用于格式化向量中各个浮点数分量的。我们想达到的效果是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>v1</span> <span class=o>=</span> <span class=n>Vector2d</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>format</span><span class=p>(</span><span class=n>v1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;(3.0, 4.0)&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>format</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=s1>&#39;.2f&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;(3.00, 4.00)&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>format</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=s1>&#39;.3e&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;(3.000e+00, 4.000e+00)&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>实现这种输出的 <code>__format__</code> 方法如示例 9-5 所示。</p><blockquote><p><strong>示例 9-5</strong>　<code>Vector2d.__format__</code> 方法，第 1 版</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># 在 Vector2d 类中定义</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=fm>__format__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>fmt_spec</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 使用内置的 format 函数把 fmt_spec 应用到向量的各个分量上，构建一个可迭代的格式化字符串</span>
</span></span><span class=line><span class=cl>    <span class=n>components</span> <span class=o>=</span> <span class=p>(</span><span class=nb>format</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fmt_spec</span><span class=p>)</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=bp>self</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=c1># 把格式化字符串代入公式 &#39;(x, y)&#39; 中</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;(</span><span class=si>{}</span><span class=s1>, </span><span class=si>{}</span><span class=s1>)&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=o>*</span><span class=n>components</span><span class=p>)</span> 
</span></span></code></pre></td></tr></table></div></div><p>下面要在微语言中添加一个自定义的格式代码：如果格式说明符以 <code>'p'</code> 结尾，那么在极坐标中显示向量，即 <code>&lt;r, θ ></code>，其中 <code>r</code> 是模，<code>θ</code>（西塔）是弧度；其他部分（<code>'p'</code> 之前的部分）像往常那样解释</p><blockquote><p>为自定义的格式代码选择字母时，最好避免使用其他类型用过的字母。</p><p>在格式规范微语言中，整数使用的代码有 <code>'bcdoxXn'</code>，浮点数使用的代码有 <code>'eEfFgGn%'</code>，字符串使用的代码有 <code>'s'</code>。</p><p>因此，为极坐标选的代码是 <code>'p'</code>。</p><p>各个类使用自己的方式解释格式代码，在自定义的格式代码中重复使用代码字母不会出错，但是可能会让用户困惑。</p></blockquote><p>对极坐标来说，我们已经定义了计算模的 <code>__abs__</code> 方法，因此还要定义一个简单的 <code>angle</code> 方法，使用 <code>math.atan2()</code> 函数计算角度：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># 在Vector2d类中定义</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>angle</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>math</span><span class=o>.</span><span class=n>atan2</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这样便可以增强 <code>__format__</code> 方法，计算极坐标，如示例 9-6 所示。</p><blockquote><p><strong>示例 9-6</strong>　<code>Vector2d.__format__</code> 方法，第 2 版，现在能计算极坐标了</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=fm>__format__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>fmt_spec</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>fmt_spec</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>    	<span class=n>fmt_spec</span> <span class=o>=</span> <span class=n>fmt_spec</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>  
</span></span><span class=line><span class=cl>    	<span class=n>coords</span> <span class=o>=</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=bp>self</span><span class=p>),</span> <span class=bp>self</span><span class=o>.</span><span class=n>angle</span><span class=p>())</span> 
</span></span><span class=line><span class=cl>    	<span class=n>outer_fmt</span> <span class=o>=</span> <span class=s1>&#39;&lt;</span><span class=si>{}</span><span class=s1>, </span><span class=si>{}</span><span class=s1>&gt;&#39;</span>  
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    	<span class=n>coords</span> <span class=o>=</span> <span class=bp>self</span>  
</span></span><span class=line><span class=cl>    	<span class=n>outer_fmt</span> <span class=o>=</span> <span class=s1>&#39;(</span><span class=si>{}</span><span class=s1>, </span><span class=si>{}</span><span class=s1>)&#39;</span>  
</span></span><span class=line><span class=cl>    <span class=n>components</span> <span class=o>=</span> <span class=p>(</span><span class=nb>format</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fmt_spec</span><span class=p>)</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>coords</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>outer_fmt</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=o>*</span><span class=n>components</span><span class=p>)</span>  
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>format</span><span class=p>(</span><span class=n>Vector2d</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=s1>&#39;p&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;&lt;1.4142135623730951, 0.7853981633974483&gt;&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>format</span><span class=p>(</span><span class=n>Vector2d</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=s1>&#39;.3ep&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;&lt;1.414e+00, 7.854e-01&gt;&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>format</span><span class=p>(</span><span class=n>Vector2d</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=s1>&#39;0.5fp&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;&lt;1.41421, 0.78540&gt;&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>如本节所示，为用户自定义的类型扩展格式规范微语言并不难</p><h3 id=可散列化>可散列化</h3><p>按照定义，目前 <code>Vector2d</code> 实例是不可散列的，因此不能放入集合（<code>set</code>）中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>v1</span> <span class=o>=</span> <span class=n>Vector2d</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>hash</span><span class=p>(</span><span class=n>v1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>TypeError</span><span class=p>:</span> <span class=n>unhashable</span> <span class=nb>type</span><span class=p>:</span> <span class=s1>&#39;Vector2d&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>set</span><span class=p>([</span><span class=n>v1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>TypeError</span><span class=p>:</span> <span class=n>unhashable</span> <span class=nb>type</span><span class=p>:</span> <span class=s1>&#39;Vector2d&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>为了把 <code>Vector2d</code> 实例变成可散列的，<strong>必须使用 <code>__hash__</code> 方法（还需要 <code>__eq__</code> 方法，前面已经实现了）</strong>。此外，还要让向量不可变</p><p>目前，我们可以为分量赋新值，如 <code>v1.x = 7</code>，<code>Vector2d</code> 类的代码并不阻止这么做。我们想要的行为是这样的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>v1</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=n>v1</span><span class=o>.</span><span class=n>y</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mf>3.0</span><span class=p>,</span> <span class=mf>4.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>v1</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=ne>AttributeError</span><span class=p>:</span> <span class=n>can</span><span class=s1>&#39;t set attribute</span>
</span></span></code></pre></td></tr></table></div></div><p>为此，我们要把 <code>x</code> 和 <code>y</code> 分量设为只读特性</p><blockquote><p><strong>示例 9-7</strong>　vector2d_v3.py：这里只给出了让 <code>Vector2d</code> 不可变的代码，完整的代码清单在示例 9-9 中</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>Vector2d</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>typecode</span> <span class=o>=</span> <span class=s1>&#39;d&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>__x</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>__y</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span> 
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>x</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>__x</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>  
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>y</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>__y</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__iter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>))</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 其他方法</span>
</span></span></code></pre></td></tr></table></div></div><p>注意，我们让这些向量不可变是有原因的，因为这样才能实现 <code>__hash__</code> 方法。这个方法应该返回一个整数，理想情况下还要考虑对象属性的散列值（<code>__eq__</code> 方法也要使用），因为相等的对象应该具有相同的散列值。</p><p>最好使用位运算符异或（<code>^</code>）混合各分量的散列值 —— 我们会这么做。<code>Vector2d.__hash__</code> 方法的代码十分简单，如示例 9-8 所示。</p><blockquote><p><strong>示例 9-8</strong>　vector2d_v3.py：实现 <code>__hash__</code> 方法</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># 在 Vector2d 类中定义</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=fm>__hash__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>hash</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>)</span> <span class=o>^</span> <span class=nb>hash</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>添加 <code>__hash__</code> 方法之后，向量变成可散列的了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>v1</span> <span class=o>=</span> <span class=n>Vector2d</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>v2</span> <span class=o>=</span> <span class=n>Vector2d</span><span class=p>(</span><span class=mf>3.1</span><span class=p>,</span> <span class=mf>4.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>hash</span><span class=p>(</span><span class=n>v1</span><span class=p>),</span> <span class=nb>hash</span><span class=p>(</span><span class=n>v2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>7</span><span class=p>,</span> <span class=mi>384307168202284039</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>set</span><span class=p>([</span><span class=n>v1</span><span class=p>,</span> <span class=n>v2</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=n>Vector2d</span><span class=p>(</span><span class=mf>3.1</span><span class=p>,</span> <span class=mf>4.2</span><span class=p>),</span> <span class=n>Vector2d</span><span class=p>(</span><span class=mf>3.0</span><span class=p>,</span> <span class=mf>4.0</span><span class=p>)}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>要想创建可散列的类型，不一定要实现特性，也不一定要保护实例属性。只需正确地实现 <code>__hash__</code> 和 <code>__eq__</code> 方法即可。但是，实例的散列值绝不应该变化，因此我们借机提到了只读特性。</p></blockquote><h3 id=python-的私有属性和受保护的属性>Python 的私有属性和“受保护的”属性</h3><p>Python 有个简单的机制，能避免子类意外覆盖“私有”属性。</p><p>举个例子。有人编写了一个名为 <code>Dog</code> 的类，这个类的内部用到了 <code>mood</code> 实例属性，但是没有将其开放。现在，你创建了 <code>Dog</code> 类的子类：<code>Beagle</code>。如果你在毫不知情的情况下又创建了名为 <code>mood</code> 的实例属性，那么在继承的方法中就会把 <code>Dog</code> 类的 <code>mood</code> 属性覆盖掉。这是个难以调试的问题。</p><p>为了避免这种情况，如果以 <code>__mood</code> 的形式（两个前导下划线，尾部没有或最多有一个下划线）命名实例属性，Python 会把属性名存入实例的 <code>__dict__</code> 属性中，而且会在前面加上一个下划线和类名。因此，对 <code>Dog</code> 类来说，<code>__mood</code> 会变成 <code>_Dog__mood</code>；对 <code>Beagle</code> 类来说，会变成 <code>_Beagle__mood</code>。这个语言特性叫<strong>名称改写</strong>（name mangling）。</p><blockquote><p><strong>示例 9-10</strong>　私有属性的名称会被“改写”，在前面加上下划线和类名</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>v1</span> <span class=o>=</span> <span class=n>Vector2d</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>v1</span><span class=o>.</span><span class=vm>__dict__</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s1>&#39;_Vector2d__y&#39;</span><span class=p>:</span> <span class=mf>4.0</span><span class=p>,</span> <span class=s1>&#39;_Vector2d__x&#39;</span><span class=p>:</span> <span class=mf>3.0</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>v1</span><span class=o>.</span><span class=n>_Vector2d__x</span>
</span></span><span class=line><span class=cl><span class=mf>3.0</span>
</span></span></code></pre></td></tr></table></div></div><p>名称改写是一种安全措施，不能保证万无一失：它的目的是避免意外访问，不能防止故意做错事（图 9-1 也是一种保护装置）。</p><p>如示例 9-10 中的最后一行所示，只要知道改写私有属性名的机制，任何人都能直接读取私有属性——这对调试和序列化倒是有用。此外，只要编写 <code>v1._Vector__x = 7</code> 这样的代码，就能轻松地为 <code>Vector2d</code> 实例的私有分量直接赋值。如果真在生产环境中这么做了，出问题时可别抱怨。</p><p>不是所有 Python 程序员都喜欢名称改写功能，也不是所有人都喜欢 <code>self.__x</code> 这种不对称的名称。有些人不喜欢这种句法，他们约定使用一个下划线前缀编写“受保护”的属性（如 <code>self._x</code>）。批评使用两个下划线这种改写机制的人认为，应该使用命名约定来避免意外覆盖属性。</p><p>Python 解释器不会对使用单个下划线的属性名做特殊处理，不过这是很多 Python 程序员严格遵守的约定，他们不会在类外部访问这种属性。遵守使用一个下划线标记对象的私有属性很容易，就像遵守使用全大写字母编写常量那样容易。</p><blockquote><p>不过在模块中，顶层名称使用一个前导下划线的话，的确会有影响：对 <code>from mymod import *</code> 来说，<code>mymod</code> 中前缀为下划线的名称不会被导入。然而，依旧可以使用 <code>from mymod import _privatefunc</code> 将其导入。</p></blockquote><p>Python 文档的某些角落把使用一个下划线前缀标记的属性称为“受保护的”属性。9 使用 <code>self._x</code> 这种形式保护属性的做法很常见，但是很少有人把这种属性叫作“受保护的”属性。有些人甚至将其称为“私有”属性。</p><h3 id=-使用-__slots__-类属性节省空间>⭐ 使用 <strong>slots</strong> 类属性节省空间</h3><p>默认情况下，Python 在各个实例中名为 <code>__dict__</code> 的字典里存储实例属性。为了使用底层的散列表提升访问速度，字典会消耗大量内存。</p><p>如果要处理数百万个属性不多的实例，通过 <code>__slots__</code> 类属性，能节省大量内存，方法是让解释器<strong>在元组中存储实例属性，而不用字典</strong>。</p><blockquote><p>继承自超类的 <code>__slots__</code> 属性没有效果。Python 只会使用各个类中定义的 <code>__slots__</code> 属性</p></blockquote><p>定义 <code>__slots__</code> 的方式是，创建一个类属性，使用 <code>__slots__</code> 这个名字，并把它的值设为一个字符串构成的可迭代对象，其中各个元素表示各个实例属性。推荐使用元组，因为这样定义的 <code>__slots__</code> 中所含的信息不会变化：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>Vector2d</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=vm>__slots__</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39;__x&#39;</span><span class=p>,</span> <span class=s1>&#39;__y&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>typecode</span> <span class=o>=</span> <span class=s1>&#39;d&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>在类中定义 <code>__slots__</code> 属性的目的是告诉解释器：“这个类中的所有实例属性都在这儿了！”这样，Python 会在各个实例中使用类似元组的结构存储实例变量，从而避免使用消耗内存的 <code>__dict__</code> 属性。如果有数百万个实例同时活动，这样做能节省大量内存。</p><blockquote><p>在类中定义 <code>__slots__</code> 属性之后，实例不能再有 <code>__slots__</code> 中所列名称之外的其他属性。这只是一个副作用，不是 <code>__slots__</code> 存在的真正原因。不要使用 <code>__slots__</code> 属性禁止类的用户新增实例属性。<code>__slots__</code> 是用于优化的，不是为了约束程序员。</p></blockquote><p>然而，“节省的内存也可能被再次吃掉”：如果把 <code>'__dict__'</code> 这个名称添加到 <code>__slots__</code> 中，实例会在元组中保存各个实例的属性，此外还支持动态创建属性，这些属性存储在常规的 <code>__dict__</code> 中。当然，把 <code>'__dict__'</code> 添加到 <code>__slots__</code> 中可能完全违背了初衷，这取决于各个实例的静态属性和动态属性的数量及其用法。粗心的优化甚至比提早优化还糟糕。</p><p>此外，还有一个实例属性可能需要注意，即 <code>__weakref__</code> 属性，为了让对象支持弱引用，必须有这个属性。用户定义的类中默认就有 <code>__weakref__</code> 属性。可是，如果类中定义了 <code>__slots__</code> 属性，而且想把实例作为弱引用的目标，那么要把 <code>'__weakref__'</code> 添加到 <code>__slots__</code> 中。</p><p><strong>处理列表数据时 <code>__slots__</code> 属性最有用</strong>，例如模式固定的数据库记录，以及特大型数据集。</p><p>总之，如果使用得当，<code>__slots__</code> 能显著节省内存，不过有几点要注意。</p><ul><li>每个子类都要定义 <code>__slots__</code> 属性，因为解释器会忽略继承的 <code>__slots__</code> 属性。</li><li>实例只能拥有 <code>__slots__</code> 中列出的属性，除非把 <code>'__dict__'</code> 加入 <code>__slots__</code> 中（这样做就失去了节省内存的功效）。</li><li>如果不把 <code>'__weakref__'</code> 加入 <code>__slots__</code>，实例就不能作为弱引用的目标。</li></ul><p>如果你的程序不用处理数百万个实例，或许不值得费劲去创建不寻常的类，那就禁止它创建动态属性或者不支持弱引用。与其他优化措施一样，仅当权衡当下的需求并仔细搜集资料后证明确实有必要时，才应该使用 <code>__slots__</code> 属性。</p><h3 id=覆盖类属性>覆盖类属性</h3><p>Python 有个很独特的特性：<strong>类属性可用于为实例属性提供默认值</strong>。<code>Vector2d</code> 中有个 <code>typecode</code> 类属性，<code>__bytes__</code> 方法两次用到了它，而且都故意使用 <code>self.typecode</code> 读取它的值。因为 <code>Vector2d</code> 实例本身没有 <code>typecode</code> 属性，所以 <code>self.typecode</code> 默认获取的是 <code>Vector2d.typecode</code> 类属性的值。</p><p>但是，如果为不存在的实例属性赋值，会新建实例属性。假如我们为 <code>typecode</code> 实例属性赋值，那么同名类属性不受影响。然而，自此之后，实例读取的 <code>self.typecode</code> 是实例属性 <code>typecode</code>，也就是把同名类属性遮盖了。借助这一特性，可以为各个实例的 <code>typecode</code> 属性定制不同的值。</p><p><code>Vector2d.typecode</code> 属性的默认值是 <code>'d'</code>，即转换成字节序列时使用 8 字节双精度浮点数表示向量的各个分量。如果在转换之前把 <code>Vector2d</code> 实例的 <code>typecode</code> 属性设为 <code>'f'</code>，那么使用 4 字节单精度浮点数表示各个分量，如示例 9-13 所示。</p><blockquote><p><strong>示例 9-13</strong>　设定从类中继承的 <code>typecode</code> 属性，自定义一个实例属性</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>vector2d_v3</span> <span class=kn>import</span> <span class=n>Vector2d</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>v1</span> <span class=o>=</span> <span class=n>Vector2d</span><span class=p>(</span><span class=mf>1.1</span><span class=p>,</span> <span class=mf>2.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>dumpd</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>v1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>dumpd</span>
</span></span><span class=line><span class=cl><span class=sa>b</span><span class=s1>&#39;d</span><span class=se>\x9a\x99\x99\x99\x99\x99\xf1</span><span class=s1>?</span><span class=se>\x9a\x99\x99\x99\x99\x99\x01</span><span class=s1>@&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>dumpd</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=mi>17</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>v1</span><span class=o>.</span><span class=n>typecode</span> <span class=o>=</span> <span class=s1>&#39;f&#39;</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>dumpf</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>v1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>dumpf</span>
</span></span><span class=line><span class=cl><span class=sa>b</span><span class=s1>&#39;f</span><span class=se>\xcd\xcc\x8c</span><span class=s1>?</span><span class=se>\xcd\xcc\x0c</span><span class=s1>@&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>dumpf</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=mi>9</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Vector2d</span><span class=o>.</span><span class=n>typecode</span>  
</span></span><span class=line><span class=cl><span class=s1>&#39;d&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>现在你应该知道为什么要在得到的字节序列前面加上 <code>typecode</code> 的值了：为了支持不同的格式</p><p>如果想修改类属性的值，必须直接在类上修改，不能通过实例修改。如果想修改所有实例（没有 <code>typecode</code> 实例变量）的 <code>typecode</code> 属性的默认值，可以这么做：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&gt;&gt;&gt; Vector2d.typecode = &#39;f&#39;
</span></span></code></pre></td></tr></table></div></div><p>然而，有种修改方法更符合 Python 风格，而且效果持久，也更有针对性。类属性是公开的，因此会被子类继承，于是经常会创建一个子类，只用于定制类的数据属性。Django 基于类的视图就大量使用了这个技术。具体做法如示例 9-14 所示。</p><blockquote><p><strong>示例 9-14</strong>　<code>ShortVector2d</code> 是 <code>Vector2d</code> 的子类，只用于覆盖 <code>typecode</code> 的默认值</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>vector2d_v3</span> <span class=kn>import</span> <span class=n>Vector2d</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>class</span> <span class=nc>ShortVector2d</span><span class=p>(</span><span class=n>Vector2d</span><span class=p>):</span> 
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>typecode</span> <span class=o>=</span> <span class=s1>&#39;f&#39;</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>sv</span> <span class=o>=</span> <span class=n>ShortVector2d</span><span class=p>(</span><span class=mi>1</span><span class=o>/</span><span class=mi>11</span><span class=p>,</span> <span class=mi>1</span><span class=o>/</span><span class=mi>27</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>sv</span>
</span></span><span class=line><span class=cl><span class=n>ShortVector2d</span><span class=p>(</span><span class=mf>0.09090909090909091</span><span class=p>,</span> <span class=mf>0.037037037037037035</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=nb>bytes</span><span class=p>(</span><span class=n>sv</span><span class=p>))</span>  <span class=c1># 确认得到的字节序列长度为 9 字节，而不是之前的 17 字节</span>
</span></span><span class=line><span class=cl><span class=mi>9</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=序列的修改散列和切片>序列的修改、散列和切片</h2></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2023-06-14 11:23:16">更新于 2023-06-14</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://trouvaille0198.github.io/Notes/posts/python/%E6%B5%81%E7%95%85%E7%9A%84-python/ data-title="流畅的 Python" data-hashtags=Python><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://trouvaille0198.github.io/Notes/posts/python/%E6%B5%81%E7%95%85%E7%9A%84-python/ data-hashtag=Python><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://trouvaille0198.github.io/Notes/posts/python/%E6%B5%81%E7%95%85%E7%9A%84-python/ data-title="流畅的 Python"><i class="fa-brands fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href=/Notes/tags/python/>Python</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/Notes/>主页</a></span></section></div><div class=post-nav><a href=/Notes/posts/%E5%88%B7%E9%A2%98/string/1047.-%E5%88%A0%E9%99%A4%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E7%9B%B8%E9%82%BB%E9%87%8D%E5%A4%8D%E9%A1%B9/ class=prev rel=prev title="1047. 删除字符串中的所有相邻重复项"><i class="fa-solid fa-angle-left fa-fw"></i>1047. 删除字符串中的所有相邻重复项</a>
<a href=/Notes/posts/%E5%88%B7%E9%A2%98/array/%E5%8F%8C%E6%8C%87%E9%92%88/75.-%E9%A2%9C%E8%89%B2%E5%88%86%E7%B1%BB/ class=next rel=next title="75. 颜色分类">75. 颜色分类<i class="fa-solid fa-angle-right fa-fw"></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line custom">酒困路长惟欲睡，日高人渴漫思茶</div><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2022 - 2023</span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><div id=mask></div></div><link rel=stylesheet href=/Notes/lib/katex/katex.min.css><link rel=stylesheet href=/Notes/lib/katex/copy-tex.min.css><link rel=stylesheet href=/Notes/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/Notes/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/Notes/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script type=text/javascript src=/Notes/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/Notes/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/Notes/lib/katex/katex.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/Notes/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/Notes/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:45},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"7I9AMOLA4S",algoliaIndex:"Notes",algoliaSearchKey:"3c1638dfe9f4d49a59d81ff6943416b8",highlightTag:"em",maxResultLength:30,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/Notes/js/theme.min.js defer></script><script type=text/javascript src=/Notes/js/_custom.min.js defer></script></body></html>