###  第一章 操作系统引论

#### 1.1 操作系统的目标和作用

**作用**：用户和硬件间的接口，管理系统资源，抽象计算机资源



#### 1.2 操作系统的发展过程

- **多道批处理系统**：用户提交作业进入外存，作业调度若干作业进入内存，共享CPU和系统汇总的资源。多道程序交替运行。
- 优点：资源利用率高，吞吐量大
  - 缺点：平均周转时间长，无交互能力
  - 需要解决的问题：处理机争用，内存分配和保护，IO设备分配，文件组织管理，作业管理，用户与系统接口。
  
- **分时系统**：侧重用户终端互不干扰，人机交互
  - 引入：人机交互（用户想要独占主机），共享主机。
  - 关键问题：及时接收，及时处理（直接进入内存，轮转方式）

- **实时系统**：侧重多路控制现场的设备、数据互不干扰，程序数据信息交互
能及时响应外部请求，在规定时间内完成对事件的处理，控制实时任务的协调执行。

**分时/实时系统的特点比较：**
  - 多路性：分时为多终端服务；实时周期性控制
  - 独立性：多终端互不干扰；信息采集和对象控制互不干扰
  - 及时性：用户可接受；要求更高
  - 交互性：强；仅对信息查询系统中特定命令
  - 可靠性：较强；非常强

#### 1.3 操作系统的基本特征（四大特征）

- **并发：**多个事件在同一时间段发生。
引入进程使得并发成为可能。
  - 注意并发与并行的区别：并行为多个进程同一时刻发生，并发微观上是各个程序交替执行。
  - 进程：见2.2.1

- **共享（复用）：**资源供多个并发执行的进程同时使用。
  - 互斥共享：一段时间只允许一个进程访问该资源
  - 同时访问：各进程交替访问该资源

- **虚拟：**将一个物理实体变为若干逻辑对应物，提升利用率。
  - 时分复用：利用CPU的空闲时间处理其他进程
    - 虚拟处理机技术（多进程）
    - 虚拟设备技术（多I/O）
  - 空分复用：利用内存的空闲区域存放和运行其他进程（虚拟存储技术）

- **异步：**进程的执行顺序和时间不确定。

#### 1.4 操作系统的主要功能（五大功能）

- **处理机管理功能**：即对进程的管理
  - 进程控制：创建、撤销、状态迁移
  - 进程同步：多进程的运行和协调
    - （临界）资源的互斥访问
    - 资源的同步访问：调度访问顺序
  - 进程通信：进程的合作
  - 调度
    - 作业调度：使作业成为进程
    - 进程调度：执行进程
  
- **存储器管理功能**：
  - 内存分配：基本内存分配+提高内存利用率+允许进程申请额外空间
    - 两种方式 动态vs静态：是否能在内存中移动/申请内存额外空间
  - 内存保护：确保程序只访问自己的内存，不会访问操作系统的程序和数据
  - 地址映射：空间地址与逻辑地址的转换
  - 内存扩充：虚拟存储技术
    - 请求调入功能/置换功能

- **设备管理功能**：
  - 缓冲管理：管理I/O设备，缓解CPU与I/O之间的速度不匹配
  - 设备分配
  - 设备处理/驱动：实现CPU与设备控制器之间的通信

- **文件管理功能**：
  - 文件存储空间管理：为文件分配外存空间，提高外存利用率
  - 目录管理：对文件建立建立目录项，文件共享，目录查询
  - 文件读写管理及文件保护

- **操作系统与用户之间的接口**：为方便用户使用
  - 用户接口：方便用户直接或间接控制自己的作业
    - 联机用户接口（terminal）：由一组键盘操作命令及解释程序组成
    - 脱机用户接口（.sh）：用作业控制语言JCL写作业说明书
    - 图形用户接口：图标等
  - 程序接口：为用户程序访问系统资源设置，是用户程序取得系统服务的**唯一**途径

- **新功能**：系统安全、网络功能和服务、支持多媒体

#### 1.5 操作系统的结构设计

**微内核OS结构**（对应宏内核OS结构）：将操作系统划分成两部分（微内核和多个服务器），将操作系统中尽可能多的成分和功能放到服务器中运行，而留下一个尽可能小的内核完成操作系统最核心的功能。
基本概念：

- 足够小的内核：放入与硬件密切相关的部分、一些基本功能、与服务器的通信
- 基于客户/服务器模式：客户与服务器之间通过微内核实现信息交互
- 应用“机制与策略分离”原理：该做什么和怎么做分离
- 采用面向对象技术：抽象和封装

### 第二章 进程的描述和控制

#### 2.1 前趋图和程序执行

前趋图：描述进程执行的先后顺序，DAG
前趋图**并发执行**的特征：
- 间断性：程序之间相互制约
- 失去封闭性：资源共享
- 不可再现性：多次执行结果不同
（书p37 图2-3）

#### 2.2 进程的描述

**进程的定义**：进程是**进程实体的运行过程**，是系统进行**资源分配和调度**的一个**独立单位**。
  - 进程的出现**使程序并发执行成为可能**。
  - 系统使用**进程控制块（PCB）**（为进程配置的数据结构）描述进程的**基本情况和活动过程**，进而**控制管理进程**。
*注意：Main函数参数和系统调用的关系*

**进程的特征**：
- 动态性：**创建产生，调度执行，撤销消亡**（程序是静态的）
- 并发性：多个进程在同一个时间段中并发执行（程序无PCB不能并发）
- 独立性：进程实体有独立资源能独立运行（程序无PCB不能独立运行）
- 异步性：进程按各自的不可预知的速度推进

**进程和程序的区别：**
- 进程是动态的，程序是静态的
- 进程是暂时的，程序时永恒的
- **进程包含程序、数据和PCB**
- 进程可以包含多个程序，同一程序可以对应多个进程

**进程的状态和转化**：

- 三种基本状态
  - 就绪：进程所需资源除CPU外均已准备到位
  - 执行
  - 阻塞：进程由于I/O等原因无法继续执行
- 创建/终止
  - 创建：给进程分配除CPU外的资源
  - 终止：操作系统进行善后处理，然后将PCB清零返还给系统
**进程转换的三态、五态模型：书p40 图2-5、p41 图2-6
注意图中状态名称和操作名称，要会默写**

**进程管理的数据结构：**
- 操作系统管理数据结构分类：
  - 内存表、设备表、文件表、**进程表**
- PCB作用：
  - 作为独立运行基本单位的标志
  - 实现间断性运行的方式
  - 提供进程管理/调度需要的信息
  - 实现与其它进程通信
- PCB中的信息：
  - 进程控制符（编号）：内/外标识符
  - 处理机状态（寄存器信息，计数器）
  - 进程调度信息（进程状态和优先级，以及阻塞原因/事件）
  - 进程控制信息（资源清单等）
- PCB组织方式：
  - 链式、 索引式

#### 2.3 进程控制

**内核的功能**：
- 支撑功能：
  - 中断处理
  - 时钟管理：管理时间片
  - 原语操作：数条指令的集合，执行时不可被打断
- 资源管理功能：
  - 进程管理
  - 存储器（内存）管理
  - 设备管理

#### 2.4 进程同步

**进程同步：**对多个进程在执行次序上进行协调使其共享资源
进程制约关系：

- 间接相互制约：资源互斥共享
- 直接相互制约：同任务间通过管道实现的**同步**

**同步**：系统中多个进程发生的事件存在时序关系，需要相互**合作**完成同一任务
**互斥**：各进程要求共享资源，而有些资源需要互斥使用，各进程间**竞争**使用
**临界资源**：系统中一次只允许一个进程使用的资源
**临界区：**进程中访问临界资源的代码段

**同步机制遵循的规则：空闲让进、忙则等待、有限等待、让权等待**
- 有限等待：必须保证有限时间内可访问资源
- 让权等待：进程得不到资源时应立即释放处理机

以上两条措施可以防止**死锁**

**信号量机制：**一种管理进程使用临界/关键资源的机制
重要！！！
（以下S表示剩余可用资源数，wait表示该进程想使用资源，signal表示进程使用完该资源）

- 整型信号量：如果进程想使用资源（wait）且资源不足（S<=0），则该进程就不断进行测试（忙等）
  - 这样可能导致死锁

- 记录型信号量：定义一个全局队列list记录阻塞进程信息
  进程使用资源（wait）且资源不足**（S<0）**时，该进程进入阻塞队列（list）
  进程释放资源（signal）且资源不足**（S<=0）**时，唤醒阻塞队列（list）的头节点执行任务。
  S>0时表示系统中可用资源数
  S<0时其绝对值代表已阻塞进程数
  （S初始值为1表示互斥信号量）
  - 意义：解决了忙等（让权等待）

- AND型信号量：Swait(S1~Sn)、Ssignal(S1~Sn)
  应用情景：存在同时需要多个资源的进程
  S1~Sn代表该进程需要的n个资源
  过程类似记录型信号量：
  进程使用资源（wait）且任意所需资源不足（Si<0）时，其进入阻塞队列并释放所有资源
  进程释放资源（signal）且任意释放资源不足（Si<0）时，唤醒所有需要该资源的进程
  - 缺点：一次性分配全部资源给进程（要么全部分配，要么一个都不分配），效率较低
  每次一种资源只能分配一个

- 信号量集：Swait(S1,t1,d1~Sn,tn,dn)、Ssignal(S1,t1,d1~Sn,tn,dn)
  - 含义：一次性请求t1个S1，如果成功消耗d1个S1
  - 例如：Swait(S,d,d)：请求d个S，如果少于d则不分配
  Swait(S,1,1)：退化为记录型信号量(S>1)或互斥信号量(S=1)
  Swait(S,1,0)：S=1时允许多个进程进入，反之不允许进入。相当于可控开关

**信号量的应用：**
- 进程互斥：作为进程调度的算法
- 前驱关系：对于每一个过程，使用and型信号量，参数为该过程的所需条件，即可输出前驱图

**管程：**定义了一个数据结构和能为并发进程所执行的一组操作，这组操作能同步进程和改变管程中的数据。
将共享资源的数据结构和操作过程封装在对象内部，隐藏实现细节。

- 包含：名称、共享数据、操作过程、初始化代码

#### 2.5 经典进程同步问题

- 读者-写者问题：指多个资源可以同时被多个进程读取，却只能被一个进程写入的问题
  记录型：书p71
  限制读取资源的进程数量：信号量集：书p72

#### 2.6 进程通信

进程通信就是进程之间的信息交换，用于同步和互斥。

**进程通信的类型：**
- 共享存储器系统：共享数据结构或存储区
  - 基于共享数据的通信方式（数据结构）
  - 基于共享存储区的通信方式（内存）
- **管道通信系统：**写进程将数据送入管道文件，而读进程从管道文件中读取信息
- 消息传递系统：以格式化消息为单位（例如计网中的报文）
  - 直接通信方式：原语操作
  - 间接通信方式：通过共享中间实体（邮箱）
- 客户-服务器系统（详见计网）
  - 套接字：分基于文件型和基于网络型
  - 远程方法调用和远程文件调用

**消息传递通信的实现**
- 直接消息传递系统：使用原语（OS的功能）直接发送
  - 直接通信原语： 
    - 对称寻址：只监听1个发送者的消息
    - 不对称寻址：监听所有消息
  - 消息的格式
  - 进程同步方式
  - 通信链路
- 信箱通信：通过某种中间实体暂存消息实现通信
  - 结构：信箱头/信箱体
  - 通信原语：创建/撤销/发送/接受
  - 类型：
    - 私用：进程创建，其他进程只能发送信件不能查看收信
    - 公用：操作系统创建，核准进程均可使用
    - 共享：进程创建，指定其可共享的其余进程

#### 2.7 线程的基本概念

进程的基本属性：一个可拥有资源、可独立调度分配的单位
**线程的引入：**为了减少程序在并发执行时所付出的时空开销，使OS具有更好的并发性。

**线程和进程的比较**：
- 调度的基本单位：进程切换需要改变上下文环境；同一进程中的线程切换不用改变，切换代价低
- 并发性：都可以并发执行
- 拥有资源：进程是拥有资源的基本单位；线程仅拥有必不可少的独立运行所需的资源
- 独立性：进程间地址空间和资源互相独立；线程间共享地址空间和资源
- 系统开销：进程需要切换上下文；线程没什么资源，开销小
- 支持多处理机系统：进程必须在单处理机上运行；单进程中的多线程可分配到不同处理机上执行

### 第三章 处理机调度与死锁

#### 3.1 处理机调度的层次和调度算法的目标

**处理机调度的层次：**
- 高级调度（作业调度）：将外存作业调入内存
- 中级调度（内存调度）：提高内存利用率和系统吞吐量
- 低级调度（进程调度）：给进程分配处理机

**调度算法的目标：**
- 共同目标：
  - 资源利用率：=工作时间/（工作时间+空闲时间）
  - 公平性：各进程都能被执行到
  - 平衡性：使**各设备**尽可能处于忙碌状态
  - 策略强制执行：强制执行某些策略
- 批处理系统目标：
  - 平均周转时间短：作业提交给系统到作业完成的时间应该尽量短
  - 系统吞吐量高：单位时间内系统完成更多作业数
  - 处理机/CPU利用率高：工作时间/（工作时间+空闲时间）尽量接近1
- 分时系统目标：
  - 响应时间快：响应外设的请求速度快
  - 均衡性：响应时间快慢与服务复杂性一致
- 实时系统目标：
  - 截止时间的保证
  - 可预测性：例如视频的连续播放

#### 3.2 作业和作业调度

进程：程序段+数据+PCB
作业：程序+数据+作业说明书
作业步：完成作业的一个个步骤
作业控制块JCB：系统对作业进行调度管理所需的资料
（3.2以上不考）

**作业调度算法：**
- 先来先服务算法（FCFS）：等待时间
- 短作业优先算法（SJF）：作业运行时间
  缺点：
  - 无法准确预知时间
  - 可能饥饿
  - 无人机交互
  - 不考虑紧迫程度
- 高优先权优先算法（HPF(PSA)）：作业紧迫程度
- 高响应比优先算法（HRRN(PSA)）：SJF和FCFS的折衷
  - 优先权=（等待时间+要求服务时间）/要求服务时间=响应时间/要求服务时间

#### 3.3 进程调度

*进程调度算法继承作业调度全部算法*
任务：保存处理器信息，按算法选取下一个进程，将处理器分配给进程
机制：排队器（事先排队）、分派器（选取进程）、上下文切换器
进程调度方式：
- 非抢占式：进程执行完毕或无法执行、进程请求IO、通信或同步被block
- 抢占式：高优先权优先、高响应比优先、时间片原则
（3.3以上不考）

**进程调度算法：**
- 轮转调度算法（RR）：
根据FCFS排成就绪队列，每隔一个时间片产生中断，将CPU分配给队首进程。进程切换当且仅当时间片完或运行结束。较为可取的时间片大小是略大于典型交互所需要的时间，使交互程序能在一个时间片内完成。
- 优先级调度法：
  调度类型：
  - 非抢占式：队列中优先级最高的进程可不间断执行完
  - 抢占式：新进程如果优先级高于当前进程可中断当前进程

  优先级类型：
  - 静态：创建进程时分配，全程不改变
  - 动态：进程执行时优先级可改变

#### 3.5 死锁概述

**死锁**：计算机系统中多道程序并发执行时，两个或两个以上的进程由于竞争系统资源而造成的一种互相等待的现象。若无外力作用，这组进程将永远不能继续执行。

资源（了解即可）：
- 可重用性资源（数目相对固定）和消耗性资源（生产创建，消费消耗，例如用于进程间通信的消息）
- 可抢占性资源（处理机）和不可抢占性资源（打印机）

**死锁的产生：**

- 竞争不可抢占性资源
- 竞争可消耗性资源
- 进程间推进顺序不当

**死锁定义：**如果一组进程中的每一个进程都在等待仅由该组进程中的其他进程才能引发的事件，那么该组进程就是死锁的。

**死锁产生的四个必要条件：**
- 互斥条件：资源独占，进程对分配到的资源进行排他性使用
- 请求和保持条件：进程已经保持至少一个资源，又提出新请求，如未能满足，不释放已获得资源
- 不可抢占条件：资源在未被使用完前不能被抢占，只能由进程使用完后自愿释放
- 循环等待条件：存在进程-资源循环链，环路中的进程形成等待链

**死锁处理方法**：
- 预防死锁：破坏死锁产生的必要条件
- 避免死锁：防止系统进入不安全状态（银行家算法）
- 检测死锁：通过检测机构及时发现死锁，再采取措施（资源分配图）
- 解除死锁：当死锁发生，撤销一些进程，回收资源再分配

1~4：防范程度降低，资源利用率提高

#### 3.6 预防死锁

**破坏请求和保持**：

- 第一种协议：一次性申请全部资源
  - 缺点：浪费+饥饿
- 第二种协议：申请初期资源，运行后释放

**破坏不可抢占**：新资源得不到满足时主动释放已有资源

**破坏循环等待**：对资源排序，申请低序号资源必须先释放所有高序号资源

#### 3.7 避免死锁

**避免死锁与预防死锁的区别：**
预防死锁对进程的资源申请命令施加限制（规定死的）
避免死锁在进程请求分配资源时进行**动态检查**，并根据检查结果决定分配

**安全状态与安全序列：**
**安全序列：**系统能按某种进程推进顺序为每个进程分配所需资源，直至满足每个进程对资源的最大需求，使每个进程都能顺利完成。
相应序列为**安全序列**。
若不存在安全序列，则称为不安全状态。

**银行家算法中的数据结构：**
三个矩阵：
- Max（最大需求数）
- Allocation（分配数）
- Need（尚缺）=Max - Allocation

一个数组：
- Available（空闲资源数）

**银行家算法过程：**两个判断三个调整
1. 检查是否超出需求总量，超出报错
2. 检查是否资源不足，不足等待
3. 试探进行分配
4. 执行安全性检查算法
5. 如不安全，试探分配作废，进程等待

**安全性算法：**
- 挑一个剩余资源数能直接满足进程执行条件的进程分配给其资源，然后执行完毕后释放该进程所有资源给下一个资源
- 重复以上过程直至无该类进程
- 如果最终所有进程全部执行过一遍（安全序列），则系统安全，否则不安全

考试：要求写出状态图：Work、Need、Allocation、Work + Allocation、Finish并计算安全序列，见书p122

**银行家算法的不足：**对资源分配相对保守，计算多，需要预知未来进程变化和资源请求

#### 3.8 检测死锁与解除死锁

**资源分配图：**资源指向进程代表进程占用该资源，反之表示进程请求该资源
简化方式：找到非孤立节点，并确定其不阻塞（即其需求可以得到满足），即可删去该进程。

**死锁定理：**
死锁产生充要条件：资源分配图不可完全简化。
不存在环路一定没死锁，存在环路可能不存在死锁。
在一系列简化后，能消去图中所有边，使所有进程节点孤立，则不会产生死锁。

### 第九章 操作系统接口

#### 9.2 shell命令语言

**简单的shell格式：**$Command -option argument list

**简单命令分类：**
- 标准/非标准
  - 系统提供的标准命令
  - 用户自定义的非标准命令
- 是否在shell内部/内存中
  - 内部命令
  - 外部命令

#### 9.4 系统调用

**系统调用**：用户程序取得系统服务的唯一途径
- 系统态与用户态：
  - 特权指令：系统态运行的指令，不允许应用程序使用
  - 非特权指令：用户态运行的指令，允许应用程序使用
- 系统调用与一般调用的区别：
  - 仅限于用户态程序调用系统态程序
  - 通过软中断进入
  - 返回时重新检查优先级
  - 嵌套调用：系统功能调用系统子功能
- 中断机制：系统调用的实现原理，且中断号一致

#### 9.4.3 POSIX标准

**书P319 图9-7**
用户
|用户接口
v
标准系统程序
|库函数接口
v
标准库函数：读写/打开关闭/创建撤销
|系统调用接口
v
操作系统

#### 9.5 UNIX系统调用

进程控制
- 创建进程：fork
- 终止进程：exit
- 执行文件/改变进程图像：exec类
- 等待子进程结束：wait
- 获得进程ID：getpid类
- 获得用户ID：getuid、geteuid、getgid...
- 进程暂停：pause