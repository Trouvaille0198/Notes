# 研讨

https://zhuanlan.zhihu.com/p/183238194

文件共享的含义是什么？（你）

文件共享类型有哪几种形式，举例说明。（我）

Linux 基于索引节点的文件共享方式有哪两种？（你）

对文件 abc.txt 给出实现两种共享方式的相应命令，（你）

并请从文件共享链接的时空观、链接目标文件要求、删除目标文件独立性方面比较 Linux 的两种共享方式的主要区别或特点。（我）



**文件共享的含义是什么？**

操作系统提供的文件共享功能，让多个用户共享的使用同一个文件，而系统中只需保留该文件的一份副本。

如果系统不能提供共享功能，那么每个需要该文件的用户都要有各自的副本，会造成对存储空间的极大浪费。

> **共享 vs 复制**
>
> 1. 多个用户共享一个文件，意味着系统中只有一份文件数据。并且只要某个用户修改了文件的数据，其他用户也可以看到文件数据的变化。
> 2. 如果是多用户都复制了同一个文件，那么系统中会有多份文件数据。其中一个用户修改了自己的那份文件，对其他用户的文件数据并没有影响。



**Linux 中的文件**

文件包括两个部分：文件本身数据和文件的描述数据/元数据。

文件本身的数据就是文件的实际内容，存储在硬盘上；

文件的元数据有两个功能

- 提供必要的文件信息（文件名）
- 指明文件的唯一性：inode 号可以唯一地标识某个文件（而文件名不能）



这里我们引入了一个名词：索引节点

**索引节点 inode**

索引节点 inode 是类 UNIX 系统中的一种数据结构，它记录了文件的一些基本信息。

- 文件的访问权限
- 文件大小
- UID、GID
- 最近一次修改/访问/更改的时间（都包含在内）
- 当然还有最重要的 inode 号，就是它唯一地标识了一个文件
- 文件的链接数目

> 值得注意是，文件名并不在 inode 的存储范围之内，普通文件的文件名被记录到目录文件中（文件名实际上是身外之物）这也就说明了一个文件可以拥有多个不同的文件名。

> 注意到 Linux 里一切皆文件的特性——目录也是文件——目录的实际内容就是存放在此目录中的文件名和指向这些文件的指针



了解了 linux 中文件的基本结构后，我们来介绍两种实现文件共享的方式。

**基于索引节点的共享方式（硬链接）**

> 硬链接可以理解为对现有的一个文件的引用。

我们已经了解到，任何文件拥有一个唯一的索引节点，那么任何指向一个索引节点的指针本质上都指向了同一个文件实例，所以我们只要在不同用户的目录下创建若干个 inode 指针，不就完成了文件的共享吗

硬链接的实现就是基于这个原理

我们在 inode 中添加一个计数器属性 count，设初值为 1，称为引用计数器。

当一个文件被用户 1 创建时，我们首先创建一个指向该文件 inode 的指针，视为创建了一个硬链接

当有用户 2 需要使用到这个文件的时候，可以不用复制，直接建立一个指向该文件索引节点的指针，此时引用计数器的值 +1；以此类推

在这种基于索引节点的文件共享策略中，用户文件目录里只设置了文件名和指向索引节点的指针，由于我们是用这个指针来唯一地确定要链接的文件实例，那么文件名就无所谓了，可以随意改变。

<img src="https://markdown-1303167219.cos.ap-shanghai.myqcloud.com/20201224214549733.jpeg" alt="在这里插入图片描述" style="zoom: 20%;" />

如果这时候用户 2 不再需要此文件，准备把它删掉了，这个删除的步骤体现在系统层面上就是，首先索引节点中的 count 值 -1，然后删除 user2 目录中相应的目录项，用户 2 的硬链接就这样被切断了。

我们注意到删除用户 2 的文件，并不会影响原文件和其他硬链接，这个文件的信息一直会保存在硬盘，

直到计数器的 count 为 0 的时候，表明已经没有硬链接，即该文件已经没人使用，此时系统才会清空其所有数据。

> 硬链接有以下几个特点：
>
> - 所有的硬链接指向相同的 inode 以及数据块；
> - 新建立的文件本身就是一个硬链接；
> - 同一个文件的硬链接允许拥有不同的文件名（因为文件名在目录中记录，inode 不记录）
> - 删除一个硬链接不影响其他的硬链接；在有多个硬链接的情况下删除某个硬链接，数据不会被删除；删除最后一个硬链接，对应数据全部清空。
> - 不可以对目录建立硬链接；（linux 的目录是树形结构，如果在一个目录里面创建另一个目录的硬链接，岂不成了一个环状结构？）
> - 硬链接与被链接文件有着相同的文件属性（权限、时间戳等）因为它们本质上就指向同一个 inode
> - 新建一个硬链接，count+1
> - 不可以创建跨文件系统的硬链接（磁盘中有多个文件系统分区，每个文件系统分区都有自己独立的一套 inode 节点。如果跨区保存，就无法通过 inode 节点找到唯一的源文件了）



**基于符号链接的共享方式（软链接）**

软连接类似于 windows 上的快捷方式，它仅仅记录了目标文件的路径名。

具体来说，若某文件 F’ 的数据块中存放的是另一文件 F 或的路径名，称“某文件”是“另一文件”的软链接，这个路径名被视为符号链。

注意，软链接文件本质上是一个独立的文件，拥自己的 inode 节点，文件数据中保存了源文件的路径，通过这个路径访问源文件的数据。

删除一个软链接，不会影响其他软链接和原文件。
软链接的文件占用的数据块与被链接文件不同，而且有自己的 inode 和文件属性信息。

> 特点
>
> - 每个软链接都有自己的 inode 以及数据块；
> - 原文件不存在时，亦可以创建软链接；
> - 删除一个软链接，不影响被链接的文件；删除被链接的文件，则软链接无法找到原文件，变成悬挂的软链接；但原文件被重新创建（按原路径）时，软链接又重新发挥作用；
> - 可以对目录建立软链接；
> - 软链接与被链接文件有不同的文件属性（权限、时间戳等）；
> - 新建和删除软链接不改变 count 值。



最后我们总结一下软硬链接两种文件共享方式的区别

**软硬链接的区别**

- 链接文件的独立性不同
    - 硬链接文件本质上和源文件没有什么不同（他们共同使用一个 inode 节点，只是文件名不同罢了）
    - 软链接文件本质上是一个独立的文件，拥自己的 inode 节点（它与源文件的唯一联系就是它保存了源文件的路径）


- 创建的条件不同

    - 源文件不存在时，不能创建硬链接（因为连索引节点都不存在，自然也就无法创建指向它的指针）
    - 源文件不存在，也可以创建软连接（即存储一个无效的路径地址）

- 删除操作的不同

    - 删除任意一个硬链接，其他硬链接仍然有效（硬链接的删除操作不会涉及到文件实体的改变）
    - 删除任意一个软链接，其他软链接显然生效；但是一旦删除软链接的源文件，所有的软链接就会变成死链接（因为此时所有软链接记录的文件路径是找不到一个有效的文件的）
    - 硬链接之间的地位是平等的；而软链接与源文件的地位并不平等

- 索引节点中引用计数器 count 变化的策略不同

    - 新建/删除一个硬链接，count+1/-1；
    - 新建/删除一个软链接，源文件的 count 不变（因为软链接与其源文件的索引结点各自独立）

- 对目录文件的支持不同

    - 不允许创建一个**目录**的硬链接（由于 linux 的目录是一个树形结构，是一个有向无循环图，如果在一个目录里面创建另一个目录，那就变成了一个环状结构，造成混乱）
    - 允许创建一个**目录**的软链接（因为软链接的本质就是一个路径地址，所以它对于源文件没有什么特别的要求，甚至可以为空）

- 对跨文件系统的支持不同

    - 不允许创建跨文件系统的硬链接（磁盘中有多个文件系统分区，每个文件系统分区都有自己独立的一套索引节点。一旦产生跨区硬链接，索引节点就不能维护它的唯一性，也就不能找到唯一的源文件了）
    - 允许创建跨文件系统的软链接（因为它仅仅是一个路径而已）

        - 我们可以利用软链接的这一特性来解决解决磁盘空间不足问题，比如某个文件系统空间已经用完了，但是现在必须在该文件系统下创建一个新的目录并存储大量的文件，那么可以把另一个剩余空间较多的文件系统中的目录软链接到该文件系统中。这在用户层面是察觉不到的。


- 检索开销、内存开销不同
    - 检索软链接，需要系统根据路径名逐个分量地查找，造成多次读盘，开销较大
    - 软链接本质是一个单独的文件，有他独立的 inode 结点，也要耗费一定的存储空间
    - 在时空对比上，硬链接显然更胜一筹



**例题**

设文件 file 的 inode 当前的引用计数器值为 3，先对 file 建立软链接 f1，再对 file 建立硬链接 f2，再对 f1 建立硬链接f3，再删除 f2、f3。分别求 file、f1 中的引用计数器值。

解：对 file 建立软链接 f1，不影响 file 的引用计数器的值，故还是 3；对 file 建立硬链接 f2，故引用计数器 +1，变为 4；软链接 f1 本身就是一个文件，故初始 f1 中的引用计数器值为1，对 f1 建立硬链接 f3，故引用计数器值 +1，变为 2；最后删除 f2，被硬链接文件 file 的引用计数器的值 -1，变为 3，删除 f3，被硬链接文件 f1 的引用计数器的值 -1，变为 1。

因此最终答案为：file 的引用计数器的值：3；f1的引用计数器的值：1